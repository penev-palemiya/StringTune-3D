"use strict";var StringTune3D=(()=>{var Q=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var ne=Object.prototype.hasOwnProperty;var oe=(a,e)=>{for(var t in e)Q(a,t,{get:e[t],enumerable:!0})},ae=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of se(e))!ne.call(a,i)&&i!==t&&Q(a,i,{get:()=>e[i],enumerable:!(r=ie(e,i))||r.enumerable});return a};var le=a=>ae(Q({},"__esModule",{value:!0}),a);var ge={};oe(ge,{String3D:()=>G,String3DCamera:()=>N,String3DObject:()=>P,String3DRenderer:()=>z,String3DScene:()=>_,String3DSynchronizer:()=>W,ThreeJSEngine:()=>B,ThreeJSProvider:()=>Z});var ce=class{constructor(){this.desktop={rebuild:{width:!0,height:!0,scrollHeight:!0}},this.mobile={rebuild:{width:!0,height:!0,scrollHeight:!0}}}},U=class{constructor(a){this.objectMapOnPage=new Map,this.objectsOnPage=[],this.objectMap=new Map,this.objects=[],this.htmlKey="",this._type=1,this.permissions=new ce,this.tools=a.tools,this.data=a.data,this.settings=a.settings,this.events=a.events,this.centers=a.centers,this.hover=a.hover,this.attributesToMap=[{key:"active",type:"boolean",fallback:this.settings.active},{key:"fixed",type:"boolean",fallback:this.settings.fixed},{key:"outside-container",type:"boolean",fallback:this.settings["outside-container"]},{key:"repeat",type:"boolean",fallback:this.settings.repeat},{key:"self-disable",type:"boolean",fallback:this.settings["self-disable"]},{key:"abs",type:"boolean",fallback:this.settings.abs},{key:"key",type:"string",fallback:this.settings.key},{key:"offset-top",type:"dimension",fallback:this.settings["offset-top"]},{key:"offset-bottom",type:"dimension",fallback:this.settings["offset-bottom"]},{key:"inview-top",type:"dimension",fallback:this.settings["inview-top"]},{key:"inview-bottom",type:"dimension",fallback:this.settings["inview-bottom"]},{key:"start",type:"number",fallback:(e,t,r)=>{let i=r.top;return Math.floor(i)+this.data.scroll.container.scrollTop*this.data.viewport.transformScale}},{key:"end",type:"number",fallback:(e,t,r)=>{let i=r.top,s=r.height;return i+s-this.data.scroll.transformedCurrent}},{key:"size",type:"number",fallback:(e,t,r)=>r.height},{key:"half-width",type:"number",fallback:(e,t,r)=>r.width/2},{key:"half-height",type:"number",fallback:(e,t,r)=>r.height/2},{key:"enter-el",type:"string",fallback:this.settings["enter-el"]},{key:"enter-vp",type:"string",fallback:this.settings["enter-vp"]},{key:"exit-el",type:"string",fallback:this.settings["exit-el"]},{key:"exit-vp",type:"string",fallback:this.settings["exit-vp"]}]}get type(){return this._type}initializeObject(a,e,t,r){let i=this.tools.boundingClientRect.process({element:t});for(let{key:s,type:n,fallback:o,transform:l}of this.attributesToMap){let h=typeof o=="function"?o(t,e,i):o,c=this.tools.domAttribute.process({element:t,key:s,fallback:r[s]??this.settings[s]??h}),d=this.parseAttribute(c,n,{element:t,boundingRect:i,viewportHeight:this.data.viewport.windowHeight,baseRem:this.data.viewport.baseRem});l&&(d=l(d)),e.setProperty(s,d)}}calculatePositions(a,e){let t=a.getProperty("start"),r=a.getProperty("size"),i=a.getProperty("offset-bottom"),s=a.getProperty("offset-top"),n=a.getProperty("enter-el"),o=a.getProperty("enter-vp"),l=a.getProperty("exit-el"),h=a.getProperty("exit-vp"),c=0,d=0,f=0,y=0;n==="top"&&o==="top"||n==="left"&&o==="left"?(f=-e+1,c=t-i):n==="top"&&o==="bottom"||n==="left"&&o==="right"?c=t-e-i:n==="bottom"&&o==="top"||n==="right"&&o==="left"?(f=-e-r+1,c=t+r-i):(n==="bottom"&&o==="bottom"||n==="right"&&o==="right")&&(f=-r+1,c=t-e+r-i),l==="top"&&h==="top"||l==="left"&&h==="left"?(y=-r+1,d=t+s):l==="top"&&h==="bottom"||l==="left"&&h==="right"?(y=-e-r+1,d=t-e+s):l==="bottom"&&h==="top"||l==="right"&&h==="left"?d=t+r+s:(l==="bottom"&&h==="bottom"||l==="right"&&h==="right")&&(y=-e+1,d=t-e+r+s),a.setProperty("start-bias",f),a.setProperty("end-bias",y),a.setProperty("start-position",c-this.data.scroll.topPosition),a.setProperty("end-position",d-this.data.scroll.topPosition),a.setProperty("difference-position",d-c);let v=a.getProperty("inview-top")??0,g=a.getProperty("inview-bottom")??0;a.setProperty("inview-start-position",a.getProperty("start-position")+v),a.setProperty("inview-end-position",a.getProperty("end-position")+g)}parseAttribute(a,e,t={}){if(a==null)return null;if(typeof e=="object"&&e.type==="enum")return e.values.includes(a)?a:e.values[0];switch(e){case"number":return parseFloat(a);case"boolean":return a===""||a==="true";case"json":try{return JSON.parse(a)}catch{return null}case"tuple":return a.trim().split(/\s+/);case"easing":return this.tools.easingFunction.process({easing:a});case"color":return this.tools.colorParser.process({value:a});case"dimension":return a=="0"?0:t.element!=null&&t.viewportHeight!=null&&t.baseRem!=null&&t.boundingRect!=null?this.tools.unitParser.process({value:a,element:t.element,viewportHeight:t.viewportHeight,boundingRect:t.boundingRect,baseRem:t.baseRem}):0;case"breakpoint-dimension":if(t.element!=null&&t.viewportHeight!=null&&t.baseRem!=null&&t.boundingRect!=null){let r=a.trim().split("|"),i=[];for(let s of r)if(s.includes(":")){let[n,o]=s.split(":");i.push({breakpoint:parseInt(n),value:this.tools.unitParser.process({value:`${o}|`,element:t.element,viewportHeight:t.viewportHeight,boundingRect:t.boundingRect,baseRem:t.baseRem})})}else i.push({breakpoint:0,value:this.tools.unitParser.process({value:s,element:t.element,viewportHeight:t.viewportHeight,boundingRect:t.boundingRect,baseRem:t.baseRem})});return i}default:return a}}canConnect(a){return a.keys.includes(this.htmlKey)}connectObject(a){a.connect(this),this.onObjectConnected(a)}enterObject(a,e){this.objectMap.has(a)||(this.objectMap.set(a,e),this.objects.push(e))}exitObject(a){let e=this.objectMap.get(a);if(!e)return;this.objectMap.delete(a);let t=this.objects.indexOf(e);t!==-1&&this.objects.splice(t,1)}addObject(a,e){this.objectMapOnPage.has(a)||(this.objectMapOnPage.set(a,e),this.objectsOnPage.push(e))}removeObject(a){let e=this.objectMapOnPage.get(a);if(!e)return;this.objectMapOnPage.delete(a);let t=this.objectsOnPage.indexOf(e);t!==-1&&this.objectsOnPage.splice(t,1),this.onObjectDisconnected(e)}onObjectConnected(a){}onObjectDisconnected(a){}applyToElementAndConnects(a,e,t=e){a.getProperty("self-disable")!==!0&&e(a.htmlElement),a.mirrorObjects.forEach(r=>t(r.htmlElement,r))}destroy(){this.objects=[],this.objectMap=new Map}onInit(){}onFrame(a){}onMutate(a){}onScrollMeasure(a){}onMouseMoveMeasure(a){}onResize(){}onResizeWidth(){}onScroll(a){}onDirectionChange(){}onScrollStart(){}onScrollStop(){}onScrollDirectionChange(){}onAxisChange(){}onDeviceChange(){}onScrollConfigChange(){}onSettingsChange(){}onDOMRebuild(){}onMouseMove(a){}onWheel(a){}onDOMMutate(a,e){}};var he=class{constructor(){this.pendingVars=new Map,this.pendingProps=new Map,this.isOpen=!1}begin(){this.isOpen||(this.isOpen=!0)}setVars(a,e){if(!this.isOpen){console.warn("StyleTxn: call begin() first to set custom properties.");return}let t=this.pendingVars.get(a)??{};for(let[r,i]of Object.entries(e))t[r]!==i&&(t[r]=i);this.pendingVars.set(a,t)}setProps(a,e){if(!this.isOpen){console.warn("StyleTxn: call begin() first to set standard properties.");return}let t=this.pendingProps.get(a)??{};for(let[r,i]of Object.entries(e))t[r]!==i&&(t[r]=i);this.pendingProps.set(a,t)}run(a){let e=this.isOpen;e||this.begin();try{a(),e||this.commit()}catch(t){throw e||this.cancel(),t}}commit(){if(this.isOpen){this.isOpen=!1;for(let[a,e]of this.pendingVars){let t=a.style;for(let[r,i]of Object.entries(e))t.setProperty(r,String(i))}this.pendingVars.clear();for(let[a,e]of this.pendingProps){let t=a.style;for(let[r,i]of Object.entries(e))t[r]=String(i)}this.pendingProps.clear()}}cancel(){this.pendingVars.clear(),this.pendingProps.clear(),this.isOpen=!1}},ee=new he;var be=1/240;var de=class{constructor(){this.measureQueue=[],this.mutateQueue=[],this.scheduled=!1}measure(a){this.measureQueue.push(a),this.schedule()}mutate(a){this.mutateQueue.push(a),this.schedule()}schedule(){this.scheduled||(this.scheduled=!0,requestAnimationFrame(()=>{let a=this.measureQueue;this.measureQueue=[];for(let t=0;t<a.length;t++)try{a[t]()}catch(r){console.error("Error in frameDOM measure task:",r)}let e=this.mutateQueue;this.mutateQueue=[];for(let t=0;t<e.length;t++)try{e[t]()}catch(r){console.error("Error in frameDOM mutate task:",r)}this.scheduled=!1}))}},fe=new de;var ve=Math.PI*2,Se=180/Math.PI;var te=(a=>(a.ACTIVE="-active",a.ENTERING="-entering",a.LEAVING="-leaving",a.DISABLED="-disabled",a))(te||{}),ue={PROGRESS:"--sequence-progress",DIRECTION:"--sequence-direction"},pe=class re extends U{constructor(e){super(e),this.activeStep=new Map,this.leavingStep=new Map,this.transitions=new Map,this.elementIndex=new Map,this.triggerElements=new Map,this.globalSettings=new Map,this.initialized=!1,this.onTriggerClick=t=>{let r=this.triggerElements.get(t.currentTarget);if(!r)return;let i=this.activeStep.get(r.slider)??0,s=this.getMaxStep(r.slider),n,o;if(r.step==="next"){if(n=i+1,o=1,!this.elementIndex.has(`${r.slider}[${n}]`))if(r.loop&&s>=0)n=0;else return}else if(r.step==="prev"){if(n=i-1,o=-1,n<0)if(r.loop&&s>=0)n=s;else return;if(!this.elementIndex.has(`${r.slider}[${n}]`))return}else{if(n=r.step,i===n)return;o=n>i?1:-1}this.startTransition(r.slider,n,o)},this.htmlKey="sequence",this.defaultDuration=this.settings["sequence-duration"]??600,this.attributesToMap=[...this.attributesToMap,{key:"sequence",type:"string",fallback:""},{key:"sequence-trigger",type:"string",fallback:""},{key:"entering-easing",type:"string",fallback:""},{key:"leaving-easing",type:"string",fallback:""},{key:"entering-duration",type:"string",fallback:""},{key:"leaving-duration",type:"string",fallback:""},{key:"sequence-duration",type:"string",fallback:""},{key:"active-step",type:"string",fallback:""}]}onInit(){super.onInit(),this.events.on("sequence",this.onSequenceEvent.bind(this)),this.scanStandaloneTriggers()}scanStandaloneTriggers(){let e=document.querySelectorAll("[string-sequence-trigger]:not([string-inited])");for(let t of e){let r=t.getAttribute("string-sequence-trigger"),i=r?this.parseTriggerKey(r):null;i&&(this.triggerElements.set(t,i),t.addEventListener("click",this.onTriggerClick))}}parseGlobalSettingsFromObject(e){let t=i=>e.getProperty(i),r=t("sequence-duration");this.tryParseGlobalSetting(r,"enteringDuration"),this.tryParseGlobalSetting(r,"leavingDuration"),this.tryParseGlobalSetting(t("entering-duration"),"enteringDuration"),this.tryParseGlobalSetting(t("leaving-duration"),"leavingDuration"),this.tryParseGlobalSetting(t("entering-easing"),"enteringEasing"),this.tryParseGlobalSetting(t("leaving-easing"),"leavingEasing"),this.tryParseGlobalSetting(t("active-step"),"activeStep")}tryParseGlobalSetting(e,t){if(!e)return;let r=e.match(/^(.+)\[(.+)\]$/);if(!r)return;let[,i,s]=r,n=this.globalSettings.get(i)??{};this.globalSettings.set(i,n),n[t]=t==="enteringEasing"||t==="leavingEasing"?s:parseFloat(s),this.applyGlobalSettingsToExistingObjects(i)}applyGlobalSettingsToExistingObjects(e){let t=this.globalSettings.get(e);if(t){for(let[r,i]of this.elementIndex)if(this.parseSequenceKey(r)?.slider===e){t.enteringDuration!==void 0&&(i.enteringDuration=t.enteringDuration),t.leavingDuration!==void 0&&(i.leavingDuration=t.leavingDuration);for(let s of i.objects)this.resolveEasings(s,r)}}}initializeSliders(){let e=new Set;for(let t of this.elementIndex.keys()){let r=this.parseSequenceKey(t);r&&e.add(r.slider)}for(let t of e){if(this.activeStep.has(t))continue;let r=this.globalSettings.get(t)?.activeStep??0;this.elementIndex.has(`${t}[${r}]`)||(r=0),this.switchInstant(t,r,1)}}tryApplyPendingActiveStep(e){if(this.activeStep.has(e))return;let t=this.globalSettings.get(e)?.activeStep;t!==void 0&&this.elementIndex.has(`${e}[${t}]`)&&this.switchInstant(e,t,1)}canConnect(e){return e.keys.includes("sequence")||e.keys.includes("sequence-trigger")}onObjectConnected(e){super.onObjectConnected(e),this.parseGlobalSettingsFromObject(e);let t=e.getProperty("sequence"),r=e.getProperty("sequence-trigger");if(!t&&r){let i=this.parseTriggerKey(r);i&&typeof i.step=="number"&&(t=`${i.slider}[${i.step}]`,e.setProperty("sequence",t))}if(t){let i=this.parseSequenceKey(t);if(i){let s=this.elementIndex.get(t);if(!s){let{enteringDuration:o,leavingDuration:l}=this.resolveDurations(e,t);s={objects:[],enteringDuration:o,leavingDuration:l},this.elementIndex.set(t,s)}s.objects.push(e),this.resolveEasings(e,t);let n=this.activeStep.get(i.slider);this.setState(e,n===i.step?"-active":"-disabled",n===i.step?1:0,1),this.tryApplyPendingActiveStep(i.slider)}}if(r){let i=this.parseTriggerKey(r);i&&(this.triggerElements.set(e.htmlElement,i),e.htmlElement.addEventListener("click",this.onTriggerClick))}}parseTriggerKey(e){let t=e.match(/^(.+)\[(next|prev|\d+)(\|loop)?\]$/);if(!t)return null;let r=t[2]==="next"||t[2]==="prev"?t[2]:parseInt(t[2],10);return{slider:t[1],step:r,loop:t[3]==="|loop"}}getMaxStep(e){let t=-1;for(let r of this.elementIndex.keys()){let i=this.parseSequenceKey(r);i?.slider===e&&i.step>t&&(t=i.step)}return t}resolveDuration(e,t,r,i){let s=e.getProperty(i),n=e.getProperty("sequence-duration"),o=this.globalSettings.get(t)?.[r];if(s&&!s.includes("[")){let l=parseFloat(s);if(!isNaN(l))return l}if(n&&!n.includes("[")){let l=parseFloat(n);if(!isNaN(l))return l}return o??this.defaultDuration}resolveDurations(e,t){let r=this.parseSequenceKey(t)?.slider??"";return{enteringDuration:this.resolveDuration(e,r,"enteringDuration","entering-duration"),leavingDuration:this.resolveDuration(e,r,"leavingDuration","leaving-duration")}}resolveEasing(e,t,r,i){let s=e.getProperty(i);(!s||typeof s=="string"&&s.includes("["))&&(s=this.globalSettings.get(t)?.[r]??this.settings.easing??"ease-out"),typeof s=="string"&&e.setProperty(i,this.tools.easingFunction.process({easing:s}))}resolveEasings(e,t){let r=this.parseSequenceKey(t)?.slider;r&&(this.resolveEasing(e,r,"enteringEasing","entering-easing"),this.resolveEasing(e,r,"leavingEasing","leaving-easing"))}onObjectDisconnected(e){super.onObjectDisconnected(e);let t=e.getProperty("sequence");if(t){let r=this.elementIndex.get(t);if(r){let i=r.objects.indexOf(e);i!==-1&&r.objects.splice(i,1),r.objects.length||this.elementIndex.delete(t)}}this.triggerElements.has(e.htmlElement)&&(e.htmlElement.removeEventListener("click",this.onTriggerClick),this.triggerElements.delete(e.htmlElement))}parseSequenceKey(e){let t=e.match(/^(.+)\[(\d+)\]$/);return t?{slider:t[1],step:parseInt(t[2],10)}:null}onSequenceEvent(e){let{slider:t,step:r,transitionProgress:i,direction:s=1,duration:n,instant:o}=e;this.activeStep.get(t)===r&&i===void 0||(i!==void 0?this.handleScrub(t,r,i,s):o?this.switchInstant(t,r,s):this.startTransition(t,r,s,n))}startTransition(e,t,r,i){let s=this.activeStep.get(e),n=this.leavingStep.get(e);n!==void 0&&n!==s&&this.setStepState(e,n,"-disabled",0,r);let o=this.elementIndex.get(`${e}[${t}]`),l=s!==void 0?this.elementIndex.get(`${e}[${s}]`):null;s!==void 0&&this.leavingStep.set(e,s),this.activeStep.set(e,t),this.transitions.set(e,{fromStep:s??t,toStep:t,direction:r,startTime:this.data.time.now,enteringDuration:i??o?.enteringDuration??this.defaultDuration,leavingDuration:i??l?.leavingDuration??this.defaultDuration})}handleScrub(e,t,r,i){this.transitions.delete(e);let s=this.activeStep.get(e);if(s!==t){let n=this.leavingStep.get(e);n!==void 0&&this.setStepState(e,n,"-disabled",0,i),s!==void 0&&this.leavingStep.set(e,s),this.activeStep.set(e,t)}this.applyProgress(e,r,r,i)}switchInstant(e,t,r){this.transitions.delete(e);let i=this.activeStep.get(e),s=this.leavingStep.get(e);s!==void 0&&this.setStepState(e,s,"-disabled",0,r),i!==void 0&&i!==t&&this.setStepState(e,i,"-disabled",0,r),this.activeStep.set(e,t),this.leavingStep.delete(e),this.setStepState(e,t,"-active",1,r)}applyProgress(e,t,r,i){let s=this.activeStep.get(e),n=this.leavingStep.get(e);this.setStepState(e,s,t>=1?"-active":"-entering",t,i),n!==void 0&&n!==s&&(r>=1?(this.setStepState(e,n,"-disabled",0,i),this.leavingStep.delete(e)):this.setStepState(e,n,"-leaving",r,i))}setStepState(e,t,r,i,s){let n=this.elementIndex.get(`${e}[${t}]`);if(n)for(let o of n.objects)this.setState(o,r,i,s)}setState(e,t,r,i){let s=e.htmlElement,n=e.getProperty("_state"),o=e.getProperty("_direction"),l=e.getProperty(t==="-leaving"?"leaving-easing":"entering-easing"),h=typeof l=="function"?l(r):r;n!==t&&(s.classList.remove(...re.ALL_STATES),s.classList.add(t),e.setProperty("_state",t)),o!==i&&(e.setProperty("_direction",i),ee.run(()=>ee.setVars(s,{[ue.DIRECTION]:i.toString()})))}onFrame(e){super.onFrame(e),this.initialized||(this.initialized=!0,this.initializeSliders());for(let[t,r]of this.transitions){let i=e.time.now-r.startTime,s=Math.min(1,i/r.enteringDuration),n=Math.min(1,i/r.leavingDuration);this.applyProgress(t,s,n,r.direction),s>=1&&n>=1&&this.transitions.delete(t)}}};pe.ALL_STATES=Object.values(te);var J=class q extends U{constructor(e){super(e),this.htmlKey="form"}initializeObject(e,t,r,i){super.initializeObject(e,t,r,i);let s=t.getProperty("form-events")??[];s.forEach(c=>{c.eventElement.removeEventListener(c.eventType,c.eventCallback)}),s.length=0,t.setProperty("form-events",s),super.onObjectConnected(t);let n=t.htmlElement,o=[],l={};this.getInteractiveFields(n).forEach((c,d)=>this.registerField(c,n,o,l,s,d));let h=c=>{c.preventDefault();let d=!0,f={},y=new Set;for(let v of o){let g=v.field;if(!g.isConnected||!this.shouldValidateField(g))continue;if(this.isRadioField(g)){if(y.has(v.key))continue;y.add(v.key)}let{key:m,rules:M,needsContext:u}=v,w=this.getFieldValue(g);f[m]=w,l[m]=w;let{valid:p,errors:b}=this.tools.validation.process({rules:M,value:w,context:this.buildContext(u,m,l)});this.applyValidationState(n,g,m,p,b,"submit"),p||(d=!1)}if(d)this.events.emit(`form:submit:${t.id}`,f);else{let v=new Set,g=o.find(m=>{let M=m.field;if(!M.isConnected||!this.shouldValidateField(M))return!1;if(this.isRadioField(M)){if(v.has(m.key))return!1;v.add(m.key)}let{key:u,rules:w,needsContext:p}=m,b=this.getFieldValue(M);l[u]=b;let{valid:E}=this.tools.validation.process({rules:w,value:b,context:this.buildContext(p,u,l)});return!E});g?.field&&typeof g.field.focus=="function"&&g.field.focus(),this.events.emit(`form:invalid:${t.id}`)}};n.addEventListener("submit",h),s.push({eventElement:n,eventType:"submit",eventCallback:h}),t.setProperty("form-field-entries",o),t.setProperty("form-field-values",l)}onObjectConnected(e){}onDOMMutate(e,t){this.objects.length!==0&&(e.length>0&&this.handleMutationAdditions(e),t.length>0&&this.handleMutationRemovals(t))}applyValidationState(e,t,r,i,s,n){let o=e.querySelector(`[string-input="error[${r}]"]`),l=e.querySelector(`[string-input="group[${r}]"]`);o&&(o.innerHTML="",s.forEach(c=>{let d=document.createElement("span");d.textContent=c,o.appendChild(d)})),n==="live"?(t.classList.toggle("-invalid",!i),t.classList.remove("-error")):(t.classList.remove("-invalid"),t.classList.toggle("-error",!i)),t.classList.toggle("-valid",i),l&&(n==="live"?(l.classList.toggle("-invalid",!i),l.classList.remove("-error")):(l.classList.remove("-invalid"),l.classList.toggle("-error",!i)),l.classList.toggle("-valid",i));let h=i?"valid":n==="live"?"invalid":"error";this.events.emit(`form:field:${h}:${r}`,{key:r,field:t,errors:s,phase:n,valid:i})}getInteractiveFields(e){return Array.from(e.querySelectorAll("[string-input]")).filter(t=>!this.isServiceFieldAttribute(t.getAttribute("string-input")||"")).filter(t=>this.isFormFieldElement(t)).map(t=>t)}getFieldRules(e){let t=this.tools.domAttribute.process({element:e,key:"input"})??"";return this.tools.ruleParser.process({value:t})}registerField(e,t,r,i,s,n){if(!this.isFormFieldElement(e)||e.closest("form")!==t||r.some(g=>g.field===e))return;let o=this.registerFieldIndex(e,n??r.length),l=this.getInputKey(e,o),h=this.getFieldRules(e),c=this.supportsBeforeInputValidation(h),d=this.requiresContext(h),f=this.getInputEventType(e),y={field:e,key:l,rules:h,supportsRealtime:c,needsContext:d,inputEventType:f,inputHandler:()=>{}},v=g=>{let m=g.currentTarget||g.target;if(!m||!m.isConnected||!this.shouldValidateField(m))return;let M=this.getFieldValue(m);i[y.key]=M;let u=this.buildContext(y.needsContext,y.key,i),{valid:w,errors:p}=this.tools.validation.process({rules:y.rules,value:M,context:u});this.applyValidationState(t,m,y.key,w,p,"live")};if(y.inputHandler=v,e.addEventListener(f,v),s.push({eventElement:e,eventType:f,eventCallback:v}),c&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)){let g=m=>{let M=m;if(M.isComposing||M.inputType?.startsWith("insertComposition"))return;let u=m.currentTarget||m.target;if(!u||!(u instanceof HTMLInputElement||u instanceof HTMLTextAreaElement)||!u.isConnected)return;let w=u.selectionStart??0,p=u.selectionEnd??0,b=u.value;switch(M.inputType){case"deleteContentBackward":b=w===p&&w>0?u.value.slice(0,w-1)+u.value.slice(p):u.value.slice(0,w)+u.value.slice(p);break;case"deleteContentForward":b=w===p&&w<u.value.length?u.value.slice(0,w)+u.value.slice(w+1):u.value.slice(0,w)+u.value.slice(p);break;case"insertFromPaste":case"insertFromDrop":case"insertReplacementText":b=u.value.slice(0,w)+(M.data||"")+u.value.slice(p);break;default:typeof M.data=="string"&&(b=u.value.slice(0,w)+M.data+u.value.slice(p))}let{errors:E}=this.tools.validation.process({rules:y.rules,value:b,type:"beforeinput",context:this.buildContext(y.needsContext,y.key,i,{applied:!0,value:b})});E.length>0&&m.cancelable&&m.preventDefault()};y.beforeInputHandler=g,e.addEventListener("beforeinput",g),s.push({eventElement:e,eventType:"beforeinput",eventCallback:g})}e.classList.add("-inited"),r.push(y),i[l]=this.getFieldValue(e)}unregisterField(e,t,r,i){let s=t.findIndex(o=>o.field===e);if(s===-1)return;let n=t[s];n.inputHandler&&e.removeEventListener(n.inputEventType,n.inputHandler),n.beforeInputHandler&&e.removeEventListener("beforeinput",n.beforeInputHandler),delete r[n.key],t.splice(s,1);for(let o=i.length-1;o>=0;o--){let l=i[o];l.eventElement===e&&(l.eventCallback===n.inputHandler||n.beforeInputHandler&&l.eventCallback===n.beforeInputHandler)&&i.splice(o,1)}e.classList.remove("-inited")}collectInteractiveFieldsFromNode(e){let t=[];return e instanceof Element?(e.hasAttribute("string-input")&&t.push(e),t.push(...Array.from(e.querySelectorAll("[string-input]")))):e instanceof DocumentFragment&&t.push(...Array.from(e.querySelectorAll("[string-input]"))),t.filter(r=>!this.isServiceFieldAttribute(r.getAttribute("string-input")||"")).filter(r=>this.isFormFieldElement(r))}isRadioField(e){return e instanceof HTMLInputElement&&e.type==="radio"}handleMutationAdditions(e){e.forEach(t=>{this.collectInteractiveFieldsFromNode(t).forEach(r=>{let i=this.getFormStateByContainment(r);i&&this.registerField(r,i.form,i.entries,i.values,i.events)})})}handleMutationRemovals(e){e.forEach(t=>{this.collectInteractiveFieldsFromNode(t).forEach(r=>{let i=this.getFormStateByReference(r);i&&this.unregisterField(r,i.entries,i.values,i.events)})})}getFormStateByContainment(e){let t=this.objects.find(r=>r.htmlElement instanceof HTMLFormElement&&r.htmlElement.contains(e));return t?this.buildFormState(t):null}getFormStateByReference(e){for(let t of this.objects){let r=t.getProperty("form-field-entries");if(r&&r.some(i=>i.field===e))return this.buildFormState(t,r)}return null}buildFormState(e,t){let r=e.htmlElement;if(!(r instanceof HTMLFormElement))return null;let i=t??e.getProperty("form-field-entries"),s=e.getProperty("form-field-values"),n=e.getProperty("form-events");return!i||!s||!n?null:{object:e,form:r,entries:i,values:s,events:n}}registerFieldIndex(e,t){let r=e.getAttribute("data-string-form-index");return r!==null?Number(r):(e.setAttribute("data-string-form-index",String(t)),t)}getFieldIndex(e,t){let r=e.getAttribute("data-string-form-index");if(r!==null){let i=Number(r);return Number.isNaN(i)?t:i}return this.registerFieldIndex(e,t)}shouldValidateField(e){return!(e.disabled||e instanceof HTMLInputElement&&e.type==="hidden")}supportsBeforeInputValidation(e){return e.some(t=>q.beforeInputRuleKeys.has(t.key))}requiresContext(e){return e.some(t=>q.crossFieldRuleKeys.has(t.key))}buildContext(e,t,r,i){if(!e)return{fieldKey:t};let s=!!i?.applied,n=s?{...r,[t]:i.value}:r;return{fieldKey:t,values:n,getValue:o=>s&&o===t?i.value:n[o]}}getInputKey(e,t){return this.tools.domAttribute.process({element:e,key:"id"})||e.getAttribute("name")||e.getAttribute("id")||`input-${t}`}getFieldValue(e){if(e instanceof HTMLInputElement){if(e.type==="checkbox"){if(e.name){let t=e.form||e.closest("form"),r=t?Array.from(t.querySelectorAll(`input[type="checkbox"][name="${e.name}"]:checked`)):[e];return r.length>1?r.map(i=>i.value):r.length===1?r[0].value:""}return e.checked}if(e.type==="radio"){if(e.name){let t=(e.form||e.closest("form"))?.querySelector(`input[type="radio"][name="${e.name}"]:checked`);return t?t.value:""}return e.checked?e.value:""}return e.type==="file"&&e.files&&e.files.length>0?e.multiple?Array.from(e.files):e.files[0]:e.value}return e instanceof HTMLSelectElement?e.multiple?Array.from(e.selectedOptions).map(t=>t.value):e.value:e instanceof HTMLTextAreaElement?e.value:""}isServiceFieldAttribute(e){return q.serviceAttributePrefixes.some(t=>e.startsWith(`${t}[`))}isFormFieldElement(e){return e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement}getInputEventType(e){return e instanceof HTMLSelectElement||e instanceof HTMLInputElement&&(e.type==="checkbox"||e.type==="radio")?"change":"input"}};J.beforeInputRuleKeys=new Set(["number","integer","email","phone","letters","lettersSpaces","lettersNumbers","alpha","alpha_num","alpha_dash","digits","url","pattern"]),J.crossFieldRuleKeys=new Set(["same","different","after","before"]),J.serviceAttributePrefixes=["error","group"];var N=class{constructor(e,t="orthographic",r=50,i=.1,s=1e4){this.scaleCache=new Map;this._width=1;this._height=1;this.engine=e,this.mode=t,this.perspectiveFov=r,t==="orthographic"?this._camera=e.createOrthographicCamera(-1,1,1,-1,i,s):this._camera=e.createPerspectiveCamera(r,1,i,s),this._position=e.createVector3(0,0,1e3),this.update()}get camera(){return this._camera}resize(e,t){if(this._width=e,this._height=t,this.mode==="orthographic"){let r=this._camera;r.left=-e/2,r.right=e/2,r.top=t/2,r.bottom=-t/2}else this._camera.aspect=e/t;this.update()}setPosition(e,t,r){this._position.set(e,t,r),this._camera.position.copy(this._position),this.update()}lookAt(e,t,r){this._camera.lookAt(e,t,r),this.update()}update(){this._camera.updateProjectionMatrix(),this._camera.updateMatrixWorld?.()}screenToWorld(e,t,r=0){if(this.mode==="orthographic"){let i=e-this._width/2,s=-(t-this._height/2);return this.engine.createVector3(i,s,r)}else{let{width:i,height:s}=this.getFrustumSizeAt(r),n=e/this._width,o=t/this._height,l=(n-.5)*i,h=-(o-.5)*s;return this.engine.createVector3(l,h,r)}}getFrustumSizeAt(e){if(this.mode==="orthographic")return{width:this._width,height:this._height};let t=this.engine.degToRad(this.perspectiveFov),r=Math.abs(e-this._camera.position.z),i=2*Math.tan(t/2)*r;return{width:i*this._camera.aspect,height:i}}getScaleAtZ(e,t){if(this.mode==="orthographic")return 1;let r=Math.round(e*1e3)/1e3;if(this.scaleCache.has(r))return this.scaleCache.get(r);let{height:i}=this.getFrustumSizeAt(e),s=i/t;return this.scaleCache.set(r,s),s}clearScaleCache(){this.scaleCache.clear()}getMode(){return this.mode}getPerspectiveFov(){return this.perspectiveFov}getPositionZ(){return this._position.z}};var z=class{constructor(e,t){this.engine=t,this._container=e;let{width:r,height:i}=e.getBoundingClientRect();this._width=r,this._height=i,this._renderer=t.createRenderer({antialias:!0,alpha:!0,logarithmicDepthBuffer:!0}),this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(r,i),this._renderer.shadowMap&&(this._renderer.shadowMap.enabled=!0)}attach(){this._container.appendChild(this._renderer.domElement)}render(e,t){this._renderer.render(e.getScene(),t.camera)}resize(e){let{width:t,height:r}=this._container.getBoundingClientRect();this._width=t,this._height=r,this._renderer.setSize(t,r),e.resize(t,r)}get width(){return this._width}get height(){return this._height}get renderer(){return this._renderer}destroy(){this._renderer.dispose()}};var P=class{constructor(e,t,r,i,s={}){this._uniforms={};this._children=[];this.id=e,this.type=t,this._object=r,this.engine=i,this._material=s.material,this._geometry=s.geometry,this._texture=s.texture,this._quaternion=i.createQuaternion(),this._originalSize=i.createVector3(),this._bbox=i.createBox3(),this.updateBoundingBox()}get children(){return this._children}get object(){return this._object}get material(){return this._material}get originalSize(){return this._originalSize.clone()}get boundingBox(){return this._bbox.clone()}addChild(e){this._children.push(e),this.object.add(e.object)}getWorldMatrix(){return this._object.matrixWorld.clone()}getWorldPosition(){return this.engine.createVector3().setFromMatrixPosition(this._object.matrixWorld)}getOriginalBoundingBox(){if(!this._originalBoundingBox){let e=this.object.scale.clone();this.object.scale.set(1,1,1),this.object.updateMatrixWorld(!0),this._originalBoundingBox=this.engine.computeBoundingBoxRecursively(this.object),this.object.scale.copy(e),this.object.updateMatrixWorld(!0)}return this._originalBoundingBox.clone()}syncTransformFromMatrix(e){let t=this.engine.createVector3(),r=this.engine.createQuaternion(),i=this.engine.createVector3();e.decompose(t,r,i),this._object.position.copy(t),this._object.quaternion.copy(r),this._object.scale.copy(i),this._object.updateMatrix(),this._object.updateMatrixWorld()}applyWorldTransform(e,t,r){this._object.position.copy(e),this._object.quaternion.copy(t),this._object.scale.copy(r),this._object.updateMatrix(),this._object.updateMatrixWorld()}set quaternion(e){this._quaternion.copy(e),this._object.quaternion.copy(this._quaternion),this._object.updateMatrixWorld()}set position(e){this._object.position.copy(e)}set scale(e){this._object.scale.copy(e)}set rotation(e){this._object.rotation.copy(e)}set opacity(e){let t=this._object;t.material&&"opacity"in t.material&&(t.material.opacity=e)}set metalness(e){let t=this._object;t.material&&"metalness"in t.material&&(t.material.metalness=e)}set roughness(e){let t=this._object;t.material&&"roughness"in t.material&&(t.material.roughness=e)}set texture(e){this._texture=e,this._object.isMesh&&e?.applyTexture&&e.applyTexture(this._object)}set material(e){this._material=e}set geometry(e){this._geometry=e}updateBoundingBox(){this._bbox.setFromObject(this._object),this._bbox.getSize(this._originalSize)}destroy(){this.disposeObjectResources(this._object),this._texture?.dispose?.(),this._material?.dispose(),this._geometry?.dispose()}disposeObjectResources(e){let t=e;t?.geometry?.dispose&&t.geometry.dispose();let r=t?.material;Array.isArray(r)?r.forEach(i=>i?.dispose?.()):r?.dispose&&r.dispose(),typeof t?.traverse=="function"&&t.traverse(i=>{i?.geometry?.dispose&&i.geometry.dispose();let s=i?.material;Array.isArray(s)?s.forEach(n=>n?.dispose?.()):s?.dispose&&s.dispose()})}};var _=class{constructor(e,t={}){this._objects=new Map;this._rootObjects=[];this._elementMap=new Map;this._modelLoaderCache=new Map;this.engine=e,this._modelLoader=t.modelLoader,this._modelLoaderFactory=t.modelLoaderFactory,this._scene=e.createScene()}get rootObjects(){return this._rootObjects}getScene(){return this._scene}getObject(e){return this._objects.get(e)}hasObject(e){return this._objects.has(e)}deleteObject(e){let t=this._objects.get(e);return t?(this._scene.remove(t.object),this._objects.delete(e),t.destroy(),!0):!1}createFromElement(e){let t=e.getProperty("3d");if(!t)return;let r=e.htmlElement;if(!r)return;let i=s=>{if(s){let n=e.getProperty("parentId");n==null?(this._scene.add(s.object),this._rootObjects.push(s)):this._objects.get(n)?.addChild(s),this._objects.set(e.id,s),this._elementMap.set(e.id,r),s.el=r}};switch(t){case"group":this.createGroup(e,i);break;case"pointLight":this.createLight(e,"point",i);break;case"ambientLight":this.createLight(e,"ambient",i);break;case"directionalLight":this.createLight(e,"directional",i);break;case"spotLight":this.createLight(e,"spot",i);break;case"hemisphereLight":this.createLight(e,"hemisphere",i);break;case"model":this.createModel(e,i);break;case"box":this.createBox(e,i);break;case"sphere":this.createSphere(e,i);break;case"plane":this.createPlane(e,i);break;case"cylinder":this.createCylinder(e,i);break}}createGroup(e,t){let r=this.engine.createGroup(),i=new P(e.id,"group",r,this.engine);return t(i),i}createLight(e,t,r){let i=e.getProperty("3d-color")||"#ffffff",s=e.getProperty("3d-intensity")??1,n;if(t==="point"){let h=e.getProperty("3d-distance")??1e3,c=e.getProperty("3d-decay")??0;n=this.engine.createPointLight(i,s,h,c)}else if(t==="directional")n=this.engine.createDirectionalLight(i,s);else if(t==="spot"){let h=e.getProperty("3d-distance")??0,c=e.getProperty("3d-angle")??Math.PI/3,d=e.getProperty("3d-penumbra")??0,f=e.getProperty("3d-decay")??1;n=this.engine.createSpotLight(i,s,h,c,d,f)}else if(t==="hemisphere"){let h=e.getProperty("3d-ground-color")||"#ffffff";n=this.engine.createHemisphereLight(i,h,s)}else n=this.engine.createAmbientLight(i,s);if((e.getProperty("3d-cast-shadow")??!1)&&n.shadow){n.castShadow=!0;let h=e.getProperty("3d-shadow-bias")??0,c=e.getProperty("3d-shadow-map-size")??512;n.shadow.bias=h,n.shadow.mapSize.width=c,n.shadow.mapSize.height=c}let l=new P(e.id,t+"Light",n,this.engine);return r(l),l}applyShadowProps(e,t){let r=e.getProperty("3d-cast-shadow")??!1,i=e.getProperty("3d-receive-shadow")??!1;t.castShadow=r,t.receiveShadow=i}createBox(e,t){let r=this.engine.createBoxGeometry(1,1,1),i=this.createMaterialFromObject(e),s=this.engine.createMesh(r,i);this.applyShadowProps(e,s);let n=new P(e.id,"box",s,this.engine,{geometry:r,material:i});return t(n),n}createSphere(e,t){let r=e.getProperty("3d-segments-width")??32,i=e.getProperty("3d-segments-height")??32,s=this.engine.createSphereGeometry(.5,r,i),n=this.createMaterialFromObject(e),o=this.engine.createMesh(s,n);this.applyShadowProps(e,o);let l=new P(e.id,"sphere",o,this.engine,{geometry:s,material:n});return t(l),l}createPlane(e,t){let r=this.engine.createPlaneGeometry(1,1),i=this.createMaterialFromObject(e),s=this.engine.createMesh(r,i);this.applyShadowProps(e,s);let n=new P(e.id,"plane",s,this.engine,{geometry:r,material:i});return t(n),n}createCylinder(e,t){let r=e.getProperty("3d-segments")??32,i=this.engine.createCylinderGeometry(.5,.5,1,r),s=this.createMaterialFromObject(e),n=this.engine.createMesh(i,s);this.applyShadowProps(e,n);let o=new P(e.id,"cylinder",n,this.engine,{geometry:i,material:s});return t(o),o}createModel(e,t){let r=e.getProperty("3d-model");if(!r)return;let i=e.getProperty("3d-model-loader")||void 0,s=this.resolveModelLoader(i);if(!s){console.warn("[String3D] Model loader not configured");return}let n=e.htmlElement;n&&this.applyModelTextureRemap(s,n);let o=e.getProperty("3d-model-center")??!1;s.load(r,l=>{let h=l?.scene||l?.object||l;if(!h){console.warn("[String3D] Model loader returned empty result");return}let c=n&&this.shouldOverrideModelMaterial(n)?this.createMaterialFromElement(n,e):null;typeof h.traverse=="function"&&h.traverse(f=>{f.isMesh&&(c&&(f.material=c),this.applyShadowProps(e,f))}),o&&this.centerObject(h);let d=new P(e.id,"model",h,this.engine);t(d)},l=>{console.log(l.loaded/l.total*100+"% loaded")},l=>{console.error("[String3D] Model loading error:",l)})}resolveModelLoader(e){if(e){if(this._modelLoaderCache.has(e))return this._modelLoaderCache.get(e);if(!this._modelLoaderFactory){console.warn(`[String3D] No model loader factory for type "${e}"`);return}let t=this._modelLoaderFactory(this.engine,e);return this._modelLoaderCache.set(e,t),t}if(this._modelLoader)return this._modelLoader;if(this._modelLoaderFactory)return this._modelLoaderFactory(this.engine)}centerObject(e){if(!e)return;let t=this.engine.computeBoundingBoxRecursively(e),r=this.getBoxCenter(t);e.position?.set&&e.position.set(-r.x,-r.y,-r.z),e.updateMatrixWorld(!0)}getBoxCenter(e){let t=this.engine.createVector3();return t.x=(e.min.x+e.max.x)/2,t.y=(e.min.y+e.max.y)/2,t.z=(e.min.z+e.max.z)/2,t}createMaterialFromObject(e){return this.createMaterialFromElement(e.htmlElement,e)}createMaterialFromElement(e,t){let r=t?.getProperty("3d-material")||"basic[#ffffff]",[i,s]=r.split(/\[|\]/),n=s||"#ffffff",o=t?.getProperty("3d-opacity")??1,l=t?.getProperty("3d-metalness"),h=t?.getProperty("3d-roughness"),c={color:n,transparent:o<1,opacity:o},d=e?.getAttribute("string-3d-map"),f=e?.getAttribute("string-3d-normalMap"),y=e?.getAttribute("string-3d-roughnessMap"),v=e?.getAttribute("string-3d-metalnessMap"),g=e?.getAttribute("string-3d-aoMap"),m=this.parseFlipY(t,e),M=t?.getProperty("3d-colorSpace")||e?.getAttribute("string-3d-colorSpace")||"";return i!=="standard"&&!!(d||f||y||v||g)&&(i="standard"),i==="standard"?(d&&(c.map=this.loadTexture(d,{flipY:m,colorSpace:M})),f&&(c.normalMap=this.loadTexture(f,{flipY:m})),y&&(c.roughnessMap=this.loadTexture(y,{flipY:m})),v&&(c.metalnessMap=this.loadTexture(v,{flipY:m})),g&&(c.aoMap=this.loadTexture(g,{flipY:m})),typeof l=="number"&&(c.metalness=l),typeof h=="number"&&(c.roughness=h),this.engine.createMeshStandardMaterial(c)):this.engine.createMeshBasicMaterial(c)}loadTexture(e,t={}){let i=this.engine.createTextureLoader().load(e);typeof t.flipY=="boolean"&&(i.flipY=t.flipY);let s=(t.colorSpace||"").toLowerCase().trim();return s&&"colorSpace"in i&&(i.colorSpace=s==="srgb"?"srgb":"linear"),i.needsUpdate=!0,i}parseFlipY(e,t){let r=e?.getProperty("3d-texture-flipY")??t?.getAttribute("string-3d-texture-flipY");if(r==null||r==="")return;if(typeof r=="boolean")return r;let i=String(r).toLowerCase().trim();if(i==="false"||i==="0"||i==="no")return!1;if(i==="true"||i==="1"||i==="yes")return!0}shouldOverrideModelMaterial(e){return["string-3d-material","string-3d-color","string-3d-opacity","string-3d-map","string-3d-normalMap","string-3d-roughnessMap","string-3d-metalnessMap","string-3d-aoMap","string-3d-metalness","string-3d-roughness"].some(r=>e.hasAttribute(r))}applyModelTextureRemap(e,t){let r=(t.getAttribute("string-3d-model-texture-base")||"").trim(),i=r?r.replace(/\/?$/,"/"):"",s=t.getAttribute("string-3d-model-textures"),n=null;if(s)try{n=JSON.parse(s)}catch(l){console.warn("[String3D] Invalid model texture mapping JSON:",l)}let o=e?.manager;if(!o||typeof o.setURLModifier!="function"){(n||i)&&console.warn("[String3D] Model loader does not support URL remap.");return}o.setURLModifier(l=>{let h=n&&l in n?n[l]:l;return!i||/^(blob:|data:|https?:|file:|\/)/i.test(h)?h:i+h.replace(/^\.?\//,"")})}destroy(){this._objects.forEach(e=>e.destroy()),this._objects.clear(),this._rootObjects=[]}};var X=class{sync(e,t,r,i){let s=e.getBoundingClientRect(),n=s.left+s.width/2,o=s.top+s.height/2,l=e.computedStyleMap?.(),h=null,c=()=>(h||(h=getComputedStyle(e)),h),d=(u,w)=>{let p=l?.get?.(u);if(p!==void 0){if(typeof p=="number")return p;if(typeof p=="string"){let S=Number.parseFloat(p);if(!Number.isNaN(S))return S}if(p&&typeof p=="object"){let S=p.value;if(typeof S=="number")return S;if(typeof S=="string"){let T=Number.parseFloat(S);if(!Number.isNaN(T))return T}}}let b=c().getPropertyValue(u),E=Number.parseFloat(b);return Number.isNaN(E)?w:E},f=d("--translate-z",0),y=r.camera.screenToWorld(n,o,f);t.position=y;let v=d("--scale",1);t.scale=r.engine.createVector3(v,v,v);let g=-r.engine.degToRad(d("--rotate-x",0)),m=r.engine.degToRad(d("--rotate-y",0)),M=-r.engine.degToRad(d("--rotate-z",0));return t.rotation=r.engine.createEuler(g,m,M,"XYZ"),t.object.updateMatrixWorld(!0),{scale:v}}};var A=class{sync(e,t,r,i){let s=e.getBoundingClientRect(),n=s.left+s.width/2,o=s.top+s.height/2,l=parseFloat(getComputedStyle(e).getPropertyValue("--translate-z")||"0"),h=r.camera.screenToWorld(n,o,l);t.position=h;let c=t.object,d=e.getAttribute("string-3d-color");d&&c.color&&typeof c.color.set=="function"&&c.color.set(d);let f=e.getAttribute("string-3d-intensity");f&&(c.intensity=parseFloat(f));let y=e.getAttribute("string-3d-distance");y&&typeof c.distance<"u"&&(c.distance=parseFloat(y));let v=e.getAttribute("string-3d-decay");v&&typeof c.decay<"u"&&(c.decay=parseFloat(v));let g=e.getAttribute("string-3d-angle");g&&typeof c.angle<"u"&&(c.angle=parseFloat(g));let m=e.getAttribute("string-3d-penumbra");m&&typeof c.penumbra<"u"&&(c.penumbra=parseFloat(m));let M=e.getAttribute("string-3d-ground-color");M&&c.groundColor&&typeof c.groundColor.set=="function"&&c.groundColor.set(M);let u=e.getAttribute("string-3d-cast-shadow")==="true";if(c.castShadow!==u&&(c.castShadow=u),u&&c.shadow){let p=e.getAttribute("string-3d-shadow-bias");p&&(c.shadow.bias=parseFloat(p));let b=e.getAttribute("string-3d-shadow-map-size");if(b){let E=parseFloat(b);c.shadow.mapSize.width!==E&&(c.shadow.mapSize.width=E,c.shadow.mapSize.height=E)}}let w=e.getAttribute("string-3d-target");if(w&&c.target){let p=document.querySelector(`[string-id="${w}"]`);if(p){let b=p.getBoundingClientRect(),E=b.left+b.width/2,S=b.top+b.height/2,T=parseFloat(getComputedStyle(p).getPropertyValue("--translate-z")||"0"),D=r.camera.screenToWorld(E,S,T);c.target.position.copy(D),c.target.updateMatrixWorld(!0)}}return null}};var C=class a{static applyVisualProps(e,t,r){let i=e.getAttribute("string-3d-cast-shadow")==="true",s=e.getAttribute("string-3d-receive-shadow")==="true",n=typeof r=="number"?r:NaN;if(t.object.traverse)t.object.traverse(o=>{o.isMesh&&(o.castShadow!==i&&(o.castShadow=i),o.receiveShadow!==s&&(o.receiveShadow=s),isNaN(n)||(Array.isArray(o.material)?o.material:[o.material]).forEach(h=>{h&&(h.opacity=n,h.transparent=n<1)}))});else if(t.object.isMesh){let o=t.object;o.castShadow!==i&&(o.castShadow=i),o.receiveShadow!==s&&(o.receiveShadow=s),isNaN(n)||(Array.isArray(o.material)?o.material:[o.material]).forEach(h=>{h&&(h.opacity=n,h.transparent=n<1)})}}sync(e,t,r,i){let s=e.computedStyleMap?.(),n=null,o=()=>(n||(n=getComputedStyle(e)),n),l=e.getBoundingClientRect(),h=e.offsetWidth||l.width,c=e.offsetHeight||l.height,d=(k,F)=>{let L=s?.get?.(k);if(L!==void 0){if(typeof L=="number")return L;if(typeof L=="string"){let x=Number.parseFloat(L);if(!Number.isNaN(x))return x}if(L&&typeof L=="object"){let x=L.value;if(typeof x=="number")return x;if(typeof x=="string"){let H=Number.parseFloat(x);if(!Number.isNaN(H))return H}}}let Y=o().getPropertyValue(k),I=Number.parseFloat(Y);return Number.isNaN(I)?F:I},f=d("--translate-z",0),y=d("--scale",1),v=l.left+l.width/2,g=l.top+l.height/2,m=r.camera.screenToWorld(v,g,f);t.position=m;let M=-r.engine.degToRad(d("--rotate-x",0)),u=r.engine.degToRad(d("--rotate-y",0)),w=-r.engine.degToRad(d("--rotate-z",0));t.rotation=r.engine.createEuler(M,u,w,"XYZ");let p=h*y,b=c*y,E=d("--scale-z",1),S=i?.scale||1,T=t.type,D,R,O;switch(T){case"box":case"sphere":{let k=Math.min(p,b);D=k*S,R=k*S,O=k*E*S;break}case"model":{let F=t.getOriginalBoundingBox().getSize(r.engine.createVector3()),L=(e.getAttribute("string-3d-model-fit")||"contain").toLowerCase().trim(),Y=parseFloat(e.getAttribute("string-3d-model-scale")||"1"),I=Number.isFinite(Y)?Y:1;if(F.x>0&&F.y>0){let x=p/F.x,H=b/F.y,K=L==="cover"?Math.max(x,H):Math.min(x,H);D=K*I*S,R=K*I*S,O=K*I*E*S}else{let x=Math.min(p,b);D=x*I*S,R=x*I*S,O=x*I*E*S}break}case"cylinder":{let k=p;D=k*S,R=b*S,O=k*E*S;break}case"plane":default:D=p*S,R=b*S,O=Math.min(p,b)*.5*E*S;break}t.scale=r.engine.createVector3(D,R,O);let $=d("--opacity",NaN);return a.applyVisualProps(e,t,$),{scale:y*S}}};var W=class{constructor(e,t,r,i){this.camera=e;this.viewportWidth=t;this.viewportHeight=r;this.engine=i;this.strategies=new Map;this.strategies.set("box",new C),this.strategies.set("sphere",new C),this.strategies.set("plane",new C),this.strategies.set("cylinder",new C),this.strategies.set("model",new C),this.strategies.set("group",new X),this.strategies.set("pointLight",new A),this.strategies.set("ambientLight",new A),this.strategies.set("directionalLight",new A),this.strategies.set("spotLight",new A),this.strategies.set("hemisphereLight",new A)}syncElement(e,t,r){let i=this.strategies.get(t.type);return i?i.sync(e,t,{camera:this.camera,viewportWidth:this.viewportWidth,viewportHeight:this.viewportHeight,engine:this.engine},r):(console.warn(`[String3D Sync] No strategy for type "${t.type}"`),null)}updateViewportSize(e,t){this.viewportWidth=e,this.viewportHeight=t}};var me=`
let wasm = null;
let wasmReady = false;

function degToRad(deg) {
  return (deg * Math.PI) / 180;
}

function computeTransform(item, camera) {
  const centerX = item.rectLeft + item.rectWidth / 2;
  const centerY = item.rectTop + item.rectHeight / 2;

  let posX = 0;
  let posY = 0;
  let posZ = item.translateZ;

  if (camera.mode === "orthographic") {
    posX = centerX - camera.width / 2;
    posY = -(centerY - camera.height / 2);
  } else {
    const fov = degToRad(camera.fov);
    const distance = Math.abs(item.translateZ - camera.cameraZ);
    const height = 2 * Math.tan(fov / 2) * distance;
    const width = height * camera.aspect;
    const normalizedX = centerX / camera.width;
    const normalizedY = centerY / camera.height;
    posX = (normalizedX - 0.5) * width;
    posY = -(normalizedY - 0.5) * height;
  }

  const rotX = -degToRad(item.rotateX);
  const rotY = degToRad(item.rotateY);
  const rotZ = -degToRad(item.rotateZ);

  let scaleX = 1;
  let scaleY = 1;
  let scaleZ = 1;

  if (item.type === "group") {
    scaleX = item.scale;
    scaleY = item.scale;
    scaleZ = item.scale;
  } else {
    const targetWidth = item.rectWidth * item.scale;
    const targetHeight = item.rectHeight * item.scale;
    const parentScale = item.parentScale || 1;
    const cssScaleZ = item.scaleZ || 1;

    if (item.type === "box" || item.type === "sphere") {
      const uniformSize = Math.min(targetWidth, targetHeight);
      scaleX = uniformSize * parentScale;
      scaleY = uniformSize * parentScale;
      scaleZ = uniformSize * cssScaleZ * parentScale;
    } else if (item.type === "model") {
      const sizeX = item.modelSizeX || 0;
      const sizeY = item.modelSizeY || 0;
      const fitMode = (item.fitMode || "contain").toLowerCase().trim();
      const modelScale = Number.isFinite(item.modelScale) ? item.modelScale : 1;

      if (sizeX > 0 && sizeY > 0) {
        const scaleToWidth = targetWidth / sizeX;
        const scaleToHeight = targetHeight / sizeY;
        const uniformScale = fitMode === "cover"
          ? Math.max(scaleToWidth, scaleToHeight)
          : Math.min(scaleToWidth, scaleToHeight);
        scaleX = uniformScale * modelScale * parentScale;
        scaleY = uniformScale * modelScale * parentScale;
        scaleZ = uniformScale * modelScale * cssScaleZ * parentScale;
      } else {
        const fallbackSize = Math.min(targetWidth, targetHeight);
        scaleX = fallbackSize * modelScale * parentScale;
        scaleY = fallbackSize * modelScale * parentScale;
        scaleZ = fallbackSize * modelScale * cssScaleZ * parentScale;
      }
    } else if (item.type === "cylinder") {
      const cylRadius = targetWidth;
      scaleX = cylRadius * parentScale;
      scaleY = targetHeight * parentScale;
      scaleZ = cylRadius * cssScaleZ * parentScale;
    } else {
      scaleX = targetWidth * parentScale;
      scaleY = targetHeight * parentScale;
      scaleZ = Math.min(targetWidth, targetHeight) * 0.5 * cssScaleZ * parentScale;
    }
  }

  return {
    id: item.id,
    posX,
    posY,
    posZ,
    rotX,
    rotY,
    rotZ,
    scaleX,
    scaleY,
    scaleZ,
  };
}

async function initWasm(url) {
  try {
    const res = await fetch(url);
    const bytes = await res.arrayBuffer();
    const mod = await WebAssembly.instantiate(bytes, {});
    wasm = mod.instance;
    wasmReady = true;
  } catch (error) {
    wasm = null;
    wasmReady = false;
  }
}

self.onmessage = async (event) => {
  const data = event.data || {};
  if (data.type === "init") {
    if (data.wasmUrl) {
      await initWasm(data.wasmUrl);
    }
    self.postMessage({ type: "ready", wasmReady });
    return;
  }

  if (data.type === "compute") {
    const items = data.items || [];
    const camera = data.camera || {};
    const results = new Array(items.length);
    for (let i = 0; i < items.length; i += 1) {
      results[i] = computeTransform(items[i], camera);
    }
    self.postMessage({ type: "result", frameId: data.frameId, results });
  }
};
`,V=class{constructor(e={}){this.worker=null;this.ready=!1;this.lastResult=null;this.pending=!1;if(typeof Worker>"u")return;let t=new Blob([me],{type:"text/javascript"});this.worker=new Worker(URL.createObjectURL(t)),this.worker.onmessage=r=>{let i=r.data||{};if(i.type==="ready"){this.ready=!0;return}i.type==="result"&&(this.lastResult={frameId:typeof i.frameId=="number"?i.frameId:0,results:i.results||[]},this.pending=!1)},this.worker.postMessage({type:"init",wasmUrl:e.wasmUrl})}isReady(){return this.ready}isPending(){return this.pending}submit(e,t,r){!this.worker||!this.ready||this.pending||(this.pending=!0,this.worker.postMessage({type:"compute",frameId:r,items:e,camera:t}))}takeLastResult(){let e=this.lastResult;return this.lastResult=null,e}destroy(){this.worker?.terminate(),this.worker=null,this.ready=!1,this.pending=!1,this.lastResult=null}};var j=class j extends U{constructor(t){super(t);this.renderer=null;this.camera=null;this.scene=null;this.synchronizer=null;this.engine=null;this.canvasContainer=null;this.isLoading=new Map;this.useDirtySync=!1;this.dirtyElements=new Set;this.observedElements=new Set;this.resizeObserver=null;this.mutationObserver=null;this.lastSyncData=new WeakMap;this.transformWorker=null;this.workerHasResult=!1;this.workerObjectMap=new Map;this.domVersion=0;this.lastSubmittedVersion=0;this.scrollTicking=!1;this.onScrollBound=()=>this.handleScroll();this.htmlKey="3d",this.options=this.buildOptionsFromSettings(),this.attributesToMap=[...this.attributesToMap,{key:"3d",type:"string",fallback:"box"},{key:"3d-material",type:"string",fallback:"basic[#ffffff]"},{key:"3d-color",type:"string",fallback:"#ffffff"},{key:"3d-opacity",type:"number",fallback:1},{key:"3d-intensity",type:"number",fallback:1},{key:"3d-distance",type:"number",fallback:1e3},{key:"3d-decay",type:"number",fallback:0},{key:"3d-model",type:"string",fallback:""},{key:"3d-segments",type:"number",fallback:32},{key:"3d-segments-width",type:"number",fallback:32},{key:"3d-segments-height",type:"number",fallback:32},{key:"3d-model-loader",type:"string",fallback:""},{key:"3d-model-scale",type:"number",fallback:1},{key:"3d-model-center",type:"boolean",fallback:!1},{key:"3d-model-fit",type:"string",fallback:"contain"},{key:"3d-metalness",type:"number",fallback:0},{key:"3d-roughness",type:"number",fallback:1},{key:"3d-texture-flipY",type:"boolean",fallback:!0},{key:"3d-colorSpace",type:"string",fallback:""},{key:"3d-cast-shadow",type:"boolean",fallback:!1},{key:"3d-receive-shadow",type:"boolean",fallback:!1},{key:"3d-shadow-bias",type:"number",fallback:0},{key:"3d-shadow-map-size",type:"number",fallback:512},{key:"3d-angle",type:"number",fallback:Math.PI/3},{key:"3d-penumbra",type:"number",fallback:0},{key:"3d-ground-color",type:"string",fallback:"#ffffff"},{key:"3d-target",type:"string",fallback:""}]}static setProvider(t){j.provider=t}canConnect(t){let r=super.canConnect(t);return console.log("[String3D] canConnect:",t.id,"keys:",t.keys,"htmlKey:",this.htmlKey,"result:",r),r}initializeObject(t,r,i,s){super.initializeObject(t,r,i,s),r.setProperty("parentId",null);let n=i.parentElement?.closest('[string-3d="group"]');if(n){let o=n.getAttribute("string-id");o&&(r.setProperty("parentId",o),r.setProperty("parent",n))}}onResize(){this.renderer&&this.camera&&this.synchronizer&&(this.renderer.resize(this.camera),this.synchronizer.updateViewportSize(this.renderer.width,this.renderer.height),this.camera.clearScaleCache(),this.useDirtySync&&this.markAllDirty())}onInit(){if(this.options=this.buildOptionsFromSettings(),!j.provider){console.error("[String3D] No provider set. Call String3D.setProvider() before use.");return}this.engine=j.provider.getEngine(),this.canvasContainer=this.createOrGetContainer(),this.registerTypedProperties(),this.injectCSS(),this.useDirtySync=!!this.options.useDirtySync,this.useDirtySync&&(this.setupObservers(),this.setupScrollListeners()),this.renderer=new z(this.canvasContainer,this.engine),this.renderer.attach(),this.camera=new N(this.engine,"orthographic"),this.camera.setPosition(0,0,1e3),this.camera.resize(this.renderer.width,this.renderer.height);let t=this.resolveModelLoader(),r=this.resolveModelLoaderFactory();this.scene=new _(this.engine,{modelLoader:t,modelLoaderFactory:r}),this.scene.getScene().add(this.camera.camera),this.synchronizer=new W(this.camera,this.renderer.width,this.renderer.height,this.engine),this.options.useTransformWorker&&(this.transformWorker=new V({wasmUrl:this.options.transformWorkerWasmUrl})),console.info(`[String3D] Initialized with: ${j.provider.getName()}`)}onSettingsChange(){this.options=this.buildOptionsFromSettings();let t=!!this.options.useDirtySync;t&&!this.useDirtySync?(this.useDirtySync=!0,this.setupObservers(),this.setupScrollListeners(),this.observeSceneElements(),this.markAllDirty()):!t&&this.useDirtySync&&(this.useDirtySync=!1,this.removeScrollListeners(),this.resizeObserver?.disconnect(),this.mutationObserver?.disconnect(),this.dirtyElements.clear());let r=!!this.options.useTransformWorker;r&&!this.transformWorker?(this.transformWorker=new V({wasmUrl:this.options.transformWorkerWasmUrl}),this.workerHasResult=!1):!r&&this.transformWorker&&(this.transformWorker.destroy(),this.transformWorker=null,this.workerHasResult=!1)}buildOptionsFromSettings(){return{hideHTML:this.getSettingValue("hideHTML",!1),container:this.getSettingValue("container",void 0),zIndex:this.getSettingValue("zIndex",1),modelLoaderType:this.getSettingValue("modelLoaderType",void 0),modelLoader:this.getSettingValue("modelLoader",void 0),modelLoaderFactory:this.getSettingValue("modelLoaderFactory",void 0),useDirtySync:this.getSettingValue("useDirtySync",!1),useTransformWorker:this.getSettingValue("useTransformWorker",!1),transformWorkerWasmUrl:this.getSettingValue("transformWorkerWasmUrl",void 0)}}getSettingValue(t,r){return!this.settings||!(t in this.settings)?r:this.settings[t]}resolveModelLoader(){if(this.engine){if(this.options.modelLoader)return this.options.modelLoader;if(!this.options.modelLoaderFactory&&this.options.modelLoaderType)try{return this.engine.createModelLoader(this.options.modelLoaderType)}catch(t){console.warn("[String3D] Failed to create model loader:",t)}}}resolveModelLoaderFactory(){if(this.engine){if(this.options.modelLoaderFactory)return this.options.modelLoaderFactory;if(this.options.modelLoaderType)return(t,r)=>{let i=r||this.options.modelLoaderType;if(!i)throw new Error("[String3D] Model loader type not provided");return t.createModelLoader(i)}}}createOrGetContainer(){if(this.options.container instanceof HTMLElement)return this.applyContainerStyles(this.options.container),this.options.container;if(typeof this.options.container=="string"){let r=document.getElementById(this.options.container);if(r)return this.applyContainerStyles(r),r}let t=document.createElement("div");return t.id="string-3d-canvas",this.applyContainerStyles(t),document.body.insertBefore(t,document.body.firstChild),t}applyContainerStyles(t){Object.assign(t.style,{position:"fixed",left:"0",top:"0",width:"100vw",height:"100lvh",zIndex:String(this.options.zIndex),pointerEvents:"none"})}onObjectConnected(t){this.isLoading.has(t.id)||!this.scene||(this.isLoading.set(t.id,!0),this.scene.createFromElement(t),this.useDirtySync&&t.htmlElement&&(this.observeElement(t.htmlElement),this.markDirty(t.htmlElement)),this.options.hideHTML&&t.htmlElement&&(t.htmlElement.style.opacity="0",t.htmlElement.style.pointerEvents="none"))}onFrame(t){if(!this.renderer||!this.scene||!this.camera||!this.synchronizer)return;let r=this.transformWorker?.takeLastResult();r&&r.frameId===this.lastSubmittedVersion&&r.frameId>=this.domVersion&&(this.workerHasResult=!0,this.applyWorkerResults(r.results));let i=this.useDirtySync?this.dirtyElements:null,s=!i||i.size===0,n=this.transformWorker;if(n?.isReady()&&!n.isPending()){let o=[];if(this.workerObjectMap.clear(),this.scene.rootObjects.forEach(l=>{this.collectWorkerInputs(l,{scale:1},s,i,o)}),o.length>0){let l=this.domVersion;this.lastSubmittedVersion=l,n.submit(o,this.buildWorkerCameraData(),l)}}this.scene.rootObjects.forEach(o=>{this.syncRecursive(o.el,o,{scale:1},s,i)}),this.useDirtySync&&this.dirtyElements.clear(),this.renderer.render(this.scene,this.camera)}syncRecursive(t,r,i,s,n){if(!this.synchronizer||!t)return;let o=s||!n||n.has(t),l=i;if(o){let c=this.synchronizer.syncElement(t,r,i);c&&typeof c.scale=="number"&&(this.lastSyncData.set(r,c),l=c)}else{let c=this.lastSyncData.get(r);c&&(l=c)}let h=s||o;r.children.forEach(c=>this.syncRecursive(c.el,c,l,h,n))}injectCSS(){if(document.getElementById("string-3d-styles"))return;let t=document.createElement("style");t.id="string-3d-styles",t.textContent=`
      @property --translate-x { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --translate-y { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --translate-z { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --rotate-x { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --rotate-y { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --rotate-z { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --scale { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --scale-x { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --scale-y { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --scale-z { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --opacity { syntax: "<number>"; inherits: false; initial-value: 1; }

      [string-3d] {
        --translate-x: 0; --translate-y: 0; --translate-z: 0;
        --rotate-x: 0; --rotate-y: 0; --rotate-z: 0;
        --scale: 1; --scale-x: 1; --scale-y: 1; --scale-z: 1;--opacity: 1;
        transform-style: preserve-3d;
      }

      [string-3d-visual="true"] {
        transform:
          translate3d(calc(var(--translate-x) * 1px), calc(var(--translate-y) * 1px), calc(var(--translate-z) * 1px))
          rotateX(calc(var(--rotate-x) * 1deg))
          rotateY(calc(var(--rotate-y) * 1deg))
          rotateZ(calc(var(--rotate-z) * 1deg))
          scale3d(calc(var(--scale) * var(--scale-x)), calc(var(--scale) * var(--scale-y)), calc(var(--scale) * var(--scale-z)));
      }
    `,document.head.appendChild(t)}registerTypedProperties(){let t=globalThis.CSS;if(!t?.registerProperty)return;[{name:"--translate-x",initialValue:"0"},{name:"--translate-y",initialValue:"0"},{name:"--translate-z",initialValue:"0"},{name:"--rotate-x",initialValue:"0"},{name:"--rotate-y",initialValue:"0"},{name:"--rotate-z",initialValue:"0"},{name:"--scale",initialValue:"1"},{name:"--scale-x",initialValue:"1"},{name:"--scale-y",initialValue:"1"},{name:"--scale-z",initialValue:"1"},{name:"--opacity",initialValue:"1"}].forEach(({name:i,initialValue:s})=>{try{t.registerProperty({name:i,syntax:"<number>",inherits:!1,initialValue:s})}catch{}})}setupObservers(){typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(t=>{t.forEach(r=>{r.target instanceof HTMLElement&&this.markDirty(r.target)})})),typeof MutationObserver<"u"&&(this.mutationObserver=new MutationObserver(t=>{t.forEach(r=>{r.target instanceof HTMLElement&&this.markDirty(r.target)})}))}setupScrollListeners(){window.addEventListener("scroll",this.onScrollBound,{passive:!0}),window.addEventListener("resize",this.onScrollBound,{passive:!0}),window.visualViewport&&(window.visualViewport.addEventListener("scroll",this.onScrollBound,{passive:!0}),window.visualViewport.addEventListener("resize",this.onScrollBound,{passive:!0}))}removeScrollListeners(){window.removeEventListener("scroll",this.onScrollBound),window.removeEventListener("resize",this.onScrollBound),window.visualViewport&&(window.visualViewport.removeEventListener("scroll",this.onScrollBound),window.visualViewport.removeEventListener("resize",this.onScrollBound))}handleScroll(){this.useDirtySync&&this.markAllDirty()}observeElement(t){this.observedElements.has(t)||(this.observedElements.add(t),this.resizeObserver?.observe(t),this.mutationObserver?.observe(t,{attributes:!0,attributeFilter:["style","class","string-3d","string-3d-model-fit","string-3d-model-scale","string-3d-cast-shadow","string-3d-receive-shadow","string-3d-opacity","string-3d-target"]}))}observeSceneElements(){this.scene&&this.scene.rootObjects.forEach(t=>{this.observeRecursive(t)})}observeRecursive(t){t.el instanceof HTMLElement&&this.observeElement(t.el),t.children.forEach(r=>this.observeRecursive(r))}markDirty(t){this.dirtyElements.add(t),this.domVersion+=1}markAllDirty(){this.observedElements.forEach(t=>this.dirtyElements.add(t)),this.domVersion+=1}readNumberStyle(t,r,i){let n=t.computedStyleMap?.()?.get?.(r);if(n!==void 0){if(typeof n=="number")return n;if(typeof n=="string"){let c=Number.parseFloat(n);if(!Number.isNaN(c))return c}if(n&&typeof n=="object"){let c=n.value;if(typeof c=="number")return c;if(typeof c=="string"){let d=Number.parseFloat(c);if(!Number.isNaN(d))return d}}}let l=getComputedStyle(t).getPropertyValue(r),h=Number.parseFloat(l);return Number.isNaN(h)?i:h}buildWorkerCameraData(){return{mode:this.camera.getMode(),width:this.renderer.width,height:this.renderer.height,cameraZ:this.camera.getPositionZ(),fov:this.camera.getPerspectiveFov(),aspect:this.renderer.width/this.renderer.height}}collectWorkerInputs(t,r,i,s,n){if(!this.synchronizer||!t.el)return;let o=t.el,l=i||!s||s.has(o),h=r;if(t.type.endsWith("Light")){l&&this.synchronizer.syncElement(o,t,r);return}if(l){let d=o.getBoundingClientRect(),f=o.offsetWidth||d.width,y=o.offsetHeight||d.height,v=this.readNumberStyle(o,"--translate-z",0),g=this.readNumberStyle(o,"--scale",1),m=this.readNumberStyle(o,"--scale-z",1),M=this.readNumberStyle(o,"--rotate-x",0),u=this.readNumberStyle(o,"--rotate-y",0),w=this.readNumberStyle(o,"--rotate-z",0),p=this.readNumberStyle(o,"--opacity",NaN);t.type!=="group"&&C.applyVisualProps(o,t,p);let b,E,S,T;if(t.type==="model"){let O=t.getOriginalBoundingBox().getSize(this.engine.createVector3());b=O.x,E=O.y;let $=parseFloat(o.getAttribute("string-3d-model-scale")||"1");S=Number.isFinite($)?$:1,T=(o.getAttribute("string-3d-model-fit")||"contain").toLowerCase().trim()}let D=t.type==="group"?g:g*r.scale;this.lastSyncData.set(t,{scale:D}),h={scale:D},this.workerObjectMap.set(t.id,{object:t,el:o}),n.push({id:t.id,type:t.type,rectLeft:d.left,rectTop:d.top,rectWidth:f,rectHeight:y,translateZ:v,scale:g,scaleZ:m,rotateX:M,rotateY:u,rotateZ:w,parentScale:r.scale,modelSizeX:b,modelSizeY:E,modelScale:S,fitMode:T})}else{let d=this.lastSyncData.get(t);d&&(h=d)}let c=i||l;t.children.forEach(d=>{this.collectWorkerInputs(d,h,c,s,n)})}applyWorkerResults(t){this.engine&&t.forEach(r=>{let i=this.workerObjectMap.get(r.id);if(!i)return;let s=i.object;s.position=this.engine.createVector3(r.posX,r.posY,r.posZ),s.rotation=this.engine.createEuler(r.rotX,r.rotY,r.rotZ,"XYZ"),s.scale=this.engine.createVector3(r.scaleX,r.scaleY,r.scaleZ),s.type==="group"&&s.object.updateMatrixWorld(!0)})}destroy(){this.renderer?.destroy(),this.scene?.destroy(),this.isLoading.clear(),this.transformWorker?.destroy(),this.transformWorker=null,this.removeScrollListeners(),this.resizeObserver?.disconnect(),this.mutationObserver?.disconnect(),this.observedElements.clear(),this.dirtyElements.clear(),this.workerObjectMap.clear(),this.lastSyncData=new WeakMap,document.getElementById("string-3d-styles")?.remove(),this.canvasContainer?.id==="string-3d-canvas"&&this.canvasContainer.remove(),super.destroy()}};j.provider=null;var G=j;var B=class{constructor(e,t={}){this.THREE=e,this.loaders=t}createVector3(e=0,t=0,r=0){return new this.THREE.Vector3(e,t,r)}createVector2(e=0,t=0){return new this.THREE.Vector2(e,t)}createQuaternion(e=0,t=0,r=0,i=1){return new this.THREE.Quaternion(e,t,r,i)}createEuler(e=0,t=0,r=0,i="XYZ"){return new this.THREE.Euler(e,t,r,i)}createMatrix4(){return new this.THREE.Matrix4}createBox3(e,t){return new this.THREE.Box3(e,t)}createScene(){return new this.THREE.Scene}createRenderer(e){let t=new this.THREE.WebGLRenderer(e);return t.outputEncoding=this.THREE.sRGBEncoding,t}createPerspectiveCamera(e=45,t=1,r=.1,i=2e3){return new this.THREE.PerspectiveCamera(e,t,r,i)}createOrthographicCamera(e,t,r,i,s=.1,n=1e4){return new this.THREE.OrthographicCamera(e,t,r,i,s,n)}createGroup(){return new this.THREE.Group}createMesh(e,t){return new this.THREE.Mesh(e,t)}createBoxGeometry(e,t,r){return new this.THREE.BoxGeometry(e,t,r)}createSphereGeometry(e,t=32,r=32){return new this.THREE.SphereGeometry(e,t,r)}createPlaneGeometry(e,t){return new this.THREE.PlaneGeometry(e,t)}createCylinderGeometry(e,t,r,i=32){return new this.THREE.CylinderGeometry(e,t,r,i)}createMeshBasicMaterial(e){return new this.THREE.MeshBasicMaterial(e)}createMeshStandardMaterial(e){return new this.THREE.MeshStandardMaterial(e)}createPointLight(e,t=1,r=0,i=2){return new this.THREE.PointLight(e,t,r,i)}createSpotLight(e,t=1,r=0,i=Math.PI/3,s=0,n=1){return new this.THREE.SpotLight(e,t,r,i,s,n)}createHemisphereLight(e,t,r=1){return new this.THREE.HemisphereLight(e,t,r)}createAmbientLight(e,t=1){return new this.THREE.AmbientLight(e,t)}createDirectionalLight(e,t=1){return new this.THREE.DirectionalLight(e,t)}createTextureLoader(){return new this.THREE.TextureLoader}createModelLoader(e){let t=this.loaders[e];if(!t)throw new Error(`[ThreeJSEngine] Model loader "${e}" not registered`);return new t}degToRad(e){return this.THREE.MathUtils.degToRad(e)}radToDeg(e){return this.THREE.MathUtils.radToDeg(e)}computeBoundingBoxRecursively(e){let t=new this.THREE.Box3,r=!1;return e.traverse&&e.traverse(i=>{if(i.visible&&i.geometry){typeof i.geometry.computeBoundingBox=="function"&&i.geometry.computeBoundingBox();let s=i.geometry.boundingBox;if(s){let n=s.clone().applyMatrix4(i.matrixWorld);t.union(n),r=!0}}}),r?t:new this.THREE.Box3}},Z=class{constructor(e,t={}){this.engine=new B(e,t)}getEngine(){return this.engine}getName(){return"Three.js"}};return le(ge);})();
//# sourceMappingURL=index.js.map