import{StringModule as ht}from"@fiddle-digital/string-tune";var Te=class{constructor(e,t="perspective",i=50,r=.1,a=1e4){this.scaleCache=new Map;this._width=1;this._height=1;this.engine=e,this.mode=t,this.perspectiveFov=i,t==="orthographic"?this._camera=e.createOrthographicCamera(-1,1,1,-1,r,a):this._camera=e.createPerspectiveCamera(i,1,r,a),this._position=e.createVector3(0,0,1e3),this.update()}get camera(){return this._camera}resize(e,t){if(this._width=e,this._height=t,this.mode==="orthographic"){let i=this._camera;i.left=-e/2,i.right=e/2,i.top=t/2,i.bottom=-t/2}else this._camera.aspect=e/t;this.update()}setPosition(e,t,i){this._position.set(e,t,i),this._camera.position.copy(this._position),this.update()}lookAt(e,t,i){this._camera.lookAt(e,t,i),this.update()}update(){this._camera.updateProjectionMatrix(),this._camera.updateMatrixWorld?.()}screenToWorld(e,t,i=0){if(this.mode==="orthographic"){let r=e-this._width/2,a=-(t-this._height/2);return this.engine.createVector3(r,a,i)}else{let{width:r,height:a}=this.getFrustumSizeAt(i),s=e/this._width,o=t/this._height,n=(s-.5)*r,l=-(o-.5)*a;return this.engine.createVector3(n,l,i)}}getFrustumSizeAt(e){if(this.mode==="orthographic")return{width:this._width,height:this._height};let t=this.engine.degToRad(this.perspectiveFov),i=Math.abs(e-this._camera.position.z),r=2*Math.tan(t/2)*i;return{width:r*this._camera.aspect,height:r}}getScaleAtZ(e,t){if(this.mode==="orthographic")return 1;let i=Math.round(e*1e3)/1e3;if(this.scaleCache.has(i))return this.scaleCache.get(i);let{height:r}=this.getFrustumSizeAt(e),a=r/t;return this.scaleCache.set(i,a),a}clearScaleCache(){this.scaleCache.clear()}getMode(){return this.mode}getPerspectiveFov(){return this.perspectiveFov}getPositionZ(){return this._position.z}};var Se=class{static register(e){let t=e.name.trim().toLowerCase();if(!t)throw new Error("[String3D] Custom filter name is required.");this.filters.set(t,{...e,name:t})}static get(e){return this.filters.get(e.trim().toLowerCase())}static has(e){return this.filters.has(e.trim().toLowerCase())}static list(){return Array.from(this.filters.values())}};Se.filters=new Map;var $e=class{constructor(e){this.pool=[];this.create=e}acquire(e,t){let i=this.pool.pop()||this.create(e,t);return(i.width!==e||i.height!==t)&&i.setSize(e,t),i}release(e){this.pool.push(e)}dispose(){this.pool.forEach(e=>e.dispose()),this.pool=[]}},Re=class{constructor(e,t,i,r){this.scale=1;this.customMaterials=new Map;this.engine=e,this.renderer=t,this.width=i,this.height=r,this.scene=e.createScene(),this.camera=e.createOrthographicCamera(-1,1,1,-1,0,1);let a=e.createPlaneGeometry(2,2);this.copyMaterial=this.createCopyMaterial(),this.blurMaterial=this.createBlurMaterial(),this.pixelMaterial=this.createPixelMaterial(),this.bloomExtractMaterial=this.createBloomExtractMaterial(),this.bloomAddMaterial=this.createBloomAddMaterial(),this.colorMaterial=this.createColorMaterial(),this.quad=e.createMesh(a,this.copyMaterial),this.scene.add(this.quad);let s=(o,n)=>{if(!this.engine.createRenderTarget)throw new Error("[String3DFilterPipeline] Render target support missing.");return this.engine.createRenderTarget(o,n)};this.pool=new $e(s)}isSupported(){return!!this.engine.createRenderTarget&&!!this.engine.createShaderMaterial&&!!this.renderer.setRenderTarget}resize(e,t){this.width=e,this.height=t}setScale(e){let t=Math.max(.75,Math.min(1,e));this.scale=t}applyFilters(e,t,i=1){let r=e,a=[],s=n=>{let l=a.indexOf(n);l>=0&&(a.splice(l,1),this.pool.release(n))},o=()=>{let{width:n,height:l}=this.getScaledSize(),c=this.pool.acquire(n,l);return a.push(c),c};return t.forEach(n=>{if(n.type==="blur"){let l=n.amount*i;if(l<=1e-4)return;let c=o();this.renderPass(this.blurMaterial,r,c,{uDirection:[1,0],uRadius:l});let h=o();this.renderPass(this.blurMaterial,c,h,{uDirection:[0,1],uRadius:l}),s(c),r!==e&&s(r),r=h}else if(n.type==="pixel"){if(n.size<=.5)return;let l=o();this.renderPass(this.pixelMaterial,r,l,{uPixelSize:n.size}),r!==e&&s(r),r=l}else if(n.type==="bloom"){let l=n.intensity;if(l<=1e-4||n.threshold>=.99)return;let c=Math.max(1,4*i),h=o();this.renderPass(this.bloomExtractMaterial,r,h,{uThreshold:n.threshold});let u=o();this.renderPass(this.blurMaterial,h,u,{uDirection:[1,0],uRadius:c});let d=o();this.renderPass(this.blurMaterial,u,d,{uDirection:[0,1],uRadius:c}),s(h),s(u);let p=o();this.renderAddPass(r,d,p,l),s(d),r!==e&&s(r),r=p}else if(n.type==="brightness"||n.type==="contrast"||n.type==="saturate"||n.type==="grayscale"||n.type==="sepia"||n.type==="invert"||n.type==="hue-rotate"){let l=o(),c=this.getColorMode(n.type),h=n.type==="hue-rotate"?n.angle:n.amount;this.renderPass(this.colorMaterial,r,l,{uMode:c,uAmount:h}),r!==e&&s(r),r=l}else if(n.type==="custom"){let l=o(),c=this.getCustomMaterial(n.name);c?(this.renderPass(c,r,l,n.uniforms),r!==e&&s(r),r=l):s(l)}}),a.forEach(n=>{n!==r&&this.pool.release(n)}),r}acquireTarget(){let{width:e,height:t}=this.getScaledSize();return this.pool.acquire(e,t)}releaseTarget(e){this.pool.release(e)}renderToScreen(e){this.renderPass(this.copyMaterial,e,null,{},!1)}dispose(){this.pool.dispose(),this.customMaterials.forEach(e=>e.dispose()),this.customMaterials.clear()}renderPass(e,t,i,r={},a=!0){let s=this.renderer;s.setRenderTarget&&s.setRenderTarget(i),this.setMaterial(this.quad,e),this.setUniform(e,"tDiffuse",t.texture);let{width:o,height:n}=this.getScaledSize();this.setUniform(e,"uResolution",[o,n]),this.setUniform(e,"uTexel",[1/o,1/n]),Object.entries(r).forEach(([l,c])=>this.setUniform(e,l,c)),a&&s.clear&&s.clear(!0,!0,!0),this.renderer.render(this.scene,this.camera)}renderAddPass(e,t,i,r){let a=this.renderer;a.setRenderTarget&&a.setRenderTarget(i),this.setMaterial(this.quad,this.bloomAddMaterial),this.setUniform(this.bloomAddMaterial,"tBase",e.texture),this.setUniform(this.bloomAddMaterial,"tBloom",t.texture),this.setUniform(this.bloomAddMaterial,"uIntensity",r);let{width:s,height:o}=this.getScaledSize();this.setUniform(this.bloomAddMaterial,"uResolution",[s,o]),a.clear&&a.clear(!0,!0,!0),this.renderer.render(this.scene,this.camera)}setMaterial(e,t){let i=e;i.material!==t&&(i.material=t)}setUniform(e,t,i){let r=e.uniforms;r&&(r[t]?r[t].value=i:r[t]={value:i})}createCopyMaterial(){return this.createShaderMaterial({uniforms:{tDiffuse:{value:null}},vertexShader:this.getVertexShader(),fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tDiffuse;
        void main() {
          gl_FragColor = texture2D(tDiffuse, vUv);
        }
      `,transparent:!0,depthTest:!1,depthWrite:!1})}createPixelMaterial(){return this.createShaderMaterial({uniforms:{tDiffuse:{value:null},uResolution:{value:[this.width,this.height]},uPixelSize:{value:1}},vertexShader:this.getVertexShader(),fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tDiffuse;
        uniform vec2 uResolution;
        uniform float uPixelSize;
        void main() {
          vec2 pixel = uPixelSize / uResolution;
          vec2 coord = floor(vUv / pixel) * pixel + pixel * 0.5;
          gl_FragColor = texture2D(tDiffuse, coord);
        }
      `,transparent:!0,depthTest:!1,depthWrite:!1})}createBlurMaterial(){return this.createShaderMaterial({uniforms:{tDiffuse:{value:null},uTexel:{value:[1/this.width,1/this.height]},uDirection:{value:[1,0]},uRadius:{value:2}},vertexShader:this.getVertexShader(),fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tDiffuse;
        uniform vec2 uTexel;
        uniform vec2 uDirection;
        uniform float uRadius;
        void main() {
          vec2 off1 = uDirection * uTexel * uRadius;
          vec2 off2 = uDirection * uTexel * uRadius * 2.0;
          vec2 off3 = uDirection * uTexel * uRadius * 3.0;
          vec2 off4 = uDirection * uTexel * uRadius * 4.0;
          vec4 color = texture2D(tDiffuse, vUv) * 0.227027;
          color += texture2D(tDiffuse, vUv + off1) * 0.1945946;
          color += texture2D(tDiffuse, vUv - off1) * 0.1945946;
          color += texture2D(tDiffuse, vUv + off2) * 0.1216216;
          color += texture2D(tDiffuse, vUv - off2) * 0.1216216;
          color += texture2D(tDiffuse, vUv + off3) * 0.054054;
          color += texture2D(tDiffuse, vUv - off3) * 0.054054;
          color += texture2D(tDiffuse, vUv + off4) * 0.016216;
          color += texture2D(tDiffuse, vUv - off4) * 0.016216;
          gl_FragColor = color;
        }
      `,transparent:!0,depthTest:!1,depthWrite:!1})}createBloomExtractMaterial(){return this.createShaderMaterial({uniforms:{tDiffuse:{value:null},uThreshold:{value:.8}},vertexShader:this.getVertexShader(),fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tDiffuse;
        uniform float uThreshold;
        void main() {
          vec4 color = texture2D(tDiffuse, vUv);
          float brightness = max(max(color.r, color.g), color.b);
          gl_FragColor = brightness > uThreshold ? color : vec4(0.0);
        }
      `,transparent:!0,depthTest:!1,depthWrite:!1})}createBloomAddMaterial(){return this.createShaderMaterial({uniforms:{tBase:{value:null},tBloom:{value:null},uIntensity:{value:1},uResolution:{value:[this.width,this.height]}},vertexShader:this.getVertexShader(),fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tBase;
        uniform sampler2D tBloom;
        uniform float uIntensity;
        void main() {
          vec4 base = texture2D(tBase, vUv);
          vec4 bloom = texture2D(tBloom, vUv);
          gl_FragColor = vec4(base.rgb + bloom.rgb * uIntensity, base.a);
        }
      `,transparent:!0,depthTest:!1,depthWrite:!1})}createColorMaterial(){return this.createShaderMaterial({uniforms:{tDiffuse:{value:null},uMode:{value:0},uAmount:{value:1}},vertexShader:this.getVertexShader(),fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tDiffuse;
        uniform int uMode;
        uniform float uAmount;

        vec3 applyHueRotate(vec3 color, float angle) {
          float cosA = cos(angle);
          float sinA = sin(angle);
          mat3 m = mat3(
            0.213 + cosA * 0.787 - sinA * 0.213,
            0.715 - cosA * 0.715 - sinA * 0.715,
            0.072 - cosA * 0.072 + sinA * 0.928,
            0.213 - cosA * 0.213 + sinA * 0.143,
            0.715 + cosA * 0.285 + sinA * 0.140,
            0.072 - cosA * 0.072 - sinA * 0.283,
            0.213 - cosA * 0.213 - sinA * 0.787,
            0.715 - cosA * 0.715 + sinA * 0.715,
            0.072 + cosA * 0.928 + sinA * 0.072
          );
          return clamp(m * color, 0.0, 1.0);
        }

        void main() {
          vec4 color = texture2D(tDiffuse, vUv);
          float luma = dot(color.rgb, vec3(0.299, 0.587, 0.114));

          if (uMode == 1) {
            color.rgb *= uAmount;
          } else if (uMode == 2) {
            color.rgb = (color.rgb - 0.5) * uAmount + 0.5;
          } else if (uMode == 3) {
            color.rgb = mix(vec3(luma), color.rgb, uAmount);
          } else if (uMode == 4) {
            color.rgb = mix(color.rgb, vec3(luma), uAmount);
          } else if (uMode == 5) {
            vec3 sepia = vec3(
              dot(color.rgb, vec3(0.393, 0.769, 0.189)),
              dot(color.rgb, vec3(0.349, 0.686, 0.168)),
              dot(color.rgb, vec3(0.272, 0.534, 0.131))
            );
            color.rgb = mix(color.rgb, sepia, uAmount);
          } else if (uMode == 6) {
            color.rgb = mix(color.rgb, vec3(1.0) - color.rgb, uAmount);
          } else if (uMode == 7) {
            color.rgb = applyHueRotate(color.rgb, uAmount);
          }

          gl_FragColor = color;
        }
      `,transparent:!0,depthTest:!1,depthWrite:!1})}getColorMode(e){switch(e){case"brightness":return 1;case"contrast":return 2;case"saturate":return 3;case"grayscale":return 4;case"sepia":return 5;case"invert":return 6;case"hue-rotate":return 7;default:return 0}}createShaderMaterial(e){if(!this.engine.createShaderMaterial)throw new Error("[String3DFilterPipeline] Shader material support missing.");return this.engine.createShaderMaterial(e)}getCustomMaterial(e){let t=e.trim().toLowerCase();if(!t)return null;if(this.customMaterials.has(t))return this.customMaterials.get(t);let i=Se.get(t);if(!i)return null;let r={tDiffuse:{value:null}},{width:a,height:s}=this.getScaledSize();r.uResolution={value:[a,s]},r.uTexel={value:[1/a,1/s]},Object.entries(i.uniforms||{}).forEach(([n,l])=>{r[n]={value:l}});let o=this.createShaderMaterial({uniforms:r,vertexShader:this.getVertexShader(),fragmentShader:i.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1});return this.customMaterials.set(t,o),o}getScaledSize(){let e=Math.max(1,Math.round(this.width*this.scale)),t=Math.max(1,Math.round(this.height*this.scale));return{width:e,height:t}}getVertexShader(){return`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `}};var Ie=class{constructor(e,t){this.filterPipeline=null;this.filterCache=new Map;this.frameId=0;this.lastFrameTime=performance.now();this.avgFrameMs=16.7;this.qualityScale=1;this.lastQualityChange=0;this.filterLayer=1;this.engine=t,this._container=e;let{width:i,height:r}=e.getBoundingClientRect();this._width=i,this._height=r,this._renderer=t.createRenderer({antialias:!0,alpha:!0,logarithmicDepthBuffer:!0});let a=this._renderer;typeof a.setClearColor=="function"&&a.setClearColor(0,0),this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(i,r),this._renderer.shadowMap&&(this._renderer.shadowMap.enabled=!0)}attach(){this._container.appendChild(this._renderer.domElement)}render(e,t,i=[]){if(i.length===0){this._renderer.render(e.getScene(),t.camera);return}let r=this.ensureFilterPipeline();if(!r?.isSupported()){this._renderer.render(e.getScene(),t.camera);return}this.frameId+=1,this.updateQuality(i.length,r);let a=e.getAllObjects(),s=new Map;a.forEach(u=>{let d=u.object;"visible"in d&&s.set(u.object,d.visible)});let o=new Set;i.forEach(u=>{this.collectSubtreeObjects(u.object,o)}),a.forEach(u=>{o.has(u.object)&&this.setVisible(u.object,!1)});let n=this._renderer,l=n.autoClear;n.autoClear=!0,n.setRenderTarget&&n.setRenderTarget(null),n.clear&&n.clear(!0,!0,!0),this._renderer.render(e.getScene(),t.camera),n.autoClear=!1,a.forEach(u=>{let d=s.get(u.object);typeof d<"u"&&this.setVisible(u.object,d)});let c=a.filter(u=>u.type.endsWith("Light")),h=this.supportsLayers(t.camera,a);i.forEach(u=>{let d=this.filterCache.get(u.object.id);if(!u.dirty&&d&&d.effectsKey===u.effectsKey&&d.qualityScale===this.qualityScale){d.lastUsedFrame=this.frameId,r.renderToScreen(d.target);return}let m=this.injectEffectContext(u.object.el,u.effects),f=new Set;this.collectSubtreeObjects(u.object,f);let C=[],v=null;if(h){let T=u.object.getSubtreeObjects();C=this.applyLayerMask(T,c,this.filterLayer),v=this.setCameraLayer(t.camera,this.filterLayer)}else a.forEach(T=>{if(s.get(T.object)===!1){this.setVisible(T.object,!1);return}if(T.type.endsWith("Light")){this.setVisible(T.object,!0);return}this.setVisible(T.object,f.has(T.object))});let y=r.acquireTarget();n.setRenderTarget&&n.setRenderTarget(y),n.clear&&n.clear(!0,!0,!0),this._renderer.render(e.getScene(),t.camera);let M=r.applyFilters(y,m,this.qualityScale);n.setRenderTarget&&n.setRenderTarget(null),r.renderToScreen(M),h&&(this.restoreLayerMask(C),v!==null&&this.restoreCameraLayer(t.camera,v)),M!==y&&r.releaseTarget(y);let P={target:M,effectsKey:u.effectsKey,lastUsedFrame:this.frameId,qualityScale:this.qualityScale},j=this.filterCache.get(u.object.id);j&&j.target!==M&&r.releaseTarget(j.target),this.filterCache.set(u.object.id,P)}),h||a.forEach(u=>{let d=s.get(u.object);typeof d<"u"&&this.setVisible(u.object,d)}),n.autoClear=l,this.evictCache()}resize(e){let{width:t,height:i}=this._container.getBoundingClientRect();this._width=t,this._height=i,this._renderer.setSize(t,i),e.resize(t,i),this.filterPipeline?.resize(t,i),this.invalidateFilterCache()}get width(){return this._width}get height(){return this._height}get renderer(){return this._renderer}destroy(){this._renderer.dispose(),this.filterPipeline?.dispose(),this.filterCache.clear()}ensureFilterPipeline(){return this.canCreateFilterPipeline()?(this.filterPipeline||(this.filterPipeline=new Re(this.engine,this._renderer,this._width,this._height),this.filterPipeline.setScale(this.qualityScale)),this.filterPipeline):null}canCreateFilterPipeline(){return typeof this.engine.createRenderTarget=="function"&&typeof this.engine.createShaderMaterial=="function"&&typeof this._renderer.setRenderTarget=="function"}collectSubtreeObjects(e,t){t.add(e.object),e.children.forEach(i=>this.collectSubtreeObjects(i,t))}setVisible(e,t){let i=e;"visible"in i&&(i.visible=t)}getFilterCenter(e){if(!e||!this._width||!this._height)return[.5,.5];let t=e.__layoutCache,i=t?t.rect:e.getBoundingClientRect(),r=(i.left+i.width/2)/this._width,a=1-(i.top+i.height/2)/this._height,s=o=>Math.max(0,Math.min(1,o));return[s(r),s(a)]}injectEffectContext(e,t){if(!t.some(s=>s.type==="custom"))return t;let i=this.getFilterCenter(e),r=!1,a=t.map(s=>{if(s.type!=="custom"||s.uniforms&&"uCenter"in s.uniforms)return s;let o={...s.uniforms||{},uCenter:i};return r=!0,{...s,uniforms:o}});return r?a:t}updateQuality(e,t){let i=performance.now(),r=Math.max(.1,i-this.lastFrameTime);this.lastFrameTime=i,this.avgFrameMs=this.avgFrameMs*.9+r*.1;let a=1e3/this.avgFrameMs,s=Math.max(.75,1-Math.min(.4,e*.03)),o=s;a<48&&(o=Math.max(.75,s-.1)),a<40&&(o=Math.max(.75,s-.2)),a>58&&(o=Math.min(1,s+.05)),Math.abs(o-this.qualityScale)>=.05&&i-this.lastQualityChange>300&&(this.qualityScale=o,this.lastQualityChange=i,t.setScale(this.qualityScale),this.invalidateFilterCache())}invalidateFilterCache(){this.filterPipeline&&(this.filterCache.forEach(e=>{this.filterPipeline?.releaseTarget(e.target)}),this.filterCache.clear())}evictCache(){if(!this.filterPipeline)return;let e=120;this.filterCache.forEach((t,i)=>{this.frameId-t.lastUsedFrame>e&&(this.filterPipeline?.releaseTarget(t.target),this.filterCache.delete(i))})}supportsLayers(e,t){return!e?.layers||typeof e.layers.set!="function"?!1:t.some(i=>this.hasLayers(i.object))}hasLayers(e){return e?.layers&&typeof e.layers.set=="function"}applyLayerMask(e,t,i){let r=new Map,a=(s,o)=>{let n=s;this.hasLayers(n)&&(r.has(s)||r.set(s,n.layers.mask),o==="set"?n.layers.set(i):n.layers.enable(i))};return e.forEach(s=>a(s,"set")),t.forEach(s=>a(s.object,"enable")),Array.from(r.entries()).map(([s,o])=>({object:s,mask:o}))}restoreLayerMask(e){e.forEach(t=>{let i=t.object;this.hasLayers(i)&&(i.layers.mask=t.mask)})}setCameraLayer(e,t){if(!e?.layers||typeof e.layers.set!="function")return null;let i=e.layers.mask;return e.layers.set(t),i}restoreCameraLayer(e,t){e?.layers&&(e.layers.mask=t)}};var ne=class{constructor(e,t,i,r,a={}){this._uniforms={};this._children=[];this._flatObjectsCache=null;this._subtreeCache=null;this.id=e,this.type=t,this._object=i,this.engine=r,this._material=a.material,this._geometry=a.geometry,this._texture=a.texture,this._quaternion=r.createQuaternion(),this._originalSize=r.createVector3(),this._bbox=r.createBox3(),this.updateBoundingBox()}get children(){return this._children}get object(){return this._object}get material(){return this._material}get originalSize(){return this._originalSize.clone()}get boundingBox(){return this._bbox.clone()}addChild(e){this._children.push(e),this.object.add(e.object),this.invalidateFlatCache(),this.invalidateSubtreeCache()}getWorldMatrix(){return this._object.matrixWorld.clone()}getWorldPosition(){return this.engine.createVector3().setFromMatrixPosition(this._object.matrixWorld)}getOriginalBoundingBox(){if(!this._originalBoundingBox){let e=this.object.scale.clone();this.object.scale.set(1,1,1),this.object.updateMatrixWorld(!0),this._originalBoundingBox=this.engine.computeBoundingBoxRecursively(this.object),this.object.scale.copy(e),this.object.updateMatrixWorld(!0)}return this._originalBoundingBox.clone()}syncTransformFromMatrix(e){let t=this.engine.createVector3(),i=this.engine.createQuaternion(),r=this.engine.createVector3();e.decompose(t,i,r),this._object.position.copy(t),this._object.quaternion.copy(i),this._object.scale.copy(r),this._object.updateMatrix(),this._object.updateMatrixWorld()}applyWorldTransform(e,t,i){this._object.position.copy(e),this._object.quaternion.copy(t),this._object.scale.copy(i),this._object.updateMatrix(),this._object.updateMatrixWorld()}set quaternion(e){this._quaternion.copy(e),this._object.quaternion.copy(this._quaternion),this._object.updateMatrixWorld()}set position(e){this._object.position.copy(e)}set scale(e){this._object.scale.copy(e)}set rotation(e){this._object.rotation.copy(e)}set opacity(e){let t=this._object;t.material&&"opacity"in t.material&&(t.material.opacity=e)}set metalness(e){let t=this._object;t.material&&"metalness"in t.material&&(t.material.metalness=e)}set roughness(e){let t=this._object;t.material&&"roughness"in t.material&&(t.material.roughness=e)}set texture(e){this._texture=e,this._object.isMesh&&e?.applyTexture&&e.applyTexture(this._object)}set material(e){this._material=e}set geometry(e){this._geometry=e}updateBoundingBox(){this._bbox.setFromObject(this._object),this._bbox.getSize(this._originalSize)}destroy(){this.disposeObjectResources(this._object),this._texture?.dispose?.(),this._material?.dispose(),this._geometry?.dispose(),this._subtreeCache=null}getFlatObjects(){if(this._flatObjectsCache)return this._flatObjectsCache;let e=[],t=i=>{e.push(i.object),i.children.forEach(r=>t(r))};return t(this),this._flatObjectsCache=e,e}getSubtreeObjects(){if(this._subtreeCache)return this._subtreeCache;let e=[],t=this._object;return e.push(this._object),typeof t.traverse=="function"&&t.traverse(i=>{i&&i!==this._object&&e.push(i)}),this._subtreeCache=e,e}invalidateFlatCache(){this._flatObjectsCache=null}invalidateSubtreeCache(){this._subtreeCache=null}disposeObjectResources(e){let t=e;t?.geometry?.dispose&&t.geometry.dispose();let i=t?.material;Array.isArray(i)?i.forEach(r=>r?.dispose?.()):i?.dispose&&i.dispose(),typeof t?.traverse=="function"&&t.traverse(r=>{r?.geometry?.dispose&&r.geometry.dispose();let a=r?.material;Array.isArray(a)?a.forEach(s=>s?.dispose?.()):a?.dispose&&a.dispose()})}};var be=class{constructor(e){this.styleMap=e.computedStyleMap?.(),this.style=getComputedStyle(e)}readNumber(e,t){let i=this.styleMap?.get?.(e);if(i!=null){let a=typeof i=="object"?i.value:i,s=typeof a=="number"?a:Number.parseFloat(a);if(!Number.isNaN(s))return s}let r=Number.parseFloat(this.style.getPropertyValue(e));return Number.isNaN(r)?t:r}readString(e,t=""){let i=this.styleMap?.get?.(e),r=i&&typeof i=="object"?i.value:i;if(typeof r=="string")return this.stripQuotes(r.trim())||t;let a=this.style.getPropertyValue(e).trim();return this.stripQuotes(a)||t}stripQuotes(e){return e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e}readBoolean(e,t=!1){let i=this.readString(e,"");if(!i)return t;let r=i.toLowerCase();return r==="true"||r==="1"||r==="yes"?!0:r==="false"||r==="0"||r==="no"?!1:t}};function ue(g,e,t){let r=g.computedStyleMap?.()?.get?.(e);if(r!==void 0){if(typeof r=="number")return r;if(typeof r=="string"){let n=Number.parseFloat(r);if(!Number.isNaN(n))return n}if(r&&typeof r=="object"){let n=r.value;if(typeof n=="number")return n;if(typeof n=="string"){let l=Number.parseFloat(n);if(!Number.isNaN(l))return l}}}let s=getComputedStyle(g).getPropertyValue(e),o=Number.parseFloat(s);return Number.isNaN(o)?t:o}function Ze(g){return g.startsWith("'")&&g.endsWith("'")||g.startsWith('"')&&g.endsWith('"')?g.slice(1,-1):g}function De(g,e,t=""){let r=g.computedStyleMap?.()?.get?.(e);if(typeof r=="string")return Ze(r.trim());if(r&&typeof r=="object"){let o=r.value;if(typeof o=="string")return Ze(o.trim())}let a=getComputedStyle(g).getPropertyValue(e);return(a?Ze(a.trim()):"")||t}function je(g,e,t=!1){let i=De(g,e,"");if(!i)return t;let r=i.toLowerCase().trim();return r==="true"||r==="1"||r==="yes"?!0:r==="false"||r==="0"||r==="no"?!1:t}function rt(g){let e=g.computedStyleMap?.(),t="",i=e?.get?.("--filter");if(i!==void 0){if(typeof i=="string")t=i;else if(i&&typeof i=="object"){let r=i.value;typeof r=="string"&&(t=r)}}return t||(t=getComputedStyle(g).getPropertyValue("--filter")||""),t=t.trim(),t}var pe=class{static register(e){let t=e.name.trim().toLowerCase();if(!t)throw new Error("[String3D] Custom material name is required.");this.materials.set(t,{...e,name:t}),this.registerCssVarsForMaterial(e)}static registerCssVarsForMaterial(e){let t=globalThis.CSS;if(!t?.registerProperty)return;let i=e.uniforms||{};for(let r of Object.values(i)){let a=r.css?.trim();if(!a||!a.startsWith("--")||this.registeredCssVars.has(a))continue;let s=this.resolveCssSyntax(r.type);try{t.registerProperty({name:a,syntax:s,inherits:!1,initialValue:this.defaultCssInitialValue(r)}),this.registeredCssVars.add(a)}catch{}}}static resolveCssSyntax(e){switch(e){case"color":return"<color>";case"float":case"int":return"<number>";default:return"*"}}static defaultCssInitialValue(e){return e.type==="color"?typeof e.value=="string"?e.value:"#000000":e.type==="float"||e.type==="int"?typeof e.value=="number"?String(e.value):"0":"initial"}static get(e){return this.materials.get(e.trim().toLowerCase())}static has(e){return this.materials.has(e.trim().toLowerCase())}static list(){return Array.from(this.materials.values())}static unregister(e){return this.materials.delete(e.trim().toLowerCase())}};pe.materials=new Map,pe.registeredCssVars=new Set;function nt(g,e){if(e==null||e===""||e==="none")return g.value;let t=e.trim();switch(g.type){case"float":case"int":{let i=parseFloat(t);return isNaN(i)?g.value:i}case"vec2":{let i=t.split(/[\s,]+/).map(r=>parseFloat(r.trim()));return i.length>=2&&i.every(r=>!isNaN(r))?[i[0],i[1]]:g.value}case"vec3":{let i=t.split(/[\s,]+/).map(r=>parseFloat(r.trim()));return i.length>=3&&i.every(r=>!isNaN(r))?[i[0],i[1],i[2]]:g.value}case"vec4":{let i=t.split(/[\s,]+/).map(r=>parseFloat(r.trim()));return i.length>=4&&i.every(r=>!isNaN(r))?[i[0],i[1],i[2],i[3]]:g.value}case"color":return at(t)??g.value;case"texture":{let i=t.match(/url\(['"]?(.*?)['"]?\)/);return i?i[1]:t||g.value}default:return g.value}}function at(g){if(g.startsWith("#")){let t=g.slice(1);if(t.length===3){let i=parseInt(t[0]+t[0],16)/255,r=parseInt(t[1]+t[1],16)/255,a=parseInt(t[2]+t[2],16)/255;return[i,r,a]}if(t.length===6){let i=parseInt(t.slice(0,2),16)/255,r=parseInt(t.slice(2,4),16)/255,a=parseInt(t.slice(4,6),16)/255;return[i,r,a]}}let e=g.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);return e?[parseInt(e[1])/255,parseInt(e[2])/255,parseInt(e[3])/255]:null}function Ye(g,e,t){let i={};if(g.parse){let r=g.parse(e,t);Object.assign(i,r)}if(g.uniforms)for(let[r,a]of Object.entries(g.uniforms))if(a.css){let s=t.getPropertyValue(a.css).trim();i[r]=nt(a,s)}else r in i||(i[r]=a.value);return i}function Xe(g){let e=new Map;for(let i of g){let r=e.get(i.point)||[];r.push(i),e.set(i.point,r)}let t=new Map;for(let[i,r]of e){let a=r.sort((s,o)=>(s.order??0)-(o.order??0));t.set(i,a.map(s=>s.code).join(`
`))}return t}var Le=class{constructor(e,t={}){this._objects=new Map;this._rootObjects=[];this._elementMap=new Map;this._materialInstances=new Map;this._modelLoaderCache=new Map;this.engine=e,this._modelLoader=t.modelLoader,this._modelLoaderFactory=t.modelLoaderFactory,this._scene=e.createScene()}get rootObjects(){return this._rootObjects}getScene(){return this._scene}getObject(e){return this._objects.get(e)}getAllObjects(){let e=[],t=i=>{e.push(i),i.children.forEach(r=>t(r))};return this._rootObjects.forEach(i=>t(i)),e}hasObject(e){return this._objects.has(e)}deleteObject(e){let t=this._objects.get(e);return t?(this._scene.remove(t.object),this._objects.delete(e),this._elementMap.delete(e),this._rootObjects=this._rootObjects.filter(i=>i!==t),t.destroy(),!0):!1}createFromElement(e){let t=e.getProperty("3d");if(!t)return;let i=e.htmlElement;if(!i)return;let r=a=>{if(a){let s=e.getProperty("parentId");s==null?(this._scene.add(a.object),this._rootObjects.push(a)):this._objects.get(s)?.addChild(a),this._objects.set(e.id,a),this._elementMap.set(e.id,i),a.el=i}};switch(t){case"group":this.createGroup(e,r);break;case"pointLight":this.createLight(e,"point",r);break;case"ambientLight":this.createLight(e,"ambient",r);break;case"directionalLight":this.createLight(e,"directional",r);break;case"spotLight":this.createLight(e,"spot",r);break;case"hemisphereLight":this.createLight(e,"hemisphere",r);break;case"model":this.createModel(e,r);break;case"box":this.createBox(e,r);break;case"sphere":this.createSphere(e,r);break;case"plane":this.createPlane(e,r);break;case"cylinder":this.createCylinder(e,r);break;case"particles":this.createParticles(e,r);break;case"text":this.createText(e,r);break}}createGroup(e,t){let i=this.engine.createGroup(),r=new ne(e.id,"group",i,this.engine);return t(r),r}createLight(e,t,i){let r=e.htmlElement,a=r?De(r,"--light-color","#ffffff"):"#ffffff",s=a&&a!=="none"?a:"#ffffff",o=r?ue(r,"--light-intensity",1):1,n;if(t==="point"){let h=r?ue(r,"--light-distance",1e3):1e3,u=r?ue(r,"--light-decay",0):0;n=this.engine.createPointLight(s,o,h,u)}else if(t==="directional")n=this.engine.createDirectionalLight(s,o);else if(t==="spot"){let h=r?ue(r,"--light-distance",0):0,u=r?ue(r,"--light-angle",Math.PI/3):Math.PI/3,d=r?ue(r,"--light-penumbra",0):0,p=r?ue(r,"--light-decay",1):1;n=this.engine.createSpotLight(s,o,h,u,d,p)}else if(t==="hemisphere"){let h=r?De(r,"--light-ground-color","#ffffff"):"#ffffff",u=h&&h!=="none"?h:"#ffffff";n=this.engine.createHemisphereLight(s,u,o)}else n=this.engine.createAmbientLight(s,o);if((r?je(r,"--shadow-cast",!1):!1)&&n.shadow){n.castShadow=!0;let h=r?ue(r,"--shadow-bias",0):0,u=r?ue(r,"--shadow-map-size",512):512;n.shadow.bias=h,n.shadow.mapSize.width=u,n.shadow.mapSize.height=u}let c=new ne(e.id,t+"Light",n,this.engine);return i(c),c}applyShadowProps(e,t){let i=e.htmlElement,r=i?je(i,"--shadow-cast",!1):!1,a=i?je(i,"--shadow-receive",!1):!1;t.castShadow=r,t.receiveShadow=a}createBox(e,t){let i=this.engine.createBoxGeometry(1,1,1),r=this.createMaterialFromObject(e),a=this.engine.createMesh(i,r);this.applyShadowProps(e,a);let s=new ne(e.id,"box",a,this.engine,{geometry:i,material:r});return t(s),s}createSphere(e,t){let i=this.getGeometryQuality(e.htmlElement),r=Math.max(3,Math.round(32*i)),a=Math.max(2,Math.round(32*i)),s=this.engine.createSphereGeometry(.5,r,a),o=this.createMaterialFromObject(e),n=this.engine.createMesh(s,o);this.applyShadowProps(e,n);let l=new ne(e.id,"sphere",n,this.engine,{geometry:s,material:o});return t(l),l}createPlane(e,t){let i=this.engine.createPlaneGeometry(1,1),r=this.createMaterialFromObject(e),a=this.engine.createMesh(i,r);this.applyShadowProps(e,a);let s=new ne(e.id,"plane",a,this.engine,{geometry:i,material:r});return t(s),s}createCylinder(e,t){let i=this.getGeometryQuality(e.htmlElement),r=Math.max(3,Math.round(32*i)),a=this.engine.createCylinderGeometry(.5,.5,1,r),s=this.createMaterialFromObject(e),o=this.engine.createMesh(a,s);this.applyShadowProps(e,o);let n=new ne(e.id,"cylinder",o,this.engine,{geometry:a,material:s});return t(n),n}createModel(e,t){let i=e.getProperty("3d-model");if(!i)return;let r=e.getProperty("3d-model-loader")||void 0,a=this.resolveModelLoader(r);if(!a)return;let s=e.htmlElement;s&&this.applyModelTextureRemap(a,s);let o=e.getProperty("3d-model-center")??!1;a.load(i,n=>{let l=n?.scene||n?.object||n;if(!l)return;let c=s&&this.shouldOverrideModelMaterial(s)?this.createMaterialFromElement(s,e):null;typeof l.traverse=="function"&&l.traverse(u=>{u.isMesh&&(c&&(u.material=c),this.applyShadowProps(e,u))}),o&&this.centerObject(l);let h=new ne(e.id,"model",l,this.engine);t(h)},void 0,void 0)}createParticles(e,t){if(!this.engine.createParticleSystem)return;let i=e.htmlElement,r={mode:"emitter",count:300,size:2,color:"#ffffff",opacity:1,spread:120,spreadX:0,spreadY:0,seed:1,emitRate:30,emitBurst:0,particleLife:2.5,particleSpeed:40,particleDirection:[0,1,0],particleGravity:[0,-30,0],particleDrag:.1,particleSizeVariation:.6,particleColorVariation:.2,particleShape:"sphere",particleModelUrl:"",particleModelLoader:"",particleModelNode:"",instanceShape:"sphere",instanceModelUrl:"",instanceModelLoader:"",instanceModelNode:"",instanceScale:1,instanceScaleVariation:.5,instanceRotationSpeed:.4,instanceJitter:.2,instanceFlow:.3,instanceDisperse:0,instanceDisperseScatter:0,instanceDisperseScatterX:0,instanceDisperseScatterY:0,instanceDisperseScatterZ:0,modelTransitionDuration:0},a=this.engine.createParticleSystem(r),s=new ne(e.id,"particles",a,this.engine);t(s)}createText(e,t){if(!this.engine.createTextGeometry)return;let i=this.engine.createBoxGeometry(1,1,1),r=this.createMaterialFromObject(e),a=this.engine.createMesh(i,r);this.applyShadowProps(e,a);let s=this.engine.createGroup();s.__textMesh=a,s.add(a);let o=new ne(e.id,"text",s,this.engine,{geometry:i,material:r});t(o)}getGeometryQuality(e){if(!e)return 1;let t=ue(e,"--geometry-quality",1);return!Number.isFinite(t)||t<=0?1:t}resolveModelLoader(e){if(e){if(this._modelLoaderCache.has(e))return this._modelLoaderCache.get(e);if(!this._modelLoaderFactory)return;let t=this._modelLoaderFactory(this.engine,e);return this._modelLoaderCache.set(e,t),t}if(this._modelLoader)return this._modelLoader;if(this._modelLoaderFactory)return this._modelLoaderFactory(this.engine)}centerObject(e){if(!e)return;let t=this.engine.computeBoundingBoxRecursively(e),i=this.getBoxCenter(t);e.position?.set&&e.position.set(-i.x,-i.y,-i.z),e.updateMatrixWorld(!0)}getBoxCenter(e){let t=this.engine.createVector3();return t.x=(e.min.x+e.max.x)/2,t.y=(e.min.y+e.max.y)/2,t.z=(e.min.z+e.max.z)/2,t}createMaterialFromObject(e){return this.createMaterialFromElement(e.htmlElement,e)}createMaterialFromElement(e,t){let i=e?getComputedStyle(e):null,r=b=>i?i.getPropertyValue(b).trim():"",a=(b,w,V)=>{let N=r(b);return N&&N!=="none"&&N!==""?w(N):V},s=b=>parseFloat(b),o=b=>b,n=b=>{let w=b.match(/url\(['"]?(.*?)['"]?\)/);return w?w[1]:b},l=a("--material-type",b=>b.split("[")[0]||"basic","basic"),c=this.tryCreateCustomMaterial(l,e,i,t);if(c)return c;let h=a("--material-color",o,"#ffffff"),u=a("--opacity",s,1),d=a("--material-metalness",s,0),p=a("--material-roughness",s,1),m=a("--material-emissive",o,"#000000"),f={color:h,transparent:u<1,opacity:u},C=a("--texture-map",n,""),v=a("--texture-normal",n,""),y=a("--texture-roughness",n,""),M=a("--texture-metalness",n,""),P=a("--texture-ao",n,""),j=this.parseFlipY(e),T=e?De(e,"--texture-color-space",""):"",z=!!(C||v||y||M||P),D=l;return D!=="standard"&&z&&(D="standard"),D==="standard"?(C&&(f.map=this.loadTexture(C,{flipY:j,colorSpace:T})),v&&(f.normalMap=this.loadTexture(v,{flipY:j})),y&&(f.roughnessMap=this.loadTexture(y,{flipY:j})),M&&(f.metalnessMap=this.loadTexture(M,{flipY:j})),P&&(f.aoMap=this.loadTexture(P,{flipY:j})),f.metalness=d,f.roughness=p,f.emissive=m,this.engine.createMeshStandardMaterial(f)):this.engine.createMeshBasicMaterial(f)}tryCreateCustomMaterial(e,t,i,r){let a=pe.get(e);if(!a)return null;let s=this.engine.getMaterialFactory?.();if(!s||!s.supports(a))return null;let o={};t&&i&&(o=s.parseUniformsFromCSS(a,t,i));let n=s.create(a,o);return r&&this._materialInstances.set(r.id,n),n.material}updateMaterialUniforms(e,t){let i=this._materialInstances.get(e);i&&i.update(t)}getMaterialInstance(e){return this._materialInstances.get(e)}loadTexture(e,t={}){let r=this.engine.createTextureLoader().load(e);typeof t.flipY=="boolean"&&(r.flipY=t.flipY);let a=(t.colorSpace||"").toLowerCase().trim();return a&&"colorSpace"in r&&(r.colorSpace=a==="srgb"?"srgb":"linear"),r.needsUpdate=!0,r}parseFlipY(e){let t=e?De(e,"--texture-flip-y",""):"";if(t==null||t==="")return;if(typeof t=="boolean")return t;let i=String(t).toLowerCase().trim();if(i==="false"||i==="0"||i==="no")return!1;if(i==="true"||i==="1"||i==="yes")return!0}shouldOverrideModelMaterial(e){let t=getComputedStyle(e),i=a=>{let s=t.getPropertyValue(a);return s&&s!=="0"&&s!=="none"&&s!==""};return i("--material-color")||i("--texture-map")?!0:["--material-type","--material-metalness","--material-roughness","--material-emissive","--opacity","--texture-normal","--texture-roughness","--texture-metalness","--texture-ao"].some(a=>i(a))}applyModelTextureRemap(e,t){let i=(t.getAttribute("string-3d-model-texture-base")||"").trim(),r=i?i.replace(/\/?$/,"/"):"",a=t.getAttribute("string-3d-model-textures"),s=null;if(a)try{s=JSON.parse(a)}catch{}let o=e?.manager;!o||typeof o.setURLModifier!="function"||o.setURLModifier(n=>{let l=s&&n in s?s[n]:n;return!r||/^(blob:|data:|https?:|file:|\/)/i.test(l)?l:r+l.replace(/^\.?\//,"")})}destroy(){this._materialInstances.forEach(e=>e.dispose()),this._materialInstances.clear(),this._objects.forEach(e=>e.destroy()),this._objects.clear(),this._rootObjects=[]}};var J=class{constructor(){this.cache=new WeakMap;this.meta=new WeakMap}get(e,t,i){if(!!t.dirtySet&&t.forceSync===!1&&!t.dirtySet.has(e)){let n=this.cache.get(e);if(n)return n}let a=performance.now(),s=Math.max(0,t.styleReadIntervalMs??0);if(s>0){let n=this.meta.get(e),l=this.cache.get(e);if(n&&l&&a-n.time<s)return l}let o=i(e);return this.cache.set(e,o),this.meta.set(e,{time:a}),o}clear(){this.cache=new WeakMap,this.meta=new WeakMap}};var qe=Math.PI/180,Ve=class Ve{sync(e,t,i,r){let a=e.__layoutCache,s=a?a.rect:e.getBoundingClientRect(),o=this.readStyleBundle(e,i),n=s.left+s.width*.5,l=s.top+s.height*.5;if(i.camera.getMode()==="orthographic")t.object.position.set(n-i.viewportWidth/2,-(l-i.viewportHeight/2),o.translateZ);else{let c=i.camera.getFrustumSizeAt(o.translateZ),h=n/i.viewportWidth,u=l/i.viewportHeight;t.object.position.set((h-.5)*c.width,-(u-.5)*c.height,o.translateZ)}return t.object.scale.set(o.scale,o.scale,o.scale),t.object.rotation.x=-o.rotateX*qe,t.object.rotation.y=o.rotateY*qe,t.object.rotation.z=-o.rotateZ*qe,t.object.rotation.order="XYZ",t.object.updateMatrixWorld(!0),{scale:o.scale}}readStyleBundle(e,t){return Ve.styleCache.get(e,t,i=>{let r=new be(i);return{translateZ:r.readNumber("--translate-z",0),scale:r.readNumber("--scale",1),rotateX:r.readNumber("--rotate-x",0),rotateY:r.readNumber("--rotate-y",0),rotateZ:r.readNumber("--rotate-z",0)}})}};Ve.styleCache=new J;var ze=Ve;var Ne=class Ne{sync(e,t,i,r){let a=e.__layoutCache,s=a?a.rect:e.getBoundingClientRect(),o=this.readStyleBundle(e,i,t),n=s.left+s.width*.5,l=s.top+s.height*.5;if(i.camera.getMode()==="orthographic")t.object.position.set(n-i.viewportWidth/2+o.translateX,-(l-i.viewportHeight/2)+o.translateY,o.translateZ);else{let h=i.camera.getFrustumSizeAt(o.translateZ),u=n/i.viewportWidth,d=l/i.viewportHeight;t.object.position.set((u-.5)*h.width+o.translateX,-(d-.5)*h.height+o.translateY,o.translateZ)}let c=t.object;if(o.color&&o.color!=="none"&&c.color&&typeof c.color.set=="function"&&c.color.set(o.color),c.intensity=o.intensity,typeof c.distance<"u"&&o.distance!==void 0&&(c.distance=o.distance),typeof c.decay<"u"&&o.decay!==void 0&&(c.decay=o.decay),typeof c.angle<"u"&&o.angle!==void 0&&(c.angle=o.angle),typeof c.penumbra<"u"&&o.penumbra!==void 0&&(c.penumbra=o.penumbra),o.groundColor&&o.groundColor!=="none"&&c.groundColor&&typeof c.groundColor.set=="function"&&c.groundColor.set(o.groundColor),c.castShadow!==o.castShadow&&(c.castShadow=o.castShadow),o.castShadow&&c.shadow&&(o.shadowBias!==void 0&&(c.shadow.bias=o.shadowBias),o.shadowMapSize!==void 0&&c.shadow.mapSize.width!==o.shadowMapSize&&(c.shadow.mapSize.width=o.shadowMapSize,c.shadow.mapSize.height=o.shadowMapSize)),o.targetId&&o.targetId!=="none"&&c.target){let h=document.querySelector(`[string-id="${o.targetId}"]`);if(h){let u=h.__layoutCache,d=u?u.rect:h.getBoundingClientRect(),m=new be(h).readNumber("--translate-z",0),f=d.left+d.width*.5,C=d.top+d.height*.5,v,y,M;if(i.camera.getMode()==="orthographic")v=f-i.viewportWidth/2,y=-(C-i.viewportHeight/2),M=m;else{let P=i.camera.getFrustumSizeAt(m),j=f/i.viewportWidth,T=C/i.viewportHeight;v=(j-.5)*P.width,y=-(T-.5)*P.height,M=m}o.targetOffset&&(v+=o.targetOffset.x,y+=o.targetOffset.y,M+=o.targetOffset.z),c.target.position.set(v,y,M),c.target.updateMatrixWorld(!0)}}return null}readStyleBundle(e,t,i){return Ne.styleCache.get(e,t,r=>{let a=new be(r),s=i.object,o={translateZ:a.readNumber("--translate-z",0),translateX:a.readNumber("--translate-x",0),translateY:a.readNumber("--translate-y",0),color:a.readString("--light-color","")||void 0,intensity:a.readNumber("--light-intensity",s.intensity??1),castShadow:a.readBoolean("--shadow-cast",!1)};typeof s.distance<"u"&&(o.distance=a.readNumber("--light-distance",s.distance??0)),typeof s.decay<"u"&&(o.decay=a.readNumber("--light-decay",s.decay??1)),typeof s.angle<"u"&&(o.angle=a.readNumber("--light-angle",s.angle??Math.PI/3)),typeof s.penumbra<"u"&&(o.penumbra=a.readNumber("--light-penumbra",s.penumbra??0));let n=a.readString("--light-ground-color","");n&&(o.groundColor=n),o.castShadow&&s.shadow&&(o.shadowBias=a.readNumber("--shadow-bias",s.shadow.bias??0),o.shadowMapSize=a.readNumber("--shadow-map-size",s.shadow.mapSize.width??512));let l=a.readString("--light-target","").trim();l&&(o.targetId=l);let c=a.readString("--light-target-offset","").trim();if(c){let h=this.parseTargetOffset(c);h&&(o.targetOffset=h)}return o})}parseTargetOffset(e){let t=e.split(/[\s,]+/).map(i=>i.trim()).filter(Boolean).map(i=>Number.parseFloat(i));return t.length<3||t.some(i=>Number.isNaN(i))?null:{x:t[0],y:t[1],z:t[2]}}};Ne.styleCache=new J;var Me=Ne;var Ke=Math.PI/180,G=class G{static applyVisualProps(e,t,i){let r=G.lastVisualProps.get(t);if(r){if(r.opacity===i.opacity&&r.color===i.color&&r.metalness===i.metalness&&r.roughness===i.roughness&&r.emissive===i.emissive&&r.castShadow===i.castShadow&&r.receiveShadow===i.receiveShadow)return;r.opacity=i.opacity,r.color=i.color,r.metalness=i.metalness,r.roughness=i.roughness,r.emissive=i.emissive,r.castShadow=i.castShadow,r.receiveShadow=i.receiveShadow}else G.lastVisualProps.set(t,{opacity:i.opacity,color:i.color,metalness:i.metalness,roughness:i.roughness,emissive:i.emissive,castShadow:i.castShadow,receiveShadow:i.receiveShadow});let a=i.castShadow??!1,s=i.receiveShadow??!1,o=typeof i.opacity=="number"?i.opacity:NaN,n=l=>{l&&(isNaN(o)||(l.opacity=o,l.transparent=o<1),i.color&&l.color&&l.color.set&&l.color.set(i.color),typeof i.metalness=="number"&&"metalness"in l&&(l.metalness=i.metalness),typeof i.roughness=="number"&&"roughness"in l&&(l.roughness=i.roughness),i.emissive&&l.emissive&&l.emissive.set&&l.emissive.set(i.emissive))};if(t.object.traverse)t.object.traverse(l=>{l.isMesh&&(l.castShadow!==a&&(l.castShadow=a),l.receiveShadow!==s&&(l.receiveShadow=s),(Array.isArray(l.material)?l.material:[l.material]).forEach(n))});else if(t.object.isMesh){let l=t.object;l.castShadow!==a&&(l.castShadow=a),l.receiveShadow!==s&&(l.receiveShadow=s),(Array.isArray(l.material)?l.material:[l.material]).forEach(n)}}sync(e,t,i,r){let{rect:a,width:s,height:o}=this.readLayout(e,i),n=this.readStyleBundle(e,i),{translateZ:l,cssScale:c,rotateX:h,rotateY:u,rotateZ:d,cssScaleZ:p,opacity:m,color:f,metalness:C,roughness:v,emissive:y,castShadow:M,receiveShadow:P,geometryQuality:j}=n,T=a.left+a.width*.5,z=a.top+a.height*.5;if(i.camera.getMode()==="orthographic")t.object.position.set(T-i.viewportWidth/2,-(z-i.viewportHeight/2),l);else{let k=i.camera.getFrustumSizeAt(l),B=T/i.viewportWidth,x=z/i.viewportHeight;t.object.position.set((B-.5)*k.width,-(x-.5)*k.height,l)}t.object.rotation.x=-h*Ke,t.object.rotation.y=u*Ke,t.object.rotation.z=-d*Ke,t.object.rotation.order="XYZ";let D=s*c,b=o*c,w=r?.scale||1,V=p*w,N=D<b?D:b,_,H,U;switch(t.type){case"box":case"sphere":{let k=N*w;_=H=k,U=k*p;break}case"model":{let k=t.getOriginalBoundingBox();G.tempVector3||(G.tempVector3=i.engine.createVector3());let B=k.getSize(G.tempVector3),x=e.getAttribute("string-3d-model-fit"),S=parseFloat(e.getAttribute("string-3d-model-scale")||"1"),L=Number.isFinite(S)?S*w:w;if(B.x>0&&B.y>0){let E=D/B.x,R=b/B.y,I=(x==="cover"?E>R?E:R:E<R?E:R)*L;_=H=I,U=I*p}else{let E=N*L;_=H=E,U=E*p}break}case"cylinder":_=D*w,H=b*w,U=D*V;break;default:_=D*w,H=b*w,U=N*.5*V;break}return t.object.scale.set(_,H,U),G.applyVisualProps(e,t,{opacity:m,color:f&&f!=="none"?f:void 0,metalness:isNaN(C)?void 0:C,roughness:isNaN(v)?void 0:v,emissive:y&&y!=="none"?y:void 0,castShadow:M,receiveShadow:P}),this.applyGeometryQuality(t,j,i),this.updateCustomUniforms(e,t,i),{scale:c*w}}applyGeometryQuality(e,t,i){let r=i.engine,a=r?.simplifyGeometry?.bind(r);if(typeof a!="function")return;let s=Number.isFinite(t)&&t>0?t:1,o=G.lastGeometryQuality.get(e);if(typeof o=="number"&&Math.abs(o-s)<.001)return;G.lastGeometryQuality.set(e,s);let n=l=>{if(!l?.geometry)return;let c=l.userData||(l.userData={});c.__originalGeometry||(c.__originalGeometry=l.geometry);let h=c.__originalGeometry;if(s>=.999){l.geometry=h;return}c.__lodCache||(c.__lodCache=new Map);let u=s.toFixed(3);if(c.__lodCache.has(u)){l.geometry=c.__lodCache.get(u);return}let d=a(h,s);d&&(c.__lodCache.set(u,d),l.geometry=d)};e.object.traverse?e.object.traverse(l=>{l?.isMesh&&n(l)}):e.object.isMesh&&n(e.object)}updateCustomUniforms(e,t,i){let r=i.engine.getMaterialFactory?.();if(!r)return;let a=getComputedStyle(e),s=o=>{let n=o?.userData?.definition;if(!n?.uniforms)return;let l=r.parseUniformsFromCSS(n,e,a);for(let[c,h]of Object.entries(l)){let u=n.uniforms?.[c];if(!u)continue;let d=r.convertUniformValue?.bind(r),p=d?d(u.type,h):h;o.userData?.shader?.uniforms?.[c]?o.userData.shader.uniforms[c].value=p:o.userData?.customUniforms?.[c]?o.userData.customUniforms[c].value=p:o.uniforms?.[c]&&(o.uniforms[c].value=p)}};if(t.object.traverse)t.object.traverse(o=>{o.isMesh&&(Array.isArray(o.material)?o.material:[o.material]).forEach(s)});else if(t.object.isMesh){let o=t.object;(Array.isArray(o.material)?o.material:[o.material]).forEach(s)}}readStyleBundle(e,t){return G.styleCache.get(e,t,i=>{let r=i.computedStyleMap?.(),a=getComputedStyle(i),s=(l,c)=>{let h=r?.get?.(l);if(h!=null){let d=typeof h=="object"&&"value"in h?h.value:h,p=typeof d=="number"?d:Number.parseFloat(String(d));if(!Number.isNaN(p))return p}let u=Number.parseFloat(a.getPropertyValue(l));return Number.isNaN(u)?c:u},o=l=>{let c=r?.get?.(l),h=c&&typeof c=="object"&&"value"in c?c.value:c;return typeof h=="string"?h.trim()||void 0:a.getPropertyValue(l).trim()||void 0},n=(l,c=!1)=>{let h=o(l);if(!h)return c;let u=h.toLowerCase();return u==="true"||u==="1"||u==="yes"?!0:u==="false"||u==="0"||u==="no"?!1:c};return{translateZ:s("--translate-z",0),cssScale:s("--scale",1),rotateX:s("--rotate-x",0),rotateY:s("--rotate-y",0),rotateZ:s("--rotate-z",0),cssScaleZ:s("--scale-z",1),opacity:s("--opacity",NaN),color:o("--material-color"),metalness:s("--material-metalness",NaN),roughness:s("--material-roughness",NaN),emissive:o("--material-emissive"),castShadow:n("--shadow-cast",!1),receiveShadow:n("--shadow-receive",!1),geometryQuality:s("--geometry-quality",1)}})}readLayout(e,t){let i=e.__layoutCache;return i||G.layoutCache.get(e,t,r=>{let a=r.getBoundingClientRect(),s=r.offsetWidth||a.width,o=r.offsetHeight||a.height;return{rect:a,width:s,height:o}})}};G.styleCache=new J,G.layoutCache=new J,G.tempVector3=null,G.lastVisualProps=new WeakMap,G.lastGeometryQuality=new WeakMap;var me=G;var Qe=Math.PI/180,F={mode:"emitter",count:300,size:2,color:"#ffffff",opacity:1,spread:120,spreadX:120,spreadY:120,seed:1,emitRate:30,emitBurst:0,particleLife:2.5,particleSpeed:40,particleDirection:[0,1,0],particleGravity:[0,-30,0],particleDrag:.1,particleSizeVariation:.6,particleColorVariation:.2,particleShape:"sphere",particleModelUrl:"",particleModelLoader:"",particleModelNode:"",instanceShape:"sphere",instanceModelUrl:"",instanceModelLoader:"",instanceModelNode:"",instanceScale:1,instanceScaleVariation:.5,instanceRotationSpeed:.4,instanceJitter:.2,instanceFlow:.3,instanceDisperse:0,instanceDisperseScatter:0,instanceDisperseScatterX:0,instanceDisperseScatterY:0,instanceDisperseScatterZ:0,modelTransitionDuration:0},A=class A{sync(e,t,i,r){let a=e.__layoutCache,s=a?a.rect:e.getBoundingClientRect(),o=this.readStyleBundle(e,i),n=s.left+s.width*.5,l=s.top+s.height*.5;if(i.camera.getMode()==="orthographic")t.object.position.set(n-i.viewportWidth/2,-(l-i.viewportHeight/2),o.translateZ);else{let C=i.camera.getFrustumSizeAt(o.translateZ),v=n/i.viewportWidth,y=l/i.viewportHeight;t.object.position.set((v-.5)*C.width,-(y-.5)*C.height,o.translateZ)}let c=r?.scale??1,h=o.scale*c;t.object.scale.set(h,h,h),t.object.rotation.x=-o.rotateX*Qe,t.object.rotation.y=o.rotateY*Qe,t.object.rotation.z=-o.rotateZ*Qe,t.object.rotation.order="XYZ";let u=this.buildConfig(o,s,i,r),d=A.lastConfig.get(t);(!d||!this.isSameConfig(d,u))&&(A.lastConfig.set(t,u),t.object.setConfig?.(u)),this.updateMaterialOverrides(e,t,i,o),this.updateCustomUniforms(e,t,i);let p=performance.now(),m=A.lastTime.get(t)??p,f=Math.max(0,(p-m)/1e3);return A.lastTime.set(t,p),t.object.update?.(f),{scale:r?.scale??1}}readStyleBundle(e,t){return A.styleCache.get(e,t,i=>{let r=new be(i),s=r.readString("--particles-mode",F.mode).toLowerCase()==="instanced"?"instanced":"emitter";return{...F,translateZ:r.readNumber("--translate-z",0),scale:r.readNumber("--scale",1),rotateX:r.readNumber("--rotate-x",0),rotateY:r.readNumber("--rotate-y",0),rotateZ:r.readNumber("--rotate-z",0),particlesFit:r.readNumber("--particles-fit",0)>.5,materialType:r.readString("--material-type","basic"),mode:s,count:r.readNumber("--particles-count",F.count),size:r.readNumber("--particles-size",F.size),color:r.readString("--particles-color",F.color),opacity:r.readNumber("--particles-opacity",F.opacity),spread:r.readNumber("--particles-spread",F.spread),seed:r.readNumber("--particles-seed",F.seed),emitRate:r.readNumber("--emit-rate",F.emitRate),emitBurst:r.readNumber("--emit-burst",F.emitBurst),particleLife:r.readNumber("--particle-life",F.particleLife),particleSpeed:r.readNumber("--particle-speed",F.particleSpeed),particleDirection:this.parseVec3(r.readString("--particle-direction","0 1 0"),F.particleDirection),particleGravity:this.parseVec3(r.readString("--particle-gravity","0 -30 0"),F.particleGravity),particleDrag:r.readNumber("--particle-drag",F.particleDrag),particleSizeVariation:r.readNumber("--particle-size-variation",F.particleSizeVariation),particleColorVariation:r.readNumber("--particle-color-variation",F.particleColorVariation),particleShape:this.parseShape(r.readString("--particles-shape",F.particleShape)),particleModelUrl:r.readString("--particles-model",F.particleModelUrl),particleModelLoader:r.readString("--particles-model-loader",F.particleModelLoader),particleModelNode:r.readString("--particles-model-node",F.particleModelNode),instanceShape:this.parseDistribution(r.readString("--instance-shape",F.instanceShape)),instanceModelUrl:r.readString("--instance-model",F.instanceModelUrl),instanceModelLoader:r.readString("--instance-model-loader",F.instanceModelLoader),instanceModelNode:r.readString("--instance-model-node",F.instanceModelNode),instanceScale:r.readNumber("--instance-scale",F.instanceScale),instanceScaleVariation:r.readNumber("--instance-scale-variation",F.instanceScaleVariation),instanceRotationSpeed:r.readNumber("--instance-rotation-speed",F.instanceRotationSpeed),instanceJitter:r.readNumber("--instance-jitter",F.instanceJitter),instanceFlow:r.readNumber("--instance-flow",F.instanceFlow),instanceDisperse:r.readNumber("--instance-disperse",F.instanceDisperse),instanceDisperseScatter:r.readNumber("--instance-scatter",F.instanceDisperseScatter),instanceDisperseScatterX:r.readNumber("--instance-scatter-x",F.instanceDisperseScatterX),instanceDisperseScatterY:r.readNumber("--instance-scatter-y",F.instanceDisperseScatterY),instanceDisperseScatterZ:r.readNumber("--instance-scatter-z",F.instanceDisperseScatterZ),modelTransitionDuration:this.getTransitionDuration(i,"--instance-model")}})}getTransitionDuration(e,t){let i=getComputedStyle(e),r=this.splitTransitionList(i.transitionProperty),a=this.splitTransitionList(i.transitionDuration),s=this.findTransitionIndex(r,t);if(s===-1){let o=this.parseTransitionShorthand(i.transition),n=o.get(t)||o.get("all");return n?n.duration:0}return this.parseTime(a[s]||a[a.length-1]||"0s")}splitTransitionList(e){let t=[],i="",r=0;for(let a=0;a<e.length;a+=1){let s=e[a];s==="("&&(r+=1),s===")"&&(r=Math.max(0,r-1)),s===","&&r===0?(t.push(i.trim()),i=""):i+=s}return i.trim()&&t.push(i.trim()),t.length>0?t:["all"]}findTransitionIndex(e,t){let i=e.map(a=>a.trim().toLowerCase()),r=i.indexOf(t);return r===-1&&(r=i.indexOf("all")),r}parseTime(e){let t=e.trim().toLowerCase();if(t.endsWith("ms")){let r=Number.parseFloat(t.slice(0,-2));return Number.isFinite(r)?r/1e3:0}if(t.endsWith("s")){let r=Number.parseFloat(t.slice(0,-1));return Number.isFinite(r)?r:0}let i=Number.parseFloat(t);return Number.isFinite(i)?i:0}parseTransitionShorthand(e){let t=new Map;return this.splitTransitionList(e).forEach(r=>{if(!r)return;let a=r.trim().split(/\s+(?![^()]*\))/g),s="",o="";a.forEach(n=>{let l=n.toLowerCase();l.endsWith("ms")||l.endsWith("s")||/^[0-9.]+$/.test(l)?o||(o=l):l.startsWith("cubic-bezier")||l.startsWith("steps")||l==="linear"||l==="ease"||l==="ease-in"||l==="ease-out"||l==="ease-in-out"||s||(s=n)}),s&&t.set(s.trim().toLowerCase(),{duration:this.parseTime(o||"0s")})}),t}parseVec3(e,t){let i=e.split(/[\s,]+/).map(r=>Number.parseFloat(r)).filter(r=>!Number.isNaN(r));return i.length>=3?[i[0],i[1],i[2]]:t}parseShape(e){let t=e.trim().toLowerCase();return t==="box"?"box":t==="model"?"model":"sphere"}parseDistribution(e){return this.parseShape(e)}buildConfig(e,t,i,r){let s=r?.scale??1,o=.5,n,l,c;return e.particlesFit?(l=this.toWorld(t.width*o,e.translateZ,i),c=this.toWorld(t.height*o,e.translateZ,i),n=Math.max(l,c)):(n=this.toWorld(e.spread,e.translateZ,i),l=n,c=n),{...e,count:Math.max(0,Math.floor(e.count)),size:Math.max(.1,e.size),opacity:Math.max(0,Math.min(1,e.opacity)),spread:Math.max(0,n*s),spreadX:Math.max(0,l*s),spreadY:Math.max(0,c*s),seed:Math.max(0,Math.floor(e.seed)),emitRate:Math.max(0,e.emitRate),emitBurst:Math.max(0,e.emitBurst),particleLife:Math.max(.1,e.particleLife),particleSpeed:Math.max(0,e.particleSpeed),particleDrag:Math.max(0,Math.min(1,e.particleDrag)),particleSizeVariation:Math.max(0,e.particleSizeVariation),particleColorVariation:Math.max(0,e.particleColorVariation),instanceScale:Math.max(.1,e.instanceScale),instanceScaleVariation:Math.max(0,e.instanceScaleVariation),instanceRotationSpeed:Math.max(0,e.instanceRotationSpeed),instanceJitter:Math.max(0,e.instanceJitter),instanceFlow:Math.max(0,e.instanceFlow),instanceDisperse:Math.max(0,e.instanceDisperse),instanceDisperseScatter:Math.max(0,e.instanceDisperseScatter),instanceDisperseScatterX:Math.max(0,e.instanceDisperseScatterX),instanceDisperseScatterY:Math.max(0,e.instanceDisperseScatterY),instanceDisperseScatterZ:Math.max(0,e.instanceDisperseScatterZ)}}toWorld(e,t,i){if(i.camera.getMode()==="orthographic")return e;let a=i.camera.getFrustumSizeAt(t).width/Math.max(1,i.viewportWidth);return e*a}isSameConfig(e,t){return JSON.stringify(e)===JSON.stringify(t)}updateMaterialOverrides(e,t,i,r){let s=(r.materialType||"basic").split("[")[0].trim().toLowerCase(),o=pe.get(s),n=i.engine.getMaterialFactory?.();if(!o||!n||!n.supports(o)){if(!(A.materialInstances.has(t)||A.lastMaterialType.has(t)))return;let h=A.materialInstances.get(t);h&&(h.dispose(),A.materialInstances.delete(t)),A.lastMaterialType.delete(t),t.object.setMaterial?.(null,{points:!0,meshes:!0});return}if(A.lastMaterialType.get(t)!==s){let c=A.materialInstances.get(t);c&&c.dispose();let h=getComputedStyle(e),u=n.parseUniformsFromCSS(o,e,h),d=n.create(o,u);A.materialInstances.set(t,d),A.lastMaterialType.set(t,s);let p=d.material,m=!!p?.isShaderMaterial,f=t.object;f.setMaterial?.(p,{meshes:!0,points:!1}),f.setMaterial?.(m?p:null,{meshes:!1,points:!0})}}updateCustomUniforms(e,t,i){let r=i.engine.getMaterialFactory?.();if(!r)return;let a=getComputedStyle(e),s=o=>{let n=o?.userData?.definition;if(!n?.uniforms)return;let l=r.parseUniformsFromCSS(n,e,a);for(let[c,h]of Object.entries(l)){let u=n.uniforms?.[c];if(!u)continue;let d=r.convertUniformValue?.bind(r),p=d?d(u.type,h):h;o.userData?.shader?.uniforms?.[c]?o.userData.shader.uniforms[c].value=p:o.userData?.customUniforms?.[c]?o.userData.customUniforms[c].value=p:o.uniforms?.[c]&&(o.uniforms[c].value=p)}};t.object.traverse&&t.object.traverse(o=>{(o.isMesh||o.isPoints)&&(Array.isArray(o.material)?o.material:[o.material]).forEach(s)})}};A.styleCache=new J,A.lastConfig=new WeakMap,A.lastTime=new WeakMap,A.lastMaterialType=new WeakMap,A.materialInstances=new WeakMap;var _e=A;var ce=class{static register(e,t){let i=e.trim();i&&this.fonts.set(i,{name:i,url:t})}static setDefault(e){let t=e.trim();t&&(this.defaultFont=t)}static get(e){return this.fonts.get(e.trim())}static list(){return Array.from(this.fonts.values())}static resolveFontFamily(e){if(!e)return this.getDefault();let t=e.split(",").map(i=>i.trim().replace(/^["']|["']$/g,"")).filter(Boolean);for(let i of t){let r=this.fonts.get(i);if(r)return r}return this.getDefault()}static getDefault(){return this.defaultFont&&this.fonts.get(this.defaultFont)||null}};ce.fonts=new Map,ce.defaultFont=null;var Je=null,we=null,et=null,Ce=null;async function st(){return we||(Je||(Je=(async()=>typeof window<"u"&&window.opentype?(we=window.opentype,we):new Promise((g,e)=>{if(typeof document>"u"){e(new Error("[FontConverter] Cannot load opentype.js in non-browser environment"));return}let t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js",t.onload=()=>{we=window.opentype,g(we)},t.onerror=()=>e(new Error("[FontConverter] Failed to load opentype.js")),document.head.appendChild(t)}))()),Je)}async function ot(){return Ce||(et||(et=(async()=>typeof window<"u"&&window.Module?.decompress?(Ce=window.Module,Ce):new Promise((g,e)=>{if(typeof document>"u"){e(new Error("[FontConverter] Cannot load woff2 decoder in non-browser environment"));return}let t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/wawoff2@2.0.1/build/decompress_binding.js",t.onload=()=>{let i=0,r=500,a=()=>{i++;let s=window;s.Module?.decompress?(Ce=s.Module,g(Ce)):i>=r?e(new Error("[FontConverter] woff2 decoder initialization timeout")):setTimeout(a,10)};a()},t.onerror=()=>{e(new Error("[FontConverter] Failed to load woff2 decoder"))},document.head.appendChild(t)}))()),et)}async function lt(g){let e=await ot(),t=new Uint8Array(g),i=e.decompress(t);if(i instanceof Uint8Array){let r=new ArrayBuffer(i.length);return new Uint8Array(r).set(i),r}return i.buffer}function ct(g){return new DataView(g).getUint32(0,!1)===2001684018}var ve=class{static async load(e){let t=typeof e=="string"?e:"buffer-"+Date.now(),i=this.cache.get(t);if(i)return i;let r=this.loadingPromises.get(t);if(r)return r;let a=this.doLoad(e,t);this.loadingPromises.set(t,a);try{let s=await a;return this.cache.set(t,s),s}finally{this.loadingPromises.delete(t)}}static async doLoad(e,t){let i=await st(),r;if(typeof e=="string")r=await(await fetch(e)).arrayBuffer();else if(e instanceof ArrayBuffer)r=e;else if(e instanceof Uint8Array)r=e.buffer;else throw new Error("[FontConverter] Invalid font source");ct(r)&&(r=await lt(r));let a=i.parse(r);if(!a)throw new Error("[FontConverter] Failed to parse font");return this.convertToTypeFace(a)}static convertToTypeFace(e){let t=1e3/e.unitsPerEm,i={};for(let r=0;r<e.glyphs.length;r++){let a=e.glyphs.get(r);if(!a.unicode)continue;let s=String.fromCharCode(a.unicode),o=a.getPath(0,0,e.unitsPerEm),n=this.pathToOutline(o,t),l=a.advanceWidth??a.xMax??e.unitsPerEm*.5;i[s]={ha:Math.round(l*t),x_min:a.xMin!==void 0?Math.round(a.xMin*t):0,x_max:a.xMax!==void 0?Math.round(a.xMax*t):0,o:n}}if(!i[" "]){let r=e.charToGlyph(" ");i[" "]={ha:Math.round((r?.advanceWidth||e.unitsPerEm*.25)*t),x_min:0,x_max:0,o:""}}return{glyphs:i,familyName:e.names.fontFamily?.en||e.names.fullName?.en||"Unknown",ascender:Math.round(e.ascender*t),descender:Math.round(e.descender*t),underlinePosition:Math.round((e.tables.post?.underlinePosition||-100)*t),underlineThickness:Math.round((e.tables.post?.underlineThickness||50)*t),boundingBox:{xMin:Math.round((e.tables.head?.xMin||0)*t),xMax:Math.round((e.tables.head?.xMax||1e3)*t),yMin:Math.round((e.tables.head?.yMin||-200)*t),yMax:Math.round((e.tables.head?.yMax||800)*t)},resolution:1e3,original_font_information:{format:0,copyright:e.names.copyright?.en||"",fontFamily:e.names.fontFamily?.en||"",fontSubfamily:e.names.fontSubfamily?.en||"",uniqueID:e.names.uniqueID?.en||"",fullName:e.names.fullName?.en||"",version:e.names.version?.en||"",postScriptName:e.names.postScriptName?.en||""}}}static pathToOutline(e,t){let i=[];for(let r of e.commands)switch(r.type){case"M":i.push(`m ${this.round(r.x*t)} ${this.round(r.y*t)}`);break;case"L":i.push(`l ${this.round(r.x*t)} ${this.round(r.y*t)}`);break;case"Q":i.push(`q ${this.round(r.x1*t)} ${this.round(r.y1*t)} ${this.round(r.x*t)} ${this.round(r.y*t)}`);break;case"C":i.push(`b ${this.round(r.x1*t)} ${this.round(r.y1*t)} ${this.round(r.x2*t)} ${this.round(r.y2*t)} ${this.round(r.x*t)} ${this.round(r.y*t)}`);break;case"Z":i.push("z");break}return i.join(" ")}static round(e){return Math.round(e*100)/100}static isTypefaceJson(e){let t=e.toLowerCase();return t.endsWith(".json")||t.includes("typeface")}static isFontFile(e){let t=e.toLowerCase();return t.endsWith(".ttf")||t.endsWith(".otf")||t.endsWith(".woff")||t.endsWith(".woff2")}static clearCache(){this.cache.clear()}};ve.cache=new Map,ve.loadingPromises=new Map;var Be=Math.PI/180;var ut=`
[data-string3d-text] {
  -webkit-text-fill-color: transparent;
}

[data-string3d-text]::before {
  content: attr(data-string3d-text);
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  
  color: inherit;
  -webkit-text-fill-color: initial;
  font: inherit;
  text-transform: inherit;
  letter-spacing: inherit;
  line-height: inherit;
  text-align: inherit;
  white-space: inherit;
  word-spacing: inherit;
  
  transform: var(--string3d-transform, none);
  transform-style: preserve-3d;
  transform-origin: center center;
}
`,O=class O{static markObjectPendingFont(e,t){let i=this.pendingFontObjects.get(e);i||(i=new Set,this.pendingFontObjects.set(e,i)),i.add(t),this.log(`Marked object ${t.id} as pending font: ${e}`)}static clearObjectPendingFont(e,t){let i=this.pendingFontObjects.get(e);i&&i.delete(t)}static invalidatePendingObjects(e){let t=this.pendingFontObjects.get(e);t&&(this.log(`Font loaded: ${e}, invalidating ${t.size} pending objects`),t.forEach(i=>{this.geometryKeys.delete(i)}),t.clear())}static injectPseudoElementStyles(){if(this.pseudoStyleInjected||typeof document>"u")return;let e=document.createElement("style");e.setAttribute("data-string3d","pseudo-text"),e.textContent=ut,document.head.appendChild(e),this.pseudoStyleInjected=!0}static setupSelectableText(e){let t=e.textContent||"";e.dataset.string3dText!==t&&(e.dataset.string3dText=t);let i=getComputedStyle(e);i.position==="static"&&(e.style.position="relative");let r=i.getPropertyValue("--rotate-x").trim()||"0",a=i.getPropertyValue("--rotate-y").trim()||"0",s=i.getPropertyValue("--rotate-z").trim()||"0",o=i.getPropertyValue("--translate-x").trim()||"0px",n=i.getPropertyValue("--translate-y").trim()||"0px",l=i.getPropertyValue("--translate-z").trim()||"0px",c=i.getPropertyValue("--scale").trim()||"1",h=[o!=="0px"&&o!=="0"?`translateX(${o})`:"",n!=="0px"&&n!=="0"?`translateY(${n})`:"",l!=="0px"&&l!=="0"?`translateZ(${l})`:"",r!=="0"?`rotateX(${r}deg)`:"",a!=="0"?`rotateY(${a}deg)`:"",s!=="0"?`rotateZ(${s}deg)`:"",c!=="1"?`scale(${c})`:""].filter(Boolean).join(" ");e.style.setProperty("--string3d-transform",h||"none")}sync(e,t,i,r){O.injectPseudoElementStyles(),O.setupSelectableText(e);let{rect:a,width:s,height:o}=this.readLayout(e,i),n=this.readStyleBundle(e,i),{translateZ:l,cssScale:c,rotateX:h,rotateY:u,rotateZ:d,cssScaleZ:p,opacity:m,color:f,metalness:C,roughness:v,emissive:y,castShadow:M,receiveShadow:P,fontFamily:j,fontSize:T,textTransform:z,textDepth:D,textCurveSegments:b,bevelEnabled:w,bevelSize:V,bevelThickness:N,bevelOffset:_,bevelSegments:H,fontCss:U}=n,k=a.left+a.width*.5,B=a.top+a.height*.5;if(i.camera.getMode()==="orthographic")t.object.position.set(k-i.viewportWidth/2,-(B-i.viewportHeight/2),l);else{let W=i.camera.getFrustumSizeAt(l),$=k/i.viewportWidth,ee=B/i.viewportHeight;t.object.position.set(($-.5)*W.width,-(ee-.5)*W.height,l)}t.object.rotation.x=-h*Be,t.object.rotation.y=u*Be,t.object.rotation.z=-d*Be,t.object.rotation.order="XYZ",t.object.rotation.z=-d*Be,t.object.rotation.order="XYZ";let x=this.extractCharacterLayout(e,z),S=x.map(W=>W.char).join(""),L=!!U,E=this.getTextMesh(t);if(!E)return O.log("No mesh found for text object"),{scale:c*(r?.scale||1)};if(x.length===0)return O.log("Empty text content, hiding mesh"),E.visible=!1,{scale:c*(r?.scale||1)};E.visible=!0;let R=ce.resolveFontFamily(j||"");if(!R){return O.warnedMissingFont||(O.warnedMissingFont=!0),{scale:c*(r?.scale||1)};return{scale:c*(r?.scale||1)}}if(!i.engine.loadFont||!i.engine.createTextGeometry)return O.warnedMissingLoader||(O.warnedMissingLoader=!0),{scale:c*(r?.scale||1)};let I=R.url,Z=O.fontCache.get(I);if(!Z){if(O.markObjectPendingFont(I,t),!O.fontPromises.has(I)){let W=i.engine.loadFont(I).then($=>($&&(O.fontCache.set(I,$),O.invalidatePendingObjects(I)),$));O.fontPromises.set(I,W)}return E.visible=!1,{scale:c*(r?.scale||1)}}O.clearObjectPendingFont(I,t);let q=x.length>0?`${x.length}:${x[0].x.toFixed(1)},${x[0].y.toFixed(1)}:${x[x.length-1].x.toFixed(1)},${x[x.length-1].y.toFixed(1)}`:"empty",Y=[S,T.toFixed(3),U||"",a.width.toFixed(1),a.height.toFixed(1),q,D.toFixed(3),b.toFixed(3),w?"1":"0",V.toFixed(3),N.toFixed(3),_.toFixed(3),H.toFixed(3)].join("|");if(O.geometryKeys.get(t)!==Y){O.log("Creating new geometry for",S.substring(0,20),"Layout:",q);let W=O.getFontMetrics(Z,T),$=W?W.ascent:T*.8,ee=x.map(oe=>({...oe,y:oe.y+$})),Q=i.engine.createTextGeometry(S,Z,{size:T,height:D,curveSegments:Math.max(1,Math.round(b)),bevelEnabled:w,bevelThickness:N,bevelSize:V,bevelOffset:_,bevelSegments:Math.max(0,Math.round(H)),lineHeight:0,letterSpacing:0,align:"left",layout:ee});Q&&(Q.computeBoundingBox(),E.geometry&&E.geometry.dispose?.(),E.geometry=Q,t.geometry=Q,O.geometryKeys.set(t,Y))}let X=r?.scale||1,ae=i.camera.getMode()==="orthographic"?1:i.camera.getScaleAtZ(l,i.viewportHeight),se=c*X*ae,fe=se*p;t.object.scale.set(se,se,fe);let ge=-s*.5,ye=o*.5;return E.position.set(ge,ye,0),me.applyVisualProps(e,t,{opacity:m,color:f&&f!=="none"?f:void 0,metalness:Number.isFinite(C)?C:void 0,roughness:Number.isFinite(v)?v:void 0,emissive:y&&y!=="none"?y:void 0,castShadow:M,receiveShadow:P}),this.updateCustomUniforms(e,t,i),{scale:se}}extractCharacterLayout(e,t){let i=[];if(typeof document>"u"||!document.createRange)return i;let r=document.createRange(),a=e.getBoundingClientRect(),s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),o;for(;o=s.nextNode();){let n=o.textContent||"";if(!(!n.trim()&&n!==" "))for(let l=0;l<n.length;l++){let c=n[l];if(c===`
`||c==="\r"||!c.trim())continue;r.setStart(o,l),r.setEnd(o,l+1);let h=r.getClientRects();if(h.length>0){let u=h[0],d=u.left-a.left,p=u.top-a.top,m=this.applyTextTransform(c,t);i.push({char:m,x:d,y:p,width:u.width,height:u.height})}}}return i}getTextMesh(e){let t=e.object;if(t?.__textMesh)return t.__textMesh;if(t?.isMesh)return t;if(Array.isArray(t?.children)){let i=t.children.find(r=>r?.isMesh);if(i)return t.__textMesh=i,i}return null}updateCustomUniforms(e,t,i){let r=i.engine.getMaterialFactory?.();if(!r)return;let a=getComputedStyle(e),s=o=>{let n=o?.userData?.definition;if(!n?.uniforms)return;let l=r.parseUniformsFromCSS(n,e,a);for(let[c,h]of Object.entries(l)){let u=n.uniforms?.[c];if(!u)continue;let d=r.convertUniformValue?.bind(r),p=d?d(u.type,h):h;o.userData?.shader?.uniforms?.[c]?o.userData.shader.uniforms[c].value=p:o.userData?.customUniforms?.[c]?o.userData.customUniforms[c].value=p:o.uniforms?.[c]&&(o.uniforms[c].value=p)}};if(t.object.traverse)t.object.traverse(o=>{o.isMesh&&(Array.isArray(o.material)?o.material:[o.material]).forEach(s)});else{let o=this.getTextMesh(t);if(!o)return;(Array.isArray(o.material)?o.material:[o.material]).forEach(s)}}readStyleBundle(e,t){return O.styleCache.get(e,t,i=>{let r=i.computedStyleMap?.(),a=getComputedStyle(i),s=(D,b)=>{let w=r?.get?.(D);if(w!=null){let _=typeof w=="object"&&"value"in w?w.value:w,H=typeof _=="number"?_:Number.parseFloat(String(_));if(!Number.isNaN(H))return H}let V=a.getPropertyValue(D),N=Number.parseFloat(V);return Number.isNaN(N)?b:N},o=D=>{let b=r?.get?.(D),w=b&&typeof b=="object"&&"value"in b?b.value:b;return typeof w=="string"?w.trim():a.getPropertyValue(D).trim()},n=(D,b=!1)=>{let w=o(D);if(!w)return b;let V=w.toLowerCase();return V==="true"||V==="1"||V==="yes"?!0:V==="false"||V==="0"||V==="no"?!1:b},l=o("--material-color"),c=l&&l!=="none"?l:a.color.trim(),h=(()=>{let D=a.fontSize||"",b=Number.parseFloat(D);return Number.isFinite(b)?b:16})(),u=(()=>{let D=a.lineHeight||"";if(!D||D==="normal")return h*1.2;let b=Number.parseFloat(D);return Number.isFinite(b)?D.endsWith("px")?b:b*h:h*1.2})(),d=(()=>{let D=a.letterSpacing||"";if(!D||D==="normal")return 0;let b=Number.parseFloat(D);return Number.isFinite(b)?b:0})(),p=o("--text-fit")||"none",m=s("--text-depth",NaN),f=Number.isFinite(m)?m:Math.max(1,h*.2),C=s("--text-bevel-size",0),v=s("--text-bevel-thickness",0),y=s("--text-bevel-offset",0),M=s("--text-bevel-steps",0),P=(a.textAlign||"left").toLowerCase(),j=P==="center"?"center":P==="right"||P==="end"?"right":"left",T=a.font?.trim(),z=T&&T.length>0?T:[a.fontStyle||"normal",a.fontWeight||"normal",`${a.fontSize||"16px"}/${a.lineHeight||"normal"}`,a.fontFamily||"sans-serif"].join(" ");return{translateZ:s("--translate-z",0),cssScale:s("--scale",1),rotateX:s("--rotate-x",0),rotateY:s("--rotate-y",0),rotateZ:s("--rotate-z",0),cssScaleZ:s("--scale-z",1),opacity:s("--opacity",NaN),color:c,metalness:s("--material-metalness",NaN),roughness:s("--material-roughness",NaN),emissive:o("--material-emissive"),castShadow:n("--shadow-cast",!1),receiveShadow:n("--shadow-receive",!1),fontFamily:a.fontFamily||"",fontCss:z,fontSize:h,lineHeight:u,letterSpacing:d,textAlign:j,textTransform:(a.textTransform||"").toLowerCase(),textDepth:f,textCurveSegments:s("--text-curve-segments",8),bevelEnabled:C>0||v>0,bevelSize:C,bevelThickness:v,bevelOffset:y,bevelSegments:M,textFit:p==="cover"||p==="none"?p:"contain"}})}applyTextTransform(e,t){return!t||t==="none"?e:t==="uppercase"?e.toUpperCase():t==="lowercase"?e.toLowerCase():t==="capitalize"?e.replace(/\b(\p{L})/gu,i=>i.toUpperCase()):e}static getFontMetrics(e,t){let i=e?.data,r=Number(i?.resolution),a=Number(i?.ascender),s=Number(i?.descender);if(!Number.isFinite(r)||r<=0||!Number.isFinite(a)||!Number.isFinite(s))return null;let o=a/r*t,n=Math.abs(s)/r*t;return!Number.isFinite(o)||!Number.isFinite(n)?null:{ascent:o,descent:n}}readLayout(e,t){let i=e.__layoutCache;return i||O.layoutCache.get(e,t,r=>{let a=r.getBoundingClientRect();return{rect:a,width:a.width,height:a.height}})}};O.styleCache=new J,O.layoutCache=new J,O.geometryKeys=new WeakMap,O.fontCache=new Map,O.fontPromises=new Map,O.pendingFontObjects=new Map,O.warnedMissingFont=!1,O.warnedMissingLoader=!1,O.pseudoStyleInjected=!1;var Ae=O;var Oe=class{constructor(e,t,i,r){this.camera=e;this.viewportWidth=t;this.viewportHeight=i;this.engine=r;this.strategies=new Map;this.styleReadIntervalMs=0;this.layoutReadIntervalMs=0;this.strategies.set("box",new me),this.strategies.set("sphere",new me),this.strategies.set("plane",new me),this.strategies.set("cylinder",new me),this.strategies.set("model",new me),this.strategies.set("group",new ze),this.strategies.set("pointLight",new Me),this.strategies.set("ambientLight",new Me),this.strategies.set("directionalLight",new Me),this.strategies.set("spotLight",new Me),this.strategies.set("hemisphereLight",new Me),this.strategies.set("particles",new _e),this.strategies.set("text",new Ae)}syncElement(e,t,i,r){let a=this.strategies.get(t.type);return a?a.sync(e,t,{camera:this.camera,viewportWidth:this.viewportWidth,viewportHeight:this.viewportHeight,engine:this.engine,dirtySet:r?.dirtySet,forceSync:r?.forceSync,styleReadIntervalMs:this.styleReadIntervalMs,layoutReadIntervalMs:this.layoutReadIntervalMs},i):null}setSyncOptions(e){this.styleReadIntervalMs=Math.max(0,e.styleReadIntervalMs??0),this.layoutReadIntervalMs=Math.max(0,e.layoutReadIntervalMs??0)}updateViewportSize(e,t){this.viewportWidth=e,this.viewportHeight=t}};var He=class{constructor(e){this.handleScrollBound=()=>this.handleScroll();this.dirtyElements=new Set;this.observedElements=new Set;this.resizeObserver=null;this.mutationObserver=null;this.enabled=!1;this.domVersion=0;this.attributeFilter=e}enable(){this.enabled||(this.enabled=!0,this.setupObservers(),this.setupScrollListeners())}disable(){this.enabled&&(this.enabled=!1,this.removeScrollListeners(),this.resizeObserver?.disconnect(),this.mutationObserver?.disconnect(),this.dirtyElements.clear(),this.observedElements.clear())}observeElement(e){!this.enabled||this.observedElements.has(e)||(this.observedElements.add(e),this.resizeObserver?.observe(e),this.mutationObserver?.observe(e,{attributes:!0,attributeFilter:this.attributeFilter}))}observeScene(e){this.enabled&&e.forEach(t=>this.observeRecursive(t))}markDirty(e){this.enabled&&(this.dirtyElements.add(e),this.bumpVersion())}markAllDirty(){this.enabled&&(this.observedElements.forEach(e=>this.dirtyElements.add(e)),this.bumpVersion())}getDirtySet(){return this.enabled?this.dirtyElements:null}clearDirty(){this.dirtyElements.clear()}getVersion(){return this.domVersion}isEnabled(){return this.enabled}observeRecursive(e){e.el instanceof HTMLElement&&this.observeElement(e.el),e.children.forEach(t=>this.observeRecursive(t))}handleScroll(){this.markAllDirty()}setupObservers(){typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(e=>{e.forEach(t=>{t.target instanceof HTMLElement&&this.markDirty(t.target)})})),typeof MutationObserver<"u"&&(this.mutationObserver=new MutationObserver(e=>{e.forEach(t=>{t.target instanceof HTMLElement&&this.markDirty(t.target)})}))}setupScrollListeners(){window.addEventListener("scroll",this.handleScrollBound,{passive:!0}),window.addEventListener("resize",this.handleScrollBound,{passive:!0}),window.visualViewport&&(window.visualViewport.addEventListener("scroll",this.handleScrollBound,{passive:!0}),window.visualViewport.addEventListener("resize",this.handleScrollBound,{passive:!0}))}removeScrollListeners(){window.removeEventListener("scroll",this.handleScrollBound),window.removeEventListener("resize",this.handleScrollBound),window.visualViewport&&(window.visualViewport.removeEventListener("scroll",this.handleScrollBound),window.visualViewport.removeEventListener("resize",this.handleScrollBound))}bumpVersion(){this.domVersion+=1}};var ke=class{constructor(e){this.easingParser=e;this.filterStates=new WeakMap;this.filterWarnings=new WeakMap}collectTargets(e,t,i,r){let a=[],s=o=>{let n=o.el;if(n){let l=this.filterStates.get(n)?.animating===!0,c=!i||!r||r.has(n)||l,h=this.readFilterChain(n,t,c);if(h&&h.length>0){let u=!i||!r||r.has(n)||l,d=this.filterStates.get(n)?.effectsKey||this.stringifyFilterChain(h);a.push({object:o,effects:h,effectsKey:d,dirty:u});return}}o.children.forEach(l=>s(l))};return e.forEach(o=>s(o)),a}clear(){this.filterStates=new WeakMap,this.filterWarnings=new WeakMap}readFilterChain(e,t,i){let r=this.filterStates.get(e);if(!i&&r)return r.animating?this.sampleTransition(r,t):r.effects;let a=rt(e);if(!a||a==="none"){if(r){if(r.animating&&r.clearOnComplete){let m=this.sampleTransition(r,t);return r.animating?m:(this.filterStates.delete(e),null)}let{duration:u,delay:d,easing:p}=this.getFilterTransition(e);if(u<=0&&r.lastDuration>0&&(u=r.lastDuration,d=r.lastDelay,p=r.lastEasing),u>0){let m=this.makeZeroChain(r.effects);return r.from=r.effects,r.to=m,r.startTime=t+d,r.duration=u,r.easing=p,r.animating=!0,r.clearOnComplete=!0,r.lastDuration=u,r.lastDelay=d,r.lastEasing=p,this.sampleTransition(r,t)}}return this.filterStates.delete(e),null}let{effects:s,warnings:o}=this.parseFilterChain(a);if(this.warnFilterIssues(e,a,o),s.length===0)return null;let n=this.filterStates.get(e);if(!n){let{duration:u,delay:d,easing:p}=this.getFilterTransition(e);if(u>0){let m=this.makeZeroChain(s),f={raw:a,effects:s,animating:!0,from:m,to:s,startTime:t+d,duration:u,easing:p,clearOnComplete:!1,lastDuration:u,lastDelay:d,lastEasing:p};return f.effectsKey=this.stringifyFilterChain(s),this.filterStates.set(e,f),this.sampleTransition(f,t)}return this.filterStates.set(e,{raw:a,effects:s,animating:!1,from:s,to:s,startTime:0,duration:0,easing:m=>m,clearOnComplete:!1,lastDuration:0,lastDelay:0,lastEasing:m=>m,effectsKey:this.stringifyFilterChain(s)}),s}if(n.raw===a){if(n.animating){let u=this.sampleTransition(n,t);return!n.animating&&n.clearOnComplete?(this.filterStates.delete(e),null):u}return n.effects}n.pendingEffects=void 0,n.pendingRaw=void 0;let{duration:l,delay:c,easing:h}=this.getFilterTransition(e);if(l<=0&&n.lastDuration>0&&(l=n.lastDuration,c=n.lastDelay,h=n.lastEasing),l>0){let u=this.canInterpolate(n.effects,s),d=n.animating?this.getCurrentChain(n,t):n.effects;if(!u&&this.isZeroChain(s))return n.pendingRaw=a,n.pendingEffects=s,n.raw=a,n.effects=d,n.from=d,n.to=this.makeZeroChain(d),n.startTime=t+c,n.duration=l,n.easing=h,n.animating=!0,n.clearOnComplete=!1,n.lastDuration=l,n.lastDelay=c,n.lastEasing=h,n.effectsKey=this.stringifyFilterChain(s),this.sampleTransition(n,t);let p=u?d:this.makeZeroChain(s);return n.raw=a,n.effects=s,n.from=p,n.to=s,n.startTime=t+c,n.duration=l,n.easing=h,n.animating=!0,n.clearOnComplete=!1,n.lastDuration=l,n.lastDelay=c,n.lastEasing=h,n.effectsKey=this.stringifyFilterChain(s),this.sampleTransition(n,t)}return n.raw=a,n.effects=s,n.animating=!1,n.clearOnComplete=!1,n.effectsKey=this.stringifyFilterChain(s),s}warnFilterIssues(e,t,i){i.length===0||this.filterWarnings.get(e)===t||this.filterWarnings.set(e,t)}parseFilterChain(e){let t=[],i=[],r=u=>{let p=u.trim().toLowerCase().match(/^(-?\d*\.?\d+)(px)?$/);if(!p)return null;let m=Number.parseFloat(p[1]);return Number.isFinite(m)?m:null},a=u=>{let d=u.trim().toLowerCase();if(!d)return null;if(d.endsWith("%")){let m=Number.parseFloat(d.slice(0,-1));return Number.isFinite(m)?m/100:null}let p=Number.parseFloat(d);return Number.isFinite(p)?p:null},s=u=>{let d=u.trim().toLowerCase();if(!d)return null;if(d.endsWith("rad")){let f=Number.parseFloat(d.slice(0,-3));return Number.isFinite(f)?f:null}let p=d.endsWith("deg")?d.slice(0,-3):d,m=Number.parseFloat(p);return Number.isFinite(m)?m*Math.PI/180:null},o=u=>{let d=u.split(",").map(f=>f.trim()),p=r(d[0]||"");if(p===null)return null;let m=d[1]?a(d[1]):null;return{intensity:Math.max(0,p),threshold:m===null?.8:Math.max(0,Math.min(1,m))}},n=(u,d,p=!1)=>{let m=r(u);return m===null?(t.push(`[String3D] Invalid ${d} value "${u}".`),null):!p&&m<=0?(t.push(`[String3D] ${d} must be > 0.`),null):m},l=(u,d)=>{let p=a(u);return p===null?(t.push(`[String3D] Invalid ${d} value "${u}".`),null):p},c=/([a-zA-Z-]+)\(([^)]*)\)/g,h;for(;h=c.exec(e);){let u=h[1].toLowerCase(),d=(h[2]||"").trim();if(u==="blur"){let p=n(d,"blur",!0);p!==null&&i.push({type:"blur",amount:p})}else if(u==="pixel"||u==="pixelate"){let p=n(d,"pixel",!0);p!==null&&i.push({type:"pixel",size:p})}else if(u==="bloom"){let p=o(d);p?i.push({type:"bloom",...p}):t.push(`[String3D] Invalid bloom value "${d}".`)}else if(u==="brightness"){let p=l(d,"brightness");p!==null&&i.push({type:"brightness",amount:Math.max(0,p)})}else if(u==="contrast"){let p=l(d,"contrast");p!==null&&i.push({type:"contrast",amount:Math.max(0,p)})}else if(u==="saturate"){let p=l(d,"saturate");p!==null&&i.push({type:"saturate",amount:Math.max(0,p)})}else if(u==="grayscale"){let p=l(d,"grayscale");p!==null&&i.push({type:"grayscale",amount:Math.max(0,Math.min(1,p))})}else if(u==="sepia"){let p=l(d,"sepia");p!==null&&i.push({type:"sepia",amount:Math.max(0,Math.min(1,p))})}else if(u==="invert"){let p=l(d,"invert");p!==null&&i.push({type:"invert",amount:Math.max(0,Math.min(1,p))})}else if(u==="hue-rotate"){let p=s(d);p!==null?i.push({type:"hue-rotate",angle:p}):t.push(`[String3D] Invalid hue-rotate value "${d}".`)}else if(u){let p=Se.get(u);if(p){let m=p.parse?p.parse(d):{};m===null?t.push(`[String3D] Invalid custom filter "${u}" args "${d}".`):i.push({type:"custom",name:u,uniforms:m})}else t.push(`[String3D] Unknown filter "${u}".`)}}return i.length===0&&t.push("[String3D] No valid filters parsed from --filter."),{effects:i,warnings:t}}getFilterTransition(e){let t=getComputedStyle(e),i=this.splitTransitionList(t.transitionProperty),r=this.splitTransitionList(t.transitionDuration),a=this.splitTransitionList(t.transitionDelay),s=this.splitTransitionList(t.transitionTimingFunction),o=this.findTransitionIndex(i,"--filter");if(o===-1){let h=this.parseTransitionShorthand(t.transition),u=h.get("--filter")||h.get("all");return u||{duration:0,delay:0,easing:d=>d}}let n=this.parseTime(r[o]||r[r.length-1]||"0s"),l=this.parseTime(a[o]||a[a.length-1]||"0s"),c=s[o]||s[s.length-1]||"linear";return{duration:n,delay:l,easing:this.parseEasing(c)}}splitTransitionList(e){let t=[],i="",r=0;for(let a=0;a<e.length;a+=1){let s=e[a];s==="("&&(r+=1),s===")"&&(r=Math.max(0,r-1)),s===","&&r===0?(t.push(i.trim()),i=""):i+=s}return i.trim()&&t.push(i.trim()),t.length>0?t:["all"]}findTransitionIndex(e,t){let i=e.map(a=>a.trim().toLowerCase()),r=i.indexOf(t);return r===-1&&(r=i.indexOf("all")),r}parseTime(e){let t=e.trim().toLowerCase();if(t.endsWith("ms")){let r=Number.parseFloat(t.slice(0,-2));return Number.isFinite(r)?r:0}if(t.endsWith("s")){let r=Number.parseFloat(t.slice(0,-1));return Number.isFinite(r)?r*1e3:0}let i=Number.parseFloat(t);return Number.isFinite(i)?i:0}parseTransitionShorthand(e){let t=new Map;return this.splitTransitionList(e).forEach(r=>{if(!r)return;let a=r.trim().split(/\s+(?![^()]*\))/g),s="",o="",n="",l="";a.forEach(c=>{let h=c.toLowerCase();h.endsWith("ms")||h.endsWith("s")||/^[0-9.]+$/.test(h)?o?n||(n=h):o=h:h.startsWith("cubic-bezier")||h.startsWith("steps")||h==="linear"||h==="ease"||h==="ease-in"||h==="ease-out"||h==="ease-in-out"?l=c:s||(s=c)}),s&&t.set(s.trim().toLowerCase(),{duration:this.parseTime(o||"0s"),delay:this.parseTime(n||"0s"),easing:this.parseEasing(l||"linear")})}),t}parseEasing(e){let t=e.trim();if(!t)return i=>i;if(!this.easingParser)return i=>i;try{let i=this.easingParser(t);return typeof i=="function"?i:r=>r}catch{return i=>i}}canInterpolate(e,t){return e.length!==t.length?!1:e.every((i,r)=>{let a=t[r];if(i.type!==a.type)return!1;if(i.type==="custom"&&a.type==="custom"){if(i.name!==a.name)return!1;let s=Object.keys(i.uniforms||{}),o=Object.keys(a.uniforms||{});return s.length!==o.length?!1:s.every(n=>n in(a.uniforms||{})&&this.isNumeric(i.uniforms?.[n]))}return!0})}makeZeroChain(e){return e.map(t=>{switch(t.type){case"blur":return{type:"blur",amount:0};case"pixel":return{type:"pixel",size:0};case"bloom":return{type:"bloom",intensity:0,threshold:t.threshold};case"brightness":return{type:"brightness",amount:1};case"contrast":return{type:"contrast",amount:1};case"saturate":return{type:"saturate",amount:1};case"grayscale":return{type:"grayscale",amount:0};case"sepia":return{type:"sepia",amount:0};case"invert":return{type:"invert",amount:0};case"hue-rotate":return{type:"hue-rotate",angle:0};case"custom":{let i={};return Object.entries(t.uniforms||{}).forEach(([r,a])=>{i[r]=this.isNumeric(a)?0:a}),{type:"custom",name:t.name,uniforms:i}}default:return t}})}sampleTransition(e,t){if(!e.animating)return e.effects;if(t<e.startTime)return e.from;let i=t-e.startTime,r=Math.max(1,e.duration),a=Math.min(1,Math.max(0,i/r)),s=e.easing(a),o=this.interpolateChain(e.from,e.to,s);return a>=1&&(e.animating=!1,e.from=e.to,e.pendingEffects&&e.pendingRaw===e.raw?(e.effects=e.pendingEffects,e.raw=e.pendingRaw||e.raw,e.pendingEffects=void 0,e.pendingRaw=void 0):e.pendingEffects&&(e.pendingEffects=void 0,e.pendingRaw=void 0)),o}getCurrentChain(e,t){if(!e.animating)return e.effects;if(t<e.startTime)return e.from;let i=t-e.startTime,r=Math.max(1,e.duration),a=Math.min(1,Math.max(0,i/r)),s=e.easing(a);return this.interpolateChain(e.from,e.to,s)}interpolateChain(e,t,i){return this.canInterpolate(e,t)?e.map((r,a)=>this.interpolateEffect(r,t[a],i)):t}interpolateEffect(e,t,i){let r=(a,s)=>a+(s-a)*i;if(e.type==="blur"&&t.type==="blur")return{type:"blur",amount:r(e.amount,t.amount)};if(e.type==="pixel"&&t.type==="pixel")return{type:"pixel",size:r(e.size,t.size)};if(e.type==="bloom"&&t.type==="bloom")return{type:"bloom",intensity:r(e.intensity,t.intensity),threshold:r(e.threshold,t.threshold)};if(e.type==="brightness"&&t.type==="brightness")return{type:"brightness",amount:r(e.amount,t.amount)};if(e.type==="contrast"&&t.type==="contrast")return{type:"contrast",amount:r(e.amount,t.amount)};if(e.type==="saturate"&&t.type==="saturate")return{type:"saturate",amount:r(e.amount,t.amount)};if(e.type==="grayscale"&&t.type==="grayscale")return{type:"grayscale",amount:r(e.amount,t.amount)};if(e.type==="sepia"&&t.type==="sepia")return{type:"sepia",amount:r(e.amount,t.amount)};if(e.type==="invert"&&t.type==="invert")return{type:"invert",amount:r(e.amount,t.amount)};if(e.type==="hue-rotate"&&t.type==="hue-rotate")return{type:"hue-rotate",angle:r(e.angle,t.angle)};if(e.type==="custom"&&t.type==="custom"&&e.name===t.name){let a={};return Object.entries(t.uniforms||{}).forEach(([s,o])=>{let n=e.uniforms?.[s];this.isNumeric(n)&&this.isNumeric(o)?a[s]=r(n,o):a[s]=o}),{type:"custom",name:t.name,uniforms:a}}return t}stringifyFilterChain(e){return e.map(i=>{if(i.type==="blur")return`blur:${i.amount}`;if(i.type==="pixel")return`pixel:${i.size}`;if(i.type==="bloom")return`bloom:${i.intensity},${i.threshold}`;if(i.type==="brightness")return`brightness:${i.amount}`;if(i.type==="contrast")return`contrast:${i.amount}`;if(i.type==="saturate")return`saturate:${i.amount}`;if(i.type==="grayscale")return`grayscale:${i.amount}`;if(i.type==="sepia")return`sepia:${i.amount}`;if(i.type==="invert")return`invert:${i.amount}`;if(i.type==="hue-rotate")return`hue-rotate:${i.angle}`;if(i.type==="custom"){let r=Object.keys(i.uniforms||{}).sort().map(a=>`${a}=${i.uniforms[a]}`).join(",");return`custom:${i.name}:${r}`}return"unknown"}).join("|")}isNumeric(e){return typeof e=="number"&&Number.isFinite(e)}isZeroChain(e){return e.every(t=>{switch(t.type){case"blur":return t.amount<=0;case"pixel":return t.size<=0;case"bloom":return t.intensity<=0;case"brightness":return t.amount===1;case"contrast":return t.amount===1;case"saturate":return t.amount===1;case"grayscale":return t.amount===0;case"sepia":return t.amount===0;case"invert":return t.amount===0;case"hue-rotate":return t.angle===0;case"custom":return!1;default:return!1}})}};var xe=class xe extends ht{constructor(t){super(t);this.renderer=null;this.camera=null;this.scene=null;this.synchronizer=null;this.engine=null;this.canvasContainer=null;this.isLoading=new Map;this.useDirtySync=!1;this.lastSyncData=new WeakMap;this.htmlKey="3d",this.options=this.buildOptionsFromSettings(),this.dirtySyncManager=new He(["style","class","string-3d","string-3d-model-fit","string-3d-model-scale"]),this.filterController=new ke(i=>this.tools.easingFunction.process({easing:i})),this.attributesToMap=[...this.attributesToMap,{key:"3d",type:"string",fallback:"box"},{key:"3d-model",type:"string",fallback:""},{key:"3d-segments",type:"number",fallback:32},{key:"3d-segments-width",type:"number",fallback:32},{key:"3d-segments-height",type:"number",fallback:32},{key:"3d-model-loader",type:"string",fallback:""},{key:"3d-model-scale",type:"number",fallback:1},{key:"3d-model-center",type:"boolean",fallback:!1},{key:"3d-model-fit",type:"string",fallback:"contain"}]}static setProvider(t){xe.provider=t}static registerFont(t,i,r={}){ce.register(t,i),r.default&&ce.setDefault(t)}static setDefaultFont(t){ce.setDefault(t)}canConnect(t){return super.canConnect(t)}initializeObject(t,i,r,a){super.initializeObject(t,i,r,a),i.setProperty("parentId",null);let s=r.parentElement?.closest('[string-3d="group"]');if(s){let o=s.getAttribute("string-id");o&&(i.setProperty("parentId",o),i.setProperty("parent",s))}}onResize(){this.renderer&&this.camera&&this.synchronizer&&(this.renderer.resize(this.camera),this.synchronizer.updateViewportSize(this.renderer.width,this.renderer.height),this.camera.clearScaleCache(),this.useDirtySync&&this.dirtySyncManager.markAllDirty())}onInit(){if(this.options=this.buildOptionsFromSettings(),!xe.provider)return;this.engine=xe.provider.getEngine(),this.canvasContainer=this.createOrGetContainer(),this.registerTypedProperties(),this.injectCSS(),this.useDirtySync=!!this.options.useDirtySync,this.useDirtySync&&this.dirtySyncManager.enable(),this.renderer=new Ie(this.canvasContainer,this.engine),this.renderer.attach(),this.camera=new Te(this.engine,"orthographic"),this.camera.setPosition(0,0,1e3),this.camera.resize(this.renderer.width,this.renderer.height);let t=this.resolveModelLoader(),i=this.resolveModelLoaderFactory();this.scene=new Le(this.engine,{modelLoader:t,modelLoaderFactory:i}),this.scene.getScene().add(this.camera.camera),this.synchronizer=new Oe(this.camera,this.renderer.width,this.renderer.height,this.engine),this.synchronizer.setSyncOptions({styleReadIntervalMs:this.options.styleReadIntervalMs,layoutReadIntervalMs:this.options.layoutReadIntervalMs}),console.info(`[String3D] Initialized with: ${xe.provider.getName()}`)}onSettingsChange(){this.options=this.buildOptionsFromSettings();let t=!!this.options.useDirtySync;t&&!this.useDirtySync?(this.useDirtySync=!0,this.dirtySyncManager.enable(),this.scene&&this.dirtySyncManager.observeScene(this.scene.rootObjects),this.dirtySyncManager.markAllDirty()):!t&&this.useDirtySync&&(this.useDirtySync=!1,this.dirtySyncManager.disable()),this.synchronizer?.setSyncOptions({styleReadIntervalMs:this.options.styleReadIntervalMs,layoutReadIntervalMs:this.options.layoutReadIntervalMs})}buildOptionsFromSettings(){return{hideHTML:this.getSettingValue("hideHTML",!1),container:this.getSettingValue("container",void 0),zIndex:this.getSettingValue("zIndex",1),modelLoaderType:this.getSettingValue("modelLoaderType",void 0),modelLoader:this.getSettingValue("modelLoader",void 0),modelLoaderFactory:this.getSettingValue("modelLoaderFactory",void 0),useDirtySync:this.getSettingValue("useDirtySync",!1),styleReadIntervalMs:this.getSettingValue("styleReadIntervalMs",0),layoutReadIntervalMs:this.getSettingValue("layoutReadIntervalMs",0)}}getSettingValue(t,i){return!this.settings||!(t in this.settings)?i:this.settings[t]}resolveModelLoader(){if(this.engine){if(this.options.modelLoader)return this.options.modelLoader;if(!this.options.modelLoaderFactory&&this.options.modelLoaderType)try{return this.engine.createModelLoader(this.options.modelLoaderType)}catch{}}}resolveModelLoaderFactory(){if(this.engine){if(this.options.modelLoaderFactory)return this.options.modelLoaderFactory;if(this.options.modelLoaderType)return(t,i)=>{let r=i||this.options.modelLoaderType;if(!r)throw new Error("[String3D] Model loader type not provided");return t.createModelLoader(r)}}}createOrGetContainer(){if(this.options.container instanceof HTMLElement)return this.applyContainerStyles(this.options.container),this.options.container;if(typeof this.options.container=="string"){let i=document.getElementById(this.options.container);if(i)return this.applyContainerStyles(i),i}let t=document.createElement("div");return t.id="string-3d-canvas",this.applyContainerStyles(t),document.body.insertBefore(t,document.body.firstChild),t}applyContainerStyles(t){Object.assign(t.style,{position:"fixed",left:"0",top:"0",width:"100vw",height:"100lvh",zIndex:String(this.options.zIndex),pointerEvents:"none"})}onObjectConnected(t){this.isLoading.has(t.id)||!this.scene||(this.isLoading.set(t.id,!0),this.scene.createFromElement(t),this.useDirtySync&&t.htmlElement&&(this.dirtySyncManager.observeElement(t.htmlElement),this.dirtySyncManager.markDirty(t.htmlElement)),this.options.hideHTML&&t.htmlElement&&(t.htmlElement.style.opacity="0",t.htmlElement.style.pointerEvents="none"))}onFrame(t){if(!this.renderer||!this.scene||!this.camera||!this.synchronizer)return;let i=this.useDirtySync?this.dirtySyncManager.getDirtySet():null,r=!i||i.size===0;this.batchReadLayouts(this.scene.rootObjects,r,i),this.scene.rootObjects.forEach(s=>{this.syncRecursive(s.el,s,{scale:1},r,i)});let a=this.filterController.collectTargets(this.scene.rootObjects,performance.now(),this.useDirtySync,i);this.renderer.render(this.scene,this.camera,a),this.useDirtySync&&this.dirtySyncManager.clearDirty()}batchReadLayouts(t,i,r){let a=s=>{if(s.el&&(i||!r||r.has(s.el))){let n=s.el.getBoundingClientRect(),l=s.el.offsetWidth||n.width,c=s.el.offsetHeight||n.height;s.el.__layoutCache={rect:n,width:l,height:c}}s.children.forEach(a)};t.forEach(a)}syncRecursive(t,i,r,a,s){if(!this.synchronizer||!t)return;let o=i.type==="particles"||i.type==="text"||a||!s||s.has(t),n=r;if(o){let c=this.synchronizer.syncElement(t,i,r,{dirtySet:s,forceSync:a});c&&typeof c.scale=="number"&&(this.lastSyncData.set(i,c),n=c)}else{let c=this.lastSyncData.get(i);c&&(n=c)}let l=a||o;i.children.forEach(c=>this.syncRecursive(c.el,c,n,l,s))}injectCSS(){if(document.getElementById("string-3d-styles"))return;let t=document.createElement("style");t.id="string-3d-styles",t.textContent=`
      @property --translate-x { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --translate-y { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --translate-z { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --rotate-x { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --rotate-y { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --rotate-z { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --scale { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --scale-x { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --scale-y { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --scale-z { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --opacity { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --filter { syntax: "*"; inherits: false; initial-value: none; }
      @property --light-color { syntax: "<color>"; inherits: false; initial-value: #ffffff; }
      @property --light-intensity { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --light-distance { syntax: "<number>"; inherits: false; initial-value: 1000; }
      @property --light-decay { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --light-angle { syntax: "<number>"; inherits: false; initial-value: 1.0472; }
      @property --light-penumbra { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --light-ground-color { syntax: "<color>"; inherits: false; initial-value: #ffffff; }
      @property --light-target { syntax: "*"; inherits: false; initial-value: none; }
      @property --shadow-cast { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --shadow-receive { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --shadow-bias { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --shadow-map-size { syntax: "<number>"; inherits: false; initial-value: 512; }
      @property --texture-flip-y { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --texture-color-space { syntax: "*"; inherits: false; initial-value: none; }
      @property --particles-mode { syntax: "*"; inherits: false; initial-value: emitter; }
      @property --particles-count { syntax: "<number>"; inherits: false; initial-value: 300; }
      @property --particles-size { syntax: "<number>"; inherits: false; initial-value: 2; }
      @property --particles-color { syntax: "<color>"; inherits: false; initial-value: #ffffff; }
      @property --particles-opacity { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --particles-spread { syntax: "<number>"; inherits: false; initial-value: 120; }
      @property --particles-seed { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --particles-shape { syntax: "*"; inherits: false; initial-value: sphere; }
      @property --particles-fit { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --particles-model { syntax: "*"; inherits: false; initial-value: none; }
      @property --particles-model-loader { syntax: "*"; inherits: false; initial-value: none; }
      @property --particles-model-node { syntax: "*"; inherits: false; initial-value: none; }
      @property --instance-model { syntax: "*"; inherits: false; initial-value: none; }
      @property --instance-model-loader { syntax: "*"; inherits: false; initial-value: none; }
      @property --instance-model-node { syntax: "*"; inherits: false; initial-value: none; }
      @property --emit-rate { syntax: "<number>"; inherits: false; initial-value: 30; }
      @property --emit-burst { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --particle-life { syntax: "<number>"; inherits: false; initial-value: 2.5; }
      @property --particle-speed { syntax: "<number>"; inherits: false; initial-value: 40; }
      @property --particle-direction { syntax: "*"; inherits: false; initial-value: 0 1 0; }
      @property --particle-gravity { syntax: "*"; inherits: false; initial-value: 0 -30 0; }
      @property --particle-drag { syntax: "<number>"; inherits: false; initial-value: 0.1; }
      @property --particle-size-variation { syntax: "<number>"; inherits: false; initial-value: 0.6; }
      @property --particle-color-variation { syntax: "<number>"; inherits: false; initial-value: 0.2; }
      @property --instance-shape { syntax: "*"; inherits: false; initial-value: sphere; }
      @property --instance-scale { syntax: "<number>"; inherits: false; initial-value: 1; }
      @property --instance-scale-variation { syntax: "<number>"; inherits: false; initial-value: 0.5; }
      @property --instance-rotation-speed { syntax: "<number>"; inherits: false; initial-value: 0.4; }
      @property --instance-jitter { syntax: "<number>"; inherits: false; initial-value: 0.2; }
      @property --instance-flow { syntax: "<number>"; inherits: false; initial-value: 0.3; }
      @property --instance-disperse { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --instance-scatter { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --instance-scatter-x { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --instance-scatter-y { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --instance-scatter-z { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --text-depth { syntax: "<number>"; inherits: false; initial-value: 8; }
      @property --text-curve-segments { syntax: "<number>"; inherits: false; initial-value: 8; }
      @property --text-bevel-size { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --text-bevel-thickness { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --text-bevel-offset { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --text-bevel-steps { syntax: "<number>"; inherits: false; initial-value: 0; }
      @property --text-fit { syntax: "*"; inherits: false; initial-value: contain; }

      :where([string-3d]) {
        --translate-x: 0; --translate-y: 0; --translate-z: 0;
        --rotate-x: 0; --rotate-y: 0; --rotate-z: 0;
        --scale: 1; --scale-x: 1; --scale-y: 1; --scale-z: 1; --opacity: 1; --filter: none;
        --light-color: #ffffff; --light-intensity: 1; --light-distance: 1000; --light-decay: 0;
        --light-angle: 1.0472; --light-penumbra: 0; --light-ground-color: #ffffff; --light-target: none;
        --shadow-cast: 0; --shadow-receive: 0; --shadow-bias: 0; --shadow-map-size: 512;
        --texture-flip-y: 1; --texture-color-space: none;
        --particles-mode: emitter; --particles-count: 300; --particles-size: 2; --particles-color: #ffffff;
        --particles-opacity: 1; --particles-spread: 120; --particles-seed: 1; --particles-shape: sphere;
        --particles-fit: 0;
        --particles-model: none; --particles-model-loader: none; --particles-model-node: none;
        --instance-model: none; --instance-model-loader: none; --instance-model-node: none;
        --emit-rate: 30; --emit-burst: 0; --particle-life: 2.5; --particle-speed: 40;
        --particle-direction: 0 1 0; --particle-gravity: 0 -30 0; --particle-drag: 0.1;
        --particle-size-variation: 0.6; --particle-color-variation: 0.2;
        --instance-shape: sphere; --instance-scale: 1; --instance-scale-variation: 0.5;
        --instance-rotation-speed: 0.4; --instance-jitter: 0.2; --instance-flow: 0.3;
        --instance-disperse: 0;
        --instance-scatter: 0;
        --instance-scatter-x: 0; --instance-scatter-y: 0; --instance-scatter-z: 0;
        --text-depth: 8; --text-curve-segments: 8; --text-bevel-size: 0; --text-bevel-thickness: 0;
        --text-bevel-offset: 0; --text-bevel-steps: 0; --text-fit: contain;
        transform-style: preserve-3d;
      }

      [string-3d-visual="true"] {
        transform:
          translate3d(calc(var(--translate-x) * 1px), calc(var(--translate-y) * 1px), calc(var(--translate-z) * 1px))
          rotateX(calc(var(--rotate-x) * 1deg))
          rotateY(calc(var(--rotate-y) * 1deg))
          rotateZ(calc(var(--rotate-z) * 1deg))
          scale3d(calc(var(--scale) * var(--scale-x)), calc(var(--scale) * var(--scale-y)), calc(var(--scale) * var(--scale-z)));
      }
    `,document.head.appendChild(t)}registerTypedProperties(){let t=globalThis.CSS;if(!t?.registerProperty)return;[{name:"--translate-x",initialValue:"0"},{name:"--translate-y",initialValue:"0"},{name:"--translate-z",initialValue:"0"},{name:"--rotate-x",initialValue:"0"},{name:"--rotate-y",initialValue:"0"},{name:"--rotate-z",initialValue:"0"},{name:"--scale",initialValue:"1"},{name:"--scale-x",initialValue:"1"},{name:"--scale-y",initialValue:"1"},{name:"--scale-z",initialValue:"1"},{name:"--opacity",initialValue:"1"},{name:"--filter",initialValue:"none"},{name:"--material-type",initialValue:"basic"},{name:"--material-color",initialValue:"#ffffff"},{name:"--material-metalness",initialValue:"0"},{name:"--material-roughness",initialValue:"1"},{name:"--material-emissive",initialValue:"#000000"},{name:"--rim-color",initialValue:"#00c8ff"},{name:"--rim-power",initialValue:"1.5"},{name:"--rim-strength",initialValue:"1"},{name:"--uv-strength",initialValue:"0.7"},{name:"--texture-map",initialValue:"none"},{name:"--texture-normal",initialValue:"none"},{name:"--texture-roughness",initialValue:"none"},{name:"--texture-metalness",initialValue:"none"},{name:"--texture-ao",initialValue:"none"},{name:"--light-color",initialValue:"#ffffff"},{name:"--light-intensity",initialValue:"1"},{name:"--light-distance",initialValue:"1000"},{name:"--light-decay",initialValue:"0"},{name:"--light-angle",initialValue:"1.0472"},{name:"--light-penumbra",initialValue:"0"},{name:"--light-ground-color",initialValue:"#ffffff"},{name:"--light-target",initialValue:"none"},{name:"--shadow-cast",initialValue:"0"},{name:"--shadow-receive",initialValue:"0"},{name:"--shadow-bias",initialValue:"0"},{name:"--shadow-map-size",initialValue:"512"},{name:"--texture-flip-y",initialValue:"1"},{name:"--texture-color-space",initialValue:"none"},{name:"--particles-mode",initialValue:"emitter"},{name:"--particles-count",initialValue:"300"},{name:"--particles-size",initialValue:"2"},{name:"--particles-color",initialValue:"#ffffff"},{name:"--particles-opacity",initialValue:"1"},{name:"--particles-spread",initialValue:"120"},{name:"--particles-seed",initialValue:"1"},{name:"--particles-shape",initialValue:"sphere"},{name:"--particles-fit",initialValue:"0"},{name:"--particles-model",initialValue:"none"},{name:"--particles-model-loader",initialValue:"none"},{name:"--particles-model-node",initialValue:"none"},{name:"--instance-model",initialValue:"none"},{name:"--instance-model-loader",initialValue:"none"},{name:"--instance-model-node",initialValue:"none"},{name:"--emit-rate",initialValue:"30"},{name:"--emit-burst",initialValue:"0"},{name:"--particle-life",initialValue:"2.5"},{name:"--particle-speed",initialValue:"40"},{name:"--particle-direction",initialValue:"0 1 0"},{name:"--particle-gravity",initialValue:"0 -30 0"},{name:"--particle-drag",initialValue:"0.1"},{name:"--particle-size-variation",initialValue:"0.6"},{name:"--particle-color-variation",initialValue:"0.2"},{name:"--instance-shape",initialValue:"sphere"},{name:"--instance-scale",initialValue:"1"},{name:"--instance-scale-variation",initialValue:"0.5"},{name:"--instance-rotation-speed",initialValue:"0.4"},{name:"--instance-jitter",initialValue:"0.2"},{name:"--instance-flow",initialValue:"0.3"},{name:"--instance-disperse",initialValue:"0"},{name:"--instance-scatter",initialValue:"0"},{name:"--instance-scatter-x",initialValue:"0"},{name:"--instance-scatter-y",initialValue:"0"},{name:"--instance-scatter-z",initialValue:"0"},{name:"--text-depth",initialValue:"8"},{name:"--text-curve-segments",initialValue:"8"},{name:"--text-bevel-size",initialValue:"0"},{name:"--text-bevel-thickness",initialValue:"0"},{name:"--text-bevel-offset",initialValue:"0"},{name:"--text-bevel-steps",initialValue:"0"},{name:"--text-fit",initialValue:"contain"}].forEach(({name:r,initialValue:a})=>{try{t.registerProperty({name:r,syntax:r==="--filter"||r==="--light-target"||r.startsWith("--texture-")||r==="--material-type"||r==="--particles-mode"||r==="--particles-shape"||r==="--particles-model"||r==="--particles-model-loader"||r==="--particles-model-node"||r==="--instance-model"||r==="--instance-model-loader"||r==="--instance-model-node"||r==="--particle-direction"||r==="--particle-gravity"||r==="--instance-shape"||r==="--text-fit"?"*":r.includes("color")||r.includes("emissive")?"<color>":"<number>",inherits:!1,initialValue:a})}catch{}})}destroy(){this.renderer?.destroy(),this.scene?.destroy(),this.isLoading.clear(),this.dirtySyncManager.disable(),this.filterController.clear(),this.lastSyncData=new WeakMap,document.getElementById("string-3d-styles")?.remove(),this.canvasContainer?.id==="string-3d-canvas"&&this.canvasContainer.remove(),super.destroy()}};xe.provider=null;var tt=xe;var Pe=class{constructor(e){this.textureCache=new Map;this.THREE=e,this.textureLoader=new e.TextureLoader}supports(e){return!0}create(e,t){let i=this.buildUniforms(e,t),r;return e.extends==="shader"||!e.extends&&e.vertexShader?r=this.createShaderMaterial(e,i):r=this.createExtendedMaterial(e,i),this.applyMaterialProperties(r,e),{material:r,definition:e,update:o=>{this.updateUniforms(r,e,o)},dispose:()=>{r.dispose()}}}parseUniformsFromCSS(e,t,i){return Ye(e,t,i)}buildUniforms(e,t){let i={};if(e.uniforms)for(let[r,a]of Object.entries(e.uniforms)){let s=t?.[r]??a.value;s=this.convertUniformValue(a.type,s),i[r]={value:s}}return i}convertUniformValue(e,t){switch(e){case"vec2":return Array.isArray(t)?new this.THREE.Vector2(t[0],t[1]):t;case"vec3":return Array.isArray(t)?new this.THREE.Vector3(t[0],t[1],t[2]):t;case"vec4":return Array.isArray(t)?new this.THREE.Vector4(t[0],t[1],t[2],t[3]):t;case"color":return Array.isArray(t)?new this.THREE.Color(t[0],t[1],t[2]):typeof t=="string"?new this.THREE.Color(t):t;case"texture":return typeof t=="string"&&t?this.loadTexture(t):t;default:return t}}loadTexture(e){if(this.textureCache.has(e))return this.textureCache.get(e);let t=this.textureLoader.load(e);return this.textureCache.set(e,t),t}createShaderMaterial(e,t){let i=new this.THREE.ShaderMaterial({uniforms:t,vertexShader:e.vertexShader||this.getDefaultVertexShader(),fragmentShader:e.fragmentShader||this.getDefaultFragmentShader(),lights:e.lights??!1,transparent:e.properties?.transparent??!1});return i.userData.customUniforms=t,i.userData.definition=e,i}createExtendedMaterial(e,t){let i=e.extends||"standard",r;switch(i){case"basic":r=this.THREE.MeshBasicMaterial;break;case"physical":r=this.THREE.MeshPhysicalMaterial;break;case"standard":default:r=this.THREE.MeshStandardMaterial;break}let a=new r({transparent:e.properties?.transparent??!1});if(e.injections&&e.injections.length>0){let s=Xe(e.injections);a.onBeforeCompile=o=>{Object.assign(o.uniforms,t),o.vertexShader=this.injectVertexShader(o.vertexShader,s,t),o.fragmentShader=this.injectFragmentShader(o.fragmentShader,s,t),a.userData.shader=o}}return a.userData.customUniforms=t,a.userData.definition=e,a}injectVertexShader(e,t,i){let r=e,a=t.get("vertex_pars");a&&(r=r.replace("#include <common>",`#include <common>
${a}`));let s=t.get("vertex_header");if(s){let l=this.generateUniformDeclarations(i);r=r.replace("void main() {",`${l}
${s}
void main() {`)}let o=t.get("vertex_transform");o&&(r=r.replace("#include <begin_vertex>",`#include <begin_vertex>
${o}`));let n=t.get("vertex_output");return n&&(r=r.replace("#include <project_vertex>",`${n}
#include <project_vertex>`)),r}injectFragmentShader(e,t,i){let r=e,a=t.get("fragment_pars");a&&(r=r.replace("#include <common>",`#include <common>
${a}`));let s=t.get("fragment_header");if(s){let h=this.generateUniformDeclarations(i);r=r.replace("void main() {",`${h}
${s}
void main() {`)}let o=t.get("fragment_color");o&&(r=r.replace("#include <color_fragment>",`#include <color_fragment>
${o}`));let n=t.get("fragment_normal");n&&(r=r.replace("#include <normal_fragment_maps>",`#include <normal_fragment_maps>
${n}`));let l=t.get("fragment_emissive");l&&(r=r.replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>
${l}`));let c=t.get("fragment_output");return c&&(r=r.replace("#include <dithering_fragment>",`${c}
#include <dithering_fragment>`)),r}generateUniformDeclarations(e){let t=[];for(let[i,r]of Object.entries(e)){let a=this.inferGLSLType(r.value);t.push(`uniform ${a} ${i};`)}return t.join(`
`)}inferGLSLType(e){return typeof e=="number"?"float":typeof e=="boolean"?"bool":e instanceof this.THREE.Vector2?"vec2":e instanceof this.THREE.Vector3?"vec3":e instanceof this.THREE.Vector4?"vec4":e instanceof this.THREE.Color?"vec3":e instanceof this.THREE.Matrix3?"mat3":e instanceof this.THREE.Matrix4?"mat4":e?.isTexture?"sampler2D":"float"}applyMaterialProperties(e,t){let i=t.properties;if(i){if(i.transparent!==void 0&&(e.transparent=i.transparent),i.side!==void 0)switch(i.side){case"front":e.side=this.THREE.FrontSide;break;case"back":e.side=this.THREE.BackSide;break;case"double":e.side=this.THREE.DoubleSide;break}if(i.depthWrite!==void 0&&(e.depthWrite=i.depthWrite),i.depthTest!==void 0&&(e.depthTest=i.depthTest),i.blending!==void 0)switch(i.blending){case"additive":e.blending=this.THREE.AdditiveBlending;break;case"subtractive":e.blending=this.THREE.SubtractiveBlending;break;case"multiply":e.blending=this.THREE.MultiplyBlending;break;default:e.blending=this.THREE.NormalBlending}i.wireframe!==void 0&&(e.wireframe=i.wireframe)}}updateUniforms(e,t,i){let r=e.userData?.shader,a=e.userData?.customUniforms;if(r?.uniforms)for(let[s,o]of Object.entries(i)){let n=t.uniforms?.[s];n&&r.uniforms[s]&&(r.uniforms[s].value=this.convertUniformValue(n.type,o))}else if(a)for(let[s,o]of Object.entries(i)){let n=t.uniforms?.[s];n&&a[s]&&(a[s].value=this.convertUniformValue(n.type,o))}if(e.uniforms)for(let[s,o]of Object.entries(i)){let n=t.uniforms?.[s];n&&e.uniforms[s]&&(e.uniforms[s].value=this.convertUniformValue(n.type,o))}}getDefaultVertexShader(){return`
      varying vec2 vUv;
      varying vec3 vNormal;
      varying vec3 vPosition;

      void main() {
        vUv = uv;
        vNormal = normalize(normalMatrix * normal);
        vPosition = (modelMatrix * vec4(position, 1.0)).xyz;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `}getDefaultFragmentShader(){return`
      varying vec2 vUv;
      varying vec3 vNormal;
      varying vec3 vPosition;

      void main() {
        gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
      }
    `}dispose(){this.textureCache.forEach(e=>e.dispose()),this.textureCache.clear()}};var Ue=class{constructor(e,t={}){this.materialFactory=null;this.particleModelCache=new Map;this.particleModelPromiseCache=new Map;this.fontCache=new Map;this.fontPromiseCache=new Map;this.fontMetricsCache=new Map;this.THREE=e,this.loaders=t,this.materialFactory=new Pe(e)}getMaterialFactory(){return this.materialFactory}createVector3(e=0,t=0,i=0){return new this.THREE.Vector3(e,t,i)}createVector2(e=0,t=0){return new this.THREE.Vector2(e,t)}createQuaternion(e=0,t=0,i=0,r=1){return new this.THREE.Quaternion(e,t,i,r)}createEuler(e=0,t=0,i=0,r="XYZ"){return new this.THREE.Euler(e,t,i,r)}createMatrix4(){return new this.THREE.Matrix4}createBox3(e,t){return new this.THREE.Box3(e,t)}createScene(){return new this.THREE.Scene}createRenderer(e){let t=new this.THREE.WebGLRenderer(e);return t.outputEncoding=this.THREE.sRGBEncoding,t}createPerspectiveCamera(e=45,t=1,i=.1,r=2e3){return new this.THREE.PerspectiveCamera(e,t,i,r)}createOrthographicCamera(e,t,i,r,a=.1,s=1e4){return new this.THREE.OrthographicCamera(e,t,i,r,a,s)}createGroup(){return new this.THREE.Group}createMesh(e,t){return new this.THREE.Mesh(e,t)}createBoxGeometry(e,t,i){return new this.THREE.BoxGeometry(e,t,i)}createSphereGeometry(e,t=32,i=32){return new this.THREE.SphereGeometry(e,t,i)}createPlaneGeometry(e,t){return new this.THREE.PlaneGeometry(e,t)}createCylinderGeometry(e,t,i,r=32){return new this.THREE.CylinderGeometry(e,t,i,r)}createMeshBasicMaterial(e){return new this.THREE.MeshBasicMaterial(e)}createMeshStandardMaterial(e){return new this.THREE.MeshStandardMaterial(e)}createShaderMaterial(e){return new this.THREE.ShaderMaterial(e)}createPointLight(e,t=1,i=0,r=2){return new this.THREE.PointLight(e,t,i,r)}createSpotLight(e,t=1,i=0,r=Math.PI/3,a=0,s=1){return new this.THREE.SpotLight(e,t,i,r,a,s)}createHemisphereLight(e,t,i=1){return new this.THREE.HemisphereLight(e,t,i)}createAmbientLight(e,t=1){return new this.THREE.AmbientLight(e,t)}createDirectionalLight(e,t=1){return new this.THREE.DirectionalLight(e,t)}createTextureLoader(){return new this.THREE.TextureLoader}createModelLoader(e){let t=this.loaders[e];if(!t)throw new Error(`[ThreeJSEngine] Model loader "${e}" not registered`);return new t}createRenderTarget(e,t,i={}){let r={minFilter:this.THREE.LinearFilter,magFilter:this.THREE.LinearFilter,format:this.THREE.RGBAFormat,depthBuffer:!0,stencilBuffer:!1};return new this.THREE.WebGLRenderTarget(e,t,{...r,...i})}loadFont(e){let t=e.trim();if(!t||t==="none")return Promise.resolve(null);if(this.fontCache.has(t))return Promise.resolve(this.fontCache.get(t));let i=this.fontPromiseCache.get(t);if(i)return i;let r=ve.isFontFile(t),a;return r?a=this.loadFontWithConverter(t):a=this.loadFontWithLoader(t),this.fontPromiseCache.set(t,a),a}async loadFontWithConverter(e){try{let t=await ve.load(e),i=this.createFontFromData(t);return this.fontCache.set(e,i),i}catch{return null}}loadFontWithLoader(e){let t=this.loaders.font||this.loaders.FontLoader;if(!t)return Promise.resolve(null);let i=new t;return new Promise(r=>{i.load(e,a=>{this.fontCache.set(e,a),r(a)},void 0,()=>{r(null)})})}createFontFromData(e){return{data:e,generateShapes:(i,r)=>this.generateShapesFromFontData(e,i,r,!1),generateNormalizedShapes:(i,r)=>this.generateShapesFromFontData(e,i,r,!0)}}generateShapesFromFontData(e,t,i,r=!1){let a=[],s=i/e.resolution,o=t[0];if(!o)return a;let n=e.glyphs[o];if(!n||!n.o)return a;let l=0;r&&(l=-this.getOutlineXMin(n.o)*s);let c=this.parseOutlineToShapes(n.o,s,l);return a.push(...c),a}getOutlineXMin(e){let t=e.split(" "),i=1/0,r=0;for(;r<t.length;)switch(t[r]){case"m":case"l":i=Math.min(i,parseFloat(t[r+1])||0),r+=3;break;case"q":i=Math.min(i,parseFloat(t[r+1])||0),i=Math.min(i,parseFloat(t[r+3])||0),r+=5;break;case"b":i=Math.min(i,parseFloat(t[r+1])||0),i=Math.min(i,parseFloat(t[r+3])||0),i=Math.min(i,parseFloat(t[r+5])||0),r+=7;break;default:r++;break}return i===1/0?0:i}getOutlineXMax(e){let t=e.split(" "),i=-1/0,r=0;for(;r<t.length;)switch(t[r]){case"m":case"l":i=Math.max(i,parseFloat(t[r+1])||0),r+=3;break;case"q":i=Math.max(i,parseFloat(t[r+1])||0),i=Math.max(i,parseFloat(t[r+3])||0),r+=5;break;case"b":i=Math.max(i,parseFloat(t[r+1])||0),i=Math.max(i,parseFloat(t[r+3])||0),i=Math.max(i,parseFloat(t[r+5])||0),r+=7;break;default:r++;break}return i===-1/0?0:i}parseOutlineToShapes(e,t,i=0){if(!e)return[];let r=new this.THREE.ShapePath,a=e.split(" "),s=0;for(;s<a.length;)switch(a[s]){case"m":{let l=parseFloat(a[s+1])*t+i,c=-parseFloat(a[s+2])*t;r.moveTo(l,c),s+=3}break;case"l":{let l=parseFloat(a[s+1])*t+i,c=-parseFloat(a[s+2])*t;r.lineTo(l,c),s+=3}break;case"q":{let l=parseFloat(a[s+3])*t+i,c=-parseFloat(a[s+4])*t;r.quadraticCurveTo(parseFloat(a[s+1])*t+i,-parseFloat(a[s+2])*t,l,c),s+=5}break;case"b":{let l=parseFloat(a[s+5])*t+i,c=-parseFloat(a[s+6])*t;r.bezierCurveTo(parseFloat(a[s+1])*t+i,-parseFloat(a[s+2])*t,parseFloat(a[s+3])*t+i,-parseFloat(a[s+4])*t,l,c),s+=7}break;case"z":typeof r.closePath=="function"?r.closePath():r.currentPath&&typeof r.currentPath.closePath=="function"&&r.currentPath.closePath(),s+=1;break;default:s++;break}return r.toShapes(!1)}reversePath(e){let t=new this.THREE.Path;if(!e.curves||e.curves.length===0)return t;let i=e.curves[e.curves.length-1],r=i.v2||i.v3||(i.getPoint?i.getPoint(1):null);r&&t.moveTo(r.x,r.y);for(let a=e.curves.length-1;a>=0;a--){let s=e.curves[a];s.isLineCurve||s.type==="LineCurve"||s.type==="LineCurve3"?t.lineTo(s.v1.x,s.v1.y):s.isQuadraticBezierCurve||s.type==="QuadraticBezierCurve"||s.type==="QuadraticBezierCurve3"?t.quadraticCurveTo(s.v1.x,s.v1.y,s.v0.x,s.v0.y):(s.isCubicBezierCurve||s.type==="CubicBezierCurve"||s.type==="CubicBezierCurve3")&&t.bezierCurveTo(s.v2.x,s.v2.y,s.v1.x,s.v1.y,s.v0.x,s.v0.y)}return t}createTextGeometry(e,t,i){if(!e||!t)return null;let r=Math.max(.001,i.size||16),a=Math.max(0,i.height||0),s=Math.max(.001,i.lineHeight||r*1.2),o=Number.isFinite(i.letterSpacing)?i.letterSpacing:0,n=i.align||"left",l=!!i.bevelEnabled,c=Math.max(0,i.bevelThickness||0),h=Math.max(0,i.bevelSize||0),u=i.bevelOffset||0,d=Math.max(0,i.bevelSegments||0),p=Math.max(1,Math.round(i.curveSegments||8)),m=String(e).split(/\r?\n/),f=[],C=t?.data,v=C?.resolution||1e3,y=C?.ascender||800,M=C?.descender||-200,P=r/v,j=y*P;if(i.layout&&i.layout.length>0?i.layout.forEach(z=>{let D=t.generateShapes(z.char,r),b=z.x,w=-z.y;D.forEach(V=>{let N=this.translateShape(V,b,w);z.scale&&z.scale!==1&&(N=this.scaleShape(N,z.scale)),f.push(N)})}):m.forEach((z,D)=>{let{shapes:b,width:w}=this.buildLineShapes(z,t,r,o),V=0;n==="center"?V=-w*.5:n==="right"&&(V=-w);let N=-D*s;b.forEach(_=>{f.push(this.translateShape(_,V,N))})}),!f.length)return null;let T=new this.THREE.ExtrudeGeometry(f,{depth:a,curveSegments:p,bevelEnabled:l,bevelThickness:c,bevelSize:h,bevelOffset:u,bevelSegments:d});return T.computeBoundingBox(),T}buildLineShapes(e,t,i,r){let a=[],s=0,o=Array.from(e);return o.forEach((n,l)=>{t.generateShapes(n,i).forEach(u=>{let d=this.translateShape(u,s,0);a.push(d)});let h=this.getGlyphAdvance(t,n,i);s+=h,r!==0&&l<o.length-1&&(s+=r)}),{shapes:a,width:s}}getGlyphAdvance(e,t,i){let r=e?.data,a=r?.glyphs||{},o=(a[t]||a[t.charCodeAt(0)]||a["?"])?.ha??r?.ha,n=r?.resolution||1e3;return typeof o=="number"?o/n*i:i*.5}translateShape(e,t,i){if(!e||!t&&!i)return e;if(typeof e.translate=="function")return e.translate(t,i),e;if(typeof e.applyMatrix4=="function"){let r=new this.THREE.Matrix4().makeTranslation(t,i,0);return e.applyMatrix4(r),e}if(typeof e.extractPoints=="function"){let{shape:r,holes:a}=e.extractPoints(12),s=n=>new this.THREE.Vector2((n.x||0)+t,(n.y||0)+i),o=new this.THREE.Shape(r.map(s));return Array.isArray(a)&&a.forEach(n=>{let l=new this.THREE.Path;l.setFromPoints(n.map(s)),o.holes.push(l)}),o}return e}scaleShape(e,t){if(t===1)return e;if(typeof e.scale=="function")return e.scale(t,t),e;if(typeof e.applyMatrix4=="function"){let i=new this.THREE.Matrix4().makeScale(t,t,1);return e.applyMatrix4(i),e}if(typeof e.extractPoints=="function"){let{shape:i,holes:r}=e.extractPoints(12),a=o=>new this.THREE.Vector2((o.x||0)*t,(o.y||0)*t),s=new this.THREE.Shape(i.map(a));return Array.isArray(r)&&r.forEach(o=>{let n=new this.THREE.Path;n.setFromPoints(o.map(a)),s.holes.push(n)}),s}return e}resolveParticleModelGeometry(e,t,i){let r=e.trim();if(!r||r==="none")return Promise.resolve(null);let a=t&&t!=="none"?t:this.loaders.gltf?"gltf":Object.keys(this.loaders)[0];if(!a)return Promise.resolve(null);let s=(i||"").trim(),o=`${a}|${r}|${s}`;if(this.particleModelCache.has(o))return Promise.resolve(this.particleModelCache.get(o));let n=this.particleModelPromiseCache.get(o);if(n)return n;let l=new Promise(c=>{let h=null;try{h=this.createModelLoader(a)}catch{c(null);return}h.load(r,u=>{let d=u?.scene||u?.object||u;if(!d){c(null);return}let p=null;if(s){if(d.getObjectByName){let f=d.getObjectByName(s);f?.isMesh&&(p=f)}!p&&d.traverse&&d.traverse(f=>{p||f?.isMesh&&f?.name===s&&(p=f)})}p||(d.isMesh?p=d:d.traverse&&d.traverse(f=>{!p&&f?.isMesh&&(p=f)}));let m=p?.geometry||null;if(!m){c(null);return}this.particleModelCache.set(o,m),c(m)},void 0,()=>{c(null)})});return this.particleModelPromiseCache.set(o,l),l}createParticleSystem(e){let t=this.THREE,i=this,r=s=>{let o=Math.max(1,s|0);return()=>(o^=o<<13,o^=o>>17,o^=o<<5,(o>>>0)%1e5/1e5)};class a extends t.Object3D{constructor(n){super();this.rng=r(e.seed);this.points=null;this.instanced=null;this.positions=new Float32Array(0);this.velocities=new Float32Array(0);this.life=new Float32Array(0);this.colors=new Float32Array(0);this.sizeFactors=new Float32Array(0);this.alive=0;this.emitRemainder=0;this.pendingBurst=0;this.basePositions=new Float32Array(0);this.baseScales=new Float32Array(0);this.baseJitter=new Float32Array(0);this.basePhase=new Float32Array(0);this.elapsed=0;this.modelGeometry=null;this.modelKey="";this.instancedUsesSharedGeometry=!1;this.distributionGeometry=null;this.distributionKey="";this.materialOverride=null;this.materialOverrideForPoints=null;this.defaultEmitterMaterial=null;this.defaultInstancedMaterial=null;this.transitionStartTime=0;this.transitionDuration=0;this.isTransitioning=!1;this.transitionFromPositions=new Float32Array(0);this.transitionToPositions=new Float32Array(0);this.pendingTransition=!1;this.pendingTransitionKey="";this.pendingDistributionLoad=!1;this.cfg={...n},this.refreshModelGeometry(),this.rebuild()}setConfig(n){let l=this.cfg;this.cfg={...n};let c=this.cfg.mode==="emitter"&&(l.emitRate!==this.cfg.emitRate||l.emitBurst!==this.cfg.emitBurst||l.particleLife!==this.cfg.particleLife||l.particleSpeed!==this.cfg.particleSpeed||!this.isVec3Equal(l.particleDirection,this.cfg.particleDirection)||!this.isVec3Equal(l.particleGravity,this.cfg.particleGravity)||l.particleDrag!==this.cfg.particleDrag||l.particleSizeVariation!==this.cfg.particleSizeVariation||l.particleColorVariation!==this.cfg.particleColorVariation||l.color!==this.cfg.color);if(l.mode!==this.cfg.mode||l.count!==this.cfg.count||l.seed!==this.cfg.seed||l.spread!==this.cfg.spread||l.particleShape!==this.cfg.particleShape||l.particleModelUrl!==this.cfg.particleModelUrl||l.particleModelLoader!==this.cfg.particleModelLoader||l.particleModelNode!==this.cfg.particleModelNode||l.instanceShape!==this.cfg.instanceShape||l.instanceModelUrl!==this.cfg.instanceModelUrl||l.instanceModelLoader!==this.cfg.instanceModelLoader||l.instanceModelNode!==this.cfg.instanceModelNode||l.instanceScale!==this.cfg.instanceScale||l.instanceScaleVariation!==this.cfg.instanceScaleVariation){let u=this.cfg.mode==="instanced"&&this.instanced&&this.cfg.modelTransitionDuration>0&&(l.particleModelUrl!==this.cfg.particleModelUrl||l.particleModelLoader!==this.cfg.particleModelLoader||l.particleModelNode!==this.cfg.particleModelNode||l.particleShape!==this.cfg.particleShape),d=this.cfg.mode==="instanced"&&this.instanced&&this.cfg.modelTransitionDuration>0&&(l.instanceModelUrl!==this.cfg.instanceModelUrl||l.instanceModelLoader!==this.cfg.instanceModelLoader||l.instanceModelNode!==this.cfg.instanceModelNode||l.instanceShape!==this.cfg.instanceShape);u||d?this.startModelTransition():(this.refreshModelGeometry(),this.refreshDistributionGeometry(),this.rebuild());return}if(c&&this.resetEmitter(),this.points){let u=this.points.material.uniforms;u&&(u.uOpacity&&(u.uOpacity.value=this.cfg.opacity),u.uSize&&(u.uSize.value=this.cfg.size),u.uSizeVar&&(u.uSizeVar.value=this.cfg.particleSizeVariation),u.uPointSize&&(u.uPointSize.value=this.cfg.size))}this.instanced&&(this.instanced.material.opacity=this.cfg.opacity,this.instanced.material.color=new t.Color(this.cfg.color)),this.pendingBurst=this.cfg.emitBurst}startModelTransition(){this.transitionFromPositions=new Float32Array(this.basePositions),this.transitionDuration=this.cfg.modelTransitionDuration;let n=this.cfg.instanceModelUrl?.trim(),l=`${this.cfg.instanceModelLoader}|${n}|${this.cfg.instanceModelNode}`;this.pendingTransition=!0,this.pendingTransitionKey=l,this.refreshModelGeometry(),this.refreshDistributionGeometryForTransition()}refreshDistributionGeometryForTransition(){if(this.cfg.instanceShape!=="model"){this.startMorphTransition();return}let n=this.cfg.instanceModelUrl?.trim();if(!n||n==="none"){this.startMorphTransition();return}let l=`${this.cfg.instanceModelLoader}|${n}|${this.cfg.instanceModelNode}`;if(this.distributionKey===l&&this.distributionGeometry){this.startMorphTransition();return}this.distributionKey=l,i.resolveParticleModelGeometry(n,this.cfg.instanceModelLoader,this.cfg.instanceModelNode).then(c=>{c&&this.distributionKey===l&&(!this.pendingTransition||this.pendingTransitionKey!==l||(this.distributionGeometry=c,this.startMorphTransition()))})}startMorphTransition(){this.pendingTransition=!1,this.pendingTransitionKey="";let n=Math.max(1,this.cfg.count);if(this.transitionToPositions=new Float32Array(n*3),this.cfg.instanceShape==="model"&&this.distributionGeometry)this.fillFromModelToArray(n,this.distributionGeometry,this.transitionToPositions);else for(let c=0;c<n;c+=1){let h=this.cfg.instanceShape==="box"?this.randomInBox(this.cfg.spread):this.randomInSphere(this.cfg.spread);this.transitionToPositions.set(h,c*3)}this.transitionStartTime=this.elapsed,this.isTransitioning=!0}cleanupOutgoing(){this.isTransitioning=!1,this.pendingTransition=!1,this.pendingTransitionKey="",this.transitionFromPositions=new Float32Array(0),this.transitionToPositions=new Float32Array(0)}updateTransition(){if(!this.isTransitioning)return;let n=this.elapsed-this.transitionStartTime,l=Math.min(1,n/this.transitionDuration),c=l<.5?2*l*l:1-Math.pow(-2*l+2,2)/2,h=Math.min(this.transitionFromPositions.length/3,this.transitionToPositions.length/3,this.basePositions.length/3);for(let u=0;u<h;u+=1){let d=u*3;this.basePositions[d]=this.transitionFromPositions[d]+(this.transitionToPositions[d]-this.transitionFromPositions[d])*c,this.basePositions[d+1]=this.transitionFromPositions[d+1]+(this.transitionToPositions[d+1]-this.transitionFromPositions[d+1])*c,this.basePositions[d+2]=this.transitionFromPositions[d+2]+(this.transitionToPositions[d+2]-this.transitionFromPositions[d+2])*c}if(l>=1){for(let u=0;u<h*3;u+=1)this.basePositions[u]=this.transitionToPositions[u];this.cleanupOutgoing()}}fillFromModelToArray(n,l,c){let h=l?.attributes?.position;if(!h?.array||h.itemSize<3){for(let S=0;S<n;S+=1){let L=this.randomInSphere(this.cfg.spread);c.set(L,S*3)}return}let u=h.array,d=h.itemSize,p=Math.floor(u.length/d);if(p<=0)return;let m=l?.index?.array,f=Math.floor(m?m.length/3:p/3);if(f<=0)return;let C=1/0,v=1/0,y=1/0,M=-1/0,P=-1/0,j=-1/0;for(let S=0;S<p;S+=1){let L=S*d,E=u[L],R=u[L+1],I=u[L+2];C=Math.min(C,E),v=Math.min(v,R),y=Math.min(y,I),M=Math.max(M,E),P=Math.max(P,R),j=Math.max(j,I)}let T=Math.max(1e-6,M-C),z=Math.max(1e-6,P-v),D=Math.max(1e-6,j-y),b=(this.cfg.spreadX>0?this.cfg.spreadX:this.cfg.spread)*2,w=(this.cfg.spreadY>0?this.cfg.spreadY:this.cfg.spread)*2,V=b>0?b/T:1,N=w>0?w/z:1,_=Math.min(V,N),H=(C+M)*.5,U=(v+P)*.5,k=(y+j)*.5,B=new Float32Array(f),x=0;for(let S=0;S<f;S+=1){let L=S*3,E=m?m[L]:L,R=m?m[L+1]:L+1,I=m?m[L+2]:L+2,Z=E*d,q=R*d,Y=I*d,K=u[Z],X=u[Z+1],ae=u[Z+2],se=u[q],fe=u[q+1],ge=u[q+2],ye=u[Y],W=u[Y+1],$=u[Y+2],ee=se-K,Q=fe-X,oe=ge-ae,he=ye-K,le=W-X,te=$-ae,ie=Q*te-oe*le,re=oe*he-ee*te,de=ee*le-Q*he,Ee=Math.sqrt(ie*ie+re*re+de*de)*.5;x+=Ee,B[S]=x}if(x<=0){for(let S=0;S<n;S+=1){let L=this.randomInSphere(this.cfg.spread);c.set(L,S*3)}return}for(let S=0;S<n;S+=1){let L=this.rng()*x,E=0,R=f-1;for(;E<R;){let Ge=Math.floor((E+R)/2);L<=B[Ge]?R=Ge:E=Ge+1}let I=E*3,Z=m?m[I]:I,q=m?m[I+1]:I+1,Y=m?m[I+2]:I+2,K=Z*d,X=q*d,ae=Y*d,se=u[K],fe=u[K+1],ge=u[K+2],ye=u[X],W=u[X+1],$=u[X+2],ee=u[ae],Q=u[ae+1],oe=u[ae+2],he=this.rng(),le=this.rng(),te=Math.sqrt(he),ie=1-te,re=te*(1-le),de=te*le,Ee=(se*ie+ye*re+ee*de-H)*_,We=(fe*ie+W*re+Q*de-U)*_,Fe=(ge*ie+$*re+oe*de-k)*_;c[S*3]=Ee,c[S*3+1]=We,c[S*3+2]=Fe}}update(n){n<=0||(this.elapsed+=n,this.updateTransition(),this.cfg.mode==="emitter"?this.updateEmitter(n):this.updateInstanced(this.elapsed))}dispose(){this.cleanupOutgoing(),this.points&&(this.points.geometry.dispose(),this.points.material.dispose()),this.instanced&&(this.instancedUsesSharedGeometry||this.instanced.geometry.dispose(),this.instanced.material.dispose())}rebuild(){if(this.points&&(this.remove(this.points),this.points.geometry.dispose(),this.points.material.dispose(),this.points=null),this.instanced&&(this.remove(this.instanced),this.instancedUsesSharedGeometry||this.instanced.geometry.dispose(),this.instanced.material.dispose(),this.instanced=null),this.elapsed=0,this.cfg.mode==="emitter")this.buildEmitter();else{let n=this.cfg.instanceShape==="model",l=this.distributionGeometry!==null;if(n&&!l){this.pendingDistributionLoad=!0,this.refreshDistributionGeometry();return}this.pendingDistributionLoad=!1,this.refreshDistributionGeometry(),this.buildInstanced()}this.applyMaterialOverrides()}buildEmitter(){let n=Math.max(1,this.cfg.count);this.positions=new Float32Array(n*3),this.velocities=new Float32Array(n*3),this.life=new Float32Array(n),this.colors=new Float32Array(n*3),this.sizeFactors=new Float32Array(n);let l=1e6;for(let u=0;u<n;u+=1){let d=u*3;this.positions[d]=l,this.positions[d+1]=l,this.positions[d+2]=l}this.alive=0,this.emitRemainder=0,this.pendingBurst=this.cfg.emitBurst;let c=new t.BufferGeometry;c.setAttribute("position",new t.BufferAttribute(this.positions,3)),c.setAttribute("color",new t.BufferAttribute(this.colors,3)),c.setAttribute("sizeFactor",new t.BufferAttribute(this.sizeFactors,1));let h=new t.ShaderMaterial({transparent:this.cfg.opacity<1,depthWrite:!1,uniforms:{uOpacity:{value:this.cfg.opacity},uSize:{value:this.cfg.size},uSizeVar:{value:this.cfg.particleSizeVariation}},vertexShader:`
            attribute vec3 color;
            attribute float sizeFactor;
            varying vec3 vColor;
            uniform float uSize;
            uniform float uSizeVar;
            void main() {
              vColor = color;
              float size = uSize * mix(1.0 - uSizeVar, 1.0, sizeFactor);
              gl_PointSize = size;
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,fragmentShader:`
            varying vec3 vColor;
            uniform float uOpacity;
            void main() {
              float dist = length(gl_PointCoord - vec2(0.5));
              if (dist > 0.5) discard;
              gl_FragColor = vec4(vColor, uOpacity);
            }
          `});this.points=new t.Points(c,h),this.defaultEmitterMaterial=h,this.add(this.points)}buildInstanced(){let n=Math.max(1,this.cfg.count),l=this.cfg.particleShape==="model"&&this.modelGeometry,c=this.cfg.particleShape==="model"&&this.modelGeometry?this.modelGeometry:this.cfg.particleShape==="box"?new t.BoxGeometry(1,1,1):new t.SphereGeometry(.5,8,8);this.instancedUsesSharedGeometry=l;let h=new t.MeshStandardMaterial({color:new t.Color(this.cfg.color),transparent:this.cfg.opacity<1,opacity:this.cfg.opacity});this.defaultInstancedMaterial=h,this.instanced=new t.InstancedMesh(c,h,n),this.basePositions=new Float32Array(n*3),this.baseScales=new Float32Array(n),this.baseJitter=new Float32Array(n*3),this.basePhase=new Float32Array(n),this.fillBasePositions(n),this.applyInstancedTransforms(0),this.add(this.instanced)}setMaterial(n,l={}){let c=l.points??!0;(l.meshes??!0)&&(this.materialOverride=n),c&&(this.materialOverrideForPoints=n),this.applyMaterialOverrides()}updateEmitter(n){let l=this.cfg.count,c=this.normalize(this.cfg.particleDirection),h=this.cfg.particleGravity,u=Math.max(0,Math.min(1,this.cfg.particleDrag)),p=this.cfg.emitRate*n+this.emitRemainder,m=Math.floor(p);this.emitRemainder=p-m;let f=!1,C=1e6;for(let v=0;v<m;v+=1)this.spawnParticle(c);for(;this.pendingBurst>0;)this.spawnParticle(c),this.pendingBurst-=1;for(let v=0;v<l;v+=1){if(this.life[v]<=0)continue;if(this.life[v]-=n,this.life[v]<=0){this.life[v]=0;let M=v*3;this.positions[M]=C,this.positions[M+1]=C,this.positions[M+2]=C,this.colors[M]=0,this.colors[M+1]=0,this.colors[M+2]=0,f=!0;continue}let y=v*3;this.velocities[y]+=h[0]*n,this.velocities[y+1]+=h[1]*n,this.velocities[y+2]+=h[2]*n,this.velocities[y]*=1-u*n,this.velocities[y+1]*=1-u*n,this.velocities[y+2]*=1-u*n,this.positions[y]+=this.velocities[y]*n,this.positions[y+1]+=this.velocities[y+1]*n,this.positions[y+2]+=this.velocities[y+2]*n}this.points&&(this.points.geometry.attributes.position.needsUpdate=!0,f&&(this.points.geometry.attributes.color.needsUpdate=!0))}spawnParticle(n){let l=this.cfg.count,c=-1;for(let f=0;f<l;f+=1)if(this.life[f]<=0){c=f;break}if(c===-1)return;let h=this.randomInSphere(this.cfg.spread),u=this.cfg.particleSpeed*(1-this.cfg.particleSizeVariation+this.rng()*this.cfg.particleSizeVariation),d=[n[0]*u+(this.rng()-.5)*u*.2,n[1]*u+(this.rng()-.5)*u*.2,n[2]*u+(this.rng()-.5)*u*.2],p=c*3;this.positions.set(h,p),this.velocities.set(d,p),this.life[c]=this.cfg.particleLife,this.sizeFactors[c]=this.rng();let m=new t.Color(this.cfg.color);this.cfg.particleColorVariation>0&&m.offsetHSL((this.rng()-.5)*this.cfg.particleColorVariation,0,0),this.colors[p]=m.r,this.colors[p+1]=m.g,this.colors[p+2]=m.b,this.points&&(this.points.geometry.attributes.color.needsUpdate=!0,this.points.geometry.attributes.sizeFactor.needsUpdate=!0)}updateInstanced(n){this.applyInstancedTransforms(n),this.instanced&&(this.instanced.instanceMatrix.needsUpdate=!0)}applyInstancedTransforms(n){if(!this.instanced)return;let l=this.cfg.count,c=this.cfg.instanceJitter,h=this.cfg.instanceFlow,u=Math.max(0,this.cfg.instanceDisperse),d=Math.max(0,this.cfg.instanceDisperseScatter),p=this.cfg.instanceDisperseScatterX>0?this.cfg.instanceDisperseScatterX:d,m=this.cfg.instanceDisperseScatterY>0?this.cfg.instanceDisperseScatterY:d,f=this.cfg.instanceDisperseScatterZ>0?this.cfg.instanceDisperseScatterZ:d,C=this.cfg.instanceRotationSpeed,v=new t.Object3D;for(let y=0;y<l;y+=1){let M=y*3,P=this.basePositions[M],j=this.basePositions[M+1],T=this.basePositions[M+2],z=this.basePhase[y],D=Math.sin((j+n*1.4)*.7+z)*h*this.cfg.spread,b=Math.cos((P-n*1.1)*.6+z)*h*this.cfg.spread,w=Math.sin((T+n*1.2)*.8+z)*h*this.cfg.spread,V=Math.sin(n*2.1+z+this.baseJitter[M]*2.5)*c,N=Math.cos(n*1.7+z+this.baseJitter[M+1]*2.5)*c,_=Math.sin(n*1.9+z+this.baseJitter[M+2]*2.5)*c,H=1+u,U=this.baseJitter[M],k=this.baseJitter[M+1],B=this.baseJitter[M+2],x=Math.sqrt(U*U+k*k+B*B)||1,S=u*this.cfg.spread,L=U/x*p*S,E=k/x*m*S,R=B/x*f*S;v.position.set(P*H+L+D+V,j*H+E+b+N,T*H+R+w+_),v.rotation.set(this.baseJitter[M]*.5,n*C+y*.1,this.baseJitter[M+2]*.5);let I=this.baseScales[y]*this.cfg.size;v.scale.set(I,I,I),v.updateMatrix(),this.instanced.setMatrixAt(y,v.matrix)}}applyMaterialOverrides(){if(this.points){let n=this.materialOverrideForPoints||this.defaultEmitterMaterial;n&&this.points.material!==n&&(this.points.material=n,this.ensurePointMaterial(n))}if(this.instanced){let n=this.materialOverride||this.defaultInstancedMaterial;n&&this.instanced.material!==n&&(this.instanced.material=n)}}ensurePointMaterial(n){n?.isShaderMaterial&&(n.uniforms||(n.uniforms={}),n.uniforms.uPointSize||(n.uniforms.uPointSize={value:this.cfg.size}),n.uniforms.uOpacity||(n.uniforms.uOpacity={value:this.cfg.opacity}),n.vertexShader.includes("gl_PointSize")||(n.vertexShader.includes("uPointSize")||(n.vertexShader=`uniform float uPointSize;
${n.vertexShader}`),n.vertexShader=n.vertexShader.replace(/void\\s+main\\s*\\(\\)\\s*\\{/,"void main() {\\n  gl_PointSize = uPointSize;"),n.needsUpdate=!0))}refreshModelGeometry(){if(this.cfg.particleShape!=="model"){this.modelGeometry=null,this.modelKey="";return}let n=this.cfg.particleModelUrl?.trim();if(!n||n==="none"){this.modelGeometry=null,this.modelKey="";return}let l=`${this.cfg.particleModelLoader}|${n}|${this.cfg.particleModelNode}`;this.modelKey===l&&this.modelGeometry||(this.modelKey=l,i.resolveParticleModelGeometry(n,this.cfg.particleModelLoader,this.cfg.particleModelNode).then(c=>{c&&this.modelKey===l&&(this.modelGeometry=c,this.cfg.mode==="instanced"&&this.cfg.particleShape==="model"&&this.rebuild())}))}refreshDistributionGeometry(){if(this.cfg.instanceShape!=="model"){this.distributionGeometry=null,this.distributionKey="";return}let n=this.cfg.instanceModelUrl?.trim();if(!n||n==="none"){this.distributionGeometry=null,this.distributionKey="";return}let l=`${this.cfg.instanceModelLoader}|${n}|${this.cfg.instanceModelNode}`;this.distributionKey===l&&this.distributionGeometry||(this.distributionKey=l,i.resolveParticleModelGeometry(n,this.cfg.instanceModelLoader,this.cfg.instanceModelNode).then(c=>{c&&this.distributionKey===l&&(this.distributionGeometry=c,this.cfg.mode==="instanced"&&this.cfg.instanceShape==="model"&&(this.pendingDistributionLoad?(this.pendingDistributionLoad=!1,this.buildInstanced(),this.applyMaterialOverrides()):this.rebuild()))}))}fillBasePositions(n){if(this.cfg.instanceShape==="model"&&this.distributionGeometry)this.fillFromModel(n,this.distributionGeometry);else for(let c=0;c<n;c+=1){let h=this.cfg.instanceShape==="box"?this.randomInBox(this.cfg.spread):this.randomInSphere(this.cfg.spread);this.basePositions.set(h,c*3)}for(let c=0;c<n;c+=1){let h=c*3;this.baseJitter[h]=this.rng()*2-1,this.baseJitter[h+1]=this.rng()*2-1,this.baseJitter[h+2]=this.rng()*2-1,this.basePhase[c]=this.rng()*Math.PI*2;let u=this.cfg.instanceScale*(1-this.cfg.instanceScaleVariation+this.rng()*this.cfg.instanceScaleVariation);this.baseScales[c]=u}}fillFromModel(n,l){let c=l?.attributes?.position;if(!c?.array||c.itemSize<3){for(let x=0;x<n;x+=1){let S=this.randomInSphere(this.cfg.spread);this.basePositions.set(S,x*3)}return}let h=c.array,u=c.itemSize,d=Math.floor(h.length/u);if(d<=0)return;let p=l?.index?.array,m=Math.floor(p?p.length/3:d/3);if(m<=0)return;let f=1/0,C=1/0,v=1/0,y=-1/0,M=-1/0,P=-1/0;for(let x=0;x<d;x+=1){let S=x*u,L=h[S],E=h[S+1],R=h[S+2];f=Math.min(f,L),C=Math.min(C,E),v=Math.min(v,R),y=Math.max(y,L),M=Math.max(M,E),P=Math.max(P,R)}let j=Math.max(1e-6,y-f),T=Math.max(1e-6,M-C),z=Math.max(1e-6,P-v),D=(this.cfg.spreadX>0?this.cfg.spreadX:this.cfg.spread)*2,b=(this.cfg.spreadY>0?this.cfg.spreadY:this.cfg.spread)*2,w=D>0?D/j:1,V=b>0?b/T:1,N=Math.min(w,V),_=(f+y)*.5,H=(C+M)*.5,U=(v+P)*.5,k=new Float32Array(m),B=0;for(let x=0;x<m;x+=1){let S=x*3,L=p?p[S]:S,E=p?p[S+1]:S+1,R=p?p[S+2]:S+2,I=L*u,Z=E*u,q=R*u,Y=h[I],K=h[I+1],X=h[I+2],ae=h[Z],se=h[Z+1],fe=h[Z+2],ge=h[q],ye=h[q+1],W=h[q+2],$=ae-Y,ee=se-K,Q=fe-X,oe=ge-Y,he=ye-K,le=W-X,te=ee*le-Q*he,ie=Q*oe-$*le,re=$*he-ee*oe,de=Math.sqrt(te*te+ie*ie+re*re)*.5;B+=de,k[x]=B}if(B<=0){for(let x=0;x<n;x+=1){let S=this.randomInSphere(this.cfg.spread);this.basePositions.set(S,x*3)}return}for(let x=0;x<n;x+=1){let S=this.rng()*B,L=0,E=m-1;for(;L<E;){let Fe=Math.floor((L+E)/2);S<=k[Fe]?E=Fe:L=Fe+1}let R=L*3,I=p?p[R]:R,Z=p?p[R+1]:R+1,q=p?p[R+2]:R+2,Y=I*u,K=Z*u,X=q*u,ae=h[Y],se=h[Y+1],fe=h[Y+2],ge=h[K],ye=h[K+1],W=h[K+2],$=h[X],ee=h[X+1],Q=h[X+2],oe=this.rng(),he=this.rng(),le=Math.sqrt(oe),te=1-le,ie=le*(1-he),re=le*he,de=(ae*te+ge*ie+$*re-_)*N,Ee=(se*te+ye*ie+ee*re-H)*N,We=(fe*te+W*ie+Q*re-U)*N;this.basePositions[x*3]=de,this.basePositions[x*3+1]=Ee,this.basePositions[x*3+2]=We}}resetEmitter(){if(!this.points)return;let n=1e6;for(let l=0;l<this.positions.length;l+=3)this.positions[l]=n,this.positions[l+1]=n,this.positions[l+2]=n;this.velocities.fill(0),this.life.fill(0),this.colors.fill(0),this.sizeFactors.fill(0),this.alive=0,this.emitRemainder=0,this.pendingBurst=this.cfg.emitBurst,this.points.geometry.attributes.position.needsUpdate=!0,this.points.geometry.attributes.color.needsUpdate=!0,this.points.geometry.attributes.sizeFactor.needsUpdate=!0}normalize(n){let l=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2])||1;return[n[0]/l,n[1]/l,n[2]/l]}isVec3Equal(n,l){return n[0]===l[0]&&n[1]===l[1]&&n[2]===l[2]}randomInSphere(n){let l=this.rng(),c=this.rng(),h=l*Math.PI*2,u=Math.acos(2*c-1),d=Math.cbrt(this.rng())*n;return[d*Math.sin(u)*Math.cos(h),d*Math.sin(u)*Math.sin(h),d*Math.cos(u)]}randomInBox(n){let l=n*.5;return[(this.rng()*2-1)*l,(this.rng()*2-1)*l,(this.rng()*2-1)*l]}}return new a(e)}simplifyGeometry(e,t){let i=this.THREE?.SimplifyModifier;if(!i)return null;let r=e,a=r?.attributes?.position?.count;if(!Number.isFinite(a))return null;let s=Math.max(.05,Math.min(1,t)),o=Math.max(3,Math.floor(a*s));if(o>=a)return e;try{return new i().modify(r,o)}catch{return null}}degToRad(e){return this.THREE.MathUtils.degToRad(e)}radToDeg(e){return this.THREE.MathUtils.radToDeg(e)}computeBoundingBoxRecursively(e){let t=new this.THREE.Box3,i=!1;return e.traverse&&e.traverse(r=>{if(r.visible&&r.geometry){typeof r.geometry.computeBoundingBox=="function"&&r.geometry.computeBoundingBox();let a=r.geometry.boundingBox;if(a){let s=a.clone().applyMatrix4(r.matrixWorld);t.union(s),i=!0}}}),i?t:new this.THREE.Box3}},it=class{constructor(e,t={}){this.engine=new Ue(e,t)}getEngine(){return this.engine}getName(){return"Three.js"}};export{ve as FontConverter,tt as String3D,Te as String3DCamera,Se as String3DCustomFilterRegistry,pe as String3DCustomMaterialRegistry,ce as String3DFontRegistry,ne as String3DObject,Ie as String3DRenderer,Le as String3DScene,Oe as String3DSynchronizer,Ue as ThreeJSEngine,Pe as ThreeJSMaterialFactory,it as ThreeJSProvider};
//# sourceMappingURL=index.mjs.map