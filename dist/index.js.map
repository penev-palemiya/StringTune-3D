{"version":3,"sources":["../src/index.ts","../node_modules/@fiddle-digital/string-tune/src/core/controllers/CursorController.ts","../node_modules/@fiddle-digital/string-tune/src/core/managers/EventManager.ts","../node_modules/@fiddle-digital/string-tune/src/core/managers/ModuleManager.ts","../node_modules/@fiddle-digital/string-tune/src/objects/StringMirrorObject.ts","../node_modules/@fiddle-digital/string-tune/src/objects/StringObject.ts","../node_modules/@fiddle-digital/string-tune/src/core/managers/ObjectManager.ts","../node_modules/@fiddle-digital/string-tune/src/core/controllers/ScrollController.ts","../node_modules/@fiddle-digital/string-tune/src/core/controllers/StringScrollDefault.ts","../node_modules/@fiddle-digital/string-tune/src/core/controllers/StringScrollDisable.ts","../node_modules/@fiddle-digital/string-tune/src/models/scroll/ScrollHTMLClass.ts","../node_modules/@fiddle-digital/string-tune/src/core/controllers/StringScrollSmooth.ts","../node_modules/@fiddle-digital/string-tune/src/core/managers/ScrollManager.ts","../node_modules/@fiddle-digital/string-tune/src/states/CursorState.ts","../node_modules/@fiddle-digital/string-tune/src/states/RenderState.ts","../node_modules/@fiddle-digital/string-tune/src/states/ScrollState.ts","../node_modules/@fiddle-digital/string-tune/src/states/SystemState.ts","../node_modules/@fiddle-digital/string-tune/src/states/TimeState.ts","../node_modules/@fiddle-digital/string-tune/src/states/ViewportState.ts","../node_modules/@fiddle-digital/string-tune/src/core/StringData.ts","../node_modules/@fiddle-digital/string-tune/src/models/IModuleLifecyclePermissions.ts","../node_modules/@fiddle-digital/string-tune/src/core/StringModule.ts","../node_modules/@fiddle-digital/string-tune/src/tools/BoundingClientRectTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/DOMAttributeTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/RecordAttributeTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/TransformNullifyTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/RelativePositionTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/LerpTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/UnitParserTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/AdaptiveLerpTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/OriginParserTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/ColorParserTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/EasingFunctionTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/MagneticPullTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/LerpColorTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/LerpVector2Tool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/TransformScaleParserTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/SplitOptionsParserTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/RuleParserTool.ts","../node_modules/@fiddle-digital/string-tune/src/tools/ValidationTool.ts","../node_modules/@fiddle-digital/string-tune/src/core/StringToolsContainer.ts","../node_modules/@fiddle-digital/string-tune/src/utils/isCoarsePointer.ts","../node_modules/@fiddle-digital/string-tune/src/utils/style-txn.ts","../node_modules/@fiddle-digital/string-tune/src/modules/cursor/StringCursor.ts","../node_modules/@fiddle-digital/string-tune/src/modules/cursor/StringImpulse.ts","../node_modules/@fiddle-digital/string-tune/src/modules/cursor/StringMagnetic.ts","../node_modules/@fiddle-digital/string-tune/src/utils/frame-dom.ts","../node_modules/@fiddle-digital/string-tune/src/modules/cursor/CursorReactiveModule.ts","../node_modules/@fiddle-digital/string-tune/src/modules/cursor/StringSpotlight.ts","../node_modules/@fiddle-digital/string-tune/src/modules/loading/StringLazy.ts","../node_modules/@fiddle-digital/string-tune/src/modules/loading/StringLoading.ts","../node_modules/@fiddle-digital/string-tune/src/modules/screen/StringInview.ts","../node_modules/@fiddle-digital/string-tune/src/modules/screen/StringResponsive.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scroll/StringAnchor.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scroll/StringGlide.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scroll/StringLerp.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scroll/StringProgress.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scroll/StringParallax.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scrollbar/StringScrollbarHorizontal.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scrollbar/StringScrollbarVertical.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scrollbar/StringScrollbar.ts","../node_modules/@fiddle-digital/string-tune/src/models/text/SplitElementClass.ts","../node_modules/@fiddle-digital/string-tune/src/utils/text/BuildDOMTree.ts","../node_modules/@fiddle-digital/string-tune/src/utils/text/BuildTokens.ts","../node_modules/@fiddle-digital/string-tune/src/utils/text/CanvasKerningApplier.ts","../node_modules/@fiddle-digital/string-tune/src/utils/text/LayoutMeasurer.ts","../node_modules/@fiddle-digital/string-tune/src/utils/text/SplitMeasuredTokens.ts","../node_modules/@fiddle-digital/string-tune/src/modules/text/StringSplit.ts","../node_modules/@fiddle-digital/string-tune/src/modules/tracker/StringDelayLerpTracker.ts","../node_modules/@fiddle-digital/string-tune/src/modules/tracker/StringFPSTracker.ts","../node_modules/@fiddle-digital/string-tune/src/modules/tracker/StringLerpTracker.ts","../node_modules/@fiddle-digital/string-tune/src/modules/tracker/StringPositionTracker.ts","../node_modules/@fiddle-digital/string-tune/src/utils/Debounce.ts","../node_modules/@fiddle-digital/string-tune/src/utils/StringFPS.ts","../node_modules/@fiddle-digital/string-tune/src/modules/loading/StringVideoAutoplay.ts","../node_modules/@fiddle-digital/string-tune/src/models/slider/SequenceState.ts","../node_modules/@fiddle-digital/string-tune/src/modules/slider/StringSequence.ts","../node_modules/@fiddle-digital/string-tune/src/modules/input/StringForm.ts","../node_modules/@fiddle-digital/string-tune/src/core/managers/CenterCache.ts","../node_modules/@fiddle-digital/string-tune/src/core/managers/HoverTracker.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scroll/StringScroller.ts","../node_modules/@fiddle-digital/string-tune/src/utils/ParsePartOf.ts","../node_modules/@fiddle-digital/string-tune/src/modules/scroll/StringProgressPart.ts","../node_modules/@fiddle-digital/string-tune/src/index.ts","../src/core/String3DCamera.ts","../src/core/filters/String3DCustomFilter.ts","../src/core/filters/String3DFilterPipeline.ts","../src/core/String3DRenderer.ts","../src/core/String3DObject.ts","../src/modules/string3d/styleUtils.ts","../src/core/materials/String3DCustomMaterial.ts","../src/core/materials/MaterialFactory.ts","../src/core/String3DScene.ts","../src/core/synchronizer/StyleBundleCache.ts","../src/core/synchronizer/GroupSynchronizer.ts","../src/core/synchronizer/LightSynchronizer.ts","../src/core/synchronizer/MeshSynchronizer.ts","../src/core/synchronizer/ParticlesSynchronizer.ts","../src/core/text/String3DFontRegistry.ts","../src/core/text/FontConverter.ts","../src/core/synchronizer/TextSynchronizer.ts","../src/core/synchronizer/String3DSynchronizer.ts","../src/modules/string3d/DirtySyncManager.ts","../src/modules/string3d/FilterController.ts","../src/modules/String3D.ts","../src/adapters/ThreeJSMaterialFactory.ts","../src/adapters/ThreeJSProvider.ts"],"sourcesContent":["export { String3D } from \"./modules/String3D\";\r\nexport type { String3DOptions } from \"./modules/String3D\";\r\n\r\nexport type {\r\n  I3DEngine,\r\n  I3DVector3,\r\n  I3DVector2,\r\n  I3DQuaternion,\r\n  I3DEuler,\r\n  I3DMatrix4,\r\n  I3DBox3,\r\n  I3DObject,\r\n  I3DMesh,\r\n  I3DGeometry,\r\n  I3DMaterial,\r\n  I3DRenderTarget,\r\n  I3DLight,\r\n  I3DParticleSystem,\r\n  ParticleSystemConfig,\r\n  ParticleMode,\r\n  I3DCamera,\r\n  I3DPerspectiveCamera,\r\n  I3DOrthographicCamera,\r\n  I3DScene,\r\n  I3DRenderer,\r\n  I3DTextureLoader,\r\n  I3DModelLoader,\r\n} from \"./core/abstractions/I3DEngine\";\r\n\r\nexport type { CameraMode } from \"./core/String3DCamera\";\r\nexport type { I3DEngineProvider } from \"./core/abstractions/I3DEngineProvider\";\r\n\r\nexport { String3DCamera } from \"./core/String3DCamera\";\r\nexport { String3DRenderer } from \"./core/String3DRenderer\";\r\nexport { String3DScene } from \"./core/String3DScene\";\r\nexport { String3DObject } from \"./core/String3DObject\";\r\nexport { String3DSynchronizer } from \"./core/synchronizer/String3DSynchronizer\";\r\nexport {\r\n  String3DCustomFilterRegistry,\r\n  type String3DCustomFilterDefinition,\r\n} from \"./core/filters/String3DCustomFilter\";\r\n\r\nexport {\r\n  String3DCustomMaterialRegistry,\r\n  type String3DCustomMaterialDefinition,\r\n  type UniformType,\r\n  type UniformDefinition,\r\n  type ShaderInjection,\r\n  type ShaderInjectionPoint,\r\n  type MaterialBlendMode,\r\n  type MaterialSide,\r\n  type IMaterialInstance,\r\n  type IMaterialFactory,\r\n} from \"./core/materials\";\r\nexport {\r\n  String3DFontRegistry,\r\n  type String3DFontEntry,\r\n  FontConverter,\r\n  type FontData,\r\n  type FontSource,\r\n} from \"./core/text\";\r\n\r\nexport { ThreeJSProvider, ThreeJSEngine } from \"./adapters/ThreeJSProvider\";\r\nexport { ThreeJSMaterialFactory } from \"./adapters/ThreeJSMaterialFactory\";\r\n","import { ISettingsChangeData } from \"../../models/event/ISettingsChangeData\";\r\nimport { CursorState } from \"../../states/CursorState\";\r\nimport { EventManager } from \"../managers/EventManager\";\r\nimport { StringContext } from \"../StringContext\";\r\nimport { StringData } from \"../StringData\";\r\nimport { StringToolsContainer } from \"../StringToolsContainer\";\r\n\r\n/**\r\n * Manages virtual cursor logic: smoothing, updating, and syncing with mouse events.\r\n *\r\n * This controller handles cursor position tracking with smoothing (lerp) logic.\r\n * Useful for animated cursor effects and interaction modules.\r\n */\r\nexport class CursorController {\r\n  /** Context providing access to shared data, tools, and settings. */\r\n  protected context: StringContext;\r\n\r\n  /** Threshold below which cursor is considered settled (no movement). */\r\n  private readonly SETTLE_THRESHOLD = 0.1;\r\n\r\n  /** Smoothing factor used to interpolate cursor movement. */\r\n  private smoothingFactor: number;\r\n\r\n  private lastMouseX: number = 0;\r\n  private lastMouseY: number = 0;\r\n  private lastMouseTime: number = 0;\r\n\r\n  /**\r\n   * Constructs a new `CursorController` instance.\r\n   * @param smoothing The initial lerp smoothing factor (0 to 1).\r\n   * @param context The shared context containing state and tools.\r\n   */\r\n  constructor(smoothing: number = 0.1, context: StringContext) {\r\n    this.smoothingFactor = smoothing;\r\n    this.context = context;\r\n\r\n    this.onSettingsChange({\r\n      isDesktop: context.data.viewport.windowWidth > 1024,\r\n      isForceRebuild: false,\r\n      widthChanged: true,\r\n      heightChanged: true,\r\n      scrollHeightChanged: true,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Updates the target cursor position from a mouse event.\r\n   * This is the raw position that smoothing will interpolate toward.\r\n   * @param e MouseEvent with current cursor position.\r\n   */\r\n  public onMouseMove(e: MouseEvent): void {\r\n    this.context.data.cursor.targetX = e.clientX;\r\n    this.context.data.cursor.targetY = e.clientY;\r\n\r\n    const now = performance.now();\r\n    const dt = now - this.lastMouseTime;\r\n\r\n    if (dt > 0) {\r\n      this.context.data.cursor.velocityX = (e.clientX - this.lastMouseX) / dt;\r\n      this.context.data.cursor.velocityY = (e.clientY - this.lastMouseY) / dt;\r\n    }\r\n\r\n    this.lastMouseX = e.clientX;\r\n    this.lastMouseY = e.clientY;\r\n    this.lastMouseTime = now;\r\n  }\r\n\r\n  /**\r\n   * Updates smoothed cursor position using linear interpolation (lerp).\r\n   * Should be called on every animation frame.\r\n   * Handles snapping when movement is below threshold.\r\n   */\r\n  public onFrame(): void {\r\n    const { targetX, targetY, smoothedX, smoothedY } = this.context.data.cursor;\r\n\r\n    const stepX = this.context.tools.lerp.process({\r\n      from: smoothedX,\r\n      to: targetX,\r\n      progress: this.smoothingFactor,\r\n    });\r\n    const stepY = this.context.tools.lerp.process({\r\n      from: smoothedY,\r\n      to: targetY,\r\n      progress: this.smoothingFactor,\r\n    });\r\n\r\n    const distance = this.getStepDistance(stepX, stepY);\r\n\r\n    if (this.isSettled(distance)) {\r\n      this.snapToTarget();\r\n    } else {\r\n      this.applyStep(stepX, stepY);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Called when global settings change.\r\n   * Updates the internal lerp factor from context settings.\r\n   */\r\n  public onSettingsChange(data: ISettingsChangeData): void {\r\n    let lerp = Number(this.context.settings[\"cursor-lerp\"]);\r\n    this.setLerpFactor(lerp);\r\n  }\r\n\r\n  /**\r\n   * Dynamically adjusts the smoothing factor using adaptive mapping.\r\n   * @param t The raw input lerp value (usually from 0 to 1).\r\n   */\r\n  public setLerpFactor(t: number): void {\r\n    this.smoothingFactor = this.context.tools.adaptiveLerp.process({\r\n      value: t,\r\n      inMin: 0.1,\r\n      inMax: 1.0,\r\n      outMin: 0.05,\r\n      outMax: 0.65,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Calculates the Euclidean distance from the cursor step.\r\n   * @param x Step in X direction.\r\n   * @param y Step in Y direction.\r\n   * @returns The length of the movement vector.\r\n   */\r\n  private getStepDistance(x: number, y: number): number {\r\n    return Math.hypot(x, y);\r\n  }\r\n\r\n  /**\r\n   * Determines whether the movement is below the settle threshold.\r\n   * @param distance Distance between smoothed and target positions.\r\n   * @returns Whether the cursor should snap to target.\r\n   */\r\n  private isSettled(distance: number): boolean {\r\n    return distance < this.SETTLE_THRESHOLD;\r\n  }\r\n\r\n  /**\r\n   * Immediately sets smoothed position to the target and zeroes deltas.\r\n   */\r\n  private snapToTarget(): void {\r\n    this.context.data.cursor.smoothedX = this.context.data.cursor.targetX;\r\n    this.context.data.cursor.smoothedY = this.context.data.cursor.targetY;\r\n    this.context.data.cursor.stepX = 0;\r\n    this.context.data.cursor.stepY = 0;\r\n  }\r\n\r\n  /**\r\n   * Applies lerped movement step to smoothed position and stores delta.\r\n   * @param x Step in X direction.\r\n   * @param y Step in Y direction.\r\n   */\r\n  private applyStep(x: number, y: number): void {\r\n    this.context.data.cursor.smoothedX += x;\r\n    this.context.data.cursor.smoothedY += y;\r\n    this.context.data.cursor.stepX = x;\r\n    this.context.data.cursor.stepY = y;\r\n  }\r\n}\r\n","import { EventCallback } from \"../../models/event/EventCallback\";\r\n\r\n/**\r\n * Manages custom event subscriptions and dispatching.\r\n * Allows multiple listeners per event and supports optional `id` suffixing.\r\n */\r\nexport class EventManager {\r\n  private listeners: Record<string, Set<EventCallback<any>>> = {};\r\n  private stateEvents: Set<string> = new Set();\r\n  private lastPayloads: Record<string, any> = {};\r\n\r\n  constructor() {\r\n    this.stateEvents.add(\"screen:mobile\");\r\n    this.stateEvents.add(\"screen:tablet\");\r\n    this.stateEvents.add(\"screen:laptop\");\r\n    this.stateEvents.add(\"screen:desktop\");\r\n    this.stateEvents.add(\"start\");\r\n  }\r\n\r\n  /**\r\n   * Subscribes to an event.\r\n   * Optionally appends an `id` to the event name for namespacing.\r\n   *\r\n   * @param eventName The base event name (e.g. \"scroll\", \"update\").\r\n   * @param callback The function to call when the event is emitted.\r\n   * @param id Optional unique identifier to scope the event (e.g. element ID).\r\n   */\r\n  on<T = any>(\r\n    eventName: string,\r\n    callback: EventCallback<T>,\r\n    id?: string | null\r\n  ): void {\r\n    const fullEvent = id ? `${eventName}:${id}` : eventName;\r\n\r\n    if (!this.listeners[fullEvent]) {\r\n      this.listeners[fullEvent] = new Set();\r\n    }\r\n    this.listeners[fullEvent].add(callback);\r\n    if (\r\n      this.stateEvents.has(fullEvent) &&\r\n      this.lastPayloads[fullEvent] !== undefined\r\n    ) {\r\n      callback(this.lastPayloads[fullEvent]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribes from a specific event listener.\r\n   * Must match the original `eventName`, `callback`, and optional `id`.\r\n   *\r\n   * @param eventName The base event name to unsubscribe from.\r\n   * @param callback The callback function to remove.\r\n   * @param id Optional identifier used when subscribing.\r\n   */\r\n  off<T = any>(\r\n    eventName: string,\r\n    callback: EventCallback<T>,\r\n    id?: string\r\n  ): void {\r\n    const fullEvent = id ? `${eventName}:${id}` : eventName;\r\n\r\n    if (this.listeners[fullEvent]) {\r\n      this.listeners[fullEvent].delete(callback);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emits an event with an optional payload.\r\n   * All matching listeners will be called.\r\n   *\r\n   * @param eventName The full event name (must include `id` if used).\r\n   * @param payload Optional data passed to event listeners.\r\n   */\r\n  emit<T = any>(eventName: string, payload?: T): void {\r\n    if (this.stateEvents.has(eventName)) {\r\n      this.lastPayloads[eventName] = payload;\r\n    }\r\n    const set = this.listeners[eventName];\r\n    if (!set) return;\r\n    for (const callback of set) {\r\n      callback(payload as T);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Subscribes to a per-object progress event.\r\n   * @param id The object ID.\r\n   * @param callback The callback to handle progress value.\r\n   */\r\n  onProgress(id: string, callback: EventCallback<number>): void {\r\n    this.on(`progress:${id}`, callback);\r\n  }\r\n\r\n  /**\r\n   * Emits a per-object progress event.\r\n   * @param id The object ID.\r\n   * @param value The progress value.\r\n   */\r\n  emitProgress(id: string, value: number): void {\r\n    this.emit(`progress:${id}`, value);\r\n  }\r\n\r\n  /**\r\n   * Subscribes to a per-object in-view event.\r\n   * @param id The object ID.\r\n   * @param callback The callback to handle visibility.\r\n   */\r\n  onInview(id: string, callback: EventCallback<boolean>): void {\r\n    this.on(`object:inview:${id}`, callback);\r\n  }\r\n\r\n  /**\r\n   * Emits a per-object in-view event.\r\n   * @param id The object ID.\r\n   * @param visible Whether the object is visible.\r\n   */\r\n  emitInview(id: string, visible: boolean): void {\r\n    this.emit(`object:inview:${id}`, visible);\r\n  }\r\n\r\n  /**\r\n   * Subscribes to the global scroll event.\r\n   * @param callback The callback to handle scroll value.\r\n   */\r\n  onScroll(callback: EventCallback<number>): void {\r\n    this.on(`scroll`, callback);\r\n  }\r\n\r\n  /**\r\n   * Emits the global scroll event.\r\n   * @param value The scroll value.\r\n   */\r\n  emitScroll(value: number): void {\r\n    this.emit(`scroll`, value);\r\n  }\r\n\r\n  /**\r\n   * Subscribes to the global update event.\r\n   * @param callback The callback to handle update.\r\n   */\r\n  onUpdate(callback: EventCallback<void>): void {\r\n    this.on(`update`, callback);\r\n  }\r\n\r\n  /**\r\n   * Emits the global update event.\r\n   */\r\n  emitUpdate(): void {\r\n    this.emit(`update`);\r\n  }\r\n\r\n  /**\r\n   * Clears all listeners for a specific event.\r\n   *\r\n   * @param eventName The full event name (including optional `id`).\r\n   */\r\n  clear(eventName: string): void {\r\n    delete this.listeners[eventName];\r\n  }\r\n\r\n  /**\r\n   * Clears all registered events.\r\n   */\r\n  clearAll(): void {\r\n    this.listeners = {};\r\n  }\r\n}\r\n","import { StringData } from \"../..\";\r\nimport { ISettingsChangeData } from \"../../models/event/ISettingsChangeData\";\r\nimport { IStringModule } from \"../IStringModule\";\r\nimport { StringModule } from \"../StringModule\";\r\n\r\ntype LifecycleName =\r\n  | \"destroy\"\r\n  | \"onInit\"\r\n  | \"onFrame\"\r\n  | \"onMutate\"\r\n  | \"onScrollMeasure\"\r\n  | \"onMouseMoveMeasure\"\r\n  | \"onScroll\"\r\n  | \"onResizeWidth\"\r\n  | \"onResize\"\r\n  | \"onMouseMove\"\r\n  | \"onWheel\"\r\n  | \"onDirectionChange\"\r\n  | \"onScrollStart\"\r\n  | \"onScrollStop\"\r\n  | \"onAxisChange\"\r\n  | \"onDeviceChange\"\r\n  | \"onScrollConfigChange\"\r\n  | \"onSettingsChange\"\r\n  | \"onDOMMutate\";\r\n\r\nfunction toLifecycleArgs(\r\n  lifecycle: LifecycleName,\r\n  data: StringData,\r\n  arg?: unknown,\r\n  arg2?: unknown\r\n): unknown[] {\r\n  switch (lifecycle) {\r\n    case \"onFrame\":\r\n    case \"onMutate\":\r\n    case \"onScrollMeasure\":\r\n    case \"onMouseMoveMeasure\":\r\n    case \"onScroll\":\r\n      return [data];\r\n    case \"onMouseMove\":\r\n    case \"onWheel\":\r\n      return arg ? [arg] : [];\r\n    case \"onDOMMutate\":\r\n      return arg && arg2 ? [arg, arg2] : [];\r\n    case \"onSettingsChange\":\r\n      return [];\r\n    default:\r\n      return [];\r\n  }\r\n}\r\n\r\nexport class ModuleManager {\r\n  private modules: StringModule[] = [];\r\n  private uiModules: StringModule[] = [];\r\n  private allModules: StringModule[] = [];\r\n\r\n  constructor(private data: StringData) {}\r\n\r\n  register(module: StringModule): void {\r\n    if (module.type === 1) {\r\n      this.modules.push(module);\r\n    } else if (module.type === 2) {\r\n      this.uiModules.push(module);\r\n    }\r\n\r\n    this.rebuildAllModules();\r\n  }\r\n\r\n  find<T>(type: new (...args: any[]) => T): T | undefined {\r\n    return this.modules.find((m) => m instanceof type) as T | undefined;\r\n  }\r\n\r\n  onInit(): void {\r\n    this.callAll(\"onInit\");\r\n  }\r\n\r\n  onFrame(): void {\r\n    this.callAll(\"onFrame\");\r\n  }\r\n\r\n  onMutate(): void {\r\n    this.callAll(\"onMutate\");\r\n  }\r\n\r\n  onScrollMeasure(): void {\r\n    this.callAll(\"onScrollMeasure\");\r\n  }\r\n\r\n  onMouseMoveMeasure(): void {\r\n    this.callAll(\"onMouseMoveMeasure\");\r\n  }\r\n\r\n  onScroll(): void {\r\n    this.callAll(\"onScroll\");\r\n  }\r\n\r\n  onResizeWidth(): void {\r\n    this.callAll(\"onResizeWidth\");\r\n  }\r\n\r\n  onResize(): void {\r\n    this.callAll(\"onResize\");\r\n  }\r\n\r\n  onMouseMove(e: MouseEvent): void {\r\n    this.callAll(\"onMouseMove\", e);\r\n  }\r\n\r\n  onWheel(e: WheelEvent): void {\r\n    this.callAll(\"onWheel\", e);\r\n  }\r\n\r\n  onDirectionChange(): void {\r\n    this.callAll(\"onDirectionChange\");\r\n  }\r\n\r\n  onScrollStart(): void {\r\n    this.callAll(\"onScrollStart\");\r\n  }\r\n\r\n  onScrollStop(): void {\r\n    this.callAll(\"onScrollStop\");\r\n  }\r\n\r\n  onAxisChange(): void {\r\n    this.callAll(\"onAxisChange\");\r\n  }\r\n\r\n  onDeviceChange(): void {\r\n    this.callAll(\"onDeviceChange\");\r\n  }\r\n\r\n  onScrollConfigChange(): void {\r\n    this.callAll(\"onScrollConfigChange\");\r\n  }\r\n\r\n  onSettingsChange(_data: ISettingsChangeData): void {\r\n    this.callAll(\"onSettingsChange\");\r\n  }\r\n\r\n  onDOMMutate(added: NodeList, removed: NodeList): void {\r\n    this.callAll(\"onDOMMutate\", added, removed);\r\n  }\r\n\r\n  destroy(): void {\r\n    this.callAll(\"destroy\");\r\n    this.modules = [];\r\n    this.uiModules = [];\r\n    this.allModules = [];\r\n  }\r\n\r\n  get all(): IStringModule[] {\r\n    return this.allModules;\r\n  }\r\n\r\n  get core(): IStringModule[] {\r\n    return this.modules;\r\n  }\r\n\r\n  get ui(): IStringModule[] {\r\n    return this.uiModules;\r\n  }\r\n\r\n  private callAll(lifecycle: LifecycleName, arg?: unknown, arg2?: unknown): void {\r\n    this.callLifecycle(this.modules, lifecycle, arg, arg2);\r\n    this.callLifecycle(this.uiModules, lifecycle, arg, arg2);\r\n  }\r\n\r\n  private callLifecycle(\r\n    modules: StringModule[],\r\n    lifecycle: LifecycleName,\r\n    arg?: unknown,\r\n    arg2?: unknown\r\n  ): void {\r\n    if (modules.length === 0) {\r\n      return;\r\n    }\r\n\r\n    const args = toLifecycleArgs(lifecycle, this.data, arg, arg2);\r\n\r\n    for (let i = 0; i < modules.length; i++) {\r\n      const module = modules[i];\r\n      if (!module) continue;\r\n\r\n      (module as any)[lifecycle](...args);\r\n    }\r\n  }\r\n\r\n  private rebuildAllModules(): void {\r\n    this.allModules = [...this.modules, ...this.uiModules];\r\n  }\r\n}\r\n","import type { StringObject } from \"./StringObject\";\n\nexport type MirrorEasingFn = (value: number) => number;\n\n/**\n * Lightweight wrapper that mirrors a primary StringObject while keeping\n * its own easing and state. Intended for elements linked via\n * `[string-copy-from]`.\n */\nexport class StringMirrorObject {\n  public readonly id: string;\n  public readonly htmlElement: HTMLElement;\n\n  private properties = new Map<string, any>();\n  private easingFn?: MirrorEasingFn;\n\n  constructor(id: string, element: HTMLElement, private parent: StringObject) {\n    this.id = id;\n    this.htmlElement = element;\n  }\n\n  public get parentObject(): StringObject {\n    return this.parent;\n  }\n\n  public setProperty<T>(key: string, value: T): void {\n    this.properties.set(key, value);\n  }\n\n  public getProperty<T>(key: string): T {\n    return this.properties.get(key) ?? null;\n  }\n\n  public setEasing(easing: MirrorEasingFn | null | undefined): void {\n    this.easingFn = easing ?? undefined;\n  }\n\n  public getEasing(): MirrorEasingFn | undefined {\n    return this.easingFn;\n  }\n\n  /**\n   * Returns eased progress using mirror easing (if set) or fallback.\n   */\n  public applyProgress(rawProgress: number, fallback?: MirrorEasingFn): number {\n    const easing = this.easingFn ?? fallback;\n    return easing ? easing(rawProgress) : rawProgress;\n  }\n}\n","import { IStringModule } from \"../core/IStringModule\";\nimport { EventManager } from \"../core/managers/EventManager\";\nimport { StringMirrorObject } from \"./StringMirrorObject\";\n\r\n/**\r\n * Internal class representing a DOM-bound interactive object.\r\n * Connected to modules and holds its own internal state.\r\n */\r\nexport class StringObject {\r\n  /**\r\n   * The DOM element this object wraps.\r\n   */\r\n  public htmlElement: HTMLElement;\r\n\r\n  /**\r\n   * Unique global ID assigned by the system.\r\n   */\r\n  public id: string = \"\";\r\n\r\n  /**\r\n   * Space-separated list of all attribute keys associated with this object.\r\n   */\r\n  public keys: string[] = [];\r\n\r\n  /**\n   * Mirror objects linked via `string-copy-from`.\n   */\n  private mirrors = new Map<string, StringMirrorObject>();\n\r\n  /**\n   * Internal key-value store of dynamic object properties (like offsets, progress, etc.).\n   */\n  private properties: Map<string, any> = new Map();\n\r\n  /**\r\n   * Modules currently connected to this object.\r\n   */\r\n  private modules: IStringModule[] = [];\r\n\r\n  /**\r\n   * Manages and handles events for the object.\r\n   * Provides functionality to register, trigger, and manage event listeners.\r\n   */\r\n  events: EventManager = new EventManager();\n\r\n  constructor(id: string, element: HTMLElement) {\r\n    this.htmlElement = element;\r\n    this.id = id;\r\n  }\r\n\r\n  /**\r\n   * Stores a property value for this object.\r\n   * @param key - Property name\r\n   * @param value - Value to store\r\n   */\r\n  public setProperty<T>(key: string, value: T): void {\r\n    this.properties.set(key, value);\r\n  }\r\n\r\n  /**\n   * Retrieves a previously stored property value.\n   * @param key - Property name\r\n   * @returns The value or null if not set\r\n   */\r\n  public getProperty<T>(key: string): T {\r\n    return this.properties.get(key) ?? null;\r\n  }\r\n\r\n  /**\r\n   * Marks this object as \"active\" (usually on intersection/scroll enter).\r\n   */\r\n  public enter(): void {\r\n    this.events.emit(\"enter\", this);\r\n    this.setProperty(\"active\", true);\r\n    this.modules.forEach((module) => {\r\n      module.enterObject(this.id, this);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Marks this object as \"inactive\" (usually on intersection/scroll leave).\r\n   */\r\n  public leave(): void {\r\n    this.events.emit(\"leave\", this);\r\n    this.setProperty(\"active\", false);\r\n    this.modules.forEach((module) => {\r\n      module.exitObject(this.id);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Removes the current object by iterating through all associated modules\r\n   * and invoking their `removeObject` method with the object's ID.\r\n   *\r\n   * This method ensures that the object is properly removed from all\r\n   * modules it is associated with.\r\n   */\r\n  public remove(): void {\r\n    this.modules.forEach((module) => {\n      module.removeObject(this.id);\n    });\n  }\n\n  /**\n   * Shows the object, applies visual class and notifies connected modules.\n   */\n  public show(): void {\n    this.htmlElement.classList.add(\"-inview\");\n  }\n\r\n  /**\r\n   * Hides the object, removes visual class (if repeat is enabled), and notifies modules.\r\n   */\r\n  public hide(): void {\r\n    const shouldRepeat = this.getProperty<boolean>(\"repeat\");\r\n    if (shouldRepeat) {\r\n      this.htmlElement.classList.remove(\"-inview\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Connects a module to this object if not already connected.\r\n   * @param module - The module to connect\r\n   */\r\n  public connect(module: IStringModule): void {\n    if (!this.modules.includes(module)) {\n      this.modules.push(module);\n    }\n  }\n\n  public addMirror(mirror: StringMirrorObject): void {\n    this.mirrors.set(mirror.id, mirror);\n  }\n\n  public removeMirror(id: string): void {\n    this.mirrors.delete(id);\n  }\n\n  public get mirrorObjects(): StringMirrorObject[] {\n    return Array.from(this.mirrors.values());\n  }\n\n  public get connects(): HTMLElement[] {\n    return this.mirrorObjects.map((mirror) => mirror.htmlElement);\n  }\n}\n","import { ModuleManager } from \"./ModuleManager\";\r\nimport { StringData } from \"../StringData\";\r\nimport { StringMirrorObject } from \"../../objects/StringMirrorObject\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { EventManager } from \"./EventManager\";\r\nimport { ISettingsChangeData } from \"../../models/event/ISettingsChangeData\";\r\nimport { StringToolsContainer } from \"../StringToolsContainer\";\r\n\r\nexport class ObjectManager {\r\n  private objects = new Map<string, StringObject>();\r\n  private connectQueue: { id: string; element: HTMLElement }[] = [];\r\n  private mirrors = new Map<string, StringMirrorObject>();\r\n  private mirrorId = 1;\r\n  private globalId = 1;\r\n\r\n  constructor(\r\n    private data: StringData,\r\n    private modules: ModuleManager,\r\n    private events: EventManager,\r\n    private tools: StringToolsContainer\r\n  ) {}\r\n\r\n  /**\r\n   * Returns the object map (read-only).\r\n   */\r\n  get all(): ReadonlyMap<string, StringObject> {\r\n    return this.objects;\r\n  }\r\n\r\n  /**\r\n   * Adds a new object from an element.\r\n   */\r\n  public add(el: HTMLElement) {\r\n    let idAttr = `string-${this.globalId++}`;\r\n    let key = \"string-id\";\r\n\r\n    if (el.getAttribute(\"string-id\")) {\r\n      idAttr = el.getAttribute(\"string-id\")!;\r\n      key = \"string-id\";\r\n    }\r\n    if (el.getAttribute(\"data-string-id\")) {\r\n      idAttr = el.getAttribute(\"data-string-id\")!;\r\n      key = \"data-string-id\";\r\n    }\r\n\r\n    const object =\r\n      idAttr && this.objects.has(idAttr) ? this.objects.get(idAttr)! : new StringObject(idAttr, el);\r\n\r\n    el.setAttribute(key, object.id);\r\n\r\n    const keysAttr = el.getAttribute(\"string\") ?? el.getAttribute(\"data-string\");\r\n\r\n    if (keysAttr) {\r\n      object.keys = (keysAttr ?? \"\")\r\n        .split(\"|\")\r\n        .map((s) => s.trim())\r\n        .filter(Boolean);\r\n    }\r\n\r\n    el.setAttribute(\"string-inited\", \"\");\r\n    this.objects.set(object.id, object);\r\n\r\n    const attributes = this.getAllAttributes(el);\r\n\r\n    // Delegate core setup (dimensions, offsets, key, start/end, etc.)\r\n    this.modules.core.forEach((m) => {\r\n      if (\"setupCoreProperties\" in m && typeof m[\"setupCoreProperties\"] === \"function\") {\r\n        (m as any).setupCoreProperties(object, el, attributes);\r\n      }\r\n    });\r\n\r\n    // Try connecting to modules\r\n    this.modules.core.forEach((m) => {\r\n      if (m.canConnect(object)) {\r\n        m.initializeObject(this.globalId, object, el, attributes);\r\n        m.calculatePositions(object, this.data.viewport.windowHeight);\r\n        m.connectObject(object);\r\n        m.addObject(object.id, object);\r\n      }\r\n    });\r\n\r\n    // Restore connect-from\r\n    const queueItems = this.connectQueue.filter((q) => q.id === object.id);\r\n    queueItems.forEach((item) => this.attachMirrorToObject(object, item.element));\r\n    this.connectQueue = this.connectQueue.filter((q) => q.id !== object.id);\r\n\r\n    // Set up observers\r\n    this.initObservers(object, el);\r\n\r\n    this.checkInviewForObject(object);\r\n  }\r\n\r\n  /**\r\n   * Removes an object by its id.\r\n   */\r\n  public remove(id: string) {\r\n    const obj = this.objects.get(id);\r\n    if (!obj) return;\r\n\r\n    obj.events.clearAll();\r\n    obj.getProperty<IntersectionObserver>(\"observer-progress\")?.disconnect();\r\n    obj.getProperty<IntersectionObserver>(\"observer-inview\")?.disconnect();\r\n\r\n    obj.htmlElement.removeAttribute(\"string-inited\");\r\n    obj.leave();\r\n    obj.remove();\r\n\r\n    obj.mirrorObjects.forEach((mirror) => {\r\n      mirror.htmlElement.removeAttribute(\"string-mirror-id\");\r\n      this.mirrors.delete(mirror.id);\r\n\r\n      const copyFromId =\r\n        mirror.htmlElement.getAttribute(\"string-copy-from\") ??\r\n        mirror.htmlElement.getAttribute(\"data-string-copy-from\");\r\n      if (copyFromId) {\r\n        this.enqueueConnection(copyFromId, mirror.htmlElement);\r\n      }\r\n    });\r\n\r\n    this.objects.delete(id);\r\n  }\r\n\r\n  /**\r\n   * Add an element that will connect later.\r\n   */\r\n  public enqueueConnection(id: string, element: HTMLElement) {\r\n    if (this.connectQueue.some((item) => item.id === id && item.element === element)) {\r\n      return;\r\n    }\r\n    this.connectQueue.push({ id, element });\r\n  }\r\n\r\n  public linkMirror(id: string, element: HTMLElement): void {\r\n    const parent = this.objects.get(id);\r\n    if (parent) {\r\n      this.attachMirrorToObject(parent, element);\r\n    } else {\r\n      this.enqueueConnection(id, element);\r\n    }\r\n  }\r\n\r\n  private attachMirrorToObject(object: StringObject, element: HTMLElement): StringMirrorObject {\r\n    const existingId =\r\n      element.getAttribute(\"string-mirror-id\") ?? element.getAttribute(\"data-string-mirror-id\");\r\n\r\n    if (existingId) {\r\n      const existing = this.mirrors.get(existingId);\r\n      if (existing) {\r\n        if (existing.parentObject === object) {\r\n          return existing;\r\n        }\r\n        existing.parentObject.removeMirror(existingId);\r\n        this.mirrors.delete(existingId);\r\n      }\r\n    }\r\n\r\n    const mirrorId = existingId ?? `string-mirror-${this.mirrorId++}`;\r\n    const mirror = new StringMirrorObject(mirrorId, element, object);\r\n    element.setAttribute(\"string-mirror-id\", mirrorId);\r\n    object.addMirror(mirror);\r\n    this.mirrors.set(mirrorId, mirror);\r\n\r\n    const easingAttr =\r\n      element.getAttribute(\"string-easing\") ?? element.getAttribute(\"data-string-easing\");\r\n    if (easingAttr && easingAttr.trim().length > 0) {\r\n      mirror.setEasing(this.tools.easingFunction.process({ easing: easingAttr }));\r\n      mirror.setProperty(\"easing\", easingAttr);\r\n    }\r\n    return mirror;\r\n  }\r\n\r\n  private detachMirrorByElement(element: HTMLElement): void {\r\n    const mirrorId =\r\n      element.getAttribute(\"string-mirror-id\") ?? element.getAttribute(\"data-string-mirror-id\");\r\n    if (!mirrorId) return;\r\n    this.detachMirrorById(mirrorId);\r\n    element.removeAttribute(\"string-mirror-id\");\r\n  }\r\n\r\n  private detachMirrorById(mirrorId: string): void {\r\n    const mirror = this.mirrors.get(mirrorId);\r\n    if (!mirror) return;\r\n    mirror.parentObject.removeMirror(mirrorId);\r\n    this.mirrors.delete(mirrorId);\r\n  }\r\n\r\n  /**\r\n   * Retrieves all attributes of a given HTML element and returns them as a record.\r\n   *\r\n   * @param el - The HTML element from which to extract attributes.\r\n   * @returns A record where the keys are attribute names and the values are attribute values.\r\n   */\r\n  private getAllAttributes(el: HTMLElement): Record<string, any> {\r\n    const attributes: Record<string, any> = {};\r\n    Array.from(el.attributes).forEach((attr) => {\r\n      attributes[attr.name] = attr.value;\r\n    });\r\n    return attributes;\r\n  }\r\n\r\n  /**\r\n   * Initializes IntersectionObservers for a given object and its associated HTML element.\r\n   *\r\n   * This method sets up observer:\r\n   * - A \"progress\" observer to track when the object enters or leaves the viewport.\r\n   *\r\n   * The observers are configured with custom root margins and thresholds based on the object's properties.\r\n   * Existing observers, if any, are disconnected before creating new ones.\r\n   *\r\n   * @param obj - The `StringObject` instance containing properties and methods for interaction.\r\n   * @param el - The `HTMLElement` to observe for intersection changes.\r\n   */\r\n  private initObservers(obj: StringObject, el: HTMLElement) {\r\n    const start = obj.getProperty<number>(\"offset-top\") ?? 0;\r\n    const end = obj.getProperty<number>(\"offset-bottom\") ?? 0;\r\n    obj.getProperty<IntersectionObserver>(\"observer-progress\")?.disconnect();\r\n    const progressCallback = (entries: IntersectionObserverEntry[]) => {\r\n      entries.forEach((e) => {\r\n        this.events.emit(`object:activate:${obj.id}`, e.isIntersecting);\r\n        e.isIntersecting ? obj.enter() : obj.leave();\r\n      });\r\n    };\r\n    const outsideProp = obj.getProperty<boolean>(\"outside-container\");\r\n    const outsideAttrValue =\r\n      el.getAttribute(\"string-outside-container\") ??\r\n      el.getAttribute(\"data-string-outside-container\");\r\n    const outsideAttrNormalized =\r\n      outsideAttrValue != null ? outsideAttrValue.trim().toLowerCase() : null;\r\n    const outsideAttrFlag =\r\n      outsideAttrNormalized === \"\" ||\r\n      outsideAttrNormalized === \"true\" ||\r\n      outsideAttrNormalized === \"1\";\r\n    const isOutsideContainer = outsideProp != null ? outsideProp === true : outsideAttrFlag;\r\n    const observerRoot =\r\n      this.data.scroll.container === document.body || isOutsideContainer\r\n        ? null\r\n        : this.data.scroll.container;\r\n\r\n    const progressObserver = new IntersectionObserver(progressCallback, {\r\n      root: observerRoot,\r\n      rootMargin: `${end + this.data.viewport.windowHeight}px 0px ${\r\n        start + this.data.viewport.windowHeight\r\n      }px 0px`,\r\n      threshold: 0,\r\n    });\r\n    progressObserver.observe(el);\r\n    obj.setProperty(\"observer-progress\", progressObserver);\r\n  }\r\n\r\n  /**\r\n   * Observes DOM mutations to auto-add/remove elements with [string] attribute.\r\n   * Should be called once after DOM is ready.\r\n   */\r\n  public observeDOM(): void {\r\n    const observer = new MutationObserver((mutations) => {\r\n      mutations.forEach((mutation) => {\r\n        if (mutation.type === \"childList\") {\r\n          // Removed elements\r\n          mutation.removedNodes.forEach((node) => {\r\n            if (node.nodeType !== Node.ELEMENT_NODE) return;\r\n\r\n            const element = node as HTMLElement;\r\n\r\n            this.detachMirrorByElement(element);\r\n\r\n            if (this.isFixed(element)) return;\r\n\r\n            if (element.hasAttribute(\"string\")) {\r\n              this.handleRemoved(element);\r\n            }\r\n\r\n            element.querySelectorAll(\"[string],[data-string]\").forEach((child) => {\r\n              if (this.isFixed(child as HTMLElement)) return;\r\n              this.handleRemoved(child as HTMLElement);\r\n            });\r\n\r\n            element\r\n              .querySelectorAll(\"[string-copy-from],[data-string-copy-from]\")\r\n              .forEach((child) => this.detachMirrorByElement(child as HTMLElement));\r\n          });\r\n\r\n          // Added elements\r\n          mutation.addedNodes.forEach((node) => {\r\n            if (node.nodeType !== Node.ELEMENT_NODE) return;\r\n\r\n            const element = node as HTMLElement;\r\n\r\n            if (this.isFixed(element)) return;\r\n\r\n            if (element.hasAttribute(\"string\") && !element.hasAttribute(\"string-inited\")) {\r\n              this.add(element);\r\n            }\r\n\r\n            element\r\n              .querySelectorAll(\"[string]:not([string-inited]),[data-string]:not([string-inited])\")\r\n              .forEach((child) => this.add(child as HTMLElement));\r\n\r\n            // Check for connect-from logic\r\n            const copyFrom =\r\n              element.getAttribute(\"string-copy-from\") ??\r\n              element.getAttribute(\"data-string-copy-from\");\r\n\r\n            if (copyFrom) {\r\n              this.linkMirror(copyFrom, element);\r\n            }\r\n\r\n            element\r\n              .querySelectorAll(\"[string-copy-from],[data-string-copy-from]\")\r\n              .forEach((child) => {\r\n                const childCopyFrom =\r\n                  child.getAttribute(\"string-copy-from\") ??\r\n                  child.getAttribute(\"data-string-copy-from\");\r\n                if (childCopyFrom) {\r\n                  this.linkMirror(childCopyFrom, child as HTMLElement);\r\n                }\r\n              });\r\n          });\r\n\r\n          if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {\r\n            this.modules.onDOMMutate(mutation.addedNodes, mutation.removedNodes);\r\n          }\r\n\r\n          // Let modules know about DOM rebuild\r\n          this.modules.all.forEach((m) => m.onDOMRebuild());\r\n        }\r\n      });\r\n    });\r\n\r\n    observer.observe(document.body, {\r\n      childList: true,\r\n      subtree: true,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Removes an object and its observers.\r\n   */\r\n  private handleRemoved(el: HTMLElement): void {\r\n    const id = el.getAttribute(\"string-id\") ?? el.getAttribute(\"data-string-id\");\r\n    if (!id) return;\r\n\r\n    const copyFrom =\r\n      el.getAttribute(\"string-copy-from\") ?? el.getAttribute(\"data-string-copy-from\");\r\n    if (copyFrom) {\r\n      this.connectQueue = this.connectQueue.filter((q) => q.id !== copyFrom);\r\n    }\r\n\r\n    this.remove(id);\r\n  }\r\n\r\n  /**\r\n   * Re-applies module initialization logic to all managed objects after settings change.\r\n   *\r\n   * This method should be called when `StringSettings` are updated at runtime,\r\n   * especially if the new settings affect how modules calculate offsets,\r\n   * easing, origins, or custom configuration.\r\n   *\r\n   * Internally, it re-runs `initializeObject`, `calculatePositions`, and `connectObject`\r\n   * for each core module that can connect to the object.\r\n   *\r\n   * This is useful for supporting dynamic configuration updates without requiring\r\n   * a full DOM rebuild or reinitialization.\r\n   */\r\n  public onSettingsChange(data: ISettingsChangeData) {\r\n    this.objects.forEach((object) => {\r\n      this.modules.core.forEach((m) => {\r\n        let isCanRebuild = false;\r\n        if (data.isDesktop) {\r\n          if (m.permissions.desktop.rebuild.scrollHeight && data.scrollHeightChanged) {\r\n            isCanRebuild = true;\r\n          }\r\n          if (m.permissions.desktop.rebuild.width && data.widthChanged) {\r\n            isCanRebuild = true;\r\n          }\r\n          if (m.permissions.desktop.rebuild.height && data.heightChanged) {\r\n            isCanRebuild = true;\r\n          }\r\n        } else {\r\n          if (m.permissions.mobile.rebuild.scrollHeight && data.scrollHeightChanged) {\r\n            isCanRebuild = true;\r\n          }\r\n          if (m.permissions.mobile.rebuild.width && data.widthChanged) {\r\n            isCanRebuild = true;\r\n          }\r\n          if (m.permissions.mobile.rebuild.height && data.heightChanged) {\r\n            isCanRebuild = true;\r\n          }\r\n        }\r\n\r\n        if (isCanRebuild || data.isForceRebuild) {\r\n          if (m.canConnect(object)) {\r\n            const attributes = this.getAllAttributes(object.htmlElement);\r\n            m.initializeObject(this.globalId, object, object.htmlElement, attributes);\r\n            m.calculatePositions(object, this.data.viewport.windowHeight);\r\n            m.connectObject(object);\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks whether the element is marked as fixed (not managed).\r\n   */\r\n  private isFixed(el: HTMLElement): boolean {\r\n    return el.hasAttribute(\"string-fixed\");\r\n  }\r\n\r\n  public checkInview() {\r\n    this.objects.forEach((object) => {\r\n      this.checkInviewForObject(object);\r\n    });\r\n  }\r\n\r\n  private checkInviewForObject(object: StringObject) {\r\n    const scrollPos = this.data.scroll.transformedCurrent;\r\n    const inviewStart = object.getProperty<number>(\"inview-start-position\");\r\n    const inviewEnd = object.getProperty<number>(\"inview-end-position\");\r\n    const wasInView = object.getProperty<boolean>(\"is-inview\") ?? false;\r\n\r\n    const start = Math.min(inviewStart, inviewEnd);\r\n    const end = Math.max(inviewStart, inviewEnd);\r\n    const isNowInView = scrollPos >= start && scrollPos <= end;\r\n\r\n    let direction: \"enter-top\" | \"enter-bottom\" | \"exit-top\" | \"exit-bottom\" | null = null;\r\n    if (!wasInView && isNowInView) {\r\n      const distToStart = Math.abs(scrollPos - start);\r\n      const distToEnd = Math.abs(end - scrollPos);\r\n      direction = distToStart <= distToEnd ? \"enter-top\" : \"enter-bottom\";\r\n    } else if (wasInView && !isNowInView) {\r\n      direction = scrollPos < start ? \"exit-top\" : \"exit-bottom\";\r\n    }\r\n    if (isNowInView !== wasInView) {\r\n      object.setProperty(\"is-inview\", isNowInView);\r\n      this.events.emit(`object:inview:${object.id}`, {\r\n        inView: isNowInView,\r\n        direction,\r\n      });\r\n      isNowInView ? object.show() : object.hide();\r\n    }\r\n  }\r\n}\r\n","import { ScrollMarkRule } from \"../../models/scroll/ScrollTriggerRule\";\r\nimport { StringContext } from \"../StringContext\";\r\n\r\n/**\r\n * Base class for managing scroll behavior in the system.\r\n * Handles abstract scroll state and updates, intended for extension.\r\n */\r\nexport class ScrollController {\r\n  /** Shared context containing data and tools */\r\n  protected context: StringContext;\r\n\r\n  /** Reference to the document object */\r\n  protected document: Document;\r\n\r\n  /** Name of the scroll mode (e.g. 'default', 'smooth', etc.) */\r\n  public name: string = \"\";\r\n\r\n  /** Whether the system is in programmatic scroll mode */\r\n  public isProg: boolean = false;\r\n\r\n  /** Whether parallax-related logic should be active */\r\n  public isParallaxEnabled: boolean = false;\r\n\r\n  /** Scroll direction: vertical or horizontal */\r\n  protected _scrollDirection: \"vertical\" | \"horizontal\" = \"vertical\";\r\n\r\n  /**\r\n   * Current scroll direction.\r\n   * - `true` — scrolling down\r\n   * - `false` — scrolling up\r\n   * - `null` — unknown (initial state)\r\n   */\r\n  protected isBottomScrollDirection: boolean | null = null;\r\n\r\n  protected isLastBottomScrollDirection: boolean = true;\r\n\r\n  protected scrollTriggerRules: Array<ScrollMarkRule> = [];\r\n\r\n  /**\r\n   * Sets scroll direction and updates internal scroll logic.\r\n   * @param scrollDirection Either 'vertical' or 'horizontal'.\r\n   */\r\n  public set scrollDirection(scrollDirection: \"vertical\" | \"horizontal\") {\r\n    this._scrollDirection = scrollDirection;\r\n\r\n    if (this._scrollDirection === \"vertical\") {\r\n      this.onCalcUpdate = () => {\r\n        this.context.data.scroll.scrollContainer?.scrollTo(0, this.context.data.scroll.current);\r\n        this.triggerScrollRules();\r\n      };\r\n    } else if (this._scrollDirection === \"horizontal\") {\r\n      this.onCalcUpdate = () => {\r\n        this.context.data.scroll.scrollContainer?.scrollTo(this.context.data.scroll.current, 0);\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a new ScrollController instance.\r\n   * @param context Shared context containing data and settings.\r\n   */\r\n  constructor(context: StringContext) {\r\n    this.document = document;\r\n    this.context = context;\r\n  }\r\n\r\n  /**\r\n   * Called when scroll direction changes (up ↔ down).\r\n   * Override this callback in subclasses or instances.\r\n   */\r\n  public onChangeDirection = () => {};\r\n\r\n  /**\r\n   * Called when scroll starts (user input).\r\n   * Override this callback in subclasses or instances.\r\n   */\r\n  public onScrollStart = () => {};\r\n\r\n  /**\r\n   * Called when scroll ends.\r\n   * Override this callback in subclasses or instances.\r\n   */\r\n  public onScrollStop = () => {};\r\n\r\n  /**\r\n   * Scroll-to function called on each frame.\r\n   * This will be reassigned depending on scroll direction.\r\n   */\r\n  public onCalcUpdate: () => void = () => {\r\n    this.context.data.scroll.scrollContainer?.scrollTo(0, this.context.data.scroll.current);\r\n    this.triggerScrollRules();\r\n  };\r\n\r\n  /**\r\n   * Called every animation frame.\r\n   * Intended to be overridden in subclasses.\r\n   */\r\n  public onFrame(): void {}\r\n\r\n  /**\r\n   * Called when wheel event is fired.\r\n   * Override to implement custom scroll interaction.\r\n   * @param e Wheel event.\r\n   */\r\n  public onWheel(e: any): void {}\r\n\r\n  /**\r\n   * Called when native scroll event is fired.\r\n   * Override to track native scroll position.\r\n   * @param e Scroll event.\r\n   */\r\n  public onScroll(e: any): void {}\r\n\r\n  public disableScrollEvents(): void {}\r\n\r\n  public enableScrollEvents(): void {}\r\n\r\n  private triggerScrollRules() {\r\n    this.scrollTriggerRules.forEach((rule) => {\r\n      const shouldTrigger =\r\n        (rule.direction === \"any\" ||\r\n          (this.isLastBottomScrollDirection && rule.direction === \"forward\")) &&\r\n        this.context.data.scroll.current >= rule.offset;\r\n      if (shouldTrigger) {\r\n        rule.onEnter?.();\r\n        if (rule.toggleClass) {\r\n          rule.toggleClass.target.classList.add(rule.toggleClass.className);\r\n        }\r\n      } else {\r\n        rule.onLeave?.();\r\n        if (rule.toggleClass) {\r\n          rule.toggleClass.target.classList.remove(rule.toggleClass.className);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public addScrollMark(rule: ScrollMarkRule) {\r\n    this.scrollTriggerRules.push(rule);\r\n  }\r\n\r\n  public removeScrollMark(id: string) {\r\n    this.scrollTriggerRules = this.scrollTriggerRules.filter((rule) => rule.id !== id);\r\n  }\r\n\r\n  public scrollTo(position: number) {}\r\n}\r\n","import { StringContext } from \"../StringContext\";\r\nimport { ScrollController } from \"./ScrollController\";\r\n\r\n/**\r\n * Default scroll controller using native browser scrolling behavior.\r\n * Handles `scrollTop`, easing delta over time for smooth lerped animations.\r\n */\r\nexport class StringScrollDefault extends ScrollController {\r\n  /** Unique name identifier for this scroll mode. */\r\n  public readonly name: string = \"default\";\r\n\r\n  /**\r\n   * Constructs a new instance of the default scroll controller.\r\n   * @param context Shared string system context.\r\n   */\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n  }\r\n\r\n  /**\r\n   * Called every animation frame.\r\n   * Applies easing to scroll delta and updates lerped value.\r\n   * Fires `onScrollStop` once movement has settled.\r\n   */\r\n  public onFrame(): void {\r\n    if (this.context.data.scroll.delta !== 0) {\r\n      const delta = this.context.data.scroll.delta * this.context.data.scroll.speedAccelerate;\r\n      this.context.data.scroll.delta -= delta;\r\n      this.context.data.scroll.lerped = delta;\r\n\r\n      if (Math.abs(this.context.data.scroll.lerped) < 0.1) {\r\n        this.context.data.scroll.delta = 0;\r\n        this.context.data.scroll.lerped = 0;\r\n        this.onScrollStop();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Called on native scroll event.\r\n   * Syncs the internal scroll state with the current page scroll.\r\n   * @param e Scroll event object (unused).\r\n   */\r\n  public onScroll(e: any): void {\r\n    const scrollTop = this.context.data.scroll.elementContainer.scrollTop;\r\n    this.context.data.scroll.current = scrollTop;\r\n    this.context.data.scroll.target = scrollTop;\r\n    this.context.data.scroll.transformedCurrent = scrollTop;\r\n  }\r\n\r\n  /**\r\n   * Handles wheel input by updating scroll delta for easing.\r\n   * Triggers `onScrollStart` if delta begins from zero.\r\n   * @param e Wheel event.\r\n   */\r\n  public onWheel(e: any): void {\r\n    if (e.deltaY !== 0) {\r\n      if (this.context.data.scroll.delta === 0) {\r\n        this.onScrollStart();\r\n      }\r\n\r\n      const plusDelta = e.deltaY;\r\n\r\n      // Prevent negative delta from triggering at top of scroll\r\n      if (this.context.data.scroll.target === 0) {\r\n        this.context.data.scroll.delta += Math.max(0, e.deltaY);\r\n      }\r\n\r\n      this.context.data.scroll.delta += plusDelta;\r\n    }\r\n  }\r\n\r\n  public scrollTo(position: number) {\r\n    this.context.data.scroll.target = position;\r\n    this.context.data.scroll.delta = 1;\r\n  }\r\n}\r\n","import { StringContext } from \"../StringContext\";\r\nimport { ScrollController } from \"./ScrollController\";\r\n\r\n/**\r\n * Scroll controller that disables all user-initiated scrolling.\r\n * Prevents native scroll and wheel behavior, effectively locking the page.\r\n */\r\nexport class StringScrollDisable extends ScrollController {\r\n  /** Unique name identifier for this scroll mode. */\r\n  public readonly name: string = \"disable\";\r\n\r\n  /**\r\n   * Constructs the scroll disabling controller.\r\n   * @param context The shared string system context.\r\n   */\r\n\r\n  private preventScroll = (e: Event) => {\r\n    e.preventDefault();\r\n  };\r\n\r\n  private preventKeyScroll = (e: KeyboardEvent) => {\r\n    const keysThatScroll = [\r\n      \"ArrowUp\",\r\n      \"ArrowDown\",\r\n      \"PageUp\",\r\n      \"PageDown\",\r\n      \" \",\r\n      \"Home\",\r\n      \"End\",\r\n    ];\r\n    if (keysThatScroll.includes(e.key)) {\r\n      e.preventDefault();\r\n    }\r\n  };\r\n\r\n  private onPreventScroll = this.preventScroll.bind(this);\r\n  private onPreventKeyScroll = this.preventKeyScroll.bind(this);\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n  }\r\n\r\n  disableScrollEvents() {\r\n    window.addEventListener(\"touchmove\", this.onPreventScroll, {\r\n      passive: false,\r\n    });\r\n    window.addEventListener(\"keydown\", this.onPreventKeyScroll);\r\n  }\r\n\r\n  enableScrollEvents() {\r\n    window.removeEventListener(\"touchmove\", this.onPreventScroll);\r\n    window.removeEventListener(\"keydown\", this.onPreventKeyScroll);\r\n  }\r\n\r\n  /**\r\n   * Called on each animation frame.\r\n   * Not used in this controller since scrolling is disabled.\r\n   */\r\n  public onFrame(): void {}\r\n\r\n  /**\r\n   * Prevents scroll via mouse wheel.\r\n   * @param e Wheel event.\r\n   */\r\n  public onWheel(e: any): void {\r\n    e.preventDefault();\r\n  }\r\n\r\n  /**\r\n   * Prevents scroll via native scroll interaction (e.g. touch).\r\n   * @param e Scroll event.\r\n   */\r\n  public onScroll(e: any): void {\r\n    e.preventDefault();\r\n  }\r\n}\r\n","/**\r\n * CSS class names applied to `<html>` element based on scroll direction.\r\n */\r\nexport const SCROLL_CLASS_NAMES = {\r\n  SCROLL_FORWARD: \"-scroll-forward\",\r\n  SCROLL_BACKWARD: \"-scroll-backward\",\r\n  SCROLLING_FORWARD: \"-scrolling-forward\",\r\n  SCROLLING_BACKWARD: \"-scrolling-backward\",\r\n} as const;\r\n","import { SCROLL_CLASS_NAMES } from \"../../models/scroll/ScrollHTMLClass\";\r\nimport { StringContext } from \"../StringContext\";\r\nimport { ScrollController } from \"./ScrollController\";\r\n\r\n/**\r\n * Smooth scroll controller with delta-based acceleration and direction tracking.\r\n * Handles wheel events and scroll position updates with smooth interpolation.\r\n */\r\nexport class StringScrollSmooth extends ScrollController {\r\n  /**\r\n   * Unique identifier for this scroll controller type.\r\n   * Used for selection and debug purposes.\r\n   */\r\n  public readonly name: string = \"smooth\";\r\n\r\n  /**\r\n   * Whether the user has manually scrolled using the native scrollbar.\r\n   * When true, the scroll position is directly synced from DOM on next frame.\r\n   */\r\n  private isScrollbarManipulation = false;\r\n\r\n  /**\r\n   * Current internal force applied to the scroll target.\r\n   * Calculated from accumulated scroll impulse and acceleration.\r\n   */\r\n  private scrollForce: number = 0;\r\n\r\n  /**\r\n   * Latest raw scroll impulse received from the wheel event (`deltaY`).\r\n   * Temporarily stored for direction and boundary checks.\r\n   */\r\n  private wheelImpulse: number = 0;\r\n\r\n  /**\r\n   * Scroll position from the previous frame.\r\n   * Used to detect actual movement and trigger updates only when needed.\r\n   */\r\n  private previousCurrent: number = 0;\r\n\r\n  /**\r\n   * Minimum velocity threshold below which scrolling is considered stopped.\r\n   * Prevents micro-movements from continuing infinite smooth scroll.\r\n   */\r\n  private readonly velocityThreshold = 0.1;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n  }\r\n\r\n  /**\r\n   * Handles scroll direction changes and toggles CSS classes accordingly.\r\n   * @param newDirection `true` if scrolling down, `false` if up.\r\n   */\r\n  private updateScrollDirection(newDirection: boolean) {\r\n    this.isLastBottomScrollDirection = newDirection;\r\n    if (this.isBottomScrollDirection === null) {\r\n      this.isBottomScrollDirection = newDirection;\r\n      return;\r\n    }\r\n    this.context.data.scroll.isScrollingDown = newDirection;\r\n    this.onChangeDirection();\r\n\r\n    this.context.events.emit(`scroll:direction:change`, this.context.data.scroll.isScrollingDown);\r\n\r\n    if (this.context.settings[\"global-class\"]) {\r\n      document.documentElement.classList.toggle(SCROLL_CLASS_NAMES.SCROLLING_FORWARD, newDirection);\r\n      document.documentElement.classList.toggle(\r\n        SCROLL_CLASS_NAMES.SCROLLING_BACKWARD,\r\n        !newDirection\r\n      );\r\n      document.documentElement.classList.toggle(SCROLL_CLASS_NAMES.SCROLL_FORWARD, newDirection);\r\n      document.documentElement.classList.toggle(SCROLL_CLASS_NAMES.SCROLL_BACKWARD, !newDirection);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Immediately stops scrolling and resets all deltas and directions.\r\n   */\r\n  public stopScroll(): void {\r\n    this.context.data.scroll.lerped = 0;\r\n    this.context.data.scroll.delta = 0;\r\n    this.context.data.scroll.target = this.context.data.scroll.current;\r\n    this.isProg = false;\r\n    this.onCalcUpdate();\r\n    document.documentElement.classList.remove(\r\n      SCROLL_CLASS_NAMES.SCROLLING_BACKWARD,\r\n      SCROLL_CLASS_NAMES.SCROLLING_FORWARD\r\n    );\r\n    this.isBottomScrollDirection = null;\r\n  }\r\n\r\n  /**\r\n   * Called on each animation frame to apply lerped scroll logic.\r\n   */\r\n  public onFrame(): void {\r\n    if (this.isScrollbarManipulation) {\r\n      this.isScrollbarManipulation = false;\r\n      this.context.data.scroll.current = this.context.data.scroll.elementContainer.scrollTop;\r\n      this.context.data.scroll.target = this.context.data.scroll.elementContainer.scrollTop;\r\n      this.context.data.scroll.transformedCurrent =\r\n        this.context.data.scroll.current * this.context.data.viewport.transformScale;\r\n      return;\r\n    }\r\n\r\n    if (this.context.data.scroll.delta !== 0) {\r\n      this.scrollForce = this.context.data.scroll.delta * this.context.data.scroll.speedAccelerate;\r\n\r\n      this.context.data.scroll.target = Math.min(\r\n        Math.max(0, this.context.data.scroll.target + this.scrollForce),\r\n        this.context.data.scroll.bottomPosition\r\n      );\r\n      this.context.data.scroll.delta -= this.scrollForce;\r\n\r\n      this.context.data.scroll.lerped =\r\n        (this.context.data.scroll.target - this.context.data.scroll.current) *\r\n        this.context.data.scroll.speed;\r\n\r\n      const absVelocity = Math.abs(this.context.data.scroll.lerped);\r\n      if (this.context.data.scroll.lerped > 0) {\r\n        this.context.data.scroll.current = Math.ceil(\r\n          this.context.data.scroll.current + this.context.data.scroll.lerped\r\n        );\r\n      } else {\r\n        this.context.data.scroll.current = Math.floor(\r\n          this.context.data.scroll.current + this.context.data.scroll.lerped\r\n        );\r\n      }\r\n\r\n      this.context.data.scroll.transformedCurrent =\r\n        this.context.data.scroll.current * this.context.data.viewport.transformScale;\r\n      this.updateScrollDirection(this.context.data.scroll.lerped > 0);\r\n\r\n      if (absVelocity < this.velocityThreshold) {\r\n        this.stopScroll();\r\n        this.onScrollStop();\r\n      } else {\r\n        this.isProg = true;\r\n        if (this.previousCurrent !== this.context.data.scroll.current) {\r\n          this.previousCurrent = this.context.data.scroll.current;\r\n          this.onCalcUpdate();\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles user wheel input to accumulate scroll delta.\r\n   * @param e The WheelEvent from the browser.\r\n   */\r\n  public onWheel(e: WheelEvent): void {\r\n    if (e.deltaY !== 0) {\r\n      e.preventDefault();\r\n    }\r\n\r\n    this.wheelImpulse = e.deltaY;\r\n    if (this.wheelImpulse === 0) return;\r\n\r\n    if (this.context.data.scroll.delta === 0) {\r\n      this.onScrollStart();\r\n    }\r\n\r\n    const scrollDirection = Math.sign(this.wheelImpulse);\r\n    const atTop = this.context.data.scroll.target === 0 && scrollDirection < 0;\r\n    const atBottom =\r\n      this.context.data.scroll.target === this.context.data.scroll.bottomPosition &&\r\n      scrollDirection > 0;\r\n\r\n    if (atTop || atBottom) return;\r\n    this.context.data.scroll.delta += this.wheelImpulse;\r\n  }\r\n\r\n  /**\r\n   * Detects native scrollbar manipulation when smooth scroll is idle.\r\n   * @param e Scroll event.\r\n   */\r\n  public onScroll(e: Event): void {\r\n    if (!this.isProg) {\r\n      this.isScrollbarManipulation = true;\r\n    }\r\n  }\r\n\r\n  public scrollTo(position: number) {\r\n    this.context.data.scroll.target = position;\r\n    this.context.data.scroll.delta = 1;\r\n  }\r\n}\r\n","import { ScrollMarkRule } from \"../../models/scroll/ScrollTriggerRule\";\r\nimport { ScrollMode } from \"../../states/ScrollState\";\r\nimport { ScrollController } from \"../controllers/ScrollController\";\r\nimport { StringScrollDefault } from \"../controllers/StringScrollDefault\";\r\nimport { StringScrollDisable } from \"../controllers/StringScrollDisable\";\r\nimport { StringScrollSmooth } from \"../controllers/StringScrollSmooth\";\r\nimport { StringContext } from \"../StringContext\";\r\n\r\n/**\r\n * Handles scroll engine setup and switching logic.\r\n * Synchronizes scroll modes with the centralized ScrollState inside StringContext.\r\n */\r\nexport class ScrollManager {\r\n  private modes: Map<ScrollMode, ScrollController> = new Map();\r\n\r\n  constructor(private context: StringContext) {\r\n    this.modes.set(\"smooth\", new StringScrollSmooth(context));\r\n    this.modes.set(\"default\", new StringScrollDefault(context));\r\n    this.modes.set(\"disable\", new StringScrollDisable(context));\r\n\r\n    // Initial mode based on screen width\r\n    this.updateResponsiveMode();\r\n  }\r\n\r\n  /**\r\n   * Manually sets the scroll mode for mobile devices.\r\n   * @param mode The scroll mode: 'smooth', 'default', or 'disable'.\r\n   */\r\n  public setMobileMode(mode: ScrollMode): void {\r\n    this.context.data.scroll.modeMobile = mode;\r\n    this.updateResponsiveMode();\r\n  }\r\n\r\n  /**\r\n   * Manually sets the scroll mode for desktop devices.\r\n   * @param mode The scroll mode: 'smooth', 'default', or 'disable'.\r\n   */\r\n  public setDesktopMode(mode: ScrollMode): void {\r\n    this.context.data.scroll.modeDesktop = mode;\r\n    this.updateResponsiveMode();\r\n  }\r\n\r\n  /**\r\n   * Automatically switches scroll mode based on screen width.\r\n   * Call this inside your resize handler.\r\n   */\r\n  public updateResponsiveMode(): void {\r\n    const isMobile = window.innerWidth < 1024;\r\n    const newMode = isMobile\r\n      ? this.context.data.scroll.modeMobile\r\n      : this.context.data.scroll.modeDesktop;\r\n\r\n    this.setMode(newMode);\r\n  }\r\n\r\n  public updatePosition(): void {\r\n    this.modes.forEach((engine) => {\r\n      engine.onCalcUpdate();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets the current scroll mode and updates the active scroll engine.\r\n   * @param mode The scroll mode to activate.\r\n   */\r\n  public setMode(mode: ScrollMode): void {\r\n    if (!this.modes.has(mode)) {\r\n      console.warn(`[ScrollManager] Unknown scroll mode: ${mode}`);\r\n      return;\r\n    }\r\n    this.get().enableScrollEvents();\r\n    this.context.data.scroll.mode = mode;\r\n    this.get().disableScrollEvents();\r\n  }\r\n\r\n  /**\r\n   * Returns the currently active scroll engine based on state.\r\n   */\r\n  public get(): ScrollController {\r\n    return this.modes.get(this.context.data.scroll.mode)!;\r\n  }\r\n\r\n  /**\r\n   * Returns all available scroll engine instances.\r\n   */\r\n  public getEngines(): Map<ScrollMode, ScrollController> {\r\n    return this.modes;\r\n  }\r\n\r\n  /**\r\n   * Calls `onFrame()` on the current scroll engine.\r\n   */\r\n  public onFrame(): void {\r\n    this.get().onFrame();\r\n  }\r\n\r\n  /**\r\n   * Forwards native scroll event to the current scroll engine.\r\n   * @param e The scroll event.\r\n   */\r\n  public onScroll(e: Event): void {\r\n    this.get().onScroll(e);\r\n  }\r\n\r\n  /**\r\n   * Forwards wheel event to the current scroll engine.\r\n   * @param e The wheel event.\r\n   */\r\n  public onWheel(e: WheelEvent): void {\r\n    this.get().onWheel(e);\r\n  }\r\n\r\n  /**\r\n   * Subscribes lifecycle event handlers to all scroll engines.\r\n   * @param events Scroll lifecycle callbacks.\r\n   */\r\n  public bindEvents(events: {\r\n    onScrollStart: () => void;\r\n    onScrollStop: () => void;\r\n    onDirectionChange: () => void;\r\n  }) {\r\n    this.modes.forEach((engine) => {\r\n      engine.onScrollStart = events.onScrollStart;\r\n      engine.onScrollStop = events.onScrollStop;\r\n      engine.onChangeDirection = events.onDirectionChange;\r\n    });\r\n  }\r\n\r\n  public addScrollMark(rule: ScrollMarkRule) {\r\n    this.modes.forEach((engine) => {\r\n      engine.addScrollMark(rule);\r\n    });\r\n  }\r\n  public removeScrollMark(id: string) {\r\n    this.modes.forEach((engine) => {\r\n      engine.removeScrollMark(id);\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Reactive cursor data for raw, target, smoothed and step deltas.\r\n */\r\nexport class CursorState {\r\n  /**\r\n   * Target X position of the cursor (e.g., from `mousemove`)\r\n   */\r\n  targetX: number = 0;\r\n\r\n  /**\r\n   * Target Y position of the cursor.\r\n   */\r\n  targetY: number = 0;\r\n\r\n  /**\r\n   * Smoothed X position after applying lerp.\r\n   */\r\n  smoothedX: number = 0;\r\n\r\n  /**\r\n   * Smoothed Y position after applying lerp.\r\n   */\r\n  smoothedY: number = 0;\r\n\r\n  /**\r\n   * Delta step between current and target X (used internally for lerp).\r\n   */\r\n  stepX: number = 0;\r\n\r\n  /**\r\n   * Delta step between current and target Y.\r\n   */\r\n  stepY: number = 0;\r\n\r\n  /**\r\n   * Velocity in X direction, calculated from smoothed position.\r\n   */\r\n  velocityX: number = 0;\r\n\r\n  /**\r\n   * Velocity in Y direction, calculated from smoothed position.\r\n   */\r\n  velocityY: number = 0;\r\n}\r\n","/**\r\n * Global Three.js or rendering context reference.\r\n */\r\nexport class RenderState {\r\n  /** Instance of Three.js or another render context */\r\n  threeInstance: any = null\r\n}\r\n","export type ScrollDirection = 'vertical' | 'horizontal'\r\nexport type ScrollMode = 'smooth' | 'disable' | 'default'\r\n\r\n/**\r\n * Describes current scroll-related state for all calculations and modules.\r\n */\r\nexport class ScrollState {\r\n  /** Target scroll value — where we want to scroll to (used in smooth scroll) */\r\n  target: number = 0\r\n\r\n  /** Current scroll value (actual scroll position) */\r\n  current: number = 0\r\n\r\n  /** Transformed current scroll value (with transform by scroll container) */\r\n  transformedCurrent: number = 0\r\n\r\n  /** Delta between frames (used for animation / velocity) */\r\n  delta: number = 0\r\n\r\n  /** Interpolated scroll value for smooth transitions */\r\n  lerped: number = 0\r\n\r\n  /** Displacement value (similar to lerped, but used for other animations) */\r\n  displacement: number = 0\r\n\r\n  /** Whether scroll direction is downward */\r\n  isScrollingDown: boolean = false\r\n\r\n  /** Top screen scroll position */\r\n  topPosition: number = 0\r\n\r\n  /** Bottom screen scroll position */\r\n  bottomPosition: number = 0\r\n\r\n  /** Scroll direction (vertical / horizontal) */\r\n  direction: ScrollDirection = 'vertical'\r\n\r\n  /** Scroll container element */\r\n  elementContainer: HTMLElement = document.documentElement\r\n\r\n  /** Scroll container element */\r\n  scrollContainer: HTMLElement | Window = window\r\n\r\n  /** Scroll container element */\r\n  container: HTMLElement = document.body\r\n\r\n  /**\r\n   * Currently active scroll mode.\r\n   * Can be 'smooth', 'default', or 'disable'.\r\n   */\r\n  mode: ScrollMode = 'smooth'\r\n\r\n  /**\r\n   * Scroll mode to use on mobile devices.\r\n   * Can be 'smooth', 'default', or 'disable'.\r\n   */\r\n  modeMobile: ScrollMode = 'smooth'\r\n\r\n  /**\r\n   * Scroll mode to use on desktop devices.\r\n   * Can be 'smooth', 'default', or 'disable'.\r\n   */\r\n  modeDesktop: ScrollMode = 'smooth'\r\n\r\n  /**\r\n   * Base scroll speed used for calculating smooth scrolling.\r\n   * Typically a small value between 0 and 1.\r\n   */\r\n  speed: number = 0.1\r\n\r\n  /**\r\n   * Acceleration factor used for scroll easing or velocity-based animations.\r\n   * Also typically a value between 0 and 1.\r\n   */\r\n  speedAccelerate: number = 0.25\r\n}\r\n","export class SystemState {\n  fpsTracker: boolean = false;\n  positionTracker: boolean = false;\n}\n","/**\r\n * Represents the time-related state of the current and previous animation frames.\r\n * \r\n * Useful for calculating delta time, total elapsed time, and implementing\r\n * time-based animations or physics.\r\n */\r\nexport class TimeState {\r\n  /**\r\n   * Timestamp of the current animation frame in milliseconds.\r\n   * This value is typically obtained via `performance.now()`.\r\n   */\r\n  now: number = 0;\r\n\r\n  /**\r\n   * Timestamp of the previous animation frame in milliseconds.\r\n   */\r\n  previous: number = 0;\r\n\r\n  /**\r\n   * Time difference between the current and previous frames in milliseconds.\r\n   * Commonly used to calculate animation progress.\r\n   */\r\n  delta: number = 0;\r\n\r\n  /**\r\n   * Total time elapsed since the start of the animation or system in milliseconds.\r\n   */\r\n  elapsed: number = 0;\r\n}\r\n","/**\r\n * Describes current viewport size and scaling.\r\n */\r\nexport class ViewportState {\r\n  /** Width of the visible window */\r\n  windowWidth: number = 0\r\n\r\n  /** Height of the visible window */\r\n  windowHeight: number = 0\r\n\r\n  /** Full scroll width (content width inside scroll container) */\r\n  contentWidth: number = 0\r\n\r\n  /** Full scroll height (content height inside scroll container) */\r\n  contentHeight: number = 0\r\n\r\n  /** Screen scale ratio for width (e.g. device pixel ratio or zoom level) */\r\n  scaleWidth: number = 1\r\n\r\n  /** Screen scale ratio for height */\r\n  scaleHeight: number = 1\r\n\r\n  transformScale: number = 1\r\n\r\n  baseRem: number = 16\r\n}\r\n","import { CursorState } from \"../states/CursorState\";\r\nimport { RenderState } from \"../states/RenderState\";\r\nimport { ScrollState } from \"../states/ScrollState\";\r\nimport { SystemState } from \"../states/SystemState\";\r\nimport { TimeState } from \"../states/TimeState\";\r\nimport { ViewportState } from \"../states/ViewportState\";\r\n\r\n/**\r\n * Container for global dynamic state used throughout the string-tune system.\r\n * Provides access to live scroll, viewport, cursor, and render states,\r\n * which are updated each frame and shared across modules and tools.\r\n */\r\nexport class StringData {\r\n  /**\r\n   * Scroll-related state object.\r\n   * Contains live values like `target`, `current`, `delta`, `direction`, and more.\r\n   * Used for scroll-based animations, transitions, and effects.\r\n   */\r\n  scroll = new ScrollState();\r\n\r\n  /**\r\n   * Viewport-related state object.\r\n   * Holds dimensions like window size, content size, aspect ratios, and more.\r\n   * Useful for layout calculations, unit parsing, and element positioning.\r\n   */\r\n  viewport = new ViewportState();\r\n\r\n  /**\r\n   * Cursor-related state object.\r\n   * Tracks cursor position, velocity, movement, and derived values.\r\n   * Can be used for pointer interactions, proximity effects, and hover states.\r\n   */\r\n  cursor = new CursorState();\r\n\r\n  /**\r\n   * Render-related state object.\r\n   * Stores data related to rendering context (e.g. WebGL, Three.js),\r\n   * such as shared materials, textures, or active render frame data.\r\n   */\r\n  render = new RenderState();\r\n\r\n  /**\r\n   * Time-related state object.\r\n   * Tracks frame timings, including current timestamp, delta between frames,\r\n   * and total elapsed time since animation start.\r\n   * Useful for time-based animations, easing, frame consistency, and syncing logic.\r\n   */\r\n  time = new TimeState();\r\n\r\n  system = new SystemState();\r\n}\r\n","export interface ModuleLifecyclePermissionsItem {\n  rebuild: {\n    width: boolean;\n    height: boolean;\n    scrollHeight: boolean;\n  };\n}\nexport class ModuleLifecyclePermissions {\n  desktop: ModuleLifecyclePermissionsItem = {\n    rebuild: {\n      width: true,\n      height: true,\n      scrollHeight: true,\n    },\n  };\n  mobile: ModuleLifecyclePermissionsItem = {\n    rebuild: {\n      width: true,\n      height: true,\n      scrollHeight: true,\n    },\n  };\n}\n","import { IStringModule } from \"./IStringModule\";\r\nimport { StringObject } from \"../objects/StringObject\";\r\nimport { StringMirrorObject } from \"../objects/StringMirrorObject\";\r\nimport { StringToolsContainer } from \"./StringToolsContainer\";\r\nimport { StringData } from \"./StringData\";\r\nimport { AttributeType } from \"../models/attribute/AttributeType\";\r\nimport { StringContext } from \"./StringContext\";\r\nimport { EventManager } from \"./managers/EventManager\";\r\nimport { AttributeMapping } from \"../models/attribute/AttributeMapping\";\r\nimport { ModuleLifecyclePermissions } from \"../models/IModuleLifecyclePermissions\";\r\nimport { CenterCache } from \"./managers/CenterCache\";\r\nimport { HoverTracker } from \"./managers/HoverTracker\";\r\n\r\n/**\r\n * Base class for a module used in the string-tune system.\r\n * Extend this class to create custom modules that respond to scroll, resize, input, etc.\r\n */\r\nexport class StringModule implements IStringModule {\r\n  /**\r\n   * List of attribute names this module should automatically read\r\n   * from the DOM element and assign to the object properties.\r\n   * Example: [\"offset-top\", \"offset-bottom\"]\r\n   */\r\n  protected attributesToMap: AttributeMapping[];\r\n\r\n  /**\r\n   * A map that associates string keys with `StringObject` instances.\r\n   * This map is used to manage and track `StringObject` instances on a page.\r\n   */\r\n  protected objectMapOnPage: Map<string, StringObject> = new Map();\r\n\r\n  /**\r\n   * A protected array that holds the collection of `StringObject` instances\r\n   * currently present on the page.\r\n   */\r\n  protected objectsOnPage: StringObject[] = [];\r\n\r\n  /**\r\n   * A map of all entered objects by their unique ID.\r\n   */\r\n  protected objectMap: Map<string, StringObject> = new Map();\r\n\r\n  /**\r\n   * A flat array of all connected objects.\r\n   */\r\n  protected objects: StringObject[] = [];\r\n\r\n  /**\r\n   * The HTML attribute key that identifies objects this module is responsible for.\r\n   */\r\n  protected htmlKey: string = \"\";\r\n\r\n  /**\r\n   * Module type ID used internally to categorize module behavior.\r\n   */\r\n  protected _type: number = 1;\r\n\r\n  /**\r\n   * Returns the type of the module.\r\n   * Type 1 = core module, type 2 = UI module.\r\n   */\r\n  public get type(): number {\r\n    return this._type;\r\n  }\r\n\r\n  /**\r\n   * Tools container providing utilities for attribute parsing, unit conversion, etc.\r\n   * Acts as a dependency injection hub for core IStringTool implementations.\r\n   */\r\n  protected tools: StringToolsContainer;\r\n\r\n  /**\r\n   * Shared global data object containing scroll state, viewport info, cursor position, etc.\r\n   * Used for calculations within lifecycle hooks like `onScroll`, `onFrame`, and `onResize`.\r\n   */\r\n  protected data: StringData;\r\n\r\n  /**\r\n   * Configuration object specific to the current module.\r\n   * Passed in during module registration or initialization.\r\n   */\r\n  protected settings: Record<string, any>;\r\n\r\n  /**\r\n   * Event hub for communication between modules or systems.\r\n   * Supports custom event emitting, listening, and unsubscription.\r\n   */\r\n  protected events: EventManager;\r\n\r\n  /**\r\n   * Cache for storing and managing object centers.\r\n   */\r\n  protected centers: CenterCache;\r\n\r\n  /**\r\n   * Tracker for managing hover states of objects.\r\n   */\r\n  protected hover: HoverTracker;\r\n\r\n  public permissions: ModuleLifecyclePermissions = new ModuleLifecyclePermissions();\r\n\r\n  constructor(context: StringContext) {\r\n    this.tools = context.tools;\r\n    this.data = context.data;\r\n    this.settings = context.settings;\r\n    this.events = context.events;\r\n    this.centers = context.centers;\r\n    this.hover = context.hover;\r\n\r\n    this.attributesToMap = [\r\n      { key: \"active\", type: \"boolean\", fallback: this.settings[\"active\"] },\r\n      { key: \"fixed\", type: \"boolean\", fallback: this.settings[\"fixed\"] },\r\n      { key: \"outside-container\", type: \"boolean\", fallback: this.settings[\"outside-container\"] },\r\n      { key: \"repeat\", type: \"boolean\", fallback: this.settings[\"repeat\"] },\r\n      {\r\n        key: \"self-disable\",\r\n        type: \"boolean\",\r\n        fallback: this.settings[\"self-disable\"],\r\n      },\r\n      { key: \"abs\", type: \"boolean\", fallback: this.settings[\"abs\"] },\r\n      { key: \"key\", type: \"string\", fallback: this.settings[\"key\"] },\r\n      {\r\n        key: \"offset-top\",\r\n        type: \"dimension\",\r\n        fallback: this.settings[\"offset-top\"],\r\n      },\r\n      {\r\n        key: \"offset-bottom\",\r\n        type: \"dimension\",\r\n        fallback: this.settings[\"offset-bottom\"],\r\n      },\r\n      {\r\n        key: \"inview-top\",\r\n        type: \"dimension\",\r\n        fallback: this.settings[\"inview-top\"],\r\n      },\r\n      {\r\n        key: \"inview-bottom\",\r\n        type: \"dimension\",\r\n        fallback: this.settings[\"inview-bottom\"],\r\n      },\r\n      {\r\n        key: \"start\",\r\n        type: \"number\",\r\n        fallback: (element: HTMLElement, object: StringObject, boundingRect: DOMRect) => {\r\n          const top = boundingRect.top;\r\n          return (\r\n            Math.floor(top) +\r\n            this.data.scroll.container.scrollTop * this.data.viewport.transformScale\r\n          );\r\n        },\r\n      },\r\n      {\r\n        key: \"end\",\r\n        type: \"number\",\r\n        fallback: (element: HTMLElement, object: StringObject, boundingRect: DOMRect) => {\r\n          const top = boundingRect.top;\r\n          const height = boundingRect.height;\r\n          return top + height - this.data.scroll.transformedCurrent;\r\n        },\r\n      },\r\n      {\r\n        key: \"size\",\r\n        type: \"number\",\r\n        fallback: (element: HTMLElement, object: StringObject, boundingRect: DOMRect) => {\r\n          return boundingRect.height;\r\n        },\r\n      },\r\n      {\r\n        key: \"half-width\",\r\n        type: \"number\",\r\n        fallback: (element: HTMLElement, object: StringObject, boundingRect: DOMRect) => {\r\n          return boundingRect.width / 2;\r\n        },\r\n      },\r\n      {\r\n        key: \"half-height\",\r\n        type: \"number\",\r\n        fallback: (element: HTMLElement, object: StringObject, boundingRect: DOMRect) => {\r\n          return boundingRect.height / 2;\r\n        },\r\n      },\r\n      { key: \"enter-el\", type: \"string\", fallback: this.settings[\"enter-el\"] },\r\n      { key: \"enter-vp\", type: \"string\", fallback: this.settings[\"enter-vp\"] },\r\n      { key: \"exit-el\", type: \"string\", fallback: this.settings[\"exit-el\"] },\r\n      { key: \"exit-vp\", type: \"string\", fallback: this.settings[\"exit-vp\"] },\r\n    ];\r\n  }\r\n\r\n  /**\r\n   * Initializes a `StringObject` by mapping attributes from an HTML element\r\n   * and applying transformations as needed.\r\n   *\r\n   * @param globalId - A unique identifier for the object being initialized.\r\n   * @param object - The `StringObject` instance to be initialized.\r\n   * @param element - The HTML element from which attributes are extracted.\r\n   * @param attributes - A record of additional attributes to be used during initialization.\r\n   *\r\n   * The method performs the following steps:\r\n   * 1. Retrieves the bounding rectangle of the provided HTML element.\r\n   * 2. Iterates over a predefined list of attributes to map.\r\n   * 3. Resolves fallback values for attributes, either from the provided attributes,\r\n   *    settings, or a fallback function.\r\n   * 4. Processes and parses the raw attribute values based on their expected type.\r\n   * 5. Applies optional transformations to the parsed values.\r\n   * 6. Sets the processed attributes as properties on the `StringObject` instance.\r\n   */\r\n  initializeObject(\r\n    globalId: number,\r\n    object: StringObject,\r\n    element: HTMLElement,\r\n    attributes: Record<string, any>\r\n  ): void {\r\n    let boundingRect = this.tools.boundingClientRect.process({ element });\r\n    for (const { key, type, fallback, transform } of this.attributesToMap) {\r\n      const resolvedFallback =\r\n        typeof fallback === \"function\" ? fallback(element, object, boundingRect) : fallback;\r\n      const raw = this.tools.domAttribute.process({\r\n        element,\r\n        key,\r\n        fallback: attributes[key] ?? this.settings[key] ?? resolvedFallback,\r\n      });\r\n\r\n      let parsed = this.parseAttribute(raw, type, {\r\n        element,\r\n        boundingRect,\r\n        viewportHeight: this.data.viewport.windowHeight,\r\n        baseRem: this.data.viewport.baseRem,\r\n      });\r\n\r\n      if (transform) {\r\n        parsed = transform(parsed);\r\n      }\r\n      object.setProperty(key, parsed);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calculates object-specific positions or metrics based on the current layout or scroll state.\r\n   * This method is intended to be overridden in subclasses if the module needs to precompute\r\n   * layout-dependent values (e.g. parallax offsets, trigger zones, distances).\r\n   *\r\n   * @param object The `StringObject` instance whose positions are being calculated.\r\n   * @param windowSize The current window height or width (depending on scroll axis).\r\n   */\r\n  calculatePositions(object: StringObject, windowSize: number) {\r\n    const start = object.getProperty<number>(\"start\");\r\n    const size = object.getProperty<number>(\"size\");\r\n\r\n    const offsetStart = object.getProperty<number>(\"offset-bottom\");\r\n    const offsetEnd = object.getProperty<number>(\"offset-top\");\r\n\r\n    const startElement = object.getProperty(\"enter-el\");\r\n    const startViewport = object.getProperty(\"enter-vp\");\r\n    const endElement = object.getProperty(\"exit-el\");\r\n    const endViewport = object.getProperty(\"exit-vp\");\r\n\r\n    let startPosition = 0;\r\n    let endPosition = 0;\r\n    let startBias = 0;\r\n    let endBias = 0;\r\n\r\n    if (\r\n      (startElement === \"top\" && startViewport === \"top\") ||\r\n      (startElement === \"left\" && startViewport === \"left\")\r\n    ) {\r\n      startBias = -windowSize + 1;\r\n      startPosition = start - offsetStart;\r\n    } else if (\r\n      (startElement === \"top\" && startViewport === \"bottom\") ||\r\n      (startElement === \"left\" && startViewport === \"right\")\r\n    ) {\r\n      startPosition = start - windowSize - offsetStart;\r\n    } else if (\r\n      (startElement === \"bottom\" && startViewport === \"top\") ||\r\n      (startElement === \"right\" && startViewport === \"left\")\r\n    ) {\r\n      startBias = -windowSize - size + 1;\r\n      startPosition = start + size - offsetStart;\r\n    } else if (\r\n      (startElement === \"bottom\" && startViewport === \"bottom\") ||\r\n      (startElement === \"right\" && startViewport === \"right\")\r\n    ) {\r\n      startBias = -size + 1;\r\n      startPosition = start - windowSize + size - offsetStart;\r\n    }\r\n\r\n    // End position calculation\r\n    if (\r\n      (endElement === \"top\" && endViewport === \"top\") ||\r\n      (endElement === \"left\" && endViewport === \"left\")\r\n    ) {\r\n      endBias = -size + 1;\r\n      endPosition = start + offsetEnd;\r\n    } else if (\r\n      (endElement === \"top\" && endViewport === \"bottom\") ||\r\n      (endElement === \"left\" && endViewport === \"right\")\r\n    ) {\r\n      endBias = -windowSize - size + 1;\r\n      endPosition = start - windowSize + offsetEnd;\r\n    } else if (\r\n      (endElement === \"bottom\" && endViewport === \"top\") ||\r\n      (endElement === \"right\" && endViewport === \"left\")\r\n    ) {\r\n      endPosition = start + size + offsetEnd;\r\n    } else if (\r\n      (endElement === \"bottom\" && endViewport === \"bottom\") ||\r\n      (endElement === \"right\" && endViewport === \"right\")\r\n    ) {\r\n      endBias = -windowSize + 1;\r\n      endPosition = start - windowSize + size + offsetEnd;\r\n    }\r\n\r\n    object.setProperty<number>(\"start-bias\", startBias);\r\n    object.setProperty<number>(\"end-bias\", endBias);\r\n\r\n    object.setProperty<number>(\"start-position\", startPosition - this.data.scroll.topPosition);\r\n    object.setProperty<number>(\"end-position\", endPosition - this.data.scroll.topPosition);\r\n    object.setProperty<number>(\"difference-position\", endPosition - startPosition);\r\n\r\n    const inviewTop = object.getProperty<number>(\"inview-top\") ?? 0;\r\n    const inviewBottom = object.getProperty<number>(\"inview-bottom\") ?? 0;\r\n    object.setProperty<number>(\r\n      \"inview-start-position\",\r\n      object.getProperty<number>(\"start-position\") + inviewTop\r\n    );\r\n    object.setProperty<number>(\r\n      \"inview-end-position\",\r\n      object.getProperty<number>(\"end-position\") + inviewBottom\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Parses a raw DOM attribute value into the correct type based on mapping.\r\n   * Handles fallback resolution, transformation, and special units.\r\n   *\r\n   * @param value Raw attribute string from DOM.\r\n   * @param type The expected attribute type (e.g. number, boolean, dimension).\r\n   * @param context Optional helper values like element or viewport size.\r\n   * @returns The parsed and transformed value.\r\n   */\r\n  protected parseAttribute(\r\n    value: string | null,\r\n    type: AttributeType,\r\n    context: {\r\n      element?: HTMLElement;\r\n      boundingRect?: DOMRect;\r\n      viewportHeight?: number;\r\n      baseRem?: number;\r\n    } = {}\r\n  ): any {\r\n    if (value == null) return null;\r\n\r\n    if (typeof type === \"object\" && type.type === \"enum\") {\r\n      return type.values.includes(value) ? value : type.values[0];\r\n    }\r\n\r\n    switch (type) {\r\n      case \"number\":\r\n        return parseFloat(value);\r\n\r\n      case \"boolean\":\r\n        return value === \"\" || value === \"true\";\r\n\r\n      case \"json\":\r\n        try {\r\n          return JSON.parse(value);\r\n        } catch {\r\n          return null;\r\n        }\r\n\r\n      case \"tuple\":\r\n        return value.trim().split(/\\s+/);\r\n\r\n      case \"easing\":\r\n        return this.tools.easingFunction.process({ easing: value });\r\n\r\n      case \"color\":\r\n        return this.tools.colorParser.process({ value: value });\r\n\r\n      case \"dimension\":\r\n        if (value == \"0\") return 0;\r\n        if (\r\n          context.element != null &&\r\n          context.viewportHeight != null &&\r\n          context.baseRem != null &&\r\n          context.boundingRect != null\r\n        ) {\r\n          return this.tools.unitParser.process({\r\n            value,\r\n            element: context.element,\r\n            viewportHeight: context.viewportHeight,\r\n            boundingRect: context.boundingRect,\r\n            baseRem: context.baseRem,\r\n          });\r\n        } else {\r\n          return 0;\r\n        }\r\n\r\n      case \"breakpoint-dimension\":\r\n        if (\r\n          context.element != null &&\r\n          context.viewportHeight != null &&\r\n          context.baseRem != null &&\r\n          context.boundingRect != null\r\n        ) {\r\n          let parsedBreakpoint = value.trim().split(\"|\");\r\n          let breakpoints: Array<{ breakpoint: number; value: number }> = [];\r\n          for (const item of parsedBreakpoint) {\r\n            if (item.includes(\":\")) {\r\n              const [key, val] = item.split(\":\");\r\n              breakpoints.push({\r\n                breakpoint: parseInt(key),\r\n                value: this.tools.unitParser.process({\r\n                  value: `${val}|`,\r\n                  element: context.element,\r\n                  viewportHeight: context.viewportHeight,\r\n                  boundingRect: context.boundingRect,\r\n                  baseRem: context.baseRem,\r\n                }),\r\n              });\r\n            } else {\r\n              breakpoints.push({\r\n                breakpoint: 0,\r\n                value: this.tools.unitParser.process({\r\n                  value: item,\r\n                  element: context.element,\r\n                  viewportHeight: context.viewportHeight,\r\n                  boundingRect: context.boundingRect,\r\n                  baseRem: context.baseRem,\r\n                }),\r\n              });\r\n            }\r\n          }\r\n          return breakpoints;\r\n        }\r\n\r\n      default:\r\n        return value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Determines whether the module should attach to a given object,\r\n   * based on the presence of the module's `htmlKey` in the object keys.\r\n   *\r\n   * @param object The target object to test.\r\n   * @returns `true` if the module can connect, `false` otherwise.\r\n   */\r\n  canConnect(object: StringObject): boolean {\r\n    return object.keys.includes(this.htmlKey);\r\n  }\r\n\r\n  /**\r\n   * Registers the module on a given object, adds the object to internal list,\r\n   * and triggers connection logic.\r\n   *\r\n   * @param object The object to connect to.\r\n   */\r\n  connectObject(object: StringObject): void {\r\n    object.connect(this);\r\n    this.onObjectConnected(object);\r\n  }\r\n\r\n  /**\r\n   * Registers the object internally when it enters the module’s scope.\r\n   */\r\n  enterObject(id: string, object: StringObject): void {\r\n    if (!this.objectMap.has(id)) {\r\n      this.objectMap.set(id, object);\r\n      this.objects.push(object);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unregisters the object when it leaves the module’s scope.\r\n   */\r\n  exitObject(id: string): void {\r\n    const object = this.objectMap.get(id);\r\n    if (!object) return;\r\n\r\n    this.objectMap.delete(id);\r\n\r\n    const index = this.objects.indexOf(object);\r\n    if (index !== -1) {\r\n      this.objects.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a `StringObject` to the internal collections if it does not already exist.\r\n   *\r\n   * @param id - The unique identifier for the `StringObject`.\r\n   * @param object - The `StringObject` to be added.\r\n   *\r\n   * @remarks\r\n   * This method ensures that the object is added to both `objectMapOnPage` and\r\n   * `objectsOnPage` only if the `id` is not already present in `objectMapOnPage`.\r\n   */\r\n  addObject(id: string, object: StringObject): void {\r\n    if (!this.objectMapOnPage.has(id)) {\r\n      this.objectMapOnPage.set(id, object);\r\n      this.objectsOnPage.push(object);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes an object from the page by its unique identifier.\r\n   *\r\n   * This method performs the following steps:\r\n   * 1. Retrieves the object associated with the given `id` from `objectMapOnPage`.\r\n   * 2. If the object is not found, the method exits early.\r\n   * 3. Deletes the object from `objectMapOnPage`.\r\n   * 4. Finds the index of the object in the `objectsOnPage` array.\r\n   * 5. If the object exists in the array, it is removed using `splice`.\r\n   *\r\n   * @param id - The unique identifier of the object to be removed.\r\n   */\r\n  removeObject(id: string): void {\r\n    const object = this.objectMapOnPage.get(id);\r\n    if (!object) return;\r\n\r\n    this.objectMapOnPage.delete(id);\r\n\r\n    const index = this.objectsOnPage.indexOf(object);\r\n    if (index !== -1) {\r\n      this.objectsOnPage.splice(index, 1);\r\n    }\r\n    this.onObjectDisconnected(object);\r\n  }\r\n\r\n  /**\r\n   * Called when an object is connected. Can be overridden to apply initial styles or logic.\r\n   * @param object The connected object.\r\n   */\r\n  onObjectConnected(object: StringObject): void {}\r\n\r\n  /**\r\n   * Called when an object is disconnected. Can be overridden to clean up styles or logic.\r\n   * @param object The disconnected object.\r\n   */\r\n  onObjectDisconnected(object: StringObject): void {}\r\n\r\n  /**\r\n   * Applies a style or callback to both the main element and all its connected elements.\r\n   *\r\n   * @param object The object whose elements to update.\r\n   * @param applyFn The function that receives an HTMLElement and performs any update.\r\n   */\r\n  protected applyToElementAndConnects(\r\n    object: StringObject,\r\n    applyFn: (el: HTMLElement) => void,\r\n    copyFn: (el: HTMLElement, mirror?: StringMirrorObject) => void = applyFn\r\n  ) {\r\n    if (object.getProperty(\"self-disable\") !== true) {\r\n      applyFn(object.htmlElement);\r\n    }\r\n    object.mirrorObjects.forEach((mirror) => copyFn(mirror.htmlElement, mirror));\r\n  }\r\n\r\n  /**\r\n   * Cleans up internal state and detaches the module from the system.\r\n   */\r\n  destroy(): void {\r\n    this.objects = [];\r\n    this.objectMap = new Map();\r\n  }\r\n\r\n  // ───────────────────────────────\r\n  // Lifecycle Hooks\r\n  // ───────────────────────────────\r\n\r\n  /** Called once when the module is initialized. */\r\n  onInit(): void {}\r\n\r\n  /** Called on each frame with current scroll and state data. */\r\n  onFrame(data: StringData): void {}\r\n\r\n  onMutate(data: StringData): void {}\r\n  onScrollMeasure(data: StringData): void {}\r\n  onMouseMoveMeasure(data: StringData): void {}\r\n  /** Called when the window or layout is resized. */\r\n  onResize(): void {}\r\n\r\n  /** Called when the layout is resized width. */\r\n  onResizeWidth(): void {}\r\n\r\n  /** Called when scroll position changes. */\r\n  onScroll(data: StringData): void {}\r\n\r\n  /** Called when user changed scroll diraction. */\r\n  onDirectionChange(): void {}\r\n\r\n  /** Called when user starts scrolling. */\r\n  onScrollStart(): void {}\r\n\r\n  /** Called when user stops scrolling. */\r\n  onScrollStop(): void {}\r\n\r\n  /** Called when scroll direction changes (e.g., up ↔ down). */\r\n  onScrollDirectionChange(): void {}\r\n\r\n  /** Called when scroll axis changes (vertical ↔ horizontal). */\r\n  onAxisChange(): void {}\r\n\r\n  /** Called when device type changes (e.g., desktop ↔ mobile). */\r\n  onDeviceChange(): void {}\r\n\r\n  /** Called when scroll-related system settings or parameters change. */\r\n  onScrollConfigChange(): void {}\r\n\r\n  /** Called when scroll-related system settings or parameters change. */\r\n  onSettingsChange(): void {}\r\n\r\n  /** Called when the DOM is rebuilt, such as after a major mutation. */\r\n  onDOMRebuild(): void {}\r\n\r\n  /** Called on every mouse movement. */\r\n  onMouseMove(event: MouseEvent): void {}\r\n\r\n  /** Called on wheel input (independent of scroll). */\r\n  onWheel(event: WheelEvent): void {}\r\n\r\n  /**\r\n   * Called when DOM elements are added or removed.\r\n   */\r\n  onDOMMutate(added: NodeList, removed: NodeList): void {}\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\n\r\n/**\r\n * Input for `BoundingClientRectTool`.\r\n */\r\ninterface BoundingClientRectInput {\r\n  /** The DOM element to retrieve bounding rect from. */\r\n  element: HTMLElement\r\n}\r\n\r\n/**\r\n * Tool for accessing `getBoundingClientRect()` in a consistent, testable way.\r\n */\r\nexport default class BoundingClientRectTool\r\n  implements IStringTool<BoundingClientRectInput, DOMRect>\r\n{\r\n  /**\r\n   * @returns The bounding client rect of the provided element.\r\n   */\r\n  process({ element }: BoundingClientRectInput): DOMRect {\r\n    return element.getBoundingClientRect()\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\n\r\ninterface DOMAttributeInput {\r\n  element: HTMLElement\r\n  key: string // for example: \"offset-tom\"\r\n  fallback?: string | null\r\n}\r\n\r\nexport default class DOMAttributeTool implements IStringTool<DOMAttributeInput, string | null> {\r\n  /**\r\n   * Retrieves the value of either `string-${key}` or `data-string-${key}` attribute.\r\n   *\r\n   * @example key = \"offset-tom\" → tries:\r\n   *   - element.getAttribute(\"string-offset-tom\")\r\n   *   - element.getAttribute(\"data-string-offset-tom\")\r\n   */\r\n  process({ element, key, fallback = null }: DOMAttributeInput): string | null {\r\n    return (\r\n      element.getAttribute(`string-${key}`) ??\r\n      element.getAttribute(`data-string-${key}`) ??\r\n      fallback\r\n    )\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\n\r\n/**\r\n * Input for retrieving a value from a key-value object or dataset-like structure.\r\n */\r\ninterface RecordAttributeInput {\r\n  /** Source object to read from (e.g. dataset or plain record). */\r\n  record: Record<string, any>\r\n\r\n  /** Key to look up (without `\"data-\"` prefix). */\r\n  name: string\r\n\r\n  /** Fallback value if both keys are missing. */\r\n  fallback?: any\r\n}\r\n\r\n/**\r\n * Retrieves a value from an object or dataset-like structure.\r\n * Tries `record[name]` first, then `record[\"data-\" + name]`, or returns fallback.\r\n */\r\nexport default class RecordAttributeTool implements IStringTool<RecordAttributeInput, any> {\r\n  /**\r\n   * @returns Value from the record or fallback.\r\n   */\r\n  process({ record, name, fallback = null }: RecordAttributeInput): any {\r\n    return (\r\n      record[name] ??\r\n      record[`data-${name}`] ??\r\n      fallback\r\n    )\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\n\r\n/**\r\n * Input for removing transform effects from an element's bounding box.\r\n */\r\ninterface TransformNullifyInput {\r\n  /** The DOM element whose CSS transform should be nullified. */\r\n  element: HTMLElement\r\n}\r\n\r\n/**\r\n * Output with corrected bounding box values.\r\n */\r\ninterface TransformNullifyOutput {\r\n  /** Top position without transform effects. */\r\n  top: number\r\n\r\n  /** Left position without transform effects. */\r\n  left: number\r\n\r\n  /** Width without transform scaling. */\r\n  width: number\r\n\r\n  /** Height without transform scaling. */\r\n  height: number\r\n}\r\n\r\n/**\r\n * Computes the true bounding box of a DOM element,\r\n * nullifying CSS `transform: matrix(...)` effects.\r\n */\r\nexport default class TransformNullifyTool\r\n  implements IStringTool<TransformNullifyInput, TransformNullifyOutput>\r\n{\r\n  /**\r\n   * @returns Element position and size without transform influence.\r\n   */\r\n  process({ element }: TransformNullifyInput): TransformNullifyOutput {\r\n    const rect = element.getBoundingClientRect()\r\n    const matrix = getComputedStyle(element).transform\r\n\r\n    const values = matrix\r\n      .match(/-?[\\d.]+/g)\r\n      ?.map(parseFloat) ?? []\r\n\r\n    if (values.length === 6) {\r\n      const [a, b, c, d, e, f] = values\r\n      const det = a * d - b * c\r\n\r\n      return {\r\n        width: rect.width / (a || 1),\r\n        height: rect.height / (d || 1),\r\n        left: (rect.left * d - rect.top * c + c * f - e * d) / det,\r\n        top: (-rect.left * b + rect.top * a + e * b - a * f) / det,\r\n      }\r\n    }\r\n\r\n    return rect\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\nimport TransformNullifyTool from \"./TransformNullifyTool\"\r\n\r\n/**\r\n * Input for calculating the position of an element relative to a container.\r\n */\r\ninterface RelativePositionInput {\r\n  /** The DOM element whose position should be calculated. */\r\n  element: HTMLElement\r\n\r\n  /** Optional container to measure against. Defaults to `document.body`. */\r\n  container?: HTMLElement\r\n}\r\n\r\n/**\r\n * Output: relative position in pixels.\r\n */\r\ninterface RelativePositionOutput {\r\n  /** Distance from the top of the container. */\r\n  top: number\r\n\r\n  /** Distance from the left of the container. */\r\n  left: number\r\n}\r\n\r\n/**\r\n * Calculates an element's position relative to a container.\r\n * Uses `TransformNullifyTool` to account for CSS transforms.\r\n */\r\nexport default class RelativePositionTool\r\n  implements IStringTool<RelativePositionInput, RelativePositionOutput>\r\n{\r\n  constructor(\r\n    /** Optional tool for CSS transform-neutral measurements. */\r\n    private transformTool = new TransformNullifyTool()\r\n  ) {}\r\n\r\n  /**\r\n   * @returns Relative top/left position of element within container.\r\n   */\r\n  process({ element, container = document.body }: RelativePositionInput): RelativePositionOutput {\r\n    let containerRect: DOMRect\r\n    try {\r\n      containerRect = container.getBoundingClientRect()\r\n    } catch {\r\n      containerRect = document.body.getBoundingClientRect()\r\n    }\r\n\r\n    const elRect = this.transformTool.process({ element })\r\n\r\n    return {\r\n      top: elRect.top - containerRect.top,\r\n      left: elRect.left - containerRect.left,\r\n    }\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\n\r\ninterface LerpInput {\r\n  /** Starting value of the interpolation. */\r\n  from: number\r\n\r\n  /** Target value to interpolate towards. */\r\n  to: number\r\n\r\n  /** Interpolation progress between 0 (start) and 1 (end). */\r\n  progress: number\r\n}\r\n\r\nexport default class LerpTool implements IStringTool<LerpInput, number> {\r\n  /**\r\n   * Calculates the linear interpolation between two values.\r\n   * @returns Interpolated value.\r\n   */\r\n  process({ from, to, progress }: LerpInput): number {\r\n    return (to - from) * progress\r\n  }\r\n}\r\n\r\n","import { IStringTool } from \"../core/IStringTool\";\r\n\r\n/**\r\n * Input for parsing unit-based strings into numeric pixel values.\r\n */\r\ninterface UnitParserInput {\r\n  /** Unit string, e.g. `\"20px\"`, `\"50%\"`, `\"1.5rem\"`, or `\"selfHeight\"` */\r\n  value: string;\r\n\r\n  /** DOM element used for `\"selfHeight\"` calculation */\r\n  element: HTMLElement;\r\n\r\n  /** Viewport height in pixels (for percentage conversion) */\r\n  viewportHeight: number;\r\n\r\n  /** Root font size in pixels (for rem conversion) */\r\n  baseRem: number;\r\n\r\n  boundingRect: DOMRect;\r\n}\r\n\r\n/**\r\n * Converts unit-based strings to numeric pixel values.\r\n * Supports `px`, `%`, `rem`, and `\"selfHeight\"` keyword. Handles negatives.\r\n */\r\nexport default class UnitParserTool implements IStringTool<UnitParserInput, number> {\r\n  /**\r\n   * @returns Numeric value in pixels (positive or negative).\r\n   */\r\n  process({ value, element, viewportHeight, baseRem, boundingRect }: UnitParserInput): number {\r\n    const parts = value\r\n      .split(\"|\")\r\n      .map((s) => s.trim())\r\n      .filter(Boolean);\r\n\r\n    let sum = 0;\r\n    for (const part of parts) {\r\n      let v = part;\r\n      let isNegative = false;\r\n      if (v.startsWith(\"-\")) {\r\n        isNegative = true;\r\n        v = v.slice(1);\r\n      }\r\n      let result = 0;\r\n      if (v === \"selfHeight\") {\r\n        result = element.offsetHeight;\r\n      } else if (v.endsWith(\"px\")) {\r\n        result = parseFloat(v);\r\n      } else if (v.endsWith(\"%\")) {\r\n        result = (parseFloat(v) / 100) * viewportHeight;\r\n      } else if (v.endsWith(\"rem\")) {\r\n        result = parseFloat(v) * baseRem;\r\n      } else if (v.endsWith(\"sh\")) {\r\n        result = (parseFloat(v) * boundingRect.height) / 100;\r\n      } else {\r\n        result = parseFloat(v);\r\n      }\r\n\r\n      sum += isNegative ? -result : result;\r\n    }\r\n\r\n    return sum;\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\n\r\n/**\r\n * Input for adaptive lerp factor calculation.\r\n * Maps a speed-like value to a lerp factor, where:\r\n * - lower speed ⇒ slower smoothing (higher lerp factor)\r\n * - higher speed ⇒ faster response (lower lerp factor)\r\n */\r\ninterface AdaptiveLerpInput {\r\n  /** Current value (e.g., speed or delta). */\r\n  value: number\r\n\r\n  /** Minimum input threshold (default: 0.1) */\r\n  inMin?: number\r\n\r\n  /** Maximum input threshold (default: 1.0) */\r\n  inMax?: number\r\n\r\n  /** Output when input is at minimum (default: 0.65) */\r\n  outMax?: number\r\n\r\n  /** Output when input is at maximum (default: 0.05) */\r\n  outMin?: number\r\n}\r\n\r\n/**\r\n * Converts a numeric input (like velocity) into an adaptive lerp factor.\r\n * Useful for scroll or speed-based smoothing effects.\r\n */\r\nexport default class AdaptiveLerpTool implements IStringTool<AdaptiveLerpInput, number> {\r\n  /**\r\n   * @returns A remapped lerp factor from `outMax` to `outMin`.\r\n   */\r\n  process({\r\n    value,\r\n    inMin = 0.1,\r\n    inMax = 1.0,\r\n    outMin = 0.05,\r\n    outMax = 0.65\r\n  }: AdaptiveLerpInput): number {\r\n    if (value < inMin) return outMax\r\n    if (value > 1.0) value = 1.0\r\n\r\n    if (value <= inMax) {\r\n      const t = (value - inMin) / (inMax - inMin)\r\n      return outMax - t * (outMax - outMin)\r\n    }\r\n\r\n    return outMin\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\";\r\n\r\n/**\r\n * Input for origin parser.\r\n * Supports static values or `random(...)` expressions.\r\n */\r\ninterface OriginInput {\r\n  /** Raw origin string, e.g. `'center'` or `'random(top, bottom)'`. */\r\n  value: string;\r\n}\r\n\r\n/**\r\n * Input for parsing origin to normalized coordinates.\r\n * Supports formats like `'left top'`, `'center center'`, `'50% 50%'`, `'35% 76%'`.\r\n */\r\ninterface OriginToNormalizedInput {\r\n  /** Raw origin string, e.g. `'left top'`, `'center'`, `'50% 25%'`. */\r\n  value: string;\r\n}\r\n\r\n/**\r\n * Output: normalized origin coordinates (0-1 range).\r\n */\r\ninterface NormalizedOrigin {\r\n  /** Normalized X coordinate (0 = left, 0.5 = center, 1 = right). */\r\n  x: number;\r\n  /** Normalized Y coordinate (0 = top, 0.5 = center, 1 = bottom). */\r\n  y: number;\r\n}\r\n\r\n/** Keyword mappings for horizontal axis. */\r\nconst HORIZONTAL_KEYWORDS: Record<string, number> = {\r\n  left: 0,\r\n  center: 0.5,\r\n  right: 1,\r\n};\r\n\r\n/** Keyword mappings for vertical axis. */\r\nconst VERTICAL_KEYWORDS: Record<string, number> = {\r\n  top: 0,\r\n  center: 0.5,\r\n  bottom: 1,\r\n};\r\n\r\n/**\r\n * Tool that parses origin strings.\r\n * Allows static values like `'center'`, or expressions like `'random(...)'` to select one randomly.\r\n * Also provides `toNormalized()` method to convert origin strings to `{ x, y }` coordinates.\r\n */\r\nexport default class OriginParserTool implements IStringTool<OriginInput, string> {\r\n  /**\r\n   * @returns Parsed string value (static or randomly chosen).\r\n   */\r\n  process({ value }: OriginInput): string {\r\n    if (!value) return \"center\";\r\n    const raw = value.trim();\r\n\r\n    if (raw.startsWith(\"random(\") && raw.endsWith(\")\")) {\r\n      const options = raw\r\n        .slice(7, -1)\r\n        .split(\",\")\r\n        .map((s) => s.trim())\r\n        .filter(Boolean);\r\n\r\n      const index = Math.floor(Math.random() * options.length);\r\n      return options[index];\r\n    }\r\n\r\n    return raw;\r\n  }\r\n\r\n  /**\r\n   * Parses an origin string to normalized `{ x, y }` coordinates (0-1 range).\r\n   *\r\n   * Supported formats:\r\n   * - Single keyword: `'center'`, `'top'`, `'left'`, etc.\r\n   * - Two keywords: `'left top'`, `'right bottom'`, `'center center'`\r\n   * - Percentages: `'50% 50%'`, `'0% 100%'`, `'35% 76%'`\r\n   * - Mixed: `'left 25%'`, `'50% top'`\r\n   *\r\n   * @param input - The origin string to parse.\r\n   * @returns Normalized `{ x, y }` coordinates.\r\n   */\r\n  toNormalized({ value }: OriginToNormalizedInput): NormalizedOrigin {\r\n    const raw = this.process({ value });\r\n    const parts = raw.toLowerCase().split(/\\s+/).filter(Boolean);\r\n\r\n    if (parts.length === 0) {\r\n      return { x: 0.5, y: 0.5 };\r\n    }\r\n\r\n    if (parts.length === 1) {\r\n      const single = parts[0];\r\n      const parsed = this.parseValue(single);\r\n\r\n      // If it's a horizontal keyword, use center for Y\r\n      if (single in HORIZONTAL_KEYWORDS && !(single in VERTICAL_KEYWORDS)) {\r\n        return { x: parsed, y: 0.5 };\r\n      }\r\n      // If it's a vertical keyword, use center for X\r\n      if (single in VERTICAL_KEYWORDS && !(single in HORIZONTAL_KEYWORDS)) {\r\n        return { x: 0.5, y: parsed };\r\n      }\r\n      // 'center' or percentage applies to both\r\n      return { x: parsed, y: parsed };\r\n    }\r\n\r\n    // Two parts: determine which is X and which is Y\r\n    const [first, second] = parts;\r\n\r\n    // Check if keywords need to be swapped (e.g., \"top left\" → x=left, y=top)\r\n    const firstIsVerticalOnly = first in VERTICAL_KEYWORDS && !(first in HORIZONTAL_KEYWORDS);\r\n    const secondIsHorizontalOnly = second in HORIZONTAL_KEYWORDS && !(second in VERTICAL_KEYWORDS);\r\n\r\n    if (firstIsVerticalOnly || secondIsHorizontalOnly) {\r\n      // Swap: first is Y, second is X\r\n      return {\r\n        x: this.parseValue(second, \"horizontal\"),\r\n        y: this.parseValue(first, \"vertical\"),\r\n      };\r\n    }\r\n\r\n    // Default order: first is X, second is Y\r\n    return {\r\n      x: this.parseValue(first, \"horizontal\"),\r\n      y: this.parseValue(second, \"vertical\"),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Parses a single value (keyword or percentage) to a normalized number.\r\n   */\r\n  private parseValue(val: string, axis?: \"horizontal\" | \"vertical\"): number {\r\n    // Check keywords\r\n    if (axis === \"horizontal\" && val in HORIZONTAL_KEYWORDS) {\r\n      return HORIZONTAL_KEYWORDS[val];\r\n    }\r\n    if (axis === \"vertical\" && val in VERTICAL_KEYWORDS) {\r\n      return VERTICAL_KEYWORDS[val];\r\n    }\r\n    if (val in HORIZONTAL_KEYWORDS) {\r\n      return HORIZONTAL_KEYWORDS[val];\r\n    }\r\n    if (val in VERTICAL_KEYWORDS) {\r\n      return VERTICAL_KEYWORDS[val];\r\n    }\r\n\r\n    // Parse percentage\r\n    if (val.endsWith(\"%\")) {\r\n      const num = parseFloat(val);\r\n      if (!isNaN(num)) {\r\n        return num / 100;\r\n      }\r\n    }\r\n\r\n    // Parse plain number (treat as percentage)\r\n    const num = parseFloat(val);\r\n    if (!isNaN(num)) {\r\n      // If it's a small number (0-1), treat as normalized\r\n      // If it's larger, treat as percentage\r\n      return num > 1 ? num / 100 : num;\r\n    }\r\n\r\n    // Default to center\r\n    return 0.5;\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\nimport { StringColor } from \"../models/color/StringColor\"\r\n\r\n/**\r\n * Input for parsing color strings into RGBA format.\r\n */\r\ninterface ColorParserInput {\r\n  /** Color string in hex, rgb[a], or hsl[a] format. */\r\n  value: string\r\n}\r\n\r\n/**\r\n * Parses a CSS color string (`#fff`, `rgb(...)`, `hsl(...)`, etc.)\r\n * into an object with `r`, `g`, `b`, `a` values.\r\n */\r\nexport default class ColorParserTool\r\n  implements IStringTool<ColorParserInput, StringColor>\r\n{\r\n  /**\r\n   * @returns RGBA object parsed from color string.\r\n   */\r\n  process({ value }: ColorParserInput): StringColor {\r\n    const str = value.trim().toLowerCase()\r\n\r\n    // --- HEX ---\r\n    if (str.startsWith(\"#\")) {\r\n      let hex = str.slice(1)\r\n\r\n      if (hex.length === 3) {\r\n        hex = hex.split(\"\").map((ch) => ch + ch).join(\"\")\r\n      }\r\n\r\n      const r = parseInt(hex.slice(0, 2), 16)\r\n      const g = parseInt(hex.slice(2, 4), 16)\r\n      const b = parseInt(hex.slice(4, 6), 16)\r\n      const a = hex.length === 8 ? parseInt(hex.slice(6, 8), 16) / 255 : 1\r\n\r\n      return { r, g, b, a }\r\n    }\r\n\r\n    // --- RGB / RGBA ---\r\n    const rgbMatch = str.match(/rgba?\\(([^)]+)\\)/)\r\n    if (rgbMatch) {\r\n      const [r, g, b, a = 1] = rgbMatch[1]\r\n        .split(\",\")\r\n        .map((v) => parseFloat(v.trim()))\r\n\r\n      return { r, g, b, a }\r\n    }\r\n\r\n    // --- HSL / HSLA ---\r\n    const hslMatch = str.match(/hsla?\\(([^)]+)\\)/)\r\n    if (hslMatch) {\r\n      const [h, s, l, a = \"1\"] = hslMatch[1].split(\",\").map((v) => v.trim())\r\n      const [r, g, b] = this.hslToRgb(parseFloat(h), parseFloat(s), parseFloat(l))\r\n      return { r, g, b, a: parseFloat(a) }\r\n    }\r\n\r\n    // fallback: transparent\r\n    return { r: 0, g: 0, b: 0, a: 0 }\r\n  }\r\n\r\n  private hslToRgb(h: number, s: string | number, l: string | number): [number, number, number] {\r\n    h = h / 360\r\n    s = parseFloat(s.toString()) / 100\r\n    l = parseFloat(l.toString()) / 100\r\n\r\n    const hue2rgb = (p: number, q: number, t: number) => {\r\n      if (t < 0) t += 1\r\n      if (t > 1) t -= 1\r\n      if (t < 1 / 6) return p + (q - p) * 6 * t\r\n      if (t < 1 / 2) return q\r\n      if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6\r\n      return p\r\n    }\r\n\r\n    const q = l < 0.5 ? l * (1 + s) : l + s - l * s\r\n    const p = 2 * l - q\r\n\r\n    const r = Math.round(hue2rgb(p, q, h + 1 / 3) * 255)\r\n    const g = Math.round(hue2rgb(p, q, h) * 255)\r\n    const b = Math.round(hue2rgb(p, q, h - 1 / 3) * 255)\r\n\r\n    return [r, g, b]\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\n\r\n/**\r\n * Input parameters for EasingFunctionTool.\r\n */\r\ninterface EasingFunctionInput {\r\n  /**\r\n   * The easing string.\r\n   * Can be: 'linear', 'ease', 'ease-in', 'ease-out', 'ease-in-out', or 'cubic-bezier(...)'\r\n   */\r\n  easing: string\r\n}\r\n\r\n/**\r\n * Output of the easing function: receives t in [0,1] and returns eased value.\r\n */\r\nexport type EasingFunctionOutput = (t: number) => number\r\n\r\n/**\r\n * Tool for parsing easing strings into easing functions.\r\n * Supports standard keywords (`ease-in`, `ease-out`, etc.) and `cubic-bezier(...)` expressions.\r\n */\r\nexport default class EasingFunctionTool implements IStringTool<EasingFunctionInput, EasingFunctionOutput> {\r\n  private namedCurves: Record<string, [number, number, number, number]> = {\r\n    \"linear\": [0, 0, 1, 1],\r\n    \"ease\": [0.25, 0.1, 0.25, 1],\r\n    \"ease-in\": [0.42, 0, 1, 1],\r\n    \"ease-out\": [0, 0, 0.58, 1],\r\n    \"ease-in-out\": [0.42, 0, 0.58, 1],\r\n  }\r\n\r\n  /**\r\n   * Parses an easing string and returns a corresponding easing function.\r\n   */\r\n  process({ easing }: EasingFunctionInput): EasingFunctionOutput {\r\n    const def = easing.trim()\r\n\r\n    if (this.namedCurves[def]) {\r\n      return this.cubicBezier(...this.namedCurves[def])\r\n    }\r\n\r\n    const match = def.match(/^cubic-bezier\\s*\\(\\s*([-+]?\\d*\\.?\\d+)\\s*,\\s*([-+]?\\d*\\.?\\d+)\\s*,\\s*([-+]?\\d*\\.?\\d+)\\s*,\\s*([-+]?\\d*\\.?\\d+)\\s*\\)$/);\r\n\r\n    if (match) {\r\n      const [x1, y1, x2, y2] = match.slice(1).map(Number)\r\n      return this.cubicBezier(x1, y1, x2, y2)\r\n    }\r\n\r\n    // fallback: linear\r\n    return (t: number) => t\r\n  }\r\n\r\n  /**\r\n   * Generates a cubic-bezier easing function.\r\n   * Ported from https://github.com/gre/bezier-easing (MIT)\r\n   */\r\n  private cubicBezier(x1: number, y1: number, x2: number, y2: number): EasingFunctionOutput {\r\n    const cx = 3 * x1\r\n    const bx = 3 * (x2 - x1) - cx\r\n    const ax = 1 - cx - bx\r\n\r\n    const cy = 3 * y1\r\n    const by = 3 * (y2 - y1) - cy\r\n    const ay = 1 - cy - by\r\n\r\n    function sampleCurveX(t: number) {\r\n      return ((ax * t + bx) * t + cx) * t\r\n    }\r\n\r\n    function sampleCurveY(t: number) {\r\n      return ((ay * t + by) * t + cy) * t\r\n    }\r\n\r\n    function sampleCurveDerivativeX(t: number) {\r\n      return (3 * ax * t + 2 * bx) * t + cx\r\n    }\r\n\r\n    function solveCurveX(x: number, epsilon = 1e-5) {\r\n      let t0, t1, t2 = x, x2, d2, i\r\n\r\n      // Newton-Raphson method\r\n      for (i = 0; i < 8; i++) {\r\n        x2 = sampleCurveX(t2) - x\r\n        if (Math.abs(x2) < epsilon) return t2\r\n        d2 = sampleCurveDerivativeX(t2)\r\n        if (Math.abs(d2) < 1e-6) break\r\n        t2 = t2 - x2 / d2\r\n      }\r\n\r\n      // Bisection fallback\r\n      t0 = 0\r\n      t1 = 1\r\n      t2 = x\r\n\r\n      while (t0 < t1) {\r\n        x2 = sampleCurveX(t2) - x\r\n        if (Math.abs(x2) < epsilon) return t2\r\n        if (x2 > 0) t1 = t2\r\n        else t0 = t2\r\n        t2 = (t1 + t0) / 2\r\n      }\r\n\r\n      return t2\r\n    }\r\n\r\n    return function (x: number) {\r\n      return sampleCurveY(solveCurveX(x))\r\n    }\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\n\r\n/**\r\n * Input parameters for calculating magnetic pull factor.\r\n */\r\ninterface MagneticPullInput {\r\n  /** Distance between pointer and element center (px). */\r\n  distance: number\r\n\r\n  /** Max distance within which magnetic pull is active. */\r\n  radius: number\r\n\r\n  /** Strength of the magnetic pull (0–1 recommended). */\r\n  strength: number\r\n}\r\n\r\n/**\r\n * Output: factor to multiply by direction vector (dx/dy) to get magnetic offset.\r\n */\r\ntype MagneticPullOutput = number\r\n\r\n/**\r\n * Tool for calculating magnetic attraction based on distance to element.\r\n * Returns a scalar value (0..strength) depending on proximity.\r\n */\r\nexport default class MagneticPullTool implements IStringTool<MagneticPullInput, MagneticPullOutput> {\r\n  /**\r\n   * Returns a pull factor based on distance to target within a radius.\r\n   * @param input - Magnetic pull parameters.\r\n   * @returns A multiplier (typically < 1) to apply to dx/dy.\r\n   */\r\n  process({ distance, radius, strength }: MagneticPullInput): number {\r\n    if (distance >= radius) return 0\r\n    const proximity = (radius - distance) / radius // 1 when close, 0 at edge\r\n    return strength * proximity\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\nimport { StringColor } from \"../models/color/StringColor\"\r\n\r\n/**\r\n * Input parameters for `LerpColorTool`.\r\n */\r\ninterface LerpColorInput {\r\n  /**\r\n   * Starting color as an object `{ r, g, b, a }` where each value is in the range `0–1`.\r\n   */\r\n  from: StringColor\r\n\r\n  /**\r\n   * Target color as an object `{ r, g, b, a }` where each value is in the range `0–1`.\r\n   */\r\n  to: StringColor\r\n\r\n  /**\r\n   * Interpolation progress from `0` (start) to `1` (end).\r\n   */\r\n  progress: number\r\n}\r\n\r\n/**\r\n * Tool for linearly interpolating between two RGBA colors using `StringColor` format.\r\n * Each channel (`r`, `g`, `b`, `a`) is interpolated independently.\r\n * Returns a new `StringColor` with the interpolated values.\r\n */\r\nexport default class LerpColorTool implements IStringTool<LerpColorInput, StringColor> {\r\n  /**\r\n   * Performs linear interpolation between two `StringColor` values.\r\n   *\r\n   * @param input.from - The starting color `{ r, g, b, a }`.\r\n   * @param input.to - The target color `{ r, g, b, a }`.\r\n   * @param input.progress - A number from `0` to `1` indicating interpolation progress.\r\n   * @returns Interpolated color as a new `StringColor`.\r\n   */\r\n  process({ from, to, progress }: LerpColorInput): StringColor {\r\n    return {\r\n      r: from.r + (to.r - from.r) * progress,\r\n      g: from.g + (to.g - from.g) * progress,\r\n      b: from.b + (to.b - from.b) * progress,\r\n      a: from.a + (to.a - from.a) * progress,\r\n    }\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\"\r\nimport { StringVector } from \"../models/vector/StringVector\"\r\n\r\n/**\r\n * Input parameters for LerpVector2Tool.\r\n */\r\ninterface LerpVector2Input {\r\n  /**\r\n   * Starting vector value `{ x, y }`.\r\n   */\r\n  from: StringVector\r\n\r\n  /**\r\n   * Target vector value `{ x, y }`.\r\n   */\r\n  to: StringVector\r\n\r\n  /**\r\n   * Interpolation progress from `0` (start) to `1` (end).\r\n   */\r\n  progress: number\r\n}\r\n\r\n/**\r\n * Tool for linearly interpolating between two 2D vectors.\r\n * Useful for cursor smoothing, UI element animations, and motion blending.\r\n */\r\nexport default class LerpVector2Tool implements IStringTool<LerpVector2Input, StringVector> {\r\n  /**\r\n   * Calculates the interpolated vector between `from` and `to`.\r\n   *\r\n   * @param input.from - The starting vector `{ x, y }`.\r\n   * @param input.to - The target vector `{ x, y }`.\r\n   * @param input.progress - Interpolation progress from `0` (start) to `1` (end).\r\n   * @returns Interpolated vector `{ x, y }`.\r\n   */\r\n  process({ from, to, progress }: LerpVector2Input): { x: number, y: number } {\r\n    return {\r\n      x: (to.x - from.x) * progress,\r\n      y: (to.y - from.y) * progress,\r\n    }\r\n  }\r\n}\r\n\r\n","import { IStringTool } from \"../core/IStringTool\"; // Переконайтесь, що шлях правильний\r\n\r\n/**\r\n * Input for parsing the transform string to extract scale.\r\n */\r\ninterface TransformParserInput {\r\n  /** CSS transform string (e.g., \"matrix(0.5, 0, 0, 0.5, 10, 20)\", \"scale(0.5)\", \"none\"). */\r\n  value: string;\r\n}\r\n\r\n/**\r\n * Parses a CSS transform string to extract the primary scale factor.\r\n * Assumes uniform scale or extracts the X-axis scale factor from matrix/scale functions.\r\n */\r\nexport default class TransformScaleParserTool\r\n  implements IStringTool<TransformParserInput, number> // Output is a number\r\n{\r\n  /**\r\n   * Processes the transform string and extracts the scale factor.\r\n   * @returns Numeric scale factor (defaults to 1 if no scale transform is found or parsing fails).\r\n   */\r\n  process({ value }: TransformParserInput): number {\r\n    const defaultScale = 1;\r\n    const str = value?.trim();\r\n\r\n    if (!str || str === 'none') {\r\n      return defaultScale;\r\n    }\r\n    try {\r\n      if (str.startsWith('matrix(')) {\r\n        const matrixValues = str.match(/matrix\\(([^)]+)\\)/);\r\n        if (matrixValues && matrixValues[1]) {\r\n          const matrixNumbers = matrixValues[1].split(',').map(s => parseFloat(s.trim()));\r\n          if (matrixNumbers.length >= 1 && !isNaN(matrixNumbers[0])) {\r\n            return matrixNumbers[0];\r\n          }\r\n        }\r\n      }\r\n\r\n      if (str.startsWith('scale(')) {\r\n        const scaleValue = str.match(/scale\\(([^)]+)\\)/);\r\n        if (scaleValue && scaleValue[1]) {\r\n          const scaleNumbers = scaleValue[1].split(',').map(s => parseFloat(s.trim()));\r\n          if (scaleNumbers.length >= 1 && !isNaN(scaleNumbers[0])) {\r\n            return scaleNumbers[0];\r\n          }\r\n        }\r\n      }\r\n\r\n       if (str.startsWith('scaleX(')) {\r\n        const scaleXValue = str.match(/scaleX\\(([^)]+)\\)/);\r\n        if (scaleXValue && scaleXValue[1]) {\r\n          const scaleNumber = parseFloat(scaleXValue[1].trim());\r\n          if (!isNaN(scaleNumber)) {\r\n            return scaleNumber;\r\n          }\r\n        }\r\n      }\r\n\r\n       if (str.startsWith('scale3d(')) {\r\n         const scale3dValue = str.match(/scale3d\\(([^)]+)\\)/);\r\n         if (scale3dValue && scale3dValue[1]) {\r\n             const scaleNumbers = scale3dValue[1].split(',').map(s => parseFloat(s.trim()));\r\n             if (scaleNumbers.length >= 1 && !isNaN(scaleNumbers[0])) {\r\n                 return scaleNumbers[0]; // Повертаємо sx\r\n             }\r\n         }\r\n       }\r\n\r\n       if (str.startsWith('matrix3d(')) {\r\n           const matrix3dValues = str.match(/matrix3d\\(([^)]+)\\)/);\r\n           if (matrix3dValues && matrix3dValues[1]) {\r\n               const matrixNumbers = matrix3dValues[1].split(',').map(s => parseFloat(s.trim()));\r\n               if (matrixNumbers.length >= 1 && !isNaN(matrixNumbers[0])) {\r\n                   return matrixNumbers[0];\r\n               }\r\n           }\r\n       }\r\n\r\n    } catch (error) {\r\n      console.error(`Error parsing transform string \"${str}\":`, error);\r\n      return defaultScale;\r\n    }\r\n\r\n    return defaultScale;\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\";\r\nimport { ISplitOptionItem } from \"../models/text/ISplitOptionItem\";\r\nimport { ISplitOptions } from \"../models/text/ISplitOptions\";\r\nimport { SplitOptionsParserInput } from \"../models/text/SplitOptionsParserInput\";\r\n\r\n/**\r\n * Tool responsible for parsing the string value of a split attribute\r\n * (e.g., \"line[center]|char[random(0,10)|abs]\") into a structured\r\n * ISplitOptions object.\r\n * Implements the IStringTool interface.\r\n */\r\nexport class SplitOptionsParserTool\r\n  implements IStringTool<SplitOptionsParserInput, ISplitOptions>\r\n{\r\n  /**\r\n   * Parses the attribute string into an ISplitOptions object.\r\n   * Handles splitting by '|', parsing prefixes (word-, char-), main types (line, word, char),\r\n   * and parameters within brackets (align, random, abs).\r\n   *\r\n   * @param input - An object containing the attributeValue string (can be null).\r\n   * @returns An ISplitOptions object representing the parsed rules.\r\n   * Returns an object with empty arrays if the attributeValue is null or empty.\r\n   */\r\n  process({ attributeValue }: SplitOptionsParserInput): ISplitOptions {\r\n    // Initialize with empty arrays for all possible options\r\n    const options: ISplitOptions = {\r\n      line: [],\r\n      word: [],\r\n      char: [],\r\n      charLine: [],\r\n      charWord: [],\r\n      wordLine: [],\r\n    };\r\n\r\n    // Return default empty options if attribute value is null or empty string\r\n    if (!attributeValue) {\r\n      return options;\r\n    }\r\n\r\n    // Split the main attribute value by the pipe '|' separator\r\n    const parts = attributeValue.split(\"|\");\r\n\r\n    parts.forEach((part) => {\r\n      // Trim whitespace from each part\r\n      const trimmedPart = part.trim();\r\n      if (!trimmedPart) return; // Skip empty parts resulting from separators like '||' or trailing '|'\r\n\r\n      // Regex to capture:\r\n      // 1. Optional prefix (word-, char-) - (\\w+-)?\r\n      // 2. Main option type (line, word, char) - (\\w+)\r\n      // 3. Optional parameters section including brackets - (\\[(.*?)\\])?\r\n      // 4. Content within the brackets (params string) - (.*?)\r\n      const match = trimmedPart.match(/^(\\w+-)?(\\w+)(\\[(.*?)\\])?$/);\r\n\r\n      if (match) {\r\n        const prefix = match[1] || \"\"; // e.g., \"word-\" or \"\"\r\n        const optionType = match[2]; // e.g., \"line\", \"word\", \"char\"\r\n        const fullOptionKey = prefix + optionType; // Combined key like \"line\", \"word\", \"charLine\"\r\n        // Extract params string inside brackets, or empty string if no brackets\r\n        const paramsString = match[4] || \"\";\r\n        // Split params by comma and trim each resulting param string\r\n        const params = paramsString\r\n          .split(\";\")\r\n          .map((p) => p.trim())\r\n          .filter((p) => p.length > 0); // Filter out empty params\r\n\r\n        // Parse the parameters within brackets using the helper method\r\n        const parsedParam: ISplitOptionItem = this.parseParamsArray(params);\r\n\r\n        // Add the parsed parameters object to the correct array in the options object\r\n        // Use a type assertion for simplicity. More complex type guards could be used.\r\n        switch (fullOptionKey) {\r\n          case \"line\":\r\n            (options.line as ISplitOptionItem[]).push(parsedParam);\r\n            break;\r\n          case \"word\":\r\n            (options.word as ISplitOptionItem[]).push(parsedParam);\r\n            break;\r\n          case \"char\":\r\n            (options.char as ISplitOptionItem[]).push(parsedParam);\r\n            break;\r\n          case \"charLine\": // e.g., char-line\r\n            (options.charLine as ISplitOptionItem[]).push(parsedParam);\r\n            break;\r\n          case \"charWord\": // e.g., char-word\r\n            (options.charWord as ISplitOptionItem[]).push(parsedParam);\r\n            break;\r\n          case \"wordLine\": // e.g., word-line\r\n            (options.wordLine as ISplitOptionItem[]).push(parsedParam);\r\n            break;\r\n          default:\r\n            // Log a warning for unrecognized option combinations\r\n            console.warn(\r\n              `SplitOptionsParserTool: Unrecognized option type \"${fullOptionKey}\" in part \"${trimmedPart}\"`\r\n            );\r\n            break;\r\n        }\r\n      } else {\r\n        // Log a warning for parts that don't match the expected format \"type[params]\" or \"prefix-type[params]\"\r\n        console.warn(\r\n          `SplitOptionsParserTool: Could not parse part format \"${trimmedPart}\"`\r\n        );\r\n      }\r\n    }); // End forEach part\r\n\r\n    return options; // Return the populated options object\r\n  }\r\n\r\n  /**\r\n   * Parses an array of string parameters (extracted from within brackets `[...]`).\r\n   * Determines alignment, random settings, and absolute flag.\r\n   * Example input: ['center'], ['random(0, 10)', 'abs']\r\n   *\r\n   * @param params - An array of string parameters.\r\n   * @returns An ISplitOptionItem object representing the parsed parameters.\r\n   */\r\n  private parseParamsArray(params: string[]): ISplitOptionItem {\r\n    // Default result with 'start' alignment\r\n    const result: ISplitOptionItem = { align: \"start\" };\r\n\r\n    params.forEach((param) => {\r\n      if (param === \"abs\") {\r\n        // Set the absolute flag\r\n        result.abs = true;\r\n      } else if (param.startsWith(\"random\")) {\r\n        // Handle random alignment\r\n        result.align = \"random\"; // Set alignment type\r\n        // Try to parse min/max values like random(10,50)\r\n        // Allows optional whitespace around numbers and comma\r\n        const randomMatch = param.match(/random\\(\\s*(\\d+)\\s*,\\s*(\\d+)\\s*\\)/);\r\n        if (randomMatch) {\r\n          // If numbers found, parse and store them\r\n          result.random = {\r\n            min: parseInt(randomMatch[1], 10),\r\n            max: parseInt(randomMatch[2], 10),\r\n          };\r\n          // Optional: Add validation like min <= max here if desired\r\n        }\r\n        // If 'random' specified without valid numbers, result.align is 'random',\r\n        // and result.random remains undefined (defaults will apply later based on context).\r\n      } else if ([\"start\", \"center\", \"end\"].includes(param)) {\r\n        // Handle specific alignment keywords\r\n        result.align = param;\r\n      }\r\n      // Silently ignore any other unrecognized parameters within the brackets\r\n    });\r\n\r\n    return result; // Return the parsed option item definition\r\n  }\r\n}\r\n","import { IStringTool } from \"../core/IStringTool\";\n\nexport interface RuleParserInput {\n  value: string;\n}\n\nexport interface RuleParserResult {\n  key: string;\n  params?: string[];\n}\n\nexport default class RuleParserTool implements IStringTool<RuleParserInput, RuleParserResult[]> {\n  process({ value }: RuleParserInput): RuleParserResult[] {\n    const result: string[] = [];\n    let current = \"\";\n    let depth = 0;\n    for (let i = 0; i < value.length; i++) {\n      const c = value[i];\n      if (c === \"(\") depth++;\n      if (c === \")\") depth--;\n      if (c === \"|\" && depth === 0) {\n        if (current.trim()) result.push(current.trim());\n        current = \"\";\n      } else {\n        current += c;\n      }\n    }\n    if (current.trim()) result.push(current.trim());\n\n    return result.map((ruleStr) => {\n      const match = ruleStr.match(/^(\\w+)(?:\\((.*)\\))?$/);\n      if (match) {\n        const [, key, params] = match;\n        if (params) {\n          return { key, params: params.split(\",\").map((s) => s.trim()) };\n        }\n        return { key };\n      }\n\n      const colonIndex = ruleStr.indexOf(\":\");\n      if (colonIndex !== -1) {\n        const key = ruleStr.slice(0, colonIndex).trim();\n        const paramsString = ruleStr.slice(colonIndex + 1).trim();\n        const params = paramsString ? paramsString.split(\",\").map((s) => s.trim()) : undefined;\n        return { key, params };\n      }\n\n      return { key: ruleStr };\n    });\n  }\n}\n","import { IStringTool } from \"../core/IStringTool\";\r\nimport { RuleParserResult } from \"./RuleParserTool\";\r\n\r\nexport interface ValidationContext {\r\n  fieldKey?: string;\r\n  values?: Record<string, any>;\r\n  getValue?: (key: string) => any;\r\n}\r\n\r\nexport interface ValidateInput {\r\n  rules: RuleParserResult[];\r\n  value: any;\r\n  type?: \"input\" | \"beforeinput\";\r\n  context?: ValidationContext;\r\n}\r\n\r\nexport interface ValidationResult {\r\n  valid: boolean;\r\n  errors: string[];\r\n}\r\n\r\ntype ValidatorFn = (value: any, params?: string[], context?: ValidationContext) => boolean;\r\n\r\nexport class ValidationTool implements IStringTool<ValidateInput, ValidationResult> {\r\n  process({ rules, value, type = \"input\", context }: ValidateInput): ValidationResult {\r\n    const errors: string[] = [];\r\n    for (const rule of rules) {\r\n      var beforeInputValidatorFn: ValidatorFn | null = null;\r\n      var inputValidatorFn: ValidatorFn | null = null;\r\n      var inputValid = true;\r\n      var beforeInputValid = true;\r\n\r\n      if (type == \"input\") {\r\n        inputValidatorFn = this.inputValidators[rule.key];\r\n        if (!inputValidatorFn) continue;\r\n      }\r\n      if (type == \"beforeinput\") {\r\n        beforeInputValidatorFn = this.beforeInputValidators[rule.key];\r\n        if (!beforeInputValidatorFn) continue;\r\n      }\r\n\r\n      if (inputValidatorFn) {\r\n        inputValid = inputValidatorFn(value, rule.params, context);\r\n      }\r\n      if (beforeInputValidatorFn) {\r\n        beforeInputValid = beforeInputValidatorFn(value, rule.params, context);\r\n      }\r\n\r\n      if (!beforeInputValid) {\r\n        errors.push(this.getErrorMessage(rule.key, rule.params));\r\n      }\r\n      if (!inputValid) {\r\n        errors.push(this.getErrorMessage(rule.key, rule.params));\r\n      }\r\n    }\r\n    return { valid: errors.length === 0, errors };\r\n  }\r\n\r\n  inputValidators: Record<string, ValidatorFn> = {\r\n    required: (v) => v != null && String(v).trim() !== \"\",\r\n    min: (v, params) => typeof v === \"string\" && v.length >= Number(params?.[0] ?? 0),\r\n    max: (v, params) =>\r\n      typeof v === \"string\" && v.length <= Number(params?.[0] ?? Number.MAX_SAFE_INTEGER),\r\n    checked: (v) => {\r\n      if (Array.isArray(v)) {\r\n        return v.length > 0;\r\n      }\r\n      if (v === true || v === \"true\" || v === 1 || v === \"1\") {\r\n        return true;\r\n      }\r\n      if (typeof v === \"string\") {\r\n        const normalized = v.trim().toLowerCase();\r\n        if (normalized === \"false\" || normalized === \"0\") {\r\n          return false;\r\n        }\r\n        return normalized.length > 0;\r\n      }\r\n      return !!v;\r\n    },\r\n    email: (v) => typeof v === \"string\" && /^[\\w-.]+@([\\w-]+\\.)+[\\w-]{2,4}$/.test(v),\r\n    phone: (v) => {\r\n      if (typeof v !== \"string\") return false;\r\n      const normalized = v.trim();\r\n      if (normalized === \"\") return false;\r\n      if (!/^[0-9()\\s+-.]+$/.test(normalized)) return false;\r\n      const digitCount = normalized.replace(/\\D/g, \"\").length;\r\n      return digitCount >= 7 && digitCount <= 15;\r\n    },\r\n    number: (v) => typeof v === \"string\" && /^-?\\d+(\\.\\d+)?$/.test(v),\r\n    integer: (v) => typeof v === \"string\" && /^-?\\d+$/.test(v),\r\n    url: (v) =>\r\n      typeof v === \"string\" &&\r\n      /^(https?:\\/\\/)?([\\w\\-]+\\.)+[\\w\\-]+(\\/[\\w\\-._~:\\/?#[\\]@!$&'()*+,;=]*)?$/.test(v),\r\n    regex: (v, params) => this.testByRegex(v, params?.[0]),\r\n    alpha: (v) => this.testByRegex(v, \"^[A-Za-z]+$\", true),\r\n    alpha_num: (v) => this.testByRegex(v, \"^[A-Za-z0-9]+$\", true),\r\n    alpha_dash: (v) => this.testByRegex(v, \"^[A-Za-z0-9_-]+$\", true),\r\n    same: (v, params, context) => {\r\n      const targetKey = params?.[0];\r\n      const otherValue = this.getContextValue(context, targetKey);\r\n      if (targetKey && otherValue === undefined) return false;\r\n      return this.areValuesEqual(v, otherValue);\r\n    },\r\n    different: (v, params, context) => {\r\n      const targetKey = params?.[0];\r\n      const otherValue = this.getContextValue(context, targetKey);\r\n      if (targetKey && otherValue === undefined) return false;\r\n      return !this.areValuesEqual(v, otherValue);\r\n    },\r\n    range: (v, params) => {\r\n      if (v == null || v === \"\") return true;\r\n      const value = Number(v);\r\n      const min = Number(params?.[0]);\r\n      const max = Number(params?.[1]);\r\n      if (Number.isNaN(value) || Number.isNaN(min) || Number.isNaN(max)) {\r\n        return false;\r\n      }\r\n      return value >= min && value <= max;\r\n    },\r\n    digits: (v, params) => {\r\n      if (typeof v !== \"string\") return false;\r\n      const length = Number(params?.[0] ?? 0);\r\n      if (length <= 0) return false;\r\n      return new RegExp(`^\\\\d{${length}}$`).test(v);\r\n    },\r\n    ip: (v) => typeof v === \"string\" && (this.isIPv4(v) || this.isIPv6(v)),\r\n    mimes: (v, params) => this.validateMimes(v, params),\r\n    max_size: (v, params) => {\r\n      const limit = Number(params?.[0]);\r\n      if (!limit || limit <= 0) return true;\r\n      return this.validateMaxSize(v, limit);\r\n    },\r\n    after: (v, params, context) => this.compareDates(v, params, context, \"after\"),\r\n    before: (v, params, context) => this.compareDates(v, params, context, \"before\"),\r\n  };\r\n\r\n  beforeInputValidators: Record<string, ValidatorFn> = {\r\n    number: (v) => /^-?\\d*\\.?\\d*$/.test(v),\r\n    integer: (v) => /^-?\\d*$/.test(v),\r\n    email: (v) => /^[\\w@.\\-+]*$/.test(v),\r\n    phone: (v) => /^[0-9()\\s+-.]*$/.test(v),\r\n    letters: (v) => /^[a-zA-Z]*$/.test(v),\r\n    lettersSpaces: (v) => /^[a-zA-Z\\s]*$/.test(v),\r\n    lettersNumbers: (v) => /^[a-zA-Z0-9]*$/.test(v),\r\n    alpha: (v) => /^[A-Za-z]*$/.test(v),\r\n    alpha_num: (v) => /^[A-Za-z0-9]*$/.test(v),\r\n    alpha_dash: (v) => /^[A-Za-z0-9_-]*$/.test(v),\r\n    digits: (v, params) => {\r\n      const length = Number(params?.[0] ?? 0);\r\n      if (length <= 0) return /^\\d*$/.test(v);\r\n      return new RegExp(`^\\\\d{0,${length}}$`).test(v);\r\n    },\r\n    url: (v) => /^[a-zA-Z0-9\\-._~:\\/?#\\[\\]@!$&'()*+,;=%]*$/.test(v),\r\n    pattern: (v, params) => {\r\n      try {\r\n        return new RegExp(params?.[0] || \"\").test(v);\r\n      } catch {\r\n        return true;\r\n      }\r\n    },\r\n  };\r\n\r\n  getErrorMessage(key: string, params?: string[]): string {\r\n    switch (key) {\r\n      case \"required\":\r\n        return \"This field is required\";\r\n      case \"email\":\r\n        return \"Invalid email address\";\r\n      case \"min\":\r\n        return `Minimum ${params?.[0]} characters`;\r\n      case \"max\":\r\n        return `Maximum ${params?.[0]} characters`;\r\n      case \"phone\":\r\n        return \"Invalid phone number\";\r\n      case \"number\":\r\n        return \"Only numbers are allowed\";\r\n      case \"integer\":\r\n        return \"Only whole numbers are allowed\";\r\n      case \"url\":\r\n        return \"Invalid URL address\";\r\n      case \"checked\":\r\n        return \"You must accept\";\r\n      case \"regex\":\r\n        return \"Value does not match the required pattern\";\r\n      case \"alpha\":\r\n        return \"Only letters are allowed\";\r\n      case \"alpha_num\":\r\n        return \"Only letters and numbers are allowed\";\r\n      case \"alpha_dash\":\r\n        return \"Only letters, numbers, dashes, and underscores are allowed\";\r\n      case \"same\":\r\n        return \"Values do not match\";\r\n      case \"different\":\r\n        return \"Values must be different\";\r\n      case \"range\":\r\n        return `Value must be between ${params?.[0]} and ${params?.[1]}`;\r\n      case \"digits\":\r\n        return `Value must contain exactly ${params?.[0]} digits`;\r\n      case \"ip\":\r\n        return \"Invalid IP address\";\r\n      case \"mimes\":\r\n        return `Allowed file types: ${params?.join(\", \")}`;\r\n      case \"max_size\":\r\n        return `File must be smaller than ${params?.[0]} KB`;\r\n      case \"after\":\r\n        return `Date must be after ${params?.[0]}`;\r\n      case \"before\":\r\n        return `Date must be before ${params?.[0]}`;\r\n      default:\r\n        return \"Invalid value\";\r\n    }\r\n  }\r\n\r\n  private validateMimes(value: any, params?: string[]): boolean {\r\n    if (!params || params.length === 0) return true;\r\n    const files = this.extractFiles(value);\r\n    if (files.length === 0) return true;\r\n    const allowed = params.map((p) => p.trim().toLowerCase());\r\n    return files.every((file) => this.isMimeAllowed(file, allowed));\r\n  }\r\n\r\n  private validateMaxSize(value: any, limitKb: number): boolean {\r\n    const files = this.extractFiles(value);\r\n    if (files.length === 0) return true;\r\n    const maxBytes = limitKb * 1024;\r\n    return files.every((file) => {\r\n      if (typeof file.size !== \"number\") return true;\r\n      return file.size <= maxBytes;\r\n    });\r\n  }\r\n\r\n  private extractFiles(value: any): Array<{ name?: string; size?: number; type?: string }> {\r\n    if (!value) return [];\r\n    const files: Array<{ name?: string; size?: number; type?: string }> = [];\r\n\r\n    if (typeof File !== \"undefined\" && value instanceof File) {\r\n      files.push(value);\r\n      return files;\r\n    }\r\n\r\n    if (typeof FileList !== \"undefined\" && value instanceof FileList) {\r\n      return Array.from(value);\r\n    }\r\n\r\n    if (Array.isArray(value)) {\r\n      value.forEach((item) => {\r\n        files.push(...this.extractFiles(item));\r\n      });\r\n      return files;\r\n    }\r\n\r\n    if (typeof value === \"object\" && (\"name\" in value || \"size\" in value || \"type\" in value)) {\r\n      files.push(value as any);\r\n      return files;\r\n    }\r\n\r\n    if (typeof value === \"string\" && value !== \"\") {\r\n      files.push({ name: value });\r\n    }\r\n\r\n    return files;\r\n  }\r\n\r\n  private isMimeAllowed(file: { name?: string; type?: string }, allowed: string[]): boolean {\r\n    const mime = (file.type || \"\").toLowerCase();\r\n    const ext = this.getFileExtension(file.name);\r\n    return allowed.some((rule) => {\r\n      const normalized = rule.replace(/^\\./, \"\").toLowerCase();\r\n      if (!normalized) return false;\r\n      if (normalized.includes(\"/\")) {\r\n        return mime === normalized;\r\n      }\r\n      return ext === normalized;\r\n    });\r\n  }\r\n\r\n  private getFileExtension(name?: string): string {\r\n    if (!name) return \"\";\r\n    const parts = name.split(\".\");\r\n    if (parts.length <= 1) return \"\";\r\n    return (parts.pop() || \"\").toLowerCase();\r\n  }\r\n\r\n  private compareDates(\r\n    value: any,\r\n    params: string[] | undefined,\r\n    context: ValidationContext | undefined,\r\n    mode: \"before\" | \"after\"\r\n  ): boolean {\r\n    if (value == null || value === \"\") return true;\r\n    const target = params?.[0];\r\n    if (!target) return true;\r\n    const currentDate = this.toDate(value);\r\n    const referenceDate = this.resolveDateReference(target, context);\r\n    if (!currentDate || !referenceDate) return false;\r\n    return mode === \"after\"\r\n      ? currentDate.getTime() > referenceDate.getTime()\r\n      : currentDate.getTime() < referenceDate.getTime();\r\n  }\r\n\r\n  private resolveDateReference(token: string, context?: ValidationContext): Date | null {\r\n    const contextualValue = this.getContextValue(context, token);\r\n    if (contextualValue !== undefined) {\r\n      return this.toDate(contextualValue);\r\n    }\r\n    if (token.toLowerCase() === \"now\") {\r\n      return new Date();\r\n    }\r\n    if (token.toLowerCase() === \"today\") {\r\n      const today = new Date();\r\n      today.setHours(0, 0, 0, 0);\r\n      return today;\r\n    }\r\n    return this.toDate(token);\r\n  }\r\n\r\n  private toDate(value: any): Date | null {\r\n    if (value == null || value === \"\") return null;\r\n    if (value instanceof Date) {\r\n      return Number.isNaN(value.getTime()) ? null : value;\r\n    }\r\n    if (typeof value === \"number\") {\r\n      const date = new Date(value);\r\n      return Number.isNaN(date.getTime()) ? null : date;\r\n    }\r\n    if (typeof value === \"string\") {\r\n      const timestamp = Date.parse(value);\r\n      if (!Number.isNaN(timestamp)) {\r\n        return new Date(timestamp);\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private testByRegex(value: any, pattern?: string, allowEmpty = false): boolean {\r\n    if (pattern == null || pattern === \"\") return true;\r\n    const stringValue = typeof value === \"string\" ? value : value == null ? \"\" : String(value);\r\n    if (allowEmpty && stringValue === \"\") return true;\r\n    try {\r\n      const { source, flags } = this.normalizeRegex(pattern);\r\n      return new RegExp(source, flags).test(stringValue);\r\n    } catch {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  private normalizeRegex(pattern: string): { source: string; flags: string } {\r\n    const trimmed = pattern.trim();\r\n    if (trimmed.startsWith(\"/\") && trimmed.lastIndexOf(\"/\") > 0) {\r\n      const lastSlashIndex = trimmed.lastIndexOf(\"/\");\r\n      const source = trimmed.slice(1, lastSlashIndex);\r\n      const flags = trimmed.slice(lastSlashIndex + 1);\r\n      return { source, flags };\r\n    }\r\n    return { source: trimmed, flags: \"\" };\r\n  }\r\n\r\n  private getContextValue(context: ValidationContext | undefined, key?: string): any {\r\n    if (!context || !key) return undefined;\r\n    if (context.values && Object.prototype.hasOwnProperty.call(context.values, key)) {\r\n      return context.values[key];\r\n    }\r\n    if (context.getValue) {\r\n      return context.getValue(key);\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  private areValuesEqual(a: any, b: any): boolean {\r\n    if (Array.isArray(a) || Array.isArray(b)) {\r\n      return JSON.stringify(a) === JSON.stringify(b);\r\n    }\r\n    return a === b;\r\n  }\r\n\r\n  private isIPv4(value: string): boolean {\r\n    const segments = value.split(\".\");\r\n    if (segments.length !== 4) return false;\r\n    return segments.every((segment) => {\r\n      if (!/^\\d+$/.test(segment)) return false;\r\n      const num = Number(segment);\r\n      return num >= 0 && num <= 255;\r\n    });\r\n  }\r\n\r\n  private isIPv6(value: string): boolean {\r\n    if (!value) return false;\r\n    if (value === \"::\") return true;\r\n    const parts = value.split(\"::\");\r\n    if (parts.length > 2) return false;\r\n\r\n    const hextetPattern = /^[0-9a-fA-F]{1,4}$/;\r\n    const segments = value.split(\":\");\r\n    if (parts.length === 2) {\r\n      return (\r\n        segments.every((segment) => segment === \"\" || hextetPattern.test(segment)) &&\r\n        segments.length <= 8\r\n      );\r\n    }\r\n    return segments.length === 8 && segments.every((segment) => hextetPattern.test(segment));\r\n  }\r\n}\r\n","import BoundingClientRectTool from \"../tools/BoundingClientRectTool\";\r\nimport DOMAttributeTool from \"../tools/DOMAttributeTool\";\r\nimport RecordAttributeTool from \"../tools/RecordAttributeTool\";\r\nimport RelativePositionTool from \"../tools/RelativePositionTool\";\r\nimport LerpTool from \"../tools/LerpTool\";\r\nimport TransformNullifyTool from \"../tools/TransformNullifyTool\";\r\nimport UnitParserTool from \"../tools/UnitParserTool\";\r\nimport AdaptiveLerpTool from \"../tools/AdaptiveLerpTool\";\r\nimport OriginParserTool from \"../tools/OriginParserTool\";\r\nimport ColorParserTool from \"../tools/ColorParserTool\";\r\nimport EasingFunctionTool from \"../tools/EasingFunctionTool\";\r\nimport MagneticPullTool from \"../tools/MagneticPullTool\";\r\nimport LerpColorTool from \"../tools/LerpColorTool\";\r\nimport LerpVector2Tool from \"../tools/LerpVector2Tool\";\r\nimport TransformScaleParserTool from \"../tools/TransformScaleParserTool\";\r\nimport { SplitOptionsParserTool } from \"../tools/SplitOptionsParserTool\";\r\nimport RuleParserTool from \"../tools/RuleParserTool\";\r\nimport { ValidationTool } from \"../tools/ValidationTool\";\r\n\r\n/**\r\n * Interface describing all available tools used inside modules.\r\n */\r\nexport interface StringToolsContainer {\r\n  /** Tool for reading DOM attributes (including data-*). */\r\n  domAttribute: DOMAttributeTool;\r\n\r\n  /** Tool for reading attributes from a plain JS object or dataset. */\r\n  recordAttribute: RecordAttributeTool;\r\n\r\n  /** Tool for calculating the relative position between two elements. */\r\n  relativePosition: RelativePositionTool;\r\n\r\n  /** Tool that nullifies the effect of CSS transform matrix. */\r\n  transformNullify: TransformNullifyTool;\r\n\r\n  /** Tool that wraps getBoundingClientRect with consistent output. */\r\n  boundingClientRect: BoundingClientRectTool;\r\n\r\n  /** Tool for parsing string-based values like '50%', '2rem', 'selfHeight'. */\r\n  unitParser: UnitParserTool;\r\n\r\n  /** Tool for performing linear interpolation (lerp). */\r\n  lerp: LerpTool;\r\n\r\n  /**\r\n   * Tool for adaptive interpolation based on dynamic input value.\r\n   * Useful when smoothing cursor speed, scroll velocity, etc.\r\n   */\r\n  adaptiveLerp: AdaptiveLerpTool;\r\n\r\n  /**\r\n   * Tool for parsing origin strings.\r\n   * Supports values like `'top'`, `'center'`, or random expressions like `'random(top, bottom)'`.\r\n   */\r\n  originParser: OriginParserTool;\r\n\r\n  /**\r\n   * Tool for parsing CSS color strings into { r, g, b, a } format.\r\n   * Supports `#hex`, `rgb[a](...)`, `hsl[a](...)` inputs.\r\n   */\r\n  colorParser: ColorParserTool;\r\n\r\n  /**\r\n   * Tool for validating strings using rules like `required`, `minLength`, `email`, etc.\r\n   * Returns validation status, error code, and optional message.\r\n   */\r\n  validation: ValidationTool;\r\n\r\n  /**\r\n   * Tool for parsing CSS-like easing strings into easing functions.\r\n   * Supports keywords like `'ease'`, `'linear'`, and full `cubic-bezier(...)` expressions.\r\n   */\r\n  easingFunction: EasingFunctionTool;\r\n\r\n  /**\r\n   * Tool for calculating magnetic offset strength based on proximity to pointer.\r\n   */\r\n  magneticPull: MagneticPullTool;\r\n\r\n  /**\r\n   * Tool for interpolating between two RGBA colors.\r\n   * Accepts `from` and `to` colors as `{ r, g, b, a }`, and a `progress` value from `0` to `1`.\r\n   * Returns an interpolated `StringColor` object.\r\n   */\r\n  lerpColor: LerpColorTool;\r\n\r\n  /**\r\n   * Tool for interpolating between two 2D vectors.\r\n   * Accepts `{ x, y }` objects and a `progress` value between `0` and `1`.\r\n   * Returns a new `{ x, y }` vector.\r\n   */\r\n  lerpVector: LerpVector2Tool;\r\n\r\n  transformScaleParser: TransformScaleParserTool;\r\n\r\n  optionsParser: SplitOptionsParserTool;\r\n\r\n  ruleParser: RuleParserTool;\r\n}\r\n\r\n/**\r\n * Default implementation of the StringToolContainer,\r\n * which provides ready-to-use instances of all core tools.\r\n */\r\nexport class DefaultToolsContainer implements StringToolsContainer {\r\n  public domAttribute = new DOMAttributeTool();\r\n  public recordAttribute = new RecordAttributeTool();\r\n  public transformNullify = new TransformNullifyTool();\r\n  public boundingClientRect = new BoundingClientRectTool();\r\n  public relativePosition = new RelativePositionTool(this.transformNullify);\r\n  public unitParser = new UnitParserTool();\r\n  public lerp = new LerpTool();\r\n  public adaptiveLerp = new AdaptiveLerpTool();\r\n  public originParser = new OriginParserTool();\r\n  public colorParser = new ColorParserTool();\r\n  public validation = new ValidationTool();\r\n  public easingFunction = new EasingFunctionTool();\r\n  public magneticPull = new MagneticPullTool();\r\n  public lerpColor = new LerpColorTool();\r\n  public lerpVector = new LerpVector2Tool();\r\n  public transformScaleParser = new TransformScaleParserTool();\r\n  public optionsParser = new SplitOptionsParserTool();\r\n  public ruleParser = new RuleParserTool();\r\n}\r\n","export function isCoarsePointer(): boolean {\n  const mm =\n    typeof window !== \"undefined\" && typeof window.matchMedia === \"function\"\n      ? window.matchMedia(\"(pointer: coarse)\").matches\n      : false;\n  const touch = typeof navigator !== \"undefined\" ? (navigator.maxTouchPoints || 0) > 0 : false;\n  const narrow = typeof window !== \"undefined\" ? window.innerWidth <= 768 : false;\n  return mm || touch || narrow;\n}\n","type StyleValue = string | number;\ntype StyleVars = Record<string, StyleValue>;\ntype StyleProps = Record<string, StyleValue>;\n\nclass StyleTxn {\n  private pendingVars = new Map<Element, StyleVars>();\n  private pendingProps = new Map<Element, StyleProps>();\n  private isOpen = false;\n\n  public begin(): void {\n    if (this.isOpen) return;\n    this.isOpen = true;\n  }\n\n  public setVars(el: Element, vars: StyleVars): void {\n    if (!this.isOpen) {\n      console.warn(\"StyleTxn: call begin() first to set custom properties.\");\n      return;\n    }\n    const currentVars = this.pendingVars.get(el) ?? {};\n    for (const [k, v] of Object.entries(vars)) {\n      if (currentVars[k] === v) continue;\n      currentVars[k] = v;\n    }\n    this.pendingVars.set(el, currentVars);\n  }\n\n  public setProps(el: Element, props: StyleProps): void {\n    if (!this.isOpen) {\n      console.warn(\"StyleTxn: call begin() first to set standard properties.\");\n      return;\n    }\n    const currentProps = this.pendingProps.get(el) ?? {};\n    for (const [k, v] of Object.entries(props)) {\n      if (currentProps[k] === v) continue;\n      currentProps[k] = v;\n    }\n\n    this.pendingProps.set(el, currentProps);\n  }\n\n  public run(fn: () => void): void {\n    const alreadyOpen = this.isOpen;\n    if (!alreadyOpen) {\n      this.begin();\n    }\n    try {\n      fn();\n      if (!alreadyOpen) {\n        this.commit();\n      }\n    } catch (error) {\n      if (!alreadyOpen) {\n        this.cancel();\n      }\n      throw error;\n    }\n  }\n\n  public commit(): void {\n    if (!this.isOpen) return;\n    this.isOpen = false;\n\n    for (const [el, vars] of this.pendingVars) {\n      const style = (el as HTMLElement).style;\n      for (const [k, v] of Object.entries(vars)) {\n        style.setProperty(k, String(v));\n      }\n    }\n    this.pendingVars.clear();\n\n    for (const [el, props] of this.pendingProps) {\n      const style = (el as HTMLElement).style;\n      for (const [k, v] of Object.entries(props)) {\n        (style as any)[k] = String(v);\n      }\n    }\n    this.pendingProps.clear();\n  }\n\n  public cancel(): void {\n    this.pendingVars.clear();\n    this.pendingProps.clear();\n    this.isOpen = false;\n  }\n}\n\nexport const styleTxn = new StyleTxn();\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { isCoarsePointer } from \"../../utils/isCoarsePointer\";\r\nimport { styleTxn } from \"../../utils/style-txn\";\r\n\r\ntype CursorTargetState = {\r\n  prevX: number;\r\n  prevY: number;\r\n};\r\n\r\ntype CursorObjectDimensions = {\r\n  width: number;\r\n  height: number;\r\n  halfWidth: number;\r\n  halfHeight: number;\r\n};\r\n\r\ntype CursorPrevSnapshot = {\r\n  x: number;\r\n  y: number;\r\n  stepX: number;\r\n  stepY: number;\r\n};\r\n\r\ntype CursorPortal = {\r\n  id: string;\r\n  element: HTMLElement;\r\n  content: HTMLElement | null;\r\n  prev: CursorPrevSnapshot;\r\n  hoverCount: number;\r\n  showTimer: ReturnType<typeof setTimeout> | null;\r\n  lerp: number | null;\r\n};\r\n\r\nconst targetStates = new WeakMap<StringObject, CursorTargetState>();\r\nconst CURSOR_EPSILON = 0.0005;\r\nconst DEFAULT_CURSOR_ID = \"default\";\r\nconst CURSOR_PORTAL_SELECTOR = \"[string-cursor],[data-string-cursor]\";\r\nconst CURSOR_PORTAL_CONTENT_SELECTOR = \"[string-cursor-content],[data-string-cursor-content]\";\r\nconst MIN_FRAME_DELTA = 1 / 240;\r\n\r\nfunction getTargetState(object: StringObject): CursorTargetState {\r\n  let state = targetStates.get(object);\r\n  if (!state) {\r\n    state = { prevX: Number.NaN, prevY: Number.NaN };\r\n    targetStates.set(object, state);\r\n  }\r\n  return state;\r\n}\r\n\r\n/**\r\n * StringCursor Module\r\n *\r\n * Handles cursor tracking and hover states for StringTune objects.\r\n *\r\n * Safari Navigation Fix:\r\n * Safari has an issue where mouseleave events are not fired when navigation occurs\r\n * (especially with NuxtLink/router navigation). This module includes several\r\n * workarounds to ensure proper cleanup:\r\n *\r\n * 1. MutationObserver - detects when elements are removed from DOM\r\n * 2. beforeunload/pagehide - captures traditional navigation\r\n * 3. visibilitychange - captures modern SPA navigation\r\n * 4. DOM existence checks - prevents operations on removed elements\r\n */\r\nexport class StringCursor extends StringModule {\r\n  private cursorPrev: CursorPrevSnapshot = {\r\n    x: Number.NaN,\r\n    y: Number.NaN,\r\n    stepX: Number.NaN,\r\n    stepY: Number.NaN,\r\n  };\r\n  private cursorPortals: Map<string, CursorPortal[]> = new Map();\r\n  private hoveredObjects: Set<StringObject> = new Set();\r\n  private globalListenersBound = false;\r\n  private boundBeforeUnload = () => this.cleanupHoverTargets();\r\n  private boundPageHide = () => this.cleanupHoverTargets();\r\n  private boundVisibilityChange = () => {\r\n    if (document.hidden) {\r\n      this.cleanupHoverTargets();\r\n    }\r\n  };\r\n  protected enabled = true;\r\n\r\n  private lastFrameTime: number = 0;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"cursor\";\r\n\r\n    this.permissions.mobile.rebuild.height = false;\r\n    this.permissions.mobile.rebuild.width = false;\r\n    this.permissions.mobile.rebuild.scrollHeight = false;\r\n\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      {\r\n        key: \"target-disable\",\r\n        type: \"boolean\",\r\n        fallback: this.settings[\"target-disable\"],\r\n      },\r\n      {\r\n        key: \"target-style-disable\",\r\n        type: \"boolean\",\r\n        fallback: this.settings[\"target-style-disable\"],\r\n      },\r\n      {\r\n        key: \"cursor-target\",\r\n        type: \"string\",\r\n        fallback: this.settings[\"cursor-target\"] ?? DEFAULT_CURSOR_ID,\r\n      },\r\n      {\r\n        key: \"target-class\",\r\n        type: \"string\",\r\n        fallback: this.settings[\"target-class\"],\r\n      },\r\n      {\r\n        key: \"cursor-class\",\r\n        type: \"string\",\r\n        fallback: this.settings[\"cursor-class\"],\r\n      },\r\n      {\r\n        key: \"alignment\",\r\n        type: { type: \"enum\", values: [\"start\", \"center\", \"end\"] },\r\n        fallback: this.settings[\"alignment\"],\r\n      },\r\n      {\r\n        key: \"lerp\",\r\n        type: \"number\",\r\n        fallback: this.settings[\"lerp\"],\r\n        transform: (value: number) => {\r\n          return this.tools.adaptiveLerp.process({\r\n            value,\r\n            inMin: 0.1,\r\n            inMax: 1.0,\r\n            outMin: 0.05,\r\n            outMax: 0.65,\r\n          });\r\n        },\r\n      },\r\n    ];\r\n\r\n    if (isCoarsePointer()) {\r\n      this.enabled = false;\r\n    }\r\n\r\n    this.collectCursorPortals();\r\n    if (this.enabled) {\r\n      this.bindGlobalLifecycleListeners();\r\n    }\r\n  }\r\n\r\n  initializeObject(\r\n    globalId: number,\r\n    object: StringObject,\r\n    element: HTMLElement,\r\n    attributes: Record<string, any>\r\n  ): void {\r\n    super.initializeObject(globalId, object, element, attributes);\r\n    object.setProperty(\"mouse-x\", 0);\r\n    object.setProperty(\"mouse-y\", 0);\r\n    object.setProperty(\"mouse-pixel-x\", 0);\r\n    object.setProperty(\"mouse-pixel-y\", 0);\r\n    object.setProperty(\"is-mouse-over\", false);\r\n    object.setProperty(\"is-mouse-move\", false);\r\n  }\r\n\r\n  onMutate(data: StringData): void {\r\n    if (!this.enabled) return;\r\n\r\n    const now = performance.now();\r\n\r\n    let dt = this.lastFrameTime ? (now - this.lastFrameTime) / 1000 : 0.016;\r\n    this.lastFrameTime = now;\r\n    if (dt > 0.1) dt = 0.1;\r\n    if (dt < MIN_FRAME_DELTA) dt = MIN_FRAME_DELTA;\r\n\r\n    const cursorX = this.data.cursor.targetX;\r\n    const cursorY = this.data.cursor.targetY;\r\n\r\n    this.objects.forEach((object) => {\r\n      const isOver = object.getProperty<boolean>(\"is-mouse-over\");\r\n      const isDisabled = object.getProperty<boolean>(\"cursor-target-disable\");\r\n      const baseLerp = object.getProperty<number>(\"lerp\") ?? 0.15;\r\n      const frameLerp = this.getFrameAdjustedLerp(baseLerp, dt);\r\n\r\n      const dimensions = this.getObjectDimensions(object);\r\n      const { halfWidth, halfHeight, width, height } = dimensions;\r\n\r\n      if (isOver && !isDisabled) {\r\n        const { cx, cy } = this.centers.getCenter(object);\r\n        const elementX = cursorX - (cx - halfWidth);\r\n        const elementY = cursorY - (cy - halfHeight);\r\n\r\n        let px = object.getProperty<number>(\"mouse-pixel-x\") ?? 0;\r\n        let py = object.getProperty<number>(\"mouse-pixel-y\") ?? 0;\r\n\r\n        const dx = px - elementX;\r\n        const dy = py - elementY;\r\n        const distSquared = dx * dx + dy * dy;\r\n\r\n        if (distSquared > 0.0001) {\r\n          const isMoving = object.getProperty<boolean>(\"is-mouse-move\") ?? false;\r\n          if (!isMoving) {\r\n            object.setProperty(\"is-mouse-move\", true);\r\n            object.setProperty(\"mouse-pixel-x\", elementX);\r\n            object.setProperty(\"mouse-pixel-y\", elementY);\r\n            object.setProperty(\"mouse-x\", elementX);\r\n            object.setProperty(\"mouse-y\", elementY);\r\n            px = elementX;\r\n            py = elementY;\r\n            this.events.emit(`cursor:start:${object.id}`, null);\r\n          }\r\n\r\n          const lerpedX = this.tools.lerp.process({\r\n            from: px,\r\n            to: elementX,\r\n            progress: frameLerp,\r\n          });\r\n          const lerpedY = this.tools.lerp.process({\r\n            from: py,\r\n            to: elementY,\r\n            progress: frameLerp,\r\n          });\r\n\r\n          const updatedX = px + lerpedX;\r\n          const updatedY = py + lerpedY;\r\n          const pixelChanged =\r\n            Math.abs(updatedX - px) > CURSOR_EPSILON || Math.abs(updatedY - py) > CURSOR_EPSILON;\r\n\r\n          object.setProperty(\"mouse-pixel-x\", updatedX);\r\n          object.setProperty(\"mouse-pixel-y\", updatedY);\r\n\r\n          const alignment = object.getProperty<string>(\"alignment\") ?? \"center\";\r\n          const offsetX = this.calculateOffset(alignment, updatedX, width);\r\n          const offsetY = this.calculateOffset(alignment, updatedY, height);\r\n\r\n          object.setProperty(\"mouse-x\", offsetX);\r\n          object.setProperty(\"mouse-y\", offsetY);\r\n\r\n          const coordsChanged = this.setMouseCoordinates(object, offsetX, offsetY);\r\n\r\n          if (coordsChanged) {\r\n            this.events.emit(`cursor:move:${object.id}`, {\r\n              x: offsetX,\r\n              y: offsetY,\r\n            });\r\n          }\r\n          if (pixelChanged) {\r\n            this.events.emit(`cursor:pixel:${object.id}`, {\r\n              x: updatedX,\r\n              y: updatedY,\r\n            });\r\n          }\r\n        } else {\r\n          object.setProperty(\"mouse-pixel-x\", elementX);\r\n          object.setProperty(\"mouse-pixel-y\", elementY);\r\n          if (object.getProperty<boolean>(\"is-mouse-move\")) {\r\n            object.setProperty(\"is-mouse-move\", false);\r\n            this.events.emit(`cursor:end:${object.id}`, null);\r\n          }\r\n          this.setMouseCoordinates(object, 0, 0);\r\n        }\r\n      } else {\r\n        const mouseX = object.getProperty<number>(\"mouse-x\") ?? 0;\r\n        const mouseY = object.getProperty<number>(\"mouse-y\") ?? 0;\r\n        if (mouseX !== 0 || mouseY !== 0) {\r\n          object.setProperty(\"is-mouse-move\", false);\r\n\r\n          const targetX = this.calculateOffset(\"center\", halfWidth, width);\r\n          const targetY = this.calculateOffset(\"center\", halfHeight, height);\r\n\r\n          const newMouseX =\r\n            mouseX +\r\n            this.tools.lerp.process({\r\n              from: mouseX,\r\n              to: targetX,\r\n              progress: frameLerp,\r\n            });\r\n          const newMouseY =\r\n            mouseY +\r\n            this.tools.lerp.process({\r\n              from: mouseY,\r\n              to: targetY,\r\n              progress: frameLerp,\r\n            });\r\n\r\n          object.setProperty(\"mouse-x\", newMouseX);\r\n          object.setProperty(\"mouse-y\", newMouseY);\r\n\r\n          if (Math.abs(newMouseX) < 0.001 && Math.abs(newMouseY) < 0.001) {\r\n            object.setProperty(\"mouse-x\", 0);\r\n            object.setProperty(\"mouse-y\", 0);\r\n            object.setProperty(\"mouse-pixel-x\", 0);\r\n            object.setProperty(\"mouse-pixel-y\", 0);\r\n            this.setMouseCoordinates(object, 0, 0);\r\n          } else {\r\n            this.setMouseCoordinates(object, newMouseX, newMouseY);\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (this.cursorPortals.size > 0) {\r\n      const { stepX, stepY, smoothedX, smoothedY } = this.data.cursor;\r\n      const prev = this.cursorPrev;\r\n      const cursorChanged =\r\n        !Number.isFinite(prev.x) ||\r\n        Math.abs(smoothedX - prev.x) > CURSOR_EPSILON ||\r\n        Math.abs(smoothedY - prev.y) > CURSOR_EPSILON ||\r\n        Math.abs(stepX - prev.stepX) > CURSOR_EPSILON ||\r\n        Math.abs(stepY - prev.stepY) > CURSOR_EPSILON;\r\n\r\n      if (cursorChanged) {\r\n        this.events.emit(\"cursor\", {\r\n          stepX,\r\n          stepY,\r\n          x: smoothedX,\r\n          y: smoothedY,\r\n        });\r\n\r\n        this.cursorPrev = { x: smoothedX, y: smoothedY, stepX, stepY };\r\n      }\r\n\r\n      const targetX = this.data.cursor.targetX;\r\n      const targetY = this.data.cursor.targetY;\r\n      this.cursorPortals.forEach((bucket) => {\r\n        bucket.forEach((portal) => {\r\n          this.updatePortalPosition(portal, targetX, targetY, dt);\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  onObjectConnected(object: StringObject) {\r\n    const element = object.htmlElement;\r\n    this.centers.attach(object);\r\n\r\n    object.setProperty(\"mouseleave\", () => {\r\n      this.onMouseLeave(object);\r\n    });\r\n    object.setProperty(\"mouseenter\", () => {\r\n      this.onMouseEnter(object);\r\n    });\r\n\r\n    object.setProperty(\"onEnterEvent\", this.onEnterObject.bind(this));\r\n    object.events.on(\"enter\", object.getProperty<(object: StringObject) => void>(\"onEnterEvent\"));\r\n    object.setProperty(\"onLeaveEvent\", this.onLeaveObject.bind(this));\r\n    object.events.on(\"leave\", object.getProperty<(object: StringObject) => void>(\"onLeaveEvent\"));\r\n  }\r\n\r\n  getCursorClass(object: StringObject) {\r\n    const value = object.getProperty<string>(\"cursor-class\");\r\n    return value != null && value.length > 0 ? value : null;\r\n  }\r\n\r\n  onMouseEnter(object: StringObject) {\r\n    if (!document.contains(object.htmlElement)) {\r\n      return;\r\n    }\r\n\r\n    object.setProperty(\"is-mouse-over\", true);\r\n    this.hoveredObjects.add(object);\r\n\r\n    const cursorClass = this.getCursorClass(object);\r\n\r\n    this.withPortalsForObject(object, (portal) => {\r\n      if (cursorClass) {\r\n        portal.element.classList.add(cursorClass);\r\n      }\r\n      this.incrementPortalHover(portal);\r\n    });\r\n\r\n    object.htmlElement.addEventListener(\"mouseleave\", object.getProperty(\"mouseleave\"));\r\n  }\r\n\r\n  onMouseLeave(object: StringObject) {\r\n    object.setProperty(\"is-mouse-over\", false);\r\n    this.hoveredObjects.delete(object);\r\n\r\n    const cursorClass = this.getCursorClass(object);\r\n\r\n    this.withPortalsForObject(object, (portal) => {\r\n      if (cursorClass) {\r\n        portal.element.classList.remove(cursorClass);\r\n      }\r\n      this.decrementPortalHover(portal);\r\n    });\r\n\r\n    if (document.contains(object.htmlElement)) {\r\n      object.htmlElement.removeEventListener(\"mouseleave\", object.getProperty(\"mouseleave\"));\r\n    }\r\n  }\r\n\r\n  private onEnterObject(object: StringObject) {\r\n    object.htmlElement.addEventListener(\"mouseenter\", object.getProperty(\"mouseenter\"));\r\n  }\r\n\r\n  private onLeaveObject(object: StringObject) {\r\n    object.htmlElement.removeEventListener(\"mouseenter\", object.getProperty(\"mouseenter\"));\r\n    object.htmlElement.removeEventListener(\"mouseleave\", object.getProperty(\"mouseleave\"));\r\n  }\r\n\r\n  private safariNavigationCleanup(object: StringObject): void {\r\n    if (object.getProperty<boolean>(\"is-mouse-over\")) {\r\n      this.onMouseLeave(object);\r\n    }\r\n  }\r\n\r\n  private onElementRemovedFromDOM(object: StringObject): void {\r\n    if (object.getProperty<boolean>(\"is-mouse-over\")) {\r\n      this.onMouseLeave(object);\r\n    }\r\n  }\r\n\r\n  onObjectDisconnected(object: StringObject): void {\r\n    if (object.getProperty<boolean>(\"is-mouse-over\")) {\r\n      this.onMouseLeave(object);\r\n    }\r\n  }\r\n\r\n  onDOMRebuild(): void {\r\n    if (!this.enabled) return;\r\n    this.collectCursorPortals();\r\n  }\r\n\r\n  onDOMMutate(added: NodeList, removed: NodeList): void {\r\n    if (!this.enabled) return;\r\n    if (this.shouldRefreshPortals(added) || this.shouldRefreshPortals(removed)) {\r\n      this.collectCursorPortals();\r\n    }\r\n    if (removed.length > 0) {\r\n      this.handleRemovedNodes(removed);\r\n    }\r\n  }\r\n\r\n  private collectCursorPortals(): void {\r\n    this.cursorPortals.clear();\r\n    const nodes = document.querySelectorAll(CURSOR_PORTAL_SELECTOR);\r\n    nodes.forEach((node) => {\r\n      if (!(node instanceof HTMLElement)) return;\r\n      const id = this.resolvePortalId(node);\r\n      const customLerp = this.resolvePortalLerp(node);\r\n      const content = node.matches(CURSOR_PORTAL_CONTENT_SELECTOR)\r\n        ? node\r\n        : (node.querySelector(CURSOR_PORTAL_CONTENT_SELECTOR) as HTMLElement | null);\r\n\r\n      const targetX = this.data.cursor.targetX;\r\n      const targetY = this.data.cursor.targetY;\r\n      const portal: CursorPortal = {\r\n        id,\r\n        element: node,\r\n        content,\r\n        prev: { x: targetX, y: targetY, stepX: 0, stepY: 0 },\r\n        hoverCount: 0,\r\n        showTimer: null,\r\n        lerp: customLerp,\r\n      };\r\n\r\n      const existing = this.cursorPortals.get(id);\r\n      if (existing) {\r\n        existing.push(portal);\r\n      } else {\r\n        this.cursorPortals.set(id, [portal]);\r\n      }\r\n    });\r\n  }\r\n\r\n  private resolvePortalId(element: HTMLElement): string {\r\n    const attrSources = [\r\n      element.getAttribute(\"data-string-cursor\"),\r\n      element.getAttribute(\"string-cursor\"),\r\n      element.getAttribute(\"data-string-cursor-id\"),\r\n      element.getAttribute(\"string-cursor-id\"),\r\n    ];\r\n\r\n    for (const source of attrSources) {\r\n      if (source && source.trim().length > 0) {\r\n        return source.trim();\r\n      }\r\n    }\r\n\r\n    return DEFAULT_CURSOR_ID;\r\n  }\r\n\r\n  private resolvePortalLerp(element: HTMLElement): number | null {\r\n    const raw =\r\n      element.getAttribute(\"data-string-cursor-lerp\") ??\r\n      element.getAttribute(\"string-cursor-lerp\") ??\r\n      this.settings[\"cursor-lerp\"];\r\n    if (!raw) {\r\n      return null;\r\n    }\r\n\r\n    const value = parseFloat(raw);\r\n    if (!Number.isFinite(value)) {\r\n      return null;\r\n    }\r\n\r\n    const clamped = Math.min(1, Math.max(0.01, value));\r\n    return this.tools.adaptiveLerp.process({\r\n      value: clamped,\r\n      inMin: 0.1,\r\n      inMax: 1.0,\r\n      outMin: 0.05,\r\n      outMax: 0.65,\r\n    });\r\n  }\r\n\r\n  private shouldRefreshPortals(nodes: NodeList): boolean {\r\n    for (const node of nodes) {\r\n      if (!(node instanceof Element)) continue;\r\n      if (node.matches(CURSOR_PORTAL_SELECTOR)) {\r\n        return true;\r\n      }\r\n      if (node.querySelector(CURSOR_PORTAL_SELECTOR)) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private withPortalsForObject(\r\n    object: StringObject | null,\r\n    cb: (portal: CursorPortal) => void\r\n  ): void {\r\n    const portals = this.getPortalsForObject(object);\r\n    portals.forEach((portal) => cb(portal));\r\n  }\r\n\r\n  private getPortalsForObject(object: StringObject | null): CursorPortal[] {\r\n    if (this.cursorPortals.size === 0) {\r\n      return [];\r\n    }\r\n\r\n    const ids = this.extractPortalIds(object);\r\n    const selected: CursorPortal[] = [];\r\n\r\n    ids.forEach((id) => {\r\n      if (id === \"*\") {\r\n        this.cursorPortals.forEach((bucket) => {\r\n          bucket.forEach((portal) => selected.push(portal));\r\n        });\r\n        return;\r\n      }\r\n\r\n      const normalized = id.length > 0 ? id : DEFAULT_CURSOR_ID;\r\n      const portals = this.cursorPortals.get(normalized);\r\n      if (portals) {\r\n        portals.forEach((portal) => selected.push(portal));\r\n      }\r\n    });\r\n\r\n    if (selected.length === 0) {\r\n      const fallbackBucket =\r\n        this.cursorPortals.get(DEFAULT_CURSOR_ID) ?? this.cursorPortals.values().next().value;\r\n      if (fallbackBucket && fallbackBucket.length > 0) {\r\n        fallbackBucket.forEach((portal: any) => selected.push(portal));\r\n      }\r\n    }\r\n\r\n    return selected;\r\n  }\r\n\r\n  private extractPortalIds(object: StringObject | null): string[] {\r\n    if (!object) return [DEFAULT_CURSOR_ID];\r\n    const raw = object.getProperty<string>(\"cursor-target\");\r\n    if (typeof raw !== \"string\" || raw.trim().length === 0) {\r\n      return [DEFAULT_CURSOR_ID];\r\n    }\r\n\r\n    return raw\r\n      .split(/[,|]/)\r\n      .map((value) => value.trim())\r\n      .filter(Boolean);\r\n  }\r\n\r\n  private incrementPortalHover(portal: CursorPortal): void {\r\n    portal.hoverCount++;\r\n    portal.element.classList.remove(\"-show\");\r\n    this.restartPortalShowTimer(portal);\r\n  }\r\n\r\n  private decrementPortalHover(portal: CursorPortal): void {\r\n    portal.hoverCount = Math.max(0, portal.hoverCount - 1);\r\n    if (portal.hoverCount === 0) {\r\n      this.clearPortalShowTimer(portal);\r\n      portal.element.classList.remove(\"-show\");\r\n    }\r\n  }\r\n\r\n  private restartPortalShowTimer(portal: CursorPortal): void {\r\n    this.clearPortalShowTimer(portal);\r\n    if (!portal.element.isConnected) {\r\n      portal.showTimer = null;\r\n      return;\r\n    }\r\n    portal.element.classList.add(\"-show\");\r\n    portal.showTimer = null;\r\n  }\r\n\r\n  private clearPortalShowTimer(portal: CursorPortal): void {\r\n    if (portal.showTimer) {\r\n      clearTimeout(portal.showTimer);\r\n      portal.showTimer = null;\r\n    }\r\n  }\r\n\r\n  private updatePortalPosition(\r\n    portal: CursorPortal,\r\n    targetX: number,\r\n    targetY: number,\r\n    dt: number\r\n  ): void {\r\n    if (!portal.element.isConnected) return;\r\n\r\n    const prev = portal.prev;\r\n\r\n    const currentX = Number.isFinite(prev.x) ? prev.x : targetX;\r\n    const currentY = Number.isFinite(prev.y) ? prev.y : targetY;\r\n\r\n    const factor = portal.lerp ?? 0.1;\r\n    const fpsAdjustedLerp = this.getFrameAdjustedLerp(factor, dt);\r\n\r\n    const stepX = (targetX - currentX) * fpsAdjustedLerp;\r\n    const stepY = (targetY - currentY) * fpsAdjustedLerp;\r\n\r\n    const safeDt = dt > 1e-4 ? dt : 1 / 60;\r\n    const normalizedVelocityX = stepX / (safeDt * 60);\r\n    const normalizedVelocityY = stepY / (safeDt * 60);\r\n\r\n    if (Math.abs(stepX) < CURSOR_EPSILON && Math.abs(stepY) < CURSOR_EPSILON) {\r\n      return;\r\n    }\r\n\r\n    const nextX = currentX + stepX;\r\n    const nextY = currentY + stepY;\r\n\r\n    portal.element.style.setProperty(\"--x\", nextX.toFixed(2));\r\n    portal.element.style.setProperty(\"--y\", nextY.toFixed(2));\r\n\r\n    portal.element.style.setProperty(\"--x-lerp\", normalizedVelocityX.toFixed(3));\r\n    portal.element.style.setProperty(\"--y-lerp\", normalizedVelocityY.toFixed(3));\r\n\r\n    prev.x = nextX;\r\n    prev.y = nextY;\r\n    prev.stepX = stepX;\r\n    prev.stepY = stepY;\r\n  }\r\n\r\n  private handleRemovedNodes(nodes: NodeList): void {\r\n    if (this.hoveredObjects.size === 0) {\r\n      return;\r\n    }\r\n    Array.from(this.hoveredObjects).forEach((object) => {\r\n      if (!object.htmlElement.isConnected) {\r\n        this.onElementRemovedFromDOM(object);\r\n      }\r\n    });\r\n  }\r\n\r\n  private cleanupHoverTargets(): void {\r\n    if (this.hoveredObjects.size === 0) {\r\n      return;\r\n    }\r\n    Array.from(this.hoveredObjects).forEach((object) => this.safariNavigationCleanup(object));\r\n  }\r\n\r\n  private bindGlobalLifecycleListeners(): void {\r\n    if (this.globalListenersBound) {\r\n      return;\r\n    }\r\n    window.addEventListener(\"beforeunload\", this.boundBeforeUnload);\r\n    window.addEventListener(\"pagehide\", this.boundPageHide);\r\n    document.addEventListener(\"visibilitychange\", this.boundVisibilityChange);\r\n    this.globalListenersBound = true;\r\n  }\r\n\r\n  private unbindGlobalLifecycleListeners(): void {\r\n    if (!this.globalListenersBound) {\r\n      return;\r\n    }\r\n    window.removeEventListener(\"beforeunload\", this.boundBeforeUnload);\r\n    window.removeEventListener(\"pagehide\", this.boundPageHide);\r\n    document.removeEventListener(\"visibilitychange\", this.boundVisibilityChange);\r\n    this.globalListenersBound = false;\r\n  }\r\n\r\n  private setMouseCoordinates(object: StringObject, x: number, y: number): boolean {\r\n    if (object.getProperty(\"cursor-target-style-disable\")) {\r\n      return false;\r\n    }\r\n\r\n    const state = getTargetState(object);\r\n    const roundedX =\r\n      Math.abs(x) < CURSOR_EPSILON && Number.isFinite(state.prevX)\r\n        ? state.prevX\r\n        : Math.round(x * 100) / 100;\r\n    const roundedY =\r\n      Math.abs(y) < CURSOR_EPSILON && Number.isFinite(state.prevY)\r\n        ? state.prevY\r\n        : Math.round(y * 100) / 100;\r\n\r\n    if (\r\n      Number.isFinite(state.prevX) &&\r\n      Math.abs(roundedX - state.prevX) <= CURSOR_EPSILON &&\r\n      Number.isFinite(state.prevY) &&\r\n      Math.abs(roundedY - state.prevY) <= CURSOR_EPSILON\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    state.prevX = roundedX;\r\n    state.prevY = roundedY;\r\n\r\n    const valueX = roundedX.toFixed(2);\r\n    const valueY = roundedY.toFixed(2);\r\n\r\n    this.applyToElementAndConnects(object, (el) => {\r\n      styleTxn.setVars(el, { \"--x\": valueX, \"--y\": valueY });\r\n    });\r\n\r\n    return true;\r\n  }\r\n\r\n  private getFrameAdjustedLerp(base: number, dt: number): number {\r\n    const clampedBase = Math.min(0.99, Math.max(0.001, base));\r\n    if (!Number.isFinite(dt) || dt <= 0) {\r\n      return clampedBase;\r\n    }\r\n\r\n    const normalizedDt = Math.max(dt, MIN_FRAME_DELTA);\r\n    const frames = normalizedDt * 60;\r\n    const adjusted = 1 - Math.pow(1 - clampedBase, frames);\r\n    return Math.min(0.999, Math.max(0.0001, adjusted));\r\n  }\r\n\r\n  private getObjectDimensions(object: StringObject): CursorObjectDimensions {\r\n    const element = object.htmlElement;\r\n    const fallbackWidth = element.offsetWidth || element.clientWidth || element.scrollWidth || 1;\r\n    const fallbackHeight =\r\n      element.offsetHeight || element.clientHeight || element.scrollHeight || 1;\r\n\r\n    const rawHalfWidth = object.getProperty<number>(\"half-width\");\r\n    const rawHalfHeight = object.getProperty<number>(\"half-height\");\r\n\r\n    const halfWidth =\r\n      typeof rawHalfWidth === \"number\" && Number.isFinite(rawHalfWidth)\r\n        ? rawHalfWidth\r\n        : fallbackWidth / 2;\r\n    const halfHeight =\r\n      typeof rawHalfHeight === \"number\" && Number.isFinite(rawHalfHeight)\r\n        ? rawHalfHeight\r\n        : fallbackHeight / 2;\r\n\r\n    const width = halfWidth > 0 ? halfWidth * 2 : fallbackWidth;\r\n    const height = halfHeight > 0 ? halfHeight * 2 : fallbackHeight;\r\n\r\n    return { width, height, halfWidth, halfHeight };\r\n  }\r\n\r\n  private calculateOffset(alignment: string, mousePos: number, size: number): number {\r\n    switch (alignment) {\r\n      case \"start\":\r\n        return mousePos / size;\r\n      case \"end\":\r\n        return (mousePos - size) / size;\r\n      case \"center\":\r\n      default:\r\n        return (mousePos - size / 2) / (size / 2);\r\n    }\r\n  }\r\n\r\n  override removeObject(id: string): void {\r\n    if (!this.enabled) return super.removeObject(id);\r\n    const obj = this.objectMapOnPage.get(id);\r\n    if (obj) {\r\n      this.centers.detach(obj);\r\n    }\r\n    super.removeObject(id);\r\n  }\r\n\r\n  override destroy(): void {\r\n    this.unbindGlobalLifecycleListeners();\r\n    this.hoveredObjects.clear();\r\n    super.destroy();\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\n\r\nexport class StringImpulse extends StringModule {\r\n  private originObservers = new WeakMap<StringObject, MutationObserver>();\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"impulse\";\r\n\r\n    this.attributesToMap.push(\r\n      { key: \"position-strength\", type: \"number\", fallback: this.settings[\"position-strength\"] },\r\n      { key: \"position-tension\", type: \"number\", fallback: this.settings[\"position-tension\"] },\r\n      { key: \"position-friction\", type: \"number\", fallback: this.settings[\"position-friction\"] },\r\n      {\r\n        key: \"position-max-velocity\",\r\n        type: \"number\",\r\n        fallback: this.settings[\"position-max-velocity\"],\r\n      },\r\n      {\r\n        key: \"position-update-threshold\",\r\n        type: \"number\",\r\n        fallback: this.settings[\"position-update-threshold\"],\r\n      },\r\n\r\n      // rotate\r\n      { key: \"rotation-strength\", type: \"number\", fallback: this.settings[\"rotation-strength\"] },\r\n      { key: \"rotation-tension\", type: \"number\", fallback: this.settings[\"rotation-tension\"] },\r\n      { key: \"rotation-friction\", type: \"number\", fallback: this.settings[\"rotation-friction\"] },\r\n      {\r\n        key: \"rotation-max-angular-velocity\",\r\n        type: \"number\",\r\n        fallback: this.settings[\"rotation-max-angular-velocity\"],\r\n      },\r\n      { key: \"rotation-max-angle\", type: \"number\", fallback: this.settings[\"rotation-max-angle\"] },\r\n      {\r\n        key: \"rotation-update-threshold\",\r\n        type: \"number\",\r\n        fallback: this.settings[\"rotation-update-threshold\"],\r\n      },\r\n\r\n      { key: \"max-offset\", type: \"number\", fallback: this.settings[\"max-offset\"] },\r\n      { key: \"sleep-epsilon\", type: \"number\", fallback: this.settings[\"sleep-epsilon\"] },\r\n      { key: \"continuous-push\", type: \"boolean\", fallback: this.settings[\"continuous-push\"] },\r\n      {\r\n        key: \"rotation-origin\",\r\n        type: \"string\",\r\n        fallback: this.settings[\"rotation-origin\"] ?? \"center center\",\r\n      }\r\n    );\r\n  }\r\n\r\n  override onObjectConnected(object: StringObject): void {\r\n    super.onObjectConnected(object);\r\n\r\n    object.setProperty(\"offset-x\", 0);\r\n    object.setProperty(\"offset-y\", 0);\r\n    object.setProperty(\"velocity-x\", 0);\r\n    object.setProperty(\"velocity-y\", 0);\r\n\r\n    object.setProperty(\"angle-deg\", 0);\r\n    object.setProperty(\"ang-vel-deg\", 0);\r\n\r\n    object.setProperty(\"__prev-css-x\", 0);\r\n    object.setProperty(\"__prev-css-y\", 0);\r\n    object.setProperty(\"__prev-css-rot\", 0);\r\n\r\n    object.setProperty(\"__push-latch\", false);\r\n    object.setProperty(\"__rotate-latch\", false);\r\n\r\n    // Cache parsed rotation origin\r\n    this.cacheRotationOrigin(object);\r\n\r\n    // Watch for rotation-origin attribute changes\r\n    this.observeRotationOrigin(object);\r\n\r\n    this.hover.track(object);\r\n    this.centers.attach(object);\r\n  }\r\n\r\n  override onObjectDisconnected(object: StringObject): void {\r\n    this.hover.untrack(object);\r\n    this.centers.detach(object);\r\n\r\n    // Cleanup rotation-origin observer\r\n    const observer = this.originObservers.get(object);\r\n    if (observer) {\r\n      observer.disconnect();\r\n      this.originObservers.delete(object);\r\n    }\r\n  }\r\n\r\n  override onMouseMove(_e?: MouseEvent): void {\r\n    if (!_e) return;\r\n\r\n    const cursorVelocityX = this.data.cursor.velocityX;\r\n    const cursorVelocityY = this.data.cursor.velocityY;\r\n    if (cursorVelocityX === 0 && cursorVelocityY === 0) return;\r\n\r\n    const mouseX = this.data.cursor.targetX;\r\n    const mouseY = this.data.cursor.targetY;\r\n\r\n    for (const object of this.objects) {\r\n      const rect = object.htmlElement.getBoundingClientRect();\r\n      const isUnderCursor =\r\n        mouseX >= rect.left && mouseX <= rect.right && mouseY >= rect.top && mouseY <= rect.bottom;\r\n\r\n      if (isUnderCursor) {\r\n        {\r\n          const w = rect.width || 1;\r\n          const side01 = Math.max(0, Math.min(1, (this.data.cursor.targetX - rect.left) / w));\r\n          this.events.emit(`object:impulse:${object.id}:side`, { value: side01 });\r\n        }\r\n\r\n        const positionStrength = object.getProperty<number>(\"position-strength\") || 0;\r\n        if (positionStrength !== 0) {\r\n          const isContinuousPush = object.getProperty<boolean>(\"continuous-push\") ?? true;\r\n          const isLatched = object.getProperty<boolean>(\"__push-latch\") === true;\r\n          if (isContinuousPush || !isLatched) {\r\n            let objectVelocityX = object.getProperty<number>(\"velocity-x\") || 0;\r\n            let objectVelocityY = object.getProperty<number>(\"velocity-y\") || 0;\r\n            objectVelocityX += cursorVelocityX * positionStrength;\r\n            objectVelocityY += cursorVelocityY * positionStrength;\r\n            object.setProperty(\"velocity-x\", objectVelocityX);\r\n            object.setProperty(\"velocity-y\", objectVelocityY);\r\n            if (!isContinuousPush) object.setProperty(\"__push-latch\", true);\r\n          }\r\n        }\r\n\r\n        const rotationStrength = object.getProperty<number>(\"rotation-strength\") ?? 0.75;\r\n        if (rotationStrength !== 0) {\r\n          const isContinuousPush = object.getProperty<boolean>(\"continuous-push\") ?? true;\r\n          const isLatched = object.getProperty<boolean>(\"__rotate-latch\") === true;\r\n\r\n          if (isContinuousPush || !isLatched) {\r\n            const { centerX, centerY } = this.getRotationOriginFromRect(object, rect);\r\n            const relativeX = mouseX - centerX;\r\n            const relativeY = mouseY - centerY;\r\n            const torque = relativeX * cursorVelocityY - relativeY * cursorVelocityX;\r\n\r\n            let angularVelocityDeg = object.getProperty<number>(\"ang-vel-deg\") || 0;\r\n            angularVelocityDeg += torque * rotationStrength * 0.02;\r\n            object.setProperty(\"ang-vel-deg\", angularVelocityDeg);\r\n            if (!isContinuousPush) object.setProperty(\"__rotate-latch\", true);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parses and caches the rotation origin for an object.\r\n   * Called once on object connection and when attribute changes.\r\n   */\r\n  private cacheRotationOrigin(object: StringObject): void {\r\n    const originValue = object.getProperty<string>(\"rotation-origin\") ?? \"center center\";\r\n    const { x, y } = this.tools.originParser.toNormalized({ value: originValue });\r\n    object.setProperty(\"__rotation-origin-x\", x);\r\n    object.setProperty(\"__rotation-origin-y\", y);\r\n  }\r\n\r\n  /**\r\n   * Observes changes to the rotation-origin attribute and re-caches when changed.\r\n   */\r\n  private observeRotationOrigin(object: StringObject): void {\r\n    const attrName = \"string-rotation-origin\";\r\n    const dataAttrName = \"data-string-rotation-origin\";\r\n\r\n    const observer = new MutationObserver((mutations) => {\r\n      for (const mutation of mutations) {\r\n        if (\r\n          mutation.type === \"attributes\" &&\r\n          (mutation.attributeName === attrName || mutation.attributeName === dataAttrName)\r\n        ) {\r\n          // Re-read attribute and update cache\r\n          const newValue =\r\n            object.htmlElement.getAttribute(attrName) ??\r\n            object.htmlElement.getAttribute(dataAttrName);\r\n          if (newValue !== null) {\r\n            object.setProperty(\"rotation-origin\", newValue);\r\n          }\r\n          this.cacheRotationOrigin(object);\r\n          break;\r\n        }\r\n      }\r\n    });\r\n\r\n    observer.observe(object.htmlElement, {\r\n      attributes: true,\r\n      attributeFilter: [attrName, dataAttrName],\r\n    });\r\n\r\n    this.originObservers.set(object, observer);\r\n  }\r\n\r\n  /**\r\n   * Calculates the rotation origin point using cached normalized values and provided rect.\r\n   * Avoids re-parsing origin string and extra getBoundingClientRect calls.\r\n   */\r\n  private getRotationOriginFromRect(\r\n    object: StringObject,\r\n    rect: DOMRect\r\n  ): { centerX: number; centerY: number } {\r\n    const normalizedX = object.getProperty<number>(\"__rotation-origin-x\") ?? 0.5;\r\n    const normalizedY = object.getProperty<number>(\"__rotation-origin-y\") ?? 0.5;\r\n\r\n    return {\r\n      centerX: rect.left + rect.width * normalizedX,\r\n      centerY: rect.top + rect.height * normalizedY,\r\n    };\r\n  }\r\n\r\n  onFrame(_: StringData): void {\r\n    const mouseX = this.data.cursor.targetX;\r\n    const mouseY = this.data.cursor.targetY;\r\n\r\n    for (const objectItem of this.objects) {\r\n      const rect = objectItem.htmlElement.getBoundingClientRect();\r\n      const isUnderCursor =\r\n        mouseX >= rect.left && mouseX <= rect.right && mouseY >= rect.top && mouseY <= rect.bottom;\r\n\r\n      if (!isUnderCursor && objectItem.getProperty<boolean>(\"__push-latch\") === true) {\r\n        objectItem.setProperty(\"__push-latch\", false);\r\n      }\r\n      if (!isUnderCursor && objectItem.getProperty<boolean>(\"__rotate-latch\") === true) {\r\n        objectItem.setProperty(\"__rotate-latch\", false);\r\n      }\r\n    }\r\n\r\n    for (let i = 0; i < this.objects.length; i++) {\r\n      const object = this.objects[i];\r\n\r\n      let offsetX = object.getProperty<number>(\"offset-x\") || 0;\r\n      let offsetY = object.getProperty<number>(\"offset-y\") || 0;\r\n      let velocityX = object.getProperty<number>(\"velocity-x\") || 0;\r\n      let velocityY = object.getProperty<number>(\"velocity-y\") || 0;\r\n\r\n      const positionTension = object.getProperty<number>(\"position-tension\") ?? 0.05;\r\n      const positionFriction = object.getProperty<number>(\"position-friction\") ?? 0.15;\r\n      const maxVelocity = object.getProperty<number>(\"position-max-velocity\") ?? 120;\r\n      const maxOffset = object.getProperty<number>(\"max-offset\") ?? 220;\r\n\r\n      velocityX -= positionTension * offsetX;\r\n      velocityY -= positionTension * offsetY;\r\n\r\n      const velocityDecay = 1 - positionFriction;\r\n      velocityX *= velocityDecay;\r\n      velocityY *= velocityDecay;\r\n\r\n      if (velocityX > maxVelocity) velocityX = maxVelocity;\r\n      else if (velocityX < -maxVelocity) velocityX = -maxVelocity;\r\n      if (velocityY > maxVelocity) velocityY = maxVelocity;\r\n      else if (velocityY < -maxVelocity) velocityY = -maxVelocity;\r\n\r\n      offsetX += velocityX;\r\n      offsetY += velocityY;\r\n\r\n      if (offsetX > maxOffset) offsetX = maxOffset;\r\n      else if (offsetX < -maxOffset) offsetX = -maxOffset;\r\n      if (offsetY > maxOffset) offsetY = maxOffset;\r\n      else if (offsetY < -maxOffset) offsetY = -maxOffset;\r\n\r\n      let angleDeg = object.getProperty<number>(\"angle-deg\") || 0;\r\n      let angularVelocityDeg = object.getProperty<number>(\"ang-vel-deg\") || 0;\r\n\r\n      const rotationTension = object.getProperty<number>(\"rotation-tension\") ?? 0.06;\r\n      const rotationFriction = object.getProperty<number>(\"rotation-friction\") ?? 0.18;\r\n      const maxAngularVelocityDeg =\r\n        object.getProperty<number>(\"rotation-max-angular-velocity\") ?? 6;\r\n      const maxRotationAngleDeg = object.getProperty<number>(\"rotation-max-angle\") ?? 18;\r\n\r\n      angularVelocityDeg -= rotationTension * angleDeg;\r\n      angularVelocityDeg *= 1 - rotationFriction;\r\n\r\n      if (angularVelocityDeg > maxAngularVelocityDeg) angularVelocityDeg = maxAngularVelocityDeg;\r\n      else if (angularVelocityDeg < -maxAngularVelocityDeg)\r\n        angularVelocityDeg = -maxAngularVelocityDeg;\r\n\r\n      angleDeg += angularVelocityDeg;\r\n\r\n      if (angleDeg > maxRotationAngleDeg) {\r\n        angleDeg = maxRotationAngleDeg;\r\n        angularVelocityDeg *= 0.35;\r\n      } else if (angleDeg < -maxRotationAngleDeg) {\r\n        angleDeg = -maxRotationAngleDeg;\r\n        angularVelocityDeg *= 0.35;\r\n      }\r\n\r\n      const sleepEpsilon = object.getProperty<number>(\"sleep-epsilon\") ?? 0.01;\r\n      const isPositionAsleep =\r\n        velocityX * velocityX + velocityY * velocityY < sleepEpsilon * sleepEpsilon &&\r\n        offsetX * offsetX + offsetY * offsetY < sleepEpsilon * sleepEpsilon;\r\n\r\n      const isRotationAsleep =\r\n        Math.abs(angularVelocityDeg) < sleepEpsilon && Math.abs(angleDeg) < sleepEpsilon;\r\n\r\n      if (isPositionAsleep) {\r\n        if (velocityX || velocityY || offsetX || offsetY) {\r\n          object.setProperty(\"offset-x\", 0);\r\n          object.setProperty(\"offset-y\", 0);\r\n          object.setProperty(\"velocity-x\", 0);\r\n          object.setProperty(\"velocity-y\", 0);\r\n          offsetX = offsetY = velocityX = velocityY = 0;\r\n        }\r\n      } else {\r\n        object.setProperty(\"offset-x\", offsetX);\r\n        object.setProperty(\"offset-y\", offsetY);\r\n        object.setProperty(\"velocity-x\", velocityX);\r\n        object.setProperty(\"velocity-y\", velocityY);\r\n      }\r\n\r\n      if (isRotationAsleep) {\r\n        if (angleDeg || angularVelocityDeg) {\r\n          object.setProperty(\"angle-deg\", 0);\r\n          object.setProperty(\"ang-vel-deg\", 0);\r\n          angleDeg = angularVelocityDeg = 0;\r\n        }\r\n      } else {\r\n        object.setProperty(\"angle-deg\", angleDeg);\r\n        object.setProperty(\"ang-vel-deg\", angularVelocityDeg);\r\n      }\r\n\r\n      const positionUpdateThreshold =\r\n        object.getProperty<number>(\"position-update-threshold\") ?? 0.1;\r\n      const rotationUpdateThreshold =\r\n        object.getProperty<number>(\"rotation-update-threshold\") ?? 0.15;\r\n\r\n      const prevCssX = object.getProperty<number>(\"__prev-css-x\") || 0;\r\n      const prevCssY = object.getProperty<number>(\"__prev-css-y\") || 0;\r\n      const prevCssRot = object.getProperty<number>(\"__prev-css-rot\") || 0;\r\n\r\n      const cssTranslateX = Math.round(offsetX * 10) / 10;\r\n      const cssTranslateY = Math.round(offsetY * 10) / 10;\r\n      const cssRotateDeg = Math.round(angleDeg * 10) / 10;\r\n\r\n      const needsPositionUpdate =\r\n        Math.abs(cssTranslateX - prevCssX) > positionUpdateThreshold ||\r\n        Math.abs(cssTranslateY - prevCssY) > positionUpdateThreshold;\r\n\r\n      const needsRotationUpdate = Math.abs(cssRotateDeg - prevCssRot) > rotationUpdateThreshold;\r\n\r\n      if (needsPositionUpdate || needsRotationUpdate) {\r\n        this.applyToElementAndConnects(object, (el) => {\r\n          if (needsPositionUpdate) {\r\n            el.style.setProperty(\"--push-x\", String(cssTranslateX));\r\n            el.style.setProperty(\"--push-y\", String(cssTranslateY));\r\n            this.events.emit(`object:impulse:${object.id}:move`, {\r\n              x: cssTranslateX,\r\n              y: cssTranslateY,\r\n            });\r\n          }\r\n          if (needsRotationUpdate) {\r\n            el.style.setProperty(\"--push-rotation\", String(cssRotateDeg));\r\n            this.events.emit(`object:impulse:${object.id}:rotate`, { rotation: cssRotateDeg });\r\n          }\r\n        });\r\n\r\n        if (needsPositionUpdate) {\r\n          object.setProperty(\"__prev-css-x\", cssTranslateX);\r\n          object.setProperty(\"__prev-css-y\", cssTranslateY);\r\n        }\r\n        if (needsRotationUpdate) {\r\n          object.setProperty(\"__prev-css-rot\", cssRotateDeg);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\n\r\nexport class StringMagnetic extends StringModule {\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"magnetic\";\r\n\r\n    this.permissions.mobile.rebuild.height = false;\r\n    this.permissions.mobile.rebuild.width = false;\r\n    this.permissions.mobile.rebuild.scrollHeight = false;\r\n\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      { key: \"strength\", type: \"number\", fallback: this.settings[\"strength\"] },\r\n      { key: \"radius\", type: \"number\", fallback: this.settings[\"radius\"] },\r\n    ];\r\n  }\r\n\r\n  override initializeObject(\r\n    globalId: number,\r\n    object: StringObject,\r\n    element: HTMLElement,\r\n    attributes: Record<string, any>\r\n  ): void {\r\n    super.initializeObject(globalId, object, element, attributes);\r\n    object.setProperty(\"is-magneting\", false);\r\n    object.setProperty(\"magnetic-target-x\", 0);\r\n    object.setProperty(\"magnetic-target-y\", 0);\r\n    object.setProperty(\"magnetic-x\", 0);\r\n    object.setProperty(\"magnetic-y\", 0);\r\n    object.setProperty(\"lerp\", 0.1);\r\n  }\r\n\r\n  onMouseMove(e: MouseEvent): void {\r\n    this.objects.forEach((object) => {\r\n      const element = object.htmlElement as HTMLElement;\r\n      const rect = element.getBoundingClientRect();\r\n      const centerX = rect.left + rect.width / 2;\r\n      const centerY = rect.top + rect.height / 2;\r\n      const dx = e.clientX - centerX;\r\n      const dy = e.clientY - centerY;\r\n      const distance = Math.sqrt(dx ** 2 + dy ** 2);\r\n\r\n      const radius = object.getProperty<number>(\"radius\") ?? 0;\r\n      const strength = object.getProperty<number>(\"strength\") ?? 0;\r\n\r\n      const factor = this.tools.magneticPull.process({\r\n        distance,\r\n        radius,\r\n        strength,\r\n      });\r\n\r\n      object.setProperty(\"magnetic-target-x\", dx * factor);\r\n      object.setProperty(\"magnetic-target-y\", dy * factor);\r\n      if (factor > 0) {\r\n        object.setProperty(\"is-magneting\", true);\r\n      }\r\n    });\r\n  }\r\n\r\n  onFrame(data: StringData): void {\r\n    this.objects.forEach((object) => {\r\n      if (object.getProperty(\"is-magneting\")) {\r\n        let magneticX = object.getProperty<number>(\"magnetic-x\") ?? 0;\r\n        let magneticY = object.getProperty<number>(\"magnetic-y\") ?? 0;\r\n\r\n        let lerp = object.getProperty<number>(\"lerp\") ?? 0;\r\n\r\n        let targetMagneticX = object.getProperty<number>(\"magnetic-target-x\") ?? 0;\r\n        let targetMagneticY = object.getProperty<number>(\"magnetic-target-y\") ?? 0;\r\n\r\n        let lerpX = this.tools.lerp.process({\r\n          from: magneticX,\r\n          to: targetMagneticX,\r\n          progress: lerp,\r\n        });\r\n        let lerpY = this.tools.lerp.process({\r\n          from: magneticY,\r\n          to: targetMagneticY,\r\n          progress: lerp,\r\n        });\r\n\r\n        if (lerpX > -0.01 && lerpX < 0.01) {\r\n          lerpX = 0;\r\n          object.setProperty(\"magnetic-x\", object.getProperty(\"magnetic-target-x\"));\r\n        }\r\n        if (lerpY > -0.01 && lerpY < 0.01) {\r\n          lerpY = 0;\r\n          object.setProperty(\"magnetic-y\", object.getProperty(\"magnetic-target-y\"));\r\n        }\r\n        magneticX += lerpX;\r\n        magneticY += lerpY;\r\n        object.setProperty<number>(\"magnetic-x\", magneticX);\r\n        object.setProperty<number>(\"magnetic-y\", magneticY);\r\n        this.events.emit(`magnetic:move:${object.id}`, {\r\n          x: magneticX,\r\n          y: magneticY,\r\n        });\r\n\r\n        this.applyToElementAndConnects(object, (el) => {\r\n          el.style.setProperty(\"--magnetic-x\", magneticX.toString());\r\n          el.style.setProperty(\"--magnetic-y\", magneticY.toString());\r\n        });\r\n\r\n        if (\r\n          object.getProperty(\"magnetic-target-x\") == magneticX ||\r\n          object.getProperty(\"magnetic-target-y\") == magneticY\r\n        ) {\r\n          object.setProperty(\"is-magneting\", false);\r\n        }\r\n      }\r\n    });\r\n  }\r\n}\r\n","type Job = () => void;\n\nclass FrameDOM {\n  private measureQueue: Job[] = [];\n  private mutateQueue: Job[] = [];\n  private scheduled = false;\n\n  public measure(fn: Job): void {\n    this.measureQueue.push(fn);\n    this.schedule();\n  }\n\n  public mutate(fn: Job): void {\n    this.mutateQueue.push(fn);\n    this.schedule();\n  }\n\n  private schedule(): void {\n    if (this.scheduled) {\n      return;\n    }\n\n    this.scheduled = true;\n    requestAnimationFrame(() => {\n      const mQueue = this.measureQueue;\n      this.measureQueue = [];\n      for (let i = 0; i < mQueue.length; i++) {\n        try {\n          mQueue[i]();\n        } catch (e) {\n          console.error(\"Error in frameDOM measure task:\", e);\n        }\n      }\n\n      const wQueue = this.mutateQueue;\n      this.mutateQueue = [];\n      for (let i = 0; i < wQueue.length; i++) {\n        try {\n          wQueue[i]();\n        } catch (e) {\n          console.error(\"Error in frameDOM mutate task:\", e);\n        }\n      }\n\n      this.scheduled = false;\n    });\n  }\n}\n\nexport const frameDOM = new FrameDOM();\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { frameDOM } from \"../../utils/frame-dom\";\r\nimport { isCoarsePointer } from \"../../utils/isCoarsePointer\";\r\nimport { styleTxn } from \"../../utils/style-txn\";\r\n\r\nexport abstract class CursorReactiveModule extends StringModule {\r\n  protected nearOnly = true;\r\n  protected useAllObjects = false;\r\n  protected maxDistanceMultiplier = 1;\r\n  protected updateThreshold = 0.1;\r\n\r\n  protected enabled = true;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    if (isCoarsePointer()) {\r\n      this.enabled = false;\r\n    }\r\n  }\r\n\r\n  override onObjectConnected(object: StringObject): void {\r\n    if (!this.enabled) return;\r\n    super.onObjectConnected(object);\r\n    this.centers.attach(object);\r\n    this.hover.track(object);\r\n  }\r\n\r\n  override removeObject(id: string): void {\r\n    if (!this.enabled) return super.removeObject(id);\r\n    const obj = this.objectMapOnPage.get(id);\r\n    if (obj) {\r\n      this.centers.detach(obj);\r\n      this.hover.untrack(obj);\r\n    }\r\n    super.removeObject(id);\r\n  }\r\n\r\n  override onScroll(): void {\r\n    if (!this.enabled) return;\r\n    this.centers.invalidateAll();\r\n    this.scheduleCursorUpdate();\r\n  }\r\n\r\n  override onMouseMoveMeasure(data: StringData) {\r\n    if (!this.enabled) return;\r\n    super.onMouseMoveMeasure(data);\r\n    this.refreshPointerState();\r\n  }\r\n\r\n  override onScrollMeasure(data: StringData) {\r\n    if (!this.enabled) return;\r\n    super.onScrollMeasure(data);\r\n    this.refreshPointerState();\r\n  }\r\n\r\n  protected getCursorTargets(allowFallback = false): StringObject[] {\r\n    if (!this.enabled) return [];\r\n    const near = this.hover.activeObjects();\r\n    if (this.nearOnly && near.length) return near;\r\n    if (this.useAllObjects) return this.objectsOnPage;\r\n    if (this.objects.length > 0) return this.objects;\r\n    return allowFallback ? this.objectsOnPage : this.objects;\r\n  }\r\n\r\n  protected refreshPointerState(target?: StringObject, allowFallback = false): void {\r\n    if (!this.enabled) return;\r\n\r\n    const mx = this.data.cursor.targetX;\r\n    const my = this.data.cursor.targetY;\r\n    const targets = target ? [target] : this.getCursorTargets(allowFallback);\r\n\r\n    const maxDistanceSq =\r\n      !this.nearOnly && this.maxDistanceMultiplier > 0\r\n        ? Math.pow(this.data.viewport.windowWidth * this.maxDistanceMultiplier, 2)\r\n        : null;\r\n\r\n    for (const obj of targets) {\r\n      const { cx, cy } = this.centers.getCenter(obj);\r\n      const dx = mx - cx;\r\n      const dy = my - cy;\r\n      const d2 = dx * dx + dy * dy;\r\n\r\n      if (this.nearOnly) {\r\n        const far = d2 > this.data.viewport.windowWidth * this.data.viewport.windowWidth;\r\n        if (far && !this.hover.isActive(obj)) continue;\r\n      } else if (maxDistanceSq !== null && d2 > maxDistanceSq) {\r\n        continue;\r\n      }\r\n\r\n      obj.setProperty(\"dx\", dx);\r\n      obj.setProperty(\"dy\", dy);\r\n      obj.setProperty(\"dist\", Math.sqrt(d2));\r\n    }\r\n  }\r\n\r\n  private scrollUpdateScheduled = false;\r\n\r\n  protected scheduleCursorUpdate(): void {\r\n    if (!this.enabled || this.scrollUpdateScheduled) return;\r\n    this.scrollUpdateScheduled = true;\r\n\r\n    frameDOM.measure(() => {\r\n      this.refreshPointerState();\r\n      frameDOM.mutate(() => {\r\n        this.scrollUpdateScheduled = false;\r\n        styleTxn.run(() => {\r\n          this.onCursorScrollUpdate();\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  protected onCursorScrollUpdate(): void {}\r\n}\r\n","import { StringData } from \"../../core/StringData\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { frameDOM } from \"../../utils/frame-dom\";\r\nimport { isCoarsePointer } from \"../../utils/isCoarsePointer\";\r\nimport { styleTxn } from \"../../utils/style-txn\";\r\nimport { CursorReactiveModule } from \"./CursorReactiveModule\";\r\n\r\nconst TAU = Math.PI * 2;\r\nconst RAD2DEG = 180 / Math.PI;\r\nconst clamp01 = (v: number) => (v < 0 ? 0 : v > 1 ? 1 : v);\r\n\r\nconst shortestArc = (from: number, to: number) => {\r\n  let d = (to - from) % TAU;\r\n  if (d > Math.PI) d -= TAU;\r\n  if (d < -Math.PI) d += TAU;\r\n  return from + d;\r\n};\r\n\r\ntype SpotlightState = {\r\n  angle: number;\r\n  dist: number;\r\n  tAngle: number;\r\n  tDist: number;\r\n  prevDeg: number;\r\n  prevDist: number;\r\n};\r\n\r\nconst spotState = new WeakMap<StringObject, SpotlightState>();\r\nconst getSpot = (o: StringObject): SpotlightState => {\r\n  let s = spotState.get(o);\r\n  if (!s) {\r\n    s = { angle: 0, dist: 0, tAngle: 0, tDist: 0, prevDeg: NaN, prevDist: NaN };\r\n    spotState.set(o, s);\r\n  }\r\n  return s;\r\n};\r\n\r\nexport class StringSpotlight extends CursorReactiveModule {\r\n  constructor(context: any) {\r\n    super(context);\r\n    this.htmlKey = \"spotlight\";\r\n\r\n    this.nearOnly = false;\r\n    this.useAllObjects = false;\r\n    this.maxDistanceMultiplier = 1;\r\n\r\n    this.attributesToMap.push(\r\n      {\r\n        key: \"lerp\",\r\n        type: \"number\",\r\n        fallback: this.settings[\"lerp\"],\r\n        transform: (v: number) =>\r\n          clamp01(\r\n            this.tools.adaptiveLerp.process({\r\n              value: v,\r\n              inMin: 0.1,\r\n              inMax: 1.0,\r\n              outMin: 0.05,\r\n              outMax: 0.65,\r\n            })\r\n          ),\r\n      },\r\n      { key: \"angle-threshold\", type: \"number\", fallback: 0.2 },\r\n      { key: \"distance-threshold\", type: \"number\", fallback: 0.5 },\r\n      { key: \"deadzone\", type: \"number\", fallback: 4 },\r\n      { key: \"dist-max\", type: \"number\", fallback: 0 }\r\n    );\r\n  }\r\n\r\n  initializeObject(\r\n    id: number,\r\n    obj: StringObject,\r\n    el: HTMLElement,\r\n    attrs: Record<string, any>\r\n  ): void {\r\n    super.initializeObject(id, obj, el, attrs);\r\n\r\n    obj.setProperty(\"spotlight-angle-rad\", 0);\r\n    obj.setProperty(\"spotlight-distance\", 0);\r\n    obj.setProperty(\"spotlight-angle-rad-target\", 0);\r\n    obj.setProperty(\"spotlight-distance-target\", 0);\r\n\r\n    frameDOM.measure(() => {\r\n      this.refreshPointerState(obj, /*allowFallback=*/ true);\r\n      frameDOM.mutate(() => {\r\n        styleTxn.run(() => {\r\n          this.updateSpotlightState(obj, {\r\n            forceImmediate: true,\r\n            forceEmit: true,\r\n            bypassDeadzone: true,\r\n          });\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  override onMutate(data: StringData): void {\r\n    if (this.enabled) {\r\n      super.onMutate(data);\r\n      const targets = this.getCursorTargets(/*allowFallback=*/ false);\r\n      const list = targets.length > 0 ? targets : this.getCursorTargets(/*allowFallback=*/ true);\r\n      list.forEach((object) => {\r\n        this.updateSpotlightState(object);\r\n      });\r\n    }\r\n  }\r\n\r\n  protected onCursorScrollUpdate(): void {\r\n    const targets = this.getCursorTargets(/*allowFallback=*/ false);\r\n    const list = targets.length > 0 ? targets : this.getCursorTargets(/*allowFallback=*/ true);\r\n\r\n    list.forEach((object) => {\r\n      this.updateSpotlightState(object, { bypassDeadzone: true });\r\n    });\r\n  }\r\n\r\n  private updateSpotlightState(\r\n    object: StringObject,\r\n    options: { forceImmediate?: boolean; forceEmit?: boolean; bypassDeadzone?: boolean } = {}\r\n  ): void {\r\n    const dx = object.getProperty<number>(\"dx\");\r\n    const dy = object.getProperty<number>(\"dy\");\r\n    const dist = object.getProperty<number>(\"dist\");\r\n\r\n    if (!Number.isFinite(dx) || !Number.isFinite(dy) || !Number.isFinite(dist)) {\r\n      return;\r\n    }\r\n\r\n    const s = getSpot(object);\r\n\r\n    const DEADZONE = object.getProperty<number>(\"deadzone\") ?? 4;\r\n    if (options.bypassDeadzone || dist! > DEADZONE) {\r\n      s.tAngle = Math.atan2(dy!, dx!);\r\n    }\r\n\r\n    const distMax = object.getProperty<number>(\"dist-max\") ?? 0;\r\n    s.tDist = distMax > 0 ? Math.min(dist!, distMax) : dist!;\r\n\r\n    object.setProperty(\"spotlight-distance-target\", s.tDist);\r\n    object.setProperty(\"spotlight-angle-rad-target\", s.tAngle);\r\n\r\n    if (options.forceImmediate) {\r\n      s.angle = s.tAngle;\r\n      s.dist = s.tDist;\r\n    } else {\r\n      const lerp = clamp01(object.getProperty<number>(\"lerp\") ?? 0.15);\r\n      const nextA = shortestArc(s.angle, s.tAngle);\r\n      s.angle += (nextA - s.angle) * lerp;\r\n      s.dist += (s.tDist - s.dist) * lerp;\r\n    }\r\n\r\n    object.setProperty(\"spotlight-angle-rad\", s.angle);\r\n    object.setProperty(\"spotlight-distance\", s.dist);\r\n\r\n    const degRaw = s.angle * RAD2DEG - 90;\r\n\r\n    const angleEps = object.getProperty<number>(\"angle-threshold\") ?? 0.2;\r\n    const distEps = object.getProperty<number>(\"distance-threshold\") ?? 0.5;\r\n\r\n    const angleChanged =\r\n      options.forceEmit || Number.isNaN(s.prevDeg) || Math.abs(degRaw - s.prevDeg) > angleEps;\r\n    const distChanged =\r\n      options.forceEmit || Number.isNaN(s.prevDist) || Math.abs(s.dist - s.prevDist) > distEps;\r\n\r\n    if (angleChanged || distChanged) {\r\n      const cssDeg = Math.round(degRaw * 10) / 10;\r\n      const cssDist = Math.round(s.dist * 10) / 10;\r\n\r\n      this.applyToElementAndConnects(object, (el) => {\r\n        styleTxn.setVars(el, {\r\n          \"--spotlight-angle\": String(cssDeg),\r\n          \"--spotlight-angle-deg\": `${cssDeg}deg`,\r\n          \"--spotlight-distance\": String(cssDist),\r\n        });\r\n      });\r\n\r\n      s.prevDeg = degRaw;\r\n      s.prevDist = s.dist;\r\n\r\n      this.events.emit(`spotlight:update:${object.id}`, {\r\n        distance: cssDist,\r\n        angleDeg: cssDeg,\r\n      });\r\n    }\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\n\r\nconst ASPECT_CLASS = \"-aspect-ready\";\r\n\r\ntype Dims = { width: number; height: number };\r\n\r\nfunction isSvgSource(src: string): boolean {\r\n  if (!src) return false;\r\n  const lower = src.toLowerCase();\r\n  if (lower.endsWith(\".svg\")) return true;\r\n  if (lower.startsWith(\"data:image/svg\")) return true;\r\n  return false;\r\n}\r\n\r\ninterface LazyImageState {\r\n  src: string;\r\n  aspectReady: boolean;\r\n  contentReady: boolean;\r\n  aspectLoading: boolean;\r\n  contentLoading: boolean;\r\n  pendingActivation: boolean;\r\n  width?: number;\r\n  height?: number;\r\n  aspectPromise?: Promise<void>;\r\n  unsubscribe?: () => void;\r\n  rangeAttempted: boolean;\r\n  blobUrl?: string;\r\n  controller?: AbortController;\r\n\r\n  fetching: boolean;\r\n  allowSrcFallback?: boolean;\r\n}\r\n\r\nfunction parsePng(b: ArrayBuffer): Dims {\r\n  const d = new DataView(b);\r\n  if (b.byteLength < 24) return { width: 0, height: 0 };\r\n  if (d.getUint32(0) !== 0x89504e47 || d.getUint32(4) !== 0x0d0a1a0a)\r\n    return { width: 0, height: 0 };\r\n  if (d.getUint32(12) !== 13 || d.getUint32(16) !== 0x49484452) return { width: 0, height: 0 };\r\n  return { width: d.getUint32(20, false), height: d.getUint32(24, false) };\r\n}\r\n\r\nfunction parseJpeg(b: ArrayBuffer): Dims {\r\n  const d = new DataView(b);\r\n  if (d.getUint16(0) !== 0xffd8) return { width: 0, height: 0 };\r\n  let o = 2;\r\n  while (o + 9 < b.byteLength) {\r\n    const m = d.getUint16(o);\r\n    o += 2;\r\n    if (m === 0xffda || m === 0xffd9) break;\r\n    const len = d.getUint16(o);\r\n    if (len < 2 || o + len > b.byteLength) break;\r\n    if (\r\n      (m >= 0xffc0 && m <= 0xffc3) ||\r\n      (m >= 0xffc5 && m <= 0xffc7) ||\r\n      (m >= 0xffc9 && m <= 0xffcb) ||\r\n      (m >= 0xffcd && m <= 0xffcf)\r\n    ) {\r\n      return { height: d.getUint16(o + 3), width: d.getUint16(o + 5) };\r\n    }\r\n    o += len;\r\n  }\r\n  return { width: 0, height: 0 };\r\n}\r\n\r\nfunction parseWebp(b: ArrayBuffer): Dims {\r\n  const d = new DataView(b);\r\n  if (b.byteLength < 16) return { width: 0, height: 0 };\r\n\r\n  if (d.getUint32(0, true) !== 0x46464952 || d.getUint32(8, true) !== 0x50424557)\r\n    return { width: 0, height: 0 };\r\n\r\n  let i = 12;\r\n  while (i + 8 <= b.byteLength) {\r\n    const chunkHeader = d.getUint32(i, false);\r\n    const chunkSize = d.getUint32(i + 4, true);\r\n    const dataOffset = i + 8;\r\n\r\n    if (chunkHeader === 0x56503858) {\r\n      const w = (d.getUint16(dataOffset + 4, true) | (d.getUint8(dataOffset + 6) << 16)) + 1;\r\n      const h = (d.getUint16(dataOffset + 7, true) | (d.getUint8(dataOffset + 9) << 16)) + 1;\r\n      return { width: w, height: h };\r\n    }\r\n\r\n    if (chunkHeader === 0x56503820) {\r\n      if (\r\n        dataOffset + 10 <= b.byteLength &&\r\n        d.getUint8(dataOffset + 3) === 0x9d &&\r\n        d.getUint8(dataOffset + 4) === 0x01 &&\r\n        d.getUint8(dataOffset + 5) === 0x2a\r\n      ) {\r\n        const w = d.getUint16(dataOffset + 6, true) & 0x3fff;\r\n        const h = d.getUint16(dataOffset + 8, true) & 0x3fff;\r\n        return { width: w, height: h };\r\n      }\r\n    }\r\n\r\n    if (chunkHeader === 0x5650384c) {\r\n      if (dataOffset + 5 <= b.byteLength && d.getUint8(dataOffset) === 0x2f) {\r\n        const b0 = d.getUint8(dataOffset + 1);\r\n        const b1 = d.getUint8(dataOffset + 2);\r\n        const b2 = d.getUint8(dataOffset + 3);\r\n        const b3 = d.getUint8(dataOffset + 4);\r\n\r\n        const w = 1 + (((b1 & 0x3f) << 8) | b0);\r\n        const h = 1 + (((b3 & 0x0f) << 10) | (b2 << 2) | ((b1 & 0xc0) >> 6));\r\n        return { width: w, height: h };\r\n      }\r\n    }\r\n\r\n    i = dataOffset + chunkSize + (chunkSize & 1);\r\n  }\r\n  return { width: 0, height: 0 };\r\n}\r\n\r\nfunction tryParseDims(buffer: ArrayBuffer, ct?: string | null): Dims {\r\n  const c = (ct || \"\").toLowerCase();\r\n  if (c.includes(\"png\")) return parsePng(buffer);\r\n  if (c.includes(\"jpeg\") || c.includes(\"jpg\")) return parseJpeg(buffer);\r\n  if (c.includes(\"webp\")) return parseWebp(buffer);\r\n  let d = parsePng(buffer);\r\n  if (d.width) return d;\r\n  d = parseJpeg(buffer);\r\n  if (d.width) return d;\r\n  d = parseWebp(buffer);\r\n  if (d.width) return d;\r\n  return { width: 0, height: 0 };\r\n}\r\n\r\nasync function fetchImageStreamWithDims(\r\n  src: string,\r\n  opts?: {\r\n    credentials?: RequestCredentials;\r\n    referrerPolicy?: ReferrerPolicy;\r\n    signal?: AbortSignal;\r\n  },\r\n  onDims?: (d: Dims) => void\r\n): Promise<{\r\n  dims: { width: number; height: number } | null;\r\n  blobUrl: string;\r\n  contentType?: string | null;\r\n}> {\r\n  const res = await fetch(src, {\r\n    mode: \"cors\",\r\n    credentials: opts?.credentials ?? \"omit\",\r\n    referrerPolicy: opts?.referrerPolicy,\r\n    signal: opts?.signal,\r\n    cache: \"default\",\r\n  });\r\n  if (!res.ok || !res.body) throw new Error(`HTTP ${res.status}`);\r\n\r\n  const ct = res.headers.get(\"content-type\");\r\n  const reader = res.body.getReader();\r\n\r\n  const PROBE_CAP = 1048576;\r\n  const TRY_STEP = 4096;\r\n\r\n  const probe = new Uint8Array(PROBE_CAP);\r\n  let probeLen = 0;\r\n  let lastTriedLen = 0;\r\n\r\n  const chunks: ArrayBuffer[] = [];\r\n  let dims: Dims | null = null;\r\n  let announced = false;\r\n\r\n  for (;;) {\r\n    const { done, value } = await reader.read();\r\n    if (done) break;\r\n    if (!value) continue;\r\n\r\n    const part = value.buffer.slice(value.byteOffset, value.byteOffset + value.byteLength);\r\n    chunks.push(part);\r\n\r\n    if (!dims && probeLen < PROBE_CAP) {\r\n      const toCopy = Math.min(value.byteLength, PROBE_CAP - probeLen);\r\n      if (toCopy > 0) {\r\n        probe.set(value.subarray(0, toCopy), probeLen);\r\n        probeLen += toCopy;\r\n      }\r\n      if (probeLen - lastTriedLen >= TRY_STEP) {\r\n        const view = probeLen === probe.byteLength ? probe : probe.slice(0, probeLen);\r\n        const d = tryParseDims(view.buffer, ct);\r\n        if (d.width && d.height) {\r\n          dims = d;\r\n          if (!announced && onDims) {\r\n            onDims(dims);\r\n            announced = true;\r\n          }\r\n        }\r\n        lastTriedLen = probeLen;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!dims) {\r\n    const full = await new Response(new Blob(chunks)).arrayBuffer();\r\n    const d = tryParseDims(full, ct);\r\n    if (d.width && d.height) {\r\n      dims = d;\r\n      if (!announced && onDims) {\r\n        onDims(dims);\r\n        announced = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  const blob = new Blob(chunks, { type: ct || \"application/octet-stream\" });\r\n  const blobUrl = URL.createObjectURL(blob);\r\n  return { dims, blobUrl, contentType: ct };\r\n}\r\n\r\nexport class StringLazy extends StringModule {\r\n  private isStartLoaded = false;\r\n  private loadingCount = 0;\r\n  private imageStates = new WeakMap<HTMLImageElement, LazyImageState>();\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"lazy\";\r\n  }\r\n\r\n  onInit(): void {\r\n    const images = document.querySelectorAll(\"img[string-lazy], img[data-string-lazy]\");\r\n    images.forEach((img) => this.ensureState(img as HTMLImageElement));\r\n    this.isStartLoaded = true;\r\n  }\r\n\r\n  onObjectConnected(object: StringObject): void {\r\n    const element = object.htmlElement;\r\n    if (!(element instanceof HTMLImageElement)) return;\r\n    const state = this.ensureState(element);\r\n\r\n    if (!state.aspectReady && !state.aspectLoading) {\r\n      this.prepareAspectRatio(element);\r\n    }\r\n\r\n    const listener = (data: { inView: boolean } | undefined) => {\r\n      this.handleInView(element, state, !!data?.inView);\r\n    };\r\n    if (state.unsubscribe) state.unsubscribe();\r\n    this.events.on(`object:inview:${object.id}`, listener);\r\n    state.unsubscribe = () => this.events.off(`object:inview:${object.id}`, listener);\r\n    if (this.isStartLoaded && (object.getProperty<boolean>(\"is-inview\") ?? false)) {\r\n      this.handleInView(element, state, true);\r\n    }\r\n  }\r\n\r\n  onObjectDisconnected(object: StringObject): void {\r\n    const element = object.htmlElement;\r\n    if (!(element instanceof HTMLImageElement)) return;\r\n    const state = this.imageStates.get(element);\r\n    if (!state) return;\r\n    state.pendingActivation = false;\r\n    if (state.controller) state.controller.abort();\r\n    if (state.blobUrl) URL.revokeObjectURL(state.blobUrl);\r\n    if (state.unsubscribe) {\r\n      state.unsubscribe();\r\n      state.unsubscribe = undefined;\r\n    }\r\n  }\r\n\r\n  private ensureState(img: HTMLImageElement): LazyImageState {\r\n    let state = this.imageStates.get(img);\r\n    if (!state) {\r\n      const src = this.readSource(img);\r\n      state = {\r\n        src,\r\n        aspectReady: false,\r\n        contentReady: false,\r\n        aspectLoading: false,\r\n        contentLoading: false,\r\n        pendingActivation: false,\r\n        rangeAttempted: false,\r\n        fetching: false,\r\n      };\r\n      this.imageStates.set(img, state);\r\n      if (!img.classList.contains(\"lazyLoad\")) img.classList.add(\"lazyLoad\");\r\n      if (img.dataset && !img.dataset.stringLazySrc && src) img.dataset.stringLazySrc = src;\r\n      return state;\r\n    }\r\n    if (!state.src) state.src = this.readSource(img);\r\n    return state;\r\n  }\r\n\r\n  private readSource(img: HTMLImageElement): string {\r\n    const raw = this.tools.domAttribute.process({ element: img, key: this.htmlKey, fallback: \"\" });\r\n    if (typeof raw === \"string\") return raw;\r\n    if (raw == null) return \"\";\r\n    return String(raw);\r\n  }\r\n\r\n  private handleInView(img: HTMLImageElement, state: LazyImageState, inView: boolean): void {\r\n    state.pendingActivation = inView;\r\n    if (!inView) return;\r\n    if (state.aspectReady) {\r\n      this.maybeActivateImage(img, state);\r\n    } else if (!state.aspectLoading) {\r\n      this.prepareAspectRatio(img);\r\n    }\r\n  }\r\n\r\n  private async prepareAspectRatio(img: HTMLImageElement): Promise<void> {\r\n    const state = this.ensureState(img);\r\n    if (!state.src || state.aspectLoading || state.aspectReady) return;\r\n\r\n    if (isSvgSource(state.src)) {\r\n      state.aspectReady = true;\r\n      state.allowSrcFallback = true;\r\n      this.maybeActivateImage(img, state);\r\n      return;\r\n    }\r\n\r\n    state.aspectLoading = true;\r\n    state.fetching = true;\r\n\r\n    const crossOrigin = img.getAttribute(\"crossorigin\");\r\n    const referrerPolicy = img.getAttribute(\"referrerpolicy\") as ReferrerPolicy | null;\r\n    const ac = new AbortController();\r\n    state.controller = ac;\r\n\r\n    try {\r\n      const { blobUrl } = await fetchImageStreamWithDims(\r\n        state.src,\r\n        {\r\n          credentials: crossOrigin === \"use-credentials\" ? \"include\" : \"omit\",\r\n          referrerPolicy: referrerPolicy || undefined,\r\n          signal: ac.signal,\r\n        },\r\n\r\n        (d) => {\r\n          if (d.width > 0 && d.height > 0 && !state.aspectReady) {\r\n            img.style.aspectRatio = `${d.width} / ${d.height}`;\r\n            img.classList.add(ASPECT_CLASS);\r\n            state.width = d.width;\r\n            state.height = d.height;\r\n            state.aspectReady = true;\r\n          }\r\n        }\r\n      );\r\n\r\n      state.blobUrl = blobUrl;\r\n\r\n      if (!state.aspectReady && state.width && state.height) {\r\n        img.style.aspectRatio = `${state.width} / ${state.height}`;\r\n        img.classList.add(ASPECT_CLASS);\r\n        state.aspectReady = true;\r\n      }\r\n    } catch {\r\n      state.allowSrcFallback = true;\r\n      state.aspectReady = true;\r\n    } finally {\r\n      state.fetching = false;\r\n      state.aspectLoading = false;\r\n\r\n      this.maybeActivateImage(img, state);\r\n    }\r\n  }\r\n\r\n  private maybeActivateImage(img: HTMLImageElement, state: LazyImageState): void {\r\n    if (!state.pendingActivation || state.contentReady || state.contentLoading) return;\r\n    if (!state.aspectReady || !state.src) return;\r\n\r\n    if (state.fetching && !state.blobUrl) return;\r\n\r\n    if (state.blobUrl || state.allowSrcFallback) {\r\n      this.activateImage(img, state);\r\n    }\r\n  }\r\n\r\n  private activateImage(img: HTMLImageElement, state: LazyImageState): void {\r\n    state.contentLoading = true;\r\n    this.loadingCount++;\r\n    const finalize = (loaded: boolean) => {\r\n      if (!state.contentLoading) return;\r\n      state.contentLoading = false;\r\n      state.pendingActivation = false;\r\n      this.loadingCount = Math.max(0, this.loadingCount - 1);\r\n      if (loaded) {\r\n        state.contentReady = true;\r\n        img.classList.add(\"-loaded\");\r\n      }\r\n      if (this.loadingCount === 0) this.events.emit(\"image:load:all\", null);\r\n    };\r\n    const onLoad = () => finalize(true);\r\n    const onError = () => finalize(false);\r\n    img.addEventListener(\"load\", onLoad, { once: true });\r\n    img.addEventListener(\"error\", onError, { once: true });\r\n    img.decoding = \"async\";\r\n    img.loading = img.loading || \"lazy\";\r\n\r\n    if (state.blobUrl) {\r\n      img.removeAttribute(\"srcset\");\r\n      img.removeAttribute(\"sizes\");\r\n      img.src = state.blobUrl;\r\n    } else {\r\n      img.src = state.src;\r\n    }\r\n\r\n    if (img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {\r\n      img.removeEventListener(\"load\", onLoad);\r\n      img.removeEventListener(\"error\", onError);\r\n      finalize(true);\r\n    }\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\n\r\n/**\r\n * Represents a module responsible for handling loading-related functionality.\r\n * Extends the `StringModule` class and provides additional behavior for managing\r\n * loading states and timeouts.\r\n */\r\nexport class StringLoading extends StringModule {\r\n  loadingTimeout: number = 0;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this._type = 2;\r\n    this.loadingTimeout = this.settings[\"timeout\"];\r\n  }\r\n  onInit(): void {\r\n    setTimeout(() => {\r\n      const htmlElement = document.documentElement;\r\n      htmlElement.classList.add(\"-loaded\");\r\n    }, this.loadingTimeout);\r\n  }\r\n}\r\n","import { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\n\r\nexport class StringInview extends StringModule {\r\n  constructor(visitor: any) {\r\n    super(visitor);\r\n    this.htmlKey = '';\r\n  }\r\n  canConnect(object: StringObject): boolean {\r\n    return object.keys[0]==undefined;\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\n\r\nenum DeviceType {\r\n  Mobile,\r\n  Tablet,\r\n  Laptop,\r\n  Desktop,\r\n}\r\n\r\ninterface DeviceQueryConfig {\r\n  min?: number;\r\n  max?: number;\r\n  enable?: boolean;\r\n}\r\n\r\ninterface QueryConfig {\r\n  mobile?: DeviceQueryConfig;\r\n  tablet?: DeviceQueryConfig;\r\n  laptop?: DeviceQueryConfig;\r\n  desktop?: DeviceQueryConfig;\r\n}\r\n\r\nclass StringResponsiveQueryDevice {\r\n  public min?: number = undefined;\r\n  public max?: number = undefined;\r\n  public enable: boolean = true;\r\n\r\n  constructor(config?: DeviceQueryConfig) {\r\n    this.min = config?.min;\r\n    this.max = config?.max;\r\n    this.enable = config?.enable ?? true;\r\n  }\r\n\r\n  setEnable(enable: boolean = true) {\r\n    this.enable = enable;\r\n  }\r\n  setRange(min?: number, max?: number) {\r\n    this.min = min ?? undefined;\r\n    this.max = max ?? undefined;\r\n  }\r\n\r\n  get mediaQuery(): string {\r\n    let query = \"screen\";\r\n    if (this.min) {\r\n      query += ` and (min-width: ${this.min}px)`;\r\n    }\r\n    if (this.max) {\r\n      query += ` and (max-width: ${this.max}px)`;\r\n    }\r\n    return query;\r\n  }\r\n}\r\n\r\nexport class StringResponsive extends StringModule {\r\n  private queries: { [key in DeviceType]: StringResponsiveQueryDevice } = {\r\n    [DeviceType.Mobile]: new StringResponsiveQueryDevice({ max: 359 }),\r\n    [DeviceType.Tablet]: new StringResponsiveQueryDevice({\r\n      min: 360,\r\n      max: 1023,\r\n    }),\r\n    [DeviceType.Laptop]: new StringResponsiveQueryDevice({\r\n      min: 1024,\r\n      max: 1365,\r\n    }),\r\n    [DeviceType.Desktop]: new StringResponsiveQueryDevice({ min: 1366 }),\r\n  };\r\n\r\n  private isMobileMedia: boolean = false;\r\n  private isTabletMedia: boolean = false;\r\n  private isLaptopMedia: boolean = false;\r\n  private isDesktopMedia: boolean = false;\r\n\r\n  private matchMedias: { [key in DeviceType]: MediaQueryList } = {\r\n    [DeviceType.Mobile]: window.matchMedia(this.queries[DeviceType.Mobile].mediaQuery),\r\n    [DeviceType.Tablet]: window.matchMedia(this.queries[DeviceType.Tablet].mediaQuery),\r\n    [DeviceType.Laptop]: window.matchMedia(this.queries[DeviceType.Laptop].mediaQuery),\r\n    [DeviceType.Desktop]: window.matchMedia(this.queries[DeviceType.Desktop].mediaQuery),\r\n  };\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this._type = 2;\r\n  }\r\n\r\n  onConnect() {}\r\n\r\n  onInit(): void {\r\n    if (this.settings != null) {\r\n      if (this.settings[\"settings\"] != null) {\r\n        let config = this.settings[\"settings\"];\r\n        if (config.mobile) {\r\n          this.queries[DeviceType.Mobile].enable = true;\r\n          this.queries[DeviceType.Mobile].setRange(\r\n            config.mobile.min == undefined ? null : config.mobile.min,\r\n            config.mobile.max ?? null\r\n          );\r\n          this.matchMedias[DeviceType.Mobile] = window.matchMedia(\r\n            this.queries[DeviceType.Mobile].mediaQuery\r\n          );\r\n        } else {\r\n          this.queries[DeviceType.Mobile].enable = false;\r\n        }\r\n\r\n        if (config.tablet) {\r\n          this.queries[DeviceType.Tablet].enable = true;\r\n          this.queries[DeviceType.Tablet].setRange(\r\n            config.tablet.min == undefined ? null : config.tablet.min,\r\n            config.tablet.max ?? null\r\n          );\r\n          this.matchMedias[DeviceType.Tablet] = window.matchMedia(\r\n            this.queries[DeviceType.Tablet].mediaQuery\r\n          );\r\n        } else {\r\n          this.queries[DeviceType.Tablet].enable = false;\r\n        }\r\n\r\n        if (config.laptop) {\r\n          this.queries[DeviceType.Laptop].enable = true;\r\n          this.queries[DeviceType.Laptop].setRange(\r\n            config.laptop.min == undefined ? null : config.laptop.min,\r\n            config.laptop.max ?? null\r\n          );\r\n          this.matchMedias[DeviceType.Laptop] = window.matchMedia(\r\n            this.queries[DeviceType.Laptop].mediaQuery\r\n          );\r\n        } else {\r\n          this.queries[DeviceType.Laptop].enable = false;\r\n        }\r\n\r\n        if (config.desktop) {\r\n          this.queries[DeviceType.Desktop].enable = true;\r\n          this.queries[DeviceType.Desktop].setRange(\r\n            config.desktop.min == undefined ? null : config.desktop.min,\r\n            config.desktop.max ?? null\r\n          );\r\n          this.matchMedias[DeviceType.Desktop] = window.matchMedia(\r\n            this.queries[DeviceType.Desktop].mediaQuery\r\n          );\r\n        } else {\r\n          this.queries[DeviceType.Desktop].enable = false;\r\n        }\r\n      }\r\n    }\r\n    this.updateElements();\r\n  }\r\n\r\n  onResize(): void {\r\n    this.updateElements();\r\n  }\r\n\r\n  private updateElements() {\r\n    const isMobileMedia =\r\n      this.matchMedias[DeviceType.Mobile].matches && this.queries[DeviceType.Mobile].enable;\r\n    const isTabletMedia =\r\n      this.matchMedias[DeviceType.Tablet].matches && this.queries[DeviceType.Tablet].enable;\r\n    const isLaptopMedia =\r\n      this.matchMedias[DeviceType.Laptop].matches && this.queries[DeviceType.Laptop].enable;\r\n    const isDesktopMedia =\r\n      this.matchMedias[DeviceType.Desktop].matches && this.queries[DeviceType.Desktop].enable;\r\n\r\n    if (this.isMobileMedia != isMobileMedia) {\r\n      this.events.emit(\"screen:mobile\", isMobileMedia);\r\n    }\r\n    if (this.isTabletMedia != isTabletMedia) {\r\n      this.events.emit(\"screen:tablet\", isTabletMedia);\r\n    }\r\n    if (this.isLaptopMedia != isLaptopMedia) {\r\n      this.events.emit(\"screen:laptop\", isLaptopMedia);\r\n    }\r\n    if (this.isDesktopMedia != isDesktopMedia) {\r\n      this.events.emit(\"screen:desktop\", isDesktopMedia);\r\n    }\r\n\r\n    this.isMobileMedia = isMobileMedia;\r\n    this.isTabletMedia = isTabletMedia;\r\n    this.isLaptopMedia = isLaptopMedia;\r\n    this.isDesktopMedia = isDesktopMedia;\r\n\r\n    const elements = document.querySelectorAll(\r\n      \"[string-mobile], [string-tablet], [string-laptop], [string-desktop]\"\r\n    );\r\n\r\n    elements.forEach((element: any) => {\r\n      let showElement = false;\r\n\r\n      if (element.hasAttribute(\"string-mobile\") && isMobileMedia) {\r\n        showElement = true;\r\n      }\r\n      if (element.hasAttribute(\"string-tablet\") && isTabletMedia) {\r\n        showElement = true;\r\n      }\r\n      if (element.hasAttribute(\"string-laptop\") && isLaptopMedia) {\r\n        showElement = true;\r\n      }\r\n      if (element.hasAttribute(\"string-desktop\") && isDesktopMedia) {\r\n        showElement = true;\r\n      }\r\n\r\n      if (showElement) {\r\n        element.style.display = null;\r\n      } else {\r\n        element.style.display = `none`;\r\n      }\r\n    });\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\n\r\n/**\r\n * The `StringAnchor` class extends the `StringModule` class and is responsible for\r\n * managing anchor-related functionality within the string module system.\r\n *\r\n * This class maps an `anchor` attribute to a tuple containing x and y coordinates,\r\n * processes these coordinates using the `originParser` tool, and applies the resulting\r\n * values to the connected object's element as a CSS `transform-origin` style.\r\n */\r\nexport class StringAnchor extends StringModule {\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"anchor\";\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      {\r\n        key: \"anchor\",\r\n        type: \"tuple\",\r\n        fallback: this.settings[\"anchor\"],\r\n        transform: (tuple: string[]) => {\r\n          const [xRaw, yRaw] = tuple;\r\n          const x = this.tools.originParser.process({ value: xRaw });\r\n          const y = this.tools.originParser.process({ value: yRaw });\r\n          return { x, y };\r\n        },\r\n      },\r\n    ];\r\n  }\r\n  onObjectConnected(object: StringObject) {\r\n    super.onObjectConnected(object);\r\n    const anchor = object.getProperty<{ x: string; y: string }>(\"anchor\");\r\n    if (anchor) {\r\n      this.applyToElementAndConnects(object, (el) => {\r\n        el.style.transformOrigin = `${anchor.x} ${anchor.y}`;\r\n      });\r\n    }\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\n\r\nconst ACCELERATION_STEP: number = 0.05;\r\nconst MIN_DISPLACEMENT: number = 0.01;\r\nconst MAX_DISPLACEMENT: number = 1;\r\nconst MIN_VELOCITY: number = -1;\r\nconst MAX_VELOCITY: number = 1;\r\n\r\n/**\r\n * The `StringGlide` class is a module that handles the glide effect for string objects\r\n * based on scroll events. It calculates displacement, acceleration, and velocity\r\n * to create a smooth scrolling effect for objects.\r\n */\r\nexport class StringGlide extends StringModule {\r\n  private previousLerp: number = 0;\r\n  private displacement: number = 0;\r\n  private acceleration: number = 0;\r\n  private velocityMultiplier: number = 0.00125;\r\n  private isInitialScroll: boolean = true;\r\n\r\n  private baseVelocityMultiplier: number = 0.00125;\r\n  private reducedVelocityMultiplier: number = this.baseVelocityMultiplier / 20;\r\n  private negativeVelocityMultiplier: number = -0.0001;\r\n\r\n  private maxDisplacementValue: number = 0;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"glide\";\r\n\r\n    this.baseVelocityMultiplier =\r\n      this.settings[\"glide-base-velocity\"] ?? this.baseVelocityMultiplier;\r\n    this.reducedVelocityMultiplier =\r\n      this.settings[\"glide-reduce-velocity\"] ?? this.reducedVelocityMultiplier;\r\n    this.negativeVelocityMultiplier =\r\n      this.settings[\"glide-negative-velocity\"] ?? this.negativeVelocityMultiplier;\r\n\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      { key: \"glide\", type: \"number\", fallback: this.settings[\"glide\"] },\r\n    ];\r\n  }\r\n\r\n  private setupItem = (object: StringObject) => {\r\n    let glide = object.getProperty<number>(\"glide\") ?? 0;\r\n\r\n    let glideValue = -this.data.scroll.displacement * this.maxDisplacementValue * glide;\r\n    this.events.emit(`object:glide:${object.id}`, glideValue);\r\n\r\n    const transformCompute = `translate3d(0, ${glideValue}px, 0)`;\r\n    object.htmlElement.style.transform = transformCompute;\r\n  };\r\n\r\n  private onUpdateDesktopEvent = () => {\r\n    for (let i = 0; i < this.objects.length; i++) {\r\n      let object = this.objects[i];\r\n      this.setupItem(object);\r\n    }\r\n  };\r\n  private onUpdateMobileEvent = () => {};\r\n  private onUpdateEvent = this.onUpdateDesktopEvent;\r\n\r\n  private calcExpanderFactor(isDirectionUp: boolean): void {\r\n    const isConditionMet = isDirectionUp\r\n      ? this.data.scroll.lerped < this.previousLerp\r\n      : this.data.scroll.lerped > this.previousLerp;\r\n\r\n    this.velocityMultiplier = isConditionMet\r\n      ? this.isInitialScroll\r\n        ? this.baseVelocityMultiplier\r\n        : this.reducedVelocityMultiplier\r\n      : this.negativeVelocityMultiplier;\r\n\r\n    if (!isConditionMet) {\r\n      this.isInitialScroll = false;\r\n    }\r\n  }\r\n  onStart(): void {\r\n    this.maxDisplacementValue = this.data.viewport.windowHeight * 0.1;\r\n  }\r\n\r\n  onResize(): void {\r\n    if (window.innerWidth > 1024) {\r\n      this.maxDisplacementValue = this.data.viewport.windowHeight * 0.1;\r\n      this.onUpdateEvent = this.onUpdateDesktopEvent;\r\n    } else {\r\n      this.onUpdateEvent = this.onUpdateMobileEvent;\r\n      this.resetState();\r\n      this.objects.forEach((object) => {\r\n        this.setupItem(object);\r\n      });\r\n    }\r\n  }\r\n\r\n  private resetState(): void {\r\n    this.displacement = 0;\r\n    this.acceleration = 0;\r\n    this.isInitialScroll = true;\r\n    this.velocityMultiplier = this.baseVelocityMultiplier;\r\n  }\r\n\r\n  onScrollStart(): void {\r\n    this.resetState();\r\n  }\r\n\r\n  onScrollStop(): void {\r\n    this.resetState();\r\n    this.previousLerp = 0;\r\n    //document.documentElement.style.setProperty('--glide', '0');\r\n    for (let i = 0; i < this.objects.length; i++) {\r\n      let object = this.objects[i];\r\n      const transformCompute = `translate3d(0, 0px, 0)`;\r\n      object.htmlElement.style.transform = transformCompute;\r\n      object.htmlElement.style.setProperty(\"--glide\", this.data.scroll.displacement.toString());\r\n    }\r\n  }\r\n\r\n  onFrame(data: StringData): void {\r\n    this.calcExpanderFactor(this.data.scroll.isScrollingDown === false);\r\n    this.acceleration = Math.min(MAX_DISPLACEMENT, this.acceleration + ACCELERATION_STEP);\r\n    this.displacement = Math.max(\r\n      MIN_DISPLACEMENT,\r\n      Math.min(MAX_DISPLACEMENT, this.displacement + this.velocityMultiplier)\r\n    );\r\n    this.data.scroll.displacement = Math.min(\r\n      MAX_VELOCITY,\r\n      Math.max(MIN_VELOCITY, this.data.scroll.lerped * this.displacement * this.acceleration)\r\n    );\r\n    this.objects.forEach((object) => {\r\n      this.applyToElementAndConnects(object, (el) => {\r\n        el.style.setProperty(\"--glide\", this.data.scroll.displacement.toString());\r\n      });\r\n    });\r\n    this.previousLerp = this.data.scroll.lerped;\r\n    this.onUpdateEvent();\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringToolsContainer } from \"../../core/StringToolsContainer\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\n\r\n/**\r\n * Module that updates the `--lerp` CSS variable on elements\r\n * based on current scroll velocity.\r\n */\r\nexport class StringLerp extends StringModule {\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"lerp\";\r\n  }\r\n\r\n  /**\r\n   * Resets the `--lerp` value to 0 when scroll stops.\r\n   */\r\n  onScrollStop(): void {\r\n    this.objects.forEach((object) => {\r\n      this.setLerpValue(object, 0);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Updates `--lerp` value for each connected object during scroll.\r\n   */\r\n  onFrame(data: StringData): void {\r\n    const velocity = data.scroll.lerped;\r\n    this.objects.forEach((object) => {\r\n      this.setLerpValue(object, velocity);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets the `--lerp` CSS variable on the object.\r\n   */\r\n  private setLerpValue(object: StringObject, value: number): void {\r\n    this.events.emit(`object:lerp:${object.id}`, value);\r\n    object.htmlElement.style.setProperty(\"--lerp\", value.toString());\r\n  }\r\n}\r\n","﻿import { StringContext } from \"../../core/StringContext\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringMirrorObject } from \"../../objects/StringMirrorObject\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { EasingFunctionOutput } from \"../../tools/EasingFunctionTool\";\r\nimport { styleTxn } from \"../../utils/style-txn\";\r\n\r\nexport class StringProgress extends StringModule {\r\n  protected updateScheduled = false;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"progress\";\r\n\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      { key: \"easing\", type: \"easing\", fallback: this.settings[\"easing\"] },\r\n    ];\r\n  }\r\n\r\n  initializeObject(\r\n    globalId: number,\r\n    object: StringObject,\r\n    element: HTMLElement,\r\n    attributes: Record<string, any>\r\n  ): void {\r\n    super.initializeObject(globalId, object, element, attributes);\r\n  }\r\n\r\n  private recomputeProgress(object: StringObject): void {\r\n    const startPosition = object.getProperty<number>(\"start-position\") ?? 0;\r\n    const differencePosition = object.getProperty<number>(\"difference-position\") ?? 0;\r\n\r\n    let rawProgress = 0;\r\n    rawProgress = Math.min(\r\n      1,\r\n      Math.max(0, (this.data.scroll.transformedCurrent - startPosition) / differencePosition)\r\n    );\r\n\r\n    object.setProperty<number>(\"progress-raw\", rawProgress);\r\n\r\n    const easing = object.getProperty<EasingFunctionOutput>(\"easing\");\r\n    const progress = typeof easing === \"function\" ? easing(rawProgress) : rawProgress;\r\n    this.applyProgressValue(object, progress);\r\n  }\r\n\r\n  private applyProgressValue(object: StringObject, progress: number): void {\r\n    object.setProperty<number>(\"progress\", progress);\r\n  }\r\n\r\n  calculatePositions(object: StringObject, windowSize: number) {\r\n    super.calculatePositions(object, windowSize);\r\n    this.recomputeProgress(object);\r\n  }\r\n\r\n  onScroll(data: StringData): void {\r\n    super.onScroll(data);\r\n  }\r\n\r\n  onObjectConnected(object: StringObject) {\r\n    super.onObjectConnected(object);\r\n  }\r\n\r\n  onScrollMeasure(data: StringData) {\r\n    this.objects.forEach((object) => {\r\n      this.recomputeProgress(object);\r\n    });\r\n  }\r\n\r\n  onMutate() {\r\n    this.objects.forEach((object) => {\r\n      this.updateObjectProgress(object);\r\n    });\r\n  }\r\n\r\n  private updateObjectProgress(object: StringObject): void {\r\n    const key = object.getProperty<string>(\"key\");\r\n    const progress = object.getProperty<number>(\"progress\");\r\n\r\n    const rawProgress = object.getProperty<number>(\"progress-raw\") ?? progress;\r\n    const progressStr = progress.toString();\r\n    const parentEasing = object.getProperty<EasingFunctionOutput>(\"easing\");\r\n\r\n    this.events.emit(`object:progress:${object.id}`, progress);\r\n\r\n    this.applyToElementAndConnects(\r\n      object,\r\n      (el) => {\r\n        if (key) {\r\n          styleTxn.setVars(el, { [key]: progressStr });\r\n        }\r\n      },\r\n      (el: HTMLElement, mirror?: StringMirrorObject) => {\r\n        if (!mirror) return;\r\n        const eased = mirror.applyProgress(\r\n          rawProgress,\r\n          typeof parentEasing === \"function\" ? parentEasing : undefined\r\n        );\r\n        mirror.setProperty(\"progress\", eased);\r\n        if (key) {\r\n          styleTxn.setVars(el, { [key]: eased.toString() });\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  onObjectDisconnected(object: StringObject): void {\r\n    super.onObjectDisconnected(object);\r\n    const key = object.getProperty<string>(\"key\");\r\n    if (!key) return;\r\n\r\n    const clearCustomProperty = (el: HTMLElement) => {\r\n      el.style.removeProperty(key);\r\n    };\r\n\r\n    clearCustomProperty(object.htmlElement);\r\n    object.mirrorObjects.forEach((mirror) => {\r\n      clearCustomProperty(mirror.htmlElement);\r\n    });\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { frameDOM } from \"../../utils/frame-dom\";\r\nimport { styleTxn } from \"../../utils/style-txn\";\r\nimport { StringProgress } from \"./StringProgress\";\r\n\r\ntype ParallaxTransformResult = { transform: string };\r\n\r\n/**\r\n * The `StringParallax` class extends the `StringProgress` class to provide\r\n * functionality for handling parallax effects on scrollable elements.\r\n * It maps specific attributes related to parallax and calculates the\r\n * necessary transformations based on scroll progress and viewport size.\r\n */\r\nexport class StringParallax extends StringProgress {\r\n  private updateScheduledTransform = false;\r\n  private calculateParallaxForObject: (object: StringObject) => ParallaxTransformResult | null;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"parallax\";\r\n\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      { key: \"parallax\", type: \"number\", fallback: this.settings[\"parallax\"] },\r\n      {\r\n        key: \"parallax-bias\",\r\n        type: \"number\",\r\n        fallback: this.settings[\"parallax-bias\"],\r\n      },\r\n    ];\r\n\r\n    this.calculateParallaxForObject = this.calculateDesktopParallax;\r\n  }\r\n\r\n  /**\r\n   * Called when an object is initialized.\r\n   */\r\n  override initializeObject(\r\n    globalId: number,\r\n    object: StringObject,\r\n    element: HTMLElement,\r\n    attributes: Record<string, any>\r\n  ): void {\r\n    super.initializeObject(globalId, object, element, attributes);\r\n    const bias = object.getProperty<number>(\"parallax-bias\") ?? 0.0;\r\n    const factor = Math.abs(object.getProperty<number>(\"parallax\") ?? 0.2);\r\n    object.setProperty(\"parallax-sign\", Math.sign(object.getProperty<number>(\"parallax\")));\r\n    object.setProperty<number>(\"parallax\", factor);\r\n    object.setProperty(\"parallax-position-start\", -0.5 + 0.5 * bias);\r\n    object.setProperty(\"parallax-position-end\", 0.5 + 0.5 * (1 - bias));\r\n\r\n    const screenSize = this.data.viewport.windowHeight;\r\n\r\n    object.setProperty(\"offset-top\", factor * screenSize);\r\n    object.setProperty(\"offset-bottom\", factor * screenSize);\r\n  }\r\n\r\n  calculatePositions(object: StringObject, windowSize: number) {\r\n    super.calculatePositions(object, windowSize);\r\n    object.setProperty(\"transform-value\", this.calculateParallaxForObject(object));\r\n  }\r\n\r\n  override onScroll(data: StringData): void {\r\n    super.onScroll(data);\r\n  }\r\n\r\n  override onResize(): void {\r\n    const isDesktop = window.innerWidth > 1024;\r\n    this.calculateParallaxForObject = isDesktop\r\n      ? this.calculateDesktopParallax\r\n      : this.calculateMobileParallax;\r\n  }\r\n\r\n  onScrollMeasure(data: StringData) {\r\n    super.onScrollMeasure(data);\r\n    this.objects.forEach((object) => {\r\n      object.setProperty(\"transform-value\", this.calculateParallaxForObject(object));\r\n    });\r\n  }\r\n\r\n  onMutate() {\r\n    this.objects.forEach((object) => {\r\n      const transformData = object.getProperty<ParallaxTransformResult>(\"transform-value\");\r\n      this.applyToElementAndConnects(object, (el) => {\r\n        styleTxn.setProps(el, transformData);\r\n      });\r\n    });\r\n  }\r\n\r\n  private calculateDesktopParallax = (object: StringObject): ParallaxTransformResult => {\r\n    const progress = object.getProperty<number>(\"progress\") ?? 0;\r\n    const factor = object.getProperty<number>(\"parallax\") ?? 0;\r\n    const start = object.getProperty<number>(\"parallax-position-start\") ?? 0;\r\n    const end = object.getProperty<number>(\"parallax-position-end\") ?? 1;\r\n    const sign = object.getProperty<number>(\"parallax-sign\") ?? 1;\r\n\r\n    const screenSize = this.data.viewport.windowHeight / this.data.viewport.transformScale;\r\n    const translation = sign * factor * (screenSize * start + progress * screenSize * end);\r\n\r\n    this.events.emit(`object:parallax:${object.id}`, translation);\r\n\r\n    return { transform: `translate3d(0, ${translation}px, 0)` };\r\n  };\r\n\r\n  private calculateMobileParallax = (object: StringObject): ParallaxTransformResult => {\r\n    this.events.emit(`object:parallax:${object.id}`, 0);\r\n    return { transform: `translate3d(0, 0px, 0)` };\r\n  };\r\n}\r\n","import { StringData } from \"../../core/StringData\";\r\n\r\nexport class StringScrollbarHorizontal {\r\n  private scrollbar: any;\r\n  private thumb: any;\r\n  private isDragging = false;\r\n  private startY: number = 0;\r\n  private startScrollPosition: number = 0;\r\n  data: StringData;\r\n\r\n  constructor(data: StringData, scrollbar: any, thumb: any) {\r\n    this.data = data;\r\n    this.scrollbar = scrollbar;\r\n    this.thumb = thumb;\r\n  }\r\n\r\n  onResize(): void {\r\n    const contentWidth = this.data.viewport.contentWidth;\r\n    const visibleWidth = this.data.viewport.windowWidth;\r\n\r\n    const thumbSize = (visibleWidth / contentWidth) * visibleWidth;\r\n    this.thumb.style.setProperty('--size', thumbSize + 'px');\r\n\r\n    if (contentWidth <= visibleWidth) {\r\n      this.scrollbar.classList.add('-hide');\r\n    } else {\r\n      this.scrollbar.classList.remove('-hide');\r\n    }\r\n  }\r\n\r\n  updateThumb() {\r\n    const contentWidth = this.data.viewport.contentWidth;\r\n    const visibleWidth = this.data.viewport.windowWidth;\r\n    this.thumb.style.setProperty('--position', `${(this.data.scroll.current / contentWidth) * visibleWidth + 'px'}`);\r\n  }\r\n\r\n  mouseDownEvent(e: MouseEvent) {\r\n    this.startY = e.clientY;\r\n    this.startScrollPosition = this.data.scroll.current;\r\n  }\r\n\r\n  mouseMoveEvent(e: MouseEvent) {\r\n    const deltaY = e.clientY - this.startY;\r\n    const newScrollPosition = this.startScrollPosition + (deltaY / this.data.viewport.windowWidth) * this.data.viewport.contentWidth;\r\n    this.data.scroll.current = newScrollPosition;\r\n    this.data.scroll.target = newScrollPosition;\r\n    window.scrollTo(0, newScrollPosition);\r\n    this.updateThumb();\r\n  }\r\n}\r\n","import { StringData } from \"../../core/StringData\";\r\n\r\nexport class StringScrollbarVertical {\r\n  private scrollbar: any;\r\n  private thumb: any;\r\n  private isDragging = false;\r\n  private startCoordinate: number = 0;\r\n  private startScrollPosition: number = 0;\r\n  data: StringData;\r\n\r\n  constructor(data: StringData, scrollbar: any, thumb: any) {\r\n    this.data = data;\r\n    this.scrollbar = scrollbar;\r\n    this.thumb = thumb;\r\n  }\r\n\r\n  onResize(): void {\r\n    const contentSize = this.data.viewport.contentHeight;\r\n    const visibleSize = this.data.viewport.windowHeight;\r\n    const thumbSize = (visibleSize / contentSize) * visibleSize;\r\n    this.thumb.style.setProperty('--height', thumbSize + 'px');\r\n    if (contentSize <= visibleSize) {\r\n      this.scrollbar.classList.add('-hide');\r\n    } else {\r\n      this.scrollbar.classList.remove('-hide');\r\n    }\r\n  }\r\n\r\n  updateThumb() {\r\n    const contentHeight = this.data.viewport.contentHeight;\r\n    const visibleHeight = this.data.viewport.windowHeight;\r\n    \r\n    this.thumb.style.setProperty('--position', `${(this.data.scroll.current / contentHeight) * visibleHeight + 'px'}`);\r\n  }\r\n\r\n  mouseDownEvent(e: MouseEvent) {\r\n    this.startCoordinate = e.clientY;\r\n    this.startScrollPosition = this.data.scroll.current;\r\n  }\r\n\r\n  mouseMoveEvent(e: MouseEvent) {\r\n    const deltaY = e.clientY - this.startCoordinate;\r\n    const newScrollPosition = this.startScrollPosition + (deltaY / this.data.viewport.windowHeight) * this.data.viewport.contentHeight;\r\n    const maxScroll = this.data.scroll.bottomPosition;\r\n    const clamped = Math.max(0, Math.min(newScrollPosition, maxScroll));\r\n    this.data.scroll.current = clamped;\r\n    this.data.scroll.target = clamped;\r\n    window.scrollTo(0, clamped);\r\n    this.updateThumb();\r\n  }\r\n}\r\n","import { StringContext } from '../../core/StringContext';\r\nimport { StringData } from '../../core/StringData';\r\nimport { StringModule } from '../../core/StringModule';\r\nimport { StringScrollbarHorizontal } from './StringScrollbarHorizontal';\r\nimport { StringScrollbarVertical } from './StringScrollbarVertical';\r\n\r\nexport class StringScrollbar extends StringModule {\r\n  private scrollbar: any;\r\n  private thumb: any;\r\n  private scrollTimeout: any;\r\n\r\n  private isDragging = false;\r\n  private scrollMode: 'smooth' | 'disable' | 'default' = 'smooth';\r\n\r\n  private mouseUpEventBind: any;\r\n  private mouseDownEventBind: any;\r\n  private mouseMoveEventBind: any;\r\n\r\n  private scrollbarState: any;\r\n  private scrollbarStateHorizontal: any;\r\n  private scrollbarStateVertical: any;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context)\r\n\r\n    this.mouseUpEventBind = this.mouseUpEvent.bind(this);\r\n    this.mouseDownEventBind = this.mouseDownEvent.bind(this);\r\n    this.mouseMoveEventBind = this.mouseMoveEvent.bind(this);\r\n  }\r\n  destructor(): void {\r\n    document.removeEventListener('mouseup', this.mouseUpEventBind);\r\n    this.thumb.removeEventListener('mousedown', this.mouseDownEventBind);\r\n    document.removeEventListener('mousemove', this.mouseMoveEventBind);\r\n  }\r\n\r\n  onInit(): void {\r\n    this.createScrollbar();\r\n    this.updateThumb();\r\n    this.addCustomStyles();\r\n    document.addEventListener('mouseup', this.mouseUpEventBind);\r\n    this.thumb.addEventListener('mousedown', this.mouseDownEventBind);\r\n    document.addEventListener('mousemove', this.mouseMoveEventBind);\r\n    document.documentElement.classList.add(`-no-scrollbar`);\r\n  }\r\n\r\n  onScroll(data: StringData): void {\r\n    this.updateThumb();\r\n    this.showScrollbar();\r\n    this.hideScrollbar();\r\n  }\r\n\r\n  onResize(): void {\r\n    this.scrollbarState.onResize();\r\n  }\r\n\r\n  private addCustomStyles() {\r\n    const style = document.createElement('style');\r\n    style.textContent = `\r\n          ::-webkit-scrollbar {\r\n            display: none;\r\n            width: 0;\r\n            height: 0;\r\n            -webkit-appearance: none;\r\n          }\r\n          body {\r\n            -ms-overflow-style: none;  /* IE and Edge */\r\n            scrollbar-width: none;  /* Firefox */\r\n          }\r\n          .-without-scrollbar::-webkit-scrollbar {\r\n            display: none;\r\n          }\r\n          .-without-scrollbar {\r\n              -ms-overflow-style: none; /* IE and Edge */\r\n              scrollbar-width: none; /* Firefox */\r\n          }\r\n      `;\r\n    document.head.appendChild(style);\r\n  }\r\n\r\n  private createScrollbar() {\r\n    this.scrollbar = document.createElement('div');\r\n    this.scrollbar.classList.add('scrollbar');\r\n    this.thumb = document.createElement('div');\r\n    this.thumb.classList.add('thumb');\r\n    this.scrollbar.appendChild(this.thumb);\r\n    document.body.appendChild(this.scrollbar);\r\n\r\n    this.scrollbarStateHorizontal = new StringScrollbarHorizontal(this.data, this.scrollbar, this.thumb);\r\n    this.scrollbarStateVertical = new StringScrollbarVertical(this.data, this.scrollbar, this.thumb);\r\n    this.scrollbarState = this.scrollbarStateVertical;\r\n  }\r\n\r\n  private updateThumb() {\r\n    this.scrollbarState.updateThumb();\r\n  }\r\n\r\n  private mouseDownEvent(e: MouseEvent) {\r\n    this.isDragging = true;\r\n    this.scrollbarState.mouseDownEvent(e);\r\n    document.body.style.userSelect = 'none';\r\n    this.scrollbar.classList.add('-touch');\r\n  }\r\n\r\n  private mouseMoveEvent(e: MouseEvent) {\r\n    if (!this.isDragging) return;\r\n\r\n    this.scrollbarState.mouseMoveEvent(e);\r\n  }\r\n\r\n  private mouseUpEvent() {\r\n    this.isDragging = false;\r\n    document.body.style.userSelect = '';\r\n    this.hideScrollbar();\r\n    this.scrollbar.classList.remove('-touch');\r\n  }\r\n\r\n  private showScrollbar() {\r\n    this.scrollbar.classList.add('-scroll');\r\n  }\r\n\r\n  private hideScrollbar() {\r\n    if (this.scrollTimeout) {\r\n      clearTimeout(this.scrollTimeout);\r\n    }\r\n    this.scrollTimeout = setTimeout(() => {\r\n      this.scrollbar.classList.remove('-scroll');\r\n    }, 1000);\r\n  }\r\n}\r\n","export const SPLIT_ELEMENT_CLASS = {\r\n  BEFORE_ELEMENT: \"-before-element\",\r\n  AFTER_ELEMENT: \"-after-element\",\r\n} as const;\r\n","import { CalculatedValue } from \"../../models/text/CalculatedValue\";\r\nimport { LayoutLine } from \"./SplitMeasuredTokens\";\r\nimport { ISplitOptions } from \"../../models/text/ISplitOptions\";\r\nimport { SPLIT_ELEMENT_CLASS } from \"../../models/text/SplitElementClass\";\r\nimport { FontMetrics } from \"./CanvasKerningApplier\";\r\n\r\nfunction getWholeWordSplitClass(word: any): string[] {\r\n  if (!word || !Array.isArray(word.chars) || word.chars.length === 0) return [];\r\n  const first = (word.chars[0] as any).splitClass ?? [];\r\n  if (first.length === 0) return [];\r\n  for (const ch of word.chars) {\r\n    const cls = (ch as any).splitClass ?? [];\r\n    if (cls.length !== first.length) return [];\r\n    for (let i = 0; i < cls.length; i++) {\r\n      if (cls[i] !== first[i]) return [];\r\n    }\r\n  }\r\n  return first;\r\n}\r\n\r\nexport function BuildDOMTree(\r\n  layoutLines: LayoutLine[],\r\n  options: ISplitOptions,\r\n  fontMetrics: FontMetrics\r\n): { fragment: DocumentFragment; extraProps: Map<string, string> } {\r\n  const fragment = document.createDocumentFragment();\r\n  let localCharIndex = 0;\r\n\r\n  const hasLine =\r\n    hasOption(options, \"line\") || hasOption(options, \"charLine\") || hasOption(options, \"wordLine\");\r\n\r\n  const hasChar =\r\n    hasOption(options, \"char\") || hasOption(options, \"charLine\") || hasOption(options, \"charWord\");\r\n\r\n  let wordsCount = 0;\r\n  layoutLines.forEach((line) => (wordsCount += line.words.length));\r\n  wordsCount--;\r\n\r\n  let charsCount = 0;\r\n  layoutLines.forEach((line) => line.words.forEach((w) => (charsCount += w.chars.length)));\r\n\r\n  const linesCount = layoutLines.length;\r\n  const wordsGlobalCount = wordsCount + 1;\r\n\r\n  const extraProps = new Map<string, string>();\r\n\r\n  layoutLines.forEach((line, li) => {\r\n    const isLastInLayout = li === layoutLines.length - 1;\r\n\r\n    let container: HTMLElement | DocumentFragment = fragment;\r\n    const wordsForLine: string[] = [];\r\n\r\n    if (hasLine) {\r\n      container = document.createElement(\"span\");\r\n      container.setAttribute(\"aria-hidden\", \"true\");\r\n      container.classList.add(\"-s-line\");\r\n      if (line.isBeforeElement)\r\n        (container as HTMLElement).classList.add(SPLIT_ELEMENT_CLASS.BEFORE_ELEMENT);\r\n      if (line.isAfterElement)\r\n        (container as HTMLElement).classList.add(SPLIT_ELEMENT_CLASS.AFTER_ELEMENT);\r\n      (container as HTMLElement).style.setProperty(\"--line-index\", String(line.lineIndex));\r\n      (container as HTMLElement).style.setProperty(\"--word-total\", String(line.words.length));\r\n      applyStyles(container as HTMLElement, (line as any).calculatedValues, options);\r\n    }\r\n\r\n    line.words.forEach((word, wi) => {\r\n      if (hasLine) {\r\n        wordsCount = line.words.length - 1;\r\n      }\r\n      const isLast = wi === wordsCount;\r\n      const isElementWord = word.chars.length === 1 && word.chars[0].token.type === \"element\";\r\n      if (isElementWord) {\r\n        const original = word.chars[0].token.node.cloneNode(true) as HTMLElement;\r\n        container.appendChild(original);\r\n        return;\r\n      }\r\n\r\n      const wordText = word.chars.map((c) => c.char).join(\"\");\r\n      if (wordText) {\r\n        wordsForLine.push(wordText);\r\n      }\r\n\r\n      const hasWord =\r\n        hasOption(options, \"word\") ||\r\n        hasOption(options, \"charWord\") ||\r\n        hasOption(options, \"wordLine\");\r\n\r\n      const wordEl = hasWord ? document.createElement(\"span\") : (container as HTMLElement);\r\n\r\n      const wholeWordClass = getWholeWordSplitClass(word);\r\n\r\n      if (hasWord) {\r\n        wordEl.setAttribute(\"aria-hidden\", \"true\");\r\n        wordEl.classList.add(\"-s-word\");\r\n        if (word.isBeforeElement) wordEl.classList.add(SPLIT_ELEMENT_CLASS.BEFORE_ELEMENT);\r\n        if (word.isAfterElement) wordEl.classList.add(SPLIT_ELEMENT_CLASS.AFTER_ELEMENT);\r\n        wordEl.style.setProperty(\"--word-index\", String(word.wordIndexGlobal));\r\n        wordEl.style.setProperty(\"--char-total\", String(word.chars.length));\r\n        wordEl.setAttribute(\"data-split-content\", wordText);\r\n        applyStyles(wordEl, (word as any).calculatedValues, options);\r\n\r\n        if (wholeWordClass.length) {\r\n          wordEl.classList.add(...wholeWordClass);\r\n        }\r\n      }\r\n\r\n      if (hasChar) {\r\n        word.chars.forEach((char, charIndex) => {\r\n          if (char.char === \" \" || char.char === \"\\t\") return;\r\n\r\n          const charNode = document.createElement(\"span\");\r\n          charNode.setAttribute(\"aria-hidden\", \"true\");\r\n          const charEl = charNode as HTMLElement;\r\n\r\n          charEl.classList.add(\"-s-char\");\r\n          if (char.isBeforeElement) charEl.classList.add(SPLIT_ELEMENT_CLASS.BEFORE_ELEMENT);\r\n          if (char.isAfterElement) charEl.classList.add(SPLIT_ELEMENT_CLASS.AFTER_ELEMENT);\r\n\r\n          charEl.textContent = char.char;\r\n          charEl.setAttribute(\"data-split-content\", char.char);\r\n          charEl.style.setProperty(\"--char-index\", String(localCharIndex++));\r\n\r\n          const nextChar = word.chars[charIndex + 1];\r\n          if (nextChar) {\r\n            const kerning = fontMetrics.getKerning(char.char, nextChar.char);\r\n            if (Math.abs(kerning) > 0.01) {\r\n              charEl.style.marginRight = `${kerning.toFixed(2)}px`;\r\n            }\r\n          }\r\n\r\n          applyStyles(charEl, (char as any).calculatedValues, options);\r\n\r\n          const splitClassChar: string[] = (char as any).splitClass ?? [];\r\n          if (splitClassChar.length && !wholeWordClass.length) {\r\n            charEl.classList.add(...splitClassChar);\r\n          }\r\n\r\n          wordEl.appendChild(charNode);\r\n        });\r\n      } else {\r\n        const textNode = document.createTextNode(wordText);\r\n        wordEl.appendChild(textNode);\r\n      }\r\n\r\n      if (hasWord) {\r\n        container.appendChild(wordEl);\r\n      }\r\n\r\n      if (hasLine) {\r\n        if (!isLast) {\r\n          wordEl.appendChild(document.createTextNode(\"\\u00a0\"));\r\n        } else if (!isLastInLayout) {\r\n          container.appendChild(document.createElement(\"br\"));\r\n        }\r\n      } else {\r\n        if (!isLast) {\r\n          wordEl.appendChild(document.createTextNode(\"\\u00a0\"));\r\n        }\r\n      }\r\n    });\r\n\r\n    if (hasLine) {\r\n      const lineText = wordsForLine.join(\" \");\r\n      (container as HTMLElement).setAttribute(\"data-split-content\", lineText);\r\n      fragment.appendChild(container as HTMLElement);\r\n    }\r\n  });\r\n\r\n  if (hasChar) {\r\n    extraProps.set(\"--char-global-total\", String(charsCount));\r\n  }\r\n  if (\r\n    hasOption(options, \"word\") ||\r\n    hasOption(options, \"charWord\") ||\r\n    hasOption(options, \"wordLine\")\r\n  ) {\r\n    extraProps.set(\"--word-global-total\", String(wordsGlobalCount));\r\n  }\r\n  if (hasLine) {\r\n    extraProps.set(\"--line-global-total\", String(linesCount));\r\n  }\r\n\r\n  return { fragment, extraProps };\r\n}\r\n\r\nfunction applyStyles(\r\n  el: HTMLElement,\r\n  calculatedValues: CalculatedValue[] | undefined,\r\n  options: ISplitOptions\r\n) {\r\n  if (!calculatedValues) return;\r\n  for (const val of calculatedValues) {\r\n    if (!isOptionEnabled(val.type, val.align, options)) continue;\r\n    const varName = generateVariableName(val.type, val.align);\r\n    el.style.setProperty(varName, String(val.value));\r\n  }\r\n}\r\n\r\nfunction isOptionEnabled(type: string, align: string, options: ISplitOptions): boolean {\r\n  const group = options[type as keyof ISplitOptions] ?? [];\r\n  return (\r\n    Array.isArray(group) &&\r\n    group.some((item) =>\r\n      align.startsWith(\"random\") ? item.align.startsWith(\"random\") : item.align === align\r\n    )\r\n  );\r\n}\r\n\r\nfunction generateVariableName(type: string, align: string): string {\r\n  const norm = align.startsWith(\"random\") ? \"random\" : align;\r\n  return `--${type}-${norm}`;\r\n}\r\n\r\nfunction hasOption(options: ISplitOptions, key: keyof ISplitOptions): boolean {\r\n  return Array.isArray(options[key]) && options[key]!.length > 0;\r\n}\r\n","export type Token =\r\n  | {\r\n      type: \"text\";\r\n      id: string;\r\n      node: Text;\r\n      content: string;\r\n      meta?: Record<string, any>;\r\n    }\r\n  | {\r\n      type: \"space\";\r\n      id: string;\r\n      node: Text;\r\n      content: string;\r\n      meta?: Record<string, any>;\r\n    }\r\n  | {\r\n      type: \"element\";\r\n      id: string;\r\n      node: HTMLElement;\r\n      tagName: string;\r\n      meta?: Record<string, any>;\r\n    }\r\n  | {\r\n      type: \"br\";\r\n      id: string;\r\n      node: HTMLElement;\r\n      tagName: \"br\";\r\n      meta?: Record<string, any>;\r\n    }\r\n  | {\r\n      type: \"other\";\r\n      id: string;\r\n      node: Node;\r\n      meta?: Record<string, any>;\r\n    };\r\n\r\nlet tokenCounter = 0;\r\n\r\nexport function BuildTokens(nodes: NodeListOf<ChildNode>): Token[] {\r\n  tokenCounter = 0;\r\n  const tokens: Token[] = [];\r\n\r\n  const pushWithMeta = (t: Token, extra: Record<string, any> | undefined) => {\r\n    if (extra && Object.keys(extra).length) {\r\n      t.meta = { ...(t.meta || {}), ...extra };\r\n    }\r\n    tokens.push(t);\r\n  };\r\n\r\n  const processNode = (node: ChildNode, carryMeta?: Record<string, any>) => {\r\n    if (node.nodeType === Node.ELEMENT_NODE) {\r\n      const el = node as HTMLElement;\r\n      const tag = el.tagName.toLowerCase();\r\n\r\n      if (tag === \"split-class\") {\r\n        const classes = (el.getAttribute(\"class\") ?? \"\").split(/\\s+/).filter(Boolean);\r\n        const extraMeta = {\r\n          ...(carryMeta || {}),\r\n          splitClass: [...((carryMeta?.splitClass as string[]) ?? []), ...classes],\r\n        };\r\n        el.childNodes.forEach((child) => processNode(child as ChildNode, extraMeta));\r\n        return;\r\n      }\r\n\r\n      if (tag === \"br\") {\r\n        pushWithMeta(\r\n          {\r\n            type: \"br\",\r\n            id: `br_${tokenCounter++}`,\r\n            node: el,\r\n            tagName: \"br\",\r\n          },\r\n          carryMeta\r\n        );\r\n        return;\r\n      }\r\n\r\n      pushWithMeta(\r\n        {\r\n          type: \"element\",\r\n          id: `el_${tokenCounter++}`,\r\n          node: el,\r\n          tagName: tag,\r\n        },\r\n        carryMeta\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (node.nodeType === Node.TEXT_NODE) {\r\n      const text = node.nodeValue ?? \"\";\r\n      const id = `text_${tokenCounter++}`;\r\n      if (text.trim()) {\r\n        pushWithMeta({ type: \"text\", id, node: node as Text, content: text }, carryMeta);\r\n      } else {\r\n        pushWithMeta({ type: \"space\", id, node: node as Text, content: text }, carryMeta);\r\n      }\r\n      return;\r\n    }\r\n\r\n    pushWithMeta({ type: \"other\", id: `node_${tokenCounter++}`, node }, carryMeta);\r\n  };\r\n\r\n  nodes.forEach((n) => processNode(n as ChildNode));\r\n  return tokens;\r\n}\r\n","type PairKey = `${string}|${string}`;\n\nexport class FontMetrics {\n  private ctx: CanvasRenderingContext2D;\n  private font: string = \"\";\n  private cache = {\n    kerning: new Map<PairKey, number>(),\n    charWidth: new Map<string, number>(),\n  };\n\n  constructor(element: HTMLElement) {\n    const canvas = document.createElement(\"canvas\");\n    this.ctx = canvas.getContext(\"2d\")!;\n    this.setFontFromElement(element);\n  }\n\n  public setFontFromElement(element: HTMLElement): void {\n    const cs = window.getComputedStyle(element);\n    const font = `${cs.fontStyle} ${cs.fontVariant} ${cs.fontWeight} ${cs.fontSize}/${cs.lineHeight} ${cs.fontFamily}`;\n    if (font !== this.font) {\n      this.font = font;\n      this.ctx.font = this.font;\n      this.cache.kerning.clear();\n      this.cache.charWidth.clear();\n    }\n  }\n\n  public getCharWidth(char: string): number {\n    if (this.cache.charWidth.has(char)) {\n      return this.cache.charWidth.get(char)!;\n    }\n    const width = this.ctx.measureText(char).width;\n    this.cache.charWidth.set(char, width);\n    return width;\n  }\n\n  public getKerning(charA: string, charB: string): number {\n    const pair = `${charA}${charB}`;\n    const key: PairKey = `${this.font}|${pair}`;\n\n    if (this.cache.kerning.has(key)) {\n      return this.cache.kerning.get(key)!;\n    }\n\n    const widthWithKerning = this.ctx.measureText(pair).width;\n    const widthWithoutKerning = this.getCharWidth(charA) + this.getCharWidth(charB);\n\n    const kerning = widthWithKerning - widthWithoutKerning;\n\n    this.cache.kerning.set(key, kerning);\n    return kerning;\n  }\n\n  public measureWord(word: string): number {\n    let totalWidth = 0;\n    for (let i = 0; i < word.length; i++) {\n      const char = word[i];\n      totalWidth += this.getCharWidth(char);\n\n      if (i > 0) {\n        const prevChar = word[i - 1];\n        totalWidth += this.getKerning(prevChar, char);\n      }\n    }\n    return totalWidth;\n  }\n}\n","import { Token } from \"./BuildTokens\";\r\nimport { FontMetrics } from \"./CanvasKerningApplier\";\r\n\r\nexport type MeasuredToken = {\r\n  token: Token;\r\n  rect: DOMRect;\r\n};\r\n\r\nfunction splitTokensByBr(tokens: Token[]): Token[][] {\r\n  const result: Token[][] = [];\r\n  let chunk: Token[] = [];\r\n  for (const token of tokens) {\r\n    if (token.type === \"br\") {\r\n      if (chunk.length) result.push(chunk);\r\n      result.push([token]);\r\n      chunk = [];\r\n    } else {\r\n      chunk.push(token);\r\n    }\r\n  }\r\n  if (chunk.length) result.push(chunk);\r\n  return result;\r\n}\r\n\r\nexport function LayoutMeasurer(\r\n  tokens: Token[],\r\n  container: HTMLElement,\r\n  fontMetrics: FontMetrics\r\n): MeasuredToken[] {\r\n  const wrapper = document.createElement(\"div\");\r\n  const computed = window.getComputedStyle(container);\r\n\r\n  wrapper.style.position = \"absolute\";\r\n  wrapper.style.visibility = \"hidden\";\r\n  wrapper.style.pointerEvents = \"none\";\r\n  wrapper.style.width = container.clientWidth + \"px\";\r\n  wrapper.style.padding = computed.padding;\r\n  wrapper.style.font = computed.font;\r\n  wrapper.style.letterSpacing = computed.letterSpacing;\r\n  wrapper.style.lineHeight = computed.lineHeight;\r\n  wrapper.style.fontVariant = computed.fontVariant;\r\n  wrapper.style.fontStretch = computed.fontStretch;\r\n  wrapper.style.wordBreak = computed.wordBreak;\r\n  wrapper.style.wordWrap = computed.wordWrap;\r\n  wrapper.style.whiteSpace = computed.whiteSpace;\r\n\r\n  const spaceMeasurer = document.createElement(\"span\");\r\n  spaceMeasurer.textContent = \"\\u00a0\";\r\n  wrapper.appendChild(spaceMeasurer);\r\n  const spaceWidth = spaceMeasurer.getBoundingClientRect().width;\r\n  wrapper.removeChild(spaceMeasurer);\r\n  wrapper.style.width = container.clientWidth + spaceWidth + \"px\";\r\n  wrapper.style.boxSizing = \"border-box\";\r\n\r\n  container.appendChild(wrapper);\r\n\r\n  const measured: MeasuredToken[] = [];\r\n  const chunks = splitTokensByBr(tokens);\r\n\r\n  let isAfterElement = false;\r\n  let lastTokenWasSpace = false;\r\n  let prevMeasuredWasText = false;\r\n\r\n  for (const chunk of chunks) {\r\n    if (chunk.length === 1 && chunk[0].type === \"br\") {\r\n      measured.push({ token: chunk[0], rect: new DOMRect(0, 0, 0, 0) });\r\n      continue;\r\n    }\r\n    if (chunk.length === 0) continue;\r\n\r\n    wrapper.innerHTML = \"\";\r\n\r\n    const wordSpans: HTMLSpanElement[] = [];\r\n    const tokenInfo: Array<{\r\n      token: Token;\r\n      wordIndex?: number;\r\n      hadLeadingSpace?: boolean;\r\n      hadTrailingSpace?: boolean;\r\n    }> = [];\r\n\r\n    chunk.forEach((token) => {\r\n      switch (token.type) {\r\n        case \"text\": {\r\n          const raw = token.content;\r\n          const hadLeadingSpace = /^\\s/.test(raw);\r\n          const hadTrailingSpace = /\\s$/.test(raw);\r\n\r\n          const words = raw\r\n            .trim()\r\n            .split(/\\s+/)\r\n            .filter((w) => w.length > 0);\r\n\r\n          words.forEach((word, wIdx) => {\r\n            const span = document.createElement(\"span\");\r\n            span.style.display = \"inline-block\";\r\n            span.textContent = word;\r\n            wrapper.appendChild(span);\r\n\r\n            if (wIdx < words.length - 1 || hadTrailingSpace) {\r\n              wrapper.appendChild(document.createTextNode(\" \"));\r\n            }\r\n\r\n            wordSpans.push(span);\r\n            tokenInfo.push({\r\n              token: {\r\n                type: \"text\",\r\n                id: \"\",\r\n                node: token.node,\r\n                content: word,\r\n                meta: {\r\n                  ...(token.meta || {}),\r\n                  joinPrev:\r\n                    wIdx === 0\r\n                      ? !hadLeadingSpace && !lastTokenWasSpace && prevMeasuredWasText\r\n                      : false,\r\n                },\r\n              },\r\n              wordIndex: wordSpans.length - 1,\r\n              hadLeadingSpace,\r\n              hadTrailingSpace,\r\n            });\r\n          });\r\n\r\n          lastTokenWasSpace = hadTrailingSpace;\r\n          prevMeasuredWasText = true;\r\n          break;\r\n        }\r\n\r\n        case \"element\": {\r\n          const node = token.node.cloneNode(true);\r\n          const span = document.createElement(\"span\");\r\n          span.style.display = \"inline-block\";\r\n          span.appendChild(node);\r\n          wrapper.appendChild(span);\r\n          wordSpans.push(span);\r\n          tokenInfo.push({ token, wordIndex: wordSpans.length - 1 });\r\n          isAfterElement = true;\r\n          prevMeasuredWasText = false;\r\n          lastTokenWasSpace = false;\r\n          break;\r\n        }\r\n\r\n        case \"space\":\r\n          lastTokenWasSpace = true;\r\n          break;\r\n\r\n        case \"other\":\r\n          prevMeasuredWasText = false;\r\n          lastTokenWasSpace = false;\r\n          break;\r\n      }\r\n    });\r\n\r\n    wrapper.offsetHeight;\r\n\r\n    tokenInfo.forEach((info, idx) => {\r\n      if (info.wordIndex !== undefined) {\r\n        const span = wordSpans[info.wordIndex];\r\n        const domRect = span.getBoundingClientRect();\r\n\r\n        let rect: DOMRect;\r\n        if (info.token.type === \"text\") {\r\n          const accurateWidth = fontMetrics.measureWord(info.token.content);\r\n          rect = new DOMRect(domRect.x, domRect.y, accurateWidth, domRect.height);\r\n        } else {\r\n          rect = domRect;\r\n        }\r\n\r\n        const measuredToken: MeasuredToken = {\r\n          token: info.token,\r\n          rect: rect,\r\n        };\r\n\r\n        if (isAfterElement && info.token.type === \"text\") {\r\n          isAfterElement = false;\r\n          measuredToken.token.meta = {\r\n            ...(measuredToken.token.meta || {}),\r\n            isAfterElement: true,\r\n          };\r\n        }\r\n\r\n        measured.push(measuredToken);\r\n\r\n        if (info.token.type === \"element\") {\r\n          const prev = measured[measured.length - 2];\r\n          if (prev?.token.type === \"text\") {\r\n            prev.token.meta = { ...(prev.token.meta || {}), isBeforeElement: true };\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  container.removeChild(wrapper);\r\n  return measured;\r\n}\r\n","import { MeasuredToken } from \"./LayoutMeasurer\";\r\nimport { Token } from \"./BuildTokens\";\r\nimport { FontMetrics } from \"./CanvasKerningApplier\";\r\n\r\nexport type ProcessedChar = {\r\n  char: string;\r\n  rect: DOMRect;\r\n  token: Token;\r\n  charIndexGlobal: number;\r\n  charIndexInLine: number;\r\n  charIndexInWord: number;\r\n  isBeforeElement?: boolean;\r\n  isAfterElement?: boolean;\r\n};\r\n\r\nexport type ProcessedWord = {\r\n  chars: ProcessedChar[];\r\n  rect: DOMRect;\r\n  wordIndexGlobal: number;\r\n  wordIndexInLine: number;\r\n  isBeforeElement?: boolean;\r\n  isAfterElement?: boolean;\r\n};\r\n\r\nexport type LayoutLine = {\r\n  words: ProcessedWord[];\r\n  rect: DOMRect;\r\n  lineIndex: number;\r\n  isBeforeElement?: boolean;\r\n  isAfterElement?: boolean;\r\n};\r\n\r\nconst LINE_TOLERANCE = 5;\r\n\r\nexport function SplitMeasuredTokens(\r\n  measured: MeasuredToken[],\r\n  container: HTMLElement,\r\n  fontMetrics: FontMetrics\r\n): LayoutLine[] {\r\n  const lines: LayoutLine[] = [];\r\n  let currentLine: LayoutLine | null = null;\r\n  let y = 0;\r\n\r\n  let charIndexGlobal = 0;\r\n  let wordIndexGlobal = 0;\r\n\r\n  measured.forEach((mt) => {\r\n    const token = mt.token;\r\n    const isBefore = token.meta?.isBeforeElement ?? false;\r\n    const isAfter = token.meta?.isAfterElement ?? false;\r\n\r\n    if (token.type === \"br\") {\r\n      currentLine = null;\r\n      return;\r\n    }\r\n\r\n    if (token.type === \"text\") {\r\n      const wordText = token.content;\r\n      const splitClass: string[] = (token.meta?.splitClass as string[]) ?? [];\r\n      const joinPrev = !!token.meta?.joinPrev;\r\n\r\n      const chars: ProcessedChar[] = [];\r\n      let currentXInWord = 0;\r\n\r\n      for (let i = 0; i < wordText.length; i++) {\r\n        const ch = wordText[i];\r\n        const prev = i > 0 ? wordText[i - 1] : null;\r\n\r\n        const charWidth = fontMetrics.getCharWidth(ch);\r\n        const kerning = prev ? fontMetrics.getKerning(prev, ch) : 0;\r\n\r\n        currentXInWord += kerning;\r\n\r\n        const charRect = new DOMRect(\r\n          mt.rect.left + currentXInWord,\r\n          mt.rect.top,\r\n          charWidth,\r\n          mt.rect.height\r\n        );\r\n\r\n        const pc: ProcessedChar = {\r\n          char: ch,\r\n          rect: charRect,\r\n          token,\r\n          charIndexInWord: i,\r\n          charIndexInLine: 0,\r\n          charIndexGlobal: charIndexGlobal++,\r\n        };\r\n\r\n        if (splitClass.length) (pc as any).splitClass = splitClass;\r\n\r\n        chars.push(pc);\r\n        currentXInWord += charWidth;\r\n      }\r\n\r\n      if (chars.length > 0) {\r\n        const lastChar = chars[chars.length - 1];\r\n        if (isBefore) lastChar.isBeforeElement = true;\r\n        if (isAfter) lastChar.isAfterElement = true;\r\n      }\r\n\r\n      const currentY = Math.round(mt.rect.top);\r\n      const baselineY = Math.round(y);\r\n      const isNewLine = !currentLine || Math.abs(currentY - baselineY) > LINE_TOLERANCE;\r\n      if (isNewLine) {\r\n        y = currentY;\r\n        currentLine = { words: [], rect: mt.rect, lineIndex: lines.length };\r\n        lines.push(currentLine);\r\n      }\r\n      if (!currentLine) return;\r\n\r\n      if (joinPrev && currentLine.words.length > 0) {\r\n        const target = currentLine.words[currentLine.words.length - 1];\r\n\r\n        const charsBeforeAll = currentLine.words.reduce((acc, w) => acc + w.chars.length, 0);\r\n        const baseInWord = target.chars.length;\r\n\r\n        chars.forEach((c, i) => {\r\n          c.charIndexInLine = charsBeforeAll + i;\r\n          c.charIndexInWord = baseInWord + i;\r\n        });\r\n\r\n        target.chars.push(...chars);\r\n        target.rect = mergeRects([target.rect, mt.rect]);\r\n        currentLine.rect = mergeRects(currentLine.words.map((w) => w.rect));\r\n        if (isBefore) target.isBeforeElement = true;\r\n        if (isAfter) target.isAfterElement = true;\r\n        return;\r\n      }\r\n\r\n      const wordIndexInLine = currentLine.words.length;\r\n      const charsBefore = currentLine.words.reduce((acc, w) => acc + w.chars.length, 0);\r\n      chars.forEach((c, i) => (c.charIndexInLine = charsBefore + i));\r\n\r\n      const processedWord: ProcessedWord = {\r\n        chars,\r\n        rect: mt.rect,\r\n        wordIndexGlobal: wordIndexGlobal++,\r\n        wordIndexInLine,\r\n        isBeforeElement: isBefore,\r\n        isAfterElement: isAfter,\r\n      };\r\n\r\n      currentLine.words.push(processedWord);\r\n      currentLine.rect = mergeRects(currentLine.words.map((w) => w.rect));\r\n      if (isBefore) currentLine.isBeforeElement = true;\r\n      if (isAfter) currentLine.isAfterElement = true;\r\n      return;\r\n    }\r\n\r\n    if (token.type === \"element\") {\r\n      const rect = mt.rect;\r\n      const currentY = Math.round(rect.top);\r\n      const baselineY = Math.round(y);\r\n      const isNewLine = !currentLine || Math.abs(currentY - baselineY) > LINE_TOLERANCE;\r\n\r\n      if (isNewLine) {\r\n        y = currentY;\r\n        currentLine = { words: [], rect, lineIndex: lines.length };\r\n        lines.push(currentLine);\r\n      }\r\n      if (!currentLine) return;\r\n\r\n      const wordIndexInLine = currentLine.words.length;\r\n      const charsBefore = currentLine.words.reduce((acc, w) => acc + w.chars.length, 0);\r\n\r\n      const chars: ProcessedChar[] = [\r\n        {\r\n          char: \"[E]\",\r\n          rect,\r\n          token,\r\n          charIndexInWord: 0,\r\n          charIndexInLine: charsBefore,\r\n          charIndexGlobal: charIndexGlobal++,\r\n        },\r\n      ];\r\n\r\n      const processedWord: ProcessedWord = {\r\n        chars,\r\n        rect,\r\n        wordIndexGlobal: wordIndexGlobal++,\r\n        wordIndexInLine,\r\n        isBeforeElement: false,\r\n        isAfterElement: false,\r\n      };\r\n\r\n      currentLine.words.push(processedWord);\r\n      currentLine.rect = mergeRects(currentLine.words.map((w) => w.rect));\r\n    }\r\n  });\r\n\r\n  return lines;\r\n}\r\n\r\nfunction mergeRects(rects: DOMRect[]): DOMRect {\r\n  if (rects.length === 0) return new DOMRect(0, 0, 0, 0);\r\n  const left = Math.min(...rects.map((r) => r.left));\r\n  const top = Math.min(...rects.map((r) => r.top));\r\n  const right = Math.max(...rects.map((r) => r.right));\r\n  const bottom = Math.max(...rects.map((r) => r.bottom));\r\n  return new DOMRect(left, top, right - left, bottom - top);\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { CalculatedValue } from \"../../models/text/CalculatedValue\";\r\nimport { ISplitOptionItem } from \"../../models/text/ISplitOptionItem\";\r\nimport { ISplitOptions } from \"../../models/text/ISplitOptions\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { BuildDOMTree } from \"../../utils/text/BuildDOMTree\";\r\nimport { BuildTokens } from \"../../utils/text/BuildTokens\";\r\nimport { FontMetrics } from \"../../utils/text/CanvasKerningApplier\";\r\nimport { LayoutMeasurer } from \"../../utils/text/LayoutMeasurer\";\r\nimport {\r\n  LayoutLine,\r\n  ProcessedChar,\r\n  ProcessedWord,\r\n  SplitMeasuredTokens,\r\n} from \"../../utils/text/SplitMeasuredTokens\";\r\n\r\n/**\r\n * StringSplit module: splits text into lines, words, chars,\r\n * computes alignment/random values, and applies CSS vars.\r\n */\r\nexport class StringSplit extends StringModule {\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"split\";\r\n    this.permissions.mobile.rebuild.height = false;\r\n    this.permissions.mobile.rebuild.width = false;\r\n    //this.permissions.mobile.rebuild.scrollHeight = false;\r\n  }\r\n\r\n  onResizeWidth(): void {\r\n    this.objectsOnPage.forEach((object) => {\r\n      this.onObjectConnected(object);\r\n    });\r\n  }\r\n\r\n  onObjectConnected(object: StringObject): void {\r\n    const element = object.htmlElement;\r\n    if (!element) return;\r\n\r\n    const isAlreadySplit = element.classList.contains(\"-splitted\");\r\n    let originalHtml = element.getAttribute(\"string-split-original\");\r\n\r\n    if (!isAlreadySplit || originalHtml === null) {\r\n      originalHtml = this.escapeAttribute(element.innerHTML);\r\n      element.setAttribute(\"string-split-original\", originalHtml);\r\n      element.classList.add(\"-splitted\");\r\n    }\r\n\r\n    object.htmlElement.innerHTML = originalHtml;\r\n    const attr =\r\n      element.getAttribute(\"string-split\") ?? element.getAttribute(\"data-string-split\") ?? \"\";\r\n    const options: ISplitOptions = this.tools.optionsParser.process({\r\n      attributeValue: attr,\r\n    });\r\n    const { fragment, result, extraProps } = this.split(element, options);\r\n    object.setProperty(\"nodes\", fragment.childNodes);\r\n    element.setAttribute(\"aria-label\", originalHtml);\r\n    element.innerHTML = \"\";\r\n    element.appendChild(result);\r\n\r\n    extraProps.forEach((value: string, key: string) => {\r\n      element.style.setProperty(key, value);\r\n    });\r\n\r\n    const restoreAfter = element.getAttribute(\"string-split-restore-after\");\r\n    if (restoreAfter && !isNaN(Number(restoreAfter))) {\r\n      setTimeout(() => {\r\n        element.innerHTML = originalHtml!;\r\n        element.classList.add(\"-restored\");\r\n      }, Number(restoreAfter));\r\n    }\r\n  }\r\n\r\n  public split(element: HTMLElement, options: ISplitOptions) {\r\n    const fontMetrics = new FontMetrics(element);\r\n    const frag = document.createDocumentFragment();\r\n    element.childNodes.forEach((ch) => frag.appendChild(ch.cloneNode(true)));\r\n    const tokens = BuildTokens(frag.childNodes as NodeListOf<ChildNode>);\r\n    const measured = LayoutMeasurer(tokens, element, fontMetrics);\r\n    const layoutLines: LayoutLine[] = SplitMeasuredTokens(measured, element, fontMetrics);\r\n    this.applyCalculatedValues(layoutLines, options);\r\n    const dom = BuildDOMTree(layoutLines, options, fontMetrics);\r\n    return {\r\n      fragment: frag,\r\n      result: dom.fragment,\r\n      extraProps: dom.extraProps,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Computes a numeric value based on the provided split option, index, and total count.\r\n   *\r\n   * @param opt - The split option item containing alignment and optional random range.\r\n   * @param index - The current index in the sequence.\r\n   * @param total - The total number of items in the sequence.\r\n   * @returns A computed numeric value based on the alignment strategy:\r\n   *          - \"random\": A random value within the specified range or default range.\r\n   *          - \"start\": The current index.\r\n   *          - \"end\": The reverse index from the end of the sequence.\r\n   *          - \"center\": The distance from the center index.\r\n   *          - Default: The current index.\r\n   */\r\n  private computeValue(opt: ISplitOptionItem, index: number, total: number): number {\r\n    if (opt.align.startsWith(\"random\")) {\r\n      const min = opt.random?.min ?? 0;\r\n      const max = opt.random?.max ?? total - 1;\r\n      return Math.floor(Math.random() * (max - min + 1)) + min;\r\n    }\r\n    switch (opt.align) {\r\n      case \"start\":\r\n        return index;\r\n      case \"end\":\r\n        return total - index - 1;\r\n      case \"center\": {\r\n        const centerIdx = Math.floor((total - 1) / 2);\r\n        return Math.abs(index - centerIdx);\r\n      }\r\n      default:\r\n        return index;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Applies calculated values to the provided layout lines and their components (words and characters)\r\n   * based on the given options. This method computes and assigns various calculated values\r\n   * (e.g., alignment and value) to lines, words, and characters, depending on the specified options.\r\n   *\r\n   * @param lines - An array of `LayoutLine` objects representing the lines of text to process.\r\n   * @param options - An `ISplitOptions` object specifying the calculation options for lines, words, and characters.\r\n   *\r\n   * The `options` parameter can include the following properties:\r\n   * - `line`: An array of options for calculating values at the line level.\r\n   * - `word`: An array of options for calculating values at the word level.\r\n   * - `wordLine`: An array of options for calculating values at the word level relative to the line.\r\n   * - `char`: An array of options for calculating values at the character level.\r\n   * - `charWord`: An array of options for calculating values at the character level relative to the word.\r\n   * - `charLine`: An array of options for calculating values at the character level relative to the line.\r\n   *\r\n   * Each calculated value is assigned to the corresponding `calculatedValues` property of the line, word, or character.\r\n   * The method ensures that all specified options are processed and the calculated values are appended accordingly.\r\n   */\r\n  private applyCalculatedValues(lines: LayoutLine[], options: ISplitOptions): void {\r\n    const countChars = (ln: LayoutLine) =>\r\n      ln.words.reduce((acc, w: ProcessedWord) => acc + w.chars.length, 0);\r\n\r\n    const totalWords = lines.reduce((acc, l) => acc + l.words.length, 0);\r\n    const totalCharsGlobal = lines.reduce(\r\n      (acc, l) => acc + l.words.reduce((acc2, w) => acc2 + w.chars.length, 0),\r\n      0\r\n    );\r\n\r\n    lines.forEach((line, li) => {\r\n      if (options.line) {\r\n        (line as any).calculatedValues = options.line.map(\r\n          (opt) =>\r\n            ({\r\n              type: \"line\",\r\n              align: opt.align,\r\n              value: this.computeValue(opt, li, lines.length),\r\n            } as CalculatedValue)\r\n        );\r\n      }\r\n\r\n      line.words.forEach((word: ProcessedWord, wi) => {\r\n        if (options.word) {\r\n          (word as any).calculatedValues = options.word.map(\r\n            (opt) =>\r\n              ({\r\n                type: \"word\",\r\n                align: opt.align,\r\n                value: this.computeValue(opt, word.wordIndexGlobal, totalWords),\r\n              } as CalculatedValue)\r\n          );\r\n        }\r\n\r\n        if (options.wordLine) {\r\n          (word as any).calculatedValues ??= [];\r\n          (word as any).calculatedValues.push(\r\n            ...options.wordLine.map(\r\n              (opt) =>\r\n                ({\r\n                  type: \"wordLine\",\r\n                  align: opt.align,\r\n                  value: this.computeValue(opt, word.wordIndexInLine, line.words.length),\r\n                } as CalculatedValue)\r\n            )\r\n          );\r\n        }\r\n\r\n        const totalCharsInLine = countChars(line);\r\n\r\n        word.chars.forEach((char: ProcessedChar) => {\r\n          const cvs: CalculatedValue[] = [];\r\n\r\n          if (options.char) {\r\n            cvs.push(\r\n              ...options.char.map(\r\n                (opt) =>\r\n                  ({\r\n                    type: \"char\",\r\n                    align: opt.align,\r\n                    value: this.computeValue(opt, char.charIndexGlobal, totalCharsGlobal),\r\n                  } as CalculatedValue)\r\n              )\r\n            );\r\n          }\r\n\r\n          if (options.charWord) {\r\n            cvs.push(\r\n              ...options.charWord.map(\r\n                (opt) =>\r\n                  ({\r\n                    type: \"charWord\",\r\n                    align: opt.align,\r\n                    value: this.computeValue(opt, char.charIndexInWord, word.chars.length),\r\n                  } as CalculatedValue)\r\n              )\r\n            );\r\n          }\r\n\r\n          if (options.charLine) {\r\n            cvs.push(\r\n              ...options.charLine.map(\r\n                (opt) =>\r\n                  ({\r\n                    type: \"charLine\",\r\n                    align: opt.align,\r\n                    value: this.computeValue(opt, char.charIndexInLine, totalCharsInLine),\r\n                  } as CalculatedValue)\r\n              )\r\n            );\r\n          }\r\n\r\n          (char as any).calculatedValues = cvs;\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Escapes the `src` attribute in a given string by removing the quotes around the URL.\r\n   *\r\n   * This method searches for occurrences of `src=\"URL\"` where `URL` is an HTTP or HTTPS link,\r\n   * and replaces it with `src=URL` (removing the quotes around the URL).\r\n   *\r\n   * @param str - The input string containing the `src` attributes to be escaped.\r\n   * @returns The modified string with escaped `src` attributes.\r\n   */\r\n  private escapeAttribute(str: string): string {\r\n    return str.replace(/src=\"(https?:\\/\\/[^\"\\s]+)\"/g, \"src=$1\");\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\"\r\nimport { StringData } from \"../../core/StringData\"\r\nimport { StringModule } from \"../../core/StringModule\"\r\n\r\n/**\r\n * Visual tracker that plots scroll displacement (velocity) in real time.\r\n * Useful for debugging and tuning smoothing behavior.\r\n */\r\nexport class StringDelayLerpTracker extends StringModule {\r\n  private canvas!: HTMLCanvasElement\r\n  private context!: CanvasRenderingContext2D\r\n  private history: number[] = []\r\n\r\n  private maxPoints = 0\r\n  private height = 0\r\n  private value = 0\r\n  private target = 0\r\n\r\n  constructor(context: StringContext) {\r\n    super(context)\r\n    this._type = 2\r\n  }\r\n\r\n  /**\r\n   * Called when the module starts — sets up canvas.\r\n   */\r\n  onInit(): void {\r\n    this.initCanvas()\r\n    this.maxPoints = this.canvas.width\r\n  }\r\n\r\n  /**\r\n   * Called on scroll — stores current displacement and redraws.\r\n   */\r\n  onScroll(data: StringData): void {\r\n    const d = Math.abs(data.scroll.displacement)\r\n    this.value = d\r\n    this.history.push(d)\r\n\r\n    if (this.history.length > this.maxPoints) {\r\n      this.history.shift()\r\n    }\r\n\r\n    this.draw()\r\n  }\r\n\r\n  /**\r\n   * Draws the displacement graph to canvas.\r\n   */\r\n  private draw(): void {\r\n    const ctx = this.context\r\n    const w = this.canvas.width\r\n    const h = this.canvas.height\r\n\r\n    ctx.clearRect(0, 0, w, h)\r\n\r\n    ctx.strokeStyle = \"red\"\r\n    ctx.lineWidth = 2\r\n    ctx.beginPath()\r\n\r\n    this.history.forEach((val, i) => {\r\n      const x = i\r\n      const y = h - val * this.height\r\n      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y)\r\n    })\r\n\r\n    ctx.stroke()\r\n  }\r\n\r\n  /**\r\n   * Creates and styles the tracking canvas.\r\n   */\r\n  private initCanvas(): void {\r\n    const canvas = document.createElement(\"canvas\")\r\n    const width = window.innerWidth * 0.5\r\n    this.height = window.innerHeight / 15 - 20\r\n\r\n    canvas.width = width\r\n    canvas.height = this.height\r\n\r\n    Object.assign(canvas.style, {\r\n      position: \"fixed\",\r\n      bottom: `${window.innerHeight / 20 + 10}px`,\r\n      left: \"50%\",\r\n      transform: \"translateX(-50%)\",\r\n      backgroundColor: \"#000000\",\r\n      border: \"1px solid rgba(255, 255, 255, 0.2)\",\r\n      zIndex: \"1000\",\r\n      pointerEvents: \"none\",\r\n    })\r\n\r\n    this.canvas = canvas\r\n    this.context = canvas.getContext(\"2d\")!\r\n    document.body.appendChild(canvas)\r\n  }\r\n\r\n  /**\r\n   * Optional method to update external comparison target.\r\n   */\r\n  public setTarget(position: number): void {\r\n    this.target = position\r\n  }\r\n\r\n  /**\r\n   * Removes the canvas from DOM and resets.\r\n   */\r\n  public clear(): void {\r\n    this.canvas.remove()\r\n    this.history = []\r\n  }\r\n}\r\n","import { StringData } from \"../..\";\r\nimport { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\n\r\n/** Attribute selector for FPS tracker elements */\r\nconst ATTR_FPS = \"data-fps\";\r\n\r\n/**\r\n * FPS Tracker Module.\r\n * Broadcasts frame rate to elements with `data-fps` attribute.\r\n * Also creates an optional debug display element.\r\n */\r\nexport class StringFPSTracker extends StringModule {\r\n  private displayElement: HTMLDivElement | null = null;\r\n  private intervalId: number = 0;\r\n  private frameCount = 0;\r\n\r\n  /** Cached elements with data-fps attribute */\r\n  private fpsElements: Set<HTMLElement> = new Set();\r\n\r\n  /** MutationObserver for DOM changes */\r\n  private observer: MutationObserver | null = null;\r\n\r\n  /** Last known FPS to avoid redundant updates */\r\n  private lastFps = -1;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this._type = 2;\r\n  }\r\n\r\n  /**\r\n   * Initializes the visual FPS counter, scans for elements, and starts interval.\r\n   */\r\n  onInit(): void {\r\n    if (this.data.system.fpsTracker) {\r\n      this.createDisplayElement();\r\n    }\r\n\r\n    // Listen for visibility toggle\r\n    this.events.on(\"tracker:fps:visible\", this.onVisibilityChange.bind(this));\r\n\r\n    this.scanElements();\r\n    this.observeDOM();\r\n\r\n    this.intervalId = window.setInterval(() => {\r\n      this.updateFPS(this.frameCount);\r\n      this.frameCount = 0;\r\n    }, 1000);\r\n  }\r\n\r\n  /**\r\n   * Increments the frame counter each frame.\r\n   */\r\n  onFrame(_data: StringData): void {\r\n    this.frameCount++;\r\n  }\r\n\r\n  /**\r\n   * Cleans up DOM, observer, and interval.\r\n   */\r\n  destroy(): void {\r\n    clearInterval(this.intervalId);\r\n    this.observer?.disconnect();\r\n    this.removeDisplayElement();\r\n    this.fpsElements.clear();\r\n  }\r\n\r\n  /**\r\n   * Handles visibility toggle from external API.\r\n   */\r\n  private onVisibilityChange(visible: boolean): void {\r\n    if (visible) {\r\n      this.createDisplayElement();\r\n    } else {\r\n      this.removeDisplayElement();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes the display element and its styles.\r\n   */\r\n  private removeDisplayElement(): void {\r\n    this.displayElement?.remove();\r\n    this.displayElement = null;\r\n  }\r\n\r\n  /**\r\n   * Updates all tracked elements with current FPS.\r\n   */\r\n  private updateFPS(fps: number): void {\r\n    if (fps === this.lastFps) return;\r\n    this.lastFps = fps;\r\n\r\n    const fpsStr = String(fps);\r\n\r\n    // Update cached elements\r\n    for (const el of this.fpsElements) {\r\n      if (el.isConnected) {\r\n        el.setAttribute(ATTR_FPS, fpsStr);\r\n      }\r\n    }\r\n\r\n    // Update debug display\r\n    if (this.displayElement) {\r\n      this.displayElement.setAttribute(ATTR_FPS, fpsStr);\r\n    }\r\n\r\n    this.events.emit(\"fps\", fps);\r\n  }\r\n\r\n  /**\r\n   * Scans document for elements with data-fps attribute.\r\n   */\r\n  private scanElements(): void {\r\n    this.fpsElements.clear();\r\n\r\n    document.querySelectorAll<HTMLElement>(`[${ATTR_FPS}]`).forEach((el) => {\r\n      if (el !== this.displayElement) {\r\n        this.fpsElements.add(el);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Observes DOM for added/removed elements with data-fps attribute.\r\n   */\r\n  private observeDOM(): void {\r\n    this.observer = new MutationObserver((mutations) => {\r\n      let needsRescan = false;\r\n\r\n      for (const mutation of mutations) {\r\n        // Check added nodes\r\n        for (const node of mutation.addedNodes) {\r\n          if (node.nodeType === Node.ELEMENT_NODE) {\r\n            const el = node as HTMLElement;\r\n            if (el.hasAttribute(ATTR_FPS)) needsRescan = true;\r\n            if (el.querySelector(`[${ATTR_FPS}]`)) needsRescan = true;\r\n          }\r\n        }\r\n\r\n        // Check removed nodes - clean from cache\r\n        for (const node of mutation.removedNodes) {\r\n          if (node.nodeType === Node.ELEMENT_NODE) {\r\n            this.fpsElements.delete(node as HTMLElement);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (needsRescan) {\r\n        this.scanElements();\r\n      }\r\n    });\r\n\r\n    this.observer.observe(document.body, {\r\n      childList: true,\r\n      subtree: true,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates and styles the floating FPS display.\r\n   */\r\n  private createDisplayElement(): void {\r\n    if (this.displayElement) return;\r\n\r\n    const el = document.createElement(\"div\");\r\n\r\n    Object.assign(el.style, {\r\n      position: \"fixed\",\r\n      bottom: \"10px\",\r\n      right: \"10px\",\r\n      backgroundColor: \"#000\",\r\n      color: \"#fff\",\r\n      padding: \"4px 8px\",\r\n      fontSize: \"12px\",\r\n      fontFamily: \"monospace\",\r\n      border: \"1px solid rgba(255,255,255,0.2)\",\r\n      zIndex: \"1000\",\r\n      pointerEvents: \"none\",\r\n    });\r\n\r\n    el.setAttribute(ATTR_FPS, \"0\");\r\n    document.body.appendChild(el);\r\n\r\n    // Inject dynamic CSS\r\n    const styleId = \"string-fps-tracker-style\";\r\n    if (!document.getElementById(styleId)) {\r\n      const style = document.createElement(\"style\");\r\n      style.id = styleId;\r\n      style.innerHTML = `\r\n        [${ATTR_FPS}]::before {\r\n          content: 'FPS: ' attr(${ATTR_FPS});\r\n        }\r\n      `;\r\n      document.head.appendChild(style);\r\n    }\r\n\r\n    this.displayElement = el;\r\n  }\r\n}\r\n","import { StringData } from \"../..\"\r\nimport { StringContext } from \"../../core/StringContext\"\r\nimport { StringModule } from \"../../core/StringModule\"\r\n\r\n/**\r\n * Visual tracker that plots lerped scroll velocity (v) in real time.\r\n * Useful for analyzing smooth scroll interpolation behavior.\r\n */\r\nexport class StringLerpTracker extends StringModule {\r\n  private canvas!: HTMLCanvasElement\r\n  private context!: CanvasRenderingContext2D\r\n  private history: number[] = []\r\n\r\n  private maxPoints = 0\r\n  private canvasHeight = 0\r\n  private currentValue = 0\r\n  private targetValue = 0\r\n\r\n  constructor(context: StringContext) {\r\n    super(context)\r\n    this._type = 2\r\n  }\r\n\r\n  /**\r\n   * Called on start — sets up canvas overlay.\r\n   */\r\n  onInit(): void {\r\n    this.initCanvas()\r\n    this.maxPoints = this.canvas.width\r\n  }\r\n\r\n  /**\r\n   * Called on scroll — reads smoothed scroll velocity (v).\r\n   */\r\n  onScroll(data: StringData): void {\r\n    const v = Math.abs(data.scroll.displacement)\r\n    this.currentValue = v\r\n    this.history.push(v)\r\n\r\n    if (this.history.length > this.maxPoints) {\r\n      this.history.shift()\r\n    }\r\n\r\n    this.draw()\r\n  }\r\n\r\n  /**\r\n   * Draws the current graph line based on v-history.\r\n   */\r\n  private draw(): void {\r\n    const ctx = this.context\r\n    const w = this.canvas.width\r\n    const h = this.canvas.height\r\n\r\n    ctx.clearRect(0, 0, w, h)\r\n\r\n    ctx.strokeStyle = \"#007bff\"\r\n    ctx.lineWidth = 2\r\n    ctx.beginPath()\r\n\r\n    this.history.forEach((val, i) => {\r\n      const x = i\r\n      const y = h - val / 2\r\n      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y)\r\n    })\r\n\r\n    ctx.stroke()\r\n  }\r\n\r\n  /**\r\n   * Creates the canvas overlay and applies style.\r\n   */\r\n  private initCanvas(): void {\r\n    this.canvas = document.createElement(\"canvas\")\r\n    this.canvasHeight = window.innerHeight / 15 - 20\r\n    this.canvas.width = window.innerWidth * 0.5\r\n    this.canvas.height = this.canvasHeight\r\n\r\n    Object.assign(this.canvas.style, {\r\n      position: \"fixed\",\r\n      bottom: \"10px\",\r\n      left: \"50%\",\r\n      transform: \"translateX(-50%)\",\r\n      backgroundColor: \"#000\",\r\n      border: \"1px solid rgba(255,255,255,0.2)\",\r\n      zIndex: \"1000\",\r\n      pointerEvents: \"none\",\r\n    })\r\n\r\n    this.context = this.canvas.getContext(\"2d\")!\r\n    document.body.appendChild(this.canvas)\r\n  }\r\n\r\n  /**\r\n   * Optional external target value for debugging.\r\n   */\r\n  public setTarget(position: number): void {\r\n    this.targetValue = position\r\n  }\r\n\r\n  /**\r\n   * Removes canvas from DOM and clears history.\r\n   */\r\n  public clear(): void {\r\n    this.canvas.remove()\r\n    this.history = []\r\n  }\r\n}\r\n","import { StringData } from \"../..\";\r\nimport { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\n\r\n/** Attribute selectors for position tracker elements */\r\nconst ATTR_VAL = \"data-val\";\r\nconst ATTR_VAL_PCT = \"data-val-pct\";\r\nconst ATTR_DIR = \"data-dir\";\r\n\r\n/**\r\n * Tracker module that broadcasts scroll position to elements with data attributes.\r\n * Elements with `data-val`, `data-val-pct`, or `data-dir` will receive updates.\r\n * Also creates an optional debug display element.\r\n */\r\nexport class StringPositionTracker extends StringModule {\r\n  private displayElement: HTMLDivElement | null = null;\r\n\r\n  /** Cached elements by attribute type */\r\n  private valElements: Set<HTMLElement> = new Set();\r\n  private valPctElements: Set<HTMLElement> = new Set();\r\n  private dirElements: Set<HTMLElement> = new Set();\r\n\r\n  /** MutationObserver for DOM changes */\r\n  private observer: MutationObserver | null = null;\r\n\r\n  /** Last known values to avoid redundant updates */\r\n  private lastVal = -1;\r\n  private lastValPct = -1;\r\n  private lastDir = \"\";\r\n\r\n  /** Previous scroll position for direction detection */\r\n  private previousCurrent = 0;\r\n\r\n  /** Timeout for resetting direction to idle state */\r\n  private idleTimeout: ReturnType<typeof setTimeout> | null = null;\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this._type = 2;\r\n  }\r\n\r\n  /**\r\n   * Called on start — creates debug element and scans for tracked elements.\r\n   */\r\n  onInit(): void {\r\n    if (this.data.system.positionTracker) {\r\n      this.createDisplayElement();\r\n    }\r\n\r\n    // Listen for visibility toggle\r\n    this.events.on(\"tracker:position:visible\", this.onVisibilityChange.bind(this));\r\n\r\n    this.scanElements();\r\n    this.observeDOM();\r\n  }\r\n\r\n  /**\r\n   * Called on scroll — updates all tracked elements with position data.\r\n   */\r\n  onScroll(data: StringData): void {\r\n    const current = data.scroll.current;\r\n    const target = data.scroll.target;\r\n    const contentHeight = data.viewport.contentHeight;\r\n    const windowHeight = data.viewport.windowHeight;\r\n\r\n    const val = Math.round(current);\r\n    const maxScroll = Math.max(1, contentHeight - windowHeight);\r\n    const valPct = Math.round((current / maxScroll) * 100);\r\n\r\n    // Determine scroll direction\r\n    let direction: string;\r\n    if (current !== target) {\r\n      // Smooth scroll: compare current vs target (lerping)\r\n      direction = current < target ? \"↓\" : \"↑\";\r\n    } else if (current !== this.previousCurrent) {\r\n      // Default scroll: compare with previous position\r\n      direction = current > this.previousCurrent ? \"↓\" : \"↑\";\r\n    } else {\r\n      // No movement\r\n      direction = this.lastDir || \"•\";\r\n    }\r\n\r\n    this.previousCurrent = current;\r\n\r\n    // Reset idle timeout - will set direction to neutral after scroll stops\r\n    if (this.idleTimeout) {\r\n      clearTimeout(this.idleTimeout);\r\n    }\r\n    if (direction !== \"•\") {\r\n      this.idleTimeout = setTimeout(() => {\r\n        this.setDirection(\"•\");\r\n      }, 150);\r\n    }\r\n\r\n    // Update data-val elements\r\n    if (val !== this.lastVal) {\r\n      this.lastVal = val;\r\n      const valStr = String(val);\r\n      for (const el of this.valElements) {\r\n        if (el.isConnected) {\r\n          el.setAttribute(ATTR_VAL, valStr);\r\n        }\r\n      }\r\n      if (this.displayElement) {\r\n        this.displayElement.setAttribute(ATTR_VAL, valStr);\r\n      }\r\n    }\r\n\r\n    // Update data-val-pct elements\r\n    if (valPct !== this.lastValPct) {\r\n      this.lastValPct = valPct;\r\n      const pctStr = String(valPct);\r\n      for (const el of this.valPctElements) {\r\n        if (el.isConnected) {\r\n          el.setAttribute(ATTR_VAL_PCT, pctStr);\r\n        }\r\n      }\r\n      if (this.displayElement) {\r\n        this.displayElement.setAttribute(ATTR_VAL_PCT, pctStr);\r\n      }\r\n    }\r\n\r\n    // Update data-dir elements\r\n    this.setDirection(direction);\r\n\r\n    this.events.emit(\"scroll-position\", { val, valPct, direction });\r\n  }\r\n\r\n  /**\r\n   * Updates direction on all tracked elements.\r\n   */\r\n  private setDirection(direction: string): void {\r\n    if (direction === this.lastDir) return;\r\n    this.lastDir = direction;\r\n\r\n    for (const el of this.dirElements) {\r\n      if (el.isConnected) {\r\n        el.setAttribute(ATTR_DIR, direction);\r\n      }\r\n    }\r\n    if (this.displayElement) {\r\n      this.displayElement.setAttribute(ATTR_DIR, direction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleans up DOM observer and display element.\r\n   */\r\n  destroy(): void {\r\n    if (this.idleTimeout) {\r\n      clearTimeout(this.idleTimeout);\r\n    }\r\n    this.observer?.disconnect();\r\n    this.removeDisplayElement();\r\n    this.valElements.clear();\r\n    this.valPctElements.clear();\r\n    this.dirElements.clear();\r\n  }\r\n\r\n  /**\r\n   * Handles visibility toggle from external API.\r\n   */\r\n  private onVisibilityChange(visible: boolean): void {\r\n    if (visible) {\r\n      this.createDisplayElement();\r\n    } else {\r\n      this.removeDisplayElement();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes the display element.\r\n   */\r\n  private removeDisplayElement(): void {\r\n    this.displayElement?.remove();\r\n    this.displayElement = null;\r\n  }\r\n\r\n  /**\r\n   * Scans document for elements with tracking attributes.\r\n   */\r\n  private scanElements(): void {\r\n    this.valElements.clear();\r\n    this.valPctElements.clear();\r\n    this.dirElements.clear();\r\n\r\n    document.querySelectorAll<HTMLElement>(`[${ATTR_VAL}]`).forEach((el) => {\r\n      if (el !== this.displayElement) this.valElements.add(el);\r\n    });\r\n\r\n    document.querySelectorAll<HTMLElement>(`[${ATTR_VAL_PCT}]`).forEach((el) => {\r\n      if (el !== this.displayElement) this.valPctElements.add(el);\r\n    });\r\n\r\n    document.querySelectorAll<HTMLElement>(`[${ATTR_DIR}]`).forEach((el) => {\r\n      if (el !== this.displayElement) this.dirElements.add(el);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Observes DOM for added/removed elements with tracking attributes.\r\n   */\r\n  private observeDOM(): void {\r\n    this.observer = new MutationObserver((mutations) => {\r\n      let needsRescan = false;\r\n\r\n      for (const mutation of mutations) {\r\n        // Check added nodes\r\n        for (const node of mutation.addedNodes) {\r\n          if (node.nodeType === Node.ELEMENT_NODE) {\r\n            const el = node as HTMLElement;\r\n            if (this.hasTrackingAttr(el)) needsRescan = true;\r\n            // Check descendants\r\n            if (el.querySelector(`[${ATTR_VAL}],[${ATTR_VAL_PCT}],[${ATTR_DIR}]`)) {\r\n              needsRescan = true;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Check removed nodes - clean from cache\r\n        for (const node of mutation.removedNodes) {\r\n          if (node.nodeType === Node.ELEMENT_NODE) {\r\n            const el = node as HTMLElement;\r\n            this.valElements.delete(el);\r\n            this.valPctElements.delete(el);\r\n            this.dirElements.delete(el);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (needsRescan) {\r\n        this.scanElements();\r\n      }\r\n    });\r\n\r\n    this.observer.observe(document.body, {\r\n      childList: true,\r\n      subtree: true,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks if element has any tracking attribute.\r\n   */\r\n  private hasTrackingAttr(el: HTMLElement): boolean {\r\n    return el.hasAttribute(ATTR_VAL) || el.hasAttribute(ATTR_VAL_PCT) || el.hasAttribute(ATTR_DIR);\r\n  }\r\n\r\n  /**\r\n   * Creates and styles the floating position indicator.\r\n   */\r\n  private createDisplayElement(): void {\r\n    if (this.displayElement) return;\r\n\r\n    const el = document.createElement(\"div\");\r\n\r\n    Object.assign(el.style, {\r\n      position: \"fixed\",\r\n      bottom: \"10px\",\r\n      left: \"10px\",\r\n      backgroundColor: \"#000\",\r\n      color: \"#fff\",\r\n      border: \"1px solid rgba(255,255,255,0.2)\",\r\n      padding: \"5px 8px\",\r\n      fontSize: \"12px\",\r\n      fontFamily: \"monospace\",\r\n      zIndex: \"1000\",\r\n      pointerEvents: \"none\",\r\n    });\r\n\r\n    el.setAttribute(ATTR_DIR, \"•\");\r\n    el.setAttribute(ATTR_VAL, \"0\");\r\n    el.setAttribute(ATTR_VAL_PCT, \"0\");\r\n    document.body.appendChild(el);\r\n\r\n    // Inject dynamic CSS\r\n    const styleId = \"string-position-tracker-style\";\r\n    if (!document.getElementById(styleId)) {\r\n      const style = document.createElement(\"style\");\r\n      style.id = styleId;\r\n      style.innerHTML = `\r\n        [${ATTR_DIR}][${ATTR_VAL}][${ATTR_VAL_PCT}]::before {\r\n          content: attr(${ATTR_DIR}) ' | ' attr(${ATTR_VAL}) 'px (' attr(${ATTR_VAL_PCT}) '%)';\r\n        }\r\n      `;\r\n      document.head.appendChild(style);\r\n    }\r\n\r\n    this.displayElement = el;\r\n  }\r\n}\r\n","/**\r\n * Creates a debounced version of a function that delays invoking the function\r\n * until after `delay` milliseconds have passed since the last time the\r\n * debounced function was invoked.\r\n *\r\n * @template T The type of the function to debounce.\r\n * @param func The function to debounce.\r\n * @param delay The number of milliseconds to delay.\r\n * @returns The new debounced function.\r\n */\r\nexport function Debounce<T extends (...args: any[]) => any>(func: T, delay: number): (...args: Parameters<T>) => void {\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n\r\n  // Return a new function that will be called instead of the original\r\n  return function(this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    // Capture the 'this' context and arguments for the original function\r\n    const context = this;\r\n\r\n    // If there is already a scheduled call, cancel it\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n\r\n    // Schedule a new call to the original function after 'delay' ms\r\n    timeoutId = setTimeout(() => {\r\n      func.apply(context, args); // Call the original function with the correct 'this' and arguments\r\n      timeoutId = null; // Clear the timer ID after execution (optional but good practice)\r\n    }, delay);\r\n  };\r\n}","/**\r\n * Utility class that provides a customizable requestAnimationFrame loop.\r\n * Allows running a callback function on every frame or at a specific FPS rate.\r\n * Automatically pauses on `document.hidden` and resumes on visibility change.\r\n */\r\nexport class StringFPS {\r\n  /** Target frames per second (FPS). */\r\n  private fps: number = 0;\r\n\r\n  /** Whether the animation loop is currently active. */\r\n  private isAnimationStarted: boolean = false;\r\n\r\n  /** Time interval between frames in milliseconds, based on FPS. */\r\n  private fpsInterval: number = 0;\r\n\r\n  /** Timestamp of the previous frame (used for timing calculations). */\r\n  private then: number = 0;\r\n\r\n  /** The requestAnimationFrame ID (used to cancel the loop). */\r\n  private requestAnimationId: number = 0;\r\n\r\n  /** Bound function for visibilitychange event handler. */\r\n  private onVisibilityChangeBind: any;\r\n\r\n  /** Callback executed on each frame. */\r\n  private onFrameCallback: (time: number) => void = (time: number) => {};\r\n\r\n  /** Internal animation loop function. */\r\n  private animate: () => void = () => {};\r\n\r\n  constructor() {\r\n    this.onVisibilityChangeBind = this.onVisibilityChange.bind(this);\r\n  }\r\n\r\n  /**\r\n   * Handles visibility change events.\r\n   * Stops the loop when the document is hidden and resumes it when visible.\r\n   */\r\n  private onVisibilityChange() {\r\n    if (document.hidden) {\r\n      this.stop();\r\n      this.isAnimationStarted = false;\r\n    } else {\r\n      this.start(this.fps);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Starts the animation loop at a given FPS rate.\r\n   * If `fps` is 0, runs the callback as fast as possible (uncapped).\r\n   * \r\n   * @param fps Target frames per second (0 = uncapped).\r\n   */\r\n  public start(fps: number) {\r\n    this.fps = fps;\r\n    if (this.isAnimationStarted) return;\r\n\r\n    this.fpsInterval = 1000 / fps;\r\n    this.then = performance.now();\r\n    this.isAnimationStarted = true;\r\n\r\n    if (fps === 0) {\r\n      this.animate = () => {\r\n        const now = performance.now();\r\n        this.requestAnimationId = requestAnimationFrame(() => this.animate());\r\n        this.onFrameCallback(now);\r\n      };\r\n    } else {\r\n      this.animate = () => {\r\n        const now = performance.now();\r\n        const elapsed = now - this.then;\r\n        if (elapsed > this.fpsInterval) {\r\n          this.then = now - (elapsed % this.fpsInterval);\r\n          this.onFrameCallback(now);\r\n        }\r\n        this.requestAnimationId = requestAnimationFrame(() => this.animate());\r\n      };\r\n    }\r\n\r\n    this.animate();\r\n    // document.addEventListener(\"visibilitychange\", this.onVisibilityChangeBind);\r\n  }\r\n\r\n  /**\r\n   * Stops the animation loop and removes the animation frame.\r\n   */\r\n  public stop() {\r\n    if (!this.isAnimationStarted) return;\r\n    cancelAnimationFrame(this.requestAnimationId);\r\n    this.requestAnimationId = 0;\r\n    this.isAnimationStarted = false;\r\n  }\r\n\r\n  /**\r\n   * Assigns a callback function to be called on each frame.\r\n   * \r\n   * @param callback The function to execute per frame.\r\n   */\r\n  public setOnFrame(callback: (time: number) => void) {\r\n    this.onFrameCallback = callback;\r\n  }\r\n\r\n  /**\r\n   * Stops the loop and removes event listeners.\r\n   * Should be called when the loop is no longer needed.\r\n   */\r\n  public destructor() {\r\n    this.stop();\r\n    // document.removeEventListener(\"visibilitychange\", this.onVisibilityChangeBind);\r\n  }\r\n}\r\n","import { StringObject } from \"../../objects/StringObject\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringContext } from \"../../core/StringContext\";\r\n\r\nexport class StringVideoAutoplay extends StringModule {\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"autoplay\";\r\n\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      {\r\n        key: \"src\",\r\n        type: \"string\",\r\n        fallback: \"\",\r\n      },\r\n    ];\r\n  }\r\n\r\n  onObjectConnected(object: StringObject) {\r\n    object.setProperty(\"onEnterEvent\", this.onEnterObject.bind(this));\r\n    object.events.on(\r\n      \"enter\",\r\n      object.getProperty<(object: StringObject) => void>(\"onEnterEvent\")\r\n    );\r\n    object.setProperty(\"onLeaveEvent\", this.onLeaveObject.bind(this));\r\n    object.events.on(\r\n      \"leave\",\r\n      object.getProperty<(object: StringObject) => void>(\"onLeaveEvent\")\r\n    );\r\n\r\n    const videoElement = object.htmlElement as HTMLVideoElement;\r\n    const started =\r\n      this.tools.domAttribute.process({\r\n        element: videoElement,\r\n        key: \"string-started\",\r\n        fallback: null,\r\n      }) !== null;\r\n\r\n    if (videoElement.tagName.toLowerCase() === \"video\" && !started) {\r\n      videoElement.setAttribute(\"string-started\", \"\");\r\n      videoElement.muted = true;\r\n      videoElement.setAttribute(\"muted\", \"muted\");\r\n      videoElement.setAttribute(\"playsinline\", \"\");\r\n      videoElement.setAttribute(\"loop\", \"\");\r\n      videoElement.setAttribute(\"autoplay\", \"\");\r\n      videoElement.src = object.getProperty(\"src\");\r\n      videoElement.load();\r\n      videoElement.addEventListener(\"canplay\", () => {});\r\n    }\r\n  }\r\n\r\n  private onEnterObject(object: StringObject) {\r\n    const videoElement = object.htmlElement as HTMLVideoElement;\r\n    this.tryPlay(videoElement);\r\n  }\r\n  private onLeaveObject(object: StringObject) {\r\n    const videoElement = object.htmlElement as HTMLVideoElement;\r\n    videoElement.pause();\r\n  }\r\n\r\n  private tryPlay(element: HTMLVideoElement) {\r\n    element\r\n      .play()\r\n      .catch((err) =>\r\n        console.warn(\"[StringVideoAutoplay] Autoplay failed:\", err)\r\n      );\r\n  }\r\n}\r\n","/**\r\n * Discrete state classes applied to sequence elements.\r\n */\r\nexport enum SequenceState {\r\n  ACTIVE = \"-active\",\r\n  ENTERING = \"-entering\",\r\n  LEAVING = \"-leaving\",\r\n  DISABLED = \"-disabled\",\r\n}\r\n\r\n/**\r\n * Event data for sequence transitions.\r\n */\r\nexport interface SequenceEventData {\r\n  /** Slider identifier */\r\n  slider: string;\r\n  /** Current step index */\r\n  step: number;\r\n  /** Transition progress from 0 to 1 (optional, for manual scrubbing) */\r\n  transitionProgress?: number;\r\n  /** Direction of transition: 1 = forward, -1 = backward */\r\n  direction?: 1 | -1;\r\n  /** Custom duration for this transition in ms (overrides element's sequence-duration) */\r\n  duration?: number;\r\n  /** Skip animation and switch instantly */\r\n  instant?: boolean;\r\n}\r\n\r\n/**\r\n * CSS custom property names for sequence.\r\n */\r\nexport const SequenceProgressVars = {\r\n  /** Unified progress variable (0 to 1) */\r\n  PROGRESS: \"--sequence-progress\",\r\n  /** Direction of current transition (1 or -1) */\r\n  DIRECTION: \"--sequence-direction\",\r\n} as const;\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringData } from \"../../core/StringData\";\r\nimport {\r\n  SequenceState,\r\n  SequenceEventData,\r\n  SequenceProgressVars,\r\n} from \"../../models/slider/SequenceState\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { EasingFunctionOutput } from \"../../tools/EasingFunctionTool\";\r\nimport { styleTxn } from \"../../utils/style-txn\";\r\n\r\ninterface TransitionState {\r\n  fromStep: number;\r\n  toStep: number;\r\n  direction: 1 | -1;\r\n  startTime: number;\r\n  enteringDuration: number;\r\n  leavingDuration: number;\r\n}\r\n\r\ninterface StepElements {\r\n  objects: StringObject[];\r\n  enteringDuration: number;\r\n  leavingDuration: number;\r\n}\r\n\r\ninterface TriggerData {\r\n  slider: string;\r\n  step: number | \"next\" | \"prev\";\r\n  loop: boolean;\r\n}\r\n\r\ninterface GlobalSliderSettings {\r\n  enteringDuration?: number;\r\n  leavingDuration?: number;\r\n  enteringEasing?: string;\r\n  leavingEasing?: string;\r\n  activeStep?: number;\r\n}\r\n\r\ntype DurationKey = \"enteringDuration\" | \"leavingDuration\";\r\ntype EasingKey = \"enteringEasing\" | \"leavingEasing\";\r\n\r\nexport class StringSequence extends StringModule {\r\n  private activeStep = new Map<string, number>();\r\n  private leavingStep = new Map<string, number>();\r\n  private transitions = new Map<string, TransitionState>();\r\n  private elementIndex = new Map<string, StepElements>();\r\n  private triggerElements = new Map<HTMLElement, TriggerData>();\r\n  private globalSettings = new Map<string, GlobalSliderSettings>();\r\n  private defaultDuration: number;\r\n  private initialized = false;\r\n  private static readonly ALL_STATES = Object.values(SequenceState);\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"sequence\";\r\n    this.defaultDuration = this.settings[\"sequence-duration\"] ?? 600;\r\n\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      { key: \"sequence\", type: \"string\", fallback: \"\" },\r\n      { key: \"sequence-trigger\", type: \"string\", fallback: \"\" },\r\n      { key: \"entering-easing\", type: \"string\", fallback: \"\" },\r\n      { key: \"leaving-easing\", type: \"string\", fallback: \"\" },\r\n      { key: \"entering-duration\", type: \"string\", fallback: \"\" },\r\n      { key: \"leaving-duration\", type: \"string\", fallback: \"\" },\r\n      { key: \"sequence-duration\", type: \"string\", fallback: \"\" },\r\n      { key: \"active-step\", type: \"string\", fallback: \"\" },\r\n    ];\r\n  }\r\n\r\n  onInit(): void {\r\n    super.onInit();\r\n    this.events.on<SequenceEventData>(\"sequence\", this.onSequenceEvent.bind(this));\r\n    this.scanStandaloneTriggers();\r\n  }\r\n\r\n  private scanStandaloneTriggers(): void {\r\n    const els = document.querySelectorAll<HTMLElement>(\r\n      \"[string-sequence-trigger]:not([string-inited])\"\r\n    );\r\n    for (const el of els) {\r\n      const trigger = el.getAttribute(\"string-sequence-trigger\");\r\n      const parsed = trigger ? this.parseTriggerKey(trigger) : null;\r\n      if (parsed) {\r\n        this.triggerElements.set(el, parsed);\r\n        el.addEventListener(\"click\", this.onTriggerClick);\r\n      }\r\n    }\r\n  }\r\n\r\n  private parseGlobalSettingsFromObject(object: StringObject): void {\r\n    const get = (k: string) => object.getProperty<string>(k);\r\n    const seq = get(\"sequence-duration\");\r\n\r\n    this.tryParseGlobalSetting(seq, \"enteringDuration\");\r\n    this.tryParseGlobalSetting(seq, \"leavingDuration\");\r\n    this.tryParseGlobalSetting(get(\"entering-duration\"), \"enteringDuration\");\r\n    this.tryParseGlobalSetting(get(\"leaving-duration\"), \"leavingDuration\");\r\n    this.tryParseGlobalSetting(get(\"entering-easing\"), \"enteringEasing\");\r\n    this.tryParseGlobalSetting(get(\"leaving-easing\"), \"leavingEasing\");\r\n    this.tryParseGlobalSetting(get(\"active-step\"), \"activeStep\");\r\n  }\r\n\r\n  private tryParseGlobalSetting(attr: string | null, key: keyof GlobalSliderSettings): void {\r\n    if (!attr) return;\r\n    const match = attr.match(/^(.+)\\[(.+)\\]$/);\r\n    if (!match) return;\r\n\r\n    const [, slider, value] = match;\r\n    const settings = this.globalSettings.get(slider) ?? {};\r\n    this.globalSettings.set(slider, settings);\r\n\r\n    (settings as Record<string, string | number>)[key] =\r\n      key === \"enteringEasing\" || key === \"leavingEasing\" ? value : parseFloat(value);\r\n\r\n    this.applyGlobalSettingsToExistingObjects(slider);\r\n  }\r\n\r\n  private applyGlobalSettingsToExistingObjects(slider: string): void {\r\n    const global = this.globalSettings.get(slider);\r\n    if (!global) return;\r\n\r\n    for (const [key, group] of this.elementIndex) {\r\n      const parsed = this.parseSequenceKey(key);\r\n      if (parsed?.slider !== slider) continue;\r\n\r\n      if (global.enteringDuration !== undefined) group.enteringDuration = global.enteringDuration;\r\n      if (global.leavingDuration !== undefined) group.leavingDuration = global.leavingDuration;\r\n\r\n      for (const obj of group.objects) this.resolveEasings(obj, key);\r\n    }\r\n  }\r\n\r\n  private initializeSliders(): void {\r\n    const sliders = new Set<string>();\r\n    for (const key of this.elementIndex.keys()) {\r\n      const p = this.parseSequenceKey(key);\r\n      if (p) sliders.add(p.slider);\r\n    }\r\n\r\n    for (const slider of sliders) {\r\n      if (this.activeStep.has(slider)) continue;\r\n      const global = this.globalSettings.get(slider);\r\n      let step = global?.activeStep ?? 0;\r\n      if (!this.elementIndex.has(`${slider}[${step}]`)) step = 0;\r\n      this.switchInstant(slider, step, 1);\r\n    }\r\n  }\r\n\r\n  private tryApplyPendingActiveStep(slider: string): void {\r\n    if (this.activeStep.has(slider)) return;\r\n    const step = this.globalSettings.get(slider)?.activeStep;\r\n    if (step !== undefined && this.elementIndex.has(`${slider}[${step}]`)) {\r\n      this.switchInstant(slider, step, 1);\r\n    }\r\n  }\r\n\r\n  override canConnect(object: StringObject): boolean {\r\n    return object.keys.includes(\"sequence\") || object.keys.includes(\"sequence-trigger\");\r\n  }\r\n\r\n  override onObjectConnected(object: StringObject): void {\r\n    super.onObjectConnected(object);\r\n    this.parseGlobalSettingsFromObject(object);\r\n\r\n    let sequence = object.getProperty<string>(\"sequence\");\r\n    const trigger = object.getProperty<string>(\"sequence-trigger\");\r\n\r\n    if (!sequence && trigger) {\r\n      const p = this.parseTriggerKey(trigger);\r\n      if (p && typeof p.step === \"number\") {\r\n        sequence = `${p.slider}[${p.step}]`;\r\n        object.setProperty(\"sequence\", sequence);\r\n      }\r\n    }\r\n\r\n    if (sequence) {\r\n      const parsed = this.parseSequenceKey(sequence);\r\n      if (parsed) {\r\n        let group = this.elementIndex.get(sequence);\r\n        if (!group) {\r\n          const { enteringDuration, leavingDuration } = this.resolveDurations(object, sequence);\r\n          group = { objects: [], enteringDuration, leavingDuration };\r\n          this.elementIndex.set(sequence, group);\r\n        }\r\n        group.objects.push(object);\r\n        this.resolveEasings(object, sequence);\r\n\r\n        const active = this.activeStep.get(parsed.slider);\r\n        this.setState(\r\n          object,\r\n          active === parsed.step ? SequenceState.ACTIVE : SequenceState.DISABLED,\r\n          active === parsed.step ? 1 : 0,\r\n          1\r\n        );\r\n        this.tryApplyPendingActiveStep(parsed.slider);\r\n      }\r\n    }\r\n\r\n    if (trigger) {\r\n      const p = this.parseTriggerKey(trigger);\r\n      if (p) {\r\n        this.triggerElements.set(object.htmlElement, p);\r\n        object.htmlElement.addEventListener(\"click\", this.onTriggerClick);\r\n      }\r\n    }\r\n  }\r\n\r\n  private parseTriggerKey(key: string): TriggerData | null {\r\n    const m = key.match(/^(.+)\\[(next|prev|\\d+)(\\|loop)?\\]$/);\r\n    if (!m) return null;\r\n    const step = m[2] === \"next\" || m[2] === \"prev\" ? m[2] : parseInt(m[2], 10);\r\n    return { slider: m[1], step, loop: m[3] === \"|loop\" };\r\n  }\r\n\r\n  private getMaxStep(slider: string): number {\r\n    let max = -1;\r\n    for (const key of this.elementIndex.keys()) {\r\n      const p = this.parseSequenceKey(key);\r\n      if (p?.slider === slider && p.step > max) max = p.step;\r\n    }\r\n    return max;\r\n  }\r\n\r\n  private resolveDuration(\r\n    object: StringObject,\r\n    slider: string,\r\n    key: DurationKey,\r\n    attrKey: string\r\n  ): number {\r\n    const attr = object.getProperty<string>(attrKey);\r\n    const seqAttr = object.getProperty<string>(\"sequence-duration\");\r\n    const global = this.globalSettings.get(slider)?.[key];\r\n\r\n    if (attr && !attr.includes(\"[\")) {\r\n      const v = parseFloat(attr);\r\n      if (!isNaN(v)) return v;\r\n    }\r\n    if (seqAttr && !seqAttr.includes(\"[\")) {\r\n      const v = parseFloat(seqAttr);\r\n      if (!isNaN(v)) return v;\r\n    }\r\n    return global ?? this.defaultDuration;\r\n  }\r\n\r\n  private resolveDurations(object: StringObject, sequence: string) {\r\n    const slider = this.parseSequenceKey(sequence)?.slider ?? \"\";\r\n    return {\r\n      enteringDuration: this.resolveDuration(\r\n        object,\r\n        slider,\r\n        \"enteringDuration\",\r\n        \"entering-duration\"\r\n      ),\r\n      leavingDuration: this.resolveDuration(object, slider, \"leavingDuration\", \"leaving-duration\"),\r\n    };\r\n  }\r\n\r\n  private resolveEasing(\r\n    object: StringObject,\r\n    slider: string,\r\n    key: EasingKey,\r\n    attrKey: string\r\n  ): void {\r\n    let easing = object.getProperty<string | EasingFunctionOutput>(attrKey);\r\n    if (!easing || (typeof easing === \"string\" && easing.includes(\"[\"))) {\r\n      easing = this.globalSettings.get(slider)?.[key] ?? this.settings[\"easing\"] ?? \"ease-out\";\r\n    }\r\n    if (typeof easing === \"string\") {\r\n      object.setProperty(attrKey, this.tools.easingFunction.process({ easing }));\r\n    }\r\n  }\r\n\r\n  private resolveEasings(object: StringObject, sequence: string): void {\r\n    const slider = this.parseSequenceKey(sequence)?.slider;\r\n    if (!slider) return;\r\n    this.resolveEasing(object, slider, \"enteringEasing\", \"entering-easing\");\r\n    this.resolveEasing(object, slider, \"leavingEasing\", \"leaving-easing\");\r\n  }\r\n\r\n  override onObjectDisconnected(object: StringObject): void {\r\n    super.onObjectDisconnected(object);\r\n\r\n    const sequence = object.getProperty<string>(\"sequence\");\r\n    if (sequence) {\r\n      const group = this.elementIndex.get(sequence);\r\n      if (group) {\r\n        const idx = group.objects.indexOf(object);\r\n        if (idx !== -1) group.objects.splice(idx, 1);\r\n        if (!group.objects.length) this.elementIndex.delete(sequence);\r\n      }\r\n    }\r\n\r\n    if (this.triggerElements.has(object.htmlElement)) {\r\n      object.htmlElement.removeEventListener(\"click\", this.onTriggerClick);\r\n      this.triggerElements.delete(object.htmlElement);\r\n    }\r\n  }\r\n\r\n  private parseSequenceKey(key: string): { slider: string; step: number } | null {\r\n    const m = key.match(/^(.+)\\[(\\d+)\\]$/);\r\n    return m ? { slider: m[1], step: parseInt(m[2], 10) } : null;\r\n  }\r\n\r\n  private onTriggerClick = (e: Event): void => {\r\n    const data = this.triggerElements.get(e.currentTarget as HTMLElement);\r\n    if (!data) return;\r\n\r\n    const current = this.activeStep.get(data.slider) ?? 0;\r\n    const max = this.getMaxStep(data.slider);\r\n    let target: number, dir: 1 | -1;\r\n\r\n    if (data.step === \"next\") {\r\n      target = current + 1;\r\n      dir = 1;\r\n      if (!this.elementIndex.has(`${data.slider}[${target}]`)) {\r\n        if (data.loop && max >= 0) target = 0;\r\n        else return;\r\n      }\r\n    } else if (data.step === \"prev\") {\r\n      target = current - 1;\r\n      dir = -1;\r\n      if (target < 0) {\r\n        if (data.loop && max >= 0) target = max;\r\n        else return;\r\n      }\r\n      if (!this.elementIndex.has(`${data.slider}[${target}]`)) return;\r\n    } else {\r\n      target = data.step;\r\n      if (current === target) return;\r\n      dir = target > current ? 1 : -1;\r\n    }\r\n\r\n    this.startTransition(data.slider, target, dir);\r\n  };\r\n\r\n  private onSequenceEvent(data: SequenceEventData): void {\r\n    const { slider, step, transitionProgress, direction = 1, duration, instant } = data;\r\n    const current = this.activeStep.get(slider);\r\n\r\n    if (current === step && transitionProgress === undefined) return;\r\n\r\n    if (transitionProgress !== undefined) {\r\n      this.handleScrub(slider, step, transitionProgress, direction);\r\n    } else if (instant) {\r\n      this.switchInstant(slider, step, direction);\r\n    } else {\r\n      this.startTransition(slider, step, direction, duration);\r\n    }\r\n  }\r\n\r\n  private startTransition(\r\n    slider: string,\r\n    toStep: number,\r\n    direction: 1 | -1,\r\n    customDuration?: number\r\n  ): void {\r\n    const fromStep = this.activeStep.get(slider);\r\n    const prevLeaving = this.leavingStep.get(slider);\r\n\r\n    if (prevLeaving !== undefined && prevLeaving !== fromStep) {\r\n      this.setStepState(slider, prevLeaving, SequenceState.DISABLED, 0, direction);\r\n    }\r\n\r\n    const enteringGroup = this.elementIndex.get(`${slider}[${toStep}]`);\r\n    const leavingGroup =\r\n      fromStep !== undefined ? this.elementIndex.get(`${slider}[${fromStep}]`) : null;\r\n\r\n    if (fromStep !== undefined) this.leavingStep.set(slider, fromStep);\r\n    this.activeStep.set(slider, toStep);\r\n\r\n    this.transitions.set(slider, {\r\n      fromStep: fromStep ?? toStep,\r\n      toStep,\r\n      direction,\r\n      startTime: this.data.time.now,\r\n      enteringDuration: customDuration ?? enteringGroup?.enteringDuration ?? this.defaultDuration,\r\n      leavingDuration: customDuration ?? leavingGroup?.leavingDuration ?? this.defaultDuration,\r\n    });\r\n  }\r\n\r\n  private handleScrub(slider: string, step: number, progress: number, direction: 1 | -1): void {\r\n    this.transitions.delete(slider);\r\n    const current = this.activeStep.get(slider);\r\n\r\n    if (current !== step) {\r\n      const prev = this.leavingStep.get(slider);\r\n      if (prev !== undefined) this.setStepState(slider, prev, SequenceState.DISABLED, 0, direction);\r\n      if (current !== undefined) this.leavingStep.set(slider, current);\r\n      this.activeStep.set(slider, step);\r\n    }\r\n\r\n    this.applyProgress(slider, progress, progress, direction);\r\n  }\r\n\r\n  private switchInstant(slider: string, step: number, direction: 1 | -1): void {\r\n    this.transitions.delete(slider);\r\n    const current = this.activeStep.get(slider);\r\n    const leaving = this.leavingStep.get(slider);\r\n\r\n    if (leaving !== undefined)\r\n      this.setStepState(slider, leaving, SequenceState.DISABLED, 0, direction);\r\n    if (current !== undefined && current !== step)\r\n      this.setStepState(slider, current, SequenceState.DISABLED, 0, direction);\r\n\r\n    this.activeStep.set(slider, step);\r\n    this.leavingStep.delete(slider);\r\n    this.setStepState(slider, step, SequenceState.ACTIVE, 1, direction);\r\n  }\r\n\r\n  private applyProgress(\r\n    slider: string,\r\n    enteringProg: number,\r\n    leavingProg: number,\r\n    direction: 1 | -1\r\n  ): void {\r\n    const active = this.activeStep.get(slider)!;\r\n    const leaving = this.leavingStep.get(slider);\r\n\r\n    this.setStepState(\r\n      slider,\r\n      active,\r\n      enteringProg >= 1 ? SequenceState.ACTIVE : SequenceState.ENTERING,\r\n      enteringProg,\r\n      direction\r\n    );\r\n\r\n    if (leaving !== undefined && leaving !== active) {\r\n      if (leavingProg >= 1) {\r\n        this.setStepState(slider, leaving, SequenceState.DISABLED, 0, direction);\r\n        this.leavingStep.delete(slider);\r\n      } else {\r\n        this.setStepState(slider, leaving, SequenceState.LEAVING, leavingProg, direction);\r\n      }\r\n    }\r\n  }\r\n\r\n  private setStepState(\r\n    slider: string,\r\n    step: number,\r\n    state: SequenceState,\r\n    progress: number,\r\n    direction: 1 | -1\r\n  ): void {\r\n    const group = this.elementIndex.get(`${slider}[${step}]`);\r\n    if (group) for (const obj of group.objects) this.setState(obj, state, progress, direction);\r\n  }\r\n\r\n  private setState(\r\n    object: StringObject,\r\n    state: SequenceState,\r\n    rawProgress: number,\r\n    direction: 1 | -1\r\n  ): void {\r\n    const el = object.htmlElement;\r\n    const currentState = object.getProperty<SequenceState>(\"_state\");\r\n    const currentDir = object.getProperty<number>(\"_direction\");\r\n\r\n    const easing = object.getProperty<EasingFunctionOutput>(\r\n      state === SequenceState.LEAVING ? \"leaving-easing\" : \"entering-easing\"\r\n    );\r\n    const progress = typeof easing === \"function\" ? easing(rawProgress) : rawProgress;\r\n\r\n    if (currentState !== state) {\r\n      el.classList.remove(...StringSequence.ALL_STATES);\r\n      el.classList.add(state);\r\n      object.setProperty(\"_state\", state);\r\n    }\r\n\r\n    if (currentDir !== direction) {\r\n      object.setProperty(\"_direction\", direction);\r\n      styleTxn.run(() =>\r\n        styleTxn.setVars(el, { [SequenceProgressVars.DIRECTION]: direction.toString() })\r\n      );\r\n    }\r\n  }\r\n\r\n  onFrame(data: StringData): void {\r\n    super.onFrame(data);\r\n\r\n    if (!this.initialized) {\r\n      this.initialized = true;\r\n      this.initializeSliders();\r\n    }\r\n\r\n    for (const [slider, t] of this.transitions) {\r\n      const elapsed = data.time.now - t.startTime;\r\n      const enteringProg = Math.min(1, elapsed / t.enteringDuration);\r\n      const leavingProg = Math.min(1, elapsed / t.leavingDuration);\r\n\r\n      this.applyProgress(slider, enteringProg, leavingProg, t.direction);\r\n\r\n      if (enteringProg >= 1 && leavingProg >= 1) this.transitions.delete(slider);\r\n    }\r\n  }\r\n}\r\n","import { StringContext } from \"../../core/StringContext\";\r\nimport { StringModule } from \"../../core/StringModule\";\r\nimport { StringObject } from \"../../objects/StringObject\";\r\nimport { RuleParserResult } from \"../../tools/RuleParserTool\";\r\nimport type { ValidationContext } from \"../../tools/ValidationTool\";\r\n\r\ntype FormField = HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement;\r\n\r\ninterface RegisteredEvent {\r\n  eventElement: EventTarget;\r\n  eventType: string;\r\n  eventCallback: EventListenerOrEventListenerObject;\r\n}\r\n\r\ninterface FieldEntry {\r\n  field: FormField;\r\n  key: string;\r\n  rules: RuleParserResult[];\r\n  supportsRealtime: boolean;\r\n  needsContext: boolean;\r\n  inputEventType: \"input\" | \"change\";\r\n  inputHandler: EventListener;\r\n  beforeInputHandler?: EventListener;\r\n}\r\n\r\ntype FormState = {\r\n  object: StringObject;\r\n  form: HTMLFormElement;\r\n  entries: FieldEntry[];\r\n  values: Record<string, any>;\r\n  events: RegisteredEvent[];\r\n};\r\n\r\nexport class StringForm extends StringModule {\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"form\";\r\n  }\r\n\r\n  initializeObject(\r\n    globalId: number,\r\n    object: StringObject,\r\n    element: HTMLElement,\r\n    attributes: Record<string, any>\r\n  ): void {\r\n    super.initializeObject(globalId, object, element, attributes);\r\n\r\n    const existingEvents = object.getProperty<Array<RegisteredEvent>>(\"form-events\") ?? [];\r\n    existingEvents.forEach((evt) => {\r\n      evt.eventElement.removeEventListener(evt.eventType, evt.eventCallback);\r\n    });\r\n    existingEvents.length = 0;\r\n    object.setProperty(\"form-events\", existingEvents);\r\n\r\n    super.onObjectConnected(object);\r\n    const form = object.htmlElement as HTMLFormElement;\r\n\r\n    const fieldEntries: FieldEntry[] = [];\r\n    const fieldValues: Record<string, any> = {};\r\n\r\n    this.getInteractiveFields(form).forEach((field, idx) =>\r\n      this.registerField(field, form, fieldEntries, fieldValues, existingEvents, idx)\r\n    );\r\n\r\n    const submitCallback = (event: Event) => {\r\n      event.preventDefault();\r\n      let allValid = true;\r\n      const data: Record<string, any> = {};\r\n      const processedRadioKeys = new Set<string>();\r\n      for (const entry of fieldEntries) {\r\n        const field = entry.field;\r\n        if (!field.isConnected || !this.shouldValidateField(field)) continue;\r\n        if (this.isRadioField(field)) {\r\n          if (processedRadioKeys.has(entry.key)) {\r\n            continue;\r\n          }\r\n          processedRadioKeys.add(entry.key);\r\n        }\r\n        const { key, rules, needsContext } = entry;\r\n        const value = this.getFieldValue(field);\r\n        data[key] = value;\r\n        fieldValues[key] = value;\r\n\r\n        const { valid, errors } = this.tools.validation.process({\r\n          rules,\r\n          value,\r\n          context: this.buildContext(needsContext, key, fieldValues),\r\n        });\r\n\r\n        this.applyValidationState(form, field, key, valid, errors, \"submit\");\r\n\r\n        if (!valid) {\r\n          allValid = false;\r\n        }\r\n      }\r\n\r\n      if (allValid) {\r\n        this.events.emit(`form:submit:${object.id}`, data);\r\n      } else {\r\n        const processedRadioKeys = new Set<string>();\r\n        const firstInvalidEntry = fieldEntries.find((entry) => {\r\n          const field = entry.field;\r\n          if (!field.isConnected || !this.shouldValidateField(field)) return false;\r\n          if (this.isRadioField(field)) {\r\n            if (processedRadioKeys.has(entry.key)) {\r\n              return false;\r\n            }\r\n            processedRadioKeys.add(entry.key);\r\n          }\r\n          const { key, rules, needsContext } = entry;\r\n          const value = this.getFieldValue(field);\r\n          fieldValues[key] = value;\r\n          const { valid } = this.tools.validation.process({\r\n            rules,\r\n            value,\r\n            context: this.buildContext(needsContext, key, fieldValues),\r\n          });\r\n          return !valid;\r\n        });\r\n        if (firstInvalidEntry?.field && typeof firstInvalidEntry.field.focus === \"function\") {\r\n          firstInvalidEntry.field.focus();\r\n        }\r\n        this.events.emit(`form:invalid:${object.id}`);\r\n      }\r\n    };\r\n\r\n    form.addEventListener(\"submit\", submitCallback);\r\n    existingEvents.push({ eventElement: form, eventType: \"submit\", eventCallback: submitCallback });\r\n\r\n    object.setProperty(\"form-field-entries\", fieldEntries);\r\n    object.setProperty(\"form-field-values\", fieldValues);\r\n  }\r\n\r\n  onObjectConnected(object: StringObject) {}\r\n\r\n  onDOMMutate(added: NodeList, removed: NodeList): void {\r\n    if (this.objects.length === 0) {\r\n      return;\r\n    }\r\n\r\n    if (added.length > 0) {\r\n      this.handleMutationAdditions(added);\r\n    }\r\n\r\n    if (removed.length > 0) {\r\n      this.handleMutationRemovals(removed);\r\n    }\r\n  }\r\n\r\n  private applyValidationState(\r\n    form: HTMLFormElement,\r\n    field: FormField,\r\n    key: string,\r\n    valid: boolean,\r\n    errors: string[],\r\n    phase: \"live\" | \"submit\"\r\n  ): void {\r\n    const errorBlock = form.querySelector(`[string-input=\"error[${key}]\"]`);\r\n    const groupBlock = form.querySelector(`[string-input=\"group[${key}]\"]`);\r\n    if (errorBlock) {\r\n      errorBlock.innerHTML = \"\";\r\n      errors.forEach((message) => {\r\n        const span = document.createElement(\"span\");\r\n        span.textContent = message;\r\n        errorBlock.appendChild(span);\r\n      });\r\n    }\r\n    if (phase === \"live\") {\r\n      field.classList.toggle(\"-invalid\", !valid);\r\n      field.classList.remove(\"-error\");\r\n    } else {\r\n      field.classList.remove(\"-invalid\");\r\n      field.classList.toggle(\"-error\", !valid);\r\n    }\r\n    field.classList.toggle(\"-valid\", valid);\r\n    if (groupBlock) {\r\n      if (phase === \"live\") {\r\n        groupBlock.classList.toggle(\"-invalid\", !valid);\r\n        groupBlock.classList.remove(\"-error\");\r\n      } else {\r\n        groupBlock.classList.remove(\"-invalid\");\r\n        groupBlock.classList.toggle(\"-error\", !valid);\r\n      }\r\n      groupBlock.classList.toggle(\"-valid\", valid);\r\n    }\r\n\r\n    const eventSuffix = valid ? \"valid\" : phase === \"live\" ? \"invalid\" : \"error\";\r\n    this.events.emit(`form:field:${eventSuffix}:${key}`, {\r\n      key,\r\n      field,\r\n      errors,\r\n      phase,\r\n      valid,\r\n    });\r\n  }\r\n\r\n  private getInteractiveFields(form: HTMLFormElement): FormField[] {\r\n    return Array.from(form.querySelectorAll(\"[string-input]\"))\r\n      .filter((el) => !this.isServiceFieldAttribute(el.getAttribute(\"string-input\") || \"\"))\r\n      .filter((el): el is FormField => this.isFormFieldElement(el))\r\n      .map((el) => el as FormField);\r\n  }\r\n\r\n  private getFieldRules(field: FormField): RuleParserResult[] {\r\n    const ruleString =\r\n      this.tools.domAttribute.process({\r\n        element: field,\r\n        key: \"input\",\r\n      }) ?? \"\";\r\n    return this.tools.ruleParser.process({ value: ruleString });\r\n  }\r\n\r\n  private registerField(\r\n    field: FormField,\r\n    form: HTMLFormElement,\r\n    fieldEntries: FieldEntry[],\r\n    fieldValues: Record<string, any>,\r\n    events: RegisteredEvent[],\r\n    preferredIndex?: number\r\n  ): void {\r\n    if (!this.isFormFieldElement(field)) return;\r\n    if (field.closest(\"form\") !== form) return;\r\n    if (fieldEntries.some((entry) => entry.field === field)) return;\r\n\r\n    const registeredIndex = this.registerFieldIndex(field, preferredIndex ?? fieldEntries.length);\r\n    const key = this.getInputKey(field, registeredIndex);\r\n    const rules = this.getFieldRules(field);\r\n    const supportsRealtime = this.supportsBeforeInputValidation(rules);\r\n    const needsContext = this.requiresContext(rules);\r\n    const inputEventType = this.getInputEventType(field);\r\n\r\n    const entry: FieldEntry = {\r\n      field,\r\n      key,\r\n      rules,\r\n      supportsRealtime,\r\n      needsContext,\r\n      inputEventType,\r\n      inputHandler: () => undefined,\r\n    };\r\n\r\n    const inputHandler = (event: Event) => {\r\n      const target = (event.currentTarget || event.target) as FormField | null;\r\n      if (!target || !target.isConnected || !this.shouldValidateField(target)) {\r\n        return;\r\n      }\r\n      const value = this.getFieldValue(target);\r\n      fieldValues[entry.key] = value;\r\n      const context = this.buildContext(entry.needsContext, entry.key, fieldValues);\r\n\r\n      const { valid, errors } = this.tools.validation.process({\r\n        rules: entry.rules,\r\n        value,\r\n        context,\r\n      });\r\n\r\n      this.applyValidationState(form, target, entry.key, valid, errors, \"live\");\r\n    };\r\n\r\n    entry.inputHandler = inputHandler;\r\n    field.addEventListener(inputEventType, inputHandler);\r\n    events.push({ eventElement: field, eventType: inputEventType, eventCallback: inputHandler });\r\n\r\n    if (\r\n      supportsRealtime &&\r\n      (field instanceof HTMLInputElement || field instanceof HTMLTextAreaElement)\r\n    ) {\r\n      const beforeInputHandler = (event: Event) => {\r\n        const inputEvent = event as InputEvent;\r\n        if (inputEvent.isComposing || inputEvent.inputType?.startsWith(\"insertComposition\")) {\r\n          return;\r\n        }\r\n        const target = (event.currentTarget || event.target) as FormField | null;\r\n        if (\r\n          !target ||\r\n          !(target instanceof HTMLInputElement || target instanceof HTMLTextAreaElement) ||\r\n          !target.isConnected\r\n        ) {\r\n          return;\r\n        }\r\n\r\n        const start = target.selectionStart ?? 0;\r\n        const end = target.selectionEnd ?? 0;\r\n        let nextVal = target.value;\r\n\r\n        switch (inputEvent.inputType) {\r\n          case \"deleteContentBackward\":\r\n            nextVal =\r\n              start === end && start > 0\r\n                ? target.value.slice(0, start - 1) + target.value.slice(end)\r\n                : target.value.slice(0, start) + target.value.slice(end);\r\n            break;\r\n          case \"deleteContentForward\":\r\n            nextVal =\r\n              start === end && start < target.value.length\r\n                ? target.value.slice(0, start) + target.value.slice(start + 1)\r\n                : target.value.slice(0, start) + target.value.slice(end);\r\n            break;\r\n          case \"insertFromPaste\":\r\n          case \"insertFromDrop\":\r\n          case \"insertReplacementText\":\r\n            nextVal =\r\n              target.value.slice(0, start) + (inputEvent.data || \"\") + target.value.slice(end);\r\n            break;\r\n          default:\r\n            if (typeof inputEvent.data === \"string\") {\r\n              nextVal = target.value.slice(0, start) + inputEvent.data + target.value.slice(end);\r\n            }\r\n        }\r\n\r\n        const { errors } = this.tools.validation.process({\r\n          rules: entry.rules,\r\n          value: nextVal,\r\n          type: \"beforeinput\",\r\n          context: this.buildContext(entry.needsContext, entry.key, fieldValues, {\r\n            applied: true,\r\n            value: nextVal,\r\n          }),\r\n        });\r\n\r\n        if (errors.length > 0 && event.cancelable) {\r\n          event.preventDefault();\r\n        }\r\n      };\r\n\r\n      entry.beforeInputHandler = beforeInputHandler;\r\n      field.addEventListener(\"beforeinput\", beforeInputHandler);\r\n      events.push({\r\n        eventElement: field,\r\n        eventType: \"beforeinput\",\r\n        eventCallback: beforeInputHandler,\r\n      });\r\n    }\r\n\r\n    field.classList.add(\"-inited\");\r\n    fieldEntries.push(entry);\r\n    fieldValues[key] = this.getFieldValue(field);\r\n  }\r\n\r\n  private unregisterField(\r\n    field: FormField,\r\n    fieldEntries: FieldEntry[],\r\n    fieldValues: Record<string, any>,\r\n    events: RegisteredEvent[]\r\n  ): void {\r\n    const index = fieldEntries.findIndex((entry) => entry.field === field);\r\n    if (index === -1) return;\r\n    const entry = fieldEntries[index];\r\n    if (entry.inputHandler) {\r\n      field.removeEventListener(entry.inputEventType, entry.inputHandler);\r\n    }\r\n    if (entry.beforeInputHandler) {\r\n      field.removeEventListener(\"beforeinput\", entry.beforeInputHandler);\r\n    }\r\n    delete fieldValues[entry.key];\r\n    fieldEntries.splice(index, 1);\r\n    for (let i = events.length - 1; i >= 0; i--) {\r\n      const registered = events[i];\r\n      if (registered.eventElement !== field) continue;\r\n      if (\r\n        registered.eventCallback === entry.inputHandler ||\r\n        (entry.beforeInputHandler && registered.eventCallback === entry.beforeInputHandler)\r\n      ) {\r\n        events.splice(i, 1);\r\n      }\r\n    }\r\n    field.classList.remove(\"-inited\");\r\n  }\r\n\r\n  private collectInteractiveFieldsFromNode(node: Node): FormField[] {\r\n    const elements: Element[] = [];\r\n    if (node instanceof Element) {\r\n      if (node.hasAttribute(\"string-input\")) {\r\n        elements.push(node);\r\n      }\r\n      elements.push(...Array.from(node.querySelectorAll(\"[string-input]\")));\r\n    } else if (node instanceof DocumentFragment) {\r\n      elements.push(...Array.from(node.querySelectorAll(\"[string-input]\")));\r\n    }\r\n\r\n    return elements\r\n      .filter((el) => !this.isServiceFieldAttribute(el.getAttribute(\"string-input\") || \"\"))\r\n      .filter((el): el is FormField => this.isFormFieldElement(el));\r\n  }\r\n\r\n  private isRadioField(field: FormField): field is HTMLInputElement {\r\n    return field instanceof HTMLInputElement && field.type === \"radio\";\r\n  }\r\n\r\n  private handleMutationAdditions(nodes: NodeList): void {\r\n    nodes.forEach((node) => {\r\n      const fields = this.collectInteractiveFieldsFromNode(node);\r\n      fields.forEach((field) => {\r\n        const state = this.getFormStateByContainment(field);\r\n        if (!state) return;\r\n        this.registerField(field, state.form, state.entries, state.values, state.events);\r\n      });\r\n    });\r\n  }\r\n\r\n  private handleMutationRemovals(nodes: NodeList): void {\r\n    nodes.forEach((node) => {\r\n      const fields = this.collectInteractiveFieldsFromNode(node);\r\n      fields.forEach((field) => {\r\n        const state = this.getFormStateByReference(field);\r\n        if (!state) return;\r\n        this.unregisterField(field, state.entries, state.values, state.events);\r\n      });\r\n    });\r\n  }\r\n\r\n  private getFormStateByContainment(field: FormField): FormState | null {\r\n    const owner = this.objects.find(\r\n      (object) =>\r\n        object.htmlElement instanceof HTMLFormElement && object.htmlElement.contains(field)\r\n    );\r\n    if (!owner) return null;\r\n    return this.buildFormState(owner);\r\n  }\r\n\r\n  private getFormStateByReference(field: FormField): FormState | null {\r\n    for (const object of this.objects) {\r\n      const entries = object.getProperty<FieldEntry[]>(\"form-field-entries\");\r\n      if (!entries) continue;\r\n      if (entries.some((entry) => entry.field === field)) {\r\n        return this.buildFormState(object, entries);\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private buildFormState(object: StringObject, entries?: FieldEntry[]): FormState | null {\r\n    const element = object.htmlElement;\r\n    if (!(element instanceof HTMLFormElement)) {\r\n      return null;\r\n    }\r\n    const stateEntries = entries ?? object.getProperty<FieldEntry[]>(\"form-field-entries\");\r\n    const values = object.getProperty<Record<string, any>>(\"form-field-values\");\r\n    const events = object.getProperty<Array<RegisteredEvent>>(\"form-events\");\r\n    if (!stateEntries || !values || !events) {\r\n      return null;\r\n    }\r\n    return {\r\n      object,\r\n      form: element,\r\n      entries: stateEntries,\r\n      values,\r\n      events,\r\n    };\r\n  }\r\n\r\n  private registerFieldIndex(field: FormField, idx: number): number {\r\n    const existing = field.getAttribute(\"data-string-form-index\");\r\n    if (existing !== null) {\r\n      return Number(existing);\r\n    }\r\n    field.setAttribute(\"data-string-form-index\", String(idx));\r\n    return idx;\r\n  }\r\n\r\n  private getFieldIndex(field: FormField, fallbackIdx: number): number {\r\n    const existing = field.getAttribute(\"data-string-form-index\");\r\n    if (existing !== null) {\r\n      const parsed = Number(existing);\r\n      return Number.isNaN(parsed) ? fallbackIdx : parsed;\r\n    }\r\n    return this.registerFieldIndex(field, fallbackIdx);\r\n  }\r\n\r\n  private shouldValidateField(field: FormField): boolean {\r\n    if (field.disabled) return false;\r\n    if (field instanceof HTMLInputElement && field.type === \"hidden\") return false;\r\n    return true;\r\n  }\r\n\r\n  private supportsBeforeInputValidation(rules: RuleParserResult[]): boolean {\r\n    return rules.some((rule) => StringForm.beforeInputRuleKeys.has(rule.key));\r\n  }\r\n\r\n  private requiresContext(rules: RuleParserResult[]): boolean {\r\n    return rules.some((rule) => StringForm.crossFieldRuleKeys.has(rule.key));\r\n  }\r\n\r\n  private buildContext(\r\n    needsContext: boolean,\r\n    fieldKey: string,\r\n    fieldValues: Record<string, any>,\r\n    override?: { applied: boolean; value: any }\r\n  ): ValidationContext {\r\n    if (!needsContext) {\r\n      return { fieldKey };\r\n    }\r\n\r\n    const needsOverride = Boolean(override?.applied);\r\n    const values = needsOverride ? { ...fieldValues, [fieldKey]: override!.value } : fieldValues;\r\n\r\n    return {\r\n      fieldKey,\r\n      values,\r\n      getValue: (lookupKey: string) => {\r\n        if (needsOverride && lookupKey === fieldKey) {\r\n          return override!.value;\r\n        }\r\n        return values[lookupKey];\r\n      },\r\n    };\r\n  }\r\n\r\n  private static readonly beforeInputRuleKeys = new Set([\r\n    \"number\",\r\n    \"integer\",\r\n    \"email\",\r\n    \"phone\",\r\n    \"letters\",\r\n    \"lettersSpaces\",\r\n    \"lettersNumbers\",\r\n    \"alpha\",\r\n    \"alpha_num\",\r\n    \"alpha_dash\",\r\n    \"digits\",\r\n    \"url\",\r\n    \"pattern\",\r\n  ]);\r\n\r\n  private static readonly crossFieldRuleKeys = new Set([\"same\", \"different\", \"after\", \"before\"]);\r\n\r\n  private static readonly serviceAttributePrefixes = [\"error\", \"group\"];\r\n\r\n  getInputKey(field: FormField, idx: number): string {\r\n    return (\r\n      this.tools.domAttribute.process({\r\n        element: field,\r\n        key: \"id\",\r\n      }) ||\r\n      field.getAttribute(\"name\") ||\r\n      field.getAttribute(\"id\") ||\r\n      `input-${idx}`\r\n    );\r\n  }\r\n\r\n  getFieldValue(field: FormField): any {\r\n    if (field instanceof HTMLInputElement) {\r\n      if (field.type === \"checkbox\") {\r\n        if (field.name) {\r\n          const form = field.form || field.closest(\"form\");\r\n          const checked = form\r\n            ? Array.from(\r\n                form.querySelectorAll<HTMLInputElement>(\r\n                  `input[type=\"checkbox\"][name=\"${field.name}\"]:checked`\r\n                )\r\n              )\r\n            : [field];\r\n          if (checked.length > 1) return checked.map((el) => el.value);\r\n          return checked.length === 1 ? checked[0].value : \"\";\r\n        }\r\n        return field.checked;\r\n      }\r\n      if (field.type === \"radio\") {\r\n        if (field.name) {\r\n          const form = field.form || field.closest(\"form\");\r\n          const checked = form?.querySelector<HTMLInputElement>(\r\n            `input[type=\"radio\"][name=\"${field.name}\"]:checked`\r\n          );\r\n          return checked ? checked.value : \"\";\r\n        }\r\n        return field.checked ? field.value : \"\";\r\n      }\r\n      if (field.type === \"file\") {\r\n        if (field.files && field.files.length > 0) {\r\n          return field.multiple ? Array.from(field.files) : field.files[0];\r\n        }\r\n        return field.value;\r\n      }\r\n      return field.value;\r\n    }\r\n    if (field instanceof HTMLSelectElement) {\r\n      if (field.multiple) {\r\n        return Array.from(field.selectedOptions).map((opt) => opt.value);\r\n      }\r\n      return field.value;\r\n    }\r\n    if (field instanceof HTMLTextAreaElement) {\r\n      return field.value;\r\n    }\r\n    return \"\";\r\n  }\r\n\r\n  private isServiceFieldAttribute(attr: string): boolean {\r\n    return StringForm.serviceAttributePrefixes.some((type) => attr.startsWith(`${type}[`));\r\n  }\r\n\r\n  private isFormFieldElement(element: Element): element is FormField {\r\n    return (\r\n      element instanceof HTMLInputElement ||\r\n      element instanceof HTMLSelectElement ||\r\n      element instanceof HTMLTextAreaElement\r\n    );\r\n  }\r\n\r\n  private getInputEventType(field: FormField): \"input\" | \"change\" {\r\n    if (\r\n      field instanceof HTMLSelectElement ||\r\n      (field instanceof HTMLInputElement && (field.type === \"checkbox\" || field.type === \"radio\"))\r\n    ) {\r\n      return \"change\";\r\n    }\r\n    return \"input\";\r\n  }\r\n}\r\n","import { StringObject } from \"../../objects/StringObject\";\r\n\r\ntype CenterState = {\r\n  cx: number;\r\n  cy: number;\r\n  valid: boolean;\r\n  ro?: ResizeObserver;\r\n  el?: HTMLElement;\r\n};\r\n\r\nexport class CenterCache {\r\n  private map = new WeakMap<StringObject, CenterState>();\r\n  private all: Set<StringObject> = new Set();\r\n\r\n  attach(obj: StringObject) {\r\n    if (this.map.has(obj)) return;\r\n    const el = obj.htmlElement;\r\n    const st: CenterState = { cx: 0, cy: 0, valid: false, el };\r\n    st.ro = new ResizeObserver(() => {\r\n      st.valid = false;\r\n    });\r\n    st.ro.observe(el);\r\n    this.map.set(obj, st);\r\n    this.all.add(obj);\r\n  }\r\n\r\n  detach(obj: StringObject) {\r\n    const st = this.map.get(obj);\r\n    if (!st) return;\r\n    st.ro?.disconnect();\r\n    this.map.delete(obj);\r\n    this.all.delete(obj);\r\n  }\r\n\r\n  invalidate(id: string) {\r\n    this.all.forEach((o) => {\r\n      if (o.id === id) {\r\n        const st = this.map.get(o);\r\n        if (st) st.valid = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  invalidateAll() {\r\n    this.all.forEach((o) => {\r\n      const st = this.map.get(o);\r\n      if (st) st.valid = false;\r\n    });\r\n  }\r\n\r\n  getCenter(obj: StringObject): { cx: number; cy: number } {\r\n    const st = this.map.get(obj);\r\n    if (!st || !st.el) return { cx: 0, cy: 0 };\r\n    if (!st.valid) {\r\n      const r = st.el.getBoundingClientRect();\r\n      st.cx = r.left + r.width / 2;\r\n      st.cy = r.top + r.height / 2;\r\n      st.valid = true;\r\n    }\r\n    return { cx: st.cx, cy: st.cy };\r\n  }\r\n}\r\n","import { StringObject } from \"../../objects/StringObject\";\n\ntype HoverState = { enter?: () => void; leave?: () => void };\n\nexport class HoverTracker {\n  private active = new Set<StringObject>();\n  private subs = new WeakMap<StringObject, HoverState>();\n\n  track(obj: StringObject) {\n    if (this.subs.has(obj)) return;\n    const el = obj.htmlElement;\n\n    const enter = () => this.active.add(obj);\n    const leave = () => this.active.delete(obj);\n\n    el.addEventListener(\"pointerenter\", enter);\n    el.addEventListener(\"pointerleave\", leave);\n    this.subs.set(obj, { enter, leave });\n  }\n\n  untrack(obj: StringObject) {\n    const st = this.subs.get(obj);\n    if (!st) return;\n    const el = obj.htmlElement;\n    if (st.enter) el.removeEventListener(\"pointerenter\", st.enter);\n    if (st.leave) el.removeEventListener(\"pointerleave\", st.leave);\n    this.active.delete(obj);\n    this.subs.delete(obj);\n  }\n\n  isActive(obj: StringObject) {\n    return this.active.has(obj);\n  }\n  activeObjects(): StringObject[] {\n    return Array.from(this.active);\n  }\n}\n","import { StringContext } from \"../../core/StringContext\";\nimport { StringData } from \"../../core/StringData\";\nimport { StringModule } from \"../../core/StringModule\";\nimport { StringObject } from \"../../objects/StringObject\";\n\nexport class StringScroller extends StringModule {\n  constructor(context: StringContext) {\n    super(context);\n    this.htmlKey = \"scroller\";\n  }\n\n  onObjectConnected(object: StringObject): void {\n    let isScrollInited = object.getProperty(\"scroller-inited\");\n    if (isScrollInited == null || isScrollInited == \"\") {\n      object.setProperty(\"scroller-inited\", \"inited\");\n      let wheelEvent = (event: Event) => {\n        this.events.emit(`wheel`, event);\n      };\n      object.setProperty(\"scroller-wheel-event\", wheelEvent);\n      object.htmlElement.addEventListener(\"wheel\", wheelEvent);\n    }\n  }\n  onObjectDisconnected(object: StringObject): void {\n    object.setProperty(\"scroller-inited\", \"\");\n    object.htmlElement.removeEventListener(\"wheel\", object.getProperty(\"scroller-wheel-event\"));\n  }\n}\n","export function parsePartOf(value: string): { id: string; start: number; end: number } | null {\n  const match = value.match(/([^[]+)\\[([\\d.]+)-([\\d.]+)\\]/);\n  if (!match) return null;\n  return {\n    id: match[1],\n    start: parseFloat(match[2]),\n    end: parseFloat(match[3]),\n  };\n}\n","import { StringContext } from \"../../core/StringContext\";\nimport { StringModule } from \"../../core/StringModule\";\nimport { StringObject } from \"../../objects/StringObject\";\nimport { parsePartOf } from \"../../utils/ParsePartOf\";\n\nfunction remap(value: number, from1: number, to1: number, from2: number, to2: number): number {\n  return from2 + ((to2 - from2) * (value - from1)) / (to1 - from1);\n}\n\nexport class StringProgressPart extends StringModule {\n  constructor(context: StringContext) {\n    super(context);\n    this.htmlKey = \"progress-part\";\n    this.attributesToMap = [\n      ...this.attributesToMap,\n      { key: \"part-of\", type: \"string\", fallback: \"\" },\n    ];\n  }\n\n  onObjectConnected(object: StringObject): void {\n    let partOfId = object.getProperty(\"part-of\");\n    let partOfData = parsePartOf(partOfId as string);\n    if (partOfData) {\n      object.setProperty(\"part-of-id\", partOfData.id);\n      object.setProperty(\"start\", partOfData.start);\n      object.setProperty(\"end\", partOfData.end);\n      let progressEvent = (progress: number) => {\n        if (partOfData) {\n          const sliceProgress = remap(progress, partOfData?.start, partOfData?.end, 0, 1);\n          const clampedProgress = Math.max(0, Math.min(1, sliceProgress));\n          object.htmlElement.style.setProperty(\"--progress-slice\", clampedProgress.toString());\n          this.events.emit(`object:progress-slice:${object.id}`, clampedProgress);\n        }\n      };\n      object.setProperty(\"progress-event\", progressEvent);\n      this.events.on(`object:progress:${partOfData.id}`, progressEvent);\n    }\n  }\n\n  onObjectDisconnected(object: StringObject): void {\n    let partOfId = object.getProperty(\"part-of-id\");\n    if (partOfId) {\n      this.events.off(`object:progress:${partOfId}`, object.getProperty<any>(\"progress-event\"));\n    }\n  }\n}\n","import { CursorController } from \"./core/controllers/CursorController\";\r\nimport { IStringModule } from \"./core/IStringModule\";\r\nimport { EventManager } from \"./core/managers/EventManager\";\r\nimport { ModuleManager } from \"./core/managers/ModuleManager\";\r\nimport { ObjectManager } from \"./core/managers/ObjectManager\";\r\nimport { ScrollManager } from \"./core/managers/ScrollManager\";\r\nimport { StringContext } from \"./core/StringContext\";\r\nimport { StringData } from \"./core/StringData\";\r\nimport { StringModule } from \"./core/StringModule\";\r\nimport { DefaultToolsContainer } from \"./core/StringToolsContainer\";\r\nimport { StringCursor } from \"./modules/cursor/StringCursor\";\r\nimport { StringImpulse } from \"./modules/cursor/StringImpulse\";\r\nimport { StringMagnetic } from \"./modules/cursor/StringMagnetic\";\r\nimport { StringSpotlight } from \"./modules/cursor/StringSpotlight\";\r\nimport { StringLazy } from \"./modules/loading/StringLazy\";\r\nimport { StringLoading } from \"./modules/loading/StringLoading\";\r\nimport { StringInview } from \"./modules/screen/StringInview\";\r\nimport { StringResponsive } from \"./modules/screen/StringResponsive\";\r\nimport { StringAnchor } from \"./modules/scroll/StringAnchor\";\r\nimport { StringGlide } from \"./modules/scroll/StringGlide\";\r\nimport { StringLerp } from \"./modules/scroll/StringLerp\";\r\nimport { StringParallax } from \"./modules/scroll/StringParallax\";\r\nimport { StringProgress } from \"./modules/scroll/StringProgress\";\r\nimport { StringScrollbar } from \"./modules/scrollbar/StringScrollbar\";\r\nimport { StringSplit } from \"./modules/text/StringSplit\";\r\nimport { StringDelayLerpTracker } from \"./modules/tracker/StringDelayLerpTracker\";\r\nimport { StringFPSTracker } from \"./modules/tracker/StringFPSTracker\";\r\nimport { StringLerpTracker } from \"./modules/tracker/StringLerpTracker\";\r\nimport { StringPositionTracker } from \"./modules/tracker/StringPositionTracker\";\r\nimport { StringObject } from \"./objects/StringObject\";\r\nimport { ScrollMode } from \"./states/ScrollState\";\r\nimport { Debounce } from \"./utils/Debounce\";\r\nimport { EventCallback } from \"./models/event/EventCallback\";\r\nimport { StringFPS } from \"./utils/StringFPS\";\r\nimport { StringSettings } from \"./utils/StringSettings\";\r\nimport { StringVideoAutoplay } from \"./modules/loading/StringVideoAutoplay\";\r\nimport { ScrollMarkRule } from \"./models/scroll/ScrollTriggerRule\";\r\nimport { StringSequence } from \"./modules/slider/StringSequence\";\r\nimport { StringForm } from \"./modules/input/StringForm\";\r\nimport { ISettingsChangeData } from \"./models/event/ISettingsChangeData\";\r\nimport { CenterCache } from \"./core/managers/CenterCache\";\r\nimport { HoverTracker } from \"./core/managers/HoverTracker\";\r\nimport { CursorReactiveModule } from \"./modules/cursor/CursorReactiveModule\";\r\nimport { StringScroller } from \"./modules/scroll/StringScroller\";\r\nimport { parsePartOf } from \"./utils/ParsePartOf\";\r\nimport { StringProgressPart } from \"./modules/scroll/StringProgressPart\";\r\nimport { frameDOM } from \"./utils/frame-dom\";\r\nimport { styleTxn } from \"./utils/style-txn\";\r\n\r\nfunction isTouchDevice() {\r\n  return \"ontouchstart\" in window || navigator.maxTouchPoints > 0;\r\n}\r\nfunction isSafari(): boolean {\r\n  let ua = navigator.userAgent.toLowerCase();\r\n  if (ua.indexOf(\"safari\") != -1) {\r\n    if (ua.indexOf(\"chrome\") > -1) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  } else {\r\n    return false;\r\n  }\r\n}\r\n\r\nclass StringTune {\r\n  /** Bound handler for the scroll start event */\r\n  private onScrollStartBind: any;\r\n\r\n  /** Bound handler for the scroll stop event */\r\n  private onScrollStopBind: any;\r\n\r\n  /** Bound handler for the scroll direction change event */\r\n  private onDirectionChangeBind: any;\r\n\r\n  /** Bound wheel event handler */\r\n  private onWheelBind: any;\r\n\r\n  /** Bound scroll event handler */\r\n  private onScrollBind: any;\r\n\r\n  /** Bound resize event handler */\r\n  private onResizeBind: any;\r\n\r\n  /** Bound mouse move handler */\r\n  private onMouseMoveBind: any;\r\n\r\n  private onContainerTransitionEndBind: any;\r\n  private onResizeObserverBind: any;\r\n\r\n  /** Singleton instance of StringTune */\r\n  private static i: StringTune;\r\n\r\n  /** Root scrollable element (typically <body>) */\r\n  private root: any;\r\n\r\n  /** Window object (used for event bindings and dimensions) */\r\n  private window: any;\r\n\r\n  /** Previous window width for resize diff check */\r\n  private prevWidth: number = 0;\r\n\r\n  /** Previous window height for resize diff check */\r\n  private prevHeight: number = 0;\r\n\r\n  /** Manages all modules registered in the system */\r\n  private moduleManager: ModuleManager;\r\n\r\n  /** Manages scroll modes and active scroll engine */\r\n  private scrollManager: ScrollManager;\r\n\r\n  /** Manages all interactive objects (elements with `string-*` attributes) */\r\n  private objectManager: ObjectManager;\r\n\r\n  /** Central event manager for internal pub-sub logic */\r\n  private eventManager: EventManager;\r\n\r\n  /** Handles custom cursor logic (if enabled) */\r\n  private cursorController: CursorController;\r\n\r\n  /** Provides default utility tools (parsers, interpolation, etc.) */\r\n  private tools: DefaultToolsContainer;\r\n\r\n  /** Main loop used for frame updates (with fixed FPS) */\r\n  private loop: StringFPS = new StringFPS();\r\n\r\n  /** Global reactive data store (scroll, viewport, etc.) */\r\n  private data: StringData;\r\n\r\n  /** Context shared across all modules (events, data, tools, settings) */\r\n  private context: StringContext;\r\n\r\n  /** Caches the center positions of string objects. */\r\n  private centers: CenterCache;\r\n\r\n  /** Tracks hover states of string objects. */\r\n  private hoverManager: HoverTracker;\r\n\r\n  private observerContainerResize: ResizeObserver | null = null;\r\n\r\n  public canRebuild: boolean = true;\r\n\r\n  /**\r\n   * Sets the scroll position manually.\r\n   * This overrides all internal scroll states including target and lerped values.\r\n   * Useful for programmatic jumps or syncing scroll externally.\r\n   *\r\n   * @param value The new scroll position in pixels.\r\n   */\r\n  public set scrollPosition(value: number) {\r\n    this.data.scroll.current = value;\r\n    this.data.scroll.target = value;\r\n    this.data.scroll.transformedCurrent =\r\n      this.data.scroll.current * this.data.viewport.transformScale;\r\n    this.data.scroll.delta = 0;\r\n    this.data.scroll.lerped = 0;\r\n    this.scrollManager.updatePosition();\r\n    this.moduleManager.onScroll();\r\n    this.objectManager.checkInview();\r\n  }\r\n\r\n  /**\r\n   * Configures the container element(s) used for scroll tracking.\r\n   * Accepts either the `Window` object or an `HTMLElement`.\r\n   * Determines the appropriate internal element references based on the input type\r\n   * and triggers a resize calculation.\r\n   *\r\n   * @param {Window | HTMLElement | any} container The target window or HTML element to associate with scrolling.\r\n   * Handles `Window`, `HTMLElement`, and potentially other types via fallback.\r\n   */\r\n  public set scrollContainer(container: any) {\r\n    this.observerContainerResize?.unobserve(this.context.data.scroll.container);\r\n\r\n    this.data.scroll.elementContainer.removeEventListener(\r\n      \"transitionend\",\r\n      this.onContainerTransitionEndBind\r\n    );\r\n    if (container instanceof Window) {\r\n      this.data.scroll.container = document.body;\r\n      this.data.scroll.elementContainer = document.documentElement;\r\n      this.data.scroll.scrollContainer = container;\r\n    } else if (container instanceof HTMLElement) {\r\n      this.data.scroll.container = container;\r\n      this.data.scroll.elementContainer = container;\r\n      this.data.scroll.scrollContainer = container;\r\n    } else {\r\n      // Fallback case\r\n      this.data.scroll.container = document.body;\r\n      this.data.scroll.elementContainer = document.documentElement;\r\n      this.data.scroll.scrollContainer = container;\r\n    }\r\n    this.data.scroll.elementContainer.addEventListener(\r\n      \"transitionend\",\r\n      this.onContainerTransitionEndBind\r\n    );\r\n    this.observerContainerResize?.observe(this.context.data.scroll.container);\r\n\r\n    this.debouncedResize();\r\n  }\r\n\r\n  /**\r\n   * Gets the current scroll position in pixels.\r\n   * This is typically updated every frame.\r\n   */\r\n  public get scrollPosition() {\r\n    return this.data.scroll.current;\r\n  }\r\n\r\n  public get scrollHeight() {\r\n    return this.data.viewport.contentHeight;\r\n  }\r\n\r\n  public get containerHeight() {\r\n    return this.data.viewport.windowHeight;\r\n  }\r\n\r\n  /**\r\n   * Sets the base scroll speed for smooth scrolling.\r\n   * Typically a value between 0 and 1.\r\n   */\r\n  public set speed(value: number) {\r\n    this.data.scroll.speed = value;\r\n  }\r\n\r\n  /**\r\n   * Sets the scroll acceleration using a normalized value from 0 to 1.\r\n   * Internally maps it to a real acceleration value between 0.1 and 0.5.\r\n   *\r\n   * @param speed A normalized acceleration factor (0 to 1).\r\n   */\r\n  public set speedAccelerate(speed: number) {\r\n    const min = 0.1;\r\n    const max = 0.5;\r\n    this.data.scroll.speedAccelerate = min + (max - min) * speed;\r\n  }\r\n\r\n  /**\r\n   * Sets the scroll mode for desktop devices.\r\n   * Can be 'smooth', 'default', or 'disable'.\r\n   */\r\n  public set scrollDesktopMode(mode: ScrollMode) {\r\n    this.scrollManager.setDesktopMode(mode);\r\n  }\r\n\r\n  /**\r\n   * Sets the scroll mode for mobile devices.\r\n   * Can be 'smooth', 'default', or 'disable'.\r\n   */\r\n  public set scrollMobileMode(mode: ScrollMode) {\r\n    this.scrollManager.setMobileMode(mode);\r\n  }\r\n\r\n  public set FPSTrackerVisible(visible: boolean) {\r\n    this.data.system.fpsTracker = visible;\r\n    this.eventManager.emit(\"tracker:fps:visible\", visible);\r\n  }\r\n\r\n  public set PositionTrackerVisible(visible: boolean) {\r\n    this.data.system.positionTracker = visible;\r\n    this.eventManager.emit(\"tracker:position:visible\", visible);\r\n  }\r\n\r\n  private debouncedResize = Debounce(this.onResize, 30);\r\n\r\n  private constructor() {\r\n    this.root = document.body;\r\n    this.window = window;\r\n\r\n    this.tools = new DefaultToolsContainer();\r\n    this.data = new StringData();\r\n    this.eventManager = new EventManager();\r\n    this.moduleManager = new ModuleManager(this.data);\r\n    this.objectManager = new ObjectManager(\r\n      this.data,\r\n      this.moduleManager,\r\n      this.eventManager,\r\n      this.tools\r\n    );\r\n\r\n    this.centers = new CenterCache();\r\n    this.hoverManager = new HoverTracker();\r\n\r\n    this.context = {\r\n      events: this.eventManager,\r\n      data: this.data,\r\n      tools: this.tools,\r\n      settings: {},\r\n      centers: this.centers,\r\n      hover: this.hoverManager,\r\n    };\r\n\r\n    this.cursorController = new CursorController(1, this.context);\r\n    this.scrollManager = new ScrollManager(this.context);\r\n\r\n    this.setupSettings({\r\n      \"global-class\": false,\r\n      \"offset-top\": \"0%\",\r\n      \"offset-bottom\": \"0%\",\r\n      key: \"--progress\",\r\n      \"inview-top\": \"0%\",\r\n      \"inview-bottom\": \"0%\",\r\n      \"enter-el\": \"top\",\r\n      \"enter-vp\": \"bottom\",\r\n      \"exit-el\": \"bottom\",\r\n      \"exit-vp\": \"top\",\r\n      \"parallax-bias\": \"0.0\",\r\n      parallax: \"0.2\",\r\n      lerp: \"0.2\",\r\n      \"cursor-lerp\": \"0.75\",\r\n      radius: \"150\",\r\n      strength: \"0.3\",\r\n      glide: \"1\",\r\n      anchor: \"center center\",\r\n      timeout: 900,\r\n      alignment: \"center\",\r\n      \"target-disable\": \"false\",\r\n      \"target-style-disable\": \"false\",\r\n      \"target-class\": \"\",\r\n      active: \"false\",\r\n      fixed: \"false\",\r\n      repeat: \"false\",\r\n      \"self-disable\": \"false\",\r\n      abs: \"false\",\r\n      easing: \"cubic-bezier(0.25, 0.25, 0.25, 0.25)\",\r\n      \"glide-base-velocity\": 0.00125,\r\n      \"glide-reduce-velocity\": 0.0000625,\r\n      \"glide-negative-velocity\": -0.0001,\r\n\r\n      \"position-strength\": 3,\r\n      \"position-tension\": 0.05,\r\n      \"position-friction\": 0.15,\r\n      \"position-max-velocity\": 10,\r\n      \"position-update-threshold\": 0.1,\r\n      \"rotation-strength\": 0.75,\r\n      \"rotation-tension\": 0.06,\r\n      \"rotation-friction\": 0.18,\r\n      \"rotation-max-angular-velocity\": 6,\r\n      \"rotation-max-angle\": 18,\r\n      \"rotation-update-threshold\": 0.15,\r\n      \"max-offset\": 220,\r\n      \"sleep-epsilon\": 0.01,\r\n      \"continuous-push\": true,\r\n    });\r\n\r\n    this.onContainerTransitionEndBind = this.onContainerTransitionEnd.bind(this);\r\n\r\n    this.onResizeObserverBind = this.onResizeObserverEvent.bind(this);\r\n    this.observerContainerResize = new ResizeObserver(this.onResizeObserverBind);\r\n    this.observerContainerResize.observe(this.context.data.scroll.container);\r\n\r\n    this.onWheelBind = this.onWheelEvent.bind(this);\r\n    this.onScrollBind = this.onScrollEvent.bind(this);\r\n    this.onResizeBind = this.onResize.bind(this);\r\n    this.onMouseMoveBind = this.onMouseMoveEvent.bind(this);\r\n\r\n    this.onScrollStartBind = this.onScrollStart.bind(this);\r\n    this.onScrollStopBind = this.onScrollStop.bind(this);\r\n    this.onDirectionChangeBind = this.onDirectionChange.bind(this);\r\n\r\n    this.eventManager.on(`wheel`, this.onWheelBind);\r\n\r\n    this.scrollManager.bindEvents({\r\n      onScrollStart: this.onScrollStartBind,\r\n      onScrollStop: this.onScrollStopBind,\r\n      onDirectionChange: this.onDirectionChangeBind,\r\n    });\r\n\r\n    this.loop.setOnFrame((time: number) => {\r\n      this.data.time.delta = time - this.data.time.now;\r\n      this.data.time.previous = this.data.time.now;\r\n      this.data.time.now = time;\r\n      this.data.time.elapsed += this.data.time.delta;\r\n      this.onUpdateEvent();\r\n    });\r\n    this.on(\"image:load:all\", () => {\r\n      this.onResize();\r\n    });\r\n\r\n    this.scrollContainer = window;\r\n  }\r\n\r\n  /**\r\n   * Returns the singleton instance of StringTune.\r\n   * If not already created, initializes it.\r\n   */\r\n  public static getInstance(): StringTune {\r\n    if (!StringTune.i) {\r\n      StringTune.i = new StringTune();\r\n    }\r\n    return StringTune.i;\r\n  }\r\n\r\n  /**\r\n   * Finds and returns an existing module by its class.\r\n   * Useful for reusing a module instance without re-registering.\r\n   *\r\n   * @template T The type of the module to retrieve.\r\n   * @param type The module class constructor.\r\n   * @returns The module instance if found, otherwise undefined.\r\n   */\r\n  public reuse<T>(type: new (...args: any[]) => T): T | undefined {\r\n    return this.moduleManager.find(type);\r\n  }\r\n\r\n  /**\r\n   * Instantiates and registers a new module.\r\n   * Accepts optional per-instance settings that override global settings.\r\n   *\r\n   * @param objectClass The module class to instantiate.\r\n   * @param settings Optional settings specific to this module.\r\n   */\r\n  public use(objectClass: typeof StringModule, settings: any = null) {\r\n    const effectiveSettings = {\r\n      ...this.context.settings,\r\n      ...settings,\r\n    };\r\n    const module = new objectClass({\r\n      events: this.eventManager,\r\n      data: this.data,\r\n      tools: this.tools,\r\n      settings: effectiveSettings,\r\n      centers: this.centers,\r\n      hover: this.hoverManager,\r\n    });\r\n    this.moduleManager.register(module);\r\n  }\r\n\r\n  /**\r\n   * Subscribes to a global event within the system.\r\n   *\r\n   * @param eventName The name of the event to listen for.\r\n   * @param callback The function to call when the event is triggered.\r\n   * @param id Optional subscription ID (for easier management).\r\n   */\r\n  public on(eventName: string, callback: EventCallback<any>, id: string = \"\") {\r\n    this.eventManager.on(eventName, callback, id);\r\n  }\r\n  public emit(eventName: string, data: any) {\r\n    this.eventManager.emit(eventName, data);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribes from a global event.\r\n   *\r\n   * @param eventName The name of the event.\r\n   * @param callback The previously registered callback.\r\n   * @param id Optional ID used during subscription.\r\n   */\r\n  public off(eventName: string, callback: EventCallback<any>, id: string = \"\") {\r\n    this.eventManager.off(eventName, callback, id);\r\n  }\r\n\r\n  /**\r\n   * Adds a scroll trigger rule that activates when the user scrolls past a defined offset\r\n   * in a specific direction. This can be used to toggle CSS classes or execute callbacks\r\n   * when elements come into view or go out of view.\r\n   *\r\n   * @param rule - The scroll trigger configuration object.\r\n   *   - `id`: A unique identifier for this rule.\r\n   *   - `offset`: The vertical scroll offset (in pixels) where the rule should activate.\r\n   *   - `direction`: Defines the scroll direction required to activate the rule.\r\n   *                 Can be `\"forward\"`, `\"backward\"`, or `\"any\"`.\r\n   *   - `onEnter`: (Optional) A function that will be called when the scroll position enters the trigger zone\r\n   *                in the specified direction.\r\n   *   - `onLeave`: (Optional) A function that will be called when the scroll position leaves the trigger zone\r\n   *                or scrolls in the opposite direction.\r\n   *   - `toggleClass`: (Optional) An object defining a class toggle behavior.\r\n   *                    It contains a target element and a class name to be added when the trigger is active\r\n   *                    and removed when it's not.\r\n   */\r\n  public addScrollMark(rule: ScrollMarkRule) {\r\n    this.scrollManager.addScrollMark(rule);\r\n  }\r\n\r\n  /**\r\n   * Removes a scroll trigger by its unique identifier.\r\n   *\r\n   * @param id - The unique identifier of the scroll trigger to be removed.\r\n   */\r\n  public removeScrollMark(id: string) {\r\n    this.scrollManager.removeScrollMark(id);\r\n  }\r\n\r\n  /**\r\n   * Starts the scroll engine and initializes all listeners, observers, and modules.\r\n   *\r\n   * @param fps Desired frames per second for the update loop.\r\n   */\r\n  public start(fps: number) {\r\n    this.data.scroll.scrollContainer?.addEventListener(\"scroll\", this.onScrollBind);\r\n    this.data.scroll.container?.addEventListener(\"wheel\", this.onWheelBind, {\r\n      passive: false,\r\n    });\r\n\r\n    window.addEventListener(\"resize\", this.onResizeBind);\r\n    this.root.addEventListener(\"mousemove\", this.onMouseMoveBind);\r\n\r\n    const observerContainerMutation = new MutationObserver(\r\n      (mutationsList: MutationRecord[], observer: MutationObserver) => {\r\n        for (const mutation of mutationsList) {\r\n          if (\r\n            mutation.type === \"attributes\" &&\r\n            (mutation.attributeName === \"style\" || mutation.attributeName === \"class\")\r\n          ) {\r\n            this.onResize();\r\n          }\r\n        }\r\n      }\r\n    );\r\n    const config: MutationObserverInit = {\r\n      attributes: true,\r\n      attributeFilter: [\"style\", \"class\"],\r\n    };\r\n    observerContainerMutation.observe(this.context.data.scroll.container, config);\r\n\r\n    this.use(StringInview);\r\n\r\n    const htmlFontSize = window.getComputedStyle(document.documentElement).fontSize;\r\n    const fontSizeNumber = parseFloat(htmlFontSize);\r\n    this.context.data.viewport.baseRem = fontSizeNumber;\r\n\r\n    document.documentElement.classList.add(\"-string\");\r\n    this.moduleManager.onInit();\r\n    this.onResize();\r\n    this.initObjects();\r\n    this.objectManager.observeDOM();\r\n\r\n    this.loop.start(fps);\r\n    this.eventManager.emit(`start`, null);\r\n  }\r\n\r\n  /**\r\n   * Initializes all DOM elements with `string` or `string-copy-from` attributes.\r\n   * Registers them with the object manager and triggers resize/scroll/frame hooks.\r\n   */\r\n  private initObjects() {\r\n    document.querySelectorAll(\"[string],[data-string]\").forEach((element) => {\r\n      this.objectManager.add(element as HTMLElement);\r\n    });\r\n    document.querySelectorAll(\"[string-copy-from],[data-string-copy-from]\").forEach((element) => {\r\n      let connectTargetId = this.tools.domAttribute.process({\r\n        element: element as HTMLElement,\r\n        key: \"copy-from\",\r\n        fallback: \"\",\r\n      });\r\n\r\n      if (connectTargetId && connectTargetId.length > 0) {\r\n        this.objectManager.linkMirror(connectTargetId, element as HTMLElement);\r\n      }\r\n    });\r\n    // document.querySelectorAll(\"[string-part-of],[data-string-part-of]\").forEach((element) => {\r\n    //   let partOfTargetId = this.tools.domAttribute.process({\r\n    //     element: element as HTMLElement,\r\n    //     key: \"part-of\",\r\n    //     fallback: \"\",\r\n    //   });\r\n    //   let partOfData = parsePartOf(partOfTargetId as string);\r\n    //   if (partOfData) {\r\n    //     if (partOfData.id && partOfData.id.length > 0) {\r\n    //       if (this.objectManager.all.has(partOfData.id)) {\r\n    //         let partOfObject = new StringObject(\"\", element as HTMLElement);\r\n    //         partOfObject.setProperty(\"part-of-id\", partOfData.id);\r\n    //         partOfObject.setProperty(\"start\", partOfData.start);\r\n    //         partOfObject.setProperty(\"end\", partOfData.end);\r\n\r\n    //         this.objectManager.all.get(partOfData.id)!.partOf.push(partOfObject);\r\n    //       } else {\r\n    //         this.objectManager.enqueuePartOf(partOfData.id, element as HTMLElement);\r\n    //       }\r\n    //     }\r\n    //   }\r\n    // });\r\n    this.moduleManager.onResize();\r\n    this.moduleManager.onScroll();\r\n    this.moduleManager.onFrame();\r\n  }\r\n\r\n  /**\r\n   * Sets global fallback settings for all modules.\r\n   * These can be overridden by module-specific settings during `use(...)`.\r\n   *\r\n   * @param settings A key-value map of default settings (e.g. 'offset-top': '-10%').\r\n   */\r\n  public setupSettings(settings: StringSettings): void {\r\n    this.context.settings = {\r\n      ...this.context.settings,\r\n      ...settings,\r\n    };\r\n    this.onSettingsChange({\r\n      isDesktop: this.data.viewport.windowWidth > 1024,\r\n      widthChanged: true,\r\n      heightChanged: true,\r\n      scrollHeightChanged: true,\r\n      isForceRebuild: false,\r\n    });\r\n  }\r\n\r\n  private onResizeObserverEvent() {\r\n    this.debouncedResize();\r\n  }\r\n\r\n  private onContainerTransitionEnd(event: TransitionEvent) {\r\n    if (event.target === this.context.data.scroll.container) {\r\n      this.onResize();\r\n      this.moduleManager.onResize();\r\n      this.moduleManager.onScroll();\r\n      this.moduleManager.onFrame();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles mouse move event and dispatches it to cursor and modules.\r\n   * @param e Native mouse move event.\r\n   */\r\n  private onMouseMoveEvent(e: MouseEvent) {\r\n    this.cursorController.onMouseMove(e);\r\n    this.moduleManager.onMouseMove(e);\r\n    frameDOM.measure(() => {\r\n      this.moduleManager.onMouseMoveMeasure();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handles wheel scroll event and passes it to the scroll engine and modules.\r\n   * @param e Native wheel event.\r\n   */\r\n  private onWheelEvent(e: WheelEvent) {\r\n    const target = e.target as HTMLElement;\r\n    const isModal = target.closest(\"[string-isolation],[data-string-isolation]\");\r\n    if (isModal != null) return;\r\n\r\n    this.scrollManager.get().onWheel(e);\r\n    this.moduleManager.onWheel(e);\r\n  }\r\n\r\n  /**\r\n   * Called when scrolling begins.\r\n   * Triggers module scroll start lifecycle hook.\r\n   */\r\n  private onScrollStart() {\r\n    this.moduleManager.onScrollStart();\r\n    this.eventManager.emit(`scroll:start`, null);\r\n  }\r\n\r\n  /**\r\n   * Called when scrolling ends.\r\n   * Triggers module scroll stop lifecycle hook.\r\n   */\r\n  private onScrollStop() {\r\n    this.moduleManager.onScrollStop();\r\n    this.eventManager.emit(`scroll:stop`, null);\r\n  }\r\n\r\n  /**\r\n   * Called when scrolling ends.\r\n   * Triggers module scroll stop lifecycle hook.\r\n   */\r\n  private onDirectionChange() {\r\n    this.moduleManager.onDirectionChange();\r\n  }\r\n\r\n  /**\r\n   * Called when global or module settings are updated.\r\n   * Notifies all managers and modules to re-read new settings.\r\n   */\r\n  private onSettingsChange(data: ISettingsChangeData) {\r\n    this.cursorController.onSettingsChange(data);\r\n    this.objectManager.onSettingsChange(data);\r\n    this.moduleManager.onSettingsChange(data);\r\n  }\r\n\r\n  /**\r\n   * Handles native scroll event.\r\n   * Prevents default behavior and triggers internal scroll logic and event emissions.\r\n   *\r\n   * @param e The native scroll event.\r\n   */\r\n  private onScrollEvent(e: Event) {\r\n    e.preventDefault();\r\n\r\n    this.context.centers.invalidateAll();\r\n\r\n    this.scrollManager.get().onScroll(e);\r\n    this.moduleManager.onScroll();\r\n    this.objectManager.checkInview();\r\n    this.eventManager.emit(`lerp`, this.data.scroll.lerped);\r\n    this.eventManager.emit(`scroll`, this.data.scroll.current);\r\n\r\n    frameDOM.measure(() => {\r\n      this.moduleManager.onScrollMeasure();\r\n    });\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Called every frame by the update loop.\r\n   * Triggers scroll engine, modules, and global `update` event.\r\n   */\r\n  private onUpdateEvent() {\r\n    this.cursorController.onFrame();\r\n    this.scrollManager.get().onFrame();\r\n    this.moduleManager.onFrame();\r\n\r\n    frameDOM.mutate(() => {\r\n      styleTxn.begin();\r\n      this.moduleManager.onMutate();\r\n      styleTxn.commit();\r\n    });\r\n\r\n    this.eventManager.emit(`update`, null);\r\n  }\r\n\r\n  /**\r\n   * Handles resize events from scroll container or window.\r\n   * Ignores height-only changes on mobile to prevent layout jumps.\r\n   * Rebuilds layout and triggers module resize if size really changed.\r\n   */\r\n  public onResize(force: boolean = false): void {\r\n    if (this.canRebuild == false) {\r\n      return;\r\n    }\r\n\r\n    const container = this.data.scroll.container;\r\n    const scroll = this.context.data.scroll;\r\n    let width = 0;\r\n    let height = 0;\r\n    var newScrollHeight;\r\n    var newContainerTopPosition = 0;\r\n    const rect = container.getBoundingClientRect();\r\n\r\n    if (container.tagName == \"BODY\") {\r\n      width = window.innerWidth;\r\n      height = window.innerHeight;\r\n    } else {\r\n      width = rect.width;\r\n      height = rect.height;\r\n    }\r\n\r\n    newContainerTopPosition = rect.top;\r\n    newScrollHeight = scroll.container.scrollHeight;\r\n    const transformScale = this.tools.transformScaleParser.process({\r\n      value: window.getComputedStyle(container).transform,\r\n    });\r\n    this.context.data.viewport.transformScale =\r\n      window.getComputedStyle(container).scale == \"none\"\r\n        ? transformScale\r\n        : Number(window.getComputedStyle(container).scale);\r\n    this.context.data.scroll.transformedCurrent =\r\n      this.context.data.scroll.current * this.context.data.viewport.transformScale;\r\n    const isDesktop = width > 1024;\r\n\r\n    const widthChanged = this.prevWidth !== width;\r\n    const heightChanged = this.prevHeight !== height;\r\n    const scrollHeightChanged = this.context.data.viewport.contentHeight !== newScrollHeight;\r\n\r\n    const shouldRebuild = widthChanged || (isDesktop && heightChanged) || scrollHeightChanged;\r\n\r\n    this.context.data.scroll.topPosition = Math.floor(newContainerTopPosition);\r\n    this.context.data.viewport.contentWidth = width;\r\n    this.context.data.viewport.contentHeight = newScrollHeight;\r\n\r\n    this.prevWidth = width;\r\n    this.prevHeight = height;\r\n\r\n    this.context.data.viewport.windowWidth = width;\r\n    this.context.data.viewport.windowHeight = height;\r\n\r\n    const htmlFontSize = window.getComputedStyle(document.documentElement).fontSize;\r\n    const fontSizeNumber = parseFloat(htmlFontSize);\r\n    this.context.data.viewport.baseRem = fontSizeNumber * transformScale;\r\n\r\n    scroll.bottomPosition = this.context.data.viewport.contentHeight - height;\r\n\r\n    if (widthChanged || (typeof force === \"boolean\" && force)) {\r\n      this.moduleManager.onResizeWidth();\r\n    }\r\n    if (shouldRebuild || (typeof force === \"boolean\" && force)) {\r\n      if (this.context.data.scroll.container.scrollTop > 0) {\r\n        this.context.data.scroll.current = this.context.data.scroll.container.scrollTop;\r\n        this.context.data.scroll.target = this.context.data.scroll.container.scrollTop;\r\n      }\r\n\r\n      this.scrollManager.updateResponsiveMode();\r\n      this.moduleManager.onResize();\r\n      this.onSettingsChange({\r\n        isDesktop,\r\n        widthChanged,\r\n        heightChanged,\r\n        scrollHeightChanged,\r\n        isForceRebuild: force === true,\r\n      });\r\n      this.moduleManager.onScroll();\r\n      this.moduleManager.onScrollMeasure();\r\n      this.moduleManager.onFrame();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Scrolls the container to the specified element identified by a CSS selector, applying an optional offset.\r\n   *\r\n   * Calculates the vertical position of the target element relative to the scroll container and updates the scroll delta accordingly.\r\n   * If the element is not found, a warning is logged to the console.\r\n   *\r\n   * @param selector - The CSS selector string used to identify the target element.\r\n   * @param offset - Optional. The number of pixels to offset from the target element's top position. Defaults to 0.\r\n   */\r\n  public scrollToElement(selector: string, offset: number = 0) {\r\n    const element = document.querySelector(selector);\r\n    if (element) {\r\n      const rect = element.getBoundingClientRect();\r\n      const scrollTop =\r\n        rect.top + window.pageYOffset - this.data.scroll.container.clientTop - offset;\r\n      this.context.data.scroll.delta = scrollTop - this.data.scroll.current;\r\n    } else {\r\n      console.warn(`Element not found: ${selector}`);\r\n    }\r\n  }\r\n\r\n  public scrollTo(position: number) {\r\n    this.scrollManager.get().scrollTo(position);\r\n  }\r\n\r\n  public invalidateCenter(id: string): void {\r\n    this.centers.invalidate(id);\r\n  }\r\n\r\n  /**\r\n   * Forces center cache recalculation for all tracked objects.\r\n   * Useful when DOM geometry changes outside of StringTune's control.\r\n   */\r\n  public invalidateCenters(): void {\r\n    this.centers.invalidateAll();\r\n  }\r\n\r\n  /**\r\n   * Cleans up the system, removes all event listeners, stops the loop,\r\n   * and destroys modules and event subscriptions.\r\n   */\r\n  public destroy() {\r\n    this.data.scroll.scrollContainer?.removeEventListener(\"scroll\", this.onScrollBind);\r\n    this.data.scroll.container?.removeEventListener(\"wheel\", this.onWheelBind);\r\n    this.data.scroll.elementContainer.removeEventListener(\r\n      \"transitionend\",\r\n      this.onContainerTransitionEndBind\r\n    );\r\n    this.window.removeEventListener(\"resize\", this.onResizeBind);\r\n    this.root.removeEventListener(\"mousemove\", this.onMouseMoveBind);\r\n    this.loop.stop();\r\n    this.moduleManager.destroy();\r\n    this.eventManager.clearAll();\r\n    this.eventManager.off(`wheel`, this.onWheelBind);\r\n  }\r\n}\r\n\r\nexport {\r\n  StringTune as default,\r\n  StringCursor,\r\n  StringDelayLerpTracker,\r\n  StringFPSTracker,\r\n  StringGlide,\r\n  StringLazy,\r\n  StringLerp,\r\n  StringLerpTracker,\r\n  StringLoading,\r\n  StringForm,\r\n  StringImpulse,\r\n  StringMagnetic,\r\n  StringParallax,\r\n  StringPositionTracker,\r\n  StringProgress,\r\n  StringResponsive,\r\n  StringSpotlight,\r\n  StringScrollbar,\r\n  StringSplit,\r\n  StringAnchor,\r\n  StringTune as StringTune,\r\n  StringVideoAutoplay,\r\n  StringModule,\r\n  StringObject,\r\n  StringData,\r\n  StringSequence,\r\n  StringScroller,\r\n  StringProgressPart,\r\n  CursorReactiveModule,\r\n  frameDOM,\r\n  styleTxn,\r\n  type ScrollMarkRule as ScrollTriggerRule,\r\n  type StringContext,\r\n};\r\n","import { I3DEngine, I3DVector3, I3DCamera } from \"./abstractions/I3DEngine\";\r\n\r\nexport type CameraMode = \"orthographic\" | \"perspective\";\r\n\r\nexport class String3DCamera {\r\n  private scaleCache = new Map<number, number>();\r\n  private _camera: I3DCamera;\r\n  private _position: I3DVector3;\r\n  private _width = 1;\r\n  private _height = 1;\r\n  private engine: I3DEngine;\r\n  private mode: CameraMode;\r\n  private perspectiveFov: number;\r\n\r\n  constructor(\r\n    engine: I3DEngine,\r\n    mode: CameraMode = \"perspective\",\r\n    fov = 50,\r\n    near = 0.1,\r\n    far = 10000\r\n  ) {\r\n    this.engine = engine;\r\n    this.mode = mode;\r\n    this.perspectiveFov = fov;\r\n\r\n    if (mode === \"orthographic\") {\r\n      this._camera = engine.createOrthographicCamera(-1, 1, 1, -1, near, far);\r\n    } else {\r\n      this._camera = engine.createPerspectiveCamera(fov, 1, near, far);\r\n    }\r\n\r\n    this._position = engine.createVector3(0, 0, 1000);\r\n    this.update();\r\n  }\r\n\r\n  public get camera(): I3DCamera {\r\n    return this._camera;\r\n  }\r\n\r\n  public resize(width: number, height: number): void {\r\n    this._width = width;\r\n    this._height = height;\r\n\r\n    if (this.mode === \"orthographic\") {\r\n      const ortho = this._camera as any;\r\n      ortho.left = -width / 2;\r\n      ortho.right = width / 2;\r\n      ortho.top = height / 2;\r\n      ortho.bottom = -height / 2;\r\n    } else {\r\n      this._camera.aspect = width / height;\r\n    }\r\n\r\n    this.update();\r\n  }\r\n\r\n  public setPosition(x: number, y: number, z: number): void {\r\n    this._position.set(x, y, z);\r\n    this._camera.position.copy(this._position);\r\n    this.update();\r\n  }\r\n\r\n  public lookAt(x: number, y: number, z: number): void {\r\n    this._camera.lookAt(x, y, z);\r\n    this.update();\r\n  }\r\n\r\n  public update(): void {\r\n    this._camera.updateProjectionMatrix();\r\n    (this._camera as any).updateMatrixWorld?.();\r\n  }\r\n\r\n  public screenToWorld(screenX: number, screenY: number, z = 0): I3DVector3 {\r\n    if (this.mode === \"orthographic\") {\r\n      const x = screenX - this._width / 2;\r\n      const y = -(screenY - this._height / 2);\r\n      return this.engine.createVector3(x, y, z);\r\n    } else {\r\n      const { width, height } = this.getFrustumSizeAt(z);\r\n      const normalizedX = screenX / this._width;\r\n      const normalizedY = screenY / this._height;\r\n      const x = (normalizedX - 0.5) * width;\r\n      const y = -(normalizedY - 0.5) * height;\r\n      return this.engine.createVector3(x, y, z);\r\n    }\r\n  }\r\n\r\n  public getFrustumSizeAt(z: number): { width: number; height: number } {\r\n    if (this.mode === \"orthographic\") {\r\n      return { width: this._width, height: this._height };\r\n    }\r\n\r\n    const fov = this.engine.degToRad(this.perspectiveFov);\r\n    const distance = Math.abs(z - this._camera.position.z);\r\n    const height = 2 * Math.tan(fov / 2) * distance;\r\n    const width = height * this._camera.aspect;\r\n    return { width, height };\r\n  }\r\n\r\n  public getScaleAtZ(z: number, viewportHeight: number): number {\r\n    if (this.mode === \"orthographic\") {\r\n      return 1;\r\n    }\r\n\r\n    const roundedZ = Math.round(z * 1000) / 1000;\r\n    if (this.scaleCache.has(roundedZ)) {\r\n      return this.scaleCache.get(roundedZ)!;\r\n    }\r\n\r\n    const { height } = this.getFrustumSizeAt(z);\r\n    const scale = height / viewportHeight;\r\n    this.scaleCache.set(roundedZ, scale);\r\n    return scale;\r\n  }\r\n\r\n  public clearScaleCache(): void {\r\n    this.scaleCache.clear();\r\n  }\r\n\r\n  public getMode(): CameraMode {\r\n    return this.mode;\r\n  }\r\n\r\n  public getPerspectiveFov(): number {\r\n    return this.perspectiveFov;\r\n  }\r\n\r\n  public getPositionZ(): number {\r\n    return this._position.z;\r\n  }\r\n}\r\n","export type String3DCustomFilterDefinition = {\n  name: string;\n  fragmentShader: string;\n  uniforms?: Record<string, any>;\n  parse?: (args: string) => Record<string, any> | null;\n};\n\nexport class String3DCustomFilterRegistry {\n  private static filters: Map<string, String3DCustomFilterDefinition> = new Map();\n\n  static register(definition: String3DCustomFilterDefinition): void {\n    const name = definition.name.trim().toLowerCase();\n    if (!name) {\n      throw new Error(\"[String3D] Custom filter name is required.\");\n    }\n    this.filters.set(name, { ...definition, name });\n  }\n\n  static get(name: string): String3DCustomFilterDefinition | undefined {\n    return this.filters.get(name.trim().toLowerCase());\n  }\n\n  static has(name: string): boolean {\n    return this.filters.has(name.trim().toLowerCase());\n  }\n\n  static list(): String3DCustomFilterDefinition[] {\n    return Array.from(this.filters.values());\n  }\n}\n","import {\n  I3DEngine,\n  I3DRenderer,\n  I3DRenderTarget,\n  I3DScene,\n  I3DCamera,\n  I3DMaterial,\n  I3DObject,\n} from \"../abstractions/I3DEngine\";\nimport type { String3DFilterChain } from \"./String3DFilterTypes\";\nimport { String3DCustomFilterRegistry } from \"./String3DCustomFilter\";\n\ntype RenderTargetFactory = (width: number, height: number) => I3DRenderTarget;\n\nclass RenderTargetPool {\n  private pool: I3DRenderTarget[] = [];\n  private create: RenderTargetFactory;\n\n  constructor(create: RenderTargetFactory) {\n    this.create = create;\n  }\n\n  acquire(width: number, height: number): I3DRenderTarget {\n    const target = this.pool.pop() || this.create(width, height);\n    if (target.width !== width || target.height !== height) {\n      target.setSize(width, height);\n    }\n    return target;\n  }\n\n  release(target: I3DRenderTarget): void {\n    this.pool.push(target);\n  }\n\n  dispose(): void {\n    this.pool.forEach((target) => target.dispose());\n    this.pool = [];\n  }\n}\n\nexport class String3DFilterPipeline {\n  private engine: I3DEngine;\n  private renderer: I3DRenderer;\n  private width: number;\n  private height: number;\n  private scale = 1;\n  private scene: I3DScene;\n  private camera: I3DCamera;\n  private quad: I3DObject;\n  private copyMaterial: I3DMaterial;\n  private blurMaterial: I3DMaterial;\n  private pixelMaterial: I3DMaterial;\n  private bloomExtractMaterial: I3DMaterial;\n  private bloomAddMaterial: I3DMaterial;\n  private colorMaterial: I3DMaterial;\n  private customMaterials: Map<string, I3DMaterial> = new Map();\n  private pool: RenderTargetPool;\n\n  constructor(engine: I3DEngine, renderer: I3DRenderer, width: number, height: number) {\n    this.engine = engine;\n    this.renderer = renderer;\n    this.width = width;\n    this.height = height;\n\n    this.scene = engine.createScene();\n    this.camera = engine.createOrthographicCamera(-1, 1, 1, -1, 0, 1);\n\n    const geometry = engine.createPlaneGeometry(2, 2);\n    this.copyMaterial = this.createCopyMaterial();\n    this.blurMaterial = this.createBlurMaterial();\n    this.pixelMaterial = this.createPixelMaterial();\n    this.bloomExtractMaterial = this.createBloomExtractMaterial();\n    this.bloomAddMaterial = this.createBloomAddMaterial();\n    this.colorMaterial = this.createColorMaterial();\n\n    this.quad = engine.createMesh(geometry, this.copyMaterial);\n    this.scene.add(this.quad);\n\n    const create = (w: number, h: number) => {\n      if (!this.engine.createRenderTarget) {\n        throw new Error(\"[String3DFilterPipeline] Render target support missing.\");\n      }\n      return this.engine.createRenderTarget(w, h);\n    };\n    this.pool = new RenderTargetPool(create);\n  }\n\n  public isSupported(): boolean {\n    return (\n      !!this.engine.createRenderTarget &&\n      !!this.engine.createShaderMaterial &&\n      !!this.renderer.setRenderTarget\n    );\n  }\n\n  public resize(width: number, height: number): void {\n    this.width = width;\n    this.height = height;\n  }\n\n  public setScale(scale: number): void {\n    const next = Math.max(0.75, Math.min(1, scale));\n    this.scale = next;\n  }\n\n  public applyFilters(\n    input: I3DRenderTarget,\n    effects: String3DFilterChain,\n    quality = 1\n  ): I3DRenderTarget {\n    let current = input;\n    const locals: I3DRenderTarget[] = [];\n\n    const releaseLocal = (target: I3DRenderTarget): void => {\n      const idx = locals.indexOf(target);\n      if (idx >= 0) {\n        locals.splice(idx, 1);\n        this.pool.release(target);\n      }\n    };\n\n    const acquire = (): I3DRenderTarget => {\n      const { width, height } = this.getScaledSize();\n      const target = this.pool.acquire(width, height);\n      locals.push(target);\n      return target;\n    };\n\n    effects.forEach((effect) => {\n      if (effect.type === \"blur\") {\n        const radius = effect.amount * quality;\n        if (radius <= 0.0001) return;\n        const first = acquire();\n        this.renderPass(this.blurMaterial, current, first, {\n          uDirection: [1, 0],\n          uRadius: radius,\n        });\n        const second = acquire();\n        this.renderPass(this.blurMaterial, first, second, {\n          uDirection: [0, 1],\n          uRadius: radius,\n        });\n        releaseLocal(first);\n        if (current !== input) {\n          releaseLocal(current);\n        }\n        current = second;\n      } else if (effect.type === \"pixel\") {\n        if (effect.size <= 0.5) return;\n        const output = acquire();\n        this.renderPass(this.pixelMaterial, current, output, {\n          uPixelSize: effect.size,\n        });\n        if (current !== input) {\n          releaseLocal(current);\n        }\n        current = output;\n      } else if (effect.type === \"bloom\") {\n        const intensity = effect.intensity;\n        if (intensity <= 0.0001) return;\n        if (effect.threshold >= 0.99) return;\n        const blurRadius = Math.max(1, 4 * quality);\n        const extracted = acquire();\n        this.renderPass(this.bloomExtractMaterial, current, extracted, {\n          uThreshold: effect.threshold,\n        });\n\n        const blur1 = acquire();\n        this.renderPass(this.blurMaterial, extracted, blur1, {\n          uDirection: [1, 0],\n          uRadius: blurRadius,\n        });\n        const blur2 = acquire();\n        this.renderPass(this.blurMaterial, blur1, blur2, {\n          uDirection: [0, 1],\n          uRadius: blurRadius,\n        });\n\n        releaseLocal(extracted);\n        releaseLocal(blur1);\n\n        const combined = acquire();\n        this.renderAddPass(current, blur2, combined, intensity);\n        releaseLocal(blur2);\n\n        if (current !== input) {\n          releaseLocal(current);\n        }\n        current = combined;\n      } else if (\n        effect.type === \"brightness\" ||\n        effect.type === \"contrast\" ||\n        effect.type === \"saturate\" ||\n        effect.type === \"grayscale\" ||\n        effect.type === \"sepia\" ||\n        effect.type === \"invert\" ||\n        effect.type === \"hue-rotate\"\n      ) {\n        const output = acquire();\n        const mode = this.getColorMode(effect.type);\n        const amount = effect.type === \"hue-rotate\" ? effect.angle : effect.amount;\n        this.renderPass(this.colorMaterial, current, output, {\n          uMode: mode,\n          uAmount: amount,\n        });\n        if (current !== input) {\n          releaseLocal(current);\n        }\n        current = output;\n      } else if (effect.type === \"custom\") {\n        const output = acquire();\n        const material = this.getCustomMaterial(effect.name);\n        if (material) {\n          this.renderPass(material, current, output, effect.uniforms);\n          if (current !== input) {\n            releaseLocal(current);\n          }\n          current = output;\n        } else {\n          releaseLocal(output);\n        }\n      }\n    });\n\n    locals.forEach((target) => {\n      if (target !== current) {\n        this.pool.release(target);\n      }\n    });\n\n    return current;\n  }\n\n  public acquireTarget(): I3DRenderTarget {\n    const { width, height } = this.getScaledSize();\n    return this.pool.acquire(width, height);\n  }\n\n  public releaseTarget(target: I3DRenderTarget): void {\n    this.pool.release(target);\n  }\n\n  public renderToScreen(input: I3DRenderTarget): void {\n    this.renderPass(this.copyMaterial, input, null, {}, false);\n  }\n\n  public dispose(): void {\n    this.pool.dispose();\n    this.customMaterials.forEach((material) => material.dispose());\n    this.customMaterials.clear();\n  }\n\n  private renderPass(\n    material: I3DMaterial,\n    input: I3DRenderTarget,\n    output: I3DRenderTarget | null,\n    uniforms: Record<string, any> = {},\n    clear = true\n  ): void {\n    const renderer = this.renderer as any;\n    if (renderer.setRenderTarget) {\n      renderer.setRenderTarget(output);\n    }\n\n    this.setMaterial(this.quad, material);\n    this.setUniform(material, \"tDiffuse\", input.texture);\n    const { width, height } = this.getScaledSize();\n    this.setUniform(material, \"uResolution\", [width, height]);\n    this.setUniform(material, \"uTexel\", [1 / width, 1 / height]);\n    Object.entries(uniforms).forEach(([key, value]) => this.setUniform(material, key, value));\n\n    if (clear && renderer.clear) {\n      renderer.clear(true, true, true);\n    }\n    this.renderer.render(this.scene, this.camera);\n  }\n\n  private renderAddPass(\n    base: I3DRenderTarget,\n    bloom: I3DRenderTarget,\n    output: I3DRenderTarget,\n    intensity: number\n  ): void {\n    const renderer = this.renderer as any;\n    if (renderer.setRenderTarget) {\n      renderer.setRenderTarget(output);\n    }\n\n    this.setMaterial(this.quad, this.bloomAddMaterial);\n    this.setUniform(this.bloomAddMaterial, \"tBase\", base.texture);\n    this.setUniform(this.bloomAddMaterial, \"tBloom\", bloom.texture);\n    this.setUniform(this.bloomAddMaterial, \"uIntensity\", intensity);\n    const { width, height } = this.getScaledSize();\n    this.setUniform(this.bloomAddMaterial, \"uResolution\", [width, height]);\n\n    if (renderer.clear) {\n      renderer.clear(true, true, true);\n    }\n    this.renderer.render(this.scene, this.camera);\n  }\n\n  private setMaterial(object: I3DObject, material: I3DMaterial): void {\n    const anyObj = object as any;\n    if (anyObj.material !== material) {\n      anyObj.material = material as any;\n    }\n  }\n\n  private setUniform(material: I3DMaterial, name: string, value: any): void {\n    const uniforms = (material as any).uniforms;\n    if (!uniforms) return;\n    if (!uniforms[name]) {\n      uniforms[name] = { value };\n    } else {\n      uniforms[name].value = value;\n    }\n  }\n\n  private createCopyMaterial(): I3DMaterial {\n    return this.createShaderMaterial({\n      uniforms: { tDiffuse: { value: null } },\n      vertexShader: this.getVertexShader(),\n      fragmentShader: `\n        varying vec2 vUv;\n        uniform sampler2D tDiffuse;\n        void main() {\n          gl_FragColor = texture2D(tDiffuse, vUv);\n        }\n      `,\n      transparent: true,\n      depthTest: false,\n      depthWrite: false,\n    });\n  }\n\n  private createPixelMaterial(): I3DMaterial {\n    return this.createShaderMaterial({\n      uniforms: {\n        tDiffuse: { value: null },\n        uResolution: { value: [this.width, this.height] },\n        uPixelSize: { value: 1 },\n      },\n      vertexShader: this.getVertexShader(),\n      fragmentShader: `\n        varying vec2 vUv;\n        uniform sampler2D tDiffuse;\n        uniform vec2 uResolution;\n        uniform float uPixelSize;\n        void main() {\n          vec2 pixel = uPixelSize / uResolution;\n          vec2 coord = floor(vUv / pixel) * pixel + pixel * 0.5;\n          gl_FragColor = texture2D(tDiffuse, coord);\n        }\n      `,\n      transparent: true,\n      depthTest: false,\n      depthWrite: false,\n    });\n  }\n\n  private createBlurMaterial(): I3DMaterial {\n    return this.createShaderMaterial({\n      uniforms: {\n        tDiffuse: { value: null },\n        uTexel: { value: [1 / this.width, 1 / this.height] },\n        uDirection: { value: [1, 0] },\n        uRadius: { value: 2 },\n      },\n      vertexShader: this.getVertexShader(),\n      fragmentShader: `\n        varying vec2 vUv;\n        uniform sampler2D tDiffuse;\n        uniform vec2 uTexel;\n        uniform vec2 uDirection;\n        uniform float uRadius;\n        void main() {\n          vec2 off1 = uDirection * uTexel * uRadius;\n          vec2 off2 = uDirection * uTexel * uRadius * 2.0;\n          vec2 off3 = uDirection * uTexel * uRadius * 3.0;\n          vec2 off4 = uDirection * uTexel * uRadius * 4.0;\n          vec4 color = texture2D(tDiffuse, vUv) * 0.227027;\n          color += texture2D(tDiffuse, vUv + off1) * 0.1945946;\n          color += texture2D(tDiffuse, vUv - off1) * 0.1945946;\n          color += texture2D(tDiffuse, vUv + off2) * 0.1216216;\n          color += texture2D(tDiffuse, vUv - off2) * 0.1216216;\n          color += texture2D(tDiffuse, vUv + off3) * 0.054054;\n          color += texture2D(tDiffuse, vUv - off3) * 0.054054;\n          color += texture2D(tDiffuse, vUv + off4) * 0.016216;\n          color += texture2D(tDiffuse, vUv - off4) * 0.016216;\n          gl_FragColor = color;\n        }\n      `,\n      transparent: true,\n      depthTest: false,\n      depthWrite: false,\n    });\n  }\n\n  private createBloomExtractMaterial(): I3DMaterial {\n    return this.createShaderMaterial({\n      uniforms: {\n        tDiffuse: { value: null },\n        uThreshold: { value: 0.8 },\n      },\n      vertexShader: this.getVertexShader(),\n      fragmentShader: `\n        varying vec2 vUv;\n        uniform sampler2D tDiffuse;\n        uniform float uThreshold;\n        void main() {\n          vec4 color = texture2D(tDiffuse, vUv);\n          float brightness = max(max(color.r, color.g), color.b);\n          gl_FragColor = brightness > uThreshold ? color : vec4(0.0);\n        }\n      `,\n      transparent: true,\n      depthTest: false,\n      depthWrite: false,\n    });\n  }\n\n  private createBloomAddMaterial(): I3DMaterial {\n    return this.createShaderMaterial({\n      uniforms: {\n        tBase: { value: null },\n        tBloom: { value: null },\n        uIntensity: { value: 1 },\n        uResolution: { value: [this.width, this.height] },\n      },\n      vertexShader: this.getVertexShader(),\n      fragmentShader: `\n        varying vec2 vUv;\n        uniform sampler2D tBase;\n        uniform sampler2D tBloom;\n        uniform float uIntensity;\n        void main() {\n          vec4 base = texture2D(tBase, vUv);\n          vec4 bloom = texture2D(tBloom, vUv);\n          gl_FragColor = vec4(base.rgb + bloom.rgb * uIntensity, base.a);\n        }\n      `,\n      transparent: true,\n      depthTest: false,\n      depthWrite: false,\n    });\n  }\n\n  private createColorMaterial(): I3DMaterial {\n    return this.createShaderMaterial({\n      uniforms: {\n        tDiffuse: { value: null },\n        uMode: { value: 0 },\n        uAmount: { value: 1 },\n      },\n      vertexShader: this.getVertexShader(),\n      fragmentShader: `\n        varying vec2 vUv;\n        uniform sampler2D tDiffuse;\n        uniform int uMode;\n        uniform float uAmount;\n\n        vec3 applyHueRotate(vec3 color, float angle) {\n          float cosA = cos(angle);\n          float sinA = sin(angle);\n          mat3 m = mat3(\n            0.213 + cosA * 0.787 - sinA * 0.213,\n            0.715 - cosA * 0.715 - sinA * 0.715,\n            0.072 - cosA * 0.072 + sinA * 0.928,\n            0.213 - cosA * 0.213 + sinA * 0.143,\n            0.715 + cosA * 0.285 + sinA * 0.140,\n            0.072 - cosA * 0.072 - sinA * 0.283,\n            0.213 - cosA * 0.213 - sinA * 0.787,\n            0.715 - cosA * 0.715 + sinA * 0.715,\n            0.072 + cosA * 0.928 + sinA * 0.072\n          );\n          return clamp(m * color, 0.0, 1.0);\n        }\n\n        void main() {\n          vec4 color = texture2D(tDiffuse, vUv);\n          float luma = dot(color.rgb, vec3(0.299, 0.587, 0.114));\n\n          if (uMode == 1) {\n            color.rgb *= uAmount;\n          } else if (uMode == 2) {\n            color.rgb = (color.rgb - 0.5) * uAmount + 0.5;\n          } else if (uMode == 3) {\n            color.rgb = mix(vec3(luma), color.rgb, uAmount);\n          } else if (uMode == 4) {\n            color.rgb = mix(color.rgb, vec3(luma), uAmount);\n          } else if (uMode == 5) {\n            vec3 sepia = vec3(\n              dot(color.rgb, vec3(0.393, 0.769, 0.189)),\n              dot(color.rgb, vec3(0.349, 0.686, 0.168)),\n              dot(color.rgb, vec3(0.272, 0.534, 0.131))\n            );\n            color.rgb = mix(color.rgb, sepia, uAmount);\n          } else if (uMode == 6) {\n            color.rgb = mix(color.rgb, vec3(1.0) - color.rgb, uAmount);\n          } else if (uMode == 7) {\n            color.rgb = applyHueRotate(color.rgb, uAmount);\n          }\n\n          gl_FragColor = color;\n        }\n      `,\n      transparent: true,\n      depthTest: false,\n      depthWrite: false,\n    });\n  }\n\n  private getColorMode(type: string): number {\n    switch (type) {\n      case \"brightness\":\n        return 1;\n      case \"contrast\":\n        return 2;\n      case \"saturate\":\n        return 3;\n      case \"grayscale\":\n        return 4;\n      case \"sepia\":\n        return 5;\n      case \"invert\":\n        return 6;\n      case \"hue-rotate\":\n        return 7;\n      default:\n        return 0;\n    }\n  }\n\n  private createShaderMaterial(params: any): I3DMaterial {\n    if (!this.engine.createShaderMaterial) {\n      throw new Error(\"[String3DFilterPipeline] Shader material support missing.\");\n    }\n    return this.engine.createShaderMaterial(params);\n  }\n\n  private getCustomMaterial(name: string): I3DMaterial | null {\n    const normalized = name.trim().toLowerCase();\n    if (!normalized) return null;\n    if (this.customMaterials.has(normalized)) {\n      return this.customMaterials.get(normalized)!;\n    }\n    const def = String3DCustomFilterRegistry.get(normalized);\n    if (!def) return null;\n\n    const uniforms: Record<string, any> = { tDiffuse: { value: null } };\n    const { width, height } = this.getScaledSize();\n    uniforms.uResolution = { value: [width, height] };\n    uniforms.uTexel = { value: [1 / width, 1 / height] };\n    Object.entries(def.uniforms || {}).forEach(([key, value]) => {\n      uniforms[key] = { value };\n    });\n\n    const material = this.createShaderMaterial({\n      uniforms,\n      vertexShader: this.getVertexShader(),\n      fragmentShader: def.fragmentShader,\n      transparent: true,\n      depthTest: false,\n      depthWrite: false,\n    });\n\n    this.customMaterials.set(normalized, material);\n    return material;\n  }\n\n  private getScaledSize(): { width: number; height: number } {\n    const width = Math.max(1, Math.round(this.width * this.scale));\n    const height = Math.max(1, Math.round(this.height * this.scale));\n    return { width, height };\n  }\n\n  private getVertexShader(): string {\n    return `\n      varying vec2 vUv;\n      void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n      }\n    `;\n  }\n}\n","import { I3DEngine, I3DRenderer, I3DObject, I3DRenderTarget } from \"./abstractions/I3DEngine\";\nimport { String3DCamera } from \"./String3DCamera\";\nimport { String3DScene } from \"./String3DScene\";\nimport { String3DFilterPipeline } from \"./filters/String3DFilterPipeline\";\nimport type { String3DFilterTarget } from \"./filters/String3DFilterTypes\";\nimport type { String3DFilterEffect } from \"./filters/String3DFilterTypes\";\n\ntype FilterCacheEntry = {\n  target: I3DRenderTarget;\n  effectsKey: string;\n  lastUsedFrame: number;\n  qualityScale: number;\n};\n\nexport class String3DRenderer {\n  private _container: HTMLElement;\n  private _renderer: I3DRenderer;\n  private _width: number;\n  private _height: number;\n  private engine: I3DEngine;\n  private filterPipeline: String3DFilterPipeline | null = null;\n  private filterCache: Map<string, FilterCacheEntry> = new Map();\n  private frameId = 0;\n  private lastFrameTime = performance.now();\n  private avgFrameMs = 16.7;\n  private qualityScale = 1;\n  private lastQualityChange = 0;\n  private filterLayer = 1;\n\n  constructor(container: HTMLElement, engine: I3DEngine) {\n    this.engine = engine;\n    this._container = container;\n    const { width, height } = container.getBoundingClientRect();\n    this._width = width;\n    this._height = height;\n\n    this._renderer = engine.createRenderer({\n      antialias: true,\n      alpha: true,\n      logarithmicDepthBuffer: true,\n    });\n    const rendererAny = this._renderer as any;\n    if (typeof rendererAny.setClearColor === \"function\") {\n      rendererAny.setClearColor(0x000000, 0);\n    }\n    this._renderer.setPixelRatio(window.devicePixelRatio);\n    this._renderer.setSize(width, height);\n\n    if (this._renderer.shadowMap) {\n      this._renderer.shadowMap.enabled = true;\n    }\n  }\n\n  public attach(): void {\n    this._container.appendChild(this._renderer.domElement);\n  }\n\n  public render(\n    scene: String3DScene,\n    camera: String3DCamera,\n    filterTargets: String3DFilterTarget[] = []\n  ): void {\n    if (filterTargets.length === 0) {\n      this._renderer.render(scene.getScene(), camera.camera);\n      return;\n    }\n\n    const pipeline = this.ensureFilterPipeline();\n    if (!pipeline?.isSupported()) {\n      this._renderer.render(scene.getScene(), camera.camera);\n      return;\n    }\n\n    this.frameId += 1;\n    this.updateQuality(filterTargets.length, pipeline);\n\n    const allObjects = scene.getAllObjects();\n    const visibility = new Map<I3DObject, boolean | undefined>();\n    allObjects.forEach((obj) => {\n      const anyObj = obj.object as any;\n      if (\"visible\" in anyObj) {\n        visibility.set(obj.object, anyObj.visible);\n      }\n    });\n\n    const filteredSet = new Set<I3DObject>();\n    filterTargets.forEach((target) => {\n      this.collectSubtreeObjects(target.object, filteredSet);\n    });\n\n    allObjects.forEach((obj) => {\n      if (filteredSet.has(obj.object)) {\n        this.setVisible(obj.object, false);\n      }\n    });\n\n    const rendererAny = this._renderer as any;\n    const prevAutoClear = rendererAny.autoClear;\n    rendererAny.autoClear = true;\n    if (rendererAny.setRenderTarget) {\n      rendererAny.setRenderTarget(null);\n    }\n    if (rendererAny.clear) {\n      rendererAny.clear(true, true, true);\n    }\n    this._renderer.render(scene.getScene(), camera.camera);\n\n    rendererAny.autoClear = false;\n\n    allObjects.forEach((obj) => {\n      const originalVisible = visibility.get(obj.object);\n      if (typeof originalVisible !== \"undefined\") {\n        this.setVisible(obj.object, originalVisible);\n      }\n    });\n\n    const lights = allObjects.filter((obj) => obj.type.endsWith(\"Light\"));\n    const supportsLayers = this.supportsLayers(camera.camera, allObjects);\n\n    filterTargets.forEach((target) => {\n      const cache = this.filterCache.get(target.object.id);\n      const canUseCache =\n        !target.dirty &&\n        cache &&\n        cache.effectsKey === target.effectsKey &&\n        cache.qualityScale === this.qualityScale;\n\n      if (canUseCache) {\n        cache.lastUsedFrame = this.frameId;\n        pipeline.renderToScreen(cache.target);\n        return;\n      }\n\n      const effects = this.injectEffectContext(\n        target.object.el as HTMLElement | undefined,\n        target.effects\n      );\n\n      const allowed = new Set<I3DObject>();\n      this.collectSubtreeObjects(target.object, allowed);\n\n      let restoreLayers: Array<{ object: I3DObject; mask: number }> = [];\n      let restoreCameraMask: number | null = null;\n\n      if (supportsLayers) {\n        const subtree = target.object.getSubtreeObjects();\n        restoreLayers = this.applyLayerMask(subtree, lights, this.filterLayer);\n        restoreCameraMask = this.setCameraLayer(camera.camera, this.filterLayer);\n      } else {\n        allObjects.forEach((obj) => {\n          const originalVisible = visibility.get(obj.object);\n          if (originalVisible === false) {\n            this.setVisible(obj.object, false);\n            return;\n          }\n\n          if (obj.type.endsWith(\"Light\")) {\n            this.setVisible(obj.object, true);\n            return;\n          }\n\n          this.setVisible(obj.object, allowed.has(obj.object));\n        });\n      }\n\n      const input = pipeline.acquireTarget();\n      if (rendererAny.setRenderTarget) {\n        rendererAny.setRenderTarget(input);\n      }\n      if (rendererAny.clear) {\n        rendererAny.clear(true, true, true);\n      }\n      this._renderer.render(scene.getScene(), camera.camera);\n\n      const output = pipeline.applyFilters(input, effects, this.qualityScale);\n      if (rendererAny.setRenderTarget) {\n        rendererAny.setRenderTarget(null);\n      }\n      pipeline.renderToScreen(output);\n\n      if (supportsLayers) {\n        this.restoreLayerMask(restoreLayers);\n        if (restoreCameraMask !== null) {\n          this.restoreCameraLayer(camera.camera, restoreCameraMask);\n        }\n      }\n\n      if (output !== input) {\n        pipeline.releaseTarget(input);\n      }\n\n      const entry: FilterCacheEntry = {\n        target: output,\n        effectsKey: target.effectsKey,\n        lastUsedFrame: this.frameId,\n        qualityScale: this.qualityScale,\n      };\n      const existing = this.filterCache.get(target.object.id);\n      if (existing && existing.target !== output) {\n        pipeline.releaseTarget(existing.target);\n      }\n      this.filterCache.set(target.object.id, entry);\n    });\n\n    if (!supportsLayers) {\n      allObjects.forEach((obj) => {\n        const originalVisible = visibility.get(obj.object);\n        if (typeof originalVisible !== \"undefined\") {\n          this.setVisible(obj.object, originalVisible);\n        }\n      });\n    }\n\n    rendererAny.autoClear = prevAutoClear;\n\n    this.evictCache();\n  }\n\n  public resize(camera: String3DCamera): void {\n    const { width, height } = this._container.getBoundingClientRect();\n    this._width = width;\n    this._height = height;\n    this._renderer.setSize(width, height);\n    camera.resize(width, height);\n    this.filterPipeline?.resize(width, height);\n    this.invalidateFilterCache();\n  }\n\n  public get width(): number {\n    return this._width;\n  }\n\n  public get height(): number {\n    return this._height;\n  }\n\n  public get renderer(): I3DRenderer {\n    return this._renderer;\n  }\n\n  public destroy(): void {\n    this._renderer.dispose();\n    this.filterPipeline?.dispose();\n    this.filterCache.clear();\n  }\n\n  private ensureFilterPipeline(): String3DFilterPipeline | null {\n    if (!this.canCreateFilterPipeline()) {\n      return null;\n    }\n    if (!this.filterPipeline) {\n      this.filterPipeline = new String3DFilterPipeline(\n        this.engine,\n        this._renderer,\n        this._width,\n        this._height\n      );\n      this.filterPipeline.setScale(this.qualityScale);\n    }\n    return this.filterPipeline;\n  }\n\n  private canCreateFilterPipeline(): boolean {\n    return (\n      typeof this.engine.createRenderTarget === \"function\" &&\n      typeof this.engine.createShaderMaterial === \"function\" &&\n      typeof (this._renderer as any).setRenderTarget === \"function\"\n    );\n  }\n\n  private collectSubtreeObjects(\n    object: import(\"./String3DObject\").String3DObject,\n    set: Set<I3DObject>\n  ): void {\n    set.add(object.object);\n    object.children.forEach((child) => this.collectSubtreeObjects(child, set));\n  }\n\n  private setVisible(object: I3DObject, visible: boolean): void {\n    const anyObj = object as any;\n    if (\"visible\" in anyObj) {\n      anyObj.visible = visible;\n    }\n  }\n\n  private getFilterCenter(el: HTMLElement | undefined): [number, number] {\n    if (!el || !this._width || !this._height) return [0.5, 0.5];\n    const cached = (el as any).__layoutCache;\n    const rect = cached ? cached.rect : el.getBoundingClientRect();\n    const cx = (rect.left + rect.width / 2) / this._width;\n    const cy = 1 - (rect.top + rect.height / 2) / this._height;\n    const clamp = (value: number) => Math.max(0, Math.min(1, value));\n    return [clamp(cx), clamp(cy)];\n  }\n\n  private injectEffectContext(\n    el: HTMLElement | undefined,\n    effects: String3DFilterEffect[]\n  ): String3DFilterEffect[] {\n    if (!effects.some((effect) => effect.type === \"custom\")) {\n      return effects;\n    }\n    const center = this.getFilterCenter(el);\n    let changed = false;\n    const next = effects.map((effect) => {\n      if (effect.type !== \"custom\") return effect;\n      if (effect.uniforms && \"uCenter\" in effect.uniforms) return effect;\n      const uniforms = { ...(effect.uniforms || {}), uCenter: center };\n      changed = true;\n      return { ...effect, uniforms };\n    });\n    return changed ? next : effects;\n  }\n\n  private updateQuality(filterCount: number, pipeline: String3DFilterPipeline): void {\n    const now = performance.now();\n    const dt = Math.max(0.1, now - this.lastFrameTime);\n    this.lastFrameTime = now;\n    this.avgFrameMs = this.avgFrameMs * 0.9 + dt * 0.1;\n\n    const fps = 1000 / this.avgFrameMs;\n    const countScale = Math.max(0.75, 1 - Math.min(0.4, filterCount * 0.03));\n    let targetScale = countScale;\n\n    if (fps < 48) targetScale = Math.max(0.75, countScale - 0.1);\n    if (fps < 40) targetScale = Math.max(0.75, countScale - 0.2);\n    if (fps > 58) targetScale = Math.min(1, countScale + 0.05);\n\n    if (Math.abs(targetScale - this.qualityScale) >= 0.05 && now - this.lastQualityChange > 300) {\n      this.qualityScale = targetScale;\n      this.lastQualityChange = now;\n      pipeline.setScale(this.qualityScale);\n      this.invalidateFilterCache();\n    }\n  }\n\n  private invalidateFilterCache(): void {\n    if (!this.filterPipeline) return;\n    this.filterCache.forEach((entry) => {\n      this.filterPipeline?.releaseTarget(entry.target);\n    });\n    this.filterCache.clear();\n  }\n\n  private evictCache(): void {\n    if (!this.filterPipeline) return;\n    const maxAge = 120;\n    this.filterCache.forEach((entry, key) => {\n      if (this.frameId - entry.lastUsedFrame > maxAge) {\n        this.filterPipeline?.releaseTarget(entry.target);\n        this.filterCache.delete(key);\n      }\n    });\n  }\n\n  private supportsLayers(camera: any, objects: Array<{ object: I3DObject }>): boolean {\n    if (!camera?.layers || typeof camera.layers.set !== \"function\") return false;\n    return objects.some((obj) => this.hasLayers(obj.object));\n  }\n\n  private hasLayers(object: any): boolean {\n    return object?.layers && typeof object.layers.set === \"function\";\n  }\n\n  private applyLayerMask(\n    objects: I3DObject[],\n    lights: Array<{ object: I3DObject }>,\n    layer: number\n  ): Array<{ object: I3DObject; mask: number }> {\n    const restoredMap = new Map<I3DObject, number>();\n    const apply = (obj: I3DObject, setMode: \"set\" | \"enable\") => {\n      const anyObj = obj as any;\n      if (!this.hasLayers(anyObj)) return;\n      if (!restoredMap.has(obj)) {\n        restoredMap.set(obj, anyObj.layers.mask);\n      }\n      if (setMode === \"set\") {\n        anyObj.layers.set(layer);\n      } else {\n        anyObj.layers.enable(layer);\n      }\n    };\n\n    objects.forEach((obj) => apply(obj, \"set\"));\n    lights.forEach((light) => apply(light.object, \"enable\"));\n\n    return Array.from(restoredMap.entries()).map(([object, mask]) => ({ object, mask }));\n  }\n\n  private restoreLayerMask(entries: Array<{ object: I3DObject; mask: number }>): void {\n    entries.forEach((entry) => {\n      const anyObj = entry.object as any;\n      if (this.hasLayers(anyObj)) {\n        anyObj.layers.mask = entry.mask;\n      }\n    });\n  }\n\n  private setCameraLayer(camera: any, layer: number): number | null {\n    if (!camera?.layers || typeof camera.layers.set !== \"function\") return null;\n    const prev = camera.layers.mask;\n    camera.layers.set(layer);\n    return prev;\n  }\n\n  private restoreCameraLayer(camera: any, mask: number): void {\n    if (camera?.layers) {\n      camera.layers.mask = mask;\n    }\n  }\n}\n","import {\r\n  I3DEngine,\r\n  I3DObject,\r\n  I3DMaterial,\r\n  I3DGeometry,\r\n  I3DQuaternion,\r\n  I3DVector3,\r\n  I3DEuler,\r\n  I3DMatrix4,\r\n  I3DBox3,\r\n} from \"./abstractions/I3DEngine\";\r\n\r\nexport class String3DObject {\n  public id: string;\n  public type: string;\n  private _object: I3DObject;\n  private _material?: I3DMaterial;\n  private _geometry?: I3DGeometry;\n  private _texture?: any;\n  private _uniforms: Record<string, { value: any }> = {};\r\n  private _originalBoundingBox?: I3DBox3 | null;\r\n  private _quaternion: I3DQuaternion;\r\n  private _originalSize: I3DVector3;\r\n  private _bbox: I3DBox3;\r\n  public el: any;\r\n  private _children: String3DObject[] = [];\n  private _flatObjectsCache: I3DObject[] | null = null;\n  private _subtreeCache: I3DObject[] | null = null;\n  private engine: I3DEngine;\r\n\r\n  public get children(): String3DObject[] {\r\n    return this._children;\r\n  }\r\n\r\n  constructor(\n    id: string,\n    type: string,\n    object: I3DObject,\n    engine: I3DEngine,\n    options: { material?: I3DMaterial; geometry?: I3DGeometry; texture?: any } = {}\n  ) {\n    this.id = id;\n    this.type = type;\n    this._object = object;\n    this.engine = engine;\n    this._material = options.material;\n    this._geometry = options.geometry;\n    this._texture = options.texture;\n    this._quaternion = engine.createQuaternion();\n    this._originalSize = engine.createVector3();\n    this._bbox = engine.createBox3();\n    this.updateBoundingBox();\n  }\n\r\n  public get object(): I3DObject {\r\n    return this._object;\r\n  }\r\n\r\n  public get material(): I3DMaterial | undefined {\r\n    return this._material;\r\n  }\r\n\r\n  public get originalSize(): I3DVector3 {\r\n    return this._originalSize.clone();\r\n  }\r\n\r\n  public get boundingBox(): I3DBox3 {\r\n    return this._bbox.clone();\r\n  }\r\n\r\n  public addChild(child: String3DObject): void {\n    this._children.push(child);\n    this.object.add(child.object);\n    this.invalidateFlatCache();\n    this.invalidateSubtreeCache();\n  }\n\r\n  public getWorldMatrix(): I3DMatrix4 {\r\n    return this._object.matrixWorld.clone();\r\n  }\r\n\r\n  public getWorldPosition(): I3DVector3 {\r\n    return this.engine.createVector3().setFromMatrixPosition(this._object.matrixWorld);\r\n  }\r\n\r\n  public getOriginalBoundingBox(): I3DBox3 {\r\n    if (!this._originalBoundingBox) {\r\n      const originalScale = this.object.scale.clone();\r\n      this.object.scale.set(1, 1, 1);\r\n      this.object.updateMatrixWorld(true);\r\n      this._originalBoundingBox = this.engine.computeBoundingBoxRecursively(this.object);\r\n      this.object.scale.copy(originalScale);\r\n      this.object.updateMatrixWorld(true);\r\n    }\r\n    return this._originalBoundingBox!.clone();\r\n  }\r\n\r\n  public syncTransformFromMatrix(matrix: I3DMatrix4): void {\r\n    const pos = this.engine.createVector3();\r\n    const quat = this.engine.createQuaternion();\r\n    const scale = this.engine.createVector3();\r\n    matrix.decompose(pos, quat, scale);\r\n    this._object.position.copy(pos);\r\n    this._object.quaternion.copy(quat);\r\n    this._object.scale.copy(scale);\r\n    this._object.updateMatrix();\r\n    this._object.updateMatrixWorld();\r\n  }\r\n\r\n  public applyWorldTransform(\r\n    position: I3DVector3,\r\n    quaternion: I3DQuaternion,\r\n    scale: I3DVector3\r\n  ): void {\r\n    this._object.position.copy(position);\r\n    this._object.quaternion.copy(quaternion);\r\n    this._object.scale.copy(scale);\r\n    this._object.updateMatrix();\r\n    this._object.updateMatrixWorld();\r\n  }\r\n\r\n  public set quaternion(quaternion: I3DQuaternion) {\r\n    this._quaternion.copy(quaternion);\r\n    this._object.quaternion.copy(this._quaternion);\r\n    this._object.updateMatrixWorld();\r\n  }\r\n\r\n  public set position(position: I3DVector3) {\r\n    this._object.position.copy(position);\r\n  }\r\n\r\n  public set scale(scale: I3DVector3) {\r\n    this._object.scale.copy(scale);\r\n  }\r\n\r\n  public set rotation(euler: I3DEuler) {\r\n    this._object.rotation.copy(euler);\r\n  }\r\n\r\n  public set opacity(value: number) {\r\n    const mat = this._object as any;\r\n    if (mat.material && \"opacity\" in mat.material) {\r\n      mat.material.opacity = value;\r\n    }\r\n  }\r\n\r\n  public set metalness(value: number) {\r\n    const mat = this._object as any;\r\n    if (mat.material && \"metalness\" in mat.material) {\r\n      mat.material.metalness = value;\r\n    }\r\n  }\r\n\r\n  public set roughness(value: number) {\r\n    const mat = this._object as any;\r\n    if (mat.material && \"roughness\" in mat.material) {\r\n      mat.material.roughness = value;\r\n    }\r\n  }\r\n\r\n  public set texture(texture: any) {\n    this._texture = texture;\n    if ((this._object as any).isMesh && texture?.applyTexture) {\n      texture.applyTexture(this._object);\n    }\n  }\n\n  public set material(material: I3DMaterial | undefined) {\n    this._material = material;\n  }\n\n  public set geometry(geometry: I3DGeometry | undefined) {\n    this._geometry = geometry;\n  }\n\n  public updateBoundingBox(): void {\n    this._bbox.setFromObject(this._object);\n    this._bbox.getSize(this._originalSize);\n  }\n\n  public destroy(): void {\n    this.disposeObjectResources(this._object);\n    this._texture?.dispose?.();\n    this._material?.dispose();\n    this._geometry?.dispose();\n    this._subtreeCache = null;\n  }\n\n  public getFlatObjects(): I3DObject[] {\n    if (this._flatObjectsCache) return this._flatObjectsCache;\n    const result: I3DObject[] = [];\n    const walk = (obj: String3DObject): void => {\n      result.push(obj.object);\n      obj.children.forEach((child) => walk(child));\n    };\n    walk(this);\n    this._flatObjectsCache = result;\n    return result;\n  }\n\n  public getSubtreeObjects(): I3DObject[] {\n    if (this._subtreeCache) return this._subtreeCache;\n    const result: I3DObject[] = [];\n    const anyObj = this._object as any;\n    result.push(this._object);\n    if (typeof anyObj.traverse === \"function\") {\n      anyObj.traverse((child: any) => {\n        if (child && child !== this._object) {\n          result.push(child as I3DObject);\n        }\n      });\n    }\n    this._subtreeCache = result;\n    return result;\n  }\n\n  private invalidateFlatCache(): void {\n    this._flatObjectsCache = null;\n  }\n\n  private invalidateSubtreeCache(): void {\n    this._subtreeCache = null;\n  }\n\n  private disposeObjectResources(object: I3DObject): void {\n    const anyObj = object as any;\n    if (anyObj?.geometry?.dispose) {\n      anyObj.geometry.dispose();\n    }\n    const material = anyObj?.material;\n    if (Array.isArray(material)) {\n      material.forEach((mat) => mat?.dispose?.());\n    } else if (material?.dispose) {\n      material.dispose();\n    }\n    if (typeof anyObj?.traverse === \"function\") {\n      anyObj.traverse((child: any) => {\n        if (child?.geometry?.dispose) {\n          child.geometry.dispose();\n        }\n        const childMat = child?.material;\n        if (Array.isArray(childMat)) {\n          childMat.forEach((mat: any) => mat?.dispose?.());\n        } else if (childMat?.dispose) {\n          childMat.dispose();\n        }\n      });\n    }\n  }\n}\n","export class StyleReader {\r\n  private styleMap: any;\r\n  private style: CSSStyleDeclaration;\r\n\r\n  constructor(el: HTMLElement) {\r\n    this.styleMap = (el as any).computedStyleMap?.();\r\n    this.style = getComputedStyle(el);\r\n  }\r\n\r\n  readNumber(prop: string, fallback: number): number {\r\n    const mapValue = this.styleMap?.get?.(prop);\r\n    if (mapValue !== undefined && mapValue !== null) {\r\n      const val = typeof mapValue === \"object\" ? (mapValue as any).value : mapValue;\r\n      const num = typeof val === \"number\" ? val : Number.parseFloat(val);\r\n      if (!Number.isNaN(num)) return num;\r\n    }\r\n    const num = Number.parseFloat(this.style.getPropertyValue(prop));\r\n    return Number.isNaN(num) ? fallback : num;\r\n  }\r\n\r\n  readString(prop: string, fallback = \"\"): string {\r\n    const mapValue = this.styleMap?.get?.(prop);\r\n    const val = mapValue && typeof mapValue === \"object\" ? (mapValue as any).value : mapValue;\r\n    if (typeof val === \"string\") return this.stripQuotes(val.trim()) || fallback;\r\n    const raw = this.style.getPropertyValue(prop).trim();\r\n    return this.stripQuotes(raw) || fallback;\r\n  }\r\n\r\n  private stripQuotes(value: string): string {\r\n    if (\r\n      (value.startsWith(\"'\") && value.endsWith(\"'\")) ||\r\n      (value.startsWith('\"') && value.endsWith('\"'))\r\n    ) {\r\n      return value.slice(1, -1);\r\n    }\r\n    return value;\r\n  }\r\n\r\n  readBoolean(prop: string, fallback = false): boolean {\r\n    const raw = this.readString(prop, \"\");\r\n    if (!raw) return fallback;\r\n    const norm = raw.toLowerCase();\r\n    return norm === \"true\" || norm === \"1\" || norm === \"yes\"\r\n      ? true\r\n      : norm === \"false\" || norm === \"0\" || norm === \"no\"\r\n      ? false\r\n      : fallback;\r\n  }\r\n}\r\n\r\nexport function readNumberStyle(el: HTMLElement, prop: string, fallback: number): number {\r\n  const styleMap = (el as any).computedStyleMap?.();\r\n  const mapValue = styleMap?.get?.(prop);\r\n  if (mapValue !== undefined) {\r\n    if (typeof mapValue === \"number\") return mapValue;\r\n    if (typeof mapValue === \"string\") {\r\n      const parsed = Number.parseFloat(mapValue);\r\n      if (!Number.isNaN(parsed)) return parsed;\r\n    }\r\n    if (mapValue && typeof mapValue === \"object\") {\r\n      const value = (mapValue as any).value;\r\n      if (typeof value === \"number\") return value;\r\n      if (typeof value === \"string\") {\r\n        const parsed = Number.parseFloat(value);\r\n        if (!Number.isNaN(parsed)) return parsed;\r\n      }\r\n    }\r\n  }\r\n\r\n  const style = getComputedStyle(el);\r\n  const raw = style.getPropertyValue(prop);\r\n  const parsed = Number.parseFloat(raw);\r\n  return Number.isNaN(parsed) ? fallback : parsed;\r\n}\r\n\r\nfunction stripQuotes(value: string): string {\r\n  if (\r\n    (value.startsWith(\"'\") && value.endsWith(\"'\")) ||\r\n    (value.startsWith('\"') && value.endsWith('\"'))\r\n  ) {\r\n    return value.slice(1, -1);\r\n  }\r\n  return value;\r\n}\r\n\r\nexport function readStringStyle(el: HTMLElement, prop: string, fallback = \"\"): string {\r\n  const styleMap = (el as any).computedStyleMap?.();\r\n  const mapValue = styleMap?.get?.(prop);\r\n  if (typeof mapValue === \"string\") {\r\n    return stripQuotes(mapValue.trim());\r\n  }\r\n  if (mapValue && typeof mapValue === \"object\") {\r\n    const value = (mapValue as any).value;\r\n    if (typeof value === \"string\") {\r\n      return stripQuotes(value.trim());\r\n    }\r\n  }\r\n  const style = getComputedStyle(el).getPropertyValue(prop);\r\n  const result = style ? stripQuotes(style.trim()) : \"\";\r\n  return result || fallback;\r\n}\r\n\r\nexport function readBooleanStyle(el: HTMLElement, prop: string, fallback = false): boolean {\r\n  const raw = readStringStyle(el, prop, \"\");\r\n  if (!raw) return fallback;\r\n  const normalized = raw.toLowerCase().trim();\r\n  if (normalized === \"true\" || normalized === \"1\" || normalized === \"yes\") return true;\r\n  if (normalized === \"false\" || normalized === \"0\" || normalized === \"no\") return false;\r\n  return fallback;\r\n}\r\n\r\nexport function readFilterRaw(el: HTMLElement): string {\r\n  const styleMap = (el as any).computedStyleMap?.();\r\n  let raw = \"\";\r\n  const mapValue = styleMap?.get?.(\"--filter\");\r\n  if (mapValue !== undefined) {\r\n    if (typeof mapValue === \"string\") {\r\n      raw = mapValue;\r\n    } else if (mapValue && typeof mapValue === \"object\") {\r\n      const value = (mapValue as any).value;\r\n      if (typeof value === \"string\") raw = value;\r\n    }\r\n  }\r\n  if (!raw) {\r\n    raw = getComputedStyle(el).getPropertyValue(\"--filter\") || \"\";\r\n  }\r\n  raw = raw.trim();\r\n  return raw;\r\n}\r\n","export type UniformType =\r\n  | \"float\"\r\n  | \"int\"\r\n  | \"vec2\"\r\n  | \"vec3\"\r\n  | \"vec4\"\r\n  | \"color\"\r\n  | \"texture\"\r\n  | \"mat3\"\r\n  | \"mat4\";\r\n\r\nexport type UniformDefinition = {\r\n  type: UniformType;\r\n  value: any;\r\n  css?: string;\r\n};\r\n\r\nexport type ShaderInjectionPoint =\r\n  | \"vertex_pars\"\r\n  | \"vertex_header\"\r\n  | \"vertex_transform\"\r\n  | \"vertex_output\"\r\n  | \"fragment_pars\"\r\n  | \"fragment_header\"\r\n  | \"fragment_color\"\r\n  | \"fragment_normal\"\r\n  | \"fragment_emissive\"\r\n  | \"fragment_roughness\"\r\n  | \"fragment_metalness\"\r\n  | \"fragment_ao\"\r\n  | \"fragment_transmission\"\r\n  | \"fragment_lights\"\r\n  | \"fragment_output\";\r\n\r\nexport type ShaderInjection = {\r\n  point: ShaderInjectionPoint;\r\n  code: string;\r\n  order?: number;\r\n};\r\n\r\nexport type MaterialBlendMode = \"normal\" | \"additive\" | \"subtractive\" | \"multiply\";\r\nexport type MaterialSide = \"front\" | \"back\" | \"double\";\r\n\r\nexport type String3DCustomMaterialDefinition = {\r\n  name: string;\r\n\r\n  extends?: \"basic\" | \"standard\" | \"physical\" | \"shader\";\r\n\r\n  vertexShader?: string;\r\n  fragmentShader?: string;\r\n\r\n  injections?: ShaderInjection[];\r\n\r\n  uniforms?: Record<string, UniformDefinition>;\r\n\r\n  properties?: {\r\n    transparent?: boolean;\r\n    side?: MaterialSide;\r\n    depthWrite?: boolean;\r\n    depthTest?: boolean;\r\n    blending?: MaterialBlendMode;\r\n    wireframe?: boolean;\r\n  };\r\n\r\n  lights?: boolean;\r\n\r\n  parse?: (element: HTMLElement, style: CSSStyleDeclaration) => Record<string, any>;\r\n};\r\n\r\nexport class String3DCustomMaterialRegistry {\r\n  private static materials: Map<string, String3DCustomMaterialDefinition> = new Map();\r\n  private static registeredCssVars: Set<string> = new Set();\r\n\r\n  static register(definition: String3DCustomMaterialDefinition): void {\r\n    const name = definition.name.trim().toLowerCase();\r\n    if (!name) {\r\n      throw new Error(\"[String3D] Custom material name is required.\");\r\n    }\r\n    this.materials.set(name, { ...definition, name });\r\n    this.registerCssVarsForMaterial(definition);\r\n  }\r\n\r\n  private static registerCssVarsForMaterial(definition: String3DCustomMaterialDefinition): void {\r\n    const css = (globalThis as any).CSS;\r\n    if (!css?.registerProperty) return;\r\n\r\n    const uniforms = definition.uniforms || {};\r\n    for (const def of Object.values(uniforms)) {\r\n      const cssVar = def.css?.trim();\r\n      if (!cssVar || !cssVar.startsWith(\"--\")) continue;\r\n      if (this.registeredCssVars.has(cssVar)) continue;\r\n\r\n      const syntax = this.resolveCssSyntax(def.type);\r\n\r\n      try {\r\n        css.registerProperty({\r\n          name: cssVar,\r\n          syntax,\r\n          inherits: false,\r\n          initialValue: this.defaultCssInitialValue(def),\r\n        });\r\n        this.registeredCssVars.add(cssVar);\r\n      } catch (err) {}\r\n    }\r\n  }\r\n\r\n  private static resolveCssSyntax(type: UniformType): string {\r\n    switch (type) {\r\n      case \"color\":\r\n        return \"<color>\";\r\n      case \"float\":\r\n      case \"int\":\r\n        return \"<number>\";\r\n      default:\r\n        return \"*\";\r\n    }\r\n  }\r\n\r\n  private static defaultCssInitialValue(def: UniformDefinition): string {\r\n    if (def.type === \"color\") {\r\n      if (typeof def.value === \"string\") return def.value;\r\n      return \"#000000\";\r\n    }\r\n    if (def.type === \"float\" || def.type === \"int\") {\r\n      return typeof def.value === \"number\" ? String(def.value) : \"0\";\r\n    }\r\n    return \"initial\";\r\n  }\r\n\r\n  static get(name: string): String3DCustomMaterialDefinition | undefined {\r\n    return this.materials.get(name.trim().toLowerCase());\r\n  }\r\n\r\n  static has(name: string): boolean {\r\n    return this.materials.has(name.trim().toLowerCase());\r\n  }\r\n\r\n  static list(): String3DCustomMaterialDefinition[] {\r\n    return Array.from(this.materials.values());\r\n  }\r\n\r\n  static unregister(name: string): boolean {\r\n    return this.materials.delete(name.trim().toLowerCase());\r\n  }\r\n}\r\n","import type {\n  String3DCustomMaterialDefinition,\n  UniformDefinition,\n  ShaderInjection,\n} from \"./String3DCustomMaterial\";\n\nexport type MaterialUpdateCallback = (uniforms: Record<string, any>) => void;\n\nexport interface IMaterialInstance {\n  material: any;\n  definition: String3DCustomMaterialDefinition;\n  update: MaterialUpdateCallback;\n  dispose: () => void;\n}\n\nexport interface IMaterialFactory {\n  supports(definition: String3DCustomMaterialDefinition): boolean;\n\n  create(\n    definition: String3DCustomMaterialDefinition,\n    initialUniforms?: Record<string, any>\n  ): IMaterialInstance;\n\n  parseUniformsFromCSS(\n    definition: String3DCustomMaterialDefinition,\n    element: HTMLElement,\n    style: CSSStyleDeclaration\n  ): Record<string, any>;\n}\n\nexport function parseUniformValue(\n  def: UniformDefinition,\n  cssValue: string | null | undefined\n): any {\n  if (cssValue === null || cssValue === undefined || cssValue === \"\" || cssValue === \"none\") {\n    return def.value;\n  }\n\n  const trimmed = cssValue.trim();\n\n  switch (def.type) {\n    case \"float\":\n    case \"int\": {\n      const num = parseFloat(trimmed);\n      return isNaN(num) ? def.value : num;\n    }\n    case \"vec2\": {\n      const parts = trimmed.split(/[\\s,]+/).map((s) => parseFloat(s.trim()));\n      if (parts.length >= 2 && parts.every((n) => !isNaN(n))) {\n        return [parts[0], parts[1]];\n      }\n      return def.value;\n    }\n    case \"vec3\": {\n      const parts = trimmed.split(/[\\s,]+/).map((s) => parseFloat(s.trim()));\n      if (parts.length >= 3 && parts.every((n) => !isNaN(n))) {\n        return [parts[0], parts[1], parts[2]];\n      }\n      return def.value;\n    }\n    case \"vec4\": {\n      const parts = trimmed.split(/[\\s,]+/).map((s) => parseFloat(s.trim()));\n      if (parts.length >= 4 && parts.every((n) => !isNaN(n))) {\n        return [parts[0], parts[1], parts[2], parts[3]];\n      }\n      return def.value;\n    }\n    case \"color\": {\n      return parseColorValue(trimmed) ?? def.value;\n    }\n    case \"texture\": {\n      const match = trimmed.match(/url\\(['\"]?(.*?)['\"]?\\)/);\n      return match ? match[1] : trimmed || def.value;\n    }\n    default:\n      return def.value;\n  }\n}\n\nfunction parseColorValue(value: string): [number, number, number] | null {\n  if (value.startsWith(\"#\")) {\n    const hex = value.slice(1);\n    if (hex.length === 3) {\n      const r = parseInt(hex[0] + hex[0], 16) / 255;\n      const g = parseInt(hex[1] + hex[1], 16) / 255;\n      const b = parseInt(hex[2] + hex[2], 16) / 255;\n      return [r, g, b];\n    }\n    if (hex.length === 6) {\n      const r = parseInt(hex.slice(0, 2), 16) / 255;\n      const g = parseInt(hex.slice(2, 4), 16) / 255;\n      const b = parseInt(hex.slice(4, 6), 16) / 255;\n      return [r, g, b];\n    }\n  }\n\n  const rgbMatch = value.match(/rgba?\\(\\s*(\\d+)\\s*,\\s*(\\d+)\\s*,\\s*(\\d+)/);\n  if (rgbMatch) {\n    return [parseInt(rgbMatch[1]) / 255, parseInt(rgbMatch[2]) / 255, parseInt(rgbMatch[3]) / 255];\n  }\n\n  return null;\n}\n\nexport function collectUniformsFromCSS(\n  definition: String3DCustomMaterialDefinition,\n  element: HTMLElement,\n  style: CSSStyleDeclaration\n): Record<string, any> {\n  const result: Record<string, any> = {};\n\n  if (definition.parse) {\n    const parsed = definition.parse(element, style);\n    Object.assign(result, parsed);\n  }\n\n  if (definition.uniforms) {\n    for (const [key, def] of Object.entries(definition.uniforms)) {\n      if (def.css) {\n        const cssValue = style.getPropertyValue(def.css).trim();\n        result[key] = parseUniformValue(def, cssValue);\n      } else if (!(key in result)) {\n        result[key] = def.value;\n      }\n    }\n  }\n\n  return result;\n}\n\nexport function mergeInjections(injections: ShaderInjection[]): Map<string, string> {\n  const grouped = new Map<string, ShaderInjection[]>();\n\n  for (const injection of injections) {\n    const list = grouped.get(injection.point) || [];\n    list.push(injection);\n    grouped.set(injection.point, list);\n  }\n\n  const result = new Map<string, string>();\n\n  for (const [point, list] of grouped) {\n    const sorted = list.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));\n    result.set(point, sorted.map((i) => i.code).join(\"\\n\"));\n  }\n\n  return result;\n}\n","import {\r\n  I3DEngine,\r\n  I3DScene,\r\n  I3DLight,\r\n  I3DMaterial,\r\n  I3DModelLoader,\r\n  I3DVector3,\r\n} from \"./abstractions/I3DEngine\";\r\nimport { String3DObject } from \"./String3DObject\";\r\nimport { StringObject } from \"@fiddle-digital/string-tune\";\r\nimport { readBooleanStyle, readNumberStyle, readStringStyle } from \"../modules/string3d/styleUtils\";\r\nimport { String3DCustomMaterialRegistry, IMaterialInstance } from \"./materials\";\r\nimport type { String3DSynchronizer } from \"./synchronizer/String3DSynchronizer\";\r\n\r\nexport interface String3DSceneOptions {\r\n  modelLoader?: I3DModelLoader;\r\n  modelLoaderFactory?: (engine: I3DEngine, type?: string) => I3DModelLoader;\r\n}\r\n\r\nexport class String3DScene {\r\n  private _scene: I3DScene;\r\n  private _objects: Map<string, String3DObject> = new Map();\r\n  private _rootObjects: String3DObject[] = [];\r\n  private _elementMap: Map<string, HTMLElement> = new Map();\r\n  private _materialInstances: Map<string, IMaterialInstance> = new Map();\r\n  private engine: I3DEngine;\r\n  private _modelLoader?: I3DModelLoader;\r\n  private _modelLoaderFactory?: (engine: I3DEngine, type?: string) => I3DModelLoader;\r\n  private _modelLoaderCache: Map<string, I3DModelLoader> = new Map();\r\n  private _synchronizer?: String3DSynchronizer;\r\n\r\n  public get rootObjects(): String3DObject[] {\r\n    return this._rootObjects;\r\n  }\r\n\r\n  constructor(engine: I3DEngine, options: String3DSceneOptions = {}) {\r\n    this.engine = engine;\r\n    this._modelLoader = options.modelLoader;\r\n    this._modelLoaderFactory = options.modelLoaderFactory;\r\n    this._scene = engine.createScene();\r\n  }\r\n\r\n  public setSynchronizer(synchronizer: String3DSynchronizer): void {\r\n    this._synchronizer = synchronizer;\r\n  }\r\n\r\n  public getScene(): I3DScene {\r\n    return this._scene;\r\n  }\r\n\r\n  public getObject(id: string): String3DObject | undefined {\r\n    return this._objects.get(id);\r\n  }\r\n\r\n  public getObjectForElement(element: HTMLElement): String3DObject | undefined {\r\n    for (const [id, el] of this._elementMap) {\r\n      if (el === element) {\r\n        return this._objects.get(id);\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  public getAllObjects(): String3DObject[] {\r\n    const result: String3DObject[] = [];\r\n    const walk = (obj: String3DObject): void => {\r\n      result.push(obj);\r\n      obj.children.forEach((child) => walk(child));\r\n    };\r\n    this._rootObjects.forEach((obj) => walk(obj));\r\n    return result;\r\n  }\r\n\r\n  public hasObject(id: string): boolean {\r\n    return this._objects.has(id);\r\n  }\r\n\r\n  public deleteObject(id: string): boolean {\r\n    const obj = this._objects.get(id);\r\n    if (obj) {\r\n      const element = this._elementMap.get(id);\r\n      if (element && this._synchronizer) {\r\n        this._synchronizer.cleanupElement(element, obj);\r\n      }\r\n\r\n      this._scene.remove(obj.object);\r\n      this._objects.delete(id);\r\n      this._elementMap.delete(id);\r\n      this._rootObjects = this._rootObjects.filter((root) => root !== obj);\r\n      obj.destroy();\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public createFromElement(object: StringObject): void {\r\n    const type = object.getProperty<string>(\"3d\");\r\n    if (!type) return;\r\n\r\n    const element = object.htmlElement;\r\n    if (!element) return;\r\n\r\n    const onAdd = (added3DObject: String3DObject) => {\r\n      if (added3DObject) {\r\n        const parentId = object.getProperty<string>(\"parentId\");\r\n        if (parentId == null) {\r\n          this._scene.add(added3DObject.object);\r\n          this._rootObjects.push(added3DObject);\r\n        } else {\r\n          this._objects.get(parentId)?.addChild(added3DObject);\r\n        }\r\n        this._objects.set(object.id, added3DObject);\r\n        this._elementMap.set(object.id, element);\r\n        added3DObject.el = element;\r\n      }\r\n    };\r\n\r\n    switch (type) {\r\n      case \"group\":\r\n        this.createGroup(object, onAdd);\r\n        break;\r\n      case \"pointLight\":\r\n        this.createLight(object, \"point\", onAdd);\r\n        break;\r\n      case \"ambientLight\":\r\n        this.createLight(object, \"ambient\", onAdd);\r\n        break;\r\n      case \"directionalLight\":\r\n        this.createLight(object, \"directional\", onAdd);\r\n        break;\r\n      case \"spotLight\":\r\n        this.createLight(object, \"spot\", onAdd);\r\n        break;\r\n      case \"hemisphereLight\":\r\n        this.createLight(object, \"hemisphere\", onAdd);\r\n        break;\r\n      case \"model\":\r\n        this.createModel(object, onAdd);\r\n        break;\r\n      case \"box\":\r\n        this.createBox(object, onAdd);\r\n        break;\r\n      case \"sphere\":\r\n        this.createSphere(object, onAdd);\r\n        break;\r\n      case \"plane\":\r\n        this.createPlane(object, onAdd);\r\n        break;\r\n      case \"cylinder\":\r\n        this.createCylinder(object, onAdd);\r\n        break;\r\n      case \"particles\":\r\n        this.createParticles(object, onAdd);\r\n        break;\r\n      case \"text\":\r\n        this.createText(object, onAdd);\r\n        break;\r\n    }\r\n  }\r\n\r\n  private createGroup(object: StringObject, onAdd: (obj: String3DObject) => void): String3DObject {\r\n    const group = this.engine.createGroup();\r\n    const obj = new String3DObject(object.id, \"group\", group, this.engine);\r\n    onAdd(obj);\r\n    return obj;\r\n  }\r\n\r\n  private createLight(\r\n    object: StringObject,\r\n    kind: \"point\" | \"ambient\" | \"directional\" | \"spot\" | \"hemisphere\",\r\n    onAdd: (obj: String3DObject) => void\r\n  ): String3DObject {\r\n    const element = object.htmlElement;\r\n    const colorRaw = element ? readStringStyle(element, \"--light-color\", \"#ffffff\") : \"#ffffff\";\r\n    const color = colorRaw && colorRaw !== \"none\" ? colorRaw : \"#ffffff\";\r\n    const intensity = element ? readNumberStyle(element, \"--light-intensity\", 1) : 1;\r\n\r\n    let light: I3DLight;\r\n    if (kind === \"point\") {\r\n      const distance = element ? readNumberStyle(element, \"--light-distance\", 1000) : 1000;\r\n      const decay = element ? readNumberStyle(element, \"--light-decay\", 0) : 0;\r\n      light = this.engine.createPointLight(color, intensity, distance, decay);\r\n    } else if (kind === \"directional\") {\r\n      light = this.engine.createDirectionalLight(color, intensity);\r\n    } else if (kind === \"spot\") {\r\n      const distance = element ? readNumberStyle(element, \"--light-distance\", 0) : 0;\r\n      const angle = element ? readNumberStyle(element, \"--light-angle\", Math.PI / 3) : Math.PI / 3;\r\n      const penumbra = element ? readNumberStyle(element, \"--light-penumbra\", 0) : 0;\r\n      const decay = element ? readNumberStyle(element, \"--light-decay\", 1) : 1;\r\n      light = this.engine.createSpotLight(color, intensity, distance, angle, penumbra, decay);\r\n    } else if (kind === \"hemisphere\") {\r\n      const groundRaw = element\r\n        ? readStringStyle(element, \"--light-ground-color\", \"#ffffff\")\r\n        : \"#ffffff\";\r\n      const groundColor = groundRaw && groundRaw !== \"none\" ? groundRaw : \"#ffffff\";\r\n      light = this.engine.createHemisphereLight(color, groundColor, intensity);\r\n    } else {\r\n      light = this.engine.createAmbientLight(color, intensity);\r\n    }\r\n\r\n    const castShadow = element ? readBooleanStyle(element, \"--shadow-cast\", false) : false;\r\n    if (castShadow && light.shadow) {\r\n      light.castShadow = true;\r\n      const bias = element ? readNumberStyle(element, \"--shadow-bias\", 0) : 0;\r\n      const mapSize = element ? readNumberStyle(element, \"--shadow-map-size\", 512) : 512;\r\n      light.shadow.bias = bias;\r\n      light.shadow.mapSize.width = mapSize;\r\n      light.shadow.mapSize.height = mapSize;\r\n    }\r\n\r\n    const obj = new String3DObject(object.id, kind + \"Light\", light, this.engine);\r\n    onAdd(obj);\r\n    return obj;\r\n  }\r\n\r\n  private applyShadowProps(object: StringObject, mesh: any): void {\r\n    const element = object.htmlElement;\r\n    const castShadow = element ? readBooleanStyle(element, \"--shadow-cast\", false) : false;\r\n    const receiveShadow = element ? readBooleanStyle(element, \"--shadow-receive\", false) : false;\r\n    mesh.castShadow = castShadow;\r\n    mesh.receiveShadow = receiveShadow;\r\n  }\r\n\r\n  private createBox(object: StringObject, onAdd: (obj: String3DObject) => void): String3DObject {\r\n    const geometry = this.engine.createBoxGeometry(1, 1, 1);\r\n    const material = this.createMaterialFromObject(object);\r\n    const mesh = this.engine.createMesh(geometry, material);\r\n    this.applyShadowProps(object, mesh);\r\n    const obj = new String3DObject(object.id, \"box\", mesh, this.engine, {\r\n      geometry,\r\n      material,\r\n    });\r\n    onAdd(obj);\r\n    return obj;\r\n  }\r\n\r\n  private createSphere(object: StringObject, onAdd: (obj: String3DObject) => void): String3DObject {\r\n    const quality = this.getGeometryQuality(object.htmlElement);\r\n    const widthSegments = Math.max(3, Math.round(32 * quality));\r\n    const heightSegments = Math.max(2, Math.round(32 * quality));\r\n    const geometry = this.engine.createSphereGeometry(0.5, widthSegments, heightSegments);\r\n    const material = this.createMaterialFromObject(object);\r\n    const mesh = this.engine.createMesh(geometry, material);\r\n    this.applyShadowProps(object, mesh);\r\n    const obj = new String3DObject(object.id, \"sphere\", mesh, this.engine, {\r\n      geometry,\r\n      material,\r\n    });\r\n    onAdd(obj);\r\n    return obj;\r\n  }\r\n\r\n  private createPlane(object: StringObject, onAdd: (obj: String3DObject) => void): String3DObject {\r\n    const geometry = this.engine.createPlaneGeometry(1, 1);\r\n    const material = this.createMaterialFromObject(object);\r\n    const mesh = this.engine.createMesh(geometry, material);\r\n    this.applyShadowProps(object, mesh);\r\n    const obj = new String3DObject(object.id, \"plane\", mesh, this.engine, {\r\n      geometry,\r\n      material,\r\n    });\r\n    onAdd(obj);\r\n    return obj;\r\n  }\r\n\r\n  private createCylinder(\r\n    object: StringObject,\r\n    onAdd: (obj: String3DObject) => void\r\n  ): String3DObject {\r\n    const quality = this.getGeometryQuality(object.htmlElement);\r\n    const segments = Math.max(3, Math.round(32 * quality));\r\n    const geometry = this.engine.createCylinderGeometry(0.5, 0.5, 1, segments);\r\n    const material = this.createMaterialFromObject(object);\r\n    const mesh = this.engine.createMesh(geometry, material);\r\n    this.applyShadowProps(object, mesh);\r\n    const obj = new String3DObject(object.id, \"cylinder\", mesh, this.engine, {\r\n      geometry,\r\n      material,\r\n    });\r\n    onAdd(obj);\r\n    return obj;\r\n  }\r\n\r\n  private createModel(object: StringObject, onAdd: (obj: String3DObject) => void): void {\r\n    const modelPath = object.getProperty<string>(\"3d-model\");\r\n    if (!modelPath) return;\r\n\r\n    const loaderType = object.getProperty<string>(\"3d-model-loader\") || undefined;\r\n    const loader = this.resolveModelLoader(loaderType);\r\n    if (!loader) {\r\n      return;\r\n    }\r\n\r\n    const element = object.htmlElement;\r\n    if (element) {\r\n      this.applyModelTextureRemap(loader, element);\r\n    }\r\n    const shouldCenter = object.getProperty<boolean>(\"3d-model-center\") ?? false;\r\n\r\n    loader.load(\r\n      modelPath,\r\n      (gltf: any) => {\r\n        const root = gltf?.scene || gltf?.object || gltf;\r\n        if (!root) {\r\n          return;\r\n        }\r\n\r\n        const overrideMaterial =\r\n          element && this.shouldOverrideModelMaterial(element)\r\n            ? this.createMaterialFromElement(element, object)\r\n            : null;\r\n\r\n        if (typeof root.traverse === \"function\") {\r\n          root.traverse((child: any) => {\r\n            if (child.isMesh) {\r\n              if (overrideMaterial) {\r\n                child.material = overrideMaterial;\r\n              }\r\n              this.applyShadowProps(object, child);\r\n            }\r\n          });\r\n        }\r\n\r\n        if (shouldCenter) {\r\n          this.centerObject(root);\r\n        }\r\n        const obj = new String3DObject(object.id, \"model\", root, this.engine);\r\n        onAdd(obj);\r\n      },\r\n      undefined,\r\n      undefined\r\n    );\r\n  }\r\n\r\n  private createParticles(object: StringObject, onAdd: (obj: String3DObject) => void): void {\r\n    if (!this.engine.createParticleSystem) {\r\n      return;\r\n    }\r\n\r\n    const element = object.htmlElement;\r\n    const config: import(\"./abstractions/I3DEngine\").ParticleSystemConfig = {\r\n      mode: \"emitter\",\r\n      count: 300,\r\n      size: 2,\r\n      color: \"#ffffff\",\r\n      opacity: 1,\r\n      spread: 120,\r\n      spreadX: 0,\r\n      spreadY: 0,\r\n      seed: 1,\r\n      emitRate: 30,\r\n      emitBurst: 0,\r\n      particleLife: 2.5,\r\n      particleSpeed: 40,\r\n      particleDirection: [0, 1, 0] as [number, number, number],\r\n      particleGravity: [0, -30, 0] as [number, number, number],\r\n      particleDrag: 0.1,\r\n      particleSizeVariation: 0.6,\r\n      particleColorVariation: 0.2,\r\n      particleShape: \"sphere\",\r\n      particleModelUrl: \"\",\r\n      particleModelLoader: \"\",\r\n      particleModelNode: \"\",\r\n      instanceShape: \"sphere\",\r\n      instanceModelUrl: \"\",\r\n      instanceModelLoader: \"\",\r\n      instanceModelNode: \"\",\r\n      instanceScale: 1,\r\n      instanceScaleVariation: 0.5,\r\n      instanceRotationSpeed: 0.4,\r\n      instanceJitter: 0.2,\r\n      instanceFlow: 0.3,\r\n      instanceDisperse: 0,\r\n      instanceDisperseScatter: 0,\r\n      instanceDisperseScatterX: 0,\r\n      instanceDisperseScatterY: 0,\r\n      instanceDisperseScatterZ: 0,\r\n      modelTransitionDuration: 0,\r\n    };\r\n\r\n    const system = this.engine.createParticleSystem(config);\r\n    const obj = new String3DObject(object.id, \"particles\", system, this.engine);\r\n    onAdd(obj);\r\n  }\r\n\r\n  private createText(object: StringObject, onAdd: (obj: String3DObject) => void): void {\r\n    if (!this.engine.createTextGeometry) {\r\n      return;\r\n    }\r\n\r\n    const geometry = this.engine.createBoxGeometry(1, 1, 1);\r\n    const material = this.createMaterialFromObject(object);\r\n    const mesh = this.engine.createMesh(geometry, material);\r\n    this.applyShadowProps(object, mesh);\r\n\r\n    const group = this.engine.createGroup();\r\n    (group as any).__textMesh = mesh;\r\n    group.add(mesh);\r\n\r\n    const obj = new String3DObject(object.id, \"text\", group, this.engine, {\r\n      geometry,\r\n      material,\r\n    });\r\n    onAdd(obj);\r\n  }\r\n\r\n  private getGeometryQuality(element?: HTMLElement | null): number {\r\n    if (!element) return 1;\r\n    const quality = readNumberStyle(element, \"--geometry-quality\", 1);\r\n    if (!Number.isFinite(quality) || quality <= 0) return 1;\r\n    return quality;\r\n  }\r\n\r\n  private resolveModelLoader(type?: string): I3DModelLoader | undefined {\r\n    if (type) {\r\n      if (this._modelLoaderCache.has(type)) {\r\n        return this._modelLoaderCache.get(type);\r\n      }\r\n      if (!this._modelLoaderFactory) {\r\n        return undefined;\r\n      }\r\n      const loader = this._modelLoaderFactory(this.engine, type);\r\n      this._modelLoaderCache.set(type, loader);\r\n      return loader;\r\n    }\r\n\r\n    if (this._modelLoader) {\r\n      return this._modelLoader;\r\n    }\r\n\r\n    if (this._modelLoaderFactory) {\r\n      return this._modelLoaderFactory(this.engine);\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private centerObject(object: any): void {\r\n    if (!object) return;\r\n    const bbox = this.engine.computeBoundingBoxRecursively(object);\r\n    const center = this.getBoxCenter(bbox);\r\n    if (object.position?.set) {\r\n      object.position.set(-center.x, -center.y, -center.z);\r\n    }\r\n    object.updateMatrixWorld(true);\r\n  }\r\n\r\n  private getBoxCenter(box: any): I3DVector3 {\r\n    const center = this.engine.createVector3();\r\n    center.x = (box.min.x + box.max.x) / 2;\r\n    center.y = (box.min.y + box.max.y) / 2;\r\n    center.z = (box.min.z + box.max.z) / 2;\r\n    return center;\r\n  }\r\n\r\n  private createMaterialFromObject(object: StringObject): I3DMaterial {\r\n    return this.createMaterialFromElement(object.htmlElement, object);\r\n  }\r\n\r\n  private createMaterialFromElement(\r\n    element: HTMLElement | null,\r\n    object?: StringObject\r\n  ): I3DMaterial {\r\n    const style = element ? getComputedStyle(element) : null;\r\n    const getCSS = (prop: string) => (style ? style.getPropertyValue(prop).trim() : \"\");\r\n\r\n    const resolve = <T>(cssProp: string, parser: (v: string) => T, defaultValue: T): T => {\r\n      const cssVal = getCSS(cssProp);\r\n      if (cssVal && cssVal !== \"none\" && cssVal !== \"\") return parser(cssVal);\r\n      return defaultValue;\r\n    };\r\n\r\n    const parseNumber = (v: string) => parseFloat(v);\r\n    const parseColor = (v: string) => v;\r\n    const parseUrl = (v: string) => {\r\n      const match = v.match(/url\\(['\"]?(.*?)['\"]?\\)/);\r\n      return match ? match[1] : v;\r\n    };\r\n\r\n    const type = resolve(\"--material-type\", (v) => v.split(\"[\")[0] || \"basic\", \"basic\");\r\n\r\n    const customMaterial = this.tryCreateCustomMaterial(type, element, style, object);\r\n    if (customMaterial) {\r\n      return customMaterial;\r\n    }\r\n\r\n    const color = resolve(\"--material-color\", parseColor, \"#ffffff\");\r\n\r\n    const opacity = resolve(\"--opacity\", parseNumber, 1);\r\n    const metalness = resolve(\"--material-metalness\", parseNumber, 0);\r\n    const roughness = resolve(\"--material-roughness\", parseNumber, 1);\r\n    const emissive = resolve(\"--material-emissive\", parseColor, \"#000000\");\r\n\r\n    const params: any = {\r\n      color,\r\n      transparent: opacity < 1,\r\n      opacity: opacity,\r\n    };\r\n\r\n    const mapSrc = resolve(\"--texture-map\", parseUrl, \"\");\r\n    const normalMapSrc = resolve(\"--texture-normal\", parseUrl, \"\");\r\n    const roughnessMapSrc = resolve(\"--texture-roughness\", parseUrl, \"\");\r\n    const metalnessMapSrc = resolve(\"--texture-metalness\", parseUrl, \"\");\r\n    const aoMapSrc = resolve(\"--texture-ao\", parseUrl, \"\");\r\n\r\n    const flipY = this.parseFlipY(element);\r\n    const colorSpace = element ? readStringStyle(element, \"--texture-color-space\", \"\") : \"\";\r\n\r\n    const hasMaps = !!(mapSrc || normalMapSrc || roughnessMapSrc || metalnessMapSrc || aoMapSrc);\r\n    let finalType = type;\r\n    if (finalType !== \"standard\" && hasMaps) {\r\n      finalType = \"standard\";\r\n    }\r\n\r\n    if (finalType === \"standard\") {\r\n      if (mapSrc) params.map = this.loadTexture(mapSrc, { flipY, colorSpace });\r\n      if (normalMapSrc) params.normalMap = this.loadTexture(normalMapSrc, { flipY });\r\n      if (roughnessMapSrc) params.roughnessMap = this.loadTexture(roughnessMapSrc, { flipY });\r\n      if (metalnessMapSrc) params.metalnessMap = this.loadTexture(metalnessMapSrc, { flipY });\r\n      if (aoMapSrc) params.aoMap = this.loadTexture(aoMapSrc, { flipY });\r\n\r\n      params.metalness = metalness;\r\n      params.roughness = roughness;\r\n      params.emissive = emissive;\r\n\r\n      return this.engine.createMeshStandardMaterial(params);\r\n    }\r\n\r\n    return this.engine.createMeshBasicMaterial(params);\r\n  }\r\n\r\n  private tryCreateCustomMaterial(\r\n    type: string,\r\n    element: HTMLElement | null,\r\n    style: CSSStyleDeclaration | null,\r\n    object?: StringObject\r\n  ): I3DMaterial | null {\r\n    const definition = String3DCustomMaterialRegistry.get(type);\r\n    if (!definition) {\r\n      return null;\r\n    }\r\n\r\n    const factory = this.engine.getMaterialFactory?.();\r\n    if (!factory) {\r\n      return null;\r\n    }\r\n    if (!factory.supports(definition)) {\r\n      return null;\r\n    }\r\n\r\n    let initialUniforms: Record<string, any> = {};\r\n    if (element && style) {\r\n      initialUniforms = factory.parseUniformsFromCSS(definition, element, style);\r\n    }\r\n\r\n    const instance = factory.create(definition, initialUniforms);\r\n\r\n    if (object) {\r\n      this._materialInstances.set(object.id, instance);\r\n    }\r\n\r\n    return instance.material;\r\n  }\r\n\r\n  public updateMaterialUniforms(objectId: string, uniforms: Record<string, any>): void {\r\n    const instance = this._materialInstances.get(objectId);\r\n    if (instance) {\r\n      instance.update(uniforms);\r\n    }\r\n  }\r\n\r\n  public getMaterialInstance(objectId: string): IMaterialInstance | undefined {\r\n    return this._materialInstances.get(objectId);\r\n  }\r\n\r\n  public recreateMaterialForObject(object: String3DObject, element: HTMLElement | null): void {\r\n    const oldInstance = this._materialInstances.get(object.id);\r\n    if (oldInstance && oldInstance.dispose) {\r\n      oldInstance.dispose();\r\n    }\r\n    this._materialInstances.delete(object.id);\r\n\r\n    let stringObject: StringObject | undefined;\r\n    for (const [id, el] of this._elementMap) {\r\n      if (id === object.id && el === element) {\r\n        stringObject = (el as any).__stringObject || (el as any).stringObject;\r\n        break;\r\n      }\r\n    }\r\n\r\n    const newMaterial = this.createMaterialFromElement(element, stringObject);\r\n\r\n    if (object.object && object.object.traverse) {\r\n      object.object.traverse((child: any) => {\r\n        if (child.material) {\r\n          if (child.material.dispose) {\r\n            child.material.dispose();\r\n          }\r\n          child.material = newMaterial;\r\n        }\r\n      });\r\n    }\r\n\r\n    object.material = newMaterial;\r\n  }\r\n\r\n  private loadTexture(src: string, options: { flipY?: boolean; colorSpace?: string } = {}): any {\r\n    const textureLoader = this.engine.createTextureLoader();\r\n    const texture = textureLoader.load(src);\r\n    if (typeof options.flipY === \"boolean\") {\r\n      texture.flipY = options.flipY;\r\n    }\r\n    const colorSpace = (options.colorSpace || \"\").toLowerCase().trim();\r\n    if (colorSpace && \"colorSpace\" in texture) {\r\n      texture.colorSpace = colorSpace === \"srgb\" ? \"srgb\" : \"linear\";\r\n    }\r\n    texture.needsUpdate = true;\r\n    return texture;\r\n  }\r\n\r\n  private parseFlipY(element?: HTMLElement | null): boolean | undefined {\r\n    const value = element ? readStringStyle(element, \"--texture-flip-y\", \"\") : \"\";\r\n    if (value === undefined || value === null || value === \"\") return undefined;\r\n    if (typeof value === \"boolean\") return value;\r\n    const normalized = String(value).toLowerCase().trim();\r\n    if (normalized === \"false\" || normalized === \"0\" || normalized === \"no\") return false;\r\n    if (normalized === \"true\" || normalized === \"1\" || normalized === \"yes\") return true;\r\n    return undefined;\r\n  }\r\n\r\n  private shouldOverrideModelMaterial(element: HTMLElement): boolean {\r\n    const style = getComputedStyle(element);\r\n    const hasStyle = (prop: string) => {\r\n      const val = style.getPropertyValue(prop);\r\n      return val && val !== \"0\" && val !== \"none\" && val !== \"\";\r\n    };\r\n\r\n    if (hasStyle(\"--material-color\") || hasStyle(\"--texture-map\")) return true;\r\n\r\n    const cssVars = [\r\n      \"--material-type\",\r\n      \"--material-metalness\",\r\n      \"--material-roughness\",\r\n      \"--material-emissive\",\r\n      \"--opacity\",\r\n      \"--texture-normal\",\r\n      \"--texture-roughness\",\r\n      \"--texture-metalness\",\r\n      \"--texture-ao\",\r\n    ];\r\n    return cssVars.some((prop) => hasStyle(prop));\r\n  }\r\n\r\n  private applyModelTextureRemap(loader: any, element: HTMLElement): void {\r\n    const baseRaw = (element.getAttribute(\"string-3d-model-texture-base\") || \"\").trim();\r\n    const base = baseRaw ? baseRaw.replace(/\\/?$/, \"/\") : \"\";\r\n    const mappingRaw = element.getAttribute(\"string-3d-model-textures\");\r\n    let mapping: Record<string, string> | null = null;\r\n\r\n    if (mappingRaw) {\r\n      try {\r\n        mapping = JSON.parse(mappingRaw);\r\n      } catch (error) {}\r\n    }\r\n\r\n    const manager = loader?.manager;\r\n    if (!manager || typeof manager.setURLModifier !== \"function\") {\r\n      return;\r\n    }\r\n\r\n    manager.setURLModifier((url: string) => {\r\n      const mapped = mapping && url in mapping ? mapping[url] : url;\r\n      if (!base) return mapped;\r\n      if (/^(blob:|data:|https?:|file:|\\/)/i.test(mapped)) return mapped;\r\n      return base + mapped.replace(/^\\.?\\//, \"\");\r\n    });\r\n  }\r\n\r\n  public destroy(): void {\r\n    this._materialInstances.forEach((instance) => instance.dispose());\r\n    this._materialInstances.clear();\r\n    this._objects.forEach((obj) => obj.destroy());\r\n    this._objects.clear();\r\n    this._rootObjects = [];\r\n  }\r\n}\r\n","import type { SyncContext } from \"./SyncContext\";\n\nexport class StyleBundleCache<T> {\n  private cache: WeakMap<HTMLElement, T> = new WeakMap();\n  private meta: WeakMap<HTMLElement, { time: number }> = new WeakMap();\n\n  get(el: HTMLElement, ctx: SyncContext, reader: (el: HTMLElement) => T): T {\n    const canUseCache = !!ctx.dirtySet && ctx.forceSync === false && !ctx.dirtySet.has(el);\n    if (canUseCache) {\n      const cached = this.cache.get(el);\n      if (cached) return cached;\n    }\n\n    const now = performance.now();\n    const interval = Math.max(0, ctx.styleReadIntervalMs ?? 0);\n    if (interval > 0) {\n      const metaData = this.meta.get(el);\n      const cached = this.cache.get(el);\n      if (metaData && cached && now - metaData.time < interval) {\n        return cached;\n      }\n    }\n\n    const bundle = reader(el);\n    this.cache.set(el, bundle);\n    this.meta.set(el, { time: now });\n    return bundle;\n  }\n\n  clear(): void {\n    this.cache = new WeakMap();\n    this.meta = new WeakMap();\n  }\n}\n","import { String3DObject } from \"../String3DObject\";\nimport type { String3DObjectSyncStrategy } from \"./String3DObjectSyncStrategy\";\nimport type { SyncContext } from \"./SyncContext\";\nimport { StyleReader } from \"../../modules/string3d/styleUtils\";\nimport { StyleBundleCache } from \"./StyleBundleCache\";\n\nconst DEG_TO_RAD = Math.PI / 180;\n\ntype GroupStyleBundle = {\n  translateZ: number;\n  scale: number;\n  rotateX: number;\n  rotateY: number;\n  rotateZ: number;\n};\n\nexport class GroupSynchronizer implements String3DObjectSyncStrategy {\n  private static styleCache = new StyleBundleCache<GroupStyleBundle>();\n\n  sync(el: HTMLElement, object: String3DObject, ctx: SyncContext, parentData: any): any {\n    const cached = (el as any).__layoutCache;\n    const rect = cached ? cached.rect : el.getBoundingClientRect();\n    const bundle = this.readStyleBundle(el, ctx);\n\n    const screenCenterX = rect.left + rect.width * 0.5;\n    const screenCenterY = rect.top + rect.height * 0.5;\n\n    if (ctx.camera.getMode() === \"orthographic\") {\n      object.object.position.set(\n        screenCenterX - ctx.viewportWidth / 2,\n        -(screenCenterY - ctx.viewportHeight / 2),\n        bundle.translateZ\n      );\n    } else {\n      const frustum = ctx.camera.getFrustumSizeAt(bundle.translateZ);\n      const normalizedX = screenCenterX / ctx.viewportWidth;\n      const normalizedY = screenCenterY / ctx.viewportHeight;\n      object.object.position.set(\n        (normalizedX - 0.5) * frustum.width,\n        -(normalizedY - 0.5) * frustum.height,\n        bundle.translateZ\n      );\n    }\n\n    object.object.scale.set(bundle.scale, bundle.scale, bundle.scale);\n\n    object.object.rotation.x = -bundle.rotateX * DEG_TO_RAD;\n    object.object.rotation.y = bundle.rotateY * DEG_TO_RAD;\n    object.object.rotation.z = -bundle.rotateZ * DEG_TO_RAD;\n    object.object.rotation.order = \"XYZ\";\n\n    object.object.updateMatrixWorld(true);\n\n    return { scale: bundle.scale };\n  }\n\n  private readStyleBundle(el: HTMLElement, ctx: SyncContext): GroupStyleBundle {\n    return GroupSynchronizer.styleCache.get(el, ctx, (el) => {\n      const styles = new StyleReader(el);\n      return {\n        translateZ: styles.readNumber(\"--translate-z\", 0),\n        scale: styles.readNumber(\"--scale\", 1),\n        rotateX: styles.readNumber(\"--rotate-x\", 0),\n        rotateY: styles.readNumber(\"--rotate-y\", 0),\n        rotateZ: styles.readNumber(\"--rotate-z\", 0),\n      };\n    });\n  }\n}\n","import { String3DObject } from \"../String3DObject\";\nimport type { String3DObjectSyncStrategy } from \"./String3DObjectSyncStrategy\";\nimport type { SyncContext } from \"./SyncContext\";\nimport { I3DLight } from \"../abstractions/I3DEngine\";\nimport { StyleReader } from \"../../modules/string3d/styleUtils\";\nimport { StyleBundleCache } from \"./StyleBundleCache\";\n\ntype LightStyleBundle = {\n  translateZ: number;\n  translateX: number;\n  translateY: number;\n  color?: string;\n  intensity: number;\n  distance?: number;\n  decay?: number;\n  angle?: number;\n  penumbra?: number;\n  groundColor?: string;\n  castShadow: boolean;\n  shadowBias?: number;\n  shadowMapSize?: number;\n  targetId?: string;\n  targetOffset?: { x: number; y: number; z: number };\n};\n\nexport class LightSynchronizer implements String3DObjectSyncStrategy {\n  private static styleCache = new StyleBundleCache<LightStyleBundle>();\n\n  sync(el: HTMLElement, object: String3DObject, ctx: SyncContext, parentData: any): any {\n    const cached = (el as any).__layoutCache;\n    const rect = cached ? cached.rect : el.getBoundingClientRect();\n    const bundle = this.readStyleBundle(el, ctx, object);\n\n    const screenCenterX = rect.left + rect.width * 0.5;\n    const screenCenterY = rect.top + rect.height * 0.5;\n\n    if (ctx.camera.getMode() === \"orthographic\") {\n      object.object.position.set(\n        screenCenterX - ctx.viewportWidth / 2 + bundle.translateX,\n        -(screenCenterY - ctx.viewportHeight / 2) + bundle.translateY,\n        bundle.translateZ\n      );\n    } else {\n      const frustum = ctx.camera.getFrustumSizeAt(bundle.translateZ);\n      const normalizedX = screenCenterX / ctx.viewportWidth;\n      const normalizedY = screenCenterY / ctx.viewportHeight;\n      object.object.position.set(\n        (normalizedX - 0.5) * frustum.width + bundle.translateX,\n        -(normalizedY - 0.5) * frustum.height + bundle.translateY,\n        bundle.translateZ\n      );\n    }\n\n    const light = object.object as I3DLight;\n\n    if (\n      bundle.color &&\n      bundle.color !== \"none\" &&\n      light.color &&\n      typeof light.color.set === \"function\"\n    ) {\n      light.color.set(bundle.color);\n    }\n\n    light.intensity = bundle.intensity;\n\n    if (typeof light.distance !== \"undefined\" && bundle.distance !== undefined) {\n      light.distance = bundle.distance;\n    }\n    if (typeof light.decay !== \"undefined\" && bundle.decay !== undefined) {\n      light.decay = bundle.decay;\n    }\n\n    if (typeof light.angle !== \"undefined\" && bundle.angle !== undefined) {\n      light.angle = bundle.angle;\n    }\n    if (typeof light.penumbra !== \"undefined\" && bundle.penumbra !== undefined) {\n      light.penumbra = bundle.penumbra;\n    }\n\n    if (\n      bundle.groundColor &&\n      bundle.groundColor !== \"none\" &&\n      (light as any).groundColor &&\n      typeof (light as any).groundColor.set === \"function\"\n    ) {\n      (light as any).groundColor.set(bundle.groundColor);\n    }\n\n    if (light.castShadow !== bundle.castShadow) {\n      light.castShadow = bundle.castShadow;\n    }\n    if (bundle.castShadow && light.shadow) {\n      if (bundle.shadowBias !== undefined) {\n        light.shadow.bias = bundle.shadowBias;\n      }\n      if (\n        bundle.shadowMapSize !== undefined &&\n        light.shadow.mapSize.width !== bundle.shadowMapSize\n      ) {\n        light.shadow.mapSize.width = bundle.shadowMapSize;\n        light.shadow.mapSize.height = bundle.shadowMapSize;\n      }\n    }\n\n    if (bundle.targetId && bundle.targetId !== \"none\" && light.target) {\n      const targetEl = document.querySelector(`[string-id=\"${bundle.targetId}\"]`);\n      if (targetEl) {\n        const tCached = (targetEl as any).__layoutCache;\n        const tRect = tCached ? tCached.rect : targetEl.getBoundingClientRect();\n        const tStyles = new StyleReader(targetEl as HTMLElement);\n        const tTranslateZ = tStyles.readNumber(\"--translate-z\", 0);\n\n        const tScreenCenterX = tRect.left + tRect.width * 0.5;\n        const tScreenCenterY = tRect.top + tRect.height * 0.5;\n\n        let x: number;\n        let y: number;\n        let z: number;\n        if (ctx.camera.getMode() === \"orthographic\") {\n          x = tScreenCenterX - ctx.viewportWidth / 2;\n          y = -(tScreenCenterY - ctx.viewportHeight / 2);\n          z = tTranslateZ;\n        } else {\n          const frustum = ctx.camera.getFrustumSizeAt(tTranslateZ);\n          const normalizedX = tScreenCenterX / ctx.viewportWidth;\n          const normalizedY = tScreenCenterY / ctx.viewportHeight;\n          x = (normalizedX - 0.5) * frustum.width;\n          y = -(normalizedY - 0.5) * frustum.height;\n          z = tTranslateZ;\n        }\n\n        if (bundle.targetOffset) {\n          x += bundle.targetOffset.x;\n          y += bundle.targetOffset.y;\n          z += bundle.targetOffset.z;\n        }\n\n        light.target.position.set(x, y, z);\n\n        light.target.updateMatrixWorld(true);\n      }\n    }\n\n    return null;\n  }\n\n  private readStyleBundle(\n    el: HTMLElement,\n    ctx: SyncContext,\n    object: String3DObject\n  ): LightStyleBundle {\n    return LightSynchronizer.styleCache.get(el, ctx, (el) => {\n      const styles = new StyleReader(el);\n      const light = object.object as I3DLight;\n\n      const bundle: LightStyleBundle = {\n        translateZ: styles.readNumber(\"--translate-z\", 0),\n        translateX: styles.readNumber(\"--translate-x\", 0),\n        translateY: styles.readNumber(\"--translate-y\", 0),\n        color: styles.readString(\"--light-color\", \"\") || undefined,\n        intensity: styles.readNumber(\"--light-intensity\", light.intensity ?? 1),\n        castShadow: styles.readBoolean(\"--shadow-cast\", false),\n      };\n\n      if (typeof light.distance !== \"undefined\") {\n        bundle.distance = styles.readNumber(\"--light-distance\", light.distance ?? 0);\n      }\n      if (typeof light.decay !== \"undefined\") {\n        bundle.decay = styles.readNumber(\"--light-decay\", light.decay ?? 1);\n      }\n      if (typeof light.angle !== \"undefined\") {\n        bundle.angle = styles.readNumber(\"--light-angle\", light.angle ?? Math.PI / 3);\n      }\n      if (typeof light.penumbra !== \"undefined\") {\n        bundle.penumbra = styles.readNumber(\"--light-penumbra\", light.penumbra ?? 0);\n      }\n\n      const groundColor = styles.readString(\"--light-ground-color\", \"\");\n      if (groundColor) bundle.groundColor = groundColor;\n\n      if (bundle.castShadow && light.shadow) {\n        bundle.shadowBias = styles.readNumber(\"--shadow-bias\", light.shadow.bias ?? 0);\n        bundle.shadowMapSize = styles.readNumber(\n          \"--shadow-map-size\",\n          light.shadow.mapSize.width ?? 512\n        );\n      }\n\n      const targetId = styles.readString(\"--light-target\", \"\").trim();\n      if (targetId) bundle.targetId = targetId;\n      const offsetRaw = styles.readString(\"--light-target-offset\", \"\").trim();\n      if (offsetRaw) {\n        const offset = this.parseTargetOffset(offsetRaw);\n        if (offset) bundle.targetOffset = offset;\n      }\n\n      return bundle;\n    });\n  }\n\n  private parseTargetOffset(value: string): { x: number; y: number; z: number } | null {\n    const parts = value\n      .split(/[\\s,]+/)\n      .map((part) => part.trim())\n      .filter(Boolean)\n      .map((part) => Number.parseFloat(part));\n    if (parts.length < 3 || parts.some((num) => Number.isNaN(num))) return null;\n    return { x: parts[0], y: parts[1], z: parts[2] };\n  }\n}\n","import { String3DObject } from \"../String3DObject\";\nimport type { SyncContext } from \"./SyncContext\";\nimport type { String3DObjectSyncStrategy } from \"./String3DObjectSyncStrategy\";\nimport { StyleBundleCache } from \"./StyleBundleCache\";\n\nconst DEG_TO_RAD = Math.PI / 180;\n\nexport class MeshSynchronizer implements String3DObjectSyncStrategy {\n  private static styleCache = new StyleBundleCache<StyleBundle>();\n  private static layoutCache = new StyleBundleCache<LayoutBundle>();\n  private static tempVector3: any = null;\n  private static lastVisualProps: WeakMap<\n    String3DObject,\n    {\n      opacity?: number;\n      color?: string;\n      metalness?: number;\n      roughness?: number;\n      emissive?: string;\n      castShadow?: boolean;\n      receiveShadow?: boolean;\n    }\n  > = new WeakMap();\n  private static lastGeometryQuality: WeakMap<String3DObject, number> = new WeakMap();\n\n  static applyVisualProps(\n    el: HTMLElement,\n    object: String3DObject,\n    props: {\n      opacity?: number;\n      color?: string;\n      metalness?: number;\n      roughness?: number;\n      emissive?: string;\n      castShadow?: boolean;\n      receiveShadow?: boolean;\n    }\n  ): void {\n    const prev = MeshSynchronizer.lastVisualProps.get(object);\n    if (prev) {\n      if (\n        prev.opacity === props.opacity &&\n        prev.color === props.color &&\n        prev.metalness === props.metalness &&\n        prev.roughness === props.roughness &&\n        prev.emissive === props.emissive &&\n        prev.castShadow === props.castShadow &&\n        prev.receiveShadow === props.receiveShadow\n      )\n        return;\n      prev.opacity = props.opacity;\n      prev.color = props.color;\n      prev.metalness = props.metalness;\n      prev.roughness = props.roughness;\n      prev.emissive = props.emissive;\n      prev.castShadow = props.castShadow;\n      prev.receiveShadow = props.receiveShadow;\n    } else {\n      MeshSynchronizer.lastVisualProps.set(object, {\n        opacity: props.opacity,\n        color: props.color,\n        metalness: props.metalness,\n        roughness: props.roughness,\n        emissive: props.emissive,\n        castShadow: props.castShadow,\n        receiveShadow: props.receiveShadow,\n      });\n    }\n\n    const castShadow = props.castShadow ?? false;\n    const receiveShadow = props.receiveShadow ?? false;\n\n    const opacity = typeof props.opacity === \"number\" ? props.opacity : NaN;\n\n    const applyMaterialProps = (mat: any) => {\n      if (!mat) return;\n\n      if (!isNaN(opacity)) {\n        mat.opacity = opacity;\n        mat.transparent = opacity < 1;\n      }\n\n      if (props.color && mat.color && mat.color.set) {\n        mat.color.set(props.color);\n      }\n\n      if (typeof props.metalness === \"number\" && \"metalness\" in mat) {\n        mat.metalness = props.metalness;\n      }\n\n      if (typeof props.roughness === \"number\" && \"roughness\" in mat) {\n        mat.roughness = props.roughness;\n      }\n\n      if (props.emissive && mat.emissive && mat.emissive.set) {\n        mat.emissive.set(props.emissive);\n      }\n    };\n\n    if (object.object.traverse) {\n      object.object.traverse((child: any) => {\n        if (child.isMesh) {\n          if (child.castShadow !== castShadow) child.castShadow = castShadow;\n          if (child.receiveShadow !== receiveShadow) child.receiveShadow = receiveShadow;\n\n          const materials = Array.isArray(child.material) ? child.material : [child.material];\n          materials.forEach(applyMaterialProps);\n        }\n      });\n    } else if ((object.object as any).isMesh) {\n      const mesh = object.object as any;\n      if (mesh.castShadow !== castShadow) mesh.castShadow = castShadow;\n      if (mesh.receiveShadow !== receiveShadow) mesh.receiveShadow = receiveShadow;\n\n      const materials = Array.isArray(mesh.material) ? mesh.material : [mesh.material];\n      materials.forEach(applyMaterialProps);\n    }\n  }\n\n  sync(el: HTMLElement, object: String3DObject, ctx: SyncContext, parentData: any): any {\n    const { rect, width: originalWidth, height: originalHeight } = this.readLayout(el, ctx);\n    const bundle = this.readStyleBundle(el, ctx);\n    const {\n      translateZ,\n      cssScale,\n      rotateX,\n      rotateY,\n      rotateZ,\n      cssScaleZ,\n      opacity,\n      color,\n      metalness,\n      roughness,\n      emissive,\n      castShadow,\n      receiveShadow,\n      geometryQuality,\n    } = bundle;\n\n    const screenCenterX = rect.left + rect.width * 0.5;\n    const screenCenterY = rect.top + rect.height * 0.5;\n\n    if (ctx.camera.getMode() === \"orthographic\") {\n      object.object.position.set(\n        screenCenterX - ctx.viewportWidth / 2,\n        -(screenCenterY - ctx.viewportHeight / 2),\n        translateZ\n      );\n    } else {\n      const frustum = ctx.camera.getFrustumSizeAt(translateZ);\n      const normalizedX = screenCenterX / ctx.viewportWidth;\n      const normalizedY = screenCenterY / ctx.viewportHeight;\n      object.object.position.set(\n        (normalizedX - 0.5) * frustum.width,\n        -(normalizedY - 0.5) * frustum.height,\n        translateZ\n      );\n    }\n\n    object.object.rotation.x = -rotateX * DEG_TO_RAD;\n    object.object.rotation.y = rotateY * DEG_TO_RAD;\n    object.object.rotation.z = -rotateZ * DEG_TO_RAD;\n    object.object.rotation.order = \"XYZ\";\n\n    const targetWidth = originalWidth * cssScale;\n    const targetHeight = originalHeight * cssScale;\n    const parentScale = parentData?.scale || 1;\n    const baseScaleZ = cssScaleZ * parentScale;\n    const minTargetSize = targetWidth < targetHeight ? targetWidth : targetHeight;\n    let scaleX: number, scaleY: number, scaleZ: number;\n\n    switch (object.type) {\n      case \"box\":\n      case \"sphere\": {\n        const uniformSize = minTargetSize * parentScale;\n        scaleX = scaleY = uniformSize;\n        scaleZ = uniformSize * cssScaleZ;\n        break;\n      }\n      case \"model\": {\n        const bbox = object.getOriginalBoundingBox();\n        if (!MeshSynchronizer.tempVector3) {\n          MeshSynchronizer.tempVector3 = ctx.engine.createVector3();\n        }\n        const size = bbox.getSize(MeshSynchronizer.tempVector3);\n        const fitMode = el.getAttribute(\"string-3d-model-fit\");\n        const modelScale = parseFloat(el.getAttribute(\"string-3d-model-scale\") || \"1\");\n        const finalModelScale = Number.isFinite(modelScale)\n          ? modelScale * parentScale\n          : parentScale;\n\n        if (size.x > 0 && size.y > 0) {\n          const scaleW = targetWidth / size.x;\n          const scaleH = targetHeight / size.y;\n          const uniformScale =\n            (fitMode === \"cover\"\n              ? scaleW > scaleH\n                ? scaleW\n                : scaleH\n              : scaleW < scaleH\n              ? scaleW\n              : scaleH) * finalModelScale;\n          scaleX = scaleY = uniformScale;\n          scaleZ = uniformScale * cssScaleZ;\n        } else {\n          const fallbackSize = minTargetSize * finalModelScale;\n          scaleX = scaleY = fallbackSize;\n          scaleZ = fallbackSize * cssScaleZ;\n        }\n        break;\n      }\n      case \"cylinder\":\n        scaleX = targetWidth * parentScale;\n        scaleY = targetHeight * parentScale;\n        scaleZ = targetWidth * baseScaleZ;\n        break;\n      default:\n        scaleX = targetWidth * parentScale;\n        scaleY = targetHeight * parentScale;\n        scaleZ = minTargetSize * 0.5 * baseScaleZ;\n        break;\n    }\n\n    object.object.scale.set(scaleX, scaleY, scaleZ);\n\n    MeshSynchronizer.applyVisualProps(el, object, {\n      opacity,\n      color: color && color !== \"none\" ? color : undefined,\n      metalness: isNaN(metalness) ? undefined : metalness,\n      roughness: isNaN(roughness) ? undefined : roughness,\n      emissive: emissive && emissive !== \"none\" ? emissive : undefined,\n      castShadow,\n      receiveShadow,\n    });\n\n    this.applyGeometryQuality(object, geometryQuality, ctx);\n\n    this.updateCustomUniforms(el, object, ctx);\n\n    return { scale: cssScale * parentScale };\n  }\n\n  private applyGeometryQuality(object: String3DObject, quality: number, ctx: SyncContext): void {\n    const engine: any = ctx.engine as any;\n    const simplify = engine?.simplifyGeometry?.bind(engine);\n    if (typeof simplify !== \"function\") return;\n\n    const normalized = Number.isFinite(quality) && quality > 0 ? quality : 1;\n    const prev = MeshSynchronizer.lastGeometryQuality.get(object);\n    if (typeof prev === \"number\" && Math.abs(prev - normalized) < 0.001) return;\n    MeshSynchronizer.lastGeometryQuality.set(object, normalized);\n\n    const applyToMesh = (mesh: any) => {\n      if (!mesh?.geometry) return;\n      const userData = mesh.userData || (mesh.userData = {});\n      if (!userData.__originalGeometry) {\n        userData.__originalGeometry = mesh.geometry;\n      }\n      const original = userData.__originalGeometry;\n      if (normalized >= 0.999) {\n        mesh.geometry = original;\n        return;\n      }\n      if (!userData.__lodCache) {\n        userData.__lodCache = new Map<string, any>();\n      }\n      const key = normalized.toFixed(3);\n      if (userData.__lodCache.has(key)) {\n        mesh.geometry = userData.__lodCache.get(key);\n        return;\n      }\n      const simplified = simplify(original, normalized);\n      if (simplified) {\n        userData.__lodCache.set(key, simplified);\n        mesh.geometry = simplified;\n      }\n    };\n\n    if (object.object.traverse) {\n      object.object.traverse((child: any) => {\n        if (child?.isMesh) applyToMesh(child);\n      });\n    } else if ((object.object as any).isMesh) {\n      applyToMesh(object.object as any);\n    }\n  }\n\n  private updateCustomUniforms(el: HTMLElement, object: String3DObject, ctx: SyncContext): void {\n    const factory = ctx.engine.getMaterialFactory?.();\n    if (!factory) return;\n\n    const style = getComputedStyle(el);\n\n    const apply = (mat: any) => {\n      const definition = mat?.userData?.definition;\n      if (!definition?.uniforms) return;\n\n      const values = factory.parseUniformsFromCSS(definition, el, style);\n\n      for (const [key, value] of Object.entries(values)) {\n        const def = definition.uniforms?.[key];\n        if (!def) continue;\n\n        const converter = (factory as any).convertUniformValue?.bind(factory);\n        const converted = converter ? converter(def.type, value) : value;\n\n        if (mat.userData?.shader?.uniforms?.[key]) {\n          mat.userData.shader.uniforms[key].value = converted;\n        } else if (mat.userData?.customUniforms?.[key]) {\n          mat.userData.customUniforms[key].value = converted;\n        } else if (mat.uniforms?.[key]) {\n          mat.uniforms[key].value = converted;\n        }\n      }\n    };\n\n    if (object.object.traverse) {\n      object.object.traverse((child: any) => {\n        if (child.isMesh) {\n          const materials = Array.isArray(child.material) ? child.material : [child.material];\n          materials.forEach(apply);\n        }\n      });\n    } else if ((object.object as any).isMesh) {\n      const mesh = object.object as any;\n      const materials = Array.isArray(mesh.material) ? mesh.material : [mesh.material];\n      materials.forEach(apply);\n    }\n  }\n\n  private readStyleBundle(el: HTMLElement, ctx: SyncContext): StyleBundle {\n    return MeshSynchronizer.styleCache.get(el, ctx, (el) => {\n      const styleMap = (el as any).computedStyleMap?.();\n      const style = getComputedStyle(el);\n\n      const readNumber = (prop: string, fallback: number): number => {\n        const mapValue = styleMap?.get?.(prop);\n        if (mapValue !== undefined && mapValue !== null) {\n          const val =\n            typeof mapValue === \"object\" && \"value\" in (mapValue as any)\n              ? (mapValue as any).value\n              : mapValue;\n          const num = typeof val === \"number\" ? val : Number.parseFloat(String(val));\n          if (!Number.isNaN(num)) return num;\n        }\n        const num = Number.parseFloat(style.getPropertyValue(prop));\n        return Number.isNaN(num) ? fallback : num;\n      };\n\n      const readString = (prop: string): string | undefined => {\n        const mapValue = styleMap?.get?.(prop);\n        const val =\n          mapValue && typeof mapValue === \"object\" && \"value\" in (mapValue as any)\n            ? (mapValue as any).value\n            : mapValue;\n        if (typeof val === \"string\") return val.trim() || undefined;\n        const raw = style.getPropertyValue(prop).trim();\n        return raw || undefined;\n      };\n\n      const readBool = (prop: string, fallback = false): boolean => {\n        const raw = readString(prop);\n        if (!raw) return fallback;\n        const norm = raw.toLowerCase();\n        return norm === \"true\" || norm === \"1\" || norm === \"yes\"\n          ? true\n          : norm === \"false\" || norm === \"0\" || norm === \"no\"\n          ? false\n          : fallback;\n      };\n\n      return {\n        translateZ: readNumber(\"--translate-z\", 0),\n        cssScale: readNumber(\"--scale\", 1),\n        rotateX: readNumber(\"--rotate-x\", 0),\n        rotateY: readNumber(\"--rotate-y\", 0),\n        rotateZ: readNumber(\"--rotate-z\", 0),\n        cssScaleZ: readNumber(\"--scale-z\", 1),\n        opacity: readNumber(\"--opacity\", NaN),\n        color: readString(\"--material-color\"),\n        metalness: readNumber(\"--material-metalness\", NaN),\n        roughness: readNumber(\"--material-roughness\", NaN),\n        emissive: readString(\"--material-emissive\"),\n        castShadow: readBool(\"--shadow-cast\", false),\n        receiveShadow: readBool(\"--shadow-receive\", false),\n        geometryQuality: readNumber(\"--geometry-quality\", 1),\n      };\n    });\n  }\n\n  private readLayout(el: HTMLElement, ctx: SyncContext): LayoutBundle {\n    const cached = (el as any).__layoutCache;\n    if (cached) {\n      return cached;\n    }\n\n    return MeshSynchronizer.layoutCache.get(el, ctx, (el) => {\n      const rect = el.getBoundingClientRect();\n      const width = el.offsetWidth || rect.width;\n      const height = el.offsetHeight || rect.height;\n      return { rect, width, height };\n    });\n  }\n}\n\ntype StyleBundle = {\n  translateZ: number;\n  cssScale: number;\n  rotateX: number;\n  rotateY: number;\n  rotateZ: number;\n  cssScaleZ: number;\n  opacity: number;\n  color?: string;\n  metalness: number;\n  roughness: number;\n  emissive?: string;\n  castShadow: boolean;\n  receiveShadow: boolean;\n  geometryQuality: number;\n};\n\ntype LayoutBundle = {\n  rect: DOMRect;\n  width: number;\n  height: number;\n};\n","import { String3DObject } from \"../String3DObject\";\r\nimport type { String3DObjectSyncStrategy } from \"./String3DObjectSyncStrategy\";\r\nimport type { SyncContext } from \"./SyncContext\";\r\nimport { StyleReader } from \"../../modules/string3d/styleUtils\";\r\nimport { StyleBundleCache } from \"./StyleBundleCache\";\r\nimport type { ParticleSystemConfig } from \"../abstractions/I3DEngine\";\r\nimport { String3DCustomMaterialRegistry } from \"../materials\";\r\nimport type { IMaterialInstance } from \"../materials\";\r\n\r\ntype ParticleStyleBundle = ParticleSystemConfig & {\r\n  translateZ: number;\r\n  scale: number;\r\n  rotateX: number;\r\n  rotateY: number;\r\n  rotateZ: number;\r\n  particlesFit: boolean;\r\n  materialType: string;\r\n};\r\n\r\nconst DEG_TO_RAD = Math.PI / 180;\r\n\r\nconst DEFAULT_CONFIG: ParticleSystemConfig = {\r\n  mode: \"emitter\",\r\n  count: 300,\r\n  size: 2,\r\n  color: \"#ffffff\",\r\n  opacity: 1,\r\n  spread: 120,\r\n  spreadX: 120,\r\n  spreadY: 120,\r\n  seed: 1,\r\n  emitRate: 30,\r\n  emitBurst: 0,\r\n  particleLife: 2.5,\r\n  particleSpeed: 40,\r\n  particleDirection: [0, 1, 0],\r\n  particleGravity: [0, -30, 0],\r\n  particleDrag: 0.1,\r\n  particleSizeVariation: 0.6,\r\n  particleColorVariation: 0.2,\r\n  particleShape: \"sphere\",\r\n  particleModelUrl: \"\",\r\n  particleModelLoader: \"\",\r\n  particleModelNode: \"\",\r\n  instanceShape: \"sphere\",\r\n  instanceModelUrl: \"\",\r\n  instanceModelLoader: \"\",\r\n  instanceModelNode: \"\",\r\n  instanceScale: 1,\r\n  instanceScaleVariation: 0.5,\r\n  instanceRotationSpeed: 0.4,\r\n  instanceJitter: 0.2,\r\n  instanceFlow: 0.3,\r\n  instanceDisperse: 0,\r\n  instanceDisperseScatter: 0,\r\n  instanceDisperseScatterX: 0,\r\n  instanceDisperseScatterY: 0,\r\n  instanceDisperseScatterZ: 0,\r\n  modelTransitionDuration: 0,\r\n};\r\n\r\nexport class ParticlesSynchronizer implements String3DObjectSyncStrategy {\r\n  private static styleCache = new StyleBundleCache<ParticleStyleBundle>();\r\n  private static lastConfig: WeakMap<String3DObject, ParticleSystemConfig> = new WeakMap();\r\n  private static lastTime: WeakMap<String3DObject, number> = new WeakMap();\r\n  private static lastMaterialType: WeakMap<String3DObject, string> = new WeakMap();\r\n  private static materialInstances: WeakMap<String3DObject, IMaterialInstance> = new WeakMap();\r\n\r\n  sync(el: HTMLElement, object: String3DObject, ctx: SyncContext, parentData: any): any {\r\n    const cached = (el as any).__layoutCache;\r\n    const rect = cached ? cached.rect : el.getBoundingClientRect();\r\n    const bundle = this.readStyleBundle(el, ctx);\r\n\r\n    const screenCenterX = rect.left + rect.width * 0.5;\r\n    const screenCenterY = rect.top + rect.height * 0.5;\r\n\r\n    if (ctx.camera.getMode() === \"orthographic\") {\r\n      object.object.position.set(\r\n        screenCenterX - ctx.viewportWidth / 2,\r\n        -(screenCenterY - ctx.viewportHeight / 2),\r\n        bundle.translateZ\r\n      );\r\n    } else {\r\n      const frustum = ctx.camera.getFrustumSizeAt(bundle.translateZ);\r\n      const normalizedX = screenCenterX / ctx.viewportWidth;\r\n      const normalizedY = screenCenterY / ctx.viewportHeight;\r\n      object.object.position.set(\r\n        (normalizedX - 0.5) * frustum.width,\r\n        -(normalizedY - 0.5) * frustum.height,\r\n        bundle.translateZ\r\n      );\r\n    }\r\n\r\n    const parentScale = parentData?.scale ?? 1;\r\n    const scale = bundle.scale * parentScale;\r\n    object.object.scale.set(scale, scale, scale);\r\n\r\n    object.object.rotation.x = -bundle.rotateX * DEG_TO_RAD;\r\n    object.object.rotation.y = bundle.rotateY * DEG_TO_RAD;\r\n    object.object.rotation.z = -bundle.rotateZ * DEG_TO_RAD;\r\n    object.object.rotation.order = \"XYZ\";\r\n\r\n    const config = this.buildConfig(bundle, rect, ctx, parentData);\r\n    const prev = ParticlesSynchronizer.lastConfig.get(object);\r\n    if (!prev || !this.isSameConfig(prev, config)) {\r\n      ParticlesSynchronizer.lastConfig.set(object, config);\r\n      (object.object as any).setConfig?.(config);\r\n    }\r\n\r\n    this.updateMaterialOverrides(el, object, ctx, bundle);\r\n    this.updateCustomUniforms(el, object, ctx);\r\n\r\n    const now = performance.now();\r\n    const last = ParticlesSynchronizer.lastTime.get(object) ?? now;\r\n    const dt = Math.max(0, (now - last) / 1000);\r\n    ParticlesSynchronizer.lastTime.set(object, now);\r\n    (object.object as any).update?.(dt);\r\n\r\n    return { scale: parentData?.scale ?? 1 };\r\n  }\r\n\r\n  private readStyleBundle(el: HTMLElement, ctx: SyncContext): ParticleStyleBundle {\r\n    return ParticlesSynchronizer.styleCache.get(el, ctx, (el) => {\r\n      const styles = new StyleReader(el);\r\n      const modeRaw = styles.readString(\"--particles-mode\", DEFAULT_CONFIG.mode).toLowerCase();\r\n      const mode = modeRaw === \"instanced\" ? \"instanced\" : \"emitter\";\r\n      return {\r\n        ...DEFAULT_CONFIG,\r\n        translateZ: styles.readNumber(\"--translate-z\", 0),\r\n        scale: styles.readNumber(\"--scale\", 1),\r\n        rotateX: styles.readNumber(\"--rotate-x\", 0),\r\n        rotateY: styles.readNumber(\"--rotate-y\", 0),\r\n        rotateZ: styles.readNumber(\"--rotate-z\", 0),\r\n        particlesFit: styles.readNumber(\"--particles-fit\", 0) > 0.5,\r\n        materialType: styles.readString(\"--material-type\", \"basic\"),\r\n        mode,\r\n        count: styles.readNumber(\"--particles-count\", DEFAULT_CONFIG.count),\r\n        size: styles.readNumber(\"--particles-size\", DEFAULT_CONFIG.size),\r\n        color: styles.readString(\"--particles-color\", DEFAULT_CONFIG.color),\r\n        opacity: styles.readNumber(\"--particles-opacity\", DEFAULT_CONFIG.opacity),\r\n        spread: styles.readNumber(\"--particles-spread\", DEFAULT_CONFIG.spread),\r\n        seed: styles.readNumber(\"--particles-seed\", DEFAULT_CONFIG.seed),\r\n        emitRate: styles.readNumber(\"--emit-rate\", DEFAULT_CONFIG.emitRate),\r\n        emitBurst: styles.readNumber(\"--emit-burst\", DEFAULT_CONFIG.emitBurst),\r\n        particleLife: styles.readNumber(\"--particle-life\", DEFAULT_CONFIG.particleLife),\r\n        particleSpeed: styles.readNumber(\"--particle-speed\", DEFAULT_CONFIG.particleSpeed),\r\n        particleDirection: this.parseVec3(\r\n          styles.readString(\"--particle-direction\", \"0 1 0\"),\r\n          DEFAULT_CONFIG.particleDirection\r\n        ),\r\n        particleGravity: this.parseVec3(\r\n          styles.readString(\"--particle-gravity\", \"0 -30 0\"),\r\n          DEFAULT_CONFIG.particleGravity\r\n        ),\r\n        particleDrag: styles.readNumber(\"--particle-drag\", DEFAULT_CONFIG.particleDrag),\r\n        particleSizeVariation: styles.readNumber(\r\n          \"--particle-size-variation\",\r\n          DEFAULT_CONFIG.particleSizeVariation\r\n        ),\r\n        particleColorVariation: styles.readNumber(\r\n          \"--particle-color-variation\",\r\n          DEFAULT_CONFIG.particleColorVariation\r\n        ),\r\n        particleShape: this.parseShape(\r\n          styles.readString(\"--particles-shape\", DEFAULT_CONFIG.particleShape)\r\n        ),\r\n        particleModelUrl: styles.readString(\"--particles-model\", DEFAULT_CONFIG.particleModelUrl),\r\n        particleModelLoader: styles.readString(\r\n          \"--particles-model-loader\",\r\n          DEFAULT_CONFIG.particleModelLoader\r\n        ),\r\n        particleModelNode: styles.readString(\r\n          \"--particles-model-node\",\r\n          DEFAULT_CONFIG.particleModelNode\r\n        ),\r\n        instanceShape: this.parseDistribution(\r\n          styles.readString(\"--instance-shape\", DEFAULT_CONFIG.instanceShape)\r\n        ),\r\n        instanceModelUrl: styles.readString(\"--instance-model\", DEFAULT_CONFIG.instanceModelUrl),\r\n        instanceModelLoader: styles.readString(\r\n          \"--instance-model-loader\",\r\n          DEFAULT_CONFIG.instanceModelLoader\r\n        ),\r\n        instanceModelNode: styles.readString(\r\n          \"--instance-model-node\",\r\n          DEFAULT_CONFIG.instanceModelNode\r\n        ),\r\n        instanceScale: styles.readNumber(\"--instance-scale\", DEFAULT_CONFIG.instanceScale),\r\n        instanceScaleVariation: styles.readNumber(\r\n          \"--instance-scale-variation\",\r\n          DEFAULT_CONFIG.instanceScaleVariation\r\n        ),\r\n        instanceRotationSpeed: styles.readNumber(\r\n          \"--instance-rotation-speed\",\r\n          DEFAULT_CONFIG.instanceRotationSpeed\r\n        ),\r\n        instanceJitter: styles.readNumber(\"--instance-jitter\", DEFAULT_CONFIG.instanceJitter),\r\n        instanceFlow: styles.readNumber(\"--instance-flow\", DEFAULT_CONFIG.instanceFlow),\r\n        instanceDisperse: styles.readNumber(\"--instance-disperse\", DEFAULT_CONFIG.instanceDisperse),\r\n        instanceDisperseScatter: styles.readNumber(\r\n          \"--instance-scatter\",\r\n          DEFAULT_CONFIG.instanceDisperseScatter\r\n        ),\r\n        instanceDisperseScatterX: styles.readNumber(\r\n          \"--instance-scatter-x\",\r\n          DEFAULT_CONFIG.instanceDisperseScatterX\r\n        ),\r\n        instanceDisperseScatterY: styles.readNumber(\r\n          \"--instance-scatter-y\",\r\n          DEFAULT_CONFIG.instanceDisperseScatterY\r\n        ),\r\n        instanceDisperseScatterZ: styles.readNumber(\r\n          \"--instance-scatter-z\",\r\n          DEFAULT_CONFIG.instanceDisperseScatterZ\r\n        ),\r\n        modelTransitionDuration: this.getTransitionDuration(el, \"--instance-model\"),\r\n      };\r\n    });\r\n  }\r\n\r\n  private getTransitionDuration(el: HTMLElement, property: string): number {\r\n    const style = getComputedStyle(el);\r\n    const properties = this.splitTransitionList(style.transitionProperty);\r\n    const durations = this.splitTransitionList(style.transitionDuration);\r\n\r\n    const index = this.findTransitionIndex(properties, property);\r\n    if (index === -1) {\r\n      const shorthand = this.parseTransitionShorthand(style.transition);\r\n      const match = shorthand.get(property) || shorthand.get(\"all\");\r\n      return match ? match.duration : 0;\r\n    }\r\n\r\n    return this.parseTime(durations[index] || durations[durations.length - 1] || \"0s\");\r\n  }\r\n\r\n  private splitTransitionList(value: string): string[] {\r\n    const result: string[] = [];\r\n    let current = \"\";\r\n    let depth = 0;\r\n    for (let i = 0; i < value.length; i += 1) {\r\n      const ch = value[i];\r\n      if (ch === \"(\") depth += 1;\r\n      if (ch === \")\") depth = Math.max(0, depth - 1);\r\n      if (ch === \",\" && depth === 0) {\r\n        result.push(current.trim());\r\n        current = \"\";\r\n      } else {\r\n        current += ch;\r\n      }\r\n    }\r\n    if (current.trim()) result.push(current.trim());\r\n    return result.length > 0 ? result : [\"all\"];\r\n  }\r\n\r\n  private findTransitionIndex(properties: string[], name: string): number {\r\n    const normalized = properties.map((prop) => prop.trim().toLowerCase());\r\n    let index = normalized.indexOf(name);\r\n    if (index === -1) {\r\n      index = normalized.indexOf(\"all\");\r\n    }\r\n    return index;\r\n  }\r\n\r\n  private parseTime(value: string): number {\r\n    const raw = value.trim().toLowerCase();\r\n    if (raw.endsWith(\"ms\")) {\r\n      const num = Number.parseFloat(raw.slice(0, -2));\r\n      return Number.isFinite(num) ? num / 1000 : 0;\r\n    }\r\n    if (raw.endsWith(\"s\")) {\r\n      const num = Number.parseFloat(raw.slice(0, -1));\r\n      return Number.isFinite(num) ? num : 0;\r\n    }\r\n    const num = Number.parseFloat(raw);\r\n    return Number.isFinite(num) ? num : 0;\r\n  }\r\n\r\n  private parseTransitionShorthand(value: string): Map<string, { duration: number }> {\r\n    const map = new Map<string, { duration: number }>();\r\n    const parts = this.splitTransitionList(value);\r\n    parts.forEach((part) => {\r\n      if (!part) return;\r\n      const tokens = part.trim().split(/\\s+(?![^()]*\\))/g);\r\n      let prop = \"\";\r\n      let duration = \"\";\r\n      tokens.forEach((token) => {\r\n        const lower = token.toLowerCase();\r\n        if (lower.endsWith(\"ms\") || lower.endsWith(\"s\") || /^[0-9.]+$/.test(lower)) {\r\n          if (!duration) duration = lower;\r\n        } else if (\r\n          lower.startsWith(\"cubic-bezier\") ||\r\n          lower.startsWith(\"steps\") ||\r\n          lower === \"linear\" ||\r\n          lower === \"ease\" ||\r\n          lower === \"ease-in\" ||\r\n          lower === \"ease-out\" ||\r\n          lower === \"ease-in-out\"\r\n        ) {\r\n        } else if (!prop) {\r\n          prop = token;\r\n        }\r\n      });\r\n      if (!prop) return;\r\n      map.set(prop.trim().toLowerCase(), {\r\n        duration: this.parseTime(duration || \"0s\"),\r\n      });\r\n    });\r\n    return map;\r\n  }\r\n\r\n  private parseVec3(value: string, fallback: [number, number, number]): [number, number, number] {\r\n    const parts = value\r\n      .split(/[\\s,]+/)\r\n      .map((part) => Number.parseFloat(part))\r\n      .filter((num) => !Number.isNaN(num));\r\n    if (parts.length >= 3) {\r\n      return [parts[0], parts[1], parts[2]];\r\n    }\r\n    return fallback;\r\n  }\r\n\r\n  private parseShape(value: string): \"box\" | \"sphere\" | \"model\" {\r\n    const normalized = value.trim().toLowerCase();\r\n    if (normalized === \"box\") return \"box\";\r\n    if (normalized === \"model\") return \"model\";\r\n    return \"sphere\";\r\n  }\r\n\r\n  private parseDistribution(value: string): \"box\" | \"sphere\" | \"model\" {\r\n    return this.parseShape(value);\r\n  }\r\n\r\n  private buildConfig(\r\n    bundle: ParticleStyleBundle,\r\n    rect: DOMRect,\r\n    ctx: SyncContext,\r\n    parentData: any\r\n  ): ParticleSystemConfig {\r\n    const parentScale = parentData?.scale ?? 1;\r\n    const scale = parentScale;\r\n    const fitMultiplier = 0.5;\r\n    let spread: number;\r\n    let spreadX: number;\r\n    let spreadY: number;\r\n    if (bundle.particlesFit) {\r\n      spreadX = this.toWorld(rect.width * fitMultiplier, bundle.translateZ, ctx);\r\n      spreadY = this.toWorld(rect.height * fitMultiplier, bundle.translateZ, ctx);\r\n      spread = Math.max(spreadX, spreadY);\r\n    } else {\r\n      spread = this.toWorld(bundle.spread, bundle.translateZ, ctx);\r\n      spreadX = spread;\r\n      spreadY = spread;\r\n    }\r\n    return {\r\n      ...bundle,\r\n      count: Math.max(0, Math.floor(bundle.count)),\r\n      size: Math.max(0.1, bundle.size),\r\n      opacity: Math.max(0, Math.min(1, bundle.opacity)),\r\n      spread: Math.max(0, spread * scale),\r\n      spreadX: Math.max(0, spreadX * scale),\r\n      spreadY: Math.max(0, spreadY * scale),\r\n      seed: Math.max(0, Math.floor(bundle.seed)),\r\n      emitRate: Math.max(0, bundle.emitRate),\r\n      emitBurst: Math.max(0, bundle.emitBurst),\r\n      particleLife: Math.max(0.1, bundle.particleLife),\r\n      particleSpeed: Math.max(0, bundle.particleSpeed),\r\n      particleDrag: Math.max(0, Math.min(1, bundle.particleDrag)),\r\n      particleSizeVariation: Math.max(0, bundle.particleSizeVariation),\r\n      particleColorVariation: Math.max(0, bundle.particleColorVariation),\r\n      instanceScale: Math.max(0.1, bundle.instanceScale),\r\n      instanceScaleVariation: Math.max(0, bundle.instanceScaleVariation),\r\n      instanceRotationSpeed: Math.max(0, bundle.instanceRotationSpeed),\r\n      instanceJitter: Math.max(0, bundle.instanceJitter),\r\n      instanceFlow: Math.max(0, bundle.instanceFlow),\r\n      instanceDisperse: Math.max(0, bundle.instanceDisperse),\r\n      instanceDisperseScatter: Math.max(0, bundle.instanceDisperseScatter),\r\n      instanceDisperseScatterX: Math.max(0, bundle.instanceDisperseScatterX),\r\n      instanceDisperseScatterY: Math.max(0, bundle.instanceDisperseScatterY),\r\n      instanceDisperseScatterZ: Math.max(0, bundle.instanceDisperseScatterZ),\r\n    };\r\n  }\r\n\r\n  private toWorld(value: number, z: number, ctx: SyncContext): number {\r\n    if (ctx.camera.getMode() === \"orthographic\") {\r\n      return value;\r\n    }\r\n    const frustum = ctx.camera.getFrustumSizeAt(z);\r\n    const perPixel = frustum.width / Math.max(1, ctx.viewportWidth);\r\n    return value * perPixel;\r\n  }\r\n\r\n  private isSameConfig(a: ParticleSystemConfig, b: ParticleSystemConfig): boolean {\r\n    return JSON.stringify(a) === JSON.stringify(b);\r\n  }\r\n\r\n  private updateMaterialOverrides(\r\n    el: HTMLElement,\r\n    object: String3DObject,\r\n    ctx: SyncContext,\r\n    bundle: ParticleStyleBundle\r\n  ): void {\r\n    const typeRaw = bundle.materialType || \"basic\";\r\n    const type = typeRaw.split(\"[\")[0].trim().toLowerCase();\r\n    const definition = String3DCustomMaterialRegistry.get(type);\r\n    const factory = ctx.engine.getMaterialFactory?.();\r\n\r\n    if (!definition || !factory || !factory.supports(definition)) {\r\n      const hasExisting =\r\n        ParticlesSynchronizer.materialInstances.has(object) ||\r\n        ParticlesSynchronizer.lastMaterialType.has(object);\r\n      if (!hasExisting) return;\r\n\r\n      const existing = ParticlesSynchronizer.materialInstances.get(object);\r\n      if (existing) {\r\n        existing.dispose();\r\n        ParticlesSynchronizer.materialInstances.delete(object);\r\n      }\r\n      ParticlesSynchronizer.lastMaterialType.delete(object);\r\n      (object.object as any).setMaterial?.(null, { points: true, meshes: true });\r\n      return;\r\n    }\r\n\r\n    const lastType = ParticlesSynchronizer.lastMaterialType.get(object);\r\n    if (lastType !== type) {\r\n      const existing = ParticlesSynchronizer.materialInstances.get(object);\r\n      if (existing) existing.dispose();\r\n\r\n      const style = getComputedStyle(el);\r\n      const initialUniforms = factory.parseUniformsFromCSS(definition, el, style);\r\n      const instance = factory.create(definition, initialUniforms);\r\n      ParticlesSynchronizer.materialInstances.set(object, instance);\r\n      ParticlesSynchronizer.lastMaterialType.set(object, type);\r\n\r\n      const material = instance.material;\r\n      const isShader = !!material?.isShaderMaterial;\r\n      const system: any = object.object as any;\r\n      system.setMaterial?.(material, { meshes: true, points: false });\r\n      system.setMaterial?.(isShader ? material : null, { meshes: false, points: true });\r\n    }\r\n  }\r\n\r\n  private updateCustomUniforms(el: HTMLElement, object: String3DObject, ctx: SyncContext): void {\r\n    const factory = ctx.engine.getMaterialFactory?.();\r\n    if (!factory) return;\r\n\r\n    const style = getComputedStyle(el);\r\n\r\n    const apply = (mat: any) => {\r\n      const definition = mat?.userData?.definition;\r\n      if (!definition?.uniforms) return;\r\n\r\n      const values = factory.parseUniformsFromCSS(definition, el, style);\r\n\r\n      for (const [key, value] of Object.entries(values)) {\r\n        const def = definition.uniforms?.[key];\r\n        if (!def) continue;\r\n\r\n        const converter = (factory as any).convertUniformValue?.bind(factory);\r\n        const converted = converter ? converter(def.type, value) : value;\r\n\r\n        if (mat.userData?.shader?.uniforms?.[key]) {\r\n          mat.userData.shader.uniforms[key].value = converted;\r\n        } else if (mat.userData?.customUniforms?.[key]) {\r\n          mat.userData.customUniforms[key].value = converted;\r\n        } else if (mat.uniforms?.[key]) {\r\n          mat.uniforms[key].value = converted;\r\n        }\r\n      }\r\n    };\r\n\r\n    if (object.object.traverse) {\r\n      object.object.traverse((child: any) => {\r\n        if (child.isMesh || child.isPoints) {\r\n          const materials = Array.isArray(child.material) ? child.material : [child.material];\r\n          materials.forEach(apply);\r\n        }\r\n      });\r\n    }\r\n  }\r\n}\r\n","export type String3DFontEntry = {\r\n  name: string;\r\n  url: string;\r\n};\r\n\r\nexport class String3DFontRegistry {\r\n  private static fonts: Map<string, String3DFontEntry> = new Map();\r\n  private static defaultFont: string | null = null;\r\n\r\n  private static normalizeKey(name: string): string {\r\n    return name.trim().toLowerCase();\r\n  }\r\n\r\n  static register(name: string, url: string): void {\r\n    const normalized = name.trim();\r\n    if (!normalized) return;\r\n    this.fonts.set(this.normalizeKey(normalized), { name: normalized, url });\r\n  }\r\n\r\n  static setDefault(name: string): void {\r\n    const normalized = name.trim();\r\n    if (!normalized) return;\r\n    this.defaultFont = this.normalizeKey(normalized);\r\n  }\r\n\r\n  static get(name: string): String3DFontEntry | undefined {\r\n    return this.fonts.get(this.normalizeKey(name));\r\n  }\r\n\r\n  static list(): String3DFontEntry[] {\r\n    return Array.from(this.fonts.values());\r\n  }\r\n\r\n  static resolveFontFamily(fontFamily: string): String3DFontEntry | null {\r\n    if (!fontFamily) {\r\n      return this.getDefault();\r\n    }\r\n\r\n    const families = fontFamily\r\n      .split(\",\")\r\n      .map((value) => value.trim().replace(/^[\"']|[\"']$/g, \"\"))\r\n      .filter(Boolean);\r\n\r\n    for (const family of families) {\r\n      const entry = this.fonts.get(this.normalizeKey(family));\r\n      if (entry) return entry;\r\n    }\r\n\r\n    return this.getDefault();\r\n  }\r\n\r\n  private static getDefault(): String3DFontEntry | null {\r\n    if (!this.defaultFont) return null;\r\n    return this.fonts.get(this.defaultFont) || null;\r\n  }\r\n}\r\n","export interface FontData {\r\n  glyphs: Record<string, GlyphData>;\r\n  familyName: string;\r\n  ascender: number;\r\n  descender: number;\r\n  underlinePosition: number;\r\n  underlineThickness: number;\r\n  boundingBox: { xMin: number; xMax: number; yMin: number; yMax: number };\r\n  resolution: number;\r\n  outlineFormat: string;\r\n  original_font_information: Record<string, any>;\r\n}\r\n\r\nexport interface GlyphData {\r\n  ha: number;\r\n  x_min: number;\r\n  x_max: number;\r\n  o: string;\r\n}\r\n\r\nexport type FontSource = string | ArrayBuffer | Uint8Array;\r\n\r\nlet opentypePromise: Promise<any> | null = null;\r\nlet opentypeModule: any = null;\r\n\r\nlet woff2Promise: Promise<any> | null = null;\r\nlet woff2Module: any = null;\r\n\r\nasync function loadOpentype(): Promise<any> {\r\n  if (opentypeModule) {\r\n    return opentypeModule;\r\n  }\r\n\r\n  if (!opentypePromise) {\r\n    opentypePromise = (async () => {\r\n      if (typeof window !== \"undefined\" && (window as any).opentype) {\r\n        opentypeModule = (window as any).opentype;\r\n        return opentypeModule;\r\n      }\r\n\r\n      return new Promise((resolve, reject) => {\r\n        if (typeof document === \"undefined\") {\r\n          reject(new Error(\"[FontConverter] Cannot load opentype.js in non-browser environment\"));\r\n          return;\r\n        }\r\n        const script = document.createElement(\"script\");\r\n        script.src = \"https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js\";\r\n        script.onload = () => {\r\n          opentypeModule = (window as any).opentype;\r\n          resolve(opentypeModule);\r\n        };\r\n        script.onerror = () => reject(new Error(\"[FontConverter] Failed to load opentype.js\"));\r\n        document.head.appendChild(script);\r\n      });\r\n    })();\r\n  }\r\n  return opentypePromise;\r\n}\r\n\r\nasync function loadWoff2Decoder(): Promise<any> {\r\n  if (woff2Module) {\r\n    return woff2Module;\r\n  }\r\n\r\n  if (!woff2Promise) {\r\n    woff2Promise = (async () => {\r\n      if (typeof window !== \"undefined\" && (window as any).Module?.decompress) {\r\n        woff2Module = (window as any).Module;\r\n        return woff2Module;\r\n      }\r\n\r\n      return new Promise((resolve, reject) => {\r\n        if (typeof document === \"undefined\") {\r\n          reject(new Error(\"[FontConverter] Cannot load woff2 decoder in non-browser environment\"));\r\n          return;\r\n        }\r\n        const script = document.createElement(\"script\");\r\n        script.src = \"https://cdn.jsdelivr.net/npm/wawoff2@2.0.1/build/decompress_binding.js\";\r\n        script.onload = () => {\r\n          let attempts = 0;\r\n          const maxAttempts = 500;\r\n          const checkReady = () => {\r\n            attempts++;\r\n            const win = window as any;\r\n            if (win.Module?.decompress) {\r\n              woff2Module = win.Module;\r\n              resolve(woff2Module);\r\n            } else if (attempts >= maxAttempts) {\r\n              reject(new Error(\"[FontConverter] woff2 decoder initialization timeout\"));\r\n            } else {\r\n              setTimeout(checkReady, 10);\r\n            }\r\n          };\r\n          checkReady();\r\n        };\r\n        script.onerror = () => {\r\n          reject(new Error(\"[FontConverter] Failed to load woff2 decoder\"));\r\n        };\r\n        document.head.appendChild(script);\r\n      });\r\n    })();\r\n  }\r\n  return woff2Promise;\r\n}\r\n\r\nasync function decompressWoff2(buffer: ArrayBuffer): Promise<ArrayBuffer> {\r\n  const woff2 = await loadWoff2Decoder();\r\n  const inputArray = new Uint8Array(buffer);\r\n  const outputArray = woff2.decompress(inputArray);\r\n\r\n  if (outputArray instanceof Uint8Array) {\r\n    const newBuffer = new ArrayBuffer(outputArray.length);\r\n    const newArray = new Uint8Array(newBuffer);\r\n    newArray.set(outputArray);\r\n    return newBuffer;\r\n  }\r\n\r\n  return outputArray.buffer;\r\n}\r\n\r\nfunction isWoff2(buffer: ArrayBuffer): boolean {\r\n  const view = new DataView(buffer);\r\n  return view.getUint32(0, false) === 0x774f4632;\r\n}\r\n\r\nfunction isWoff(buffer: ArrayBuffer): boolean {\r\n  const view = new DataView(buffer);\r\n  return view.getUint32(0, false) === 0x774f4646;\r\n}\r\n\r\nexport class FontConverter {\r\n  private static cache: Map<string, FontData> = new Map();\r\n  private static loadingPromises: Map<string, Promise<FontData>> = new Map();\r\n\r\n  static async load(source: FontSource): Promise<FontData> {\r\n    const cacheKey = typeof source === \"string\" ? source : \"buffer-\" + Date.now();\r\n\r\n    const cached = this.cache.get(cacheKey);\r\n    if (cached) return cached;\r\n\r\n    const loading = this.loadingPromises.get(cacheKey);\r\n    if (loading) return loading;\r\n\r\n    const promise = this.doLoad(source, cacheKey);\r\n    this.loadingPromises.set(cacheKey, promise);\r\n\r\n    try {\r\n      const result = await promise;\r\n      this.cache.set(cacheKey, result);\r\n      return result;\r\n    } finally {\r\n      this.loadingPromises.delete(cacheKey);\r\n    }\r\n  }\r\n\r\n  private static async doLoad(source: FontSource, cacheKey: string): Promise<FontData> {\r\n    const opentype = await loadOpentype();\r\n\r\n    let buffer: ArrayBuffer;\r\n\r\n    if (typeof source === \"string\") {\r\n      const response = await fetch(source);\r\n      buffer = await response.arrayBuffer();\r\n    } else if (source instanceof ArrayBuffer) {\r\n      buffer = source;\r\n    } else if (source instanceof Uint8Array) {\r\n      buffer = source.buffer as ArrayBuffer;\r\n    } else {\r\n      throw new Error(\"[FontConverter] Invalid font source\");\r\n    }\r\n\r\n    if (isWoff2(buffer)) {\r\n      buffer = await decompressWoff2(buffer);\r\n    }\r\n\r\n    const font = opentype.parse(buffer);\r\n\r\n    if (!font) {\r\n      throw new Error(\"[FontConverter] Failed to parse font\");\r\n    }\r\n\r\n    return this.convertToTypeFace(font);\r\n  }\r\n\r\n  private static convertToTypeFace(font: any): FontData {\r\n    const scale = 1000 / font.unitsPerEm;\r\n\r\n    const glyphs: Record<string, GlyphData> = {};\r\n\r\n    const cmap = font.tables?.cmap?.glyphIndexMap;\r\n    if (cmap && typeof cmap === \"object\") {\r\n      for (const [codeStr, glyphIndex] of Object.entries(cmap)) {\r\n        const code = Number(codeStr);\r\n        if (!Number.isFinite(code)) continue;\r\n        const glyph = font.glyphs.get(glyphIndex as number);\r\n        if (!glyph) continue;\r\n\r\n        const path = glyph.getPath(0, 0, font.unitsPerEm);\r\n        const outline = this.pathToOutline(path, scale);\r\n        const advanceWidth = glyph.advanceWidth ?? glyph.xMax ?? font.unitsPerEm * 0.5;\r\n        const char = String.fromCharCode(code);\r\n        if (glyphs[char]) continue;\r\n        glyphs[char] = {\r\n          ha: Math.round(advanceWidth * scale),\r\n          x_min: glyph.xMin !== undefined ? Math.round(glyph.xMin * scale) : 0,\r\n          x_max: glyph.xMax !== undefined ? Math.round(glyph.xMax * scale) : 0,\r\n          o: outline,\r\n        };\r\n      }\r\n    } else {\r\n      for (let i = 0; i < font.glyphs.length; i++) {\r\n        const glyph = font.glyphs.get(i);\r\n        const unicodeValues = Array.isArray(glyph.unicodes)\r\n          ? glyph.unicodes\r\n          : glyph.unicode\r\n          ? [glyph.unicode]\r\n          : [];\r\n        if (unicodeValues.length === 0) continue;\r\n\r\n        const path = glyph.getPath(0, 0, font.unitsPerEm);\r\n        const outline = this.pathToOutline(path, scale);\r\n        const advanceWidth = glyph.advanceWidth ?? glyph.xMax ?? font.unitsPerEm * 0.5;\r\n\r\n        unicodeValues.forEach((code: number) => {\r\n          if (!Number.isFinite(code)) return;\r\n          const char = String.fromCharCode(code);\r\n          if (glyphs[char]) return;\r\n          glyphs[char] = {\r\n            ha: Math.round(advanceWidth * scale),\r\n            x_min: glyph.xMin !== undefined ? Math.round(glyph.xMin * scale) : 0,\r\n            x_max: glyph.xMax !== undefined ? Math.round(glyph.xMax * scale) : 0,\r\n            o: outline,\r\n          };\r\n        });\r\n      }\r\n    }\r\n\r\n    if (!glyphs[\" \"]) {\r\n      const spaceGlyph = font.charToGlyph(\" \");\r\n      glyphs[\" \"] = {\r\n        ha: Math.round((spaceGlyph?.advanceWidth || font.unitsPerEm * 0.25) * scale),\r\n        x_min: 0,\r\n        x_max: 0,\r\n        o: \"\",\r\n      };\r\n    }\r\n\r\n    return {\r\n      glyphs,\r\n      familyName: font.names.fontFamily?.en || font.names.fullName?.en || \"Unknown\",\r\n      ascender: Math.round(font.ascender * scale),\r\n      descender: Math.round(font.descender * scale),\r\n      underlinePosition: Math.round((font.tables.post?.underlinePosition || -100) * scale),\r\n      underlineThickness: Math.round((font.tables.post?.underlineThickness || 50) * scale),\r\n      boundingBox: {\r\n        xMin: Math.round((font.tables.head?.xMin || 0) * scale),\r\n        xMax: Math.round((font.tables.head?.xMax || 1000) * scale),\r\n        yMin: Math.round((font.tables.head?.yMin || -200) * scale),\r\n        yMax: Math.round((font.tables.head?.yMax || 800) * scale),\r\n      },\r\n      resolution: 1000,\r\n      outlineFormat: (font.outlinesFormat || font.outlineFormat || \"\").toString(),\r\n      original_font_information: {\r\n        format: 0,\r\n        copyright: font.names.copyright?.en || \"\",\r\n        fontFamily: font.names.fontFamily?.en || \"\",\r\n        fontSubfamily: font.names.fontSubfamily?.en || \"\",\r\n        uniqueID: font.names.uniqueID?.en || \"\",\r\n        fullName: font.names.fullName?.en || \"\",\r\n        version: font.names.version?.en || \"\",\r\n        postScriptName: font.names.postScriptName?.en || \"\",\r\n      },\r\n    };\r\n  }\r\n\r\n  private static pathToOutline(path: any, scale: number): string {\r\n    const commands: string[] = [];\r\n\r\n    for (const cmd of path.commands) {\r\n      switch (cmd.type) {\r\n        case \"M\":\r\n          commands.push(`m ${this.round(cmd.x * scale)} ${this.round(cmd.y * scale)}`);\r\n          break;\r\n        case \"L\":\r\n          commands.push(`l ${this.round(cmd.x * scale)} ${this.round(cmd.y * scale)}`);\r\n          break;\r\n        case \"Q\":\r\n          commands.push(\r\n            `q ${this.round(cmd.x1 * scale)} ${this.round(cmd.y1 * scale)} ${this.round(\r\n              cmd.x * scale\r\n            )} ${this.round(cmd.y * scale)}`\r\n          );\r\n          break;\r\n        case \"C\":\r\n          commands.push(\r\n            `b ${this.round(cmd.x1 * scale)} ${this.round(cmd.y1 * scale)} ${this.round(\r\n              cmd.x2 * scale\r\n            )} ${this.round(cmd.y2 * scale)} ${this.round(cmd.x * scale)} ${this.round(\r\n              cmd.y * scale\r\n            )}`\r\n          );\r\n          break;\r\n        case \"Z\":\r\n          commands.push(\"z\");\r\n          break;\r\n      }\r\n    }\r\n\r\n    return commands.join(\" \");\r\n  }\r\n\r\n  private static round(value: number): number {\r\n    return Math.round(value * 10000) / 10000;\r\n  }\r\n\r\n  static isTypefaceJson(url: string): boolean {\r\n    const lower = url.toLowerCase();\r\n    return lower.endsWith(\".json\") || lower.includes(\"typeface\");\r\n  }\r\n\r\n  static isFontFile(url: string): boolean {\r\n    const lower = url.toLowerCase();\r\n    const fontExtensions = /\\.(ttf|otf|woff2?)(\\?|$)/i;\r\n    if (fontExtensions.test(lower)) return true;\r\n    if (lower.includes(\"fonts.gstatic.com\")) return true;\r\n    if (lower.includes(\"/fonts/\") && !lower.endsWith(\".json\")) return true;\r\n    return false;\r\n  }\r\n\r\n  static clearCache(): void {\r\n    this.cache.clear();\r\n  }\r\n}\r\n","import { String3DObject } from \"../String3DObject\";\r\nimport type { SyncContext } from \"./SyncContext\";\r\nimport type { String3DObjectSyncStrategy } from \"./String3DObjectSyncStrategy\";\r\nimport { StyleBundleCache } from \"./StyleBundleCache\";\r\nimport { String3DFontRegistry } from \"../text\";\r\nimport { MeshSynchronizer } from \"./MeshSynchronizer\";\r\n\r\nconst DEG_TO_RAD = Math.PI / 180;\r\n\r\nconst DEBUG_TEXT_SYNC = false;\r\n\r\nconst PSEUDO_ELEMENT_CSS = `\r\n[data-string3d-text] {\r\n  -webkit-text-fill-color: transparent;\r\n}\r\n\r\n[data-string3d-text]::before {\r\n  content: attr(data-string3d-text);\r\n  position: absolute;\r\n  left: 0;\r\n  top: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n  pointer-events: none;\r\n  \r\n  color: inherit;\r\n  -webkit-text-fill-color: initial;\r\n  font: inherit;\r\n  text-transform: inherit;\r\n  letter-spacing: inherit;\r\n  line-height: inherit;\r\n  text-align: inherit;\r\n  white-space: inherit;\r\n  word-spacing: inherit;\r\n  \r\n  transform: var(--string3d-transform, none);\r\n  transform-style: preserve-3d;\r\n  transform-origin: center center;\r\n}\r\n`;\r\n\r\nexport class TextSynchronizer implements String3DObjectSyncStrategy {\r\n  private static styleCache = new StyleBundleCache<StyleBundle>();\r\n  private static layoutCache = new StyleBundleCache<LayoutBundle>();\r\n  private static geometryKeys: WeakMap<String3DObject, string> = new WeakMap();\r\n  private static lastMaterialType: WeakMap<String3DObject, string> = new WeakMap();\r\n  private static fontCache: Map<string, any> = new Map();\r\n  private static fontPromises: Map<string, Promise<any>> = new Map();\r\n  private static pendingFontObjects: Map<string, Set<String3DObject>> = new Map();\r\n  private static contentObservers: WeakMap<HTMLElement, MutationObserver> = new WeakMap();\r\n  private static warnedMissingFont = false;\r\n  private static warnedMissingLoader = false;\r\n  private static pseudoStyleInjected = false;\r\n\r\n  private static markObjectPendingFont(fontUrl: string, object: String3DObject): void {\r\n    let set = this.pendingFontObjects.get(fontUrl);\r\n    if (!set) {\r\n      set = new Set();\r\n      this.pendingFontObjects.set(fontUrl, set);\r\n    }\r\n    set.add(object);\r\n  }\r\n\r\n  private static clearObjectPendingFont(fontUrl: string, object: String3DObject): void {\r\n    const set = this.pendingFontObjects.get(fontUrl);\r\n    if (set) {\r\n      set.delete(object);\r\n    }\r\n  }\r\n\r\n  private static invalidatePendingObjects(fontUrl: string): void {\r\n    const set = this.pendingFontObjects.get(fontUrl);\r\n    if (set) {\r\n      set.forEach((obj) => {\r\n        this.geometryKeys.delete(obj);\r\n      });\r\n      set.clear();\r\n    }\r\n  }\r\n\r\n  private static injectPseudoElementStyles(): void {\r\n    if (this.pseudoStyleInjected || typeof document === \"undefined\") return;\r\n\r\n    const style = document.createElement(\"style\");\r\n    style.setAttribute(\"data-string3d\", \"pseudo-text\");\r\n    style.textContent = PSEUDO_ELEMENT_CSS;\r\n    document.head.appendChild(style);\r\n    this.pseudoStyleInjected = true;\r\n  }\r\n\r\n  private static setupSelectableText(el: HTMLElement): void {\r\n    const textContent = el.textContent || \"\";\r\n\r\n    if (el.dataset.string3dText !== textContent) {\r\n      el.dataset.string3dText = textContent;\r\n    }\r\n\r\n    const computed = getComputedStyle(el);\r\n    if (computed.position === \"static\") {\r\n      el.style.position = \"relative\";\r\n    }\r\n\r\n    const rx = computed.getPropertyValue(\"--rotate-x\").trim() || \"0\";\r\n    const ry = computed.getPropertyValue(\"--rotate-y\").trim() || \"0\";\r\n    const rz = computed.getPropertyValue(\"--rotate-z\").trim() || \"0\";\r\n    const tx = computed.getPropertyValue(\"--translate-x\").trim() || \"0px\";\r\n    const ty = computed.getPropertyValue(\"--translate-y\").trim() || \"0px\";\r\n    const tz = computed.getPropertyValue(\"--translate-z\").trim() || \"0px\";\r\n    const s = computed.getPropertyValue(\"--scale\").trim() || \"1\";\r\n\r\n    const transform = [\r\n      tx !== \"0px\" && tx !== \"0\" ? `translateX(${tx})` : \"\",\r\n      ty !== \"0px\" && ty !== \"0\" ? `translateY(${ty})` : \"\",\r\n      tz !== \"0px\" && tz !== \"0\" ? `translateZ(${tz})` : \"\",\r\n      rx !== \"0\" ? `rotateX(${rx}deg)` : \"\",\r\n      ry !== \"0\" ? `rotateY(${ry}deg)` : \"\",\r\n      rz !== \"0\" ? `rotateZ(${rz}deg)` : \"\",\r\n      s !== \"1\" ? `scale(${s})` : \"\",\r\n    ]\r\n      .filter(Boolean)\r\n      .join(\" \");\r\n\r\n    el.style.setProperty(\"--string3d-transform\", transform || \"none\");\r\n  }\r\n\r\n  private static setupContentObserver(el: HTMLElement, object: String3DObject): void {\r\n    if (this.contentObservers.has(el)) return;\r\n\r\n    let lastContent = el.textContent || \"\";\r\n\r\n    const observer = new MutationObserver((mutations) => {\r\n      const currentContent = el.textContent || \"\";\r\n      if (currentContent === lastContent) {\r\n        return;\r\n      }\r\n\r\n      lastContent = currentContent;\r\n\r\n      const string3d = (window as any).StringTune3D?.String3D?.getInstance?.();\r\n      const currentObject = string3d?.scene?.getObjectForElement?.(el);\r\n\r\n      if (currentObject) {\r\n        this.geometryKeys.delete(currentObject);\r\n        this.layoutCache.invalidate(el);\r\n\r\n        if (el.dataset.string3dText !== currentContent) {\r\n          el.dataset.string3dText = currentContent;\r\n        }\r\n      }\r\n    });\r\n\r\n    observer.observe(el, {\r\n      characterData: true,\r\n      childList: true,\r\n      subtree: true,\r\n    });\r\n\r\n    this.contentObservers.set(el, observer);\r\n  }\r\n\r\n  private static cleanupContentObserver(el: HTMLElement): void {\r\n    const observer = this.contentObservers.get(el);\r\n    if (observer) {\r\n      observer.disconnect();\r\n      this.contentObservers.delete(el);\r\n    }\r\n  }\r\n\r\n  sync(el: HTMLElement, object: String3DObject, ctx: SyncContext, parentData: any): any {\r\n    TextSynchronizer.injectPseudoElementStyles();\r\n    TextSynchronizer.setupSelectableText(el);\r\n    TextSynchronizer.setupContentObserver(el, object);\r\n\r\n    const { rect, width: originalWidth, height: originalHeight } = this.readLayout(el, ctx);\r\n    const bundle = this.readStyleBundle(el, ctx);\r\n\r\n    const {\r\n      translateZ,\r\n      cssScale,\r\n      rotateX,\r\n      rotateY,\r\n      rotateZ,\r\n      cssScaleZ,\r\n      opacity,\r\n      color,\r\n      metalness,\r\n      roughness,\r\n      emissive,\r\n      castShadow,\r\n      receiveShadow,\r\n      materialType,\r\n      fontFamily,\r\n      fontSize,\r\n      textTransform,\r\n      textDepth,\r\n      textCurveSegments,\r\n      bevelEnabled,\r\n      bevelSize,\r\n      bevelThickness,\r\n      bevelOffset,\r\n      bevelSegments,\r\n      fontCss,\r\n    } = bundle;\r\n\r\n    const screenCenterX = rect.left + rect.width * 0.5;\r\n    const screenCenterY = rect.top + rect.height * 0.5;\r\n\r\n    if (ctx.camera.getMode() === \"orthographic\") {\r\n      object.object.position.set(\r\n        screenCenterX - ctx.viewportWidth / 2,\r\n        -(screenCenterY - ctx.viewportHeight / 2),\r\n        translateZ\r\n      );\r\n    } else {\r\n      const frustum = ctx.camera.getFrustumSizeAt(translateZ);\r\n      const normalizedX = screenCenterX / ctx.viewportWidth;\r\n      const normalizedY = screenCenterY / ctx.viewportHeight;\r\n      object.object.position.set(\r\n        (normalizedX - 0.5) * frustum.width,\r\n        -(normalizedY - 0.5) * frustum.height,\r\n        translateZ\r\n      );\r\n    }\r\n\r\n    object.object.rotation.x = -rotateX * DEG_TO_RAD;\r\n    object.object.rotation.y = rotateY * DEG_TO_RAD;\r\n    object.object.rotation.z = -rotateZ * DEG_TO_RAD;\r\n    object.object.rotation.order = \"XYZ\";\r\n\r\n    object.object.rotation.z = -rotateZ * DEG_TO_RAD;\r\n    object.object.rotation.order = \"XYZ\";\r\n\r\n    const layout = this.extractCharacterLayout(el, textTransform);\r\n    const textContent = layout.map((l) => l.char).join(\"\");\r\n    const useCanvasText = Boolean(fontCss);\r\n\r\n    const mesh = this.getTextMesh(object);\r\n    if (!mesh) {\r\n      return { scale: cssScale * (parentData?.scale || 1) };\r\n    }\r\n\r\n    if (layout.length === 0) {\r\n      mesh.visible = false;\r\n      return { scale: cssScale * (parentData?.scale || 1) };\r\n    }\r\n\r\n    if (opacity === 0) {\r\n      object.object.visible = false;\r\n      return { scale: cssScale * (parentData?.scale || 1) };\r\n    }\r\n    object.object.visible = true;\r\n\r\n    mesh.visible = true;\r\n\r\n    const fontEntry = String3DFontRegistry.resolveFontFamily(fontFamily || \"\");\r\n    if (!fontEntry) {\r\n      if (!TextSynchronizer.warnedMissingFont) {\r\n        TextSynchronizer.warnedMissingFont = true;\r\n      }\r\n      return { scale: cssScale * (parentData?.scale || 1) };\r\n    }\r\n\r\n    if (!ctx.engine.loadFont || !ctx.engine.createTextGeometry) {\r\n      if (!TextSynchronizer.warnedMissingLoader) {\r\n        TextSynchronizer.warnedMissingLoader = true;\r\n      }\r\n      return { scale: cssScale * (parentData?.scale || 1) };\r\n    }\r\n\r\n    const fontUrl = fontEntry.url;\r\n    let font = TextSynchronizer.fontCache.get(fontUrl);\r\n    if (!font) {\r\n      TextSynchronizer.markObjectPendingFont(fontUrl, object);\r\n      if (!TextSynchronizer.fontPromises.has(fontUrl)) {\r\n        const promise = ctx.engine.loadFont(fontUrl).then((loaded) => {\r\n          if (loaded) {\r\n            TextSynchronizer.fontCache.set(fontUrl, loaded);\r\n            TextSynchronizer.invalidatePendingObjects(fontUrl);\r\n          }\r\n          return loaded;\r\n        });\r\n        TextSynchronizer.fontPromises.set(fontUrl, promise);\r\n      }\r\n      mesh.visible = false;\r\n      return { scale: cssScale * (parentData?.scale || 1) };\r\n    }\r\n\r\n    TextSynchronizer.clearObjectPendingFont(fontUrl, object);\r\n\r\n    const layoutSig =\r\n      layout.length > 0\r\n        ? `${layout.length}:${layout[0].x.toFixed(1)},${layout[0].y.toFixed(1)}:${layout[\r\n            layout.length - 1\r\n          ].x.toFixed(1)},${layout[layout.length - 1].y.toFixed(1)}`\r\n        : \"empty\";\r\n\r\n    const key = [\r\n      textContent,\r\n      fontSize.toFixed(3),\r\n      fontCss || \"\",\r\n      rect.width.toFixed(1),\r\n      rect.height.toFixed(1),\r\n      layoutSig,\r\n      textDepth.toFixed(3),\r\n      textCurveSegments.toFixed(3),\r\n      bevelEnabled ? \"1\" : \"0\",\r\n      bevelSize.toFixed(3),\r\n      bevelThickness.toFixed(3),\r\n      bevelOffset.toFixed(3),\r\n      bevelSegments.toFixed(3),\r\n    ].join(\"|\");\r\n\r\n    const prevKey = TextSynchronizer.geometryKeys.get(object);\r\n    if (prevKey !== key) {\r\n      const geometry = ctx.engine.createTextGeometry(textContent, font, {\r\n        size: fontSize,\r\n        height: textDepth,\r\n        curveSegments: Math.max(1, Math.round(textCurveSegments)),\r\n        bevelEnabled,\r\n        bevelThickness,\r\n        bevelSize,\r\n        bevelOffset,\r\n        bevelSegments: Math.max(0, Math.round(bevelSegments)),\r\n        lineHeight: 0,\r\n        letterSpacing: 0,\r\n        align: \"left\",\r\n        layout,\r\n        elementWidth: rect.width,\r\n        elementHeight: rect.height,\r\n      });\r\n\r\n      if (geometry) {\r\n        geometry.computeBoundingBox();\r\n        if (mesh.geometry) {\r\n          mesh.geometry.dispose?.();\r\n        }\r\n        mesh.geometry = geometry;\r\n        object.geometry = geometry;\r\n        TextSynchronizer.geometryKeys.set(object, key);\r\n      }\r\n    }\r\n\r\n    const parentScale = parentData?.scale || 1;\r\n    const perPixel =\r\n      ctx.camera.getMode() === \"orthographic\"\r\n        ? 1\r\n        : ctx.camera.getScaleAtZ(translateZ, ctx.viewportHeight);\r\n\r\n    const scaleFactor = cssScale * parentScale * perPixel;\r\n\r\n    const scaleZ = scaleFactor * cssScaleZ;\r\n    object.object.scale.set(scaleFactor, scaleFactor, scaleZ);\r\n\r\n    const localOffsetX = -originalWidth * 0.5;\r\n    const localOffsetY = originalHeight * 0.5;\r\n\r\n    mesh.position.set(localOffsetX, localOffsetY, 0);\r\n\r\n    const prevMaterialType = TextSynchronizer.lastMaterialType.get(object);\r\n    if (prevMaterialType !== undefined && prevMaterialType !== materialType) {\r\n      if (ctx.scene && (ctx.scene as any).recreateMaterialForObject) {\r\n        requestAnimationFrame(() => {\r\n          if (ctx.scene && (ctx.scene as any).recreateMaterialForObject) {\r\n            (ctx.scene as any).recreateMaterialForObject(object, el);\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    TextSynchronizer.lastMaterialType.set(object, materialType);\r\n\r\n    MeshSynchronizer.applyVisualProps(el, object, {\r\n      opacity,\r\n      color: color && color !== \"none\" ? color : undefined,\r\n      metalness: Number.isFinite(metalness) ? metalness : undefined,\r\n      roughness: Number.isFinite(roughness) ? roughness : undefined,\r\n      emissive: emissive && emissive !== \"none\" ? emissive : undefined,\r\n      castShadow,\r\n      receiveShadow,\r\n    });\r\n\r\n    this.updateCustomUniforms(el, object, ctx);\r\n\r\n    return { scale: scaleFactor };\r\n  }\r\n\r\n  cleanup(el: HTMLElement, object: String3DObject): void {\r\n    TextSynchronizer.cleanupContentObserver(el);\r\n    TextSynchronizer.geometryKeys.delete(object);\r\n  }\r\n\r\n  private extractCharacterLayout(\r\n    el: HTMLElement,\r\n    transform: string\r\n  ): Array<{\r\n    char: string;\r\n    x: number;\r\n    y: number;\r\n    width?: number;\r\n    height?: number;\r\n    scale?: number;\r\n  }> {\r\n    const layout: Array<{\r\n      char: string;\r\n      x: number;\r\n      y: number;\r\n      width?: number;\r\n      height?: number;\r\n      scale?: number;\r\n    }> = [];\r\n    if (typeof document === \"undefined\" || !document.createRange) return layout;\r\n\r\n    const range = document.createRange();\r\n    const elRect = el.getBoundingClientRect();\r\n    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);\r\n    let node: Node | null;\r\n\r\n    while ((node = walker.nextNode())) {\r\n      const text = node.textContent || \"\";\r\n      if (!text.trim() && text !== \" \") continue;\r\n\r\n      for (let i = 0; i < text.length; i++) {\r\n        const char = text[i];\r\n        if (char === \"\\n\" || char === \"\\r\") continue;\r\n\r\n        if (!char.trim()) continue;\r\n\r\n        range.setStart(node, i);\r\n        range.setEnd(node, i + 1);\r\n        const rects = range.getClientRects();\r\n\r\n        if (rects.length > 0) {\r\n          const r = rects[0];\r\n          const x = r.left - elRect.left;\r\n          const y = r.top - elRect.top;\r\n\r\n          const visibleChar = this.applyTextTransform(char, transform);\r\n\r\n          layout.push({\r\n            char: visibleChar,\r\n            x,\r\n            y,\r\n            width: r.width,\r\n            height: r.height,\r\n          });\r\n        }\r\n      }\r\n    }\r\n    return layout;\r\n  }\r\n\r\n  private getTextMesh(object: String3DObject): any | null {\r\n    const anyObj = object.object as any;\r\n    if (anyObj?.__textMesh) return anyObj.__textMesh;\r\n    if (anyObj?.isMesh) return anyObj;\r\n    if (Array.isArray(anyObj?.children)) {\r\n      const found = anyObj.children.find((child: any) => child?.isMesh);\r\n      if (found) {\r\n        anyObj.__textMesh = found;\r\n        return found;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private updateCustomUniforms(el: HTMLElement, object: String3DObject, ctx: SyncContext): void {\r\n    const factory = ctx.engine.getMaterialFactory?.();\r\n    if (!factory) return;\r\n\r\n    const style = getComputedStyle(el);\r\n\r\n    const apply = (mat: any) => {\r\n      const definition = mat?.userData?.definition;\r\n      if (!definition?.uniforms) return;\r\n\r\n      const values = factory.parseUniformsFromCSS(definition, el, style);\r\n      for (const [key, value] of Object.entries(values)) {\r\n        const def = definition.uniforms?.[key];\r\n        if (!def) continue;\r\n        const converter = (factory as any).convertUniformValue?.bind(factory);\r\n        const converted = converter ? converter(def.type, value) : value;\r\n\r\n        if (mat.userData?.shader?.uniforms?.[key]) {\r\n          mat.userData.shader.uniforms[key].value = converted;\r\n        } else if (mat.userData?.customUniforms?.[key]) {\r\n          mat.userData.customUniforms[key].value = converted;\r\n        } else if (mat.uniforms?.[key]) {\r\n          mat.uniforms[key].value = converted;\r\n        }\r\n      }\r\n    };\r\n\r\n    if (object.object.traverse) {\r\n      object.object.traverse((child: any) => {\r\n        if (child.isMesh) {\r\n          const materials = Array.isArray(child.material) ? child.material : [child.material];\r\n          materials.forEach(apply);\r\n        }\r\n      });\r\n    } else {\r\n      const mesh = this.getTextMesh(object);\r\n      if (!mesh) return;\r\n      const materials = Array.isArray(mesh.material) ? mesh.material : [mesh.material];\r\n      materials.forEach(apply);\r\n    }\r\n  }\r\n\r\n  private readStyleBundle(el: HTMLElement, ctx: SyncContext): StyleBundle {\r\n    return TextSynchronizer.styleCache.get(el, ctx, (el) => {\r\n      const styleMap = (el as any).computedStyleMap?.();\r\n      const style = getComputedStyle(el);\r\n\r\n      const readNumber = (prop: string, fallback: number): number => {\r\n        const mapValue = styleMap?.get?.(prop);\r\n        if (mapValue !== undefined && mapValue !== null) {\r\n          const val =\r\n            typeof mapValue === \"object\" && \"value\" in (mapValue as any)\r\n              ? (mapValue as any).value\r\n              : mapValue;\r\n          const num = typeof val === \"number\" ? val : Number.parseFloat(String(val));\r\n          if (!Number.isNaN(num)) return num;\r\n        }\r\n        const raw = style.getPropertyValue(prop);\r\n        const num = Number.parseFloat(raw);\r\n        return Number.isNaN(num) ? fallback : num;\r\n      };\r\n\r\n      const readString = (prop: string): string => {\r\n        const mapValue = styleMap?.get?.(prop);\r\n        const val =\r\n          mapValue && typeof mapValue === \"object\" && \"value\" in (mapValue as any)\r\n            ? (mapValue as any).value\r\n            : mapValue;\r\n        if (typeof val === \"string\") return val.trim();\r\n        return style.getPropertyValue(prop).trim();\r\n      };\r\n\r\n      const readBool = (prop: string, fallback = false): boolean => {\r\n        const raw = readString(prop);\r\n        if (!raw) return fallback;\r\n        const norm = raw.toLowerCase();\r\n        return norm === \"true\" || norm === \"1\" || norm === \"yes\"\r\n          ? true\r\n          : norm === \"false\" || norm === \"0\" || norm === \"no\"\r\n          ? false\r\n          : fallback;\r\n      };\r\n\r\n      const colorVar = readString(\"--material-color\");\r\n      const color = colorVar && colorVar !== \"none\" ? colorVar : style.color.trim();\r\n\r\n      const fontSize = (() => {\r\n        const raw = style.fontSize || \"\";\r\n        const parsed = Number.parseFloat(raw);\r\n        return Number.isFinite(parsed) ? parsed : 16;\r\n      })();\r\n\r\n      const lineHeight = (() => {\r\n        const raw = style.lineHeight || \"\";\r\n        if (!raw || raw === \"normal\") return fontSize * 1.2;\r\n        const parsed = Number.parseFloat(raw);\r\n        if (!Number.isFinite(parsed)) return fontSize * 1.2;\r\n        return raw.endsWith(\"px\") ? parsed : parsed * fontSize;\r\n      })();\r\n\r\n      const letterSpacing = (() => {\r\n        const raw = style.letterSpacing || \"\";\r\n        if (!raw || raw === \"normal\") return 0;\r\n        const parsed = Number.parseFloat(raw);\r\n        return Number.isFinite(parsed) ? parsed : 0;\r\n      })();\r\n\r\n      const fit = readString(\"--text-fit\") || \"none\";\r\n\r\n      const depthRaw = readNumber(\"--text-depth\", NaN);\r\n      const depth = Number.isFinite(depthRaw) ? depthRaw : Math.max(1, fontSize * 0.2);\r\n\r\n      const bevelSize = readNumber(\"--text-bevel-size\", 0);\r\n      const bevelThickness = readNumber(\"--text-bevel-thickness\", 0);\r\n      const bevelOffset = readNumber(\"--text-bevel-offset\", 0);\r\n      const bevelSegments = readNumber(\"--text-bevel-steps\", 0);\r\n\r\n      const alignRaw = (style.textAlign || \"left\").toLowerCase();\r\n      const align =\r\n        alignRaw === \"center\"\r\n          ? \"center\"\r\n          : alignRaw === \"right\" || alignRaw === \"end\"\r\n          ? \"right\"\r\n          : \"left\";\r\n\r\n      const fontCss = style.font?.trim();\r\n      const computedFont =\r\n        fontCss && fontCss.length > 0\r\n          ? fontCss\r\n          : [\r\n              style.fontStyle || \"normal\",\r\n              style.fontWeight || \"normal\",\r\n              `${style.fontSize || \"16px\"}/${style.lineHeight || \"normal\"}`,\r\n              style.fontFamily || \"sans-serif\",\r\n            ].join(\" \");\r\n\r\n      return {\r\n        translateZ: readNumber(\"--translate-z\", 0),\r\n        cssScale: readNumber(\"--scale\", 1),\r\n        rotateX: readNumber(\"--rotate-x\", 0),\r\n        rotateY: readNumber(\"--rotate-y\", 0),\r\n        rotateZ: readNumber(\"--rotate-z\", 0),\r\n        cssScaleZ: readNumber(\"--scale-z\", 1),\r\n        opacity: readNumber(\"--opacity\", NaN),\r\n        color,\r\n        metalness: readNumber(\"--material-metalness\", NaN),\r\n        roughness: readNumber(\"--material-roughness\", NaN),\r\n        emissive: readString(\"--material-emissive\"),\r\n        castShadow: readBool(\"--shadow-cast\", false),\r\n        receiveShadow: readBool(\"--shadow-receive\", false),\r\n        materialType: readString(\"--material-type\", \"basic\").split(\"[\")[0] || \"basic\",\r\n        fontFamily: style.fontFamily || \"\",\r\n        fontCss: computedFont,\r\n        fontSize,\r\n        lineHeight,\r\n        letterSpacing,\r\n        textAlign: align,\r\n        textTransform: (style.textTransform || \"\").toLowerCase(),\r\n        textDepth: depth,\r\n        textCurveSegments: readNumber(\"--text-curve-segments\", 8),\r\n        bevelEnabled: bevelSize > 0 || bevelThickness > 0,\r\n        bevelSize,\r\n        bevelThickness,\r\n        bevelOffset,\r\n        bevelSegments,\r\n        textFit: fit === \"cover\" || fit === \"none\" ? fit : \"contain\",\r\n      };\r\n    });\r\n  }\r\n\r\n  private applyTextTransform(text: string, transform: string): string {\r\n    if (!transform || transform === \"none\") return text;\r\n    if (transform === \"uppercase\") return text.toUpperCase();\r\n    if (transform === \"lowercase\") return text.toLowerCase();\r\n    if (transform === \"capitalize\") {\r\n      return text.replace(/\\b(\\p{L})/gu, (match) => match.toUpperCase());\r\n    }\r\n    return text;\r\n  }\r\n\r\n  private readLayout(el: HTMLElement, ctx: SyncContext): LayoutBundle {\r\n    const cached = (el as any).__layoutCache;\r\n    if (cached) {\r\n      return cached;\r\n    }\r\n\r\n    return TextSynchronizer.layoutCache.get(el, ctx, (el) => {\r\n      const rect = el.getBoundingClientRect();\r\n      return { rect, width: rect.width, height: rect.height };\r\n    });\r\n  }\r\n}\r\n\r\ntype StyleBundle = {\r\n  translateZ: number;\r\n  cssScale: number;\r\n  rotateX: number;\r\n  rotateY: number;\r\n  rotateZ: number;\r\n  cssScaleZ: number;\r\n  opacity: number;\r\n  color: string;\r\n  metalness: number;\r\n  roughness: number;\r\n  emissive: string;\r\n  castShadow: boolean;\r\n  receiveShadow: boolean;\r\n  materialType: string;\r\n  fontFamily: string;\r\n  fontCss: string;\r\n  fontSize: number;\r\n  lineHeight: number;\r\n  letterSpacing: number;\r\n  textAlign: \"left\" | \"center\" | \"right\";\r\n  textTransform: string;\r\n  textDepth: number;\r\n  textCurveSegments: number;\r\n  bevelEnabled: boolean;\r\n  bevelSize: number;\r\n  bevelThickness: number;\r\n  bevelOffset: number;\r\n  bevelSegments: number;\r\n  textFit: \"contain\" | \"cover\" | \"none\";\r\n};\r\n\r\ntype LayoutBundle = {\r\n  rect: DOMRect;\r\n  width: number;\r\n  height: number;\r\n};\r\n","import { String3DCamera } from \"../String3DCamera\";\r\nimport { String3DObject } from \"../String3DObject\";\r\nimport { I3DEngine } from \"../abstractions/I3DEngine\";\r\nimport { GroupSynchronizer } from \"./GroupSynchronizer\";\r\nimport { LightSynchronizer } from \"./LightSynchronizer\";\r\nimport { MeshSynchronizer } from \"./MeshSynchronizer\";\r\nimport { ParticlesSynchronizer } from \"./ParticlesSynchronizer\";\r\nimport { TextSynchronizer } from \"./TextSynchronizer\";\r\nimport type { String3DObjectSyncStrategy } from \"./String3DObjectSyncStrategy\";\r\n\r\nexport class String3DSynchronizer {\r\n  private strategies: Map<string, String3DObjectSyncStrategy> = new Map();\r\n  private styleReadIntervalMs = 0;\r\n  private layoutReadIntervalMs = 0;\r\n\r\n  constructor(\r\n    public camera: String3DCamera,\r\n    public viewportWidth: number,\r\n    public viewportHeight: number,\r\n    public engine: I3DEngine\r\n  ) {\r\n    this.strategies.set(\"box\", new MeshSynchronizer());\r\n    this.strategies.set(\"sphere\", new MeshSynchronizer());\r\n    this.strategies.set(\"plane\", new MeshSynchronizer());\r\n    this.strategies.set(\"cylinder\", new MeshSynchronizer());\r\n    this.strategies.set(\"model\", new MeshSynchronizer());\r\n    this.strategies.set(\"group\", new GroupSynchronizer());\r\n    this.strategies.set(\"pointLight\", new LightSynchronizer());\r\n    this.strategies.set(\"ambientLight\", new LightSynchronizer());\r\n    this.strategies.set(\"directionalLight\", new LightSynchronizer());\r\n    this.strategies.set(\"spotLight\", new LightSynchronizer());\r\n    this.strategies.set(\"hemisphereLight\", new LightSynchronizer());\r\n    this.strategies.set(\"particles\", new ParticlesSynchronizer());\r\n    this.strategies.set(\"text\", new TextSynchronizer());\r\n  }\r\n\r\n  public syncElement(\r\n    el: HTMLElement,\r\n    object: String3DObject,\r\n    parentData: any,\r\n    hints?: { dirtySet?: Set<HTMLElement> | null; forceSync?: boolean }\r\n  ): any {\r\n    const strategy = this.strategies.get(object.type);\r\n    if (!strategy) {\r\n      return null;\r\n    }\r\n\r\n    return strategy.sync(\r\n      el,\r\n      object,\r\n      {\r\n        camera: this.camera,\r\n        viewportWidth: this.viewportWidth,\r\n        viewportHeight: this.viewportHeight,\r\n        engine: this.engine,\r\n        dirtySet: hints?.dirtySet,\r\n        forceSync: hints?.forceSync,\r\n        styleReadIntervalMs: this.styleReadIntervalMs,\r\n        layoutReadIntervalMs: this.layoutReadIntervalMs,\r\n      },\r\n      parentData\r\n    );\r\n  }\r\n\r\n  public setSyncOptions(options: {\r\n    styleReadIntervalMs?: number;\r\n    layoutReadIntervalMs?: number;\r\n  }): void {\r\n    this.styleReadIntervalMs = Math.max(0, options.styleReadIntervalMs ?? 0);\r\n    this.layoutReadIntervalMs = Math.max(0, options.layoutReadIntervalMs ?? 0);\r\n  }\r\n\r\n  public updateViewportSize(width: number, height: number): void {\r\n    this.viewportWidth = width;\r\n    this.viewportHeight = height;\r\n  }\r\n\r\n  public cleanupElement(el: HTMLElement, object: String3DObject): void {\r\n    const strategy = this.strategies.get(object.type);\r\n    if (strategy?.cleanup) {\r\n      strategy.cleanup(el, object);\r\n    }\r\n  }\r\n}\r\n","import { String3DObject } from \"../../core/String3DObject\";\n\nexport class DirtySyncManager {\n  private readonly attributeFilter: string[];\n  private readonly handleScrollBound = () => this.handleScroll();\n  private dirtyElements: Set<HTMLElement> = new Set();\n  private observedElements: Set<HTMLElement> = new Set();\n  private resizeObserver: ResizeObserver | null = null;\n  private mutationObserver: MutationObserver | null = null;\n  private enabled = false;\n  private domVersion = 0;\n\n  constructor(attributeFilter: string[]) {\n    this.attributeFilter = attributeFilter;\n  }\n\n  enable(): void {\n    if (this.enabled) return;\n    this.enabled = true;\n    this.setupObservers();\n    this.setupScrollListeners();\n  }\n\n  disable(): void {\n    if (!this.enabled) return;\n    this.enabled = false;\n    this.removeScrollListeners();\n    this.resizeObserver?.disconnect();\n    this.mutationObserver?.disconnect();\n    this.dirtyElements.clear();\n    this.observedElements.clear();\n  }\n\n  observeElement(el: HTMLElement): void {\n    if (!this.enabled || this.observedElements.has(el)) return;\n    this.observedElements.add(el);\n    this.resizeObserver?.observe(el);\n    this.mutationObserver?.observe(el, {\n      attributes: true,\n      attributeFilter: this.attributeFilter,\n    });\n  }\n\n  observeScene(rootObjects: String3DObject[]): void {\n    if (!this.enabled) return;\n    rootObjects.forEach((obj) => this.observeRecursive(obj));\n  }\n\n  markDirty(el: HTMLElement): void {\n    if (!this.enabled) return;\n    this.dirtyElements.add(el);\n    this.bumpVersion();\n  }\n\n  markAllDirty(): void {\n    if (!this.enabled) return;\n    this.observedElements.forEach((el) => this.dirtyElements.add(el));\n    this.bumpVersion();\n  }\n\n  getDirtySet(): Set<HTMLElement> | null {\n    return this.enabled ? this.dirtyElements : null;\n  }\n\n  clearDirty(): void {\n    this.dirtyElements.clear();\n  }\n\n  getVersion(): number {\n    return this.domVersion;\n  }\n\n  isEnabled(): boolean {\n    return this.enabled;\n  }\n\n  private observeRecursive(object: String3DObject): void {\n    if (object.el instanceof HTMLElement) {\n      this.observeElement(object.el);\n    }\n    object.children.forEach((child) => this.observeRecursive(child));\n  }\n\n  private handleScroll(): void {\n    this.markAllDirty();\n  }\n\n  private setupObservers(): void {\n    if (typeof ResizeObserver !== \"undefined\") {\n      this.resizeObserver = new ResizeObserver((entries) => {\n        entries.forEach((entry) => {\n          if (entry.target instanceof HTMLElement) {\n            this.markDirty(entry.target);\n          }\n        });\n      });\n    }\n\n    if (typeof MutationObserver !== \"undefined\") {\n      this.mutationObserver = new MutationObserver((mutations) => {\n        mutations.forEach((mutation) => {\n          if (mutation.target instanceof HTMLElement) {\n            this.markDirty(mutation.target);\n          }\n        });\n      });\n    }\n  }\n\n  private setupScrollListeners(): void {\n    window.addEventListener(\"scroll\", this.handleScrollBound, { passive: true });\n    window.addEventListener(\"resize\", this.handleScrollBound, { passive: true });\n    if (window.visualViewport) {\n      window.visualViewport.addEventListener(\"scroll\", this.handleScrollBound, { passive: true });\n      window.visualViewport.addEventListener(\"resize\", this.handleScrollBound, { passive: true });\n    }\n  }\n\n  private removeScrollListeners(): void {\n    window.removeEventListener(\"scroll\", this.handleScrollBound);\n    window.removeEventListener(\"resize\", this.handleScrollBound);\n    if (window.visualViewport) {\n      window.visualViewport.removeEventListener(\"scroll\", this.handleScrollBound);\n      window.visualViewport.removeEventListener(\"resize\", this.handleScrollBound);\n    }\n  }\n\n  private bumpVersion(): void {\n    this.domVersion += 1;\n  }\n}\n","import { String3DObject } from \"../../core/String3DObject\";\r\nimport { String3DCustomFilterRegistry } from \"../../core/filters/String3DCustomFilter\";\r\nimport {\r\n  String3DFilterChain,\r\n  String3DFilterEffect,\r\n  String3DFilterTarget,\r\n} from \"../../core/filters/String3DFilterTypes\";\r\nimport { readFilterRaw } from \"./styleUtils\";\r\n\r\ntype FilterTransitionState = {\r\n  raw: string;\r\n  effects: String3DFilterChain;\r\n  animating: boolean;\r\n  from: String3DFilterChain;\r\n  to: String3DFilterChain;\r\n  startTime: number;\r\n  duration: number;\r\n  easing: (t: number) => number;\r\n  clearOnComplete: boolean;\r\n  lastDuration: number;\r\n  lastDelay: number;\r\n  lastEasing: (t: number) => number;\r\n  pendingRaw?: string;\r\n  pendingEffects?: String3DFilterChain;\r\n  effectsKey?: string;\r\n};\r\n\r\nexport class FilterController {\r\n  private filterStates: WeakMap<HTMLElement, FilterTransitionState> = new WeakMap();\r\n  private filterWarnings: WeakMap<HTMLElement, string> = new WeakMap();\r\n\r\n  constructor(private easingParser?: (value: string) => (t: number) => number) {}\r\n\r\n  collectTargets(\r\n    rootObjects: String3DObject[],\r\n    now: number,\r\n    useDirtySync: boolean,\r\n    dirtySet: Set<HTMLElement> | null\r\n  ): String3DFilterTarget[] {\r\n    const targets: String3DFilterTarget[] = [];\r\n    const walk = (obj: String3DObject): void => {\r\n      const el = obj.el as HTMLElement | undefined;\r\n      if (el) {\r\n        const animating = this.filterStates.get(el)?.animating === true;\r\n        const shouldReadStyle = !useDirtySync || !dirtySet || dirtySet.has(el) || animating;\r\n        const chain = this.readFilterChain(el, now, shouldReadStyle);\r\n        if (chain && chain.length > 0) {\r\n          const dirty = !useDirtySync || !dirtySet || dirtySet.has(el) || animating;\r\n          const effectsKey =\r\n            this.filterStates.get(el)?.effectsKey || this.stringifyFilterChain(chain);\r\n          targets.push({\r\n            object: obj,\r\n            effects: chain,\r\n            effectsKey,\r\n            dirty,\r\n          });\r\n          return;\r\n        }\r\n      }\r\n      obj.children.forEach((child) => walk(child));\r\n    };\r\n    rootObjects.forEach((obj) => walk(obj));\r\n    return targets;\r\n  }\r\n\r\n  clear(): void {\r\n    this.filterStates = new WeakMap();\r\n    this.filterWarnings = new WeakMap();\r\n  }\r\n\r\n  private readFilterChain(\r\n    el: HTMLElement,\r\n    now: number,\r\n    shouldReadStyle: boolean\r\n  ): String3DFilterChain | null {\r\n    const existing = this.filterStates.get(el);\r\n    if (!shouldReadStyle && existing) {\r\n      if (existing.animating) {\r\n        return this.sampleTransition(existing, now);\r\n      }\r\n      return existing.effects;\r\n    }\r\n\r\n    const raw = readFilterRaw(el);\r\n    if (!raw || raw === \"none\") {\r\n      if (existing) {\r\n        if (existing.animating && existing.clearOnComplete) {\r\n          const current = this.sampleTransition(existing, now);\r\n          if (!existing.animating) {\r\n            this.filterStates.delete(el);\r\n            return null;\r\n          }\r\n          return current;\r\n        }\r\n        let { duration, delay, easing } = this.getFilterTransition(el);\r\n        if (duration <= 0 && existing.lastDuration > 0) {\r\n          duration = existing.lastDuration;\r\n          delay = existing.lastDelay;\r\n          easing = existing.lastEasing;\r\n        }\r\n        if (duration > 0) {\r\n          const zero = this.makeZeroChain(existing.effects);\r\n          existing.from = existing.effects;\r\n          existing.to = zero;\r\n          existing.startTime = now + delay;\r\n          existing.duration = duration;\r\n          existing.easing = easing;\r\n          existing.animating = true;\r\n          existing.clearOnComplete = true;\r\n          existing.lastDuration = duration;\r\n          existing.lastDelay = delay;\r\n          existing.lastEasing = easing;\r\n          return this.sampleTransition(existing, now);\r\n        }\r\n      }\r\n      this.filterStates.delete(el);\r\n      return null;\r\n    }\r\n\r\n    const { effects, warnings } = this.parseFilterChain(raw);\r\n    this.warnFilterIssues(el, raw, warnings);\r\n    if (effects.length === 0) return null;\r\n\r\n    const state = this.filterStates.get(el);\r\n    if (!state) {\r\n      const { duration, delay, easing } = this.getFilterTransition(el);\r\n      if (duration > 0) {\r\n        const zero = this.makeZeroChain(effects);\r\n        const newState: FilterTransitionState = {\r\n          raw,\r\n          effects,\r\n          animating: true,\r\n          from: zero,\r\n          to: effects,\r\n          startTime: now + delay,\r\n          duration,\r\n          easing,\r\n          clearOnComplete: false,\r\n          lastDuration: duration,\r\n          lastDelay: delay,\r\n          lastEasing: easing,\r\n        };\r\n        newState.effectsKey = this.stringifyFilterChain(effects);\r\n        this.filterStates.set(el, newState);\r\n        return this.sampleTransition(newState, now);\r\n      }\r\n      this.filterStates.set(el, {\r\n        raw,\r\n        effects,\r\n        animating: false,\r\n        from: effects,\r\n        to: effects,\r\n        startTime: 0,\r\n        duration: 0,\r\n        easing: (t) => t,\r\n        clearOnComplete: false,\r\n        lastDuration: 0,\r\n        lastDelay: 0,\r\n        lastEasing: (t) => t,\r\n        effectsKey: this.stringifyFilterChain(effects),\r\n      });\r\n      return effects;\r\n    }\r\n\r\n    if (state.raw === raw) {\r\n      if (state.animating) {\r\n        const current = this.sampleTransition(state, now);\r\n        if (!state.animating && state.clearOnComplete) {\r\n          this.filterStates.delete(el);\r\n          return null;\r\n        }\r\n        return current;\r\n      }\r\n      return state.effects;\r\n    }\r\n\r\n    state.pendingEffects = undefined;\r\n    state.pendingRaw = undefined;\r\n\r\n    let { duration, delay, easing } = this.getFilterTransition(el);\r\n    if (duration <= 0 && state.lastDuration > 0) {\r\n      duration = state.lastDuration;\r\n      delay = state.lastDelay;\r\n      easing = state.lastEasing;\r\n    }\r\n    if (duration > 0) {\r\n      const canTween = this.canInterpolate(state.effects, effects);\r\n      const current = state.animating ? this.getCurrentChain(state, now) : state.effects;\r\n      if (!canTween && this.isZeroChain(effects)) {\r\n        state.pendingRaw = raw;\r\n        state.pendingEffects = effects;\r\n        state.raw = raw;\r\n        state.effects = current;\r\n        state.from = current;\r\n        state.to = this.makeZeroChain(current);\r\n        state.startTime = now + delay;\r\n        state.duration = duration;\r\n        state.easing = easing;\r\n        state.animating = true;\r\n        state.clearOnComplete = false;\r\n        state.lastDuration = duration;\r\n        state.lastDelay = delay;\r\n        state.lastEasing = easing;\r\n        state.effectsKey = this.stringifyFilterChain(effects);\r\n        return this.sampleTransition(state, now);\r\n      }\r\n\r\n      const fromChain = canTween ? current : this.makeZeroChain(effects);\r\n      state.raw = raw;\r\n      state.effects = effects;\r\n      state.from = fromChain;\r\n      state.to = effects;\r\n      state.startTime = now + delay;\r\n      state.duration = duration;\r\n      state.easing = easing;\r\n      state.animating = true;\r\n      state.clearOnComplete = false;\r\n      state.lastDuration = duration;\r\n      state.lastDelay = delay;\r\n      state.lastEasing = easing;\r\n      state.effectsKey = this.stringifyFilterChain(effects);\r\n      return this.sampleTransition(state, now);\r\n    }\r\n\r\n    state.raw = raw;\r\n    state.effects = effects;\r\n    state.animating = false;\r\n    state.clearOnComplete = false;\r\n    state.effectsKey = this.stringifyFilterChain(effects);\r\n    return effects;\r\n  }\r\n\r\n  private warnFilterIssues(el: HTMLElement, raw: string, warnings: string[]): void {\r\n    if (warnings.length === 0) return;\r\n    const lastRaw = this.filterWarnings.get(el);\r\n    if (lastRaw === raw) return;\r\n    this.filterWarnings.set(el, raw);\r\n  }\r\n\r\n  private parseFilterChain(raw: string): { effects: String3DFilterChain; warnings: string[] } {\r\n    const warnings: string[] = [];\r\n    const effects: String3DFilterChain = [];\r\n\r\n    const parseNumber = (value: string): number | null => {\r\n      const cleaned = value.trim().toLowerCase();\r\n      const match = cleaned.match(/^(-?\\d*\\.?\\d+)(px)?$/);\r\n      if (!match) return null;\r\n      const num = Number.parseFloat(match[1]);\r\n      return Number.isFinite(num) ? num : null;\r\n    };\r\n\r\n    const parseRatio = (value: string): number | null => {\r\n      const cleaned = value.trim().toLowerCase();\r\n      if (!cleaned) return null;\r\n      if (cleaned.endsWith(\"%\")) {\r\n        const num = Number.parseFloat(cleaned.slice(0, -1));\r\n        return Number.isFinite(num) ? num / 100 : null;\r\n      }\r\n      const num = Number.parseFloat(cleaned);\r\n      return Number.isFinite(num) ? num : null;\r\n    };\r\n\r\n    const parseAngle = (value: string): number | null => {\r\n      const cleaned = value.trim().toLowerCase();\r\n      if (!cleaned) return null;\r\n      if (cleaned.endsWith(\"rad\")) {\r\n        const num = Number.parseFloat(cleaned.slice(0, -3));\r\n        return Number.isFinite(num) ? num : null;\r\n      }\r\n      const stripped = cleaned.endsWith(\"deg\") ? cleaned.slice(0, -3) : cleaned;\r\n      const num = Number.parseFloat(stripped);\r\n      return Number.isFinite(num) ? (num * Math.PI) / 180 : null;\r\n    };\r\n\r\n    const parseBloom = (value: string): { intensity: number; threshold: number } | null => {\r\n      const parts = value.split(\",\").map((part) => part.trim());\r\n      const intensity = parseNumber(parts[0] || \"\");\r\n      if (intensity === null) return null;\r\n      const threshold = parts[1] ? parseRatio(parts[1]) : null;\r\n      return {\r\n        intensity: Math.max(0, intensity),\r\n        threshold: threshold === null ? 0.8 : Math.max(0, Math.min(1, threshold)),\r\n      };\r\n    };\r\n\r\n    const parseAmount = (value: string, name: string, allowZero = false): number | null => {\r\n      const amount = parseNumber(value);\r\n      if (amount === null) {\r\n        warnings.push(`[String3D] Invalid ${name} value \"${value}\".`);\r\n        return null;\r\n      }\r\n      if (!allowZero && amount <= 0) {\r\n        warnings.push(`[String3D] ${name} must be > 0.`);\r\n        return null;\r\n      }\r\n      return amount;\r\n    };\r\n\r\n    const parseRatioAmount = (value: string, name: string): number | null => {\r\n      const amount = parseRatio(value);\r\n      if (amount === null) {\r\n        warnings.push(`[String3D] Invalid ${name} value \"${value}\".`);\r\n        return null;\r\n      }\r\n      return amount;\r\n    };\r\n\r\n    const re = /([a-zA-Z-]+)\\(([^)]*)\\)/g;\r\n    let match: RegExpExecArray | null;\r\n    while ((match = re.exec(raw))) {\r\n      const name = match[1].toLowerCase();\r\n      const args = (match[2] || \"\").trim();\r\n\r\n      if (name === \"blur\") {\r\n        const amount = parseAmount(args, \"blur\", true);\r\n        if (amount !== null) effects.push({ type: \"blur\", amount });\r\n      } else if (name === \"pixel\" || name === \"pixelate\") {\r\n        const size = parseAmount(args, \"pixel\", true);\r\n        if (size !== null) effects.push({ type: \"pixel\", size });\r\n      } else if (name === \"bloom\") {\r\n        const bloom = parseBloom(args);\r\n        if (bloom) effects.push({ type: \"bloom\", ...bloom });\r\n        else warnings.push(`[String3D] Invalid bloom value \"${args}\".`);\r\n      } else if (name === \"brightness\") {\r\n        const amount = parseRatioAmount(args, \"brightness\");\r\n        if (amount !== null) effects.push({ type: \"brightness\", amount: Math.max(0, amount) });\r\n      } else if (name === \"contrast\") {\r\n        const amount = parseRatioAmount(args, \"contrast\");\r\n        if (amount !== null) effects.push({ type: \"contrast\", amount: Math.max(0, amount) });\r\n      } else if (name === \"saturate\") {\r\n        const amount = parseRatioAmount(args, \"saturate\");\r\n        if (amount !== null) effects.push({ type: \"saturate\", amount: Math.max(0, amount) });\r\n      } else if (name === \"grayscale\") {\r\n        const amount = parseRatioAmount(args, \"grayscale\");\r\n        if (amount !== null)\r\n          effects.push({ type: \"grayscale\", amount: Math.max(0, Math.min(1, amount)) });\r\n      } else if (name === \"sepia\") {\r\n        const amount = parseRatioAmount(args, \"sepia\");\r\n        if (amount !== null)\r\n          effects.push({ type: \"sepia\", amount: Math.max(0, Math.min(1, amount)) });\r\n      } else if (name === \"invert\") {\r\n        const amount = parseRatioAmount(args, \"invert\");\r\n        if (amount !== null)\r\n          effects.push({ type: \"invert\", amount: Math.max(0, Math.min(1, amount)) });\r\n      } else if (name === \"hue-rotate\") {\r\n        const angle = parseAngle(args);\r\n        if (angle !== null) effects.push({ type: \"hue-rotate\", angle });\r\n        else warnings.push(`[String3D] Invalid hue-rotate value \"${args}\".`);\r\n      } else if (name) {\r\n        const custom = String3DCustomFilterRegistry.get(name);\r\n        if (custom) {\r\n          const parsed = custom.parse ? custom.parse(args) : {};\r\n          if (parsed === null) {\r\n            warnings.push(`[String3D] Invalid custom filter \"${name}\" args \"${args}\".`);\r\n          } else {\r\n            effects.push({ type: \"custom\", name, uniforms: parsed });\r\n          }\r\n        } else {\r\n          warnings.push(`[String3D] Unknown filter \"${name}\".`);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (effects.length === 0) {\r\n      warnings.push(\"[String3D] No valid filters parsed from --filter.\");\r\n    }\r\n\r\n    return { effects, warnings };\r\n  }\r\n\r\n  private getFilterTransition(el: HTMLElement): {\r\n    duration: number;\r\n    delay: number;\r\n    easing: (t: number) => number;\r\n  } {\r\n    const style = getComputedStyle(el);\r\n    const properties = this.splitTransitionList(style.transitionProperty);\r\n    const durations = this.splitTransitionList(style.transitionDuration);\r\n    const delays = this.splitTransitionList(style.transitionDelay);\r\n    const timings = this.splitTransitionList(style.transitionTimingFunction);\r\n\r\n    const index = this.findTransitionIndex(properties, \"--filter\");\r\n    if (index === -1) {\r\n      const shorthand = this.parseTransitionShorthand(style.transition);\r\n      const fallback = shorthand.get(\"--filter\") || shorthand.get(\"all\");\r\n      if (fallback) {\r\n        return fallback;\r\n      }\r\n      return { duration: 0, delay: 0, easing: (t) => t };\r\n    }\r\n\r\n    const duration = this.parseTime(durations[index] || durations[durations.length - 1] || \"0s\");\r\n    const delay = this.parseTime(delays[index] || delays[delays.length - 1] || \"0s\");\r\n    const easingRaw = timings[index] || timings[timings.length - 1] || \"linear\";\r\n    return { duration, delay, easing: this.parseEasing(easingRaw) };\r\n  }\r\n\r\n  private splitTransitionList(value: string): string[] {\r\n    const result: string[] = [];\r\n    let current = \"\";\r\n    let depth = 0;\r\n    for (let i = 0; i < value.length; i += 1) {\r\n      const ch = value[i];\r\n      if (ch === \"(\") depth += 1;\r\n      if (ch === \")\") depth = Math.max(0, depth - 1);\r\n      if (ch === \",\" && depth === 0) {\r\n        result.push(current.trim());\r\n        current = \"\";\r\n      } else {\r\n        current += ch;\r\n      }\r\n    }\r\n    if (current.trim()) result.push(current.trim());\r\n    return result.length > 0 ? result : [\"all\"];\r\n  }\r\n\r\n  private findTransitionIndex(properties: string[], name: string): number {\r\n    const normalized = properties.map((prop) => prop.trim().toLowerCase());\r\n    let index = normalized.indexOf(name);\r\n    if (index === -1) {\r\n      index = normalized.indexOf(\"all\");\r\n    }\r\n    return index;\r\n  }\r\n\r\n  private parseTime(value: string): number {\r\n    const raw = value.trim().toLowerCase();\r\n    if (raw.endsWith(\"ms\")) {\r\n      const num = Number.parseFloat(raw.slice(0, -2));\r\n      return Number.isFinite(num) ? num : 0;\r\n    }\r\n    if (raw.endsWith(\"s\")) {\r\n      const num = Number.parseFloat(raw.slice(0, -1));\r\n      return Number.isFinite(num) ? num * 1000 : 0;\r\n    }\r\n    const num = Number.parseFloat(raw);\r\n    return Number.isFinite(num) ? num : 0;\r\n  }\r\n\r\n  private parseTransitionShorthand(\r\n    value: string\r\n  ): Map<string, { duration: number; delay: number; easing: (t: number) => number }> {\r\n    const map = new Map<\r\n      string,\r\n      { duration: number; delay: number; easing: (t: number) => number }\r\n    >();\r\n    const parts = this.splitTransitionList(value);\r\n    parts.forEach((part) => {\r\n      if (!part) return;\r\n      const tokens = part.trim().split(/\\s+(?![^()]*\\))/g);\r\n      let prop = \"\";\r\n      let duration = \"\";\r\n      let delay = \"\";\r\n      let easing = \"\";\r\n      tokens.forEach((token) => {\r\n        const lower = token.toLowerCase();\r\n        if (lower.endsWith(\"ms\") || lower.endsWith(\"s\") || /^[0-9.]+$/.test(lower)) {\r\n          if (!duration) duration = lower;\r\n          else if (!delay) delay = lower;\r\n        } else if (\r\n          lower.startsWith(\"cubic-bezier\") ||\r\n          lower.startsWith(\"steps\") ||\r\n          lower === \"linear\" ||\r\n          lower === \"ease\" ||\r\n          lower === \"ease-in\" ||\r\n          lower === \"ease-out\" ||\r\n          lower === \"ease-in-out\"\r\n        ) {\r\n          easing = token;\r\n        } else if (!prop) {\r\n          prop = token;\r\n        }\r\n      });\r\n      if (!prop) return;\r\n      map.set(prop.trim().toLowerCase(), {\r\n        duration: this.parseTime(duration || \"0s\"),\r\n        delay: this.parseTime(delay || \"0s\"),\r\n        easing: this.parseEasing(easing || \"linear\"),\r\n      });\r\n    });\r\n    return map;\r\n  }\r\n\r\n  private parseEasing(value: string): (t: number) => number {\r\n    const raw = value.trim();\r\n    if (!raw) return (t) => t;\r\n    if (!this.easingParser) return (t) => t;\r\n    try {\r\n      const fn = this.easingParser(raw);\r\n      return typeof fn === \"function\" ? fn : (t) => t;\r\n    } catch {\r\n      return (t) => t;\r\n    }\r\n  }\r\n\r\n  private canInterpolate(from: String3DFilterChain, to: String3DFilterChain): boolean {\r\n    if (from.length !== to.length) return false;\r\n    return from.every((effect, index) => {\r\n      const other = to[index];\r\n      if (effect.type !== other.type) return false;\r\n      if (effect.type === \"custom\" && other.type === \"custom\") {\r\n        if (effect.name !== other.name) return false;\r\n        const keys = Object.keys(effect.uniforms || {});\r\n        const otherKeys = Object.keys(other.uniforms || {});\r\n        if (keys.length !== otherKeys.length) return false;\r\n        return keys.every(\r\n          (key) => key in (other.uniforms || {}) && this.isNumeric(effect.uniforms?.[key])\r\n        );\r\n      }\r\n      return true;\r\n    });\r\n  }\r\n\r\n  private makeZeroChain(chain: String3DFilterChain): String3DFilterChain {\r\n    return chain.map((effect) => {\r\n      switch (effect.type) {\r\n        case \"blur\":\r\n          return { type: \"blur\", amount: 0 };\r\n        case \"pixel\":\r\n          return { type: \"pixel\", size: 0 };\r\n        case \"bloom\":\r\n          return { type: \"bloom\", intensity: 0, threshold: effect.threshold };\r\n        case \"brightness\":\r\n          return { type: \"brightness\", amount: 1 };\r\n        case \"contrast\":\r\n          return { type: \"contrast\", amount: 1 };\r\n        case \"saturate\":\r\n          return { type: \"saturate\", amount: 1 };\r\n        case \"grayscale\":\r\n          return { type: \"grayscale\", amount: 0 };\r\n        case \"sepia\":\r\n          return { type: \"sepia\", amount: 0 };\r\n        case \"invert\":\r\n          return { type: \"invert\", amount: 0 };\r\n        case \"hue-rotate\":\r\n          return { type: \"hue-rotate\", angle: 0 };\r\n        case \"custom\": {\r\n          const uniforms: Record<string, any> = {};\r\n          Object.entries(effect.uniforms || {}).forEach(([key, value]) => {\r\n            uniforms[key] = this.isNumeric(value) ? 0 : value;\r\n          });\r\n          return { type: \"custom\", name: effect.name, uniforms };\r\n        }\r\n        default:\r\n          return effect;\r\n      }\r\n    });\r\n  }\r\n\r\n  private sampleTransition(state: FilterTransitionState, now: number): String3DFilterChain {\r\n    if (!state.animating) return state.effects;\r\n    if (now < state.startTime) {\r\n      return state.from;\r\n    }\r\n    const elapsed = now - state.startTime;\r\n    const duration = Math.max(1, state.duration);\r\n    const t = Math.min(1, Math.max(0, elapsed / duration));\r\n    const eased = state.easing(t);\r\n    const interpolated = this.interpolateChain(state.from, state.to, eased);\r\n    if (t >= 1) {\r\n      state.animating = false;\r\n      state.from = state.to;\r\n      if (state.pendingEffects && state.pendingRaw === state.raw) {\r\n        state.effects = state.pendingEffects;\r\n        state.raw = state.pendingRaw || state.raw;\r\n        state.pendingEffects = undefined;\r\n        state.pendingRaw = undefined;\r\n      } else if (state.pendingEffects) {\r\n        state.pendingEffects = undefined;\r\n        state.pendingRaw = undefined;\r\n      }\r\n    }\r\n    return interpolated;\r\n  }\r\n\r\n  private getCurrentChain(state: FilterTransitionState, now: number): String3DFilterChain {\r\n    if (!state.animating) return state.effects;\r\n    if (now < state.startTime) return state.from;\r\n    const elapsed = now - state.startTime;\r\n    const duration = Math.max(1, state.duration);\r\n    const t = Math.min(1, Math.max(0, elapsed / duration));\r\n    const eased = state.easing(t);\r\n    return this.interpolateChain(state.from, state.to, eased);\r\n  }\r\n\r\n  private interpolateChain(\r\n    from: String3DFilterChain,\r\n    to: String3DFilterChain,\r\n    t: number\r\n  ): String3DFilterChain {\r\n    if (!this.canInterpolate(from, to)) return to;\r\n    return from.map((effect, index) => this.interpolateEffect(effect, to[index], t));\r\n  }\r\n\r\n  private interpolateEffect(\r\n    from: String3DFilterEffect,\r\n    to: String3DFilterEffect,\r\n    t: number\r\n  ): String3DFilterEffect {\r\n    const lerp = (a: number, b: number) => a + (b - a) * t;\r\n    if (from.type === \"blur\" && to.type === \"blur\") {\r\n      return { type: \"blur\", amount: lerp(from.amount, to.amount) };\r\n    }\r\n    if (from.type === \"pixel\" && to.type === \"pixel\") {\r\n      return { type: \"pixel\", size: lerp(from.size, to.size) };\r\n    }\r\n    if (from.type === \"bloom\" && to.type === \"bloom\") {\r\n      return {\r\n        type: \"bloom\",\r\n        intensity: lerp(from.intensity, to.intensity),\r\n        threshold: lerp(from.threshold, to.threshold),\r\n      };\r\n    }\r\n    if (from.type === \"brightness\" && to.type === \"brightness\") {\r\n      return { type: \"brightness\", amount: lerp(from.amount, to.amount) };\r\n    }\r\n    if (from.type === \"contrast\" && to.type === \"contrast\") {\r\n      return { type: \"contrast\", amount: lerp(from.amount, to.amount) };\r\n    }\r\n    if (from.type === \"saturate\" && to.type === \"saturate\") {\r\n      return { type: \"saturate\", amount: lerp(from.amount, to.amount) };\r\n    }\r\n    if (from.type === \"grayscale\" && to.type === \"grayscale\") {\r\n      return { type: \"grayscale\", amount: lerp(from.amount, to.amount) };\r\n    }\r\n    if (from.type === \"sepia\" && to.type === \"sepia\") {\r\n      return { type: \"sepia\", amount: lerp(from.amount, to.amount) };\r\n    }\r\n    if (from.type === \"invert\" && to.type === \"invert\") {\r\n      return { type: \"invert\", amount: lerp(from.amount, to.amount) };\r\n    }\r\n    if (from.type === \"hue-rotate\" && to.type === \"hue-rotate\") {\r\n      return { type: \"hue-rotate\", angle: lerp(from.angle, to.angle) };\r\n    }\r\n    if (from.type === \"custom\" && to.type === \"custom\" && from.name === to.name) {\r\n      const uniforms: Record<string, any> = {};\r\n      Object.entries(to.uniforms || {}).forEach(([key, value]) => {\r\n        const fromValue = from.uniforms?.[key];\r\n        if (this.isNumeric(fromValue) && this.isNumeric(value)) {\r\n          uniforms[key] = lerp(fromValue, value);\r\n        } else {\r\n          uniforms[key] = value;\r\n        }\r\n      });\r\n      return { type: \"custom\", name: to.name, uniforms };\r\n    }\r\n    return to;\r\n  }\r\n\r\n  private stringifyFilterChain(chain: String3DFilterChain): string {\r\n    const parts = chain.map((effect) => {\r\n      if (effect.type === \"blur\") return `blur:${effect.amount}`;\r\n      if (effect.type === \"pixel\") return `pixel:${effect.size}`;\r\n      if (effect.type === \"bloom\") return `bloom:${effect.intensity},${effect.threshold}`;\r\n      if (effect.type === \"brightness\") return `brightness:${effect.amount}`;\r\n      if (effect.type === \"contrast\") return `contrast:${effect.amount}`;\r\n      if (effect.type === \"saturate\") return `saturate:${effect.amount}`;\r\n      if (effect.type === \"grayscale\") return `grayscale:${effect.amount}`;\r\n      if (effect.type === \"sepia\") return `sepia:${effect.amount}`;\r\n      if (effect.type === \"invert\") return `invert:${effect.amount}`;\r\n      if (effect.type === \"hue-rotate\") return `hue-rotate:${effect.angle}`;\r\n      if (effect.type === \"custom\") {\r\n        const uniforms = Object.keys(effect.uniforms || {})\r\n          .sort()\r\n          .map((key) => `${key}=${(effect.uniforms as any)[key]}`)\r\n          .join(\",\");\r\n        return `custom:${effect.name}:${uniforms}`;\r\n      }\r\n      return \"unknown\";\r\n    });\r\n    return parts.join(\"|\");\r\n  }\r\n\r\n  private isNumeric(value: unknown): value is number {\r\n    return typeof value === \"number\" && Number.isFinite(value);\r\n  }\r\n\r\n  private isZeroChain(chain: String3DFilterChain): boolean {\r\n    return chain.every((effect) => {\r\n      switch (effect.type) {\r\n        case \"blur\":\r\n          return effect.amount <= 0;\r\n        case \"pixel\":\r\n          return effect.size <= 0;\r\n        case \"bloom\":\r\n          return effect.intensity <= 0;\r\n        case \"brightness\":\r\n          return effect.amount === 1;\r\n        case \"contrast\":\r\n          return effect.amount === 1;\r\n        case \"saturate\":\r\n          return effect.amount === 1;\r\n        case \"grayscale\":\r\n          return effect.amount === 0;\r\n        case \"sepia\":\r\n          return effect.amount === 0;\r\n        case \"invert\":\r\n          return effect.amount === 0;\r\n        case \"hue-rotate\":\r\n          return effect.angle === 0;\r\n        case \"custom\":\r\n          return false;\r\n        default:\r\n          return false;\r\n      }\r\n    });\r\n  }\r\n}\r\n","import { StringModule } from \"@fiddle-digital/string-tune\";\r\nimport { StringObject } from \"@fiddle-digital/string-tune\";\r\nimport { StringData } from \"@fiddle-digital/string-tune\";\r\nimport { StringContext } from \"@fiddle-digital/string-tune\";\r\nimport { String3DCamera } from \"../core/String3DCamera\";\r\nimport { String3DRenderer } from \"../core/String3DRenderer\";\r\nimport { String3DScene } from \"../core/String3DScene\";\r\nimport { String3DSynchronizer } from \"../core/synchronizer/String3DSynchronizer\";\r\nimport { I3DEngineProvider } from \"../core/abstractions/I3DEngineProvider\";\r\nimport { I3DEngine, I3DModelLoader } from \"../core/abstractions/I3DEngine\";\r\nimport { String3DObject } from \"../core/String3DObject\";\r\nimport { DirtySyncManager } from \"./string3d/DirtySyncManager\";\r\nimport { FilterController } from \"./string3d/FilterController\";\r\nimport { StyleReader } from \"./string3d/styleUtils\";\r\nimport { String3DFontRegistry } from \"../core/text\";\r\n\r\nexport interface String3DOptions {\r\n  hideHTML?: boolean;\r\n  container?: string | HTMLElement;\r\n  zIndex?: number;\r\n  modelLoaderType?: string;\r\n  modelLoader?: I3DModelLoader;\r\n  modelLoaderFactory?: (engine: I3DEngine, type?: string) => I3DModelLoader;\r\n  useDirtySync?: boolean;\r\n  styleReadIntervalMs?: number;\r\n  layoutReadIntervalMs?: number;\r\n}\r\n\r\nexport class String3D extends StringModule {\r\n  private static provider: I3DEngineProvider | null = null;\r\n  private static _instance: String3D | null = null;\r\n\r\n  private renderer: String3DRenderer | null = null;\r\n  private camera: String3DCamera | null = null;\r\n  private _scene: String3DScene | null = null;\r\n  private synchronizer: String3DSynchronizer | null = null;\r\n  private engine: I3DEngine | null = null;\r\n  private canvasContainer: HTMLElement | null = null;\r\n  private isLoading: Map<string, boolean> = new Map();\r\n  private options: String3DOptions;\r\n  private useDirtySync = false;\r\n  private dirtySyncManager: DirtySyncManager;\r\n  private lastSyncData: WeakMap<String3DObject, { scale: number }> = new WeakMap();\r\n  private filterController: FilterController;\r\n  private needsInitialResize = true;\r\n\r\n  public static getInstance(): String3D | null {\r\n    return String3D._instance;\r\n  }\r\n\r\n  public get scene(): String3DScene | null {\r\n    return this._scene;\r\n  }\r\n\r\n  public static setProvider(provider: I3DEngineProvider): void {\r\n    String3D.provider = provider;\r\n  }\r\n\r\n  public static registerFont(name: string, url: string, options: { default?: boolean } = {}): void {\r\n    String3DFontRegistry.register(name, url);\r\n    if (options.default) {\r\n      String3DFontRegistry.setDefault(name);\r\n    }\r\n  }\r\n\r\n  public static setDefaultFont(name: string): void {\r\n    String3DFontRegistry.setDefault(name);\r\n  }\r\n\r\n  constructor(context: StringContext) {\r\n    super(context);\r\n    this.htmlKey = \"3d\";\r\n    this.options = this.buildOptionsFromSettings();\r\n    this.dirtySyncManager = new DirtySyncManager([\r\n      \"style\",\r\n      \"class\",\r\n      \"string-3d\",\r\n      \"string-3d-model-fit\",\r\n      \"string-3d-model-scale\",\r\n    ]);\r\n    this.filterController = new FilterController((value) =>\r\n      this.tools.easingFunction.process({ easing: value })\r\n    );\r\n\r\n    this.attributesToMap = [\r\n      ...this.attributesToMap,\r\n      { key: \"3d\", type: \"string\", fallback: \"box\" },\r\n      { key: \"3d-model\", type: \"string\", fallback: \"\" },\r\n      { key: \"3d-segments\", type: \"number\", fallback: 32 },\r\n      { key: \"3d-segments-width\", type: \"number\", fallback: 32 },\r\n      { key: \"3d-segments-height\", type: \"number\", fallback: 32 },\r\n      { key: \"3d-model-loader\", type: \"string\", fallback: \"\" },\r\n      { key: \"3d-model-scale\", type: \"number\", fallback: 1 },\r\n      { key: \"3d-model-center\", type: \"boolean\", fallback: false },\r\n      { key: \"3d-model-fit\", type: \"string\", fallback: \"contain\" },\r\n    ];\r\n\r\n    String3D._instance = this;\r\n  }\r\n\r\n  override canConnect(object: StringObject): boolean {\r\n    return super.canConnect(object);\r\n  }\r\n\r\n  override initializeObject(\r\n    globalId: number,\r\n    object: StringObject,\r\n    element: HTMLElement,\r\n    attributes: Record<string, any>\r\n  ): void {\r\n    super.initializeObject(globalId, object, element, attributes);\r\n\r\n    object.setProperty(\"parentId\", null);\r\n    const parentElement = element.parentElement?.closest(\r\n      '[string-3d=\"group\"]'\r\n    ) as HTMLElement | null;\r\n    if (parentElement) {\r\n      const parentId = parentElement.getAttribute(\"string-id\");\r\n      if (parentId) {\r\n        object.setProperty(\"parentId\", parentId);\r\n        object.setProperty(\"parent\", parentElement);\r\n      }\r\n    }\r\n  }\r\n\r\n  override onResize(): void {\r\n    if (this.renderer && this.camera && this.synchronizer) {\r\n      this.renderer.resize(this.camera);\r\n      this.synchronizer.updateViewportSize(this.renderer.width, this.renderer.height);\r\n      this.camera.clearScaleCache();\r\n      if (this.useDirtySync) {\r\n        this.dirtySyncManager.markAllDirty();\r\n      }\r\n    }\r\n  }\r\n\r\n  override onInit(): void {\r\n    this.options = this.buildOptionsFromSettings();\r\n    if (!String3D.provider) {\r\n      return;\r\n    }\r\n\r\n    this.engine = String3D.provider.getEngine();\r\n    this.canvasContainer = this.createOrGetContainer();\r\n    this.registerTypedProperties();\r\n    this.injectCSS();\r\n    this.useDirtySync = !!this.options.useDirtySync;\r\n    if (this.useDirtySync) {\r\n      this.dirtySyncManager.enable();\r\n    }\r\n\r\n    this.renderer = new String3DRenderer(this.canvasContainer, this.engine);\r\n    this.renderer.attach();\r\n\r\n    this.camera = new String3DCamera(this.engine, \"orthographic\");\r\n    this.camera.setPosition(0, 0, 1000);\r\n    this.camera.resize(this.renderer.width, this.renderer.height);\r\n\r\n    const modelLoader = this.resolveModelLoader();\r\n    const modelLoaderFactory = this.resolveModelLoaderFactory();\r\n    this._scene = new String3DScene(this.engine, {\r\n      modelLoader,\r\n      modelLoaderFactory,\r\n    });\r\n    this._scene.getScene().add(this.camera.camera);\r\n\r\n    this.synchronizer = new String3DSynchronizer(\r\n      this.camera,\r\n      this.renderer.width,\r\n      this.renderer.height,\r\n      this.engine\r\n    );\r\n    this.synchronizer.setSyncOptions({\r\n      styleReadIntervalMs: this.options.styleReadIntervalMs,\r\n      layoutReadIntervalMs: this.options.layoutReadIntervalMs,\r\n    });\r\n\r\n    this._scene.setSynchronizer(this.synchronizer);\r\n  }\r\n\r\n  override onSettingsChange(): void {\r\n    this.options = this.buildOptionsFromSettings();\r\n    const shouldUseDirtySync = !!this.options.useDirtySync;\r\n    if (shouldUseDirtySync && !this.useDirtySync) {\r\n      this.useDirtySync = true;\r\n      this.dirtySyncManager.enable();\r\n      if (this._scene) {\r\n        this.dirtySyncManager.observeScene(this._scene.rootObjects);\r\n      }\r\n      this.dirtySyncManager.markAllDirty();\r\n    } else if (!shouldUseDirtySync && this.useDirtySync) {\r\n      this.useDirtySync = false;\r\n      this.dirtySyncManager.disable();\r\n    }\r\n\r\n    this.synchronizer?.setSyncOptions({\r\n      styleReadIntervalMs: this.options.styleReadIntervalMs,\r\n      layoutReadIntervalMs: this.options.layoutReadIntervalMs,\r\n    });\r\n  }\r\n\r\n  private buildOptionsFromSettings(): String3DOptions {\r\n    return {\r\n      hideHTML: this.getSettingValue(\"hideHTML\", false),\r\n      container: this.getSettingValue(\"container\", undefined),\r\n      zIndex: this.getSettingValue(\"zIndex\", 1),\r\n      modelLoaderType: this.getSettingValue(\"modelLoaderType\", undefined),\r\n      modelLoader: this.getSettingValue(\"modelLoader\", undefined),\r\n      modelLoaderFactory: this.getSettingValue(\"modelLoaderFactory\", undefined),\r\n      useDirtySync: this.getSettingValue(\"useDirtySync\", false),\r\n      styleReadIntervalMs: this.getSettingValue(\"styleReadIntervalMs\", 0),\r\n      layoutReadIntervalMs: this.getSettingValue(\"layoutReadIntervalMs\", 0),\r\n    };\r\n  }\r\n\r\n  private getSettingValue<T>(key: string, fallback: T): T {\r\n    if (!this.settings || !(key in this.settings)) return fallback;\r\n    return this.settings[key] as T;\r\n  }\r\n\r\n  private resolveModelLoader(): I3DModelLoader | undefined {\r\n    if (!this.engine) return undefined;\r\n    if (this.options.modelLoader) return this.options.modelLoader;\r\n    if (this.options.modelLoaderFactory) return undefined;\r\n    if (this.options.modelLoaderType) {\r\n      try {\r\n        return this.engine.createModelLoader(this.options.modelLoaderType);\r\n      } catch (error) {}\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  private resolveModelLoaderFactory():\r\n    | ((engine: I3DEngine, type?: string) => I3DModelLoader)\r\n    | undefined {\r\n    if (!this.engine) return undefined;\r\n    if (this.options.modelLoaderFactory) return this.options.modelLoaderFactory;\r\n    if (this.options.modelLoaderType) {\r\n      return (engine: I3DEngine, type?: string) => {\r\n        const loaderType = type || this.options.modelLoaderType;\r\n        if (!loaderType) {\r\n          throw new Error(\"[String3D] Model loader type not provided\");\r\n        }\r\n        return engine.createModelLoader(loaderType);\r\n      };\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  private createOrGetContainer(): HTMLElement {\r\n    if (this.options.container instanceof HTMLElement) {\r\n      this.applyContainerStyles(this.options.container);\r\n      return this.options.container;\r\n    }\r\n\r\n    if (typeof this.options.container === \"string\") {\r\n      const existing = document.getElementById(this.options.container);\r\n      if (existing) {\r\n        this.applyContainerStyles(existing);\r\n        return existing;\r\n      }\r\n    }\r\n\r\n    const container = document.createElement(\"div\");\r\n    container.id = \"string-3d-canvas\";\r\n    this.applyContainerStyles(container);\r\n    document.body.insertBefore(container, document.body.firstChild);\r\n    return container;\r\n  }\r\n\r\n  private applyContainerStyles(el: HTMLElement): void {\r\n    Object.assign(el.style, {\r\n      position: \"fixed\",\r\n      left: \"0\",\r\n      top: \"0\",\r\n      width: \"100vw\",\r\n      height: \"100lvh\",\r\n      zIndex: String(this.options.zIndex),\r\n      pointerEvents: \"none\",\r\n    });\r\n  }\r\n\r\n  override onObjectConnected(object: StringObject): void {\r\n    if (this.isLoading.has(object.id) || !this._scene) {\r\n      return;\r\n    }\r\n    this.isLoading.set(object.id, true);\r\n\r\n    this._scene.createFromElement(object);\r\n\r\n    if (this.useDirtySync && object.htmlElement) {\r\n      this.dirtySyncManager.observeElement(object.htmlElement);\r\n      this.dirtySyncManager.markDirty(object.htmlElement);\r\n    }\r\n\r\n    if (this.options.hideHTML && object.htmlElement) {\r\n      object.htmlElement.style.opacity = \"0\";\r\n      object.htmlElement.style.pointerEvents = \"none\";\r\n    }\r\n  }\r\n\r\n  override onFrame(data: StringData): void {\r\n    if (!this.renderer || !this._scene || !this.camera || !this.synchronizer) return;\r\n\r\n    if (this.needsInitialResize) {\r\n      this.needsInitialResize = false;\r\n      this.renderer.resize(this.camera);\r\n      this.synchronizer.updateViewportSize(this.renderer.width, this.renderer.height);\r\n    }\r\n\r\n    const dirtySet = this.useDirtySync ? this.dirtySyncManager.getDirtySet() : null;\r\n    const forceSync = !dirtySet || dirtySet.size === 0;\r\n\r\n    this.batchReadLayouts(this._scene.rootObjects, forceSync, dirtySet);\r\n\r\n    this._scene.rootObjects.forEach((obj) => {\r\n      this.syncRecursive(obj.el, obj, { scale: 1 }, forceSync, dirtySet);\r\n    });\r\n\r\n    const filterTargets = this.filterController.collectTargets(\r\n      this._scene.rootObjects,\r\n      performance.now(),\r\n      this.useDirtySync,\r\n      dirtySet\r\n    );\r\n    this.renderer!.render(this._scene!, this.camera!, filterTargets);\r\n\r\n    if (this.useDirtySync) {\r\n      this.dirtySyncManager.clearDirty();\r\n    }\r\n  }\r\n\r\n  private batchReadLayouts(\r\n    rootObjects: String3DObject[],\r\n    forceSync: boolean,\r\n    dirtySet: Set<HTMLElement> | null\r\n  ): void {\r\n    const walk = (obj: String3DObject): void => {\r\n      if (obj.el) {\r\n        const shouldSync = forceSync || !dirtySet || dirtySet.has(obj.el);\r\n        if (shouldSync) {\r\n          const rect = obj.el.getBoundingClientRect();\r\n          const width = obj.el.offsetWidth || rect.width;\r\n          const height = obj.el.offsetHeight || rect.height;\r\n          (obj.el as any).__layoutCache = { rect, width, height };\r\n        }\r\n      }\r\n      obj.children.forEach(walk);\r\n    };\r\n    rootObjects.forEach(walk);\r\n  }\r\n\r\n  private syncRecursive(\r\n    el: HTMLElement | undefined,\r\n    object: String3DObject,\r\n    parentData: any,\r\n    forceSync: boolean,\r\n    dirtySet: Set<HTMLElement> | null\r\n  ): void {\r\n    if (!this.synchronizer || !el) return;\r\n    const shouldSync =\r\n      object.type === \"particles\" ||\r\n      object.type === \"text\" ||\r\n      forceSync ||\r\n      !dirtySet ||\r\n      dirtySet.has(el);\r\n    let nextParentData = parentData;\r\n\r\n    if (shouldSync) {\r\n      const data = this.synchronizer.syncElement(el, object, parentData, {\r\n        dirtySet,\r\n        forceSync,\r\n      });\r\n      if (data && typeof data.scale === \"number\") {\r\n        this.lastSyncData.set(object, data);\r\n        nextParentData = data;\r\n      }\r\n    } else {\r\n      const cached = this.lastSyncData.get(object);\r\n      if (cached) {\r\n        nextParentData = cached;\r\n      }\r\n    }\r\n\r\n    const forceChildren = forceSync || shouldSync;\r\n    object.children.forEach((child) =>\r\n      this.syncRecursive(child.el, child, nextParentData, forceChildren, dirtySet)\r\n    );\r\n  }\r\n\r\n  private injectCSS(): void {\r\n    if (document.getElementById(\"string-3d-styles\")) return;\r\n\r\n    const style = document.createElement(\"style\");\r\n    style.id = \"string-3d-styles\";\r\n    style.textContent = `\r\n      @property --translate-x { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --translate-y { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --translate-z { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --rotate-x { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --rotate-y { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --rotate-z { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --scale { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --scale-x { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --scale-y { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --scale-z { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --opacity { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --filter { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --light-color { syntax: \"<color>\"; inherits: false; initial-value: #ffffff; }\r\n      @property --light-intensity { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --light-distance { syntax: \"<number>\"; inherits: false; initial-value: 1000; }\r\n      @property --light-decay { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --light-angle { syntax: \"<number>\"; inherits: false; initial-value: 1.0472; }\r\n      @property --light-penumbra { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --light-ground-color { syntax: \"<color>\"; inherits: false; initial-value: #ffffff; }\r\n      @property --light-target { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --shadow-cast { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --shadow-receive { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --shadow-bias { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --shadow-map-size { syntax: \"<number>\"; inherits: false; initial-value: 512; }\r\n      @property --texture-flip-y { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --texture-color-space { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --particles-mode { syntax: \"*\"; inherits: false; initial-value: emitter; }\r\n      @property --particles-count { syntax: \"<number>\"; inherits: false; initial-value: 300; }\r\n      @property --particles-size { syntax: \"<number>\"; inherits: false; initial-value: 2; }\r\n      @property --particles-color { syntax: \"<color>\"; inherits: false; initial-value: #ffffff; }\r\n      @property --particles-opacity { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --particles-spread { syntax: \"<number>\"; inherits: false; initial-value: 120; }\r\n      @property --particles-seed { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --particles-shape { syntax: \"*\"; inherits: false; initial-value: sphere; }\r\n      @property --particles-fit { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --particles-model { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --particles-model-loader { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --particles-model-node { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --instance-model { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --instance-model-loader { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --instance-model-node { syntax: \"*\"; inherits: false; initial-value: none; }\r\n      @property --emit-rate { syntax: \"<number>\"; inherits: false; initial-value: 30; }\r\n      @property --emit-burst { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --particle-life { syntax: \"<number>\"; inherits: false; initial-value: 2.5; }\r\n      @property --particle-speed { syntax: \"<number>\"; inherits: false; initial-value: 40; }\r\n      @property --particle-direction { syntax: \"*\"; inherits: false; initial-value: 0 1 0; }\r\n      @property --particle-gravity { syntax: \"*\"; inherits: false; initial-value: 0 -30 0; }\r\n      @property --particle-drag { syntax: \"<number>\"; inherits: false; initial-value: 0.1; }\r\n      @property --particle-size-variation { syntax: \"<number>\"; inherits: false; initial-value: 0.6; }\r\n      @property --particle-color-variation { syntax: \"<number>\"; inherits: false; initial-value: 0.2; }\r\n      @property --instance-shape { syntax: \"*\"; inherits: false; initial-value: sphere; }\r\n      @property --instance-scale { syntax: \"<number>\"; inherits: false; initial-value: 1; }\r\n      @property --instance-scale-variation { syntax: \"<number>\"; inherits: false; initial-value: 0.5; }\r\n      @property --instance-rotation-speed { syntax: \"<number>\"; inherits: false; initial-value: 0.4; }\r\n      @property --instance-jitter { syntax: \"<number>\"; inherits: false; initial-value: 0.2; }\r\n      @property --instance-flow { syntax: \"<number>\"; inherits: false; initial-value: 0.3; }\r\n      @property --instance-disperse { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --instance-scatter { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --instance-scatter-x { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --instance-scatter-y { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --instance-scatter-z { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --text-depth { syntax: \"<number>\"; inherits: false; initial-value: 8; }\r\n      @property --text-curve-segments { syntax: \"<number>\"; inherits: false; initial-value: 8; }\r\n      @property --text-bevel-size { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --text-bevel-thickness { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --text-bevel-offset { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --text-bevel-steps { syntax: \"<number>\"; inherits: false; initial-value: 0; }\r\n      @property --text-fit { syntax: \"*\"; inherits: false; initial-value: contain; }\r\n\r\n      :where([string-3d]) {\r\n        --translate-x: 0; --translate-y: 0; --translate-z: 0;\r\n        --rotate-x: 0; --rotate-y: 0; --rotate-z: 0;\r\n        --scale: 1; --scale-x: 1; --scale-y: 1; --scale-z: 1; --opacity: 1; --filter: none;\r\n        --light-color: #ffffff; --light-intensity: 1; --light-distance: 1000; --light-decay: 0;\r\n        --light-angle: 1.0472; --light-penumbra: 0; --light-ground-color: #ffffff; --light-target: none;\r\n        --shadow-cast: 0; --shadow-receive: 0; --shadow-bias: 0; --shadow-map-size: 512;\r\n        --texture-flip-y: 1; --texture-color-space: none;\r\n        --particles-mode: emitter; --particles-count: 300; --particles-size: 2; --particles-color: #ffffff;\r\n        --particles-opacity: 1; --particles-spread: 120; --particles-seed: 1; --particles-shape: sphere;\r\n        --particles-fit: 0;\r\n        --particles-model: none; --particles-model-loader: none; --particles-model-node: none;\r\n        --instance-model: none; --instance-model-loader: none; --instance-model-node: none;\r\n        --emit-rate: 30; --emit-burst: 0; --particle-life: 2.5; --particle-speed: 40;\r\n        --particle-direction: 0 1 0; --particle-gravity: 0 -30 0; --particle-drag: 0.1;\r\n        --particle-size-variation: 0.6; --particle-color-variation: 0.2;\r\n        --instance-shape: sphere; --instance-scale: 1; --instance-scale-variation: 0.5;\r\n        --instance-rotation-speed: 0.4; --instance-jitter: 0.2; --instance-flow: 0.3;\r\n        --instance-disperse: 0;\r\n        --instance-scatter: 0;\r\n        --instance-scatter-x: 0; --instance-scatter-y: 0; --instance-scatter-z: 0;\r\n        --text-depth: 8; --text-curve-segments: 8; --text-bevel-size: 0; --text-bevel-thickness: 0;\r\n        --text-bevel-offset: 0; --text-bevel-steps: 0; --text-fit: contain;\r\n        transform-style: preserve-3d;\r\n      }\r\n\r\n      [string-3d-visual=\"true\"] {\r\n        transform:\r\n          translate3d(calc(var(--translate-x) * 1px), calc(var(--translate-y) * 1px), calc(var(--translate-z) * 1px))\r\n          rotateX(calc(var(--rotate-x) * 1deg))\r\n          rotateY(calc(var(--rotate-y) * 1deg))\r\n          rotateZ(calc(var(--rotate-z) * 1deg))\r\n          scale3d(calc(var(--scale) * var(--scale-x)), calc(var(--scale) * var(--scale-y)), calc(var(--scale) * var(--scale-z)));\r\n      }\r\n    `;\r\n    document.head.appendChild(style);\r\n  }\r\n\r\n  private registerTypedProperties(): void {\r\n    const css = (globalThis as any).CSS;\r\n    if (!css?.registerProperty) return;\r\n\r\n    const props: Array<{ name: string; initialValue: string }> = [\r\n      { name: \"--translate-x\", initialValue: \"0\" },\r\n      { name: \"--translate-y\", initialValue: \"0\" },\r\n      { name: \"--translate-z\", initialValue: \"0\" },\r\n      { name: \"--rotate-x\", initialValue: \"0\" },\r\n      { name: \"--rotate-y\", initialValue: \"0\" },\r\n      { name: \"--rotate-z\", initialValue: \"0\" },\r\n      { name: \"--scale\", initialValue: \"1\" },\r\n      { name: \"--scale-x\", initialValue: \"1\" },\r\n      { name: \"--scale-y\", initialValue: \"1\" },\r\n      { name: \"--scale-z\", initialValue: \"1\" },\r\n      { name: \"--opacity\", initialValue: \"1\" },\r\n      { name: \"--filter\", initialValue: \"none\" },\r\n      { name: \"--material-type\", initialValue: \"basic\" },\r\n      { name: \"--material-color\", initialValue: \"#ffffff\" },\r\n      { name: \"--material-metalness\", initialValue: \"0\" },\r\n      { name: \"--material-roughness\", initialValue: \"1\" },\r\n      { name: \"--material-emissive\", initialValue: \"#000000\" },\r\n      { name: \"--rim-color\", initialValue: \"#00c8ff\" },\r\n      { name: \"--rim-power\", initialValue: \"1.5\" },\r\n      { name: \"--rim-strength\", initialValue: \"1\" },\r\n      { name: \"--uv-strength\", initialValue: \"0.7\" },\r\n      { name: \"--texture-map\", initialValue: \"none\" },\r\n      { name: \"--texture-normal\", initialValue: \"none\" },\r\n      { name: \"--texture-roughness\", initialValue: \"none\" },\r\n      { name: \"--texture-metalness\", initialValue: \"none\" },\r\n      { name: \"--texture-ao\", initialValue: \"none\" },\r\n      { name: \"--light-color\", initialValue: \"#ffffff\" },\r\n      { name: \"--light-intensity\", initialValue: \"1\" },\r\n      { name: \"--light-distance\", initialValue: \"1000\" },\r\n      { name: \"--light-decay\", initialValue: \"0\" },\r\n      { name: \"--light-angle\", initialValue: \"1.0472\" },\r\n      { name: \"--light-penumbra\", initialValue: \"0\" },\r\n      { name: \"--light-ground-color\", initialValue: \"#ffffff\" },\r\n      { name: \"--light-target\", initialValue: \"none\" },\r\n      { name: \"--shadow-cast\", initialValue: \"0\" },\r\n      { name: \"--shadow-receive\", initialValue: \"0\" },\r\n      { name: \"--shadow-bias\", initialValue: \"0\" },\r\n      { name: \"--shadow-map-size\", initialValue: \"512\" },\r\n      { name: \"--texture-flip-y\", initialValue: \"1\" },\r\n      { name: \"--texture-color-space\", initialValue: \"none\" },\r\n      { name: \"--particles-mode\", initialValue: \"emitter\" },\r\n      { name: \"--particles-count\", initialValue: \"300\" },\r\n      { name: \"--particles-size\", initialValue: \"2\" },\r\n      { name: \"--particles-color\", initialValue: \"#ffffff\" },\r\n      { name: \"--particles-opacity\", initialValue: \"1\" },\r\n      { name: \"--particles-spread\", initialValue: \"120\" },\r\n      { name: \"--particles-seed\", initialValue: \"1\" },\r\n      { name: \"--particles-shape\", initialValue: \"sphere\" },\r\n      { name: \"--particles-fit\", initialValue: \"0\" },\r\n      { name: \"--particles-model\", initialValue: \"none\" },\r\n      { name: \"--particles-model-loader\", initialValue: \"none\" },\r\n      { name: \"--particles-model-node\", initialValue: \"none\" },\r\n      { name: \"--instance-model\", initialValue: \"none\" },\r\n      { name: \"--instance-model-loader\", initialValue: \"none\" },\r\n      { name: \"--instance-model-node\", initialValue: \"none\" },\r\n      { name: \"--emit-rate\", initialValue: \"30\" },\r\n      { name: \"--emit-burst\", initialValue: \"0\" },\r\n      { name: \"--particle-life\", initialValue: \"2.5\" },\r\n      { name: \"--particle-speed\", initialValue: \"40\" },\r\n      { name: \"--particle-direction\", initialValue: \"0 1 0\" },\r\n      { name: \"--particle-gravity\", initialValue: \"0 -30 0\" },\r\n      { name: \"--particle-drag\", initialValue: \"0.1\" },\r\n      { name: \"--particle-size-variation\", initialValue: \"0.6\" },\r\n      { name: \"--particle-color-variation\", initialValue: \"0.2\" },\r\n      { name: \"--instance-shape\", initialValue: \"sphere\" },\r\n      { name: \"--instance-scale\", initialValue: \"1\" },\r\n      { name: \"--instance-scale-variation\", initialValue: \"0.5\" },\r\n      { name: \"--instance-rotation-speed\", initialValue: \"0.4\" },\r\n      { name: \"--instance-jitter\", initialValue: \"0.2\" },\r\n      { name: \"--instance-flow\", initialValue: \"0.3\" },\r\n      { name: \"--instance-disperse\", initialValue: \"0\" },\r\n      { name: \"--instance-scatter\", initialValue: \"0\" },\r\n      { name: \"--instance-scatter-x\", initialValue: \"0\" },\r\n      { name: \"--instance-scatter-y\", initialValue: \"0\" },\r\n      { name: \"--instance-scatter-z\", initialValue: \"0\" },\r\n      { name: \"--text-depth\", initialValue: \"8\" },\r\n      { name: \"--text-curve-segments\", initialValue: \"8\" },\r\n      { name: \"--text-bevel-size\", initialValue: \"0\" },\r\n      { name: \"--text-bevel-thickness\", initialValue: \"0\" },\r\n      { name: \"--text-bevel-offset\", initialValue: \"0\" },\r\n      { name: \"--text-bevel-steps\", initialValue: \"0\" },\r\n      { name: \"--text-fit\", initialValue: \"contain\" },\r\n    ];\r\n\r\n    props.forEach(({ name, initialValue }) => {\r\n      try {\r\n        css.registerProperty({\r\n          name,\r\n          syntax:\r\n            name === \"--filter\" ||\r\n            name === \"--light-target\" ||\r\n            name.startsWith(\"--texture-\") ||\r\n            name === \"--material-type\" ||\r\n            name === \"--particles-mode\" ||\r\n            name === \"--particles-shape\" ||\r\n            name === \"--particles-model\" ||\r\n            name === \"--particles-model-loader\" ||\r\n            name === \"--particles-model-node\" ||\r\n            name === \"--instance-model\" ||\r\n            name === \"--instance-model-loader\" ||\r\n            name === \"--instance-model-node\" ||\r\n            name === \"--particle-direction\" ||\r\n            name === \"--particle-gravity\" ||\r\n            name === \"--instance-shape\" ||\r\n            name === \"--text-fit\"\r\n              ? \"*\"\r\n              : name.includes(\"color\") || name.includes(\"emissive\")\r\n              ? \"<color>\"\r\n              : \"<number>\",\r\n          inherits: false,\r\n          initialValue,\r\n        });\r\n      } catch {}\r\n    });\r\n  }\r\n\r\n  override destroy(): void {\r\n    this.renderer?.destroy();\r\n    this._scene?.destroy();\r\n    this.isLoading.clear();\r\n    this.dirtySyncManager.disable();\r\n    this.filterController.clear();\r\n    this.lastSyncData = new WeakMap();\r\n\r\n    const styleEl = document.getElementById(\"string-3d-styles\");\r\n    styleEl?.remove();\r\n\r\n    if (this.canvasContainer?.id === \"string-3d-canvas\") {\r\n      this.canvasContainer.remove();\r\n    }\r\n\r\n    super.destroy();\r\n  }\r\n}\r\n","import type {\n  String3DCustomMaterialDefinition,\n  IMaterialInstance,\n  IMaterialFactory,\n} from \"../core/materials\";\nimport { collectUniformsFromCSS, mergeInjections } from \"../core/materials\";\n\nexport class ThreeJSMaterialFactory implements IMaterialFactory {\n  private THREE: any;\n  private textureLoader: any;\n  private textureCache: Map<string, any> = new Map();\n\n  constructor(THREE: any) {\n    this.THREE = THREE;\n    this.textureLoader = new THREE.TextureLoader();\n  }\n\n  supports(definition: String3DCustomMaterialDefinition): boolean {\n    return true;\n  }\n\n  create(\n    definition: String3DCustomMaterialDefinition,\n    initialUniforms?: Record<string, any>\n  ): IMaterialInstance {\n    const uniforms = this.buildUniforms(definition, initialUniforms);\n\n    let material: any;\n\n    if (definition.extends === \"shader\" || (!definition.extends && definition.vertexShader)) {\n      material = this.createShaderMaterial(definition, uniforms);\n    } else {\n      material = this.createExtendedMaterial(definition, uniforms);\n    }\n\n    this.applyMaterialProperties(material, definition);\n\n    const update = (newUniforms: Record<string, any>) => {\n      this.updateUniforms(material, definition, newUniforms);\n    };\n\n    const dispose = () => {\n      material.dispose();\n    };\n\n    return { material, definition, update, dispose };\n  }\n\n  parseUniformsFromCSS(\n    definition: String3DCustomMaterialDefinition,\n    element: HTMLElement,\n    style: CSSStyleDeclaration\n  ): Record<string, any> {\n    return collectUniformsFromCSS(definition, element, style);\n  }\n\n  private buildUniforms(\n    definition: String3DCustomMaterialDefinition,\n    initialValues?: Record<string, any>\n  ): Record<string, { value: any }> {\n    const result: Record<string, { value: any }> = {};\n\n    if (definition.uniforms) {\n      for (const [key, def] of Object.entries(definition.uniforms)) {\n        let value = initialValues?.[key] ?? def.value;\n        value = this.convertUniformValue(def.type, value);\n        result[key] = { value };\n      }\n    }\n\n    return result;\n  }\n\n  private convertUniformValue(type: string, value: any): any {\n    switch (type) {\n      case \"vec2\":\n        if (Array.isArray(value)) {\n          return new this.THREE.Vector2(value[0], value[1]);\n        }\n        return value;\n      case \"vec3\":\n        if (Array.isArray(value)) {\n          return new this.THREE.Vector3(value[0], value[1], value[2]);\n        }\n        return value;\n      case \"vec4\":\n        if (Array.isArray(value)) {\n          return new this.THREE.Vector4(value[0], value[1], value[2], value[3]);\n        }\n        return value;\n      case \"color\":\n        if (Array.isArray(value)) {\n          return new this.THREE.Color(value[0], value[1], value[2]);\n        }\n        if (typeof value === \"string\") {\n          return new this.THREE.Color(value);\n        }\n        return value;\n      case \"texture\":\n        if (typeof value === \"string\" && value) {\n          return this.loadTexture(value);\n        }\n        return value;\n      default:\n        return value;\n    }\n  }\n\n  private loadTexture(url: string): any {\n    if (this.textureCache.has(url)) {\n      return this.textureCache.get(url);\n    }\n    const texture = this.textureLoader.load(url);\n    this.textureCache.set(url, texture);\n    return texture;\n  }\n\n  private createShaderMaterial(\n    definition: String3DCustomMaterialDefinition,\n    uniforms: Record<string, { value: any }>\n  ): any {\n    const material = new this.THREE.ShaderMaterial({\n      uniforms,\n      vertexShader: definition.vertexShader || this.getDefaultVertexShader(),\n      fragmentShader: definition.fragmentShader || this.getDefaultFragmentShader(),\n      lights: definition.lights ?? false,\n      transparent: definition.properties?.transparent ?? false,\n    });\n    material.userData.customUniforms = uniforms;\n    material.userData.definition = definition;\n    return material;\n  }\n\n  private createExtendedMaterial(\n    definition: String3DCustomMaterialDefinition,\n    uniforms: Record<string, { value: any }>\n  ): any {\n    const baseType = definition.extends || \"standard\";\n    let BaseMaterial: any;\n\n    switch (baseType) {\n      case \"basic\":\n        BaseMaterial = this.THREE.MeshBasicMaterial;\n        break;\n      case \"physical\":\n        BaseMaterial = this.THREE.MeshPhysicalMaterial;\n        break;\n      case \"standard\":\n      default:\n        BaseMaterial = this.THREE.MeshStandardMaterial;\n        break;\n    }\n\n    const material = new BaseMaterial({\n      transparent: definition.properties?.transparent ?? false,\n    });\n\n    if (definition.injections && definition.injections.length > 0) {\n      const injectionMap = mergeInjections(definition.injections);\n\n      material.onBeforeCompile = (shader: any) => {\n        Object.assign(shader.uniforms, uniforms);\n\n        shader.vertexShader = this.injectVertexShader(shader.vertexShader, injectionMap, uniforms);\n        shader.fragmentShader = this.injectFragmentShader(\n          shader.fragmentShader,\n          injectionMap,\n          uniforms\n        );\n\n        material.userData.shader = shader;\n      };\n    }\n\n    material.userData.customUniforms = uniforms;\n    material.userData.definition = definition;\n\n    return material;\n  }\n\n  private injectVertexShader(\n    shader: string,\n    injections: Map<string, string>,\n    uniforms: Record<string, { value: any }>\n  ): string {\n    let result = shader;\n\n    const pars = injections.get(\"vertex_pars\");\n    if (pars) {\n      result = result.replace(\"#include <common>\", `#include <common>\\n${pars}`);\n    }\n\n    const header = injections.get(\"vertex_header\");\n    if (header) {\n      const uniformDeclarations = this.generateUniformDeclarations(uniforms);\n      result = result.replace(\"void main() {\", `${uniformDeclarations}\\n${header}\\nvoid main() {`);\n    }\n\n    const transform = injections.get(\"vertex_transform\");\n    if (transform) {\n      result = result.replace(\"#include <begin_vertex>\", `#include <begin_vertex>\\n${transform}`);\n    }\n\n    const output = injections.get(\"vertex_output\");\n    if (output) {\n      result = result.replace(\"#include <project_vertex>\", `${output}\\n#include <project_vertex>`);\n    }\n\n    return result;\n  }\n\n  private injectFragmentShader(\n    shader: string,\n    injections: Map<string, string>,\n    uniforms: Record<string, { value: any }>\n  ): string {\n    let result = shader;\n\n    const pars = injections.get(\"fragment_pars\");\n    if (pars) {\n      result = result.replace(\"#include <common>\", `#include <common>\\n${pars}`);\n    }\n\n    const header = injections.get(\"fragment_header\");\n    if (header) {\n      const uniformDeclarations = this.generateUniformDeclarations(uniforms);\n      result = result.replace(\"void main() {\", `${uniformDeclarations}\\n${header}\\nvoid main() {`);\n    }\n\n    const color = injections.get(\"fragment_color\");\n    if (color) {\n      result = result.replace(\"#include <color_fragment>\", `#include <color_fragment>\\n${color}`);\n    }\n\n    const normal = injections.get(\"fragment_normal\");\n    if (normal) {\n      result = result.replace(\n        \"#include <normal_fragment_maps>\",\n        `#include <normal_fragment_maps>\\n${normal}`\n      );\n    }\n\n    const roughness = injections.get(\"fragment_roughness\");\n    if (roughness) {\n      result = result.replace(\n        \"#include <roughnessmap_fragment>\",\n        `#include <roughnessmap_fragment>\\n${roughness}`\n      );\n    }\n\n    const metalness = injections.get(\"fragment_metalness\");\n    if (metalness) {\n      result = result.replace(\n        \"#include <metalnessmap_fragment>\",\n        `#include <metalnessmap_fragment>\\n${metalness}`\n      );\n    }\n\n    const ao = injections.get(\"fragment_ao\");\n    if (ao) {\n      result = result.replace(\"#include <aomap_fragment>\", `#include <aomap_fragment>\\n${ao}`);\n    }\n\n    const transmission = injections.get(\"fragment_transmission\");\n    if (transmission) {\n      result = result.replace(\n        \"#include <transmission_fragment>\",\n        `#include <transmission_fragment>\\n${transmission}`\n      );\n    }\n\n    const lights = injections.get(\"fragment_lights\");\n    if (lights) {\n      result = result.replace(\n        \"#include <lights_physical_fragment>\",\n        `#include <lights_physical_fragment>\\n${lights}`\n      );\n    }\n\n    const emissive = injections.get(\"fragment_emissive\");\n    if (emissive) {\n      result = result.replace(\n        \"#include <emissivemap_fragment>\",\n        `#include <emissivemap_fragment>\\n${emissive}`\n      );\n    }\n\n    const output = injections.get(\"fragment_output\");\n    if (output) {\n      result = result.replace(\n        \"#include <dithering_fragment>\",\n        `${output}\\n#include <dithering_fragment>`\n      );\n    }\n\n    return result;\n  }\n\n  private generateUniformDeclarations(uniforms: Record<string, { value: any }>): string {\n    const lines: string[] = [];\n\n    for (const [name, uniform] of Object.entries(uniforms)) {\n      const type = this.inferGLSLType(uniform.value);\n      lines.push(`uniform ${type} ${name};`);\n    }\n\n    return lines.join(\"\\n\");\n  }\n\n  private inferGLSLType(value: any): string {\n    if (typeof value === \"number\") return \"float\";\n    if (typeof value === \"boolean\") return \"bool\";\n    if (value instanceof this.THREE.Vector2) return \"vec2\";\n    if (value instanceof this.THREE.Vector3) return \"vec3\";\n    if (value instanceof this.THREE.Vector4) return \"vec4\";\n    if (value instanceof this.THREE.Color) return \"vec3\";\n    if (value instanceof this.THREE.Matrix3) return \"mat3\";\n    if (value instanceof this.THREE.Matrix4) return \"mat4\";\n    if (value?.isTexture) return \"sampler2D\";\n    return \"float\";\n  }\n\n  private applyMaterialProperties(\n    material: any,\n    definition: String3DCustomMaterialDefinition\n  ): void {\n    const props = definition.properties;\n    if (!props) return;\n\n    if (props.transparent !== undefined) {\n      material.transparent = props.transparent;\n    }\n\n    if (props.side !== undefined) {\n      switch (props.side) {\n        case \"front\":\n          material.side = this.THREE.FrontSide;\n          break;\n        case \"back\":\n          material.side = this.THREE.BackSide;\n          break;\n        case \"double\":\n          material.side = this.THREE.DoubleSide;\n          break;\n      }\n    }\n\n    if (props.depthWrite !== undefined) {\n      material.depthWrite = props.depthWrite;\n    }\n\n    if (props.depthTest !== undefined) {\n      material.depthTest = props.depthTest;\n    }\n\n    if (props.blending !== undefined) {\n      switch (props.blending) {\n        case \"additive\":\n          material.blending = this.THREE.AdditiveBlending;\n          break;\n        case \"subtractive\":\n          material.blending = this.THREE.SubtractiveBlending;\n          break;\n        case \"multiply\":\n          material.blending = this.THREE.MultiplyBlending;\n          break;\n        default:\n          material.blending = this.THREE.NormalBlending;\n      }\n    }\n\n    if (props.wireframe !== undefined) {\n      material.wireframe = props.wireframe;\n    }\n  }\n\n  private updateUniforms(\n    material: any,\n    definition: String3DCustomMaterialDefinition,\n    newValues: Record<string, any>\n  ): void {\n    const shader = material.userData?.shader;\n    const customUniforms = material.userData?.customUniforms;\n\n    if (shader?.uniforms) {\n      for (const [key, value] of Object.entries(newValues)) {\n        const uniformDef = definition.uniforms?.[key];\n        if (uniformDef && shader.uniforms[key]) {\n          shader.uniforms[key].value = this.convertUniformValue(uniformDef.type, value);\n        }\n      }\n    } else if (customUniforms) {\n      for (const [key, value] of Object.entries(newValues)) {\n        const uniformDef = definition.uniforms?.[key];\n        if (uniformDef && customUniforms[key]) {\n          customUniforms[key].value = this.convertUniformValue(uniformDef.type, value);\n        }\n      }\n    }\n\n    if (material.uniforms) {\n      for (const [key, value] of Object.entries(newValues)) {\n        const uniformDef = definition.uniforms?.[key];\n        if (uniformDef && material.uniforms[key]) {\n          material.uniforms[key].value = this.convertUniformValue(uniformDef.type, value);\n        }\n      }\n    }\n  }\n\n  private getDefaultVertexShader(): string {\n    return `\n      varying vec2 vUv;\n      varying vec3 vNormal;\n      varying vec3 vPosition;\n\n      void main() {\n        vUv = uv;\n        vNormal = normalize(normalMatrix * normal);\n        vPosition = (modelMatrix * vec4(position, 1.0)).xyz;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n      }\n    `;\n  }\n\n  private getDefaultFragmentShader(): string {\n    return `\n      varying vec2 vUv;\n      varying vec3 vNormal;\n      varying vec3 vPosition;\n\n      void main() {\n        gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n      }\n    `;\n  }\n\n  dispose(): void {\n    this.textureCache.forEach((texture) => texture.dispose());\n    this.textureCache.clear();\n  }\n}\n","import {\r\n  I3DEngine,\r\n  I3DVector3,\r\n  I3DVector2,\r\n  I3DQuaternion,\r\n  I3DEuler,\r\n  I3DMatrix4,\r\n  I3DBox3,\r\n  I3DScene,\r\n  I3DRenderer,\r\n  I3DPerspectiveCamera,\r\n  I3DOrthographicCamera,\r\n  I3DObject,\r\n  I3DMesh,\r\n  I3DGeometry,\r\n  I3DMaterial,\r\n  I3DRenderTarget,\r\n  I3DLight,\r\n  I3DTextureLoader,\r\n  I3DModelLoader,\r\n  ParticleSystemConfig,\r\n  I3DParticleSystem,\r\n} from \"../core/abstractions/I3DEngine\";\r\nimport { I3DEngineProvider } from \"../core/abstractions/I3DEngineProvider\";\r\nimport { IMaterialFactory } from \"../core/materials\";\r\nimport { ThreeJSMaterialFactory } from \"./ThreeJSMaterialFactory\";\r\nimport { FontConverter } from \"../core/text\";\r\n\r\nexport class ThreeJSEngine implements I3DEngine {\r\n  private THREE: any;\r\n  private loaders: Record<string, any>;\r\n  private materialFactory: ThreeJSMaterialFactory | null = null;\r\n  private particleModelCache: Map<string, any> = new Map();\r\n  private particleModelPromiseCache: Map<string, Promise<any>> = new Map();\r\n  private fontCache: Map<string, any> = new Map();\r\n  private fontPromiseCache: Map<string, Promise<any>> = new Map();\r\n  private fontMetricsCache: Map<string, { ascent: number; descent: number }> = new Map();\r\n\r\n  constructor(THREE: any, loaders: Record<string, any> = {}) {\r\n    this.THREE = THREE;\r\n    this.loaders = loaders;\r\n    this.materialFactory = new ThreeJSMaterialFactory(THREE);\r\n  }\r\n\r\n  getMaterialFactory(): IMaterialFactory | null {\r\n    return this.materialFactory;\r\n  }\r\n\r\n  createVector3(x = 0, y = 0, z = 0): I3DVector3 {\r\n    return new this.THREE.Vector3(x, y, z);\r\n  }\r\n\r\n  createVector2(x = 0, y = 0): I3DVector2 {\r\n    return new this.THREE.Vector2(x, y);\r\n  }\r\n\r\n  createQuaternion(x = 0, y = 0, z = 0, w = 1): I3DQuaternion {\r\n    return new this.THREE.Quaternion(x, y, z, w);\r\n  }\r\n\r\n  createEuler(x = 0, y = 0, z = 0, order = \"XYZ\"): I3DEuler {\r\n    return new this.THREE.Euler(x, y, z, order);\r\n  }\r\n\r\n  createMatrix4(): I3DMatrix4 {\r\n    return new this.THREE.Matrix4();\r\n  }\r\n\r\n  createBox3(min?: I3DVector3, max?: I3DVector3): I3DBox3 {\r\n    return new this.THREE.Box3(min, max);\r\n  }\r\n\r\n  createScene(): I3DScene {\r\n    return new this.THREE.Scene();\r\n  }\r\n\r\n  createRenderer(options?: {\r\n    antialias?: boolean;\r\n    alpha?: boolean;\r\n    logarithmicDepthBuffer?: boolean;\r\n  }): I3DRenderer {\r\n    const renderer = new this.THREE.WebGLRenderer(options);\r\n    renderer.outputEncoding = this.THREE.sRGBEncoding;\r\n    return renderer;\r\n  }\r\n\r\n  createPerspectiveCamera(fov = 45, aspect = 1, near = 0.1, far = 2000): I3DPerspectiveCamera {\r\n    return new this.THREE.PerspectiveCamera(fov, aspect, near, far);\r\n  }\r\n\r\n  createOrthographicCamera(\r\n    left: number,\r\n    right: number,\r\n    top: number,\r\n    bottom: number,\r\n    near = 0.1,\r\n    far = 10000\r\n  ): I3DOrthographicCamera {\r\n    return new this.THREE.OrthographicCamera(left, right, top, bottom, near, far);\r\n  }\r\n\r\n  createGroup(): I3DObject {\r\n    return new this.THREE.Group();\r\n  }\r\n\r\n  createMesh(geometry: I3DGeometry, material: I3DMaterial): I3DMesh {\r\n    return new this.THREE.Mesh(geometry, material);\r\n  }\r\n\r\n  createBoxGeometry(width: number, height: number, depth: number): I3DGeometry {\r\n    return new this.THREE.BoxGeometry(width, height, depth);\r\n  }\r\n\r\n  createSphereGeometry(radius: number, widthSegments = 32, heightSegments = 32): I3DGeometry {\r\n    return new this.THREE.SphereGeometry(radius, widthSegments, heightSegments);\r\n  }\r\n\r\n  createPlaneGeometry(width: number, height: number): I3DGeometry {\r\n    return new this.THREE.PlaneGeometry(width, height);\r\n  }\r\n\r\n  createCylinderGeometry(\r\n    radiusTop: number,\r\n    radiusBottom: number,\r\n    height: number,\r\n    segments = 32\r\n  ): I3DGeometry {\r\n    return new this.THREE.CylinderGeometry(radiusTop, radiusBottom, height, segments);\r\n  }\r\n\r\n  createMeshBasicMaterial(params?: any): I3DMaterial {\r\n    return new this.THREE.MeshBasicMaterial(params);\r\n  }\r\n\r\n  createMeshStandardMaterial(params?: any): I3DMaterial {\r\n    return new this.THREE.MeshStandardMaterial(params);\r\n  }\r\n\r\n  createShaderMaterial(params?: any): I3DMaterial {\r\n    return new this.THREE.ShaderMaterial(params);\r\n  }\r\n  createPointLight(color?: string | number, intensity = 1, distance = 0, decay = 2): I3DLight {\r\n    return new this.THREE.PointLight(color, intensity, distance, decay);\r\n  }\r\n\r\n  createSpotLight(\r\n    color?: string | number,\r\n    intensity = 1,\r\n    distance = 0,\r\n    angle = Math.PI / 3,\r\n    penumbra = 0,\r\n    decay = 1\r\n  ): I3DLight {\r\n    return new this.THREE.SpotLight(color, intensity, distance, angle, penumbra, decay);\r\n  }\r\n\r\n  createHemisphereLight(\r\n    skyColor?: string | number,\r\n    groundColor?: string | number,\r\n    intensity = 1\r\n  ): I3DLight {\r\n    return new this.THREE.HemisphereLight(skyColor, groundColor, intensity);\r\n  }\r\n\r\n  createAmbientLight(color?: string | number, intensity = 1): I3DLight {\r\n    return new this.THREE.AmbientLight(color, intensity);\r\n  }\r\n\r\n  createDirectionalLight(color?: string | number, intensity = 1): I3DLight {\r\n    return new this.THREE.DirectionalLight(color, intensity);\r\n  }\r\n\r\n  createTextureLoader(): I3DTextureLoader {\r\n    return new this.THREE.TextureLoader();\r\n  }\r\n\r\n  createModelLoader(type: string): I3DModelLoader {\r\n    const LoaderClass = this.loaders[type];\r\n    if (!LoaderClass) {\r\n      throw new Error(`[ThreeJSEngine] Model loader \"${type}\" not registered`);\r\n    }\r\n    return new LoaderClass();\r\n  }\r\n\r\n  createRenderTarget(width: number, height: number, options: any = {}): I3DRenderTarget {\r\n    const defaults = {\r\n      minFilter: this.THREE.LinearFilter,\r\n      magFilter: this.THREE.LinearFilter,\r\n      format: this.THREE.RGBAFormat,\r\n      depthBuffer: true,\r\n      stencilBuffer: false,\r\n    };\r\n    return new this.THREE.WebGLRenderTarget(width, height, { ...defaults, ...options });\r\n  }\r\n\r\n  loadFont(url: string): Promise<any> {\r\n    const normalized = url.trim();\r\n    if (!normalized || normalized === \"none\") {\r\n      return Promise.resolve(null);\r\n    }\r\n    if (this.fontCache.has(normalized)) {\r\n      return Promise.resolve(this.fontCache.get(normalized));\r\n    }\r\n    const cachedPromise = this.fontPromiseCache.get(normalized);\r\n    if (cachedPromise) return cachedPromise;\r\n\r\n    const isFontFile = FontConverter.isFontFile(normalized);\r\n\r\n    let promise: Promise<any>;\r\n\r\n    if (isFontFile) {\r\n      promise = this.loadFontWithConverter(normalized);\r\n    } else {\r\n      promise = this.loadFontWithLoader(normalized);\r\n    }\r\n\r\n    this.fontPromiseCache.set(normalized, promise);\r\n    return promise;\r\n  }\r\n\r\n  private async loadFontWithConverter(url: string): Promise<any> {\r\n    try {\r\n      const fontData = await FontConverter.load(url);\r\n      const font = this.createFontFromData(fontData);\r\n      this.fontCache.set(url, font);\r\n      return font;\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private loadFontWithLoader(url: string): Promise<any> {\r\n    const LoaderClass = this.loaders.font || this.loaders.FontLoader;\r\n    if (!LoaderClass) {\r\n      return Promise.resolve(null);\r\n    }\r\n\r\n    const loader = new LoaderClass();\r\n    return new Promise<any>((resolve) => {\r\n      loader.load(\r\n        url,\r\n        (font: any) => {\r\n          this.fontCache.set(url, font);\r\n          resolve(font);\r\n        },\r\n        undefined,\r\n        () => {\r\n          resolve(null);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  private createFontFromData(fontData: any): any {\r\n    const LoaderClass = this.loaders.font || this.loaders.FontLoader;\r\n    if (LoaderClass && LoaderClass.utils && LoaderClass.utils.convert) {\r\n      const loader = new LoaderClass();\r\n      if (loader.parse) {\r\n        return loader.parse(fontData);\r\n      }\r\n    }\r\n\r\n    const font = {\r\n      data: fontData,\r\n      isFont: true,\r\n      generateShapes: (text: string, size: number) => {\r\n        return this.generateShapesFromFontData(fontData, text, size, false);\r\n      },\r\n      generateNormalizedShapes: (text: string, size: number) => {\r\n        return this.generateShapesFromFontData(fontData, text, size, true);\r\n      },\r\n    };\r\n    return font;\r\n  }\r\n\r\n  private generateShapesFromFontData(\r\n    fontData: any,\r\n    text: string,\r\n    size: number,\r\n    normalizePosition: boolean = false\r\n  ): any[] {\r\n    const shapes: any[] = [];\r\n    const scale = size / fontData.resolution;\r\n\r\n    const char = text[0];\r\n    if (!char) return shapes;\r\n\r\n    const glyph = fontData.glyphs[char];\r\n    if (!glyph || !glyph.o) return shapes;\r\n\r\n    let xOffset = 0;\r\n    if (normalizePosition) {\r\n      const xMin = this.getOutlineXMin(glyph.o);\r\n      xOffset = -xMin * scale;\r\n    }\r\n\r\n    const charShapes = this.parseOutlineToShapes(glyph.o, scale, xOffset, fontData?.outlineFormat);\r\n    shapes.push(...charShapes);\r\n\r\n    return shapes;\r\n  }\r\n\r\n  private getOutlineXMin(outline: string): number {\r\n    const commands = outline.split(\" \");\r\n    let minX = Infinity;\r\n    let i = 0;\r\n\r\n    while (i < commands.length) {\r\n      const cmd = commands[i];\r\n      switch (cmd) {\r\n        case \"m\":\r\n        case \"l\":\r\n          minX = Math.min(minX, parseFloat(commands[i + 1]) || 0);\r\n          i += 3;\r\n          break;\r\n        case \"q\":\r\n          minX = Math.min(minX, parseFloat(commands[i + 1]) || 0);\r\n          minX = Math.min(minX, parseFloat(commands[i + 3]) || 0);\r\n          i += 5;\r\n          break;\r\n        case \"b\":\r\n          minX = Math.min(minX, parseFloat(commands[i + 1]) || 0);\r\n          minX = Math.min(minX, parseFloat(commands[i + 3]) || 0);\r\n          minX = Math.min(minX, parseFloat(commands[i + 5]) || 0);\r\n          i += 7;\r\n          break;\r\n        default:\r\n          i++;\r\n          break;\r\n      }\r\n    }\r\n\r\n    return minX === Infinity ? 0 : minX;\r\n  }\r\n\r\n  private getOutlineXMax(outline: string): number {\r\n    const commands = outline.split(\" \");\r\n    let maxX = -Infinity;\r\n    let i = 0;\r\n\r\n    while (i < commands.length) {\r\n      const cmd = commands[i];\r\n      switch (cmd) {\r\n        case \"m\":\r\n        case \"l\":\r\n          maxX = Math.max(maxX, parseFloat(commands[i + 1]) || 0);\r\n          i += 3;\r\n          break;\r\n        case \"q\":\r\n          maxX = Math.max(maxX, parseFloat(commands[i + 1]) || 0);\r\n          maxX = Math.max(maxX, parseFloat(commands[i + 3]) || 0);\r\n          i += 5;\r\n          break;\r\n        case \"b\":\r\n          maxX = Math.max(maxX, parseFloat(commands[i + 1]) || 0);\r\n          maxX = Math.max(maxX, parseFloat(commands[i + 3]) || 0);\r\n          maxX = Math.max(maxX, parseFloat(commands[i + 5]) || 0);\r\n          i += 7;\r\n          break;\r\n        default:\r\n          i++;\r\n          break;\r\n      }\r\n    }\r\n\r\n    return maxX === -Infinity ? 0 : maxX;\r\n  }\r\n\r\n  private getOutlineYMin(outline: string): number {\r\n    const commands = outline.split(\" \");\r\n    let minY = Infinity;\r\n    let i = 0;\r\n\r\n    while (i < commands.length) {\r\n      const cmd = commands[i];\r\n      switch (cmd) {\r\n        case \"m\":\r\n        case \"l\":\r\n          minY = Math.min(minY, parseFloat(commands[i + 2]) || 0);\r\n          i += 3;\r\n          break;\r\n        case \"q\":\r\n          minY = Math.min(minY, parseFloat(commands[i + 2]) || 0);\r\n          minY = Math.min(minY, parseFloat(commands[i + 4]) || 0);\r\n          i += 5;\r\n          break;\r\n        case \"b\":\r\n          minY = Math.min(minY, parseFloat(commands[i + 2]) || 0);\r\n          minY = Math.min(minY, parseFloat(commands[i + 4]) || 0);\r\n          minY = Math.min(minY, parseFloat(commands[i + 6]) || 0);\r\n          i += 7;\r\n          break;\r\n        default:\r\n          i++;\r\n          break;\r\n      }\r\n    }\r\n\r\n    return minY === Infinity ? 0 : minY;\r\n  }\r\n\r\n  private pointInPolygon(\r\n    px: number,\r\n    py: number,\r\n    polygon: Array<{ x: number; y: number }>\r\n  ): boolean {\r\n    let inside = false;\r\n    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {\r\n      const xi = polygon[i].x;\r\n      const yi = polygon[i].y;\r\n      const xj = polygon[j].x;\r\n      const yj = polygon[j].y;\r\n\r\n      if (yi > py !== yj > py && px < ((xj - xi) * (py - yi)) / (yj - yi) + xi) {\r\n        inside = !inside;\r\n      }\r\n    }\r\n    return inside;\r\n  }\r\n\r\n  private samplePathPoints(path: any, numSamples: number = 80): Array<{ x: number; y: number }> {\r\n    if (!path?.getPoints) return [];\r\n    return path.getPoints(numSamples).map((p: any) => ({ x: p.x, y: p.y }));\r\n  }\r\n\r\n  private getBoundingBox(points: Array<{ x: number; y: number }>): {\r\n    minX: number;\r\n    maxX: number;\r\n    minY: number;\r\n    maxY: number;\r\n    area: number;\r\n  } {\r\n    if (points.length === 0) {\r\n      return { minX: 0, maxX: 0, minY: 0, maxY: 0, area: 0 };\r\n    }\r\n    let minX = Infinity;\r\n    let maxX = -Infinity;\r\n    let minY = Infinity;\r\n    let maxY = -Infinity;\r\n    for (const p of points) {\r\n      if (p.x < minX) minX = p.x;\r\n      if (p.x > maxX) maxX = p.x;\r\n      if (p.y < minY) minY = p.y;\r\n      if (p.y > maxY) maxY = p.y;\r\n    }\r\n    return { minX, maxX, minY, maxY, area: (maxX - minX) * (maxY - minY) };\r\n  }\r\n\r\n  private getInteriorPoint(points: Array<{ x: number; y: number }>): { x: number; y: number } {\r\n    if (points.length < 3) return points[0] || { x: 0, y: 0 };\r\n    const contour = points.map((p) => new this.THREE.Vector2(p.x, p.y));\r\n    const triangles = this.THREE.ShapeUtils.triangulateShape(contour, []);\r\n    for (const tri of triangles) {\r\n      const a = contour[tri[0]];\r\n      const b = contour[tri[1]];\r\n      const c = contour[tri[2]];\r\n      const cx = (a.x + b.x + c.x) / 3;\r\n      const cy = (a.y + b.y + c.y) / 3;\r\n      if (this.pointInPolygon(cx, cy, points)) {\r\n        return { x: cx, y: cy };\r\n      }\r\n    }\r\n    return points[0];\r\n  }\r\n\r\n  private parseOutlineToShapes(\r\n    outline: string,\r\n    scale: number,\r\n    offsetX: number = 0,\r\n    outlineFormat?: string\r\n  ): any[] {\r\n    if (!outline) return [];\r\n\r\n    const shapePath = new this.THREE.ShapePath();\r\n    const commands = outline.split(\" \");\r\n    let i = 0;\r\n\r\n    while (i < commands.length) {\r\n      const cmd = commands[i];\r\n      switch (cmd) {\r\n        case \"m\":\r\n          {\r\n            const mx = parseFloat(commands[i + 1]) * scale + offsetX;\r\n            const my = -parseFloat(commands[i + 2]) * scale;\r\n            shapePath.moveTo(mx, my);\r\n            i += 3;\r\n          }\r\n          break;\r\n        case \"l\":\r\n          {\r\n            const lx = parseFloat(commands[i + 1]) * scale + offsetX;\r\n            const ly = -parseFloat(commands[i + 2]) * scale;\r\n            shapePath.lineTo(lx, ly);\r\n            i += 3;\r\n          }\r\n          break;\r\n        case \"q\":\r\n          {\r\n            const qx = parseFloat(commands[i + 3]) * scale + offsetX;\r\n            const qy = -parseFloat(commands[i + 4]) * scale;\r\n            shapePath.quadraticCurveTo(\r\n              parseFloat(commands[i + 1]) * scale + offsetX,\r\n              -parseFloat(commands[i + 2]) * scale,\r\n              qx,\r\n              qy\r\n            );\r\n            i += 5;\r\n          }\r\n          break;\r\n        case \"b\":\r\n          {\r\n            const bx = parseFloat(commands[i + 5]) * scale + offsetX;\r\n            const by = -parseFloat(commands[i + 6]) * scale;\r\n            shapePath.bezierCurveTo(\r\n              parseFloat(commands[i + 1]) * scale + offsetX,\r\n              -parseFloat(commands[i + 2]) * scale,\r\n              parseFloat(commands[i + 3]) * scale + offsetX,\r\n              -parseFloat(commands[i + 4]) * scale,\r\n              bx,\r\n              by\r\n            );\r\n            i += 7;\r\n          }\r\n          break;\r\n        case \"z\":\r\n          {\r\n            if (typeof shapePath.closePath === \"function\") {\r\n              shapePath.closePath();\r\n            } else if (\r\n              shapePath.currentPath &&\r\n              typeof shapePath.currentPath.closePath === \"function\"\r\n            ) {\r\n              shapePath.currentPath.closePath();\r\n            }\r\n            i += 1;\r\n          }\r\n          break;\r\n        default:\r\n          i++;\r\n          break;\r\n      }\r\n    }\r\n\r\n    const subPaths = shapePath.subPaths;\r\n    if (!subPaths || subPaths.length === 0) return [];\r\n\r\n    const paths = subPaths.map((sp: any) => {\r\n      const points = sp.getPoints();\r\n      const area = this.THREE.ShapeUtils.area(points);\r\n      const bbox = this.getBoundingBox(points.map((p: any) => ({ x: p.x, y: p.y })));\r\n      return {\r\n        path: sp,\r\n        points,\r\n        area: Math.abs(area),\r\n        signedArea: area,\r\n        bbox,\r\n      };\r\n    });\r\n\r\n    paths.sort((a: any, b: any) => b.area - a.area);\r\n\r\n    const finalShapes: any[] = [];\r\n    const used = new Set<number>();\r\n\r\n    for (let i = 0; i < paths.length; i++) {\r\n      if (used.has(i)) continue;\r\n\r\n      const outerPath = paths[i];\r\n      const shape = new this.THREE.Shape(outerPath.points);\r\n      used.add(i);\r\n\r\n      for (let j = 0; j < paths.length; j++) {\r\n        if (used.has(j) || i === j) continue;\r\n\r\n        const innerPath = paths[j];\r\n\r\n        if (\r\n          innerPath.bbox.minX < outerPath.bbox.minX ||\r\n          innerPath.bbox.maxX > outerPath.bbox.maxX ||\r\n          innerPath.bbox.minY < outerPath.bbox.minY ||\r\n          innerPath.bbox.maxY > outerPath.bbox.maxY\r\n        ) {\r\n          continue;\r\n        }\r\n\r\n        let allPointsInside = true;\r\n        const testPoints = [\r\n          innerPath.points[0],\r\n          innerPath.points[Math.floor(innerPath.points.length / 2)],\r\n        ];\r\n\r\n        for (const testPoint of testPoints) {\r\n          if (\r\n            !testPoint ||\r\n            !this.pointInPolygon(\r\n              testPoint.x,\r\n              testPoint.y,\r\n              outerPath.points.map((p: any) => ({ x: p.x, y: p.y }))\r\n            )\r\n          ) {\r\n            allPointsInside = false;\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (allPointsInside) {\r\n          shape.holes.push(new this.THREE.Path(innerPath.points));\r\n          used.add(j);\r\n        }\r\n      }\r\n\r\n      finalShapes.push(shape);\r\n    }\r\n\r\n    return finalShapes.length > 0 ? finalShapes : shapePath.toShapes(true);\r\n  }\r\n\r\n  private reversePath(path: any): any {\r\n    const newPath = new this.THREE.Path();\r\n    if (!path.curves || path.curves.length === 0) return newPath;\r\n\r\n    const lastCurve = path.curves[path.curves.length - 1];\r\n    const endPoint =\r\n      lastCurve.v2 || lastCurve.v3 || (lastCurve.getPoint ? lastCurve.getPoint(1) : null);\r\n    if (endPoint) {\r\n      newPath.moveTo(endPoint.x, endPoint.y);\r\n    }\r\n\r\n    for (let i = path.curves.length - 1; i >= 0; i--) {\r\n      const curve = path.curves[i];\r\n      if (curve.isLineCurve || curve.type === \"LineCurve\" || curve.type === \"LineCurve3\") {\r\n        newPath.lineTo(curve.v1.x, curve.v1.y);\r\n      } else if (\r\n        curve.isQuadraticBezierCurve ||\r\n        curve.type === \"QuadraticBezierCurve\" ||\r\n        curve.type === \"QuadraticBezierCurve3\"\r\n      ) {\r\n        newPath.quadraticCurveTo(curve.v1.x, curve.v1.y, curve.v0.x, curve.v0.y);\r\n      } else if (\r\n        curve.isCubicBezierCurve ||\r\n        curve.type === \"CubicBezierCurve\" ||\r\n        curve.type === \"CubicBezierCurve3\"\r\n      ) {\r\n        newPath.bezierCurveTo(\r\n          curve.v2.x,\r\n          curve.v2.y,\r\n          curve.v1.x,\r\n          curve.v1.y,\r\n          curve.v0.x,\r\n          curve.v0.y\r\n        );\r\n      }\r\n    }\r\n\r\n    return newPath;\r\n  }\r\n\r\n  createTextGeometry(text: string, font: any, options: any): I3DGeometry | null {\r\n    if (!text || !font) return null;\r\n\r\n    const size = Math.max(0.001, options.size || 16);\r\n    const height = Math.max(0, options.height || 0);\r\n    const lineHeight = Math.max(0.001, options.lineHeight || size * 1.2);\r\n    const letterSpacing = Number.isFinite(options.letterSpacing) ? options.letterSpacing : 0;\r\n    const align = options.align || \"left\";\r\n    const bevelEnabled = !!options.bevelEnabled;\r\n    const bevelThickness = Math.max(0, options.bevelThickness || 0);\r\n    const bevelSize = Math.max(0, options.bevelSize || 0);\r\n    const bevelOffset = options.bevelOffset || 0;\r\n    const bevelSegments = Math.max(0, options.bevelSegments || 0);\r\n    const curveSegments = Math.max(1, Math.round(options.curveSegments || 8));\r\n\r\n    const lines = String(text).split(/\\r?\\n/);\r\n    const shapes: any[] = [];\r\n\r\n    const fontData = font?.data;\r\n    const resolution = fontData?.resolution || 1000;\r\n    if (options.layout && options.layout.length > 0) {\r\n      const fontAscender = fontData?.ascender || resolution * 0.8;\r\n      const fontDescender = fontData?.descender || -resolution * 0.2;\r\n      const fontEmHeight = fontAscender - fontDescender;\r\n      const baselineRatio = fontAscender / fontEmHeight;\r\n\r\n      const elementWidth = options.elementWidth || 0;\r\n      const elementHeight = options.elementHeight || 0;\r\n      const centerOffsetX = 0;\r\n      const centerOffsetY = 0;\r\n\r\n      options.layout.forEach((item: any) => {\r\n        const charShapes = font.generateShapes(item.char, size);\r\n\r\n        const offsetX = item.x + centerOffsetX;\r\n\r\n        const charHeight = item.height || size;\r\n        const baselineFromTop = charHeight * baselineRatio;\r\n        const offsetY = -(item.y + centerOffsetY) - baselineFromTop;\r\n\r\n        charShapes.forEach((shape: any) => {\r\n          let finalShape = this.translateShape(shape, offsetX, offsetY);\r\n          if (item.scale && item.scale !== 1) {\r\n            finalShape = this.scaleShape(finalShape, item.scale);\r\n          }\r\n          shapes.push(finalShape);\r\n        });\r\n      });\r\n    } else {\r\n      lines.forEach((line, index) => {\r\n        const { shapes: lineShapes, width } = this.buildLineShapes(line, font, size, letterSpacing);\r\n        let offsetX = 0;\r\n        if (align === \"center\") {\r\n          offsetX = -width * 0.5;\r\n        } else if (align === \"right\") {\r\n          offsetX = -width;\r\n        }\r\n        const offsetY = -index * lineHeight;\r\n        lineShapes.forEach((shape) => {\r\n          shapes.push(this.translateShape(shape, offsetX, offsetY));\r\n        });\r\n      });\r\n    }\r\n\r\n    if (!shapes.length) {\r\n      return null;\r\n    }\r\n\r\n    const geometry = new this.THREE.ExtrudeGeometry(shapes, {\r\n      depth: height,\r\n      curveSegments,\r\n      bevelEnabled,\r\n      bevelThickness,\r\n      bevelSize,\r\n      bevelOffset,\r\n      bevelSegments,\r\n    });\r\n    geometry.computeBoundingBox();\r\n    return geometry;\r\n  }\r\n\r\n  private buildLineShapes(\r\n    line: string,\r\n    font: any,\r\n    size: number,\r\n    letterSpacing: number\r\n  ): { shapes: any[]; width: number } {\r\n    const shapes: any[] = [];\r\n    let x = 0;\r\n    const chars = Array.from(line);\r\n\r\n    chars.forEach((char, index) => {\r\n      const charShapes = font.generateShapes(char, size);\r\n      charShapes.forEach((shape: any) => {\r\n        const translated = this.translateShape(shape, x, 0);\r\n        shapes.push(translated);\r\n      });\r\n      const advance = this.getGlyphAdvance(font, char, size);\r\n\r\n      x += advance;\r\n      if (letterSpacing !== 0 && index < chars.length - 1) {\r\n        x += letterSpacing;\r\n      }\r\n    });\r\n\r\n    return { shapes, width: x };\r\n  }\r\n\r\n  private getGlyphAdvance(font: any, char: string, size: number): number {\r\n    const data = font?.data;\r\n    const glyphs = data?.glyphs || {};\r\n    const glyph = glyphs[char] || glyphs[char.charCodeAt(0)] || glyphs[\"?\"];\r\n    const ha = glyph?.ha ?? data?.ha;\r\n    const resolution = data?.resolution || 1000;\r\n    if (typeof ha === \"number\") {\r\n      return (ha / resolution) * size;\r\n    }\r\n    return size * 0.5;\r\n  }\r\n\r\n  private translateShape(shape: any, x: number, y: number): any {\r\n    if (!shape || (!x && !y)) return shape;\r\n    if (typeof shape.translate === \"function\") {\r\n      shape.translate(x, y);\r\n      return shape;\r\n    }\r\n    if (typeof shape.applyMatrix4 === \"function\") {\r\n      const matrix = new this.THREE.Matrix4().makeTranslation(x, y, 0);\r\n      shape.applyMatrix4(matrix);\r\n      return shape;\r\n    }\r\n    if (typeof shape.extractPoints === \"function\") {\r\n      const { shape: points, holes } = shape.extractPoints(12);\r\n      const toVec2 = (pt: any) => new this.THREE.Vector2((pt.x || 0) + x, (pt.y || 0) + y);\r\n      const newShape = new this.THREE.Shape(points.map(toVec2));\r\n      if (Array.isArray(holes)) {\r\n        holes.forEach((hole: any[]) => {\r\n          const holePath = new this.THREE.Path();\r\n          holePath.setFromPoints(hole.map(toVec2));\r\n          newShape.holes.push(holePath);\r\n        });\r\n      }\r\n      return newShape;\r\n    }\r\n    return shape;\r\n  }\r\n\r\n  private scaleShape(shape: any, s: number): any {\r\n    if (s === 1) return shape;\r\n    if (typeof shape.scale === \"function\") {\r\n      shape.scale(s, s);\r\n      return shape;\r\n    }\r\n    if (typeof shape.applyMatrix4 === \"function\") {\r\n      const matrix = new this.THREE.Matrix4().makeScale(s, s, 1);\r\n      shape.applyMatrix4(matrix);\r\n      return shape;\r\n    }\r\n\r\n    if (typeof shape.extractPoints === \"function\") {\r\n      const { shape: points, holes } = shape.extractPoints(12);\r\n      const toVec2 = (pt: any) => new this.THREE.Vector2((pt.x || 0) * s, (pt.y || 0) * s);\r\n      const newShape = new this.THREE.Shape(points.map(toVec2));\r\n      if (Array.isArray(holes)) {\r\n        holes.forEach((hole: any[]) => {\r\n          const holePath = new this.THREE.Path();\r\n          holePath.setFromPoints(hole.map(toVec2));\r\n          newShape.holes.push(holePath);\r\n        });\r\n      }\r\n      return newShape;\r\n    }\r\n    return shape;\r\n  }\r\n\r\n  private resolveParticleModelGeometry(\r\n    modelUrl: string,\r\n    loaderType?: string,\r\n    nodeName?: string\r\n  ): Promise<any | null> {\r\n    const url = modelUrl.trim();\r\n    if (!url || url === \"none\") {\r\n      return Promise.resolve(null);\r\n    }\r\n\r\n    const normalizedLoader =\r\n      loaderType && loaderType !== \"none\"\r\n        ? loaderType\r\n        : this.loaders.gltf\r\n        ? \"gltf\"\r\n        : Object.keys(this.loaders)[0];\r\n    if (!normalizedLoader) {\r\n      return Promise.resolve(null);\r\n    }\r\n\r\n    const nodeKey = (nodeName || \"\").trim();\r\n    const cacheKey = `${normalizedLoader}|${url}|${nodeKey}`;\r\n    if (this.particleModelCache.has(cacheKey)) {\r\n      return Promise.resolve(this.particleModelCache.get(cacheKey));\r\n    }\r\n    const cachedPromise = this.particleModelPromiseCache.get(cacheKey);\r\n    if (cachedPromise) {\r\n      return cachedPromise;\r\n    }\r\n\r\n    const promise = new Promise<any | null>((resolve) => {\r\n      let loader: I3DModelLoader | null = null;\r\n      try {\r\n        loader = this.createModelLoader(normalizedLoader);\r\n      } catch (error) {\r\n        resolve(null);\r\n        return;\r\n      }\r\n\r\n      loader.load(\r\n        url,\r\n        (gltf: any) => {\r\n          const root = gltf?.scene || gltf?.object || gltf;\r\n          if (!root) {\r\n            resolve(null);\r\n            return;\r\n          }\r\n          let mesh: any = null;\r\n          if (nodeKey) {\r\n            if (root.getObjectByName) {\r\n              const found = root.getObjectByName(nodeKey);\r\n              if (found?.isMesh) mesh = found;\r\n            }\r\n            if (!mesh && root.traverse) {\r\n              root.traverse((child: any) => {\r\n                if (mesh) return;\r\n                if (child?.isMesh && child?.name === nodeKey) {\r\n                  mesh = child;\r\n                }\r\n              });\r\n            }\r\n          }\r\n          if (!mesh) {\r\n            if (root.isMesh) {\r\n              mesh = root;\r\n            } else if (root.traverse) {\r\n              root.traverse((child: any) => {\r\n                if (!mesh && child?.isMesh) {\r\n                  mesh = child;\r\n                }\r\n              });\r\n            }\r\n          }\r\n\r\n          const geometry = mesh?.geometry || null;\r\n          if (!geometry) {\r\n            resolve(null);\r\n            return;\r\n          }\r\n          this.particleModelCache.set(cacheKey, geometry);\r\n          resolve(geometry);\r\n        },\r\n        undefined,\r\n        () => {\r\n          resolve(null);\r\n        }\r\n      );\r\n    });\r\n\r\n    this.particleModelPromiseCache.set(cacheKey, promise);\r\n    return promise;\r\n  }\r\n\r\n  createParticleSystem(config: ParticleSystemConfig): I3DParticleSystem {\r\n    const THREE = this.THREE;\r\n    const engine = this;\r\n\r\n    const makeRng = (seed: number) => {\r\n      let s = Math.max(1, seed | 0);\r\n      return () => {\r\n        s ^= s << 13;\r\n        s ^= s >> 17;\r\n        s ^= s << 5;\r\n        return ((s >>> 0) % 100000) / 100000;\r\n      };\r\n    };\r\n\r\n    class ParticleSystem extends THREE.Object3D {\r\n      private cfg: ParticleSystemConfig;\r\n      private rng = makeRng(config.seed);\r\n      private points: any = null;\r\n      private instanced: any = null;\r\n      private positions: Float32Array = new Float32Array(0);\r\n      private velocities: Float32Array = new Float32Array(0);\r\n      private life: Float32Array = new Float32Array(0);\r\n      private colors: Float32Array = new Float32Array(0);\r\n      private sizeFactors: Float32Array = new Float32Array(0);\r\n      private alive = 0;\r\n      private emitRemainder = 0;\r\n      private pendingBurst = 0;\r\n      private basePositions: Float32Array = new Float32Array(0);\r\n      private baseScales: Float32Array = new Float32Array(0);\r\n      private baseJitter: Float32Array = new Float32Array(0);\r\n      private basePhase: Float32Array = new Float32Array(0);\r\n      private elapsed = 0;\r\n      private modelGeometry: any = null;\r\n      private modelKey = \"\";\r\n      private instancedUsesSharedGeometry = false;\r\n      private distributionGeometry: any = null;\r\n      private distributionKey = \"\";\r\n      private materialOverride: any = null;\r\n      private materialOverrideForPoints: any = null;\r\n      private defaultEmitterMaterial: any = null;\r\n      private defaultInstancedMaterial: any = null;\r\n      private transitionStartTime = 0;\r\n      private transitionDuration = 0;\r\n      private isTransitioning = false;\r\n      private transitionFromPositions: Float32Array = new Float32Array(0);\r\n      private transitionToPositions: Float32Array = new Float32Array(0);\r\n      private pendingTransition = false;\r\n      private pendingTransitionKey = \"\";\r\n      private pendingDistributionLoad = false;\r\n\r\n      constructor(cfg: ParticleSystemConfig) {\r\n        super();\r\n        this.cfg = { ...cfg };\r\n        this.refreshModelGeometry();\r\n        this.rebuild();\r\n      }\r\n\r\n      setConfig(config: ParticleSystemConfig): void {\r\n        const prev = this.cfg;\r\n        this.cfg = { ...config };\r\n        const emitterReset =\r\n          this.cfg.mode === \"emitter\" &&\r\n          (prev.emitRate !== this.cfg.emitRate ||\r\n            prev.emitBurst !== this.cfg.emitBurst ||\r\n            prev.particleLife !== this.cfg.particleLife ||\r\n            prev.particleSpeed !== this.cfg.particleSpeed ||\r\n            !this.isVec3Equal(prev.particleDirection, this.cfg.particleDirection) ||\r\n            !this.isVec3Equal(prev.particleGravity, this.cfg.particleGravity) ||\r\n            prev.particleDrag !== this.cfg.particleDrag ||\r\n            prev.particleSizeVariation !== this.cfg.particleSizeVariation ||\r\n            prev.particleColorVariation !== this.cfg.particleColorVariation ||\r\n            prev.color !== this.cfg.color);\r\n        const needsRebuild =\r\n          prev.mode !== this.cfg.mode ||\r\n          prev.count !== this.cfg.count ||\r\n          prev.seed !== this.cfg.seed ||\r\n          prev.spread !== this.cfg.spread ||\r\n          prev.particleShape !== this.cfg.particleShape ||\r\n          prev.particleModelUrl !== this.cfg.particleModelUrl ||\r\n          prev.particleModelLoader !== this.cfg.particleModelLoader ||\r\n          prev.particleModelNode !== this.cfg.particleModelNode ||\r\n          prev.instanceShape !== this.cfg.instanceShape ||\r\n          prev.instanceModelUrl !== this.cfg.instanceModelUrl ||\r\n          prev.instanceModelLoader !== this.cfg.instanceModelLoader ||\r\n          prev.instanceModelNode !== this.cfg.instanceModelNode ||\r\n          prev.instanceScale !== this.cfg.instanceScale ||\r\n          prev.instanceScaleVariation !== this.cfg.instanceScaleVariation;\r\n        if (needsRebuild) {\r\n          const isParticleModelChange =\r\n            this.cfg.mode === \"instanced\" &&\r\n            this.instanced &&\r\n            this.cfg.modelTransitionDuration > 0 &&\r\n            (prev.particleModelUrl !== this.cfg.particleModelUrl ||\r\n              prev.particleModelLoader !== this.cfg.particleModelLoader ||\r\n              prev.particleModelNode !== this.cfg.particleModelNode ||\r\n              prev.particleShape !== this.cfg.particleShape);\r\n\r\n          const isInstanceModelChange =\r\n            this.cfg.mode === \"instanced\" &&\r\n            this.instanced &&\r\n            this.cfg.modelTransitionDuration > 0 &&\r\n            (prev.instanceModelUrl !== this.cfg.instanceModelUrl ||\r\n              prev.instanceModelLoader !== this.cfg.instanceModelLoader ||\r\n              prev.instanceModelNode !== this.cfg.instanceModelNode ||\r\n              prev.instanceShape !== this.cfg.instanceShape);\r\n\r\n          if (isParticleModelChange || isInstanceModelChange) {\r\n            this.startModelTransition();\r\n          } else {\r\n            this.refreshModelGeometry();\r\n            this.refreshDistributionGeometry();\r\n            this.rebuild();\r\n          }\r\n          return;\r\n        }\r\n        if (emitterReset) {\r\n          this.resetEmitter();\r\n        }\r\n        if (this.points) {\r\n          const uniforms = this.points.material.uniforms;\r\n          if (uniforms) {\r\n            if (uniforms.uOpacity) {\r\n              uniforms.uOpacity.value = this.cfg.opacity;\r\n            }\r\n            if (uniforms.uSize) {\r\n              uniforms.uSize.value = this.cfg.size;\r\n            }\r\n            if (uniforms.uSizeVar) {\r\n              uniforms.uSizeVar.value = this.cfg.particleSizeVariation;\r\n            }\r\n            if (uniforms.uPointSize) {\r\n              uniforms.uPointSize.value = this.cfg.size;\r\n            }\r\n          }\r\n        }\r\n        if (this.instanced) {\r\n          this.instanced.material.opacity = this.cfg.opacity;\r\n          this.instanced.material.color = new THREE.Color(this.cfg.color);\r\n        }\r\n        this.pendingBurst = this.cfg.emitBurst;\r\n      }\r\n\r\n      private startModelTransition(): void {\r\n        this.transitionFromPositions = new Float32Array(this.basePositions);\r\n        this.transitionDuration = this.cfg.modelTransitionDuration;\r\n\r\n        const url = this.cfg.instanceModelUrl?.trim();\r\n        const key = `${this.cfg.instanceModelLoader}|${url}|${this.cfg.instanceModelNode}`;\r\n        this.pendingTransition = true;\r\n        this.pendingTransitionKey = key;\r\n\r\n        this.refreshModelGeometry();\r\n        this.refreshDistributionGeometryForTransition();\r\n      }\r\n\r\n      private refreshDistributionGeometryForTransition(): void {\r\n        if (this.cfg.instanceShape !== \"model\") {\r\n          this.startMorphTransition();\r\n          return;\r\n        }\r\n        const url = this.cfg.instanceModelUrl?.trim();\r\n        if (!url || url === \"none\") {\r\n          this.startMorphTransition();\r\n          return;\r\n        }\r\n        const key = `${this.cfg.instanceModelLoader}|${url}|${this.cfg.instanceModelNode}`;\r\n\r\n        if (this.distributionKey === key && this.distributionGeometry) {\r\n          this.startMorphTransition();\r\n          return;\r\n        }\r\n\r\n        this.distributionKey = key;\r\n        engine\r\n          .resolveParticleModelGeometry(\r\n            url,\r\n            this.cfg.instanceModelLoader,\r\n            this.cfg.instanceModelNode\r\n          )\r\n          .then((geometry) => {\r\n            if (!geometry) return;\r\n            if (this.distributionKey !== key) return;\r\n            if (!this.pendingTransition || this.pendingTransitionKey !== key) return;\r\n\r\n            this.distributionGeometry = geometry;\r\n            this.startMorphTransition();\r\n          });\r\n      }\r\n\r\n      private startMorphTransition(): void {\r\n        this.pendingTransition = false;\r\n        this.pendingTransitionKey = \"\";\r\n\r\n        const count = Math.max(1, this.cfg.count);\r\n        this.transitionToPositions = new Float32Array(count * 3);\r\n\r\n        const useModel = this.cfg.instanceShape === \"model\" && this.distributionGeometry;\r\n        if (useModel) {\r\n          this.fillFromModelToArray(count, this.distributionGeometry, this.transitionToPositions);\r\n        } else {\r\n          for (let i = 0; i < count; i += 1) {\r\n            const pos =\r\n              this.cfg.instanceShape === \"box\"\r\n                ? this.randomInBox(this.cfg.spread)\r\n                : this.randomInSphere(this.cfg.spread);\r\n            this.transitionToPositions.set(pos, i * 3);\r\n          }\r\n        }\r\n\r\n        this.transitionStartTime = this.elapsed;\r\n        this.isTransitioning = true;\r\n      }\r\n\r\n      private cleanupOutgoing(): void {\r\n        this.isTransitioning = false;\r\n        this.pendingTransition = false;\r\n        this.pendingTransitionKey = \"\";\r\n        this.transitionFromPositions = new Float32Array(0);\r\n        this.transitionToPositions = new Float32Array(0);\r\n      }\r\n\r\n      private updateTransition(): void {\r\n        if (!this.isTransitioning) return;\r\n\r\n        const elapsed = this.elapsed - this.transitionStartTime;\r\n        const progress = Math.min(1, elapsed / this.transitionDuration);\r\n\r\n        const eased =\r\n          progress < 0.5 ? 2 * progress * progress : 1 - Math.pow(-2 * progress + 2, 2) / 2;\r\n\r\n        const count = Math.min(\r\n          this.transitionFromPositions.length / 3,\r\n          this.transitionToPositions.length / 3,\r\n          this.basePositions.length / 3\r\n        );\r\n\r\n        for (let i = 0; i < count; i += 1) {\r\n          const i3 = i * 3;\r\n          this.basePositions[i3] =\r\n            this.transitionFromPositions[i3] +\r\n            (this.transitionToPositions[i3] - this.transitionFromPositions[i3]) * eased;\r\n          this.basePositions[i3 + 1] =\r\n            this.transitionFromPositions[i3 + 1] +\r\n            (this.transitionToPositions[i3 + 1] - this.transitionFromPositions[i3 + 1]) * eased;\r\n          this.basePositions[i3 + 2] =\r\n            this.transitionFromPositions[i3 + 2] +\r\n            (this.transitionToPositions[i3 + 2] - this.transitionFromPositions[i3 + 2]) * eased;\r\n        }\r\n\r\n        if (progress >= 1) {\r\n          for (let i = 0; i < count * 3; i += 1) {\r\n            this.basePositions[i] = this.transitionToPositions[i];\r\n          }\r\n          this.cleanupOutgoing();\r\n        }\r\n      }\r\n\r\n      private fillFromModelToArray(count: number, geometry: any, targetArray: Float32Array): void {\r\n        const attr = geometry?.attributes?.position;\r\n        if (!attr?.array || attr.itemSize < 3) {\r\n          for (let i = 0; i < count; i += 1) {\r\n            const pos = this.randomInSphere(this.cfg.spread);\r\n            targetArray.set(pos, i * 3);\r\n          }\r\n          return;\r\n        }\r\n\r\n        const array = attr.array as ArrayLike<number>;\r\n        const itemSize = attr.itemSize;\r\n        const vertexCount = Math.floor(array.length / itemSize);\r\n        if (vertexCount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const indexArray = geometry?.index?.array as ArrayLike<number> | undefined;\r\n        const triangleCount = indexArray\r\n          ? Math.floor(indexArray.length / 3)\r\n          : Math.floor(vertexCount / 3);\r\n        if (triangleCount <= 0) {\r\n          return;\r\n        }\r\n\r\n        let minX = Infinity;\r\n        let minY = Infinity;\r\n        let minZ = Infinity;\r\n        let maxX = -Infinity;\r\n        let maxY = -Infinity;\r\n        let maxZ = -Infinity;\r\n        for (let i = 0; i < vertexCount; i += 1) {\r\n          const idx = i * itemSize;\r\n          const x = array[idx];\r\n          const y = array[idx + 1];\r\n          const z = array[idx + 2];\r\n          minX = Math.min(minX, x);\r\n          minY = Math.min(minY, y);\r\n          minZ = Math.min(minZ, z);\r\n          maxX = Math.max(maxX, x);\r\n          maxY = Math.max(maxY, y);\r\n          maxZ = Math.max(maxZ, z);\r\n        }\r\n        const sizeX = Math.max(1e-6, maxX - minX);\r\n        const sizeY = Math.max(1e-6, maxY - minY);\r\n        const sizeZ = Math.max(1e-6, maxZ - minZ);\r\n        const targetX = (this.cfg.spreadX > 0 ? this.cfg.spreadX : this.cfg.spread) * 2;\r\n        const targetY = (this.cfg.spreadY > 0 ? this.cfg.spreadY : this.cfg.spread) * 2;\r\n        const scaleX = targetX > 0 ? targetX / sizeX : 1;\r\n        const scaleY = targetY > 0 ? targetY / sizeY : 1;\r\n        const scale = Math.min(scaleX, scaleY);\r\n        const centerX = (minX + maxX) * 0.5;\r\n        const centerY = (minY + maxY) * 0.5;\r\n        const centerZ = (minZ + maxZ) * 0.5;\r\n\r\n        const cumulativeAreas = new Float32Array(triangleCount);\r\n        let totalArea = 0;\r\n        for (let i = 0; i < triangleCount; i += 1) {\r\n          const base = i * 3;\r\n          const ia = indexArray ? indexArray[base] : base;\r\n          const ib = indexArray ? indexArray[base + 1] : base + 1;\r\n          const ic = indexArray ? indexArray[base + 2] : base + 2;\r\n          const a = ia * itemSize;\r\n          const b = ib * itemSize;\r\n          const c = ic * itemSize;\r\n          const ax = array[a];\r\n          const ay = array[a + 1];\r\n          const az = array[a + 2];\r\n          const bx = array[b];\r\n          const by = array[b + 1];\r\n          const bz = array[b + 2];\r\n          const cx = array[c];\r\n          const cy = array[c + 1];\r\n          const cz = array[c + 2];\r\n          const abx = bx - ax;\r\n          const aby = by - ay;\r\n          const abz = bz - az;\r\n          const acx = cx - ax;\r\n          const acy = cy - ay;\r\n          const acz = cz - az;\r\n          const crossX = aby * acz - abz * acy;\r\n          const crossY = abz * acx - abx * acz;\r\n          const crossZ = abx * acy - aby * acx;\r\n          const area = Math.sqrt(crossX * crossX + crossY * crossY + crossZ * crossZ) * 0.5;\r\n          totalArea += area;\r\n          cumulativeAreas[i] = totalArea;\r\n        }\r\n        if (totalArea <= 0) {\r\n          for (let i = 0; i < count; i += 1) {\r\n            const pos = this.randomInSphere(this.cfg.spread);\r\n            targetArray.set(pos, i * 3);\r\n          }\r\n          return;\r\n        }\r\n\r\n        for (let i = 0; i < count; i += 1) {\r\n          const r = this.rng() * totalArea;\r\n          let lo = 0;\r\n          let hi = triangleCount - 1;\r\n          while (lo < hi) {\r\n            const mid = Math.floor((lo + hi) / 2);\r\n            if (r <= cumulativeAreas[mid]) {\r\n              hi = mid;\r\n            } else {\r\n              lo = mid + 1;\r\n            }\r\n          }\r\n          const base = lo * 3;\r\n          const ia = indexArray ? indexArray[base] : base;\r\n          const ib = indexArray ? indexArray[base + 1] : base + 1;\r\n          const ic = indexArray ? indexArray[base + 2] : base + 2;\r\n          const a = ia * itemSize;\r\n          const b = ib * itemSize;\r\n          const c = ic * itemSize;\r\n          const ax = array[a];\r\n          const ay = array[a + 1];\r\n          const az = array[a + 2];\r\n          const bx = array[b];\r\n          const by = array[b + 1];\r\n          const bz = array[b + 2];\r\n          const cx = array[c];\r\n          const cy = array[c + 1];\r\n          const cz = array[c + 2];\r\n          const u = this.rng();\r\n          const v = this.rng();\r\n          const su = Math.sqrt(u);\r\n          const w1 = 1 - su;\r\n          const w2 = su * (1 - v);\r\n          const w3 = su * v;\r\n          const x = (ax * w1 + bx * w2 + cx * w3 - centerX) * scale;\r\n          const y = (ay * w1 + by * w2 + cy * w3 - centerY) * scale;\r\n          const z = (az * w1 + bz * w2 + cz * w3 - centerZ) * scale;\r\n          targetArray[i * 3] = x;\r\n          targetArray[i * 3 + 1] = y;\r\n          targetArray[i * 3 + 2] = z;\r\n        }\r\n      }\r\n\r\n      update(dt: number): void {\r\n        if (dt <= 0) return;\r\n        this.elapsed += dt;\r\n\r\n        this.updateTransition();\r\n\r\n        if (this.cfg.mode === \"emitter\") {\r\n          this.updateEmitter(dt);\r\n        } else {\r\n          this.updateInstanced(this.elapsed);\r\n        }\r\n      }\r\n\r\n      dispose(): void {\r\n        this.cleanupOutgoing();\r\n        if (this.points) {\r\n          this.points.geometry.dispose();\r\n          this.points.material.dispose();\r\n        }\r\n        if (this.instanced) {\r\n          if (!this.instancedUsesSharedGeometry) {\r\n            this.instanced.geometry.dispose();\r\n          }\r\n          this.instanced.material.dispose();\r\n        }\r\n      }\r\n\r\n      private rebuild(): void {\r\n        if (this.points) {\r\n          this.remove(this.points);\r\n          this.points.geometry.dispose();\r\n          this.points.material.dispose();\r\n          this.points = null;\r\n        }\r\n        if (this.instanced) {\r\n          this.remove(this.instanced);\r\n          if (!this.instancedUsesSharedGeometry) {\r\n            this.instanced.geometry.dispose();\r\n          }\r\n          this.instanced.material.dispose();\r\n          this.instanced = null;\r\n        }\r\n        this.elapsed = 0;\r\n\r\n        if (this.cfg.mode === \"emitter\") {\r\n          this.buildEmitter();\r\n        } else {\r\n          const needsModel = this.cfg.instanceShape === \"model\";\r\n          const hasModel = this.distributionGeometry !== null;\r\n          if (needsModel && !hasModel) {\r\n            this.pendingDistributionLoad = true;\r\n            this.refreshDistributionGeometry();\r\n            return;\r\n          }\r\n          this.pendingDistributionLoad = false;\r\n          this.refreshDistributionGeometry();\r\n          this.buildInstanced();\r\n        }\r\n        this.applyMaterialOverrides();\r\n      }\r\n\r\n      private buildEmitter(): void {\r\n        const count = Math.max(1, this.cfg.count);\r\n        this.positions = new Float32Array(count * 3);\r\n        this.velocities = new Float32Array(count * 3);\r\n        this.life = new Float32Array(count);\r\n        this.colors = new Float32Array(count * 3);\r\n        this.sizeFactors = new Float32Array(count);\r\n        const hide = 1e6;\r\n        for (let i = 0; i < count; i += 1) {\r\n          const i3 = i * 3;\r\n          this.positions[i3] = hide;\r\n          this.positions[i3 + 1] = hide;\r\n          this.positions[i3 + 2] = hide;\r\n        }\r\n        this.alive = 0;\r\n        this.emitRemainder = 0;\r\n        this.pendingBurst = this.cfg.emitBurst;\r\n\r\n        const geometry = new THREE.BufferGeometry();\r\n        geometry.setAttribute(\"position\", new THREE.BufferAttribute(this.positions, 3));\r\n        geometry.setAttribute(\"color\", new THREE.BufferAttribute(this.colors, 3));\r\n        geometry.setAttribute(\"sizeFactor\", new THREE.BufferAttribute(this.sizeFactors, 1));\r\n        const material = new THREE.ShaderMaterial({\r\n          transparent: this.cfg.opacity < 1,\r\n          depthWrite: false,\r\n          uniforms: {\r\n            uOpacity: { value: this.cfg.opacity },\r\n            uSize: { value: this.cfg.size },\r\n            uSizeVar: { value: this.cfg.particleSizeVariation },\r\n          },\r\n          vertexShader: `\r\n            attribute vec3 color;\r\n            attribute float sizeFactor;\r\n            varying vec3 vColor;\r\n            uniform float uSize;\r\n            uniform float uSizeVar;\r\n            void main() {\r\n              vColor = color;\r\n              float size = uSize * mix(1.0 - uSizeVar, 1.0, sizeFactor);\r\n              gl_PointSize = size;\r\n              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n            }\r\n          `,\r\n          fragmentShader: `\r\n            varying vec3 vColor;\r\n            uniform float uOpacity;\r\n            void main() {\r\n              float dist = length(gl_PointCoord - vec2(0.5));\r\n              if (dist > 0.5) discard;\r\n              gl_FragColor = vec4(vColor, uOpacity);\r\n            }\r\n          `,\r\n        });\r\n        this.points = new THREE.Points(geometry, material);\r\n        this.defaultEmitterMaterial = material;\r\n        this.add(this.points);\r\n      }\r\n\r\n      private buildInstanced(): void {\r\n        const count = Math.max(1, this.cfg.count);\r\n        const useSharedGeometry = this.cfg.particleShape === \"model\" && this.modelGeometry;\r\n        const geometry =\r\n          this.cfg.particleShape === \"model\" && this.modelGeometry\r\n            ? this.modelGeometry\r\n            : this.cfg.particleShape === \"box\"\r\n            ? new THREE.BoxGeometry(1, 1, 1)\r\n            : new THREE.SphereGeometry(0.5, 8, 8);\r\n        this.instancedUsesSharedGeometry = useSharedGeometry;\r\n        const material = new THREE.MeshStandardMaterial({\r\n          color: new THREE.Color(this.cfg.color),\r\n          transparent: this.cfg.opacity < 1,\r\n          opacity: this.cfg.opacity,\r\n        });\r\n        this.defaultInstancedMaterial = material;\r\n        this.instanced = new THREE.InstancedMesh(geometry, material, count);\r\n        this.basePositions = new Float32Array(count * 3);\r\n        this.baseScales = new Float32Array(count);\r\n        this.baseJitter = new Float32Array(count * 3);\r\n        this.basePhase = new Float32Array(count);\r\n        this.fillBasePositions(count);\r\n        this.applyInstancedTransforms(0);\r\n        this.add(this.instanced);\r\n      }\r\n\r\n      setMaterial(\r\n        material: any | null,\r\n        options: { points?: boolean; meshes?: boolean } = {}\r\n      ): void {\r\n        const setPoints = options.points ?? true;\r\n        const setMeshes = options.meshes ?? true;\r\n        if (setMeshes) {\r\n          this.materialOverride = material;\r\n        }\r\n        if (setPoints) {\r\n          this.materialOverrideForPoints = material;\r\n        }\r\n        this.applyMaterialOverrides();\r\n      }\r\n\r\n      private updateEmitter(dt: number): void {\r\n        const count = this.cfg.count;\r\n        const dir = this.normalize(this.cfg.particleDirection);\r\n        const gravity = this.cfg.particleGravity;\r\n        const drag = Math.max(0, Math.min(1, this.cfg.particleDrag));\r\n        const emitRate = this.cfg.emitRate;\r\n        const totalToEmit = emitRate * dt + this.emitRemainder;\r\n        const emitCount = Math.floor(totalToEmit);\r\n        this.emitRemainder = totalToEmit - emitCount;\r\n        let colorDirty = false;\r\n        const hide = 1e6;\r\n\r\n        for (let i = 0; i < emitCount; i += 1) {\r\n          this.spawnParticle(dir);\r\n        }\r\n        while (this.pendingBurst > 0) {\r\n          this.spawnParticle(dir);\r\n          this.pendingBurst -= 1;\r\n        }\r\n\r\n        for (let i = 0; i < count; i += 1) {\r\n          if (this.life[i] <= 0) continue;\r\n          this.life[i] -= dt;\r\n          if (this.life[i] <= 0) {\r\n            this.life[i] = 0;\r\n            const i3 = i * 3;\r\n            this.positions[i3] = hide;\r\n            this.positions[i3 + 1] = hide;\r\n            this.positions[i3 + 2] = hide;\r\n            this.colors[i3] = 0;\r\n            this.colors[i3 + 1] = 0;\r\n            this.colors[i3 + 2] = 0;\r\n            colorDirty = true;\r\n            continue;\r\n          }\r\n          const idx = i * 3;\r\n          this.velocities[idx] += gravity[0] * dt;\r\n          this.velocities[idx + 1] += gravity[1] * dt;\r\n          this.velocities[idx + 2] += gravity[2] * dt;\r\n          this.velocities[idx] *= 1 - drag * dt;\r\n          this.velocities[idx + 1] *= 1 - drag * dt;\r\n          this.velocities[idx + 2] *= 1 - drag * dt;\r\n          this.positions[idx] += this.velocities[idx] * dt;\r\n          this.positions[idx + 1] += this.velocities[idx + 1] * dt;\r\n          this.positions[idx + 2] += this.velocities[idx + 2] * dt;\r\n        }\r\n\r\n        if (this.points) {\r\n          this.points.geometry.attributes.position.needsUpdate = true;\r\n          if (colorDirty) {\r\n            this.points.geometry.attributes.color.needsUpdate = true;\r\n          }\r\n        }\r\n      }\r\n\r\n      private spawnParticle(dir: [number, number, number]): void {\r\n        const count = this.cfg.count;\r\n        let idx = -1;\r\n        for (let i = 0; i < count; i += 1) {\r\n          if (this.life[i] <= 0) {\r\n            idx = i;\r\n            break;\r\n          }\r\n        }\r\n        if (idx === -1) return;\r\n\r\n        const pos = this.randomInSphere(this.cfg.spread);\r\n        const speed =\r\n          this.cfg.particleSpeed *\r\n          (1 - this.cfg.particleSizeVariation + this.rng() * this.cfg.particleSizeVariation);\r\n        const vel = [\r\n          dir[0] * speed + (this.rng() - 0.5) * speed * 0.2,\r\n          dir[1] * speed + (this.rng() - 0.5) * speed * 0.2,\r\n          dir[2] * speed + (this.rng() - 0.5) * speed * 0.2,\r\n        ];\r\n\r\n        const i3 = idx * 3;\r\n        this.positions.set(pos, i3);\r\n        this.velocities.set(vel, i3);\r\n        this.life[idx] = this.cfg.particleLife;\r\n        this.sizeFactors[idx] = this.rng();\r\n\r\n        const color = new THREE.Color(this.cfg.color);\r\n        if (this.cfg.particleColorVariation > 0) {\r\n          color.offsetHSL((this.rng() - 0.5) * this.cfg.particleColorVariation, 0, 0);\r\n        }\r\n        this.colors[i3] = color.r;\r\n        this.colors[i3 + 1] = color.g;\r\n        this.colors[i3 + 2] = color.b;\r\n        if (this.points) {\r\n          this.points.geometry.attributes.color.needsUpdate = true;\r\n          this.points.geometry.attributes.sizeFactor.needsUpdate = true;\r\n        }\r\n      }\r\n\r\n      private updateInstanced(time: number): void {\r\n        this.applyInstancedTransforms(time);\r\n        if (this.instanced) {\r\n          this.instanced.instanceMatrix.needsUpdate = true;\r\n        }\r\n      }\r\n\r\n      private applyInstancedTransforms(time: number): void {\r\n        if (!this.instanced) return;\r\n        const count = this.cfg.count;\r\n        const jitter = this.cfg.instanceJitter;\r\n        const flow = this.cfg.instanceFlow;\r\n        const disperse = Math.max(0, this.cfg.instanceDisperse);\r\n        const scatter = Math.max(0, this.cfg.instanceDisperseScatter);\r\n        const scatterX =\r\n          this.cfg.instanceDisperseScatterX > 0 ? this.cfg.instanceDisperseScatterX : scatter;\r\n        const scatterY =\r\n          this.cfg.instanceDisperseScatterY > 0 ? this.cfg.instanceDisperseScatterY : scatter;\r\n        const scatterZ =\r\n          this.cfg.instanceDisperseScatterZ > 0 ? this.cfg.instanceDisperseScatterZ : scatter;\r\n        const rotSpeed = this.cfg.instanceRotationSpeed;\r\n        const temp = new THREE.Object3D();\r\n        for (let i = 0; i < count; i += 1) {\r\n          const i3 = i * 3;\r\n          const baseX = this.basePositions[i3];\r\n          const baseY = this.basePositions[i3 + 1];\r\n          const baseZ = this.basePositions[i3 + 2];\r\n          const phase = this.basePhase[i];\r\n          const driftX = Math.sin((baseY + time * 1.4) * 0.7 + phase) * flow * this.cfg.spread;\r\n          const driftY = Math.cos((baseX - time * 1.1) * 0.6 + phase) * flow * this.cfg.spread;\r\n          const driftZ = Math.sin((baseZ + time * 1.2) * 0.8 + phase) * flow * this.cfg.spread;\r\n          const jitterX = Math.sin(time * 2.1 + phase + this.baseJitter[i3] * 2.5) * jitter;\r\n          const jitterY = Math.cos(time * 1.7 + phase + this.baseJitter[i3 + 1] * 2.5) * jitter;\r\n          const jitterZ = Math.sin(time * 1.9 + phase + this.baseJitter[i3 + 2] * 2.5) * jitter;\r\n          const dispersal = 1 + disperse;\r\n          const dirX = this.baseJitter[i3];\r\n          const dirY = this.baseJitter[i3 + 1];\r\n          const dirZ = this.baseJitter[i3 + 2];\r\n          const dirLen = Math.sqrt(dirX * dirX + dirY * dirY + dirZ * dirZ) || 1;\r\n          const scatterScale = disperse * this.cfg.spread;\r\n          const scatterOffsetX = (dirX / dirLen) * scatterX * scatterScale;\r\n          const scatterOffsetY = (dirY / dirLen) * scatterY * scatterScale;\r\n          const scatterOffsetZ = (dirZ / dirLen) * scatterZ * scatterScale;\r\n          temp.position.set(\r\n            baseX * dispersal + scatterOffsetX + driftX + jitterX,\r\n            baseY * dispersal + scatterOffsetY + driftY + jitterY,\r\n            baseZ * dispersal + scatterOffsetZ + driftZ + jitterZ\r\n          );\r\n          temp.rotation.set(\r\n            this.baseJitter[i3] * 0.5,\r\n            time * rotSpeed + i * 0.1,\r\n            this.baseJitter[i3 + 2] * 0.5\r\n          );\r\n          const scale = this.baseScales[i] * this.cfg.size;\r\n          temp.scale.set(scale, scale, scale);\r\n          temp.updateMatrix();\r\n          this.instanced.setMatrixAt(i, temp.matrix);\r\n        }\r\n      }\r\n\r\n      private applyMaterialOverrides(): void {\r\n        if (this.points) {\r\n          const next = this.materialOverrideForPoints || this.defaultEmitterMaterial;\r\n          if (next && this.points.material !== next) {\r\n            this.points.material = next;\r\n            this.ensurePointMaterial(next);\r\n          }\r\n        }\r\n        if (this.instanced) {\r\n          const next = this.materialOverride || this.defaultInstancedMaterial;\r\n          if (next && this.instanced.material !== next) {\r\n            this.instanced.material = next;\r\n          }\r\n        }\r\n      }\r\n\r\n      private ensurePointMaterial(material: any): void {\r\n        if (!material?.isShaderMaterial) return;\r\n        if (!material.uniforms) {\r\n          material.uniforms = {};\r\n        }\r\n        if (!material.uniforms.uPointSize) {\r\n          material.uniforms.uPointSize = { value: this.cfg.size };\r\n        }\r\n        if (!material.uniforms.uOpacity) {\r\n          material.uniforms.uOpacity = { value: this.cfg.opacity };\r\n        }\r\n        if (!material.vertexShader.includes(\"gl_PointSize\")) {\r\n          if (!material.vertexShader.includes(\"uPointSize\")) {\r\n            material.vertexShader = `uniform float uPointSize;\\n${material.vertexShader}`;\r\n          }\r\n          material.vertexShader = material.vertexShader.replace(\r\n            /void\\\\s+main\\\\s*\\\\(\\\\)\\\\s*\\\\{/,\r\n            \"void main() {\\\\n  gl_PointSize = uPointSize;\"\r\n          );\r\n          material.needsUpdate = true;\r\n        }\r\n      }\r\n\r\n      private refreshModelGeometry(): void {\r\n        if (this.cfg.particleShape !== \"model\") {\r\n          this.modelGeometry = null;\r\n          this.modelKey = \"\";\r\n          return;\r\n        }\r\n        const url = this.cfg.particleModelUrl?.trim();\r\n        if (!url || url === \"none\") {\r\n          this.modelGeometry = null;\r\n          this.modelKey = \"\";\r\n          return;\r\n        }\r\n        const key = `${this.cfg.particleModelLoader}|${url}|${this.cfg.particleModelNode}`;\r\n        if (this.modelKey === key && this.modelGeometry) {\r\n          return;\r\n        }\r\n        this.modelKey = key;\r\n        engine\r\n          .resolveParticleModelGeometry(\r\n            url,\r\n            this.cfg.particleModelLoader,\r\n            this.cfg.particleModelNode\r\n          )\r\n          .then((geometry) => {\r\n            if (!geometry) return;\r\n            if (this.modelKey !== key) return;\r\n            this.modelGeometry = geometry;\r\n            if (this.cfg.mode === \"instanced\" && this.cfg.particleShape === \"model\") {\r\n              this.rebuild();\r\n            }\r\n          });\r\n      }\r\n\r\n      private refreshDistributionGeometry(): void {\r\n        if (this.cfg.instanceShape !== \"model\") {\r\n          this.distributionGeometry = null;\r\n          this.distributionKey = \"\";\r\n          return;\r\n        }\r\n        const url = this.cfg.instanceModelUrl?.trim();\r\n        if (!url || url === \"none\") {\r\n          this.distributionGeometry = null;\r\n          this.distributionKey = \"\";\r\n          return;\r\n        }\r\n        const key = `${this.cfg.instanceModelLoader}|${url}|${this.cfg.instanceModelNode}`;\r\n        if (this.distributionKey === key && this.distributionGeometry) {\r\n          return;\r\n        }\r\n        this.distributionKey = key;\r\n        engine\r\n          .resolveParticleModelGeometry(\r\n            url,\r\n            this.cfg.instanceModelLoader,\r\n            this.cfg.instanceModelNode\r\n          )\r\n          .then((geometry) => {\r\n            if (!geometry) return;\r\n            if (this.distributionKey !== key) return;\r\n            this.distributionGeometry = geometry;\r\n            if (this.cfg.mode === \"instanced\" && this.cfg.instanceShape === \"model\") {\r\n              if (this.pendingDistributionLoad) {\r\n                this.pendingDistributionLoad = false;\r\n                this.buildInstanced();\r\n                this.applyMaterialOverrides();\r\n              } else {\r\n                this.rebuild();\r\n              }\r\n            }\r\n          });\r\n      }\r\n\r\n      private fillBasePositions(count: number): void {\r\n        const useModel = this.cfg.instanceShape === \"model\" && this.distributionGeometry;\r\n        if (useModel) {\r\n          this.fillFromModel(count, this.distributionGeometry);\r\n        } else {\r\n          for (let i = 0; i < count; i += 1) {\r\n            const pos =\r\n              this.cfg.instanceShape === \"box\"\r\n                ? this.randomInBox(this.cfg.spread)\r\n                : this.randomInSphere(this.cfg.spread);\r\n            this.basePositions.set(pos, i * 3);\r\n          }\r\n        }\r\n\r\n        for (let i = 0; i < count; i += 1) {\r\n          const i3 = i * 3;\r\n          this.baseJitter[i3] = this.rng() * 2 - 1;\r\n          this.baseJitter[i3 + 1] = this.rng() * 2 - 1;\r\n          this.baseJitter[i3 + 2] = this.rng() * 2 - 1;\r\n          this.basePhase[i] = this.rng() * Math.PI * 2;\r\n          const scale =\r\n            this.cfg.instanceScale *\r\n            (1 - this.cfg.instanceScaleVariation + this.rng() * this.cfg.instanceScaleVariation);\r\n          this.baseScales[i] = scale;\r\n        }\r\n      }\r\n\r\n      private fillFromModel(count: number, geometry: any): void {\r\n        const attr = geometry?.attributes?.position;\r\n        if (!attr?.array || attr.itemSize < 3) {\r\n          for (let i = 0; i < count; i += 1) {\r\n            const pos = this.randomInSphere(this.cfg.spread);\r\n            this.basePositions.set(pos, i * 3);\r\n          }\r\n          return;\r\n        }\r\n\r\n        const array = attr.array as ArrayLike<number>;\r\n        const itemSize = attr.itemSize;\r\n        const vertexCount = Math.floor(array.length / itemSize);\r\n        if (vertexCount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const indexArray = geometry?.index?.array as ArrayLike<number> | undefined;\r\n        const triangleCount = indexArray\r\n          ? Math.floor(indexArray.length / 3)\r\n          : Math.floor(vertexCount / 3);\r\n        if (triangleCount <= 0) {\r\n          return;\r\n        }\r\n\r\n        let minX = Infinity;\r\n        let minY = Infinity;\r\n        let minZ = Infinity;\r\n        let maxX = -Infinity;\r\n        let maxY = -Infinity;\r\n        let maxZ = -Infinity;\r\n        for (let i = 0; i < vertexCount; i += 1) {\r\n          const idx = i * itemSize;\r\n          const x = array[idx];\r\n          const y = array[idx + 1];\r\n          const z = array[idx + 2];\r\n          minX = Math.min(minX, x);\r\n          minY = Math.min(minY, y);\r\n          minZ = Math.min(minZ, z);\r\n          maxX = Math.max(maxX, x);\r\n          maxY = Math.max(maxY, y);\r\n          maxZ = Math.max(maxZ, z);\r\n        }\r\n        const sizeX = Math.max(1e-6, maxX - minX);\r\n        const sizeY = Math.max(1e-6, maxY - minY);\r\n        const sizeZ = Math.max(1e-6, maxZ - minZ);\r\n        const targetX = (this.cfg.spreadX > 0 ? this.cfg.spreadX : this.cfg.spread) * 2;\r\n        const targetY = (this.cfg.spreadY > 0 ? this.cfg.spreadY : this.cfg.spread) * 2;\r\n        const scaleX = targetX > 0 ? targetX / sizeX : 1;\r\n        const scaleY = targetY > 0 ? targetY / sizeY : 1;\r\n        const scale = Math.min(scaleX, scaleY);\r\n        const centerX = (minX + maxX) * 0.5;\r\n        const centerY = (minY + maxY) * 0.5;\r\n        const centerZ = (minZ + maxZ) * 0.5;\r\n\r\n        const cumulativeAreas = new Float32Array(triangleCount);\r\n        let totalArea = 0;\r\n        for (let i = 0; i < triangleCount; i += 1) {\r\n          const base = i * 3;\r\n          const ia = indexArray ? indexArray[base] : base;\r\n          const ib = indexArray ? indexArray[base + 1] : base + 1;\r\n          const ic = indexArray ? indexArray[base + 2] : base + 2;\r\n          const a = ia * itemSize;\r\n          const b = ib * itemSize;\r\n          const c = ic * itemSize;\r\n          const ax = array[a];\r\n          const ay = array[a + 1];\r\n          const az = array[a + 2];\r\n          const bx = array[b];\r\n          const by = array[b + 1];\r\n          const bz = array[b + 2];\r\n          const cx = array[c];\r\n          const cy = array[c + 1];\r\n          const cz = array[c + 2];\r\n          const abx = bx - ax;\r\n          const aby = by - ay;\r\n          const abz = bz - az;\r\n          const acx = cx - ax;\r\n          const acy = cy - ay;\r\n          const acz = cz - az;\r\n          const crossX = aby * acz - abz * acy;\r\n          const crossY = abz * acx - abx * acz;\r\n          const crossZ = abx * acy - aby * acx;\r\n          const area = Math.sqrt(crossX * crossX + crossY * crossY + crossZ * crossZ) * 0.5;\r\n          totalArea += area;\r\n          cumulativeAreas[i] = totalArea;\r\n        }\r\n        if (totalArea <= 0) {\r\n          for (let i = 0; i < count; i += 1) {\r\n            const pos = this.randomInSphere(this.cfg.spread);\r\n            this.basePositions.set(pos, i * 3);\r\n          }\r\n          return;\r\n        }\r\n\r\n        for (let i = 0; i < count; i += 1) {\r\n          const r = this.rng() * totalArea;\r\n          let lo = 0;\r\n          let hi = triangleCount - 1;\r\n          while (lo < hi) {\r\n            const mid = Math.floor((lo + hi) / 2);\r\n            if (r <= cumulativeAreas[mid]) {\r\n              hi = mid;\r\n            } else {\r\n              lo = mid + 1;\r\n            }\r\n          }\r\n          const base = lo * 3;\r\n          const ia = indexArray ? indexArray[base] : base;\r\n          const ib = indexArray ? indexArray[base + 1] : base + 1;\r\n          const ic = indexArray ? indexArray[base + 2] : base + 2;\r\n          const a = ia * itemSize;\r\n          const b = ib * itemSize;\r\n          const c = ic * itemSize;\r\n          const ax = array[a];\r\n          const ay = array[a + 1];\r\n          const az = array[a + 2];\r\n          const bx = array[b];\r\n          const by = array[b + 1];\r\n          const bz = array[b + 2];\r\n          const cx = array[c];\r\n          const cy = array[c + 1];\r\n          const cz = array[c + 2];\r\n          const u = this.rng();\r\n          const v = this.rng();\r\n          const su = Math.sqrt(u);\r\n          const w1 = 1 - su;\r\n          const w2 = su * (1 - v);\r\n          const w3 = su * v;\r\n          const x = (ax * w1 + bx * w2 + cx * w3 - centerX) * scale;\r\n          const y = (ay * w1 + by * w2 + cy * w3 - centerY) * scale;\r\n          const z = (az * w1 + bz * w2 + cz * w3 - centerZ) * scale;\r\n          this.basePositions[i * 3] = x;\r\n          this.basePositions[i * 3 + 1] = y;\r\n          this.basePositions[i * 3 + 2] = z;\r\n        }\r\n      }\r\n\r\n      private resetEmitter(): void {\r\n        if (!this.points) return;\r\n        const hide = 1e6;\r\n        for (let i = 0; i < this.positions.length; i += 3) {\r\n          this.positions[i] = hide;\r\n          this.positions[i + 1] = hide;\r\n          this.positions[i + 2] = hide;\r\n        }\r\n        this.velocities.fill(0);\r\n        this.life.fill(0);\r\n        this.colors.fill(0);\r\n        this.sizeFactors.fill(0);\r\n        this.alive = 0;\r\n        this.emitRemainder = 0;\r\n        this.pendingBurst = this.cfg.emitBurst;\r\n        this.points.geometry.attributes.position.needsUpdate = true;\r\n        this.points.geometry.attributes.color.needsUpdate = true;\r\n        this.points.geometry.attributes.sizeFactor.needsUpdate = true;\r\n      }\r\n\r\n      private normalize(vec: [number, number, number]): [number, number, number] {\r\n        const len = Math.sqrt(vec[0] * vec[0] + vec[1] * vec[1] + vec[2] * vec[2]) || 1;\r\n        return [vec[0] / len, vec[1] / len, vec[2] / len];\r\n      }\r\n\r\n      private isVec3Equal(a: [number, number, number], b: [number, number, number]): boolean {\r\n        return a[0] === b[0] && a[1] === b[1] && a[2] === b[2];\r\n      }\r\n\r\n      private randomInSphere(radius: number): [number, number, number] {\r\n        const u = this.rng();\r\n        const v = this.rng();\r\n        const theta = u * Math.PI * 2;\r\n        const phi = Math.acos(2 * v - 1);\r\n        const r = Math.cbrt(this.rng()) * radius;\r\n        return [\r\n          r * Math.sin(phi) * Math.cos(theta),\r\n          r * Math.sin(phi) * Math.sin(theta),\r\n          r * Math.cos(phi),\r\n        ];\r\n      }\r\n\r\n      private randomInBox(size: number): [number, number, number] {\r\n        const half = size * 0.5;\r\n        return [\r\n          (this.rng() * 2 - 1) * half,\r\n          (this.rng() * 2 - 1) * half,\r\n          (this.rng() * 2 - 1) * half,\r\n        ];\r\n      }\r\n    }\r\n\r\n    return new ParticleSystem(config) as unknown as I3DParticleSystem;\r\n  }\r\n\r\n  simplifyGeometry(geometry: I3DGeometry, quality: number): I3DGeometry | null {\r\n    const Modifier = (this.THREE as any)?.SimplifyModifier;\r\n    if (!Modifier) return null;\r\n    const anyGeom: any = geometry as any;\r\n    const count = anyGeom?.attributes?.position?.count;\r\n    if (!Number.isFinite(count)) return null;\r\n    const clamped = Math.max(0.05, Math.min(1, quality));\r\n    const target = Math.max(3, Math.floor(count * clamped));\r\n    if (target >= count) return geometry;\r\n    try {\r\n      const modifier = new Modifier();\r\n      return modifier.modify(anyGeom, target);\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  degToRad(degrees: number): number {\r\n    return this.THREE.MathUtils.degToRad(degrees);\r\n  }\r\n\r\n  radToDeg(radians: number): number {\r\n    return this.THREE.MathUtils.radToDeg(radians);\r\n  }\r\n\r\n  computeBoundingBoxRecursively(object: I3DObject): I3DBox3 {\r\n    const boundingBox = new this.THREE.Box3();\r\n    let hasBox = false;\r\n\r\n    if (object.traverse) {\r\n      object.traverse((child: any) => {\r\n        if (!child.visible) return;\r\n        if (child.geometry) {\r\n          if (typeof child.geometry.computeBoundingBox === \"function\") {\r\n            child.geometry.computeBoundingBox();\r\n          }\r\n          const box = child.geometry.boundingBox;\r\n          if (box) {\r\n            const childBox = box.clone().applyMatrix4(child.matrixWorld);\r\n            boundingBox.union(childBox);\r\n            hasBox = true;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    return hasBox ? boundingBox : new this.THREE.Box3();\r\n  }\r\n}\r\n\r\nexport class ThreeJSProvider implements I3DEngineProvider {\r\n  private engine: ThreeJSEngine;\r\n\r\n  constructor(THREE: any, loaders: Record<string, any> = {}) {\r\n    this.engine = new ThreeJSEngine(THREE, loaders);\r\n  }\r\n\r\n  getEngine(): I3DEngine {\r\n    return this.engine;\r\n  }\r\n\r\n  getName(): string {\r\n    return \"Three.js\";\r\n  }\r\n}\r\n"],"mappings":"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","names":["index_exports","__export","FontConverter","String3D","String3DCamera","String3DCustomFilterRegistry","String3DCustomMaterialRegistry","String3DFontRegistry","String3DObject","String3DRenderer","String3DScene","String3DSynchronizer","ThreeJSEngine","ThreeJSMaterialFactory","ThreeJSProvider","ModuleLifecyclePermissions","StringModule","context","element","object","boundingRect","top","height","globalId","attributes","key","type","fallback","transform","resolvedFallback","raw","parsed","windowSize","start","size","offsetStart","offsetEnd","startElement","startViewport","endElement","endViewport","startPosition","endPosition","startBias","endBias","inviewTop","inviewBottom","value","parsedBreakpoint","breakpoints","item","val","id","index","applyFn","copyFn","mirror","data","event","added","removed","StyleTxn","el","vars","currentVars","k","v","props","currentProps","fn","alreadyOpen","error","style","styleTxn","MIN_FRAME_DELTA","FrameDOM","fn","mQueue","i","e","wQueue","frameDOM","TAU","RAD2DEG","SequenceState","SequenceProgressVars","_StringSequence","StringModule","context","e","data","current","max","target","dir","els","el","trigger","parsed","object","get","k","seq","attr","key","match","slider","value","settings","global","group","obj","sliders","p","step","sequence","enteringDuration","leavingDuration","active","m","attrKey","seqAttr","v","easing","idx","transitionProgress","direction","duration","instant","toStep","customDuration","fromStep","prevLeaving","enteringGroup","leavingGroup","progress","prev","leaving","enteringProg","leavingProg","state","rawProgress","currentState","currentDir","styleTxn","t","elapsed","_StringForm","StringModule","context","globalId","object","element","attributes","existingEvents","evt","form","fieldEntries","fieldValues","field","idx","submitCallback","event","allValid","data","processedRadioKeys","entry","key","rules","needsContext","value","valid","errors","firstInvalidEntry","added","removed","phase","errorBlock","groupBlock","message","span","eventSuffix","el","ruleString","events","preferredIndex","registeredIndex","supportsRealtime","inputEventType","inputHandler","target","beforeInputHandler","inputEvent","start","end","nextVal","index","i","registered","node","elements","nodes","state","owner","entries","stateEntries","values","existing","fallbackIdx","parsed","rule","fieldKey","override","needsOverride","lookupKey","checked","opt","attr","type","String3DCamera","engine","mode","fov","near","far","width","height","ortho","x","y","z","screenX","screenY","normalizedX","normalizedY","distance","viewportHeight","roundedZ","scale","String3DCustomFilterRegistry","definition","name","RenderTargetPool","create","width","height","target","String3DFilterPipeline","engine","renderer","geometry","w","h","scale","next","input","effects","quality","current","locals","releaseLocal","idx","acquire","effect","radius","first","second","output","intensity","blurRadius","extracted","blur1","blur2","combined","mode","amount","material","uniforms","clear","key","value","base","bloom","object","anyObj","name","type","params","normalized","def","String3DCustomFilterRegistry","String3DRenderer","container","engine","width","height","rendererAny","scene","camera","filterTargets","pipeline","allObjects","visibility","obj","anyObj","filteredSet","target","prevAutoClear","originalVisible","lights","supportsLayers","cache","effects","allowed","restoreLayers","restoreCameraMask","subtree","input","output","entry","existing","String3DFilterPipeline","object","set","child","visible","el","cached","rect","cx","cy","clamp","value","effect","center","changed","next","uniforms","filterCount","now","dt","fps","countScale","targetScale","maxAge","key","objects","layer","restoredMap","apply","setMode","light","mask","entries","prev","String3DObject","id","type","object","engine","options","child","originalScale","matrix","pos","quat","scale","position","quaternion","euler","value","mat","texture","material","geometry","result","walk","obj","anyObj","childMat","StyleReader","el","prop","fallback","mapValue","val","num","raw","value","norm","readNumberStyle","parsed","stripQuotes","readStringStyle","style","readBooleanStyle","normalized","readFilterRaw","styleMap","String3DCustomMaterialRegistry","definition","name","css","uniforms","def","cssVar","syntax","type","parseUniformValue","def","cssValue","trimmed","num","parts","s","n","parseColorValue","match","value","hex","r","g","b","rgbMatch","collectUniformsFromCSS","definition","element","style","result","parsed","key","mergeInjections","injections","grouped","injection","list","point","sorted","a","i","String3DScene","engine","options","synchronizer","id","element","el","result","walk","obj","child","root","object","type","onAdd","added3DObject","parentId","group","String3DObject","kind","colorRaw","readStringStyle","color","intensity","readNumberStyle","light","distance","decay","angle","penumbra","groundRaw","groundColor","readBooleanStyle","bias","mapSize","mesh","castShadow","receiveShadow","geometry","material","quality","widthSegments","heightSegments","segments","modelPath","loaderType","loader","shouldCenter","gltf","overrideMaterial","config","system","bbox","center","box","style","getCSS","prop","resolve","cssProp","parser","defaultValue","cssVal","parseNumber","v","parseColor","parseUrl","match","customMaterial","opacity","metalness","roughness","emissive","params","mapSrc","normalMapSrc","roughnessMapSrc","metalnessMapSrc","aoMapSrc","flipY","colorSpace","hasMaps","finalType","definition","String3DCustomMaterialRegistry","factory","initialUniforms","instance","objectId","uniforms","oldInstance","stringObject","newMaterial","src","texture","value","normalized","hasStyle","val","baseRaw","base","mappingRaw","mapping","manager","url","mapped","StyleBundleCache","el","ctx","reader","cached","now","interval","metaData","bundle","DEG_TO_RAD","_GroupSynchronizer","el","object","ctx","parentData","cached","rect","bundle","screenCenterX","screenCenterY","frustum","normalizedX","normalizedY","styles","StyleReader","StyleBundleCache","GroupSynchronizer","_LightSynchronizer","el","object","ctx","parentData","cached","rect","bundle","screenCenterX","screenCenterY","frustum","normalizedX","normalizedY","light","targetEl","tCached","tRect","tTranslateZ","StyleReader","tScreenCenterX","tScreenCenterY","x","y","z","styles","groundColor","targetId","offsetRaw","offset","value","parts","part","num","StyleBundleCache","LightSynchronizer","DEG_TO_RAD","_MeshSynchronizer","el","object","props","prev","castShadow","receiveShadow","opacity","applyMaterialProps","mat","child","mesh","ctx","parentData","rect","originalWidth","originalHeight","bundle","translateZ","cssScale","rotateX","rotateY","rotateZ","cssScaleZ","color","metalness","roughness","emissive","geometryQuality","screenCenterX","screenCenterY","frustum","normalizedX","normalizedY","targetWidth","targetHeight","parentScale","baseScaleZ","minTargetSize","scaleX","scaleY","scaleZ","uniformSize","bbox","size","fitMode","modelScale","finalModelScale","scaleW","scaleH","uniformScale","fallbackSize","quality","engine","simplify","normalized","applyToMesh","userData","original","key","simplified","factory","style","apply","definition","values","value","def","converter","converted","styleMap","readNumber","prop","fallback","mapValue","val","num","readString","readBool","raw","norm","cached","width","height","StyleBundleCache","MeshSynchronizer","DEG_TO_RAD","DEFAULT_CONFIG","_ParticlesSynchronizer","el","object","ctx","parentData","cached","rect","bundle","screenCenterX","screenCenterY","frustum","normalizedX","normalizedY","parentScale","scale","config","prev","now","last","dt","styles","StyleReader","mode","property","style","properties","durations","index","shorthand","match","value","result","current","depth","i","ch","name","normalized","prop","raw","num","map","part","tokens","duration","token","lower","fallback","parts","fitMultiplier","spread","spreadX","spreadY","z","perPixel","a","b","type","definition","String3DCustomMaterialRegistry","factory","existing","initialUniforms","instance","material","isShader","system","apply","mat","values","key","def","converter","converted","child","StyleBundleCache","ParticlesSynchronizer","String3DFontRegistry","name","url","normalized","fontFamily","families","value","family","entry","opentypePromise","opentypeModule","woff2Promise","woff2Module","loadOpentype","resolve","reject","script","loadWoff2Decoder","attempts","maxAttempts","checkReady","win","decompressWoff2","buffer","woff2","inputArray","outputArray","newBuffer","isWoff2","FontConverter","source","cacheKey","cached","loading","promise","result","opentype","loadOpentype","buffer","isWoff2","decompressWoff2","font","scale","glyphs","cmap","codeStr","glyphIndex","code","glyph","path","outline","advanceWidth","char","i","unicodeValues","spaceGlyph","commands","cmd","value","url","lower","DEG_TO_RAD","PSEUDO_ELEMENT_CSS","_TextSynchronizer","fontUrl","object","set","obj","style","el","textContent","computed","rx","ry","rz","tx","ty","tz","s","transform","lastContent","observer","mutations","currentContent","currentObject","ctx","parentData","rect","originalWidth","originalHeight","bundle","translateZ","cssScale","rotateX","rotateY","rotateZ","cssScaleZ","opacity","color","metalness","roughness","emissive","castShadow","receiveShadow","materialType","fontFamily","fontSize","textTransform","textDepth","textCurveSegments","bevelEnabled","bevelSize","bevelThickness","bevelOffset","bevelSegments","fontCss","screenCenterX","screenCenterY","frustum","normalizedX","normalizedY","DEG_TO_RAD","layout","l","useCanvasText","mesh","fontEntry","String3DFontRegistry","font","promise","loaded","layoutSig","key","geometry","parentScale","perPixel","scaleFactor","scaleZ","localOffsetX","localOffsetY","prevMaterialType","MeshSynchronizer","range","elRect","walker","node","text","i","char","rects","r","x","y","visibleChar","anyObj","found","child","factory","apply","mat","definition","values","value","def","converter","converted","styleMap","readNumber","prop","fallback","mapValue","val","num","raw","readString","readBool","norm","colorVar","parsed","lineHeight","letterSpacing","fit","depthRaw","depth","alignRaw","align","computedFont","match","cached","StyleBundleCache","TextSynchronizer","String3DSynchronizer","camera","viewportWidth","viewportHeight","engine","MeshSynchronizer","GroupSynchronizer","LightSynchronizer","ParticlesSynchronizer","TextSynchronizer","el","object","parentData","hints","strategy","options","width","height","DirtySyncManager","attributeFilter","el","rootObjects","obj","object","child","entries","entry","mutations","mutation","FilterController","easingParser","rootObjects","now","useDirtySync","dirtySet","targets","walk","obj","el","animating","shouldReadStyle","chain","dirty","effectsKey","child","existing","raw","readFilterRaw","current","duration","delay","easing","zero","effects","warnings","state","newState","t","canTween","fromChain","parseNumber","value","match","num","parseRatio","cleaned","parseAngle","stripped","parseBloom","parts","part","intensity","threshold","parseAmount","name","allowZero","amount","parseRatioAmount","re","args","size","bloom","angle","custom","String3DCustomFilterRegistry","parsed","style","properties","durations","delays","timings","index","shorthand","fallback","easingRaw","result","depth","i","ch","normalized","prop","map","tokens","token","lower","fn","from","to","effect","other","keys","otherKeys","key","uniforms","elapsed","eased","interpolated","lerp","a","b","fromValue","_String3D","E","context","DirtySyncManager","FilterController","value","provider","name","url","options","String3DFontRegistry","object","globalId","element","attributes","parentElement","parentId","String3DRenderer","String3DCamera","modelLoader","modelLoaderFactory","String3DScene","String3DSynchronizer","shouldUseDirtySync","key","fallback","engine","type","loaderType","existing","container","el","data","dirtySet","forceSync","obj","filterTargets","rootObjects","walk","rect","width","height","parentData","shouldSync","nextParentData","cached","forceChildren","child","style","css","initialValue","String3D","ThreeJSMaterialFactory","THREE","definition","initialUniforms","uniforms","material","newUniforms","element","style","collectUniformsFromCSS","initialValues","result","key","def","value","type","url","texture","baseType","BaseMaterial","injectionMap","mergeInjections","shader","injections","pars","header","uniformDeclarations","transform","output","color","normal","roughness","metalness","ao","transmission","lights","emissive","lines","name","uniform","props","newValues","customUniforms","uniformDef","ThreeJSEngine","THREE","loaders","ThreeJSMaterialFactory","x","y","z","w","order","min","max","options","renderer","fov","aspect","near","far","left","right","top","bottom","geometry","material","width","height","depth","radius","widthSegments","heightSegments","radiusTop","radiusBottom","segments","params","color","intensity","distance","decay","angle","penumbra","skyColor","groundColor","type","LoaderClass","defaults","url","normalized","cachedPromise","isFontFile","FontConverter","promise","fontData","font","loader","resolve","text","size","normalizePosition","shapes","scale","char","glyph","xOffset","charShapes","outline","commands","minX","i","maxX","minY","px","py","polygon","inside","j","xi","yi","xj","yj","path","numSamples","p","points","maxY","contour","triangles","tri","a","b","c","cx","cy","offsetX","outlineFormat","shapePath","mx","my","lx","ly","qx","qy","bx","by","subPaths","paths","sp","area","bbox","finalShapes","used","outerPath","shape","innerPath","allPointsInside","testPoints","testPoint","newPath","lastCurve","endPoint","curve","lineHeight","letterSpacing","align","bevelEnabled","bevelThickness","bevelSize","bevelOffset","bevelSegments","curveSegments","lines","resolution","fontAscender","fontDescender","fontEmHeight","baselineRatio","elementWidth","elementHeight","centerOffsetX","centerOffsetY","item","baselineFromTop","offsetY","finalShape","line","index","lineShapes","chars","translated","advance","data","glyphs","ha","matrix","holes","toVec2","pt","newShape","hole","holePath","s","modelUrl","loaderType","nodeName","normalizedLoader","nodeKey","cacheKey","gltf","root","mesh","found","child","config","engine","makeRng","seed","ParticleSystem","cfg","prev","emitterReset","isParticleModelChange","isInstanceModelChange","uniforms","key","count","pos","elapsed","progress","eased","i3","targetArray","attr","array","itemSize","vertexCount","indexArray","triangleCount","minZ","maxZ","idx","sizeX","sizeY","sizeZ","targetX","targetY","scaleX","scaleY","centerX","centerY","centerZ","cumulativeAreas","totalArea","base","ia","ib","ic","ax","ay","az","bz","cz","abx","aby","abz","acx","acy","acz","crossX","crossY","crossZ","r","lo","hi","mid","u","v","su","w1","w2","w3","dt","needsModel","hasModel","hide","useSharedGeometry","setPoints","dir","gravity","drag","totalToEmit","emitCount","colorDirty","speed","vel","time","jitter","flow","disperse","scatter","scatterX","scatterY","scatterZ","rotSpeed","temp","baseX","baseY","baseZ","phase","driftX","driftY","driftZ","jitterX","jitterY","jitterZ","dispersal","dirX","dirY","dirZ","dirLen","scatterScale","scatterOffsetX","scatterOffsetY","scatterOffsetZ","next","vec","len","theta","phi","half","quality","Modifier","anyGeom","clamped","target","degrees","radians","object","boundingBox","hasBox","box","childBox","ThreeJSProvider"]}